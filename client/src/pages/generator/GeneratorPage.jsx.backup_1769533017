import { useState, useMemo } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";
import CodeBlock from "../../components/ui/CodeBlock";
import Tooltip from "../../components/ui/Tooltip";

// ========== CONFIGURATION ==========
const PLATFORM_CONFIG = {
  linux: {
    label: "Linux",
    icon: "ğŸ§",
    advanced: {
      distributions: [
        { value: "ubuntu", label: "Ubuntu", versions: ["24.04", "22.04", "20.04", "18.04"] },
        { value: "debian", label: "Debian", versions: ["12", "11", "10"] },
        { value: "centos", label: "CentOS", versions: ["Stream", "8", "7"] },
        { value: "fedora", label: "Fedora", versions: ["40", "39", "38"] },
        { value: "arch", label: "Arch Linux", versions: ["Latest"] },
        { value: "other", label: "Other Distro" }
      ],
      shells: [
        { value: "bash", label: "bash" },
        { value: "zsh", label: "zsh" },
        { value: "sh", label: "sh" }
      ]
    },
    tips: {
      fa: "ØªÙˆØ²ÛŒØ¹â€ŒÙ‡Ø§ÛŒ Ù„ÛŒÙ†ÙˆÚ©Ø³: Ubuntu, Debian, CentOS, Fedora, Arch",
      en: "Linux distributions: Ubuntu, Debian, CentOS, Fedora, Arch"
    }
  },
  windows: {
    label: "Windows",
    icon: "ğŸªŸ",
    advanced: {
      versions: [
        { value: "win11", label: "Windows 11", builds: ["23H2", "22H2"] },
        { value: "win10", label: "Windows 10", builds: ["22H2", "21H2", "20H2"] },
        { value: "server", label: "Windows Server", builds: ["2022", "2019", "2016"] }
      ],
      shells: [
        { value: "powershell", label: "PowerShell" },
        { value: "cmd", label: "CMD" },
        { value: "wsl", label: "WSL (Linux)" }
      ]
    },
    tips: {
      fa: "ÙˆÛŒÙ†Ø¯ÙˆØ² Û±Û°/Û±Û±ØŒ ÙˆÛŒÙ†Ø¯ÙˆØ² Ø³Ø±ÙˆØ±",
      en: "Windows 10/11, Windows Server"
    }
  },
  mac: {
    label: "macOS",
    icon: "ğŸ",
    advanced: {
      versions: [
        { value: "sonoma", label: "Sonoma (14)", releases: ["14.2", "14.1", "14.0"] },
        { value: "ventura", label: "Ventura (13)", releases: ["13.6", "13.5", "13.0"] },
        { value: "monterey", label: "Monterey (12)", releases: ["12.7", "12.6", "12.0"] }
      ],
      shells: [
        { value: "zsh", label: "zsh (default)" },
        { value: "bash", label: "bash" }
      ]
    },
    tips: {
      fa: "Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„ Ù…Ú© (macOS)",
      en: "Apple macOS"
    }
  },
  network: {
    label: "Network Device",
    icon: "ğŸŒ",
    advanced: {
      vendors: [
        { value: "cisco", label: "Cisco", devices: ["router", "switch", "firewall", "access-point"] },
        { value: "mikrotik", label: "MikroTik", devices: ["routeros", "switch", "cap"] },
        { value: "fortinet", label: "Fortinet", devices: ["fortigate", "fortiswitch", "fortiap"] },
        { value: "juniper", label: "Juniper", devices: ["junos", "switch", "firewall"] }
      ],
      osVersions: {
        cisco: ["IOS XE", "IOS", "NX-OS", "ASA"],
        mikrotik: ["RouterOS 7", "RouterOS 6"],
        fortinet: ["FortiOS 7", "FortiOS 6"],
        juniper: ["JunOS 22", "JunOS 21", "JunOS 20"]
      }
    },
    tips: {
      fa: "ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø´Ø¨Ú©Ù‡: Ø±ÙˆØªØ±ØŒ Ø³ÙˆØ¦ÛŒÚ†ØŒ ÙØ§ÛŒØ±ÙˆØ§Ù„",
      en: "Network equipment: routers, switches, firewalls"
    }
  },
  other: {
    label: "Other OS",
    icon: "ğŸ”§",
    advanced: {
      customFields: [
        { name: "os_name", label: "OS Name", placeholder: "e.g., FreeBSD, Solaris" },
        { name: "os_version", label: "OS Version", placeholder: "e.g., 13.2, 11.4" },
        { name: "shell", label: "Shell/CLI", placeholder: "e.g., tcsh, ksh" },
        { name: "architecture", label: "Architecture", placeholder: "e.g., x86_64, arm64" }
      ]
    },
    tips: {
      fa: "Ø³ÛŒØ³ØªÙ…â€ŒØ¹Ø§Ù…Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ù…Ø§Ù†Ù†Ø¯ FreeBSD, Solaris",
      en: "Other OS like FreeBSD, Solaris"
    }
  }
};

const OUTPUT_TYPES = [
  { 
    value: "tool", 
    label: "Tool (Full)", 
    icon: "ğŸ› ï¸", 
    tips: {
      fa: "Ø¯Ø³ØªÙˆØ± Ú©Ø§Ù…Ù„ + ØªÙˆØ¶ÛŒØ­ + Ù‡Ø´Ø¯Ø§Ø± + Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†",
      en: "Full command + explanation + warnings + alternatives"
    }
  },
  { 
    value: "command", 
    label: "Command Only", 
    icon: "ğŸ’»", 
    tips: {
      fa: "ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ± Ø®Ø§Ù„Øµ Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­ Ø§Ø¶Ø§ÙÙ‡",
      en: "Only the command without extra explanation"
    }
  },
  { 
    value: "python", 
    label: "Python Script", 
    icon: "ğŸ", 
    tips: {
      fa: "Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø§ÛŒØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§ØªÙˆÙ…Ø§Ø³ÛŒÙˆÙ†",
      en: "Python script for automation"
    }
  }
];

const KNOWLEDGE_LEVELS = [
  { 
    value: "beginner", 
    label: "Beginner", 
    tips: {
      fa: "ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…Ù„ Ùˆ Ú¯Ø§Ù… Ø¨Ù‡ Ú¯Ø§Ù… - Ù…Ù†Ø§Ø³Ø¨ ØªØ§Ø²Ù‡â€ŒÚ©Ø§Ø±Ø§Ù†",
      en: "Full step-by-step explanations - for beginners"
    }
  },
  { 
    value: "intermediate", 
    label: "Intermediate", 
    tips: {
      fa: "ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…ØªÙˆØ³Ø· - Ù…Ù†Ø§Ø³Ø¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ ØªØ¬Ø±Ø¨Ù‡",
      en: "Moderate explanations - for experienced users"
    }
  },
  { 
    value: "expert", 
    label: "Expert", 
    tips: {
      fa: "Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø®ØªØµØ± Ùˆ Ù¾ÛŒØ´Ø±ÙØªÙ‡ - Ù…Ù†Ø§Ø³Ø¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒâ€ŒÙ‡Ø§",
      en: "Concise advanced commands - for experts"
    }
  }
];

// ========== MAIN COMPONENT ==========
export default function GeneratorPage() {
  const { t, lang } = useLanguage();
  
  // ========== STATE ==========
  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("tool");
  const [knowledgeLevel, setKnowledgeLevel] = useState("intermediate");
  const [input, setInput] = useState("");
  const [output, setOutput] = useState({ markdown: "", tool: null });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [swapLayout, setSwapLayout] = useState(false);
  const [showAdvanced, setShowAdvanced] = useState(false);
  
  // Advanced states based on platform
  const [distribution, setDistribution] = useState("ubuntu");
  const [distributionVersion, setDistributionVersion] = useState("24.04");
  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState("cisco");
  const [deviceType, setDeviceType] = useState("router");
  const [osVersion, setOsVersion] = useState("IOS XE");
  const [customFields, setCustomFields] = useState({
    os_name: "",
    os_version: "",
    shell: "",
    architecture: ""
  });
  
  // ========== COMPUTED VALUES ==========
  const currentPlatform = useMemo(() => PLATFORM_CONFIG[platform], [platform]);
  
  const validateInput = () => {
    // Clear previous errors
    setError("");
    
    // Check main input
    if (!input.trim()) {
      setError(lang === "fa" 
        ? "âš ï¸ Ù„Ø·ÙØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" 
        : "âš ï¸ Please enter your request");
      return false;
    }
    
    // Platform-specific validation
    if (platform === "other") {
      if (!customFields.os_name.trim()) {
        setError(lang === "fa"
          ? "âš ï¸ Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
          : "âš ï¸ Please enter OS name");
        return false;
      }
      if (!customFields.shell.trim()) {
        setError(lang === "fa"
          ? "âš ï¸ Ù„Ø·ÙØ§ Ù†ÙˆØ¹ Ø´Ù„/CLI Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
          : "âš ï¸ Please enter shell/CLI type");
        return false;
      }
    }
    
    return true;
  };
  
  // ========== API CALLS ==========
  const generate = async () => {
    if (!validateInput() || loading) return;
    
    setLoading(true);
    setError("");
    setOutput({ markdown: "", tool: null });
    
    try {
      const payload = buildPayload();
      console.log("ğŸ“¤ Sending payload:", payload);
      
      const result = await callCCG(payload);
      setOutput(result);
    } catch (err) {
      setError(err.message || (lang === "fa" 
        ? "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±" 
        : "âŒ Server connection error"));
    } finally {
      setLoading(false);
    }
  };
  
  const buildPayload = () => {
    const basePayload = {
      mode: "generate",
      lang,
      user_request: input.trim(),
      outputType,
      knowledgeLevel,
      platform,
    };
    
    // Add platform-specific fields
    switch (platform) {
      case "linux":
        return {
          ...basePayload,
          os: `linux:${distribution}`,
          os_version: distributionVersion,
          cli: shell,
          context: `linux_distro:${distribution}_${distributionVersion}_shell:${shell}`
        };
        
      case "windows":
        return {
          ...basePayload,
          os: "windows",
          os_version: distributionVersion, // reused as windows version
          cli: shell,
          context: `windows_shell:${shell}`
        };
        
      case "mac":
        return {
          ...basePayload,
          os: "macos",
          os_version: distributionVersion, // reused as macOS version
          cli: shell,
          context: `macos_shell:${shell}`
        };
        
      case "network":
        return {
          ...basePayload,
          os: "network",
          vendor,
          deviceType,
          os_version: osVersion,
          context: `network_vendor:${vendor}_device:${deviceType}_os:${osVersion}`
        };
        
      case "other":
        return {
          ...basePayload,
          os: customFields.os_name,
          os_version: customFields.os_version,
          cli: customFields.shell,
          architecture: customFields.architecture,
          context: `custom_os:${customFields.os_name}_shell:${customFields.shell}`
        };
        
      default:
        return basePayload;
    }
  };
  
  const copyToClipboard = (text) => {
    if (!text) return;
    
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(() => {
        alert(lang === "fa" ? "âœ… Ú©Ù¾ÛŒ Ø´Ø¯!" : "âœ… Copied!");
      }).catch(() => {
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  };
  
  const fallbackCopy = (text) => {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert(lang === "fa" ? "âœ… Ú©Ù¾ÛŒ Ø´Ø¯!" : "âœ… Copied!");
  };
  
  const clearAll = () => {
    setInput("");
    setOutput({ markdown: "", tool: null });
    setError("");
  };
  
  // ========== RENDER HELPERS ==========
  const renderAdvancedOptions = () => {
    const config = currentPlatform.advanced;
    
    return (
      <div className="mt-4 pt-4 border-t border-[var(--border)] animate-fadeIn">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          
          {/* Linux Distributions */}
          {platform === "linux" && config.distributions && (
            <>
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "ØªÙˆØ²ÛŒØ¹ Ù„ÛŒÙ†ÙˆÚ©Ø³" : "Linux Distribution"}
                </label>
                <select
                  value={distribution}
                  onChange={(e) => {
                    setDistribution(e.target.value);
                    setDistributionVersion(config.distributions
                      .find(d => d.value === e.target.value)?.versions?.[0] || "");
                  }}
                  className="ccg-select text-sm w-full"
                >
                  {config.distributions.map(dist => (
                    <option key={dist.value} value={dist.value}>
                      {dist.label}
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "ÙˆØ±Ú˜Ù†" : "Version"}
                </label>
                <select
                  value={distributionVersion}
                  onChange={(e) => setDistributionVersion(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {config.distributions
                    .find(d => d.value === distribution)?.versions?.map(ver => (
                      <option key={ver} value={ver}>{ver}</option>
                    )) || <option>N/A</option>}
                </select>
              </div>
              
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "Ø´Ù„" : "Shell"}
                </label>
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {config.shells.map(sh => (
                    <option key={sh.value} value={sh.value}>
                      {sh.label}
                    </option>
                  ))}
                </select>
              </div>
            </>
          )}
          
          {/* Windows/Mac Versions */}
          {(platform === "windows" || platform === "mac") && config.versions && (
            <>
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {platform === "windows" 
                    ? (lang === "fa" ? "ÙˆØ±Ú˜Ù† ÙˆÛŒÙ†Ø¯ÙˆØ²" : "Windows Version")
                    : (lang === "fa" ? "ÙˆØ±Ú˜Ù† macOS" : "macOS Version")}
                </label>
                <select
                  value={distributionVersion}
                  onChange={(e) => setDistributionVersion(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {config.versions.map(ver => (
                    <option key={ver.value} value={ver.value}>
                      {ver.label}
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "Ø´Ù„" : "Shell"}
                </label>
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {config.shells.map(sh => (
                    <option key={sh.value} value={sh.value}>
                      {sh.label}
                    </option>
                  ))}
                </select>
              </div>
            </>
          )}
          
          {/* Network Devices */}
          {platform === "network" && config.vendors && (
            <>
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "Ø³Ø§Ø²Ù†Ø¯Ù‡" : "Vendor"}
                </label>
                <select
                  value={vendor}
                  onChange={(e) => {
                    setVendor(e.target.value);
                    setDeviceType(config.vendors.find(v => v.value === e.target.value)?.devices?.[0] || "");
                    setOsVersion(config.osVersions[e.target.value]?.[0] || "");
                  }}
                  className="ccg-select text-sm w-full"
                >
                  {config.vendors.map(vend => (
                    <option key={vend.value} value={vend.value}>
                      {vend.label}
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "Ù†ÙˆØ¹ Ø¯Ø³ØªÚ¯Ø§Ù‡" : "Device Type"}
                </label>
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {config.vendors
                    .find(v => v.value === vendor)?.devices?.map(dev => (
                      <option key={dev} value={dev}>
                        {dev.charAt(0).toUpperCase() + dev.slice(1).replace('-', ' ')}
                      </option>
                    )) || <option>N/A</option>}
                </select>
              </div>
              
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "ÙˆØ±Ú˜Ù† Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„" : "OS Version"}
                </label>
                <select
                  value={osVersion}
                  onChange={(e) => setOsVersion(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {config.osVersions[vendor]?.map(ver => (
                    <option key={ver} value={ver}>{ver}</option>
                  )) || <option>N/A</option>}
                </select>
              </div>
            </>
          )}
          
          {/* Custom OS */}
          {platform === "other" && config.customFields && (
            <>
              {config.customFields.map(field => (
                <div key={field.name}>
                  <label className="text-xs text-[var(--muted)] mb-1 block">
                    {field.label}
                  </label>
                  <input
                    type="text"
                    value={customFields[field.name] || ""}
                    onChange={(e) => setCustomFields({
                      ...customFields,
                      [field.name]: e.target.value
                    })}
                    placeholder={field.placeholder}
                    className="ccg-input text-sm w-full"
                  />
                </div>
              ))}
            </>
          )}
          
        </div>
        
        {/* Tips for current platform */}
        <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
          <div className="text-xs text-blue-700 dark:text-blue-300 font-medium mb-1">
            ğŸ’¡ {lang === "fa" ? "Ø±Ø§Ù‡Ù†Ù…Ø§" : "Tip"}:
          </div>
          <div className="text-xs text-blue-600 dark:text-blue-400">
            {currentPlatform.tips[lang] || currentPlatform.tips.en}
          </div>
        </div>
      </div>
    );
  };
  
  // ========== RENDER ==========
  return (
    <div className="space-y-4 md:space-y-6">
      {/* Top Bar - Platform Selection */}
      <div className="ccg-container">
        <div className="ccg-card p-3 md:p-4">
          <div className="flex flex-col md:flex-row md:items-center gap-3">
            {/* Platform Selection */}
            <div className="flex-1">
              <div className="text-sm font-medium mb-1">
                {lang === "fa" ? "ğŸ¯ Ù¾Ù„ØªÙØ±Ù… Ù‡Ø¯Ù" : "ğŸ¯ Target Platform"}
              </div>
              <div className="flex flex-wrap gap-2">
                {Object.entries(PLATFORM_CONFIG).map(([key, config]) => (
                  <button
                    key={key}
                    onClick={() => setPlatform(key)}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm transition-all ${
                      platform === key
                        ? "bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 border border-blue-300 dark:border-blue-700"
                        : "bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700"
                    }`}
                  >
                    <span>{config.icon}</span>
                    <span>{config.label}</span>
                  </button>
                ))}
              </div>
            </div>
            
            {/* Quick Actions */}
            <div className="flex items-center gap-2">
              <button
                onClick={() => setShowAdvanced(!showAdvanced)}
                className="ccg-btn px-3 py-2 text-sm"
              >
                {showAdvanced 
                  ? (lang === "fa" ? "â–² Ø¨Ø³ØªÙ† ØªÙ†Ø¸ÛŒÙ…Ø§Øª" : "â–² Hide Settings")
                  : (lang === "fa" ? "â–¼ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡" : "â–¼ Advanced Settings")
                }
              </button>
              <button
                onClick={() => setSwapLayout(!swapLayout)}
                className="ccg-btn px-3 py-2 text-sm"
              >
                â†” {lang === "fa" ? "Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ" : "Swap"}
              </button>
            </div>
          </div>
          
          {/* Platform-specific options in normal mode */}
          {!showAdvanced && platform === "network" && (
            <div className="mt-3 pt-3 border-t border-[var(--border)]">
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs text-[var(--muted)] mb-1 block">
                    {lang === "fa" ? "Ø³Ø§Ø²Ù†Ø¯Ù‡" : "Vendor"}
                  </label>
                  <select
                    value={vendor}
                    onChange={(e) => setVendor(e.target.value)}
                    className="ccg-select text-sm w-full"
                  >
                    {PLATFORM_CONFIG.network.advanced.vendors.map(vend => (
                      <option key={vend.value} value={vend.value}>
                        {vend.label}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-[var(--muted)] mb-1 block">
                    {lang === "fa" ? "Ù†ÙˆØ¹ Ø¯Ø³ØªÚ¯Ø§Ù‡" : "Device Type"}
                  </label>
                  <select
                    value={deviceType}
                    onChange={(e) => setDeviceType(e.target.value)}
                    className="ccg-select text-sm w-full"
                  >
                    {PLATFORM_CONFIG.network.advanced.vendors
                      .find(v => v.value === vendor)?.devices?.map(dev => (
                        <option key={dev} value={dev}>
                          {dev.charAt(0).toUpperCase() + dev.slice(1).replace('-', ' ')}
                        </option>
                      )) || <option>N/A</option>}
                  </select>
                </div>
              </div>
            </div>
          )}
          
          {/* Advanced Options */}
          {showAdvanced && renderAdvancedOptions()}
        </div>
      </div>
      
      {/* Main Content Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
          {/* Input Column */}
          <div className={`ccg-card p-4 md:p-6 ${swapLayout ? "lg:order-2" : "lg:order-1"}`}>
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
              <h2 className="font-semibold text-lg">
                {lang === "fa" ? "ğŸ“ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§" : "ğŸ“ Your Request"}
              </h2>
              <div className="flex items-center gap-2">
                <button
                  onClick={clearAll}
                  className="ccg-btn-ghost text-sm px-3 py-1.5"
                >
                  ğŸ—‘ï¸ {lang === "fa" ? "Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†" : "Clear"}
                </button>
              </div>
            </div>
            
            {/* Output Type & Knowledge Level */}
            <div className="grid grid-cols-2 gap-3 mb-4">
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "Ù†ÙˆØ¹ Ø®Ø±ÙˆØ¬ÛŒ" : "Output Type"}
                </label>
                <select
                  value={outputType}
                  onChange={(e) => setOutputType(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {OUTPUT_TYPES.map(type => (
                    <option key={type.value} value={type.value}>
                      {type.icon} {type.label}
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="text-xs text-[var(--muted)] mb-1 block">
                  {lang === "fa" ? "Ø³Ø·Ø­ Ø¯Ø§Ù†Ø´" : "Knowledge Level"}
                </label>
                <select
                  value={knowledgeLevel}
                  onChange={(e) => setKnowledgeLevel(e.target.value)}
                  className="ccg-select text-sm w-full"
                >
                  {KNOWLEDGE_LEVELS.map(level => (
                    <option key={level.value} value={level.value}>
                      {level.label}
                    </option>
                  ))}
                </select>
              </div>
            </div>
            
            {/* Textarea */}
            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={lang === "fa" 
                ? "Ù…Ø«Ø§Ù„: Ø¨Ø±Ø±Ø³ÛŒ ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú© Ùˆ Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ"
                : "Example: Check disk space and remove old files"}
              className="ccg-textarea w-full h-48 md:h-64 resize-none p-3 md:p-4 text-sm"
              rows={6}
            />
            
            {/* Error Display */}
            {error && (
              <div className="mt-3 ccg-error p-3 animate-fadeIn">
                <div className="font-medium">{error}</div>
              </div>
            )}
            
            {/* Action Buttons */}
            <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
              <button
                onClick={generate}
                disabled={loading || !input.trim()}
                className="ccg-btn-primary py-3 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {loading ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                    {lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯..." : "Generating..."}
                  </>
                ) : (
                  <>
                    ğŸš€ {lang === "fa" ? "ØªÙˆÙ„ÛŒØ¯ Ø¯Ø³ØªÙˆØ±" : "Generate"}
                  </>
                )}
              </button>
              
              <button
                onClick={() => {
                  if (!input.trim()) {
                    setError(lang === "fa" 
                      ? "âš ï¸ Ù„Ø·ÙØ§ Ø§ÙˆÙ„ ÛŒÚ© Ø¯Ø³ØªÙˆØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" 
                      : "âš ï¸ Please enter a command first");
                    return;
                  }
                  // This would open explain modal
                  window.dispatchEvent(new CustomEvent("ccg-explain", { 
                    detail: { command: input.trim() } 
                  }));
                }}
                disabled={!input.trim()}
                className="ccg-btn py-3 flex items-center justify-center gap-2 disabled:opacity-50"
              >
                ğŸ“– {lang === "fa" ? "ØªÙˆØ¶ÛŒØ­ Ø¯Ø³ØªÙˆØ±" : "Explain"}
              </button>
            </div>
            
            {/* Quick Tips */}
            <div className="mt-4 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
              <div className="text-xs text-gray-600 dark:text-gray-400">
                ğŸ’¡ {lang === "fa" 
                  ? "Ø¨Ø±Ø§ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¨Ù‡ØªØ±: Ù¾Ù„ØªÙØ±Ù… ØµØ­ÛŒØ­ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ + Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¯Ù‚ÛŒÙ‚ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯"
                  : "For best results: Select correct platform + Describe request precisely"}
              </div>
            </div>
          </div>
          
          {/* Output Column */}
          <div className={`ccg-card p-4 md:p-6 ${swapLayout ? "lg:order-1" : "lg:order-2"}`}>
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
              <h2 className="font-semibold text-lg">
                {lang === "fa" ? "âœ¨ Ù†ØªÛŒØ¬Ù‡" : "âœ¨ Result"}
              </h2>
              {output.markdown && (
                <button
                  onClick={() => copyToClipboard(output.markdown)}
                  className="ccg-btn-ghost text-sm px-3 py-1.5"
                >
                  ğŸ“‹ {lang === "fa" ? "Ú©Ù¾ÛŒ" : "Copy"}
                </button>
              )}
            </div>
            
            {/* Output Display */}
            {output.tool ? (
              <div className="space-y-4 animate-fadeIn">
                {/* Command */}
                <div className="bg-gray-900 rounded-lg overflow-hidden">
                  <div className="flex justify-between items-center px-4 py-2 bg-gray-800">
                    <div className="text-xs text-gray-300 font-mono">
                      {lang === "fa" ? "Ø¯Ø³ØªÙˆØ±" : "Command"}
                    </div>
                    <button
                      onClick={() => copyToClipboard(output.tool.primary?.command || output.markdown)}
                      className="text-xs text-gray-300 hover:text-white px-2 py-1 transition"
                    >
                      ğŸ“‹ {lang === "fa" ? "Ú©Ù¾ÛŒ" : "Copy"}
                    </button>
                  </div>
                  <pre className="p-4 text-sm text-gray-100 font-mono overflow-x-auto max-h-96">
                    {output.tool.primary?.command || output.markdown}
                  </pre>
                </div>
                
                {/* Explanation */}
                {output.tool.explanation && (
                  <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                    <div className="text-sm font-medium mb-2 flex items-center gap-2">
                      ğŸ’¡ {lang === "fa" ? "ØªÙˆØ¶ÛŒØ­" : "Explanation"}
                    </div>
                    <div className="text-sm">{output.tool.explanation}</div>
                  </div>
                )}
                
                {/* Warnings */}
                {output.tool.warnings && output.tool.warnings.length > 0 && (
                  <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                    <div className="text-sm font-medium mb-2 flex items-center gap-2">
                      âš ï¸ {lang === "fa" ? "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "Warnings"}
                    </div>
                    <ul className="text-sm space-y-1">
                      {output.tool.warnings.map((warn, i) => (
                        <li key={i}>â€¢ {warn}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            ) : output.markdown ? (
              outputType === "command" || outputType === "python" ? (
                <CodeBlock 
                  code={output.markdown} 
                  language={outputType === "python" ? "python" : "bash"}
                />
              ) : (
                <div className="space-y-4 animate-fadeIn">
                  <SectionedMarkdown markdown={output.markdown} lang={lang} />
                  <button
                    onClick={() => copyToClipboard(output.markdown)}
                    className="ccg-btn w-full py-2"
                  >
                    ğŸ“‹ {lang === "fa" ? "Ú©Ù¾ÛŒ Ù‡Ù…Ù‡ Ù…ØªÙ†" : "Copy All Text"}
                  </button>
                </div>
              )
            ) : (
              <div className="text-center py-12 md:py-16 text-[var(--muted)]">
                <div className="text-4xl mb-4">âœ¨</div>
                <div className="text-lg mb-2">
                  {lang === "fa" ? "Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯!" : "Ready to generate!"}
                </div>
                <div className="text-sm">
                  {lang === "fa" 
                    ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Ø¯Ú©Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯"
                    : "Write your request and click Generate"}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* Mobile-Friendly Bottom Actions */}
      <div className="ccg-container lg:hidden">
        <div className="ccg-card p-3">
          <div className="grid grid-cols-2 gap-2">
            <button
              onClick={() => setShowAdvanced(!showAdvanced)}
              className="ccg-btn py-2 text-sm"
            >
              {showAdvanced ? "â–²" : "â–¼"} {lang === "fa" ? "ØªÙ†Ø¸ÛŒÙ…Ø§Øª" : "Settings"}
            </button>
            <button
              onClick={() => setSwapLayout(!swapLayout)}
              className="ccg-btn py-2 text-sm"
            >
              â†” {lang === "fa" ? "Ø¬Ø§Ø¨Ø¬Ø§" : "Swap"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// CSS Animations
const styles = `
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}
`;

// Inject styles
if (typeof document !== 'undefined') {
  const styleEl = document.createElement('style');
  styleEl.textContent = styles;
  document.head.appendChild(styleEl);
}
