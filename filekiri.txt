CCG FILE SNAPSHOT â€” filekiri

===== PROJECT TREE (depth<=6) =====
CCG/
  filekiri.txt
  package.json
  install.sh
  LICENSE
  static.json
  responseParser-cli.js
  README.md
  package-lock.json
  install.ps1
  .gitignore
  server.js
  .env
  .ccg_backups/
    server.js.bak_20251231_153325
    aiClient.js.bak_20260102_050835
    server.js.bak_20251231_152829
    server.js.bak_20251231_153225
    server.js.bak_20260102_050835
    tool_output_final/
      20260103_045619/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
      20260103_050838/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    chat_ui_v2/
      client_src_components_layout_Header.jsx.bak_20260102_061600
      client_src_context_LanguageContext.jsx.bak_20260102_061600
      client_src_services_aiService.js.bak_20260102_061600
      client_src_hooks_useAppView.jsx.bak_20260102_061600
      client_src_App.jsx.bak_20260102_061600
    fix_formatted_loop_20260103_092024/
      ccgRoutes.js
      outputFormatter.js
    day2_generator_polish_20260108_052549/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          context/
            LanguageContext.jsx
          components/
            ui/
              ToolResult.jsx
          services/
            aiService.js
    fix_generator_blank_20260107_092609/
      GeneratorPage.jsx
    day2_advanced_os_shell_20260107_053633/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          context/
            LanguageContext.jsx
    fix_chat_exports_20260107_151357/
      client/
        src/
          pages/
            chat/
              ChatPage.jsx
          services/
            aiService.js
    fix_tool_json_leak_20260107_142753/
      ccgRoutes.js
      outputFormatter.js
    lock_tool_contract_20260103_093401/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          components/
            ui/
              MarkdownBox.jsx
              ToolResult.jsx
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    vite_proxy_fix/
      20260102_095554/
        client_vite.config.js
    fix_object_object_ui/
      20260103_100241/
        client/
          src/
            pages/
            components/
            services/
              aiService.js
    fix_ccg_route_clean_20260107_140804/
      ccgRoutes.js
    generator_toolstyle_fix/
      20260102_113354/
        server/
          utils/
            formatter.js
            outputFormatter.js
          routes/
            ccgRoutes.js
      20260102_125743/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    generator_toolstyle_v2/
      20260102_113847/
        server/
          utils/
            formatter.js
            outputFormatter.js
          routes/
            ccgRoutes.js
    fix_generator_t_block_20260108_072438/
      GeneratorPage.jsx
    fix_formatOutput_undefined/
      20260103_074437/
        ccgRoutes.js
    ui_contract_stabilize/
      20260103_103042/
        client/
          src/
            pages/
            components/
            services/
              aiService.js
    fix_formatted_var/
      20260103_071421/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    lock_generate_json_contract/
      20260106_090951/
        client/
          src/
            pages/
            services/
              aiService.js
        server/
          utils/
            aiClient.js
            outputFormatter.js
          routes/
            ccgRoutes.js
    fix_formatted_syntax_20260103_093751/
      ccgRoutes.js
    dedupe_formatToolResponse/
      20260103_072923/
        ccgRoutes.js
    chatmode_v2/
      chatRoutes.js.bak_20260102_052924
      server.js.bak_20260102_052918
      aiClient.js.bak_20260102_052918
      server.js.bak_20260102_052924
      chatRoutes.js.bak_20260102_052918
      aiClient.js.bak_20260102_052924
    fix_aiService_normalize_20260103_095314/
      client/
        src/
          services/
            aiService.js
    fix_t_tdz_definitive_20260108_092254/
      LanguageContext.jsx
    fix_dup_import/
      20260103_055255/
        ccgRoutes.js
    fix_t_tdz_20260108_070352/
      GeneratorPage.jsx
    fix_jsx_escape_20260107_054507/
      GeneratorPage.jsx
    chatmode_v3/
      chatRoutes.js.bak_20260102_060354
      server.js.bak_20260102_060354
      outputFormatter.js.bak_20260102_060354
      chatStore.js.bak_20260102_060354
    fix_contract_20260106_062417/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    fix_output_ui_contract_20260108_055417/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          components/
            ui/
              ToolResult.jsx
          services/
            aiService.js
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    rollback_generatorpage_20260107_093028/
      GeneratorPage.jsx.broken
    fix_markdownbox_t_tdz_20260108_082704/
      MarkdownBox.jsx
    day2_hardening_20260107_160523/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          components/
            ui/
              ToolResult.jsx
          services/
            aiService.js
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    fix_t_tdz_global_20260108_074123/
      client/
        src/
          pages/
            auth/
            Auth/
            dashboard/
              DashboardPage.jsx
            comparator/
              CodeComparatorPage.jsx.bak_20251231_145434
              CodeComparatorPage.jsx
            landing/
              LandingPage.jsx
              LanguageSelect.jsx
            Compare/
            Landing/
            compare/
              CodeComparatorPage.jsx
            generator/
              GeneratorPage.jsx.bak_20251231_161246
              GeneratorPage.jsx
              GeneratorPage.jsx.bak_20251231_162546
            chat/
              ChatPage.jsx
          context/
            AuthContext.jsx
            LanguageContext.jsx
            ThemeContext.jsx
            hooks/
          components/
            ProtectedRoute.jsx
            ui/
              CopyButton.jsx
              MarkdownBox.jsx.bak_20251225_110541
              MarkdownBox.jsx
              CodeCompareBox.jsx
              Tooltip.jsx
              HelpTip.jsx
              MarkdownRenderer.jsx
              CodeBlock.jsx
              Modal.jsx
              MarkdownView.jsx
              SectionedMarkdown.jsx
              BottomDrawer.jsx
              LoadingSpinner.jsx
              ToolResult.jsx
              WarningBox.jsx
            error/
              ErrorAnalyzerModal.jsx
              ErrorAnalyzerDrawer.jsx
            modals/
              WelcomeModal.jsx
              LanguageSelectModal.jsx
              ErrorAnalyzerModal.jsx
              AuthModal.jsx
              RoleSelectModal.jsx
            popup/
            shared/
            generator/
              KnowledgeSelector.jsx
              GeneratorForm.jsx
              ErrorHelper.jsx
              ModeSelector.jsx
            layout/
              Header.jsx
              Footer.jsx
              MainLayout.jsx
    lock_generate_contract_v2/
      20260106_080311/
        client/
          src/
            pages/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    stabilize_tool_contract/
      20260103_073656/
        ccgRoutes.js
        outputFormatter.js
    fix_formatter_json_leak_20260107_144454/
      outputFormatter.js
    final_format_lock/
      20260103_081321/
        client/
          src/
            components/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    fix_object_object_20260103_095046/
      client/
        src/
          services/
            aiService.js
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    generator_toolstyle_stable/
      20260102_140213/
        ccgRoutes.js
        outputFormatter.js
    day2_other_platform_20260107_052815/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          context/
            LanguageContext.jsx
    fix_tool_json_output_client_20260108_060621/
      aiService.js
    final_tool_format_20260103_065450/
      client/
        src/
          index.css
          components/
            ui/
              SectionedMarkdown.jsx
      server/
        utils/
          outputFormatter.js
    fix_backend_frontend_20260103_091446/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
      server/
        routes/
          ccgRoutes.js
    remove_knowledgeLevel/
      20260106_100417/
    mainpage_chat_hybrid_v1/
      20260102_095356/
        server.js
        client/
          vite.config.js
          src/
            App.jsx
            pages/
            context/
              LanguageContext.jsx
            components/
            hooks/
              useAppView.jsx
            services/
              aiService.js
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
            chatRoutes.js
    night_lock_contract_20260107_132348/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          context/
            LanguageContext.jsx
          components/
            ui/
              SectionedMarkdown.jsx
              ToolResult.jsx
          services/
            aiService.js
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    20260108_102830/
      client/
        src/
          components/
            ui/
              ToolResult.jsx
    day2_ui_other_lock_fix_20260107_072745/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
    fix_eof_generatorpage/
      20260107_090439/
        GeneratorPage.jsx
    day2_ui_other_lock_20260107_071003/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          services/
            aiService.js
    fix_generator_dup_lang_t_20260108_065609/
      GeneratorPage.jsx
    fix_ping_500_20260103_094113/
      ccgRoutes.js
      node.err
      server.js
      node.out
    fix_toolstyle/
      20260102_132229/
        outputFormatter.js.current
        ccgRoutes.js.current
    fix_genpage_dup_brace_20260107_075220/
      GeneratorPage.jsx
    generator_toolstyle_final/
      20260102_131017/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
      20260102_131018/
        server/
          utils/
          routes/
      20260102_131044/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    final_stable_contract/
      20260106_082556/
        client/
          src/
            pages/
        server/
          utils/
            aiClient.js
            outputFormatter.js
          routes/
            ccgRoutes.js
    tool_contract_v1/
      20260103_055028/
        client/
          src/
            pages/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    fix_js_not_in_20260108_053111/
      GeneratorPage.jsx
    generator_toolfix_v1/
      20260102_111613/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    fix_outputFormatter_tool_markdown_20260107_141708/
      outputFormatter.js
    fix_languagecontext_syntax_20260108_081601/
      LanguageContext.jsx
    final_tool_layout/
      20260103_053551/
        client/
          src/
            pages/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    vite_proxy/
      client_vite.config.js.bak_20260102_061944
      client_vite.config.js.bak_20260102_062135
    toolstyle_20260102_112342/
      ccgRoutes.js.bak
    chat_ui_v1/
      client_src_hooks_useAppView.jsx.bak_20260102_060950
      client_src_context_LanguageContext.jsx.bak_20260102_060950
      client_src_App.jsx.bak_20260102_060950
      client_src_services_aiService.js.bak_20260102_060950
      client_src_components_layout_Header.jsx.bak_20260102_060950
    fix_dup_formatted_20260107_132814/
      ccgRoutes.js
    fix_generatorpage_structure/
      20260107_085409/
        GeneratorPage.jsx
    fix_tdz_markdownbox_20260108_085219/
      MarkdownBox.jsx
    toolstyle_fix/
      20260102_131717/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    20260108_102252/
      client/
        src/
          components/
            ui/
              MarkdownBox.jsx
              MarkdownRenderer.jsx
              MarkdownView.jsx
              SectionedMarkdown.jsx
              ToolResult.jsx
    tool_contract_stable/
      20260103_090201/
        client/
          src/
            pages/
            components/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    fix_top_level_return_20260107_080401/
      GeneratorPage.jsx
    fix_formatter_export/
      20260102_132809/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    outputFormatter_enrich/
      20260103_042936/
        server/
          utils/
            outputFormatter.js
    lock_generate_contract/
      20260106_074819/
        client/
          src/
            pages/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    chatmode_v2_fix/
      server.js.bak_20260102_054158
      chatRoutes.js.bak_20260102_054158
      chatStore.js.bak_20260102_054158
    20260108_161207/
      client/
        src/
          components/
            ui/
              MarkdownBox.jsx
    fix_tdz_markdownbox_20260108_091035/
      MarkdownBox.jsx
    server_up_fix/
      20260103_075133/
        server.js
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    day2_adv_other_payload_20260107_094226/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          context/
            LanguageContext.jsx
    mainpage_finish_v1/
      20260102_125019/
        server.js
        client/
          vite.config.js
          src/
            App.jsx
            context/
              LanguageContext.jsx
            components/
            hooks/
              useAppView.jsx
            services/
              aiService.js
        server/
          utils/
            formatter.js
            outputFormatter.js
          routes/
            ccgRoutes.js
            chatRoutes.js
    mainpage_finish_v2/
      20260102_134820/
        client/
          vite.config.js
          src/
            App.jsx
            pages/
            context/
              LanguageContext.jsx
            components/
            hooks/
              useAppView.jsx
            services/
              aiService.js
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    day2_adv_other_payload_20260107_094322/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          context/
            LanguageContext.jsx
    fix_dup_formatted_FINAL_20260107_144012/
      ccgRoutes.js
    outputFormatter_toolstyle/
      20260103_051430/
        outputFormatter.js
    recover_languagecontext_20260107_100630/
      used_backup.txt
      LanguageContext.jsx.broken
    mainpage_stabilize/
      20260102_135643/
        ccgRoutes.js
        outputFormatter.js
        vite.config.js
    remove_knowledgeLevel_ui_fix/
      20260106_115045/
        client/
          src/
            pages/
            services/
              aiService.js
        server/
          utils/
            aiClient.js
            outputFormatter.js
            promptTransformer.js
          routes/
            ccgRoutes.js
    generator_toolstyle_v3/
      20260102_130322/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    fix_body_verbosity_20260107_135120/
      ccgRoutes.js
    fix_languagecontext_tdz_20260108_083622/
      LanguageContext.jsx
    remove_knowledgeLevel_v2/
      20260106_101318/
        dump_backend_ccg.sh
        .ccg_backups/
          tool_output_final/
            20260103_045619/
            20260103_050838/
          fix_formatted_loop_20260103_092024/
            ccgRoutes.js
          lock_tool_contract_20260103_093401/
            client/
            server/
          fix_object_object_ui/
            20260103_100241/
          generator_toolstyle_fix/
            20260102_113354/
            20260102_125743/
          generator_toolstyle_v2/
            20260102_113847/
          fix_formatOutput_undefined/
            20260103_074437/
              ccgRoutes.js
          ui_contract_stabilize/
            20260103_103042/
          fix_formatted_var/
            20260103_071421/
          lock_generate_json_contract/
            20260106_090951/
          fix_formatted_syntax_20260103_093751/
            ccgRoutes.js
          dedupe_formatToolResponse/
            20260103_072923/
              ccgRoutes.js
          chatmode_v2/
            chatRoutes.js.bak_20260102_052924
          fix_dup_import/
            20260103_055255/
              ccgRoutes.js
          chatmode_v3/
            chatStore.js.bak_20260102_060354
          fix_contract_20260106_062417/
            client/
            server/
          lock_generate_contract_v2/
            20260106_080311/
          stabilize_tool_contract/
            20260103_073656/
              ccgRoutes.js
          final_format_lock/
            20260103_081321/
          fix_object_object_20260103_095046/
            server/
          generator_toolstyle_stable/
            20260102_140213/
              ccgRoutes.js
          fix_backend_frontend_20260103_091446/
            client/
            server/
          mainpage_chat_hybrid_v1/
            20260102_095356/
          fix_ping_500_20260103_094113/
            ccgRoutes.js
          fix_toolstyle/
            20260102_132229/
              ccgRoutes.js.current
          generator_toolstyle_final/
            20260102_131017/
            20260102_131044/
          final_stable_contract/
            20260106_082556/
          tool_contract_v1/
            20260103_055028/
          generator_toolfix_v1/
            20260102_111613/
          final_tool_layout/
            20260103_053551/
          toolstyle_20260102_112342/
            ccgRoutes.js.bak
          toolstyle_fix/
            20260102_131717/
          tool_contract_stable/
            20260103_090201/
          fix_formatter_export/
            20260102_132809/
          lock_generate_contract/
            20260106_074819/
          chatmode_v2_fix/
            chatRoutes.js.bak_20260102_054158
            chatStore.js.bak_20260102_054158
          server_up_fix/
            20260103_075133/
          mainpage_finish_v1/
            20260102_125019/
          mainpage_finish_v2/
            20260102_134820/
          mainpage_stabilize/
            20260102_135643/
              ccgRoutes.js
          generator_toolstyle_v3/
            20260102_130322/
          day1_freeze_generator_20260106_072441/
            client/
            server/
          generator_toolstyle_lock/
            20260102_140932/
            20260103_042523/
          HARD_LOCK_CONTRACT_20260106_064240/
            client/
            server/
          day1_contract_lock/
            20260106_061449/
        client/
          src/
            pages/
            components/
            services/
              aiService.js
        server/
          utils/
            aiClient.js
            chatStore.js
            promptBuilder.js
            outputFormatter.js
            promptTransformer.js
          routes/
            ccgRoutes.js
            ccgRoutes.js.bak_20251231_152829
            chatRoutes.js
            ccgRoutes.js.bak_20251231_161753
            ccgRoutes.js.bak_20251231_161246
            ccgRoutes.js.bak_20251231_145434
        middleware/
          ccgNormalize.js
        cli/
          cmdgen-cli.js
          modules/
            codeCompare.js
    fix_generator_network_advanced_20260107_170115/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          context/
            LanguageContext.jsx
          components/
            ui/
              ToolResult.jsx
      server/
        utils/
          outputFormatter.js
    day1_freeze_generator_20260106_072441/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    20260108_101607/
      client/
        src/
          components/
            ui/
              MarkdownBox.jsx
    20260124_045626/
      client/
        src/
          components/
            ui/
              ToolResult.jsx
    fix_eof_simple/
      20260107_090723/
        GeneratorPage.jsx
    fix_openai_timeout_20260107_133430/
      ccgRoutes.js
    generator_toolstyle_lock/
      20260102_140932/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
      20260103_042523/
        server/
          utils/
            outputFormatter.js
          routes/
            ccgRoutes.js
    HARD_LOCK_CONTRACT_20260106_064240/
      client/
        src/
          pages/
            generator/
              GeneratorPage.jsx
          components/
            ui/
              ToolResult.jsx
          services/
            aiService.js
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    outputFormatter_rescue/
      20260103_043745/
        server/
          utils/
            outputFormatter.js
    fix_t_before_init_20260108_062808/
      GeneratorPage.jsx
      LanguageContext.jsx
    fix_tool_json_backend_first_20260108_062117/
      client/
        src/
          components/
            ui/
              ToolResult.jsx
      server/
        utils/
          outputFormatter.js
        routes/
          ccgRoutes.js
    fix_chat_404/
      _etc_nginx_sites-available_ccg.bak_20260102_062450
      client_vite.config.js.bak_20260102_062450
      _etc_nginx_conf.d_00-cando-http-override.conf.off.bak_20260102_062450
    day1_contract_lock/
      20260106_061449/
        client/
          src/
            pages/
            components/
            services/
              aiService.js
        server/
          utils/
            aiClient.js
            promptBuilder.js
            outputFormatter.js
          routes/
            ccgRoutes.js
  client/
    ccg_debug_dump.sh
    package.json
    main.jsx
    tailwind.config.js
    postcss.config.jsx
    dump_runtime_bits.sh
    package-lock.json
    dump_ccg_files.sh
    index.html
    postcss.config.js
    vite.config.js
    dist/
      android-chrome-512x512.png
      apple-touch-icon.png
      logo (2).png
      favicon-32x32.png
      favicon-16x16.png
      android-chrome-192x192.png
      index.html
      about.txt
      favicon.ico
      site.webmanifest
      background.svg
      assets/
        vazirmatn-latin-ext-500-normal-CgxvvVrG.woff2
        inter-cyrillic-700-normal-CjBOestx.woff2
        inter-latin-ext-500-normal-CV4jyFjo.woff2
        inter-greek-ext-400-normal-KugGGMne.woff
        inter-cyrillic-500-normal-BasfLYem.woff2
        inter-cyrillic-ext-500-normal-B0yAr1jD.woff2
        inter-latin-ext-600-normal-CIVaiw4L.woff
        vazirmatn-latin-300-normal-BoU4YpvD.woff2
        inter-greek-400-normal-q2sYcFCs.woff
        inter-vietnamese-500-normal-mJboJaSs.woff
        inter-cyrillic-300-normal-LR1W_oT8.woff
        vazirmatn-latin-ext-500-normal-4XgegWYb.woff
        inter-latin-400-normal-CyCys3Eg.woff
        inter-latin-700-normal-Yt3aPRUw.woff2
        vazirmatn-latin-ext-300-normal-C0szevm-.woff2
        inter-cyrillic-600-normal-CWCymEST.woff2
        inter-greek-ext-500-normal-2j5mBUwD.woff
        vazirmatn-latin-ext-700-normal-BfoXmNMx.woff2
        inter-latin-300-normal-BVlfKGgI.woff2
        vazirmatn-arabic-700-normal-Dge_DOjm.woff2
        vazirmatn-arabic-600-normal-CPKvAnd1.woff2
        inter-vietnamese-700-normal-DlLaEgI2.woff2
        vazirmatn-arabic-300-normal-BYd1kBEw.woff2
        inter-latin-ext-500-normal-BxGbmqWO.woff
        inter-vietnamese-600-normal-Cc8MFFhd.woff2
        vazirmatn-arabic-500-normal-C_lbnnKa.woff2
        vazirmatn-arabic-600-normal-CWYTfCgi.woff
        vazirmatn-latin-ext-300-normal-e-3YDG27.woff
        inter-greek-300-normal-BrhSP0vQ.woff
        inter-greek-ext-700-normal-BoQ6DsYi.woff
        vazirmatn-latin-600-normal-D-zF-Oec.woff2
        inter-cyrillic-ext-500-normal-BmqWE9Dz.woff
        inter-cyrillic-ext-400-normal-DQukG94-.woff
        inter-vietnamese-300-normal-DDGmYYdT.woff
        inter-greek-ext-300-normal-DLbbeei1.woff
        vazirmatn-arabic-400-normal-DMZFCm7K.woff2
        inter-cyrillic-600-normal-4D_pXhcN.woff
        inter-greek-ext-400-normal-DGGRlc-M.woff2
        inter-cyrillic-ext-600-normal-Bcila6Z-.woff
        vazirmatn-latin-500-normal-6zZzgpg4.woff2
        inter-latin-ext-700-normal-Ca8adRJv.woff2
        inter-greek-500-normal-BIZE56-Y.woff2
        index-BNEpSb4Y.js
        inter-cyrillic-ext-400-normal-BQZuk6qB.woff2
        inter-cyrillic-ext-700-normal-LO58E6JB.woff
        inter-latin-ext-700-normal-TidjK2hL.woff
        inter-latin-400-normal-C38fXH4l.woff2
        inter-cyrillic-500-normal-CxZf_p3X.woff
        inter-greek-ext-300-normal-l2DDyC6M.woff2
        vazirmatn-latin-300-normal-C6mM4Yld.woff
        inter-greek-300-normal-DmGD3g_f.woff2
        inter-cyrillic-400-normal-obahsSVq.woff2
        inter-greek-700-normal-C3JjAnD8.woff2
        inter-cyrillic-400-normal-HOLc17fK.woff
        inter-latin-500-normal-Cerq10X2.woff2
        inter-vietnamese-600-normal-BuLX-rYi.woff
        inter-greek-ext-700-normal-qfdV9bQt.woff2
        inter-vietnamese-400-normal-DMkecbls.woff2
        inter-cyrillic-ext-600-normal-Dfes3d0z.woff2
        vazirmatn-arabic-300-normal-DLHw88_k.woff
        vazirmatn-latin-ext-400-normal-DPxMaNjI.woff
        inter-vietnamese-400-normal-Bbgyi5SW.woff
        inter-cyrillic-ext-300-normal-RId2JxDB.woff
        inter-latin-500-normal-BL9OpVg8.woff
        inter-latin-ext-600-normal-D2bJ5OIk.woff2
        vazirmatn-latin-400-normal-BT_DHTc7.woff2
        inter-latin-600-normal-CiBQ2DWP.woff
        inter-greek-400-normal-B4URO6DV.woff2
        inter-latin-ext-300-normal-CPgO9Ksf.woff2
        inter-cyrillic-300-normal-BnqRxXuy.woff2
        vazirmatn-latin-500-normal-Bg_BALlD.woff
        inter-greek-600-normal-BZpKdvQh.woff
        vazirmatn-arabic-400-normal-C4W5XURk.woff
        vazirmatn-arabic-700-normal-B5nPuCFv.woff
        inter-latin-300-normal-i8F0SvXL.woff
        vazirmatn-latin-400-normal-GKyMcI03.woff
        vazirmatn-latin-700-normal-9BlbvDRV.woff2
        vazirmatn-arabic-500-normal-Dqq3-xo3.woff
        vazirmatn-latin-ext-400-normal-BdGhO0lm.woff2
        vazirmatn-latin-ext-600-normal-CyxCUfFz.woff2
        inter-latin-ext-300-normal-Dp1L8vcn.woff
        inter-cyrillic-700-normal-DrXBdSj3.woff
        inter-greek-500-normal-Xzm54t5V.woff
        inter-greek-ext-500-normal-C4iEst2y.woff2
        vazirmatn-latin-ext-700-normal-DMYLqBto.woff
        inter-greek-600-normal-plRanbMR.woff2
        inter-greek-ext-600-normal-DRtmH8MT.woff2
        inter-vietnamese-300-normal-Bdr24Bqb.woff2
        vazirmatn-latin-ext-600-normal-Di8rk35l.woff
        vazirmatn-latin-700-normal-DrB0PBU6.woff
        inter-latin-600-normal-LgqL8muc.woff2
        vazirmatn-latin-600-normal-BxJiDPKT.woff
        inter-cyrillic-ext-700-normal-BjwYoWNd.woff2
        inter-vietnamese-500-normal-DOriooB6.woff2
        inter-vietnamese-700-normal-BZaoP0fm.woff
        inter-greek-700-normal-BUv2fZ6O.woff
        index-D50Gz8y3.css
        inter-latin-ext-400-normal-C1nco2VV.woff2
        inter-cyrillic-ext-300-normal-CgCALhwJ.woff2
        inter-latin-ext-400-normal-77YHD8bZ.woff
        inter-latin-700-normal-BLAVimhd.woff
        inter-greek-ext-600-normal-B8X0CLgF.woff
    public/
      android-chrome-512x512.png
      apple-touch-icon.png
      logo (2).png
      favicon-32x32.png
      favicon-16x16.png
      android-chrome-192x192.png
      about.txt
      favicon.ico
      site.webmanifest
      background.svg
    node_modules/
      .package-lock.json
      readdirp/
        package.json
        LICENSE
        README.md
        index.d.ts
        index.js
      is-alphanumerical/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      postcss-load-config/
        package.json
        LICENSE
        README.md
        src/
          options.js
          req.js
          plugins.js
          index.d.ts
          index.js
      trough/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      yallist/
        iterator.js
        package.json
        LICENSE
        README.md
        yallist.js
      jiti/
        package.json
        LICENSE
        register.js
        README.md
        dist/
          babel.js
          types.d.ts
          jiti.js
          jiti.d.ts
          babel.d.ts
          utils.d.ts
          plugins/
            import-meta-env.d.ts
            babel-plugin-transform-import-meta.d.ts
        lib/
          index.js
        bin/
          jiti.js
      pirates/
        package.json
        LICENSE
        README.md
        index.d.ts
        lib/
          index.js
      is-hexadecimal/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      parse-entities/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
          index.d.ts.map
        node_modules/
          @types/
            unist/
              package.json
              LICENSE
              README.md
              index.d.ts
      unist-util-visit-parents/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          color.d.ts
          color.node.js
          color.node.d.ts
          index.d.ts
          color.js
          index.js
          index.d.ts.map
          color.node.d.ts.map
          color.d.ts.map
      es-object-atoms/
        RequireObjectCoercible.d.ts
        CHANGELOG.md
        package.json
        ToObject.js
        LICENSE
        tsconfig.json
        isObject.js
        README.md
        .eslintrc
        RequireObjectCoercible.js
        ToObject.d.ts
        index.d.ts
        index.js
        isObject.d.ts
        test/
          index.js
        .github/
          FUNDING.yml
      is-core-module/
        CHANGELOG.md
        package.json
        LICENSE
        .nycrc
        README.md
        .eslintrc
        core.json
        index.js
        test/
          index.js
      mdast-util-gfm-table/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      fast-glob/
        package.json
        LICENSE
        README.md
        out/
          settings.js
          settings.d.ts
          index.d.ts
          index.js
          readers/
            stream.d.ts
            reader.d.ts
            stream.js
            sync.js
            sync.d.ts
            async.d.ts
            reader.js
            async.js
          utils/
            path.d.ts
            stream.d.ts
            pattern.d.ts
            array.js
            stream.js
            errno.js
            path.js
            pattern.js
            fs.d.ts
            array.d.ts
            errno.d.ts
            index.d.ts
            string.d.ts
            index.js
            string.js
            fs.js
          types/
            index.d.ts
            index.js
          providers/
            provider.js
            stream.d.ts
            stream.js
            sync.js
            provider.d.ts
            sync.d.ts
            async.d.ts
            async.js
            filters/
              entry.js
              error.js
              deep.d.ts
              deep.js
              entry.d.ts
              error.d.ts
            matchers/
              partial.d.ts
              matcher.d.ts
              partial.js
              matcher.js
            transformers/
              entry.js
              entry.d.ts
          managers/
            tasks.d.ts
            tasks.js
        node_modules/
          glob-parent/
            CHANGELOG.md
            package.json
            LICENSE
            README.md
            index.js
      micromark-util-chunked/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      update-browserslist-db/
        utils.js
        package.json
        check-npm-version.js
        LICENSE
        README.md
        cli.js
        index.d.ts
        index.js
      micromark-util-symbol/
        package.json
        license
        readme.md
        lib/
          values.d.ts
          codes.d.ts
          constants.js
          types.d.ts
          codes.js
          codes.d.ts.map
          values.js
          default.d.ts.map
          constants.d.ts
          types.js
          default.d.ts
          types.d.ts.map
          constants.d.ts.map
          values.d.ts.map
          default.js
      normalize-path/
        package.json
        LICENSE
        README.md
        index.js
      zwitch/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      stringify-entities/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          core.js
          core.d.ts
          index.d.ts
          index.js
          util/
            to-decimal.js
            to-named.d.ts
            to-named.js
            format-basic.d.ts
            format-basic.js
            format-smart.d.ts
            to-hexadecimal.d.ts
            to-hexadecimal.js
            to-decimal.d.ts
            format-smart.js
          constant/
            dangerous.js
            dangerous.d.ts
      react-router-dom/
        package.json
        README.md
        LICENSE.md
        dist/
          index.mjs
          index.d.ts
          index.js
          index.d.mts
      style-to-js/
        package.json
        LICENSE
        README.md
        umd/
          style-to-js.min.js
          style-to-js.min.js.map
          style-to-js.js
          style-to-js.js.map
        cjs/
          utilities.js.map
          utilities.d.ts
          utilities.d.ts.map
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
          utilities.js
        src/
          index.ts
          index.test.ts
          utilities.test.ts
          utilities.ts
      binary-extensions/
        package.json
        binary-extensions.json.d.ts
        license
        binary-extensions.json
        readme.md
        index.d.ts
        index.js
      dlv/
        package.json
        README.md
        index.js
        dist/
          dlv.js.map
          dlv.umd.js
          dlv.es.js
          dlv.umd.js.map
          dlv.es.js.map
          dlv.js
      @monaco-editor/
        loader/
          CHANGELOG.md
          package.json
          rollup.config.mjs
          LICENSE
          README.md
          tea.yaml
          .babelrc
          eslint.config.mjs
          lib/
            types.d.ts
            umd/
              monaco-loader.min.js
              monaco-loader.js
            es/
              index.js
            cjs/
              index.js
          playground/
            package.json
            package-lock.json
            index.html
            main.js
          .husky/
            pre-commit
        react/
          CHANGELOG.md
          .prettierrc.json
          package.json
          CODE_OF_CONDUCT.md
          LICENSE
          tsconfig.json
          README.md
          tea.yaml
          setupTests.ts
          vitest.config.ts
          tsup.config.ts
          v4.changes.md
          dist/
            index.mjs
            index.js.map
            index.d.ts
            index.js
            index.mjs.map
          .github/
            FUNDING.yml
            ISSUE_TEMPLATE/
              feature_request.md
              bug_report.md
      hast-util-to-jsx-runtime/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          types.d.ts
          index.d.ts
          types.js
          index.js
          index.d.ts.map
      mdast-util-mdx-expression/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      postcss-selector-parser/
        CHANGELOG.md
        package.json
        README.md
        postcss-selector-parser.d.ts
        LICENSE-MIT
        API.md
        dist/
          sortAscending.js
          processor.js
          parser.js
          tokenTypes.js
          index.js
          tokenize.js
          util/
            stripComments.js
            ensureObject.js
            unesc.js
            index.js
            getProp.js
          selectors/
            pseudo.js
            nesting.js
            id.js
            attribute.js
            className.js
            container.js
            constructors.js
            node.js
            combinator.js
            namespace.js
            guards.js
            tag.js
            root.js
            types.js
            universal.js
            index.js
            comment.js
            selector.js
            string.js
      mdast-util-from-markdown/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          types.d.ts
          index.d.ts
          types.js
          index.js
        dev/
          index.d.ts
          index.js
          lib/
            types.d.ts
            index.d.ts
            types.js
            index.js
            index.d.ts.map
      tailwindcss/
        CHANGELOG.md
        colors.js
        package.json
        defaultConfig.d.ts
        variants.css
        defaultConfig.js
        colors.d.ts
        defaultTheme.js
        loadConfig.js
        LICENSE
        loadConfig.d.ts
        screens.css
        base.css
        tailwind.css
        README.md
        resolveConfig.d.ts
        components.css
        utilities.css
        resolveConfig.js
        prettier.config.js
        plugin.d.ts
        plugin.js
        defaultTheme.d.ts
        lib/
          featureFlags.js
          processTailwindFeatures.js
          cli.js
          cli-peer-dependencies.js
          corePluginList.js
          corePlugins.js
          index.js
          plugin.js
          postcss-plugins/
            nesting/
              README.md
              index.js
              plugin.js
          lib/
            partitionApplyAtRules.js
            defaultExtractor.js
            collapseAdjacentRules.js
            regex.js
            expandApplyAtRules.js
            evaluateTailwindFunctions.js
            sharedState.js
            normalizeTailwindDirectives.js
            collapseDuplicateDeclarations.js
            generateRules.js
            setupContextUtils.js
            findAtConfigPath.js
            setupTrackingContext.js
            cacheInvalidation.js
            content.js
            load-config.js
            resolveDefaultsAtRules.js
            getModuleDependencies.js
            remap-bitfield.js
            substituteScreenAtRules.js
            expandTailwindAtRules.js
            offsets.js
          util/
            isSyntacticallyValidPropertyValue.js
            applyImportantSelector.js
            pluginUtils.js
            escapeCommas.js
            negateValue.js
            toPath.js
            validateFormalSyntax.js
            dataTypes.js
            parseGlob.js
            splitAtTopLevelOnly.js
            normalizeConfig.js
            getAllConfigs.js
            createUtilityPlugin.js
            normalizeScreens.js
            nameClass.js
            configurePlugins.js
            transformThemeValue.js
            hashConfig.js
            log.js
            flattenColorPalette.js
            cloneNodes.js
            removeAlphaVariables.js
            parseBoxShadowValue.js
            validateConfig.js
            prefixSelector.js
            pseudoElements.js
            responsive.js
            bigSign.js
            toColorValue.js
            colorNames.js
            buildMediaQuery.js
            parseObjectStyles.js
            createPlugin.js
            color.js
            resolveConfig.js
            withAlphaVariable.js
            formatVariantSelector.js
            parseAnimationValue.js
            parseDependency.js
            escapeClassName.js
            isPlainObject.js
            defaults.js
            cloneDeep.js
            isKeyframeRule.js
            tap.js
            resolveConfigPath.js
          public/
            colors.js
            resolve-config.js
            load-config.js
            default-theme.js
            default-config.js
            create-plugin.js
          css/
            LICENSE
            preflight.css
          value-parser/
            walk.js
            stringify.js
            LICENSE
            unit.js
            README.md
            index.js
            index.d.js
            parse.js
          cli/
            index.js
            help/
              index.js
            init/
              index.js
            build/
              utils.js
              watching.js
              index.js
              plugin.js
              deps.js
        nesting/
          index.d.ts
          index.js
        scripts/
          create-plugin-list.js
          generate-types.js
          release-notes.js
          release-channel.js
          type-utils.js
        stubs/
          tailwind.config.ts
          .prettierrc.json
          config.simple.js
          tailwind.config.js
          config.full.js
          postcss.config.cjs
          .npmignore
          tailwind.config.cjs
          postcss.config.js
        src/
          featureFlags.js
          processTailwindFeatures.js
          cli.js
          cli-peer-dependencies.js
          corePluginList.js
          corePlugins.js
          index.js
          plugin.js
          postcss-plugins/
            nesting/
              README.md
              index.js
              plugin.js
          lib/
            partitionApplyAtRules.js
            defaultExtractor.js
            collapseAdjacentRules.js
            regex.js
            expandApplyAtRules.js
            evaluateTailwindFunctions.js
            sharedState.js
            normalizeTailwindDirectives.js
            collapseDuplicateDeclarations.js
            generateRules.js
            setupContextUtils.js
            findAtConfigPath.js
            setupTrackingContext.js
            load-config.ts
            cacheInvalidation.js
            content.js
            resolveDefaultsAtRules.js
            getModuleDependencies.js
            remap-bitfield.js
            substituteScreenAtRules.js
            expandTailwindAtRules.js
            offsets.js
          util/
            isSyntacticallyValidPropertyValue.js
            applyImportantSelector.js
            pluginUtils.js
            escapeCommas.js
            negateValue.js
            toPath.js
            validateFormalSyntax.js
            dataTypes.js
            parseGlob.js
            splitAtTopLevelOnly.js
            normalizeConfig.js
            getAllConfigs.js
            createUtilityPlugin.js
            normalizeScreens.js
            nameClass.js
            configurePlugins.js
            transformThemeValue.js
            hashConfig.js
            log.js
            flattenColorPalette.js
            cloneNodes.js
            removeAlphaVariables.js
            parseBoxShadowValue.js
            validateConfig.js
            prefixSelector.js
            pseudoElements.js
            responsive.js
            bigSign.js
            toColorValue.js
            colorNames.js
            buildMediaQuery.js
            parseObjectStyles.js
            createPlugin.js
            color.js
            resolveConfig.js
            withAlphaVariable.js
            formatVariantSelector.js
            parseAnimationValue.js
            parseDependency.js
            escapeClassName.js
            isPlainObject.js
            defaults.js
            cloneDeep.js
            isKeyframeRule.js
            tap.js
            resolveConfigPath.js
          public/
            colors.js
            resolve-config.js
            load-config.js
            default-theme.js
            default-config.js
            create-plugin.js
          css/
            LICENSE
            preflight.css
          value-parser/
            walk.js
            stringify.js
            LICENSE
            unit.js
            README.md
            index.d.ts
            index.js
            parse.js
          cli/
            index.js
            help/
              index.js
            init/
              index.js
            build/
              utils.js
              watching.js
              index.js
              plugin.js
              deps.js
        peers/
          index.js
        types/
          config.d.ts
          index.d.ts
          generated/
            corePluginList.d.ts
            colors.d.ts
            default-theme.d.ts
            .gitkeep
      object-assign/
        package.json
        license
        readme.md
        index.js
      dunder-proto/
        CHANGELOG.md
        package.json
        get.js
        LICENSE
        tsconfig.json
        set.js
        .nycrc
        README.md
        .eslintrc
        get.d.ts
        set.d.ts
        test/
          get.js
          set.js
          index.js
        .github/
          FUNDING.yml
      @nodelib/
        fs.scandir/
          package.json
          LICENSE
          README.md
          out/
            constants.js
            settings.js
            settings.d.ts
            constants.d.ts
            index.d.ts
            index.js
            adapters/
              fs.d.ts
              fs.js
            utils/
              fs.d.ts
              index.d.ts
              index.js
              fs.js
            types/
              index.d.ts
              index.js
            providers/
              common.d.ts
              sync.js
              common.js
              sync.d.ts
              async.d.ts
              async.js
        fs.stat/
          package.json
          LICENSE
          README.md
          out/
            settings.js
            settings.d.ts
            index.d.ts
            index.js
            adapters/
              fs.d.ts
              fs.js
            types/
              index.d.ts
              index.js
            providers/
              sync.js
              sync.d.ts
              async.d.ts
              async.js
        fs.walk/
          package.json
          LICENSE
          README.md
          out/
            settings.js
            settings.d.ts
            index.d.ts
            index.js
            readers/
              common.d.ts
              reader.d.ts
              sync.js
              common.js
              sync.d.ts
              async.d.ts
              reader.js
              async.js
            types/
              index.d.ts
              index.js
            providers/
              stream.d.ts
              stream.js
              sync.js
              sync.d.ts
              async.d.ts
              index.d.ts
              index.js
              async.js
      to-regex-range/
        package.json
        LICENSE
        README.md
        index.js
      micromark-factory-space/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      baseline-browser-mapping/
        package.json
        README.md
        LICENSE.txt
        dist/
          cli.js
          index.d.ts
          index.js
          index.cjs
      @rollup/
        rollup-linux-x64-musl/
          package.json
          README.md
          rollup.linux-x64-musl.node
        rollup-linux-x64-gnu/
          package.json
          rollup.linux-x64-gnu.node
          README.md
      micromark-util-types/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      csstype/
        package.json
        LICENSE
        README.md
        index.d.ts
        index.js.flow
      micromark-util-sanitize-uri/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      math-intrinsics/
        CHANGELOG.md
        package.json
        floor.js
        abs.js
        sign.d.ts
        round.d.ts
        pow.d.ts
        mod.d.ts
        LICENSE
        pow.js
        tsconfig.json
        floor.d.ts
        isNaN.d.ts
        isNegativeZero.js
        isNaN.js
        max.js
        isFinite.d.ts
        min.d.ts
        README.md
        sign.js
        .eslintrc
        abs.d.ts
        isInteger.d.ts
        round.js
        isInteger.js
        mod.js
        isFinite.js
        min.js
        isNegativeZero.d.ts
        max.d.ts
        constants/
          maxValue.d.ts
          maxSafeInteger.d.ts
          maxSafeInteger.js
          maxValue.js
          maxArrayLength.d.ts
          maxArrayLength.js
        test/
          index.js
        .github/
          FUNDING.yml
      convert-source-map/
        package.json
        LICENSE
        README.md
        index.js
      inline-style-parser/
        package.json
        LICENSE
        README.md
        index.d.ts
        dist/
          inline-style-parser.js.map
          inline-style-parser.min.js.map
          inline-style-parser.min.js
          inline-style-parser.js
        cjs/
          index.d.cts
          index.js.map
          index.js
        esm/
          index.mjs
          index.mjs.map
          index.d.mts
      mdast-util-gfm/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      unist-util-position/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      state-local/
        CHANGELOG.md
        package.json
        rollup.config.mjs
        LICENSE
        README.md
        lib/
          types.d.ts
          umd/
            state-local.js
            state-local.min.js
          es/
            state-local.js
          cjs/
            state-local.js
      remark-parse/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      resolve/
        package.json
        SECURITY.md
        LICENSE
        sync.js
        .eslintrc
        .editorconfig
        index.js
        async.js
        readme.markdown
        lib/
          node-modules-paths.js
          core.js
          homedir.js
          normalize-options.js
          caller.js
          sync.js
          core.json
          is-core.js
          async.js
        test/
          mock_sync.js
          nonstring.js
          node-modules-paths.js
          resolver_sync.js
          resolver.js
          node_path.js
          core.js
          dotdot.js
          home_paths.js
          filter.js
          symlinks.js
          filter_sync.js
          subdirs.js
          precedence.js
          faulty_basedir.js
          home_paths_sync.js
          shadowed_core.js
          module_dir.js
          pathfilter.js
          mock.js
          shadowed_core/
            node_modules/
          node_path/
            y/
            x/
          resolver/
            mug.coffee
            mug.js
            foo.js
            cup.coffee
            baz/
              package.json
              doom.js
              quux.js
            quux/
            browser_field/
              package.json
              b.js
              a.js
            same_names/
              foo.js
            invalid_main/
              package.json
            other_path/
              root.js
            multirepo/
              package.json
              lerna.json
            dot_slash_main/
              package.json
              index.js
            false_main/
              package.json
              index.js
            without_basedir/
              main.js
            symlinked/
            nested_symlinks/
            incorrect_main/
              package.json
              index.js
            dot_main/
              package.json
              index.js
          dotdot/
            index.js
            abc/
              index.js
          pathfilter/
            deep_ref/
              main.js
          module_dir/
            xmodules/
            zmodules/
            ymodules/
          precedence/
            aaa.js
            bbb.js
            bbb/
              main.js
            aaa/
              index.js
              main.js
        bin/
          resolve
        .github/
          THREAT_MODEL.md
          FUNDING.yml
          INCIDENT_RESPONSE_PROCESS.md
        example/
          sync.js
          async.js
      es-define-property/
        CHANGELOG.md
        package.json
        LICENSE
        tsconfig.json
        .nycrc
        README.md
        .eslintrc
        index.d.ts
        index.js
        test/
          index.js
        .github/
          FUNDING.yml
      mdast-util-gfm-autolink-literal/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      postcss-value-parser/
        package.json
        LICENSE
        README.md
        lib/
          walk.js
          stringify.js
          unit.js
          index.d.ts
          index.js
          parse.js
      micromark-core-commonmark/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          content.d.ts.map
          character-reference.js
          html-flow.d.ts
          content.d.ts
          label-start-link.d.ts
          blank-line.d.ts
          html-text.d.ts.map
          list.d.ts.map
          hard-break-escape.d.ts.map
          label-end.d.ts.map
          thematic-break.d.ts.map
          heading-atx.d.ts.map
          code-text.d.ts.map
          thematic-break.d.ts
          hard-break-escape.d.ts
          code-fenced.d.ts.map
          code-indented.d.ts.map
          label-start-link.d.ts.map
          code-text.js
          label-start-image.d.ts
          character-reference.d.ts.map
          label-end.js
          blank-line.js
          setext-underline.d.ts.map
          heading-atx.js
          autolink.d.ts
          label-end.d.ts
          line-ending.js
          block-quote.d.ts.map
          character-reference.d.ts
          blank-line.d.ts.map
          line-ending.d.ts
          attention.d.ts.map
          definition.d.ts.map
          block-quote.d.ts
          character-escape.js
          label-start-image.d.ts.map
          block-quote.js
          list.d.ts
          character-escape.d.ts.map
          line-ending.d.ts.map
          attention.js
          html-text.d.ts
          content.js
          autolink.d.ts.map
          label-start-link.js
          code-indented.d.ts
          hard-break-escape.js
          html-text.js
          definition.js
          code-fenced.js
          code-text.d.ts
          setext-underline.d.ts
          attention.d.ts
          list.js
          definition.d.ts
          autolink.js
          label-start-image.js
          code-indented.js
          heading-atx.d.ts
          thematic-break.js
          html-flow.d.ts.map
          setext-underline.js
          code-fenced.d.ts
          character-escape.d.ts
          html-flow.js
        dev/
          index.d.ts
          index.js
          index.d.ts.map
          lib/
            content.d.ts.map
            character-reference.js
            html-flow.d.ts
            content.d.ts
            label-start-link.d.ts
            blank-line.d.ts
            html-text.d.ts.map
            list.d.ts.map
            hard-break-escape.d.ts.map
            label-end.d.ts.map
            thematic-break.d.ts.map
            heading-atx.d.ts.map
            code-text.d.ts.map
            thematic-break.d.ts
            hard-break-escape.d.ts
            code-fenced.d.ts.map
            code-indented.d.ts.map
            label-start-link.d.ts.map
            code-text.js
            label-start-image.d.ts
            character-reference.d.ts.map
            label-end.js
            blank-line.js
            setext-underline.d.ts.map
            heading-atx.js
            autolink.d.ts
            label-end.d.ts
            line-ending.js
            block-quote.d.ts.map
            character-reference.d.ts
            blank-line.d.ts.map
            line-ending.d.ts
            attention.d.ts.map
            definition.d.ts.map
            block-quote.d.ts
            character-escape.js
            label-start-image.d.ts.map
            block-quote.js
            list.d.ts
            character-escape.d.ts.map
            line-ending.d.ts.map
            attention.js
            html-text.d.ts
            content.js
            autolink.d.ts.map
            label-start-link.js
            code-indented.d.ts
            hard-break-escape.js
            html-text.js
            definition.js
            code-fenced.js
            code-text.d.ts
            setext-underline.d.ts
            attention.d.ts
            list.js
            definition.d.ts
            autolink.js
            label-start-image.js
            code-indented.js
            heading-atx.d.ts
            thematic-break.js
            html-flow.d.ts.map
            setext-underline.js
            code-fenced.d.ts
            character-escape.d.ts
            html-flow.js
      micromark-extension-gfm-strikethrough/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          html.d.ts
          html.js
          syntax.d.ts
          syntax.js
        dev/
          index.d.ts
          index.js
          lib/
            html.d.ts
            html.js
            syntax.d.ts
            syntax.js
      micromark-factory-title/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      js-tokens/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        index.js
      mdast-util-gfm-strikethrough/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      ms/
        package.json
        license.md
        readme.md
        index.js
      camelcase-css/
        package.json
        index-es5.js
        README.md
        license
        index.js
      mdast-util-to-markdown/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          configure.d.ts.map
          unsafe.js
          configure.js
          unsafe.d.ts
          types.d.ts
          unsafe.d.ts.map
          join.js
          index.d.ts
          types.js
          join.d.ts
          index.js
          index.d.ts.map
          join.d.ts.map
          configure.d.ts
          util/
            compile-pattern.js
            encode-character-reference.js
            track.d.ts.map
            format-heading-as-setext.d.ts.map
            check-list-item-indent.d.ts
            check-fence.js
            format-link-as-autolink.d.ts
            check-rule-repetition.d.ts
            check-strong.d.ts
            emphasis-strong-marker.d.ts.map
            check-rule-repetition.d.ts.map
            check-bullet-other.d.ts
            emphasis-strong-marker.d.ts
            check-rule.js
            indent-lines.d.ts
            check-rule-repetition.js
            check-bullet.d.ts.map
            compile-pattern.d.ts.map
            format-heading-as-setext.d.ts
            check-rule.d.ts
            format-code-as-indented.js
            check-quote.js
            check-list-item-indent.d.ts.map
            encode-info.js
            check-emphasis.js
            check-bullet-ordered.d.ts.map
            encode-info.d.ts
            track.d.ts
            encode-info.d.ts.map
            container-phrasing.d.ts
            check-quote.d.ts
            association.d.ts.map
            container-flow.d.ts.map
            check-bullet-ordered.d.ts
            safe.d.ts
            container-phrasing.d.ts.map
            compile-pattern.d.ts
            indent-lines.d.ts.map
            check-bullet-other.js
            indent-lines.js
            pattern-in-scope.js
            check-fence.d.ts
            track.js
            check-bullet-other.d.ts.map
            encode-character-reference.d.ts
            format-link-as-autolink.js
            container-flow.d.ts
            association.d.ts
            check-rule.d.ts.map
            check-bullet.d.ts
            pattern-in-scope.d.ts
            check-list-item-indent.js
            check-emphasis.d.ts.map
            format-link-as-autolink.d.ts.map
            check-bullet-ordered.js
            format-heading-as-setext.js
            safe.d.ts.map
            container-phrasing.js
            check-strong.js
            pattern-in-scope.d.ts.map
            safe.js
            format-code-as-indented.d.ts
            association.js
            format-code-as-indented.d.ts.map
            encode-character-reference.d.ts.map
            check-strong.d.ts.map
            check-bullet.js
            check-quote.d.ts.map
            check-emphasis.d.ts
            check-fence.d.ts.map
            container-flow.js
          handle/
            inline-code.d.ts.map
            root.d.ts.map
            inline-code.js
            link-reference.d.ts
            list.d.ts.map
            thematic-break.d.ts.map
            link.d.ts.map
            html.d.ts.map
            text.js
            thematic-break.d.ts
            emphasis.d.ts.map
            heading.js
            image.d.ts
            link.d.ts
            code.js
            blockquote.d.ts.map
            code.d.ts
            strong.js
            paragraph.js
            html.d.ts
            html.js
            list-item.d.ts
            definition.d.ts.map
            root.d.ts
            heading.d.ts
            strong.d.ts.map
            paragraph.d.ts.map
            image.d.ts.map
            list.d.ts
            link.js
            emphasis.d.ts
            list-item.d.ts.map
            image-reference.js
            blockquote.js
            root.js
            strong.d.ts
            image-reference.d.ts
            index.d.ts
            image.js
            paragraph.d.ts
            text.d.ts
            blockquote.d.ts
            text.d.ts.map
            link-reference.d.ts.map
            definition.js
            index.js
            break.d.ts
            index.d.ts.map
            code.d.ts.map
            emphasis.js
            list.js
            definition.d.ts
            break.js
            thematic-break.js
            break.d.ts.map
            link-reference.js
            image-reference.d.ts.map
            inline-code.d.ts
            list-item.js
            heading.d.ts.map
      micromark-extension-gfm-tagfilter/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      get-proto/
        CHANGELOG.md
        package.json
        Reflect.getPrototypeOf.js
        Object.getPrototypeOf.d.ts
        LICENSE
        tsconfig.json
        Reflect.getPrototypeOf.d.ts
        .nycrc
        README.md
        .eslintrc
        Object.getPrototypeOf.js
        index.d.ts
        index.js
        test/
          index.js
        .github/
          FUNDING.yml
      loose-envify/
        package.json
        LICENSE
        custom.js
        loose-envify.js
        README.md
        cli.js
        replace.js
        index.js
      has-tostringtag/
        CHANGELOG.md
        package.json
        shams.js
        LICENSE
        tsconfig.json
        .nycrc
        README.md
        .eslintrc
        index.d.ts
        shams.d.ts
        index.js
        test/
          index.js
          tests.js
          shams/
            get-own-property-symbols.js
            core-js.js
        .github/
          FUNDING.yml
      character-reference-invalid/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      thenify/
        package.json
        LICENSE
        README.md
        History.md
        index.js
      combined-stream/
        package.json
        Readme.md
        yarn.lock
        License
        lib/
          combined_stream.js
      lilconfig/
        package.json
        LICENSE
        readme.md
        src/
          index.d.ts
          index.js
      mdast-util-mdx-jsx/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      object-hash/
        package.json
        LICENSE
        index.js
        readme.markdown
        dist/
          object_hash.js
      react-dom/
        server.browser.js
        package.json
        test-utils.js
        client.js
        LICENSE
        profiling.js
        README.md
        server.node.js
        index.js
        server.js
        umd/
          react-dom-test-utils.development.js
          react-dom-server.browser.production.min.js
          react-dom.production.min.js
          react-dom-server-legacy.browser.development.js
          react-dom.profiling.min.js
          react-dom-server.browser.development.js
          react-dom-server-legacy.browser.production.min.js
          react-dom-test-utils.production.min.js
          react-dom.development.js
        cjs/
          react-dom-test-utils.development.js
          react-dom-server.browser.production.min.js
          react-dom.production.min.js
          react-dom-server-legacy.node.development.js
          react-dom-server-legacy.browser.development.js
          react-dom-server.node.production.min.js
          react-dom.profiling.min.js
          react-dom-server-legacy.node.production.min.js
          react-dom-server.browser.development.js
          react-dom-server-legacy.browser.production.min.js
          react-dom-test-utils.production.min.js
          react-dom.development.js
          react-dom-server.node.development.js
      path-parse/
        package.json
        LICENSE
        README.md
        index.js
      lines-and-columns/
        package.json
        LICENSE
        README.md
        build/
          index.d.ts
          index.js
      json5/
        package.json
        README.md
        LICENSE.md
        dist/
          index.min.mjs
          index.mjs
          index.min.js
          index.js
        lib/
          unicode.d.ts
          stringify.js
          require.js
          util.d.ts
          register.js
          cli.js
          parse.d.ts
          util.js
          index.d.ts
          index.js
          unicode.js
          stringify.d.ts
          parse.js
      gensync/
        package.json
        LICENSE
        README.md
        index.js
        index.js.flow
        test/
          .babelrc
          index.test.js
      unist-util-stringify-position/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      remark-stringify/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      is-binary-path/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      micromark-extension-gfm/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      is-alphabetical/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      browserslist/
        browser.js
        package.json
        LICENSE
        error.js
        node.js
        README.md
        cli.js
        index.d.ts
        error.d.ts
        index.js
        parse.js
      dompurify/
        package.json
        LICENSE
        README.md
        dist/
          purify.cjs.js
          purify.cjs.js.map
          purify.min.js.map
          purify.js.map
          purify.es.mjs.map
          purify.es.d.mts
          purify.js
          purify.cjs.d.ts
          purify.es.mjs
          purify.min.js
      react-markdown/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      anymatch/
        package.json
        LICENSE
        README.md
        index.d.ts
        index.js
      @rolldown/
        pluginutils/
          package.json
          LICENSE
          dist/
            index.d.cts
            index.d.ts
            index.js
            index.cjs
      micromark-util-combine-extensions/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
      autoprefixer/
        package.json
        LICENSE
        README.md
        lib/
          utils.js
          at-rule.js
          processor.js
          brackets.js
          supports.js
          old-selector.js
          old-value.js
          resolution.js
          vendor.js
          value.js
          declaration.js
          transition.js
          browsers.js
          info.js
          prefixes.js
          prefixer.js
          selector.js
          autoprefixer.d.ts
          autoprefixer.js
          hacks/
            grid-area.js
            image-set.js
            image-rendering.js
            filter-value.js
            gradient.js
            flex-wrap.js
            grid-column-align.js
            user-select.js
            pixelated.js
            background-size.js
            overscroll-behavior.js
            order.js
            place-self.js
            writing-mode.js
            flex-shrink.js
            grid-end.js
            cross-fade.js
            mask-border.js
            flex-flow.js
            text-decoration.js
            grid-row-column.js
            inline-logical.js
            placeholder.js
            align-items.js
            text-emphasis-position.js
            justify-content.js
            grid-template.js
            block-logical.js
            grid-utils.js
            filter.js
            autofill.js
            text-decoration-skip-ink.js
            flex-basis.js
            intrinsic.js
            align-content.js
            appearance.js
            transform-decl.js
            flex-spec.js
            border-radius.js
            flex-direction.js
            background-clip.js
            grid-rows-columns.js
            display-flex.js
            border-image.js
            mask-composite.js
            flex-grow.js
            placeholder-shown.js
            align-self.js
            break-props.js
            grid-row-align.js
            backdrop-filter.js
            file-selector-button.js
            grid-start.js
            print-color-adjust.js
            animation.js
            flex.js
            display-grid.js
            grid-template-areas.js
            fullscreen.js
        bin/
          autoprefixer
        data/
          prefixes.js
      node-releases/
        package.json
        LICENSE
        README.md
        data/
          processed/
            envs.json
          release-schedule/
            release-schedule.json
      estree-util-is-identifier-name/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      fastq/
        package.json
        SECURITY.md
        example.mjs
        eslint.config.js
        LICENSE
        README.md
        example.js
        queue.js
        index.d.ts
        bench.js
        test/
          tsconfig.json
          test.js
          example.ts
          promise.js
      character-entities/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      run-parallel/
        package.json
        LICENSE
        README.md
        index.js
      decode-named-character-reference/
        package.json
        license
        readme.md
        index.d.ts
        index.dom.d.ts.map
        index.dom.js
        index.js
        index.dom.d.ts
        index.d.ts.map
      micromark-extension-gfm-footnote/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          html.d.ts
          html.js
          syntax.d.ts
          syntax.js
        dev/
          index.d.ts
          index.js
          lib/
            html.d.ts
            html.js
            syntax.d.ts
            syntax.js
      markdown-table/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
      react-router/
        CHANGELOG.md
        package.json
        README.md
        LICENSE.md
        dist/
          development/
            index-react-server.d.ts
            chunk-AMVS5XVJ.js
            instrumentation-Unc20tLk.d.ts
            register-QkB3HGjm.d.mts
            dom-export.d.mts
            index-react-server.mjs
            index.mjs
            chunk-G3INQAYP.mjs
            index-react-server.d.mts
            chunk-4WY6JWTD.mjs
            chunk-PZWDWJAY.js
            dom-export.js
            router-CAvh_Drx.d.mts
            index-react-server-client.d.mts
            chunk-O4JVZSOY.js
            browser-C07r42Tt.d.mts
            index-react-server-client-Da3kmxNd.d.ts
            index-react-server.js
            dom-export.d.ts
            index-react-server-client.js
            index-react-server-client.mjs
            index.d.ts
            index-react-server-client.d.ts
            register-BpU9rFBJ.d.ts
            index.js
            dom-export.mjs
            index.d.mts
            browser-BbBXFHbO.d.ts
            index-react-server-client-rcoGPJhU.d.mts
            lib/
          production/
            chunk-FUSXQSWG.mjs
            index-react-server.d.ts
            instrumentation-Unc20tLk.d.ts
            register-QkB3HGjm.d.mts
            dom-export.d.mts
            index-react-server.mjs
            index.mjs
            chunk-FDUMZGKM.mjs
            index-react-server.d.mts
            dom-export.js
            router-CAvh_Drx.d.mts
            index-react-server-client.d.mts
            browser-C07r42Tt.d.mts
            chunk-EAIF67OW.js
            index-react-server-client-Da3kmxNd.d.ts
            index-react-server.js
            dom-export.d.ts
            chunk-QN64DHI4.js
            index-react-server-client.js
            index-react-server-client.mjs
            index.d.ts
            index-react-server-client.d.ts
            chunk-G5A35OQU.js
            register-BpU9rFBJ.d.ts
            index.js
            dom-export.mjs
            index.d.mts
            browser-BbBXFHbO.d.ts
            index-react-server-client-rcoGPJhU.d.mts
            lib/
      micromark-util-normalize-identifier/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      monaco-editor/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        ThirdPartyNotices.txt
        monaco.d.ts
        dev/
          vs/
            workers-p6mTW5Va.js
            julia-DrYN6c6i.js
            sophia-DRm4eves.js
            jsonMode-CCwfh_OB.js
            yaml-Dx1TJ9RY.js
            nls.messages.de.js.js
            hcl-ChD4paVH.js
            monaco.contribution-D_SyqKiy.js
            dockerfile-A7JJbAuF.js
            lua-BYAO5Img.js
            typescript-0SV7N1Xc.js
            bat-gO9qKzUo.js
            elixir-BxvNo5o6.js
            lspLanguageFeatures-BnY_dL8Y.js
            cameligo-DCtn5844.js
            handlebars-C_OonjWa.js
            liquid-Limfe9fx.js
            _commonjsHelpers-98qg88fe.js
            html-Bey8D4EY.js
            shell-BmIjpZz5.js
            htmlMode-Cz7zhZ7P.js
            pla-DbBZgOrT.js
            markdown-BXo7NBdp.js
            editor.api-CykLys8L.js
            nls.messages.zh-cn.js.js
            loader.js
            nls.messages.es.js.js
            nls.messages.ru.js.js
            kotlin-CSDqhv6t.js
            scheme-DM9P8uKD.js
            scss-DijLV5ju.js
            nls.messages.ja.js.js
            go-DcS9_gMe.js
            objective-c-DZzj24DI.js
            bicep-XOQLqtWX.js
            scala-Cs4aXuOD.js
            systemverilog-D8uKG36_.js
            solidity-ClNCm0U5.js
            nls.messages.zh-tw.js.js
            postiats-OtZm4COL.js
            pascaligo-BhBiNdI2.js
            perl-BZM3Cl3T.js
            ecl-BJgqfLSq.js
            lexon-BmRNXYWC.js
            twig-DDbyWOW2.js
            r-BZ_VXAR1.js
            nls.messages.cs.js.js
            flow9-BNnUn-_8.js
            nls.messages.ko.js.js
            rust-DIvkf86i.js
            typespec-BoPQuPjQ.js
            clojure-DyYtgmYv.js
            less-B7KFvseP.js
            vb-Dj0rva7R.js
            wgsl-C6G-1Rhr.js
            ini-CdZgSnLI.js
            m3-B1KqSpyY.js
            nls.messages.it.js.js
            cypher-DyfRGA23.js
            tcl-BiHOeboY.js
            nls.messages.tr.js.js
            razor-BIG_AFb9.js
            qsharp-BzyhV8V4.js
            monaco.contribution-D74vF5SR.js
            azcli-DlDxj3-g.js
            monaco.contribution-YfYcxPkX.js
            swift-CXsb7aR5.js
            ruby-qQzGPz_6.js
            pug-BIApPNjT.js
            redis-BVpHZsxd.js
            mips-zX62smW0.js
            redshift-DMeYiY_v.js
            mdx-DDjyMvBD.js
            nls.messages-loader.js
            powerquery-Du80-tps.js
            graphql-CHzgmf8E.js
            dart-eN3E5CF0.js
            python-CzSOMEzg.js
            msdax-MzEb-8sD.js
            cssMode-Cakukknl.js
            csp-CtMdzNMY.js
            nls.messages.fr.js.js
            sparql-O5ONewYs.js
            st-UObc-eRR.js
            sql-RAEyXdQG.js
            pascal-Ek4lERtt.js
            nls.messages.js.js
            coffee-C8bOs6Uz.js
            freemarker2-CQSuO4BX.js
            xml-fSKCG6nN.js
            php-DK3ktPH8.js
            apex-Jqcmv7eP.js
            cpp-9dJI961u.js
            powershell-mk7ECzLJ.js
            nls.messages.pl.js.js
            javascript-BgQ1b_eP.js
            css-t68wsr0f.js
            sb-DUCWDbCb.js
            csharp-NZNtYXm3.js
            abap-BxE6jMvt.js
            monaco.contribution-Cqdn_4Kw.js
            mysql-Drs0JCLT.js
            nls.messages.pt-br.js.js
            fsharp-DHdXPb1O.js
            tsMode-CYrPzhIX.js
            protobuf-Bn1ftnRe.js
            pgsql-BAYS0xjf.js
            java-vwwkdu2k.js
            restructuredtext-CmsqpaZy.js
            assets/
              ts.worker-ClNbeHrN.js
              html.worker-Dp8eKPfv.js
              json.worker-CvNsV1ln.js
              editor.worker-DbHNojjm.js
              css.worker-CgWp-mpq.js
            language/
            basic-languages/
              monaco.contribution.js
            editor/
              editor.main.css
              editor.main.js
        min/
          vs/
            postiats-BBSzz8Pk.js
            bat-C397hTD6.js
            objective-c-CntZFaHX.js
            flow9-DqtmStfK.js
            lspLanguageFeatures-kM9O9rjY.js
            st-CuDFIVZ_.js
            handlebars-OwglfO-1.js
            nls.messages.de.js.js
            cpp-CkKPQIni.js
            systemverilog-Ch4vA8Yt.js
            redshift-45Et0LQi.js
            clojure-Y2auQMzK.js
            less-C0eDYdqa.js
            abap-D-t0cyap.js
            apex-CcIm7xu6.js
            yaml-DYGvmE88.js
            monaco.contribution-qLAYrEOP.js
            java-CI4ZMsH9.js
            pgsql-me_jFXeX.js
            protobuf-BmtuEB1A.js
            solidity-MZ6ExpPy.js
            monaco.contribution-DO3azKX8.js
            azcli-BA0tQDCg.js
            ruby-CZO8zYTz.js
            cypher-DVThT8BS.js
            pug-BRpRNeEb.js
            restructuredtext-C7UUFKFD.js
            nls.messages.zh-cn.js.js
            scheme-CHdMtr7p.js
            pascal-r6kuqfl_.js
            loader.js
            nls.messages.es.js.js
            fsharp-BOMdg4U1.js
            redis-fvZQY4PI.js
            nls.messages.ru.js.js
            perl-DABw_TcH.js
            vb-Dyb2648j.js
            monaco.contribution-EcChJV6a.js
            rust-Bfetafyc.js
            nls.messages.ja.js.js
            ini-CsNwO04R.js
            typespec-D-PIh9Xw.js
            nls.messages.zh-tw.js.js
            swift-n-2HociN.js
            sb-3GYllVck.js
            r-f8dDdrp4.js
            elixir-xjPaIfzF.js
            nls.messages.cs.js.js
            julia-BwzEvaQw.js
            csharp-CX28MZyh.js
            nls.messages.ko.js.js
            css-CaeNmE3S.js
            go-D_hbi-Jt.js
            python-Cr0UkIbn.js
            scss-C1cmLt9V.js
            liquid-DqKjdPGy.js
            workers-DcJshg-q.js
            bicep-DF5aW17k.js
            nls.messages.it.js.js
            nls.messages.tr.js.js
            razor-BYAHOTkz.js
            scala-foMgrKo1.js
            kotlin-IUYPiTV8.js
            m3-CsR4AuFi.js
            wgsl-BhLXMOR0.js
            csp-D8uWnyxW.js
            _commonjsHelpers-CT9FvmAN.js
            sql-32GpJSV2.js
            xml-CdsdnY8S.js
            twig-C6taOxMV.js
            nls.messages-loader.js
            coffee-Bu45yuWE.js
            graphql-CKUU4kLG.js
            powerquery-Dt-g_2cc.js
            nls.messages.fr.js.js
            hcl-DTaboeZW.js
            sparql-AUGFYSyk.js
            nls.messages.js.js
            mdx-DEWtB1K5.js
            shell-ClXCKCEW.js
            php-D_kh-9LK.js
            htmlMode-Bz67EXwp.js
            tsMode-CZz1Umrk.js
            editor.api-CalNCsUg.js
            typescript-DfOrAzoV.js
            lua-DtygF91M.js
            powershell-B-7ap1zc.js
            mysql-CdtbpvbG.js
            lexon-iON-Kj97.js
            nls.messages.pl.js.js
            dart-CmGfCvrO.js
            mips-CiYP61RB.js
            pascaligo-BiXoTmXh.js
            tcl-D74tq1nH.js
            jsonMode-DULH5oaX.js
            ecl-30fUercY.js
            html-Pa1xEWsY.js
            msdax-C38-sJlp.js
            sophia-DWkuSsPQ.js
            cssMode-CjiAH6dQ.js
            monaco.contribution-D2OdxNBt.js
            nls.messages.pt-br.js.js
            dockerfile-CZqqYdch.js
            freemarker2-Cz_sV6Md.js
            qsharp-BzsFaUU9.js
            pla-VfZjczW0.js
            cameligo-plsz8qhj.js
            markdown-C_rD0bIw.js
            javascript-PczUCGdz.js
            assets/
              css.worker-HnVq6Ewq.js
              html.worker-B51mlPHg.js
              editor.worker-Be8ye1pW.js
              json.worker-DKiEKt88.js
              ts.worker-CMbG-7ft.js
            language/
            basic-languages/
              monaco.contribution.js
            editor/
              editor.main.css
              editor.main.js
        esm/
          nls.messages.de.js
          nls.messages.fr.js
          nls.messages.ru.js
          nls.messages.it.js
          nls.messages.zh-cn.js
          nls.messages.es.js
          nls.messages.pl.js
          nls.messages.js
          nls.messages.ko.js
          nls.messages.zh-tw.js
          metadata.js
          nls.messages.ja.js
          nls.messages.pt-br.js
          nls.messages.cs.js
          nls.messages.tr.js
          metadata.d.ts
          vs/
            nls.js
            nls.messages.js
            platform/
            common/
              initialize.js
              workers.js
            base/
            language/
            basic-languages/
              _.contribution.js
            editor/
              editor.main.d.ts
              editor.all.js
              editor.worker.js
              editor.api2.js
              editor.api.js
              editor.main.js
              editor.worker.start.js
              editor.api.d.ts
              edcore.main.js
          external/
            vscode-languageserver-textdocument/
            vscode-html-languageservice/
            vscode-json-languageservice/
            jsonc-parser/
            vscode-uri/
            monaco-lsp-client/
            vscode-languageserver-types/
            vscode-css-languageservice/
            @vscode/
      micromark-util-classify-character/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      @ungap/
        structured-clone/
          package.json
          LICENSE
          README.md
          structured-json.js
          cjs/
            package.json
            json.js
            serialize.js
            deserialize.js
            types.js
            index.js
          .github/
            workflows/
              node.js.yml
          esm/
            json.js
            serialize.js
            deserialize.js
            types.js
            index.js
      terser/
        CHANGELOG.md
        package.json
        PATRONS.md
        LICENSE
        README.md
        main.js
        dist/
          package.json
          bundle.min.js
          .gitkeep
        lib/
          mozilla-ast.js
          cli.js
          ast.js
          sourcemap.js
          minify.js
          scope.js
          equivalent-to.js
          propmangle.js
          transform.js
          output.js
          size.js
          parse.js
          utils/
            first_in_statement.js
            index.js
          compress/
            reduce-vars.js
            drop-side-effect-free.js
            native-objects.js
            drop-unused.js
            evaluate.js
            common.js
            inline.js
            index.js
            inference.js
            global-defs.js
            tighten-body.js
            compressor-flags.js
        bin/
          package.json
          terser
          uglifyjs
        tools/
          props.html
          exit.cjs
          terser.d.ts
          domprops.js
        node_modules/
          commander/
            CHANGELOG.md
            package.json
            Readme.md
            LICENSE
            index.js
            typings/
              index.d.ts
      .bin/
        tailwind
        jiti
        update-browserslist-db
        tailwindcss
        baseline-browser-mapping
        parser
        resolve
        loose-envify
        json5
        browserslist
        autoprefixer
        terser
        sucrase-node
        jsesc
        yaml
        vite
        cssesc
        nanoid
        acorn
        esbuild
        sucrase
        marked
      extend/
        CHANGELOG.md
        package.json
        component.json
        LICENSE
        README.md
        .eslintrc
        .editorconfig
        .travis.yml
        .jscs.json
        index.js
      has-symbols/
        CHANGELOG.md
        package.json
        shams.js
        LICENSE
        tsconfig.json
        .nycrc
        README.md
        .eslintrc
        index.d.ts
        shams.d.ts
        index.js
        test/
          index.js
          tests.js
          shams/
            get-own-property-symbols.js
            core-js.js
        .github/
          FUNDING.yml
      @babel/
        compat-data/
          package.json
          overlapping-plugins.js
          native-modules.js
          LICENSE
          README.md
          corejs2-built-ins.js
          corejs3-shipped-proposals.js
          plugins.js
          plugin-bugfixes.js
          data/
            plugin-bugfixes.json
            plugins.json
            native-modules.json
            overlapping-plugins.json
            corejs3-shipped-proposals.json
            corejs2-built-ins.json
        helper-string-parser/
          package.json
          LICENSE
          README.md
          lib/
            index.js.map
            index.js
        helper-module-transforms/
          package.json
          LICENSE
          README.md
          lib/
            lazy-modules.js.map
            get-module-name.js.map
            rewrite-this.js
            rewrite-live-references.js
            normalize-and-load-metadata.js.map
            index.js.map
            normalize-and-load-metadata.js
            get-module-name.js
            index.js
            dynamic-import.js
            dynamic-import.js.map
            lazy-modules.js
            rewrite-live-references.js.map
            rewrite-this.js.map
        helper-globals/
          package.json
          LICENSE
          README.md
          data/
            browser-upper.json
            builtin-upper.json
            builtin-lower.json
        parser/
          CHANGELOG.md
          package.json
          LICENSE
          README.md
          typings/
            babel-parser.d.ts
          lib/
            index.js.map
            index.js
          bin/
            babel-parser.js
        traverse/
          package.json
          tsconfig.overrides.json
          LICENSE
          README.md
          lib/
            types.js.map
            visitors.js.map
            visitors.js
            cache.js.map
            index.js.map
            types.js
            hub.js
            traverse-node.js.map
            index.js
            traverse-node.js
            cache.js
            context.js
            hub.js.map
            context.js.map
            path/
              ancestry.js
              evaluation.js
              conversion.js
              ancestry.js.map
              modification.js.map
              replacement.js
              conversion.js.map
              family.js.map
              family.js
              removal.js
              replacement.js.map
              index.js.map
              comments.js.map
              removal.js.map
              comments.js
              index.js
              introspection.js.map
              modification.js
              evaluation.js.map
              context.js
              introspection.js
              context.js.map
            scope/
              binding.js
              traverseForScope.js
              binding.js.map
              index.js.map
              traverseForScope.js.map
              index.js
        helper-validator-identifier/
          package.json
          LICENSE
          README.md
          lib/
            keyword.js
            identifier.js.map
            index.js.map
            index.js
            identifier.js
            keyword.js.map
        code-frame/
          package.json
          LICENSE
          README.md
          lib/
            index.js.map
            index.js
        core/
          package.json
          LICENSE
          README.md
          lib/
            transform-ast.js.map
            transform-file-browser.js.map
            transform-file-browser.js
            transform-ast.js
            transform-file.js.map
            index.js.map
            transform-file.js
            index.js
            transform.js
            parse.js.map
            transform.js.map
            parse.js
            errors/
              rewrite-stack-trace.js
              rewrite-stack-trace.js.map
              config-error.js
              config-error.js.map
            parser/
              index.js.map
              index.js
            vendor/
              import-meta-resolve.js
              import-meta-resolve.js.map
            tools/
              build-external-helpers.js.map
              build-external-helpers.js
            transformation/
              normalize-opts.js.map
              plugin-pass.js.map
              plugin-pass.js
              normalize-opts.js
              normalize-file.js.map
              block-hoist-plugin.js
              normalize-file.js
              index.js.map
              block-hoist-plugin.js.map
              index.js
            gensync-utils/
              async.js.map
              functional.js.map
              fs.js.map
              async.js
              fs.js
              functional.js
            config/
              config-descriptors.js.map
              plugin.js.map
              resolve-targets.js
              item.js.map
              resolve-targets-browser.js.map
              printer.js
              item.js
              full.js
              util.js.map
              caching.js
              config-descriptors.js
              cache-contexts.js.map
              resolve-targets.js.map
              caching.js.map
              resolve-targets-browser.js
              printer.js.map
              util.js
              index.js.map
              config-chain.js.map
              pattern-to-regex.js
              partial.js
              full.js.map
              cache-contexts.js
              partial.js.map
              index.js
              config-chain.js
              plugin.js
              pattern-to-regex.js.map
          node_modules/
            semver/
              semver.js
              package.json
              LICENSE
              range.bnf
              README.md
            .bin/
              semver
          src/
            transform-file-browser.ts
            transform-file.ts
            config/
              resolve-targets.ts
              resolve-targets-browser.ts
        plugin-transform-react-jsx-self/
          package.json
          LICENSE
          README.md
          lib/
            index.js.map
            index.js
        helper-compilation-targets/
          package.json
          LICENSE
          README.md
          lib/
            utils.js
            pretty.js
            options.js
            pretty.js.map
            utils.js.map
            filter-items.js
            index.js.map
            debug.js
            filter-items.js.map
            targets.js.map
            targets.js
            index.js
            options.js.map
            debug.js.map
          node_modules/
            semver/
              semver.js
              package.json
              LICENSE
              range.bnf
              README.md
            .bin/
              semver
        helper-module-imports/
          package.json
          LICENSE
          README.md
          lib/
            is-module.js
            import-builder.js.map
            is-module.js.map
            import-builder.js
            import-injector.js
            index.js.map
            import-injector.js.map
            index.js
        helper-plugin-utils/
          package.json
          LICENSE
          README.md
          lib/
            index.js.map
            index.js
        helper-validator-option/
          package.json
          LICENSE
          README.md
          lib/
            find-suggestion.js
            find-suggestion.js.map
            index.js.map
            validator.js.map
            index.js
            validator.js
        plugin-transform-react-jsx-source/
          package.json
          LICENSE
          README.md
          lib/
            index.js.map
            index.js
        template/
          package.json
          LICENSE
          README.md
          lib/
            options.js
            string.js.map
            builder.js.map
            literal.js
            literal.js.map
            builder.js
            populate.js.map
            index.js.map
            formatters.js.map
            index.js
            options.js.map
            parse.js.map
            formatters.js
            string.js
            populate.js
            parse.js
        generator/
          package.json
          LICENSE
          README.md
          lib/
            printer.js
            source-map.js.map
            printer.js.map
            index.js.map
            source-map.js
            index.js
            token-map.js
            token-map.js.map
            buffer.js.map
            buffer.js
            generators/
              modules.js
              types.js.map
              modules.js.map
              classes.js.map
              typescript.js.map
              statements.js
              deprecated.js
              classes.js
              statements.js.map
              expressions.js
              flow.js.map
              methods.js
              jsx.js.map
              typescript.js
              jsx.js
              deprecated.js.map
              base.js
              index.js.map
              flow.js
              methods.js.map
              types.js
              index.js
              base.js.map
              template-literals.js
              expressions.js.map
              template-literals.js.map
            node/
              whitespace.js.map
              parentheses.js.map
              whitespace.js
              parentheses.js
              index.js.map
              index.js
        types/
          package.json
          LICENSE
          README.md
          lib/
            index.js.map
            index.d.ts
            index.js
            index.js.flow
            index-legacy.d.ts
            clone/
              clone.js.map
              cloneDeep.js.map
              clone.js
              cloneDeepWithoutLoc.js
              cloneNode.js.map
              cloneWithoutLoc.js
              cloneNode.js
              cloneDeepWithoutLoc.js.map
              cloneDeep.js
              cloneWithoutLoc.js.map
            converters/
              toBindingIdentifierName.js
              valueToNode.js.map
              toBindingIdentifierName.js.map
              gatherSequenceExpressions.js
              toComputedKey.js.map
              toStatement.js
              toExpression.js
              toSequenceExpression.js
              toStatement.js.map
              ensureBlock.js.map
              toSequenceExpression.js.map
              gatherSequenceExpressions.js.map
              toExpression.js.map
              toIdentifier.js
              toBlock.js.map
              toKeyAlias.js.map
              valueToNode.js
              toIdentifier.js.map
              toBlock.js
              toKeyAlias.js
              toComputedKey.js
              ensureBlock.js
            constants/
              index.js.map
              index.js
            traverse/
              traverseFast.js
              traverse.js.map
              traverse.js
              traverseFast.js.map
            comments/
              removeComments.js.map
              inheritsComments.js.map
              addComment.js
              removeComments.js
              inheritInnerComments.js.map
              inheritLeadingComments.js
              inheritsComments.js
              addComment.js.map
              inheritLeadingComments.js.map
              inheritTrailingComments.js
              addComments.js
              inheritInnerComments.js
              addComments.js.map
              inheritTrailingComments.js.map
            ast-types/
            retrievers/
              getOuterBindingIdentifiers.js.map
              getBindingIdentifiers.js
              getAssignmentIdentifiers.js.map
              getBindingIdentifiers.js.map
              getOuterBindingIdentifiers.js
              getFunctionName.js
              getFunctionName.js.map
              getAssignmentIdentifiers.js
            builders/
              validateNode.js
              productions.js
              validateNode.js.map
              productions.js.map
            utils/
              shallowEqual.js
              inherit.js
              inherit.js.map
              deprecationWarning.js
              shallowEqual.js.map
              deprecationWarning.js.map
            validators/
              isImmutable.js.map
              isType.js.map
              isReferenced.js.map
              isPlaceholderType.js.map
              is.js
              is.js.map
              matchesPattern.js
              isScope.js
              isValidIdentifier.js
              isNode.js.map
              isImmutable.js
              validate.js.map
              isValidES3Identifier.js.map
              isScope.js.map
              isType.js
              isNodesEquivalent.js
              isBlockScoped.js
              isBlockScoped.js.map
              validate.js
              matchesPattern.js.map
              isLet.js.map
              buildMatchMemberExpression.js
              isSpecifierDefault.js
              isBinding.js.map
              isBinding.js
              isLet.js
              isSpecifierDefault.js.map
              isValidIdentifier.js.map
              buildMatchMemberExpression.js.map
              isReferenced.js
              isNode.js
              isNodesEquivalent.js.map
              isValidES3Identifier.js
              isVar.js.map
              isVar.js
              isPlaceholderType.js
            asserts/
              assertNode.js.map
              assertNode.js
            definitions/
              utils.js
              placeholders.js.map
              experimental.js.map
              deprecated-aliases.js.map
              core.js
              typescript.js.map
              misc.js
              experimental.js
              flow.js.map
              utils.js.map
              core.js.map
              jsx.js.map
              typescript.js
              jsx.js
              index.js.map
              flow.js
              deprecated-aliases.js
              index.js
              placeholders.js
              misc.js.map
            modifications/
              removeProperties.js.map
              inherits.js.map
              removeProperties.js
              appendToMemberExpression.js
              prependToMemberExpression.js.map
              inherits.js
              appendToMemberExpression.js.map
              prependToMemberExpression.js
              removePropertiesDeep.js.map
              removePropertiesDeep.js
        helpers/
          package.json
          LICENSE
          README.md
          lib/
            helpers-generated.js
            index.js.map
            index.js
            helpers-generated.js.map
            helpers/
              classPrivateFieldGet.js
              defineProperty.js
              AwaitValue.js
              arrayWithHoles.js.map
              applyDecs2203.js
              applyDecs2311.js
              createForOfIteratorHelperLoose.js.map
              classStaticPrivateFieldDestructureSet.js
              regeneratorValues.js
              applyDecs.js.map
              newArrowCheck.js.map
              classPrivateFieldInitSpec.js.map
              classPrivateGetter.js
              classCallCheck.js.map
              regeneratorAsync.js.map
              classPrivateFieldSet.js
              identity.js
              superPropGet.js.map
              inherits.js.map
              classPrivateFieldDestructureSet.js
              toConsumableArray.js.map
              toPrimitive.js.map
              classCheckPrivateStaticAccess.js
              nonIterableSpread.js.map
              possibleConstructorReturn.js
              unsupportedIterableToArray.js
              classPrivateSetter.js.map
              get.js
              applyDecs2203R.js
              objectSpread.js.map
              readOnlyError.js.map
              classStaticPrivateFieldDestructureSet.js.map
              regeneratorRuntime.js
              initializerDefineProperty.js.map
              regenerator.js
              regeneratorKeys.js.map
              classExtractFieldDescriptor.js
              createClass.js.map
              wrapNativeSuper.js.map
              applyDecoratedDescriptor.js
              typeof.js
              objectSpread.js
              asyncToGenerator.js.map
              nullishReceiverError.js.map
              classPrivateMethodSet.js
              extends.js.map
              construct.js
              set.js.map
              isNativeReflectConstruct.js.map
              maybeArrayLike.js
              applyDecs2203.js.map
              applyDecs.js
              slicedToArray.js.map
              importDeferProxy.js.map
              toConsumableArray.js
              classStaticPrivateMethodGet.js.map
              classPrivateMethodGet.js.map
              regenerator.js.map
              classPrivateGetter.js.map
              setPrototypeOf.js
              applyDecs2301.js.map
              applyDecoratedDescriptor.js.map
              classPrivateSetter.js
              classApplyDescriptorDestructureSet.js.map
              awaitAsyncGenerator.js.map
              wrapRegExp.js
              initializerDefineProperty.js
              initializerWarningHelper.js.map
              newArrowCheck.js
              objectSpread2.js.map
              iterableToArray.js
              isNativeReflectConstruct.js
              regeneratorDefine.js
              superPropBase.js
              AwaitValue.js.map
              toPropertyKey.js
              getPrototypeOf.js.map
              toArray.js
              regeneratorValues.js.map
              get.js.map
              classStaticPrivateFieldSpecGet.js.map
              classApplyDescriptorGet.js
              usingCtx.js.map
              dispose.js
              set.js
              tsRewriteRelativeImportExtensions.js
              arrayWithoutHoles.js
              temporalRef.js
              isNativeFunction.js.map
              skipFirstGeneratorNext.js.map
              setFunctionName.js
              arrayLikeToArray.js
              classPrivateFieldSet2.js.map
              usingCtx.js
              wrapAsyncGenerator.js.map
              classStaticPrivateMethodGet.js
              taggedTemplateLiteral.js
              regeneratorAsyncGen.js
              nonIterableSpread.js
              classApplyDescriptorGet.js.map
              assertThisInitialized.js.map
              classStaticPrivateMethodSet.js.map
              setFunctionName.js.map
              dispose.js.map
              temporalRef.js.map
              importDeferProxy.js
              classStaticPrivateFieldSpecSet.js
              classPrivateMethodInitSpec.js.map
              objectDestructuringEmpty.js.map
              wrapRegExp.js.map
              wrapAsyncGenerator.js
              classExtractFieldDescriptor.js.map
              superPropGet.js
              asyncIterator.js.map
              iterableToArrayLimit.js
              regeneratorAsyncGen.js.map
              toPropertyKey.js.map
              applyDecs2203R.js.map
              unsupportedIterableToArray.js.map
              toPrimitive.js
              classPrivateMethodInitSpec.js
              decorate.js
              applyDecs2305.js.map
              createSuper.js.map
              classStaticPrivateFieldSpecSet.js.map
              arrayLikeToArray.js.map
              classPrivateMethodSet.js.map
              classCheckPrivateStaticAccess.js.map
              defineEnumerableProperties.js.map
              nonIterableRest.js.map
              applyDecs2301.js
              classPrivateFieldDestructureSet.js.map
              inherits.js
              regeneratorRuntime.js.map
              defaults.js.map
              classCheckPrivateStaticFieldDescriptor.js
              tsRewriteRelativeImportExtensions.js.map
              interopRequireWildcard.js
              classPrivateFieldLooseBase.js
              temporalUndefined.js.map
              writeOnlyError.js.map
              objectWithoutPropertiesLoose.js
              classPrivateFieldLooseKey.js
              createClass.js
              temporalUndefined.js
              applyDecs2311.js.map
              classStaticPrivateFieldSpecGet.js
              initializerWarningHelper.js
              extends.js
              classPrivateFieldInitSpec.js
              classApplyDescriptorDestructureSet.js
              jsx.js.map
              classApplyDescriptorSet.js
              objectWithoutPropertiesLoose.js.map
              wrapNativeSuper.js
              classPrivateFieldSet2.js
              objectWithoutProperties.js.map
              typeof.js.map
              jsx.js
              nonIterableRest.js
              instanceof.js
              objectWithoutProperties.js
              createForOfIteratorHelper.js
              asyncToGenerator.js
              defineAccessor.js
              asyncGeneratorDelegate.js
              arrayWithoutHoles.js.map
              writeOnlyError.js
              maybeArrayLike.js.map
              OverloadYield.js
              classNameTDZError.js
              regeneratorDefine.js.map
              classStaticPrivateMethodSet.js
              OverloadYield.js.map
              instanceof.js.map
              construct.js.map
              taggedTemplateLiteralLoose.js.map
              createSuper.js
              checkPrivateRedeclaration.js.map
              checkInRHS.js.map
              defineProperty.js.map
              asyncIterator.js
              superPropSet.js.map
              interopRequireWildcard.js.map
              identity.js.map
              awaitAsyncGenerator.js
              possibleConstructorReturn.js.map
              checkPrivateRedeclaration.js
              callSuper.js.map
              assertClassBrand.js
              iterableToArray.js.map
              superPropBase.js.map
              interopRequireDefault.js
              regeneratorAsync.js
              checkInRHS.js
              arrayWithHoles.js
              classPrivateMethodGet.js
              isNativeFunction.js
              assertClassBrand.js.map
              readOnlyError.js
              classPrivateFieldSet.js.map
              classPrivateFieldGet.js.map
              getPrototypeOf.js
              classPrivateFieldGet2.js
              using.js
              regeneratorKeys.js
              interopRequireDefault.js.map
              nullishReceiverError.js
              toArray.js.map
              inheritsLoose.js
              classApplyDescriptorSet.js.map
              classNameTDZError.js.map
              taggedTemplateLiteralLoose.js
              decorate.js.map
              toSetter.js.map
              classPrivateFieldLooseKey.js.map
              applyDecs2305.js
              classPrivateFieldGet2.js.map
              classCallCheck.js
              createForOfIteratorHelper.js.map
              regeneratorAsyncIterator.js.map
              assertThisInitialized.js
              setPrototypeOf.js.map
              superPropSet.js
              inheritsLoose.js.map
              defineAccessor.js.map
              classCheckPrivateStaticFieldDescriptor.js.map
              objectDestructuringEmpty.js
              defineEnumerableProperties.js
              defaults.js
              tdz.js
              regeneratorAsyncIterator.js
              skipFirstGeneratorNext.js
              objectSpread2.js
              using.js.map
              tdz.js.map
              toSetter.js
              slicedToArray.js
              asyncGeneratorDelegate.js.map
              classPrivateFieldLooseBase.js.map
              iterableToArrayLimit.js.map
              callSuper.js
              taggedTemplateLiteral.js.map
              createForOfIteratorHelperLoose.js
      is-glob/
        package.json
        LICENSE
        README.md
        index.js
      gopd/
        CHANGELOG.md
        package.json
        gOPD.js
        LICENSE
        tsconfig.json
        README.md
        .eslintrc
        index.d.ts
        index.js
        gOPD.d.ts
        test/
          index.js
        .github/
          FUNDING.yml
      framer-motion/
        package.json
        README.md
        LICENSE.md
        mini/
          package.json
        dist/
          dom-mini.d.ts
          dom-mini.js
          size-rollup-animate.js
          size-rollup-m.js
          size-rollup-dom-animation-assets.js
          m.d.ts
          dom.js
          mini.js
          framer-motion.dev.js
          types.d-BJcRxCew.d.ts
          size-rollup-scroll.js
          framer-motion.js
          size-rollup-motion.js
          size-rollup-dom-animation-m.js
          mini.d.ts
          size-rollup-dom-max-assets.js
          size-rollup-waapi-animate.js
          dom.d.ts
          debug.d.ts
          size-rollup-dom-max.js
          size-rollup-dom-animation.js
          es/
            index.mjs
            projection.mjs
            mini.mjs
            debug.mjs
            dom.mjs
            m.mjs
            dom-mini.mjs
            client.mjs
            render/
              store.mjs
              VisualElement.mjs
            context/
              LazyContext.mjs
              DeprecatedLayoutGroupContext.mjs
              ReorderContext.mjs
              PresenceContext.mjs
              MotionConfigContext.mjs
              LayoutGroupContext.mjs
              SwitchLayoutGroupContext.mjs
            value/
              use-time.mjs
              use-motion-value.mjs
              use-transform.mjs
              use-computed.mjs
              use-motion-template.mjs
              use-inverted-scale.mjs
              use-velocity.mjs
              use-scroll.mjs
              use-spring.mjs
              use-combine-values.mjs
            events/
              use-dom-event.mjs
              add-dom-event.mjs
              add-pointer-event.mjs
              event-info.mjs
            components/
              AnimateSharedLayout.mjs
            animation/
            motion/
              index.mjs
            utils/
              use-isomorphic-effect.mjs
              distance.mjs
              get-context-window.mjs
              use-instant-transition.mjs
              delay.mjs
              use-animation-frame.mjs
              use-page-in-view.mjs
              use-constant.mjs
              use-in-view.mjs
              use-force-update.mjs
              use-is-mounted.mjs
              shallow-compare.mjs
              use-motion-value-event.mjs
              is-ref-object.mjs
              use-unmount-effect.mjs
              use-composed-ref.mjs
              use-cycle.mjs
              is-browser.mjs
            projection/
              use-instant-layout-transition.mjs
              use-reset-projection.mjs
            gestures/
              hover.mjs
              press.mjs
              focus.mjs
          cjs/
            dom-mini.js
            client.js
            dom.js
            mini.js
            debug.js
            index.js
            m.js
            feature-bundle-v2Gb94eA.js
          types/
            index.d.ts
            client.d.ts
        client/
          package.json
          README.md
        m/
          package.json
        dom/
          package.json
          README.md
          mini/
            package.json
      @pkgjs/
      escape-string-regexp/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      fraction.js/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        fraction.d.mts
        fraction.d.ts
        dist/
          fraction.mjs
          fraction.js
          fraction.min.js
        examples/
          approx.js
          ratio-chain.js
          egyptian.js
          hesse-convergence.js
          rational-pow.js
          integrate.js
          valueOfPi.js
          tape-measure.js
          toFraction.js
          angles.js
        tests/
          fraction.test.js
        src/
          fraction.js
      read-cache/
        package.json
        LICENSE
        README.md
        index.js
      is-decimal/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      picomatch/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        index.js
        lib/
          utils.js
          constants.js
          picomatch.js
          scan.js
          parse.js
      micromatch/
        package.json
        LICENSE
        README.md
        index.js
      micromark-util-resolve-all/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
      html-url-attributes/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      delayed-stream/
        package.json
        Readme.md
        Makefile
        .npmignore
        License
        lib/
          delayed_stream.js
      unist-util-is/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      picocolors/
        package.json
        picocolors.js
        LICENSE
        types.d.ts
        README.md
        picocolors.d.ts
        picocolors.browser.js
      micromark-util-html-tag-name/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
      property-information/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          html.d.ts.map
          xmlns.js
          xml.d.ts.map
          xmlns.d.ts
          xml.d.ts
          svg.d.ts.map
          normalize.js
          xlink.js
          find.d.ts
          xlink.d.ts
          html.d.ts
          hast-to-react.js
          find.js
          html.js
          xmlns.d.ts.map
          svg.js
          hast-to-react.d.ts
          xlink.d.ts.map
          xml.js
          aria.d.ts
          aria.d.ts.map
          aria.js
          normalize.d.ts.map
          svg.d.ts
          normalize.d.ts
          hast-to-react.d.ts.map
          find.d.ts.map
          util/
            merge.d.ts
            case-insensitive-transform.d.ts
            create.d.ts.map
            create.d.ts
            types.d.ts
            schema.d.ts.map
            create.js
            case-insensitive-transform.d.ts.map
            schema.js
            defined-info.js
            merge.d.ts.map
            info.d.ts
            merge.js
            case-sensitive-transform.d.ts.map
            defined-info.d.ts.map
            info.js
            types.js
            info.d.ts.map
            schema.d.ts
            case-sensitive-transform.d.ts
            types.d.ts.map
            case-sensitive-transform.js
            defined-info.d.ts
            case-insensitive-transform.js
      micromark-factory-whitespace/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      micromark-extension-gfm-task-list-item/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          html.d.ts
          html.js
          syntax.d.ts
          syntax.js
        dev/
          index.d.ts
          index.js
          lib/
            html.d.ts
            html.js
            syntax.d.ts
            syntax.js
      postcss-nested/
        package.json
        LICENSE
        README.md
        index.d.ts
        index.js
      jsesc/
        package.json
        LICENSE-MIT.txt
        README.md
        jsesc.js
        man/
          jsesc.1
        bin/
          jsesc
      longest-streak/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      mdast-util-gfm-task-list-item/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      @alloc/
        quick-lru/
          package.json
          license
          readme.md
          index.d.ts
          index.js
      micromark-factory-destination/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      scheduler/
        package.json
        unstable_mock.js
        LICENSE
        README.md
        unstable_post_task.js
        index.js
        umd/
          scheduler-unstable_mock.development.js
          scheduler.development.js
          scheduler.profiling.min.js
          scheduler.production.min.js
          scheduler-unstable_mock.production.min.js
        cjs/
          scheduler-unstable_mock.development.js
          scheduler-unstable_post_task.development.js
          scheduler.development.js
          scheduler-unstable_post_task.production.min.js
          scheduler.production.min.js
          scheduler-unstable_mock.production.min.js
      micromark/
        package.json
        stream.d.ts.map
        stream.d.ts
        stream.js
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          create-tokenizer.js
          postprocess.d.ts
          preprocess.js
          create-tokenizer.d.ts
          constructs.d.ts
          constructs.d.ts.map
          parse.d.ts
          constructs.js
          compile.d.ts.map
          parse.d.ts.map
          create-tokenizer.d.ts.map
          compile.d.ts
          preprocess.d.ts.map
          preprocess.d.ts
          compile.js
          postprocess.d.ts.map
          parse.js
          postprocess.js
          initialize/
            content.d.ts.map
            content.d.ts
            flow.d.ts
            document.d.ts
            text.js
            content.js
            flow.js
            text.d.ts
            document.js
            text.d.ts.map
            document.d.ts.map
            flow.d.ts.map
        dev/
          stream.d.ts.map
          stream.d.ts
          stream.js
          index.d.ts
          index.js
          index.d.ts.map
          lib/
            create-tokenizer.js
            postprocess.d.ts
            preprocess.js
            create-tokenizer.d.ts
            constructs.d.ts
            constructs.d.ts.map
            parse.d.ts
            constructs.js
            compile.d.ts.map
            parse.d.ts.map
            create-tokenizer.d.ts.map
            compile.d.ts
            preprocess.d.ts.map
            preprocess.d.ts
            compile.js
            postprocess.d.ts.map
            parse.js
            postprocess.js
            initialize/
              content.d.ts.map
              content.d.ts
              flow.d.ts
              document.d.ts
              text.js
              content.js
              flow.js
              text.d.ts
              document.js
              text.d.ts.map
              document.d.ts.map
              flow.d.ts.map
      electron-to-chromium/
        full-versions.js
        package.json
        full-chromium-versions.json
        LICENSE
        chromium-versions.js
        README.md
        versions.js
        full-chromium-versions.js
        chromium-versions.json
        full-versions.json
        index.js
        versions.json
      yaml/
        package.json
        LICENSE
        bin.mjs
        README.md
        util.js
        dist/
          errors.d.ts
          errors.js
          public-api.js
          cli.d.ts
          options.d.ts
          util.d.ts
          log.js
          test-events.js
          test-events.d.ts
          visit.js
          public-api.d.ts
          util.js
          index.d.ts
          log.d.ts
          index.js
          visit.d.ts
          cli.mjs
          parse/
            cst-scalar.js
            line-counter.js
            lexer.js
            cst.js
            cst-visit.js
            cst.d.ts
            parser.js
            parser.d.ts
            cst-visit.d.ts
            line-counter.d.ts
            cst-scalar.d.ts
            cst-stringify.d.ts
            cst-stringify.js
            lexer.d.ts
          stringify/
            stringifyPair.d.ts
            stringifyString.d.ts
            stringifyDocument.d.ts
            stringifyCollection.d.ts
            stringifyCollection.js
            stringify.js
            foldFlowLines.js
            stringifyComment.js
            stringifyDocument.js
            stringifyPair.js
            stringifyComment.d.ts
            stringifyNumber.d.ts
            foldFlowLines.d.ts
            stringifyString.js
            stringify.d.ts
            stringifyNumber.js
          doc/
            directives.js
            createNode.d.ts
            applyReviver.d.ts
            directives.d.ts
            Document.js
            Document.d.ts
            createNode.js
            anchors.d.ts
            anchors.js
            applyReviver.js
          compose/
            resolve-block-seq.js
            util-empty-scalar-position.d.ts
            resolve-block-scalar.js
            composer.js
            compose-doc.d.ts
            compose-scalar.d.ts
            resolve-flow-scalar.d.ts
            compose-doc.js
            composer.d.ts
            util-flow-indent-check.js
            resolve-flow-collection.js
            util-empty-scalar-position.js
            resolve-block-seq.d.ts
            util-contains-newline.d.ts
            resolve-block-scalar.d.ts
            resolve-props.js
            util-contains-newline.js
            compose-scalar.js
            resolve-props.d.ts
            util-map-includes.js
            resolve-end.d.ts
            resolve-block-map.js
            compose-node.d.ts
            compose-node.js
            util-map-includes.d.ts
            resolve-block-map.d.ts
            resolve-flow-scalar.js
            util-flow-indent-check.d.ts
            compose-collection.js
            resolve-flow-collection.d.ts
            compose-collection.d.ts
            resolve-end.js
          schema/
            tags.d.ts
            types.d.ts
            Schema.d.ts
            tags.js
            json-schema.d.ts
            Schema.js
            common/
              null.d.ts
              null.js
              map.d.ts
              seq.d.ts
              seq.js
              string.d.ts
              map.js
              string.js
            core/
              bool.js
              bool.d.ts
              float.d.ts
              schema.js
              int.d.ts
              schema.d.ts
              float.js
              int.js
            json/
              schema.js
              schema.d.ts
            yaml-1.1/
              merge.d.ts
              pairs.js
              omap.d.ts
              bool.js
              binary.js
              set.js
              bool.d.ts
              binary.d.ts
              timestamp.d.ts
              float.d.ts
              schema.js
              timestamp.js
              merge.js
              omap.js
              int.d.ts
              schema.d.ts
              pairs.d.ts
              float.js
              int.js
              set.d.ts
          nodes/
            Scalar.js
            Node.d.ts
            identity.js
            YAMLMap.d.ts
            addPairToJSMap.js
            Alias.js
            Pair.d.ts
            Collection.js
            YAMLSeq.js
            Node.js
            toJS.d.ts
            toJS.js
            Pair.js
            YAMLMap.js
            YAMLSeq.d.ts
            Alias.d.ts
            Scalar.d.ts
            identity.d.ts
            Collection.d.ts
            addPairToJSMap.d.ts
        browser/
          package.json
          index.js
          dist/
            errors.js
            public-api.js
            log.js
            visit.js
            util.js
            index.js
            parse/
              cst-scalar.js
              line-counter.js
              lexer.js
              cst.js
              cst-visit.js
              parser.js
              cst-stringify.js
            stringify/
              stringifyCollection.js
              stringify.js
              foldFlowLines.js
              stringifyComment.js
              stringifyDocument.js
              stringifyPair.js
              stringifyString.js
              stringifyNumber.js
            doc/
              directives.js
              Document.js
              createNode.js
              anchors.js
              applyReviver.js
            compose/
              resolve-block-seq.js
              resolve-block-scalar.js
              composer.js
              compose-doc.js
              util-flow-indent-check.js
              resolve-flow-collection.js
              util-empty-scalar-position.js
              resolve-props.js
              util-contains-newline.js
              compose-scalar.js
              util-map-includes.js
              resolve-block-map.js
              compose-node.js
              resolve-flow-scalar.js
              compose-collection.js
              resolve-end.js
            schema/
              tags.js
              Schema.js
            nodes/
              Scalar.js
              identity.js
              addPairToJSMap.js
              Alias.js
              Collection.js
              YAMLSeq.js
              Node.js
              toJS.js
              Pair.js
              YAMLMap.js
      unist-util-visit/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      remark-gfm/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      merge2/
        package.json
        LICENSE
        README.md
        index.js
      mime-types/
        package.json
        LICENSE
        README.md
        index.js
        HISTORY.md
      commander/
        CHANGELOG.md
        package.json
        Readme.md
        LICENSE
        index.js
        typings/
          index.d.ts
      buffer-from/
        package.json
        LICENSE
        readme.md
        index.js
      chokidar/
        package.json
        LICENSE
        README.md
        index.js
        lib/
          constants.js
          nodefs-handler.js
          fsevents-handler.js
        node_modules/
          glob-parent/
            CHANGELOG.md
            package.json
            LICENSE
            README.md
            index.js
        types/
          index.d.ts
      ts-interface-checker/
        package.json
        LICENSE
        README.md
        dist/
          util.d.ts
          types.d.ts
          util.js
          index.d.ts
          types.js
          index.js
      axios/
        CHANGELOG.md
        index.d.cts
        package.json
        LICENSE
        README.md
        MIGRATION_GUIDE.md
        index.d.ts
        index.js
        dist/
          axios.js.map
          axios.js
          axios.min.js.map
          axios.min.js
          node/
            axios.cjs
            axios.cjs.map
          browser/
            axios.cjs
            axios.cjs.map
          esm/
            axios.js.map
            axios.js
            axios.min.js.map
            axios.min.js
        lib/
          utils.js
          axios.js
          defaults/
            index.js
            transitional.js
          platform/
            index.js
            node/
              index.js
            common/
              utils.js
            browser/
              index.js
          env/
            README.md
            data.js
            classes/
              FormData.js
          core/
            mergeConfig.js
            Axios.js
            transformData.js
            AxiosHeaders.js
            README.md
            dispatchRequest.js
            AxiosError.js
            buildFullPath.js
            InterceptorManager.js
            settle.js
          adapters/
            adapters.js
            xhr.js
            README.md
            http.js
            fetch.js
          cancel/
            isCancel.js
            CancelToken.js
            CanceledError.js
          helpers/
            isAxiosError.js
            readBlob.js
            isAbsoluteURL.js
            parseProtocol.js
            null.js
            toFormData.js
            bind.js
            combineURLs.js
            buildURL.js
            ZlibHeaderTransformStream.js
            parseHeaders.js
            formDataToJSON.js
            speedometer.js
            README.md
            HttpStatusCode.js
            estimateDataURLDecodedBytes.js
            fromDataURI.js
            throttle.js
            cookies.js
            progressEventReducer.js
            AxiosURLSearchParams.js
            trackStream.js
            resolveConfig.js
            isURLSameOrigin.js
            callbackify.js
            validator.js
            AxiosTransformStream.js
            spread.js
            composeSignals.js
            deprecatedMethod.js
            toURLEncodedForm.js
            formDataToStream.js
        node_modules/
          form-data/
            CHANGELOG.md
            package.json
            README.md
            index.d.ts
            License
            lib/
              browser.js
              form_data.js
              populate.js
      mz/
        readline.js
        package.json
        LICENSE
        zlib.js
        README.md
        child_process.js
        crypto.js
        index.js
        dns.js
        HISTORY.md
        fs.js
      function-bind/
        CHANGELOG.md
        package.json
        LICENSE
        .nycrc
        README.md
        .eslintrc
        implementation.js
        index.js
        test/
          .eslintrc
          index.js
        .github/
          SECURITY.md
          FUNDING.yml
      mdast-util-mdxjs-esm/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      set-cookie-parser/
        package.json
        LICENSE
        README.md
        lib/
          set-cookie.js
      reusify/
        package.json
        SECURITY.md
        eslint.config.js
        LICENSE
        tsconfig.json
        README.md
        test.js
        reusify.d.ts
        reusify.js
        benchmarks/
          reuseNoCodeFunction.js
          createNoCodeFunction.js
          fib.js
        .github/
          dependabot.yml
          workflows/
            ci.yml
      util-deprecate/
        browser.js
        package.json
        LICENSE
        node.js
        README.md
        History.md
      mdast-util-gfm-footnote/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      lucide-react/
        dynamicIconImports.js.map
        package.json
        LICENSE
        dynamicIconImports.js
        README.md
        dynamicIconImports.d.ts
        dist/
          lucide-react.d.ts
          umd/
            lucide-react.js
            lucide-react.js.map
            lucide-react.min.js
            lucide-react.min.js.map
          cjs/
            lucide-react.js
            lucide-react.js.map
          esm/
            createLucideIcon.js.map
            Icon.js
            lucide-react.js
            lucide-react.js.map
            Icon.js.map
            createLucideIcon.js
            defaultAttributes.js
            defaultAttributes.js.map
            icons/
              notepad-text.js.map
              message-circle.js
              music-2.js
              siren.js
              plug-2.js.map
              radio-tower.js.map
              monitor-pause.js.map
              align-vertical-space-around.js
              cloud-download.js.map
              car-taxi-front.js.map
              ticket-plus.js
              book-open-text.js
              trello.js.map
              combine.js.map
              separator-vertical.js
              shield-x.js
              proportions.js.map
              alarm-clock-minus.js.map
              cloud-cog.js
              circle-arrow-right.js
              align-vertical-justify-end.js.map
              nfc.js
              iteration-ccw.js.map
              bed.js
              layout-template.js
              building.js
              circle-help.js
              pound-sterling.js.map
              cake-slice.js.map
              sort-asc.js
              replace.js.map
              combine.js
              copyleft.js.map
              lasso-select.js.map
              dices.js.map
              arrow-down.js.map
              audio-lines.js
              align-start-horizontal.js
              pie-chart.js.map
              music-3.js
              image-play.js.map
              circle-x.js
              crop.js
              arrow-up-narrow-wide.js.map
              rainbow.js.map
              move-diagonal.js.map
              scroll.js.map
              file-search-2.js.map
              arrow-up-narrow-wide.js
              between-horizonal-start.js
              shield-close.js
              file-output.js
              beer.js.map
              square-arrow-down-right.js
              bookmark.js
              shopping-bag.js.map
              activity-square.js.map
              file-check.js
              bell-minus.js.map
              split-square-horizontal.js
              heading-5.js.map
              webcam.js.map
              pencil-line.js
              panel-right-open.js
              folder-cog-2.js.map
              clipboard-copy.js
              package.js
              clock-10.js.map
              move-down.js
              japanese-yen.js.map
              train-track.js.map
              message-square-plus.js
              bookmark-x.js
              cross.js.map
              library-square.js.map
              list-checks.js
              sailboat.js.map
              a-large-small.js.map
              square-arrow-left.js
              message-square-reply.js.map
              scale.js
              folder-search.js.map
              radio-receiver.js
              move-down-left.js
              signal.js
              monitor-down.js
              dice-4.js.map
              roller-coaster.js.map
              mountain.js.map
              calendar-minus.js
              pencil.js.map
              heart-pulse.js.map
              baggage-claim.js
              lamp-wall-up.js
              file-video-2.js
              ferris-wheel.js
              mail-plus.js
              undo-dot.js
              user-check-2.js
              dna.js
              worm.js
              pill.js.map
              mail-check.js.map
              ampersands.js
              outdent.js.map
              user-minus-2.js
              scan-search.js.map
              dice-6.js.map
              moon.js
              case-sensitive.js
              book-heart.js
              bar-chart-4.js.map
              arrow-down-narrow-wide.js
              magnet.js.map
              monitor-down.js.map
              align-vertical-justify-start.js.map
              speech.js.map
              corner-down-right.js.map
              layers.js.map
              cuboid.js
              arrow-up.js
              download-cloud.js
              scroll.js
              square-parking.js
              tree-palm.js
              chevrons-down.js.map
              badge-minus.js
              cast.js.map
              origami.js
              arrow-down-circle.js.map
              bar-chart-2.js.map
              asterisk-square.js.map
              user.js
              router.js.map
              circle-arrow-up.js.map
              scale-3d.js.map
              square-power.js.map
              spray-can.js
              beer-off.js
              folder.js
              kanban-square.js
              corner-down-left.js.map
              ear-off.js.map
              split.js
              drafting-compass.js
              circle.js.map
              power-off.js.map
              file-check.js.map
              hand-metal.js
              concierge-bell.js.map
              door-open.js.map
              rotate-3-d.js
              dollar-sign.js
              file-plus-2.js.map
              octagon-x.js
              square-check.js.map
              cloud-sun.js.map
              timer.js
              arrow-up-circle.js.map
              toggle-left.js.map
              chevron-down-circle.js.map
              pilcrow-right.js
              framer.js
              search-check.js.map
              fence.js
              annoyed.js.map
              cone.js
              paintbrush.js.map
              calendar-clock.js
              puzzle.js
              pause-circle.js.map
              circle-check-big.js
              refresh-cw.js.map
              arrow-left.js.map
              ticket.js.map
              info.js.map
              circle-stop.js
              concierge-bell.js
              panel-bottom-close.js.map
              minimize.js
              play-circle.js.map
              pause-octagon.js.map
              arrow-left-from-line.js.map
              ticket-minus.js.map
              text-cursor.js
              align-vertical-justify-start.js
              flask-conical-off.js
              chevron-left-circle.js.map
              microwave.js.map
              message-square-diff.js.map
              shovel.js
              picture-in-picture.js
              navigation-2.js.map
              shield-question.js.map
              folder-key.js.map
              terminal.js
              grid-3-x-3.js.map
              equal-square.js
              egg-off.js.map
              pencil-ruler.js.map
              circle-plus.js
              pilcrow.js
              form-input.js.map
              monitor-smartphone.js.map
              badge-swiss-franc.js
              disc.js
              shrink.js.map
              wifi.js.map
              contrast.js.map
              brick-wall.js.map
              paintbrush.js
              folder-heart.js
              corner-right-down.js.map
              hop.js.map
              folder-open.js
              rotate-3d.js.map
              user-round-search.js.map
              mail-question.js
              scissors-square.js
              arrow-up-right-from-circle.js
              axe.js.map
              file-image.js
              align-horizontal-justify-center.js
              fingerprint.js
              lightbulb.js
              circle-ellipsis.js
              vegan.js.map
              test-tube-2.js
              gift.js
              file-minus-2.js
              align-horizontal-distribute-center.js.map
              flask-round.js
              undo-2.js
              mail-search.js
              file-lock.js.map
              align-horizontal-space-around.js
              circle-arrow-out-down-right.js
              sun-moon.js
              align-vertical-distribute-end.js.map
              file-terminal.js.map
              square-chevron-up.js
              pickaxe.js
              kanban-square-dashed.js
              columns.js
              dessert.js
              copy-minus.js
              arrow-up-left-square.js.map
              panels-top-left.js.map
              clock-6.js.map
              menu.js
              archive.js.map
              folder.js.map
              group.js.map
              cloud-off.js
              roller-coaster.js
              undo.js.map
              milk-off.js.map
              puzzle.js.map
              anvil.js
              car.js
              message-square-text.js.map
              ear.js
              lamp-ceiling.js
              upload-cloud.js
              heart.js.map
              pie-chart.js
              type.js.map
              clock-3.js.map
              search-slash.js.map
              facebook.js
              credit-card.js.map
              test-tube.js
              folder-clock.js
              focus.js.map
              brain-circuit.js
              hand-coins.js
              leaf.js
              clock-12.js.map
              equal.js.map
              bot-message-square.js
              bell-ring.js.map
              droplet.js
              upload.js
              wine.js
              mailbox.js
              monitor-x.js.map
              spell-check.js
              receipt-text.js
              cloud-rain-wind.js.map
              gauge.js.map
              arrows-up-from-line.js
              vault.js.map
              umbrella-off.js
              joystick.js.map
              tv-2.js.map
              arrow-right.js
              bell-plus.js
              user-round-x.js
              apple.js.map
              weight.js
              corner-down-left.js
              book-type.js.map
              chevrons-right-left.js.map
              flip-vertical-2.js
              square-pi.js.map
              more-horizontal.js.map
              wallet-cards.js
              user-circle-2.js.map
              send.js
              square-dashed-bottom.js
              circle-arrow-out-down-right.js.map
              arrow-up-z-a.js.map
              arrow-down-za.js.map
              mail-plus.js.map
              file-symlink.js
              landmark.js
              cup-soda.js.map
              sliders-horizontal.js.map
              badge-dollar-sign.js
              book-copy.js
              git-pull-request-create.js
              smartphone.js
              university.js
              panel-right-dashed.js
              pocket-knife.js.map
              aperture.js
              bell-dot.js.map
              box.js.map
              minus-circle.js
              creative-commons.js.map
              panel-bottom-inactive.js.map
              save-all.js
              sandwich.js
              message-square-off.js.map
              lollipop.js.map
              sparkles.js.map
              file-x-2.js.map
              route.js.map
              option.js.map
              haze.js
              flag-triangle-right.js.map
              scroll-text.js
              paperclip.js.map
              tag.js.map
              gauge.js
              check-circle-2.js
              message-square-dot.js.map
              paint-roller.js.map
              list-tree.js
              wheat-off.js
              arrow-down-10.js.map
              drum.js
              shield-ban.js.map
              table.js
              rotate-ccw.js.map
              music-4.js
              panel-bottom-open.js.map
              arrow-big-down.js.map
              dice-1.js.map
              monitor-off.js.map
              hop-off.js
              bug-off.js.map
              notepad-text-dashed.js.map
              pyramid.js.map
              mic.js.map
              rotate-ccw-square.js
              arrow-down-left-from-circle.js
              projector.js.map
              hand-helping.js
              arrow-down-right-from-square.js
              divide-circle.js
              folders.js
              case-upper.js
              thermometer-snowflake.js.map
              arrow-up-left-from-circle.js.map
              edit-2.js
              clapperboard.js.map
              sigma-square.js.map
              book-check.js.map
              monitor-off.js
              graduation-cap.js.map
              square-percent.js
              copyleft.js
              list-plus.js.map
              chrome.js
              cannabis.js.map
              cloud-hail.js
              arrow-right-from-line.js
              gallery-horizontal-end.js.map
              calendar-range.js.map
              mail-x.js.map
              rotate-cw.js
              arrow-left-to-line.js
              grid-2x2.js
              lamp-floor.js
              bar-chart-2.js
              scissors-line-dashed.js
              monitor-dot.js.map
              corner-left-up.js.map
              gem.js.map
              circle-chevron-up.js
              shapes.js.map
              align-left.js.map
              circle-arrow-down.js.map
              fold-horizontal.js.map
              train.js.map
              angry.js.map
              message-square-heart.js
              braces.js.map
              circle-chevron-left.js
              arrow-left-to-line.js.map
              text.js
              chevrons-right-left.js
              user-x-2.js.map
              tent-tree.js.map
              user-round-x.js.map
              hexagon.js
              link-2.js.map
              shell.js
              test-tubes.js.map
              dot.js.map
              slash.js
              bolt.js.map
              squircle.js
              terminal-square.js
              currency.js.map
              file-type.js
              popcorn.js.map
              locate-fixed.js
              file-search-2.js
              stars.js.map
              power.js.map
              file-line-chart.js
              archive-x.js
              infinity.js.map
              bar-chart-big.js.map
              app-window.js.map
              superscript.js
              monitor-speaker.js
              video.js.map
              dribbble.js
              battery.js.map
              signal.js.map
              sword.js
              brackets.js
              tv-2.js
              git-graph.js
              gauge-circle.js
              switch-camera.js.map
              git-pull-request-closed.js
              square-arrow-down-left.js.map
              cloud-moon.js.map
              chevron-up.js.map
              file-box.js.map
              triangle-alert.js
              compass.js
              user-round.js
              flip-vertical.js
              figma.js
              signpost-big.js.map
              chef-hat.js
              egg-off.js
              square-library.js
              between-horizonal-end.js
              arrow-down-right-square.js
              folders.js.map
              sidebar.js
              music-2.js.map
              panel-top-close.js
              play-square.js.map
              git-branch-plus.js.map
              key.js.map
              folder-up.js
              map-pin-off.js
              file-minus-2.js.map
              arrow-up-1-0.js.map
              folder-cog-2.js
              circle-parking-off.js
              square-arrow-out-down-left.js.map
              earth.js
              tree-pine.js.map
              list-plus.js
              soup.js
              circle-chevron-left.js.map
              cassette-tape.js.map
              text-cursor-input.js
              link.js.map
              wifi-off.js
              circle-gauge.js
              bell-off.js
              whole-word.js
              move-3d.js.map
              arrow-down-az.js
              sticky-note.js.map
              pointer-off.js.map
              heart-off.js.map
              users.js.map
              subtitles.js
              gallery-thumbnails.js.map
              file-lock-2.js.map
              map-pinned.js
              badge-alert.js.map
              list-restart.js.map
              panel-top-inactive.js
              caravan.js
              candy-cane.js
              wand-sparkles.js
              circle-check.js
              pilcrow.js.map
              table-cells-split.js.map
              github.js
              book-heart.js.map
              square-x.js
              badge-info.js.map
              paintbrush-2.js.map
              refresh-ccw.js.map
              calendar-search.js
              table-columns-split.js
              type.js
              split.js.map
              move-right.js
              timer.js.map
              mouse-pointer-square-dashed.js
              plane-landing.js
              shield-ellipsis.js.map
              thermometer-sun.js.map
              file-up.js
              badge-check.js
              slash.js.map
              candlestick-chart.js
              file-pen.js.map
              grip-vertical.js
              step-back.js.map
              rail-symbol.js.map
              arrow-down-to-dot.js
              circle.js
              align-center-vertical.js.map
              check-circle-2.js.map
              bookmark-check.js
              ice-cream-bowl.js
              book-copy.js.map
              infinity.js
              clipboard-paste.js.map
              scale-3-d.js.map
              sailboat.js
              external-link.js.map
              layout-dashboard.js
              alarm-check.js
              clock-4.js
              inspect.js
              alarm-plus.js
              server-cog.js.map
              glasses.js
              subtitles.js.map
              arrow-up-to-line.js.map
              file-audio-2.js.map
              align-horizontal-distribute-end.js.map
              align-horizontal-space-around.js.map
              mouse-pointer-square-dashed.js.map
              traffic-cone.js
              git-pull-request-create-arrow.js.map
              ship.js
              bell-ring.js
              message-circle-warning.js.map
              fish-off.js.map
              baby.js
              heading.js
              pilcrow-left.js
              panels-left-right.js.map
              book-up-2.js
              square-code.js
              test-tube-2.js.map
              tangent.js
              banknote.js.map
              check-check.js
              flame.js.map
              cake.js
              clipboard.js
              tent.js.map
              folder-dot.js
              dna-off.js.map
              frown.js.map
              corner-left-down.js.map
              sort-desc.js
              briefcase-medical.js.map
              divide-square.js
              dribbble.js.map
              play.js
              dice-2.js
              bird.js.map
              cookie.js.map
              skull.js.map
              file-badge-2.js.map
              arrow-down-right-square.js.map
              hospital.js
              beef.js
              database-backup.js
              clipboard-pen.js
              clipboard-pen-line.js
              fan.js
              armchair.js.map
              cherry.js
              tornado.js
              camera.js.map
              square-arrow-up-right.js.map
              arrow-up-left-from-square.js
              ticket-x.js.map
              file-key.js.map
              door-open.js
              printer.js
              save.js
              ellipsis-vertical.js
              bath.js
              presentation.js.map
              ticket-minus.js
              file-volume-2.js
              crosshair.js
              separator-horizontal.js
              arrow-up-za.js.map
              between-horizontal-start.js
              package-x.js
              ligature.js
              swatch-book.js.map
              navigation-off.js
              flashlight.js
              car-front.js.map
              receipt-swiss-franc.js.map
              medal.js.map
              bluetooth.js.map
              unlock-keyhole.js.map
              flask-conical-off.js.map
              nut.js.map
              cast.js
              images.js
              lasso-select.js
              octagon.js.map
              file-plus-2.js
              git-pull-request-arrow.js
              diamond-minus.js.map
              phone-incoming.js.map
              mail.js
              traffic-cone.js.map
              gavel.js
              camera.js
              arrow-up-to-line.js
              rabbit.js.map
              badge-x.js
              unlink-2.js.map
              divide.js.map
              wifi.js
              heading-6.js.map
              phone-outgoing.js
              arrow-down-from-line.js.map
              bus-front.js
              user-x.js
              ban.js
              sun-dim.js.map
              layout-dashboard.js.map
              square-dot.js
              snowflake.js
              gitlab.js
              shapes.js
              percent-square.js
              alarm-clock-minus.js
              parking-circle-off.js
              heading-4.js
              move-up-left.js.map
              cloud-download.js
              receipt-pound-sterling.js
              book-user.js
              newspaper.js
              server-off.js
              headset.js.map
              train-front.js
              library-square.js
              hand-heart.js
              contact-round.js.map
              calendar-x.js.map
              circle-chevron-down.js.map
              circle-arrow-up.js
              calendar-range.js
              calendar-minus-2.js
              unlock.js.map
              file-type.js.map
              siren.js.map
              venetian-mask.js.map
              lock-open.js.map
              kanban.js.map
              list-minus.js
              list.js.map
              align-horizontal-justify-start.js
              file-warning.js
              rat.js
              inspect.js.map
              square-power.js
              egg.js
              blocks.js
              phone.js.map
              proportions.js
              file-key.js
              replace-all.js.map
              minus-square.js.map
              chevrons-up.js.map
              citrus.js.map
              parking-square.js
              corner-up-left.js
              file-question.js
              bluetooth-searching.js.map
              chef-hat.js.map
              test-tubes.js
              square-radical.js.map
              hop.js
              university.js.map
              shield-off.js.map
              send-horizontal.js.map
              regex.js
              spade.js
              anchor.js
              watch.js.map
              chevron-right-circle.js.map
              file-scan.js.map
              arrow-up-square.js.map
              list-minus.js.map
              folder-kanban.js.map
              screen-share-off.js.map
              file-text.js
              radio-receiver.js.map
              image-minus.js
              mouse-pointer.js.map
              dices.js
              mountain.js
              cigarette.js.map
              x-octagon.js
              divide-circle.js.map
              clipboard-check.js
              table.js.map
              ticket-check.js.map
              banknote.js
              square-arrow-out-down-right.js.map
              theater.js
              folder-cog.js
              home.js.map
              layout-grid.js
              menu-square.js.map
              arrow-down-circle.js
              edit-3.js
              image-down.js.map
              piggy-bank.js.map
              trending-down.js.map
              curly-braces.js
              speaker.js.map
              flame.js
              save-all.js.map
              dice-1.js
              ice-cream-2.js
              copy-check.js.map
              columns.js.map
              ribbon.js.map
              gauge-circle.js.map
              circle-parking.js
              gantt-chart.js
              dot.js
              badge-percent.js.map
              plug.js
              disc-album.js
              blinds.js
              component.js
              accessibility.js
              user-check-2.js.map
              signal-zero.js.map
              lasso.js
              align-right.js.map
              chevron-down-circle.js
              fish-symbol.js
              bookmark.js.map
              arrow-big-left.js.map
              edit.js.map
              shuffle.js.map
              badge-help.js.map
              rotate-cw.js.map
              album.js.map
              hdmi-port.js
              wallet-minimal.js.map
              lock.js.map
              monitor-check.js.map
              hard-drive.js
              satellite-dish.js
              eye-off.js
              search-code.js
              wheat.js
              circle-alert.js
              copy-x.js.map
              spline.js.map
              panel-left-dashed.js
              grip.js.map
              corner-up-right.js.map
              percent-circle.js.map
              figma.js.map
              diamond-plus.js.map
              radius.js
              unlink-2.js
              monitor-speaker.js.map
              arrow-down-left.js.map
              currency.js
              audio-waveform.js.map
              square-arrow-out-up-left.js.map
              mic-off.js
              step-forward.js.map
              package-search.js.map
              folder-tree.js.map
              send-horizonal.js
              japanese-yen.js
              notebook-pen.js.map
              ellipsis.js
              panel-top-dashed.js
              globe-lock.js.map
              lamp-ceiling.js.map
              hammer.js
              snowflake.js.map
              pc-case.js.map
              battery.js
              align-left.js
              megaphone-off.js
              list-filter.js
              list-collapse.js.map
              message-square-text.js
              move-up.js
              fire-extinguisher.js.map
              square-slash.js
              video.js
              copy-check.js
              book-key.js
              route-off.js
              git-commit.js
              panel-top-dashed.js.map
              arrow-down-right.js
              cog.js
              construction.js
              square-arrow-out-up-left.js
              book.js
              stretch-vertical.js
              circle-fading-plus.js.map
              home.js
              calendar-minus-2.js.map
              radiation.js
              mouse-off.js
              move-up.js.map
              between-horizonal-start.js.map
              wrench.js.map
              shield-alert.js.map
              share-2.js.map
              arrow-down-left-square.js.map
              message-square-quote.js
              pointer.js.map
              ice-cream-2.js.map
              split-square-horizontal.js.map
              square-dashed-bottom-code.js
              message-circle-x.js.map
              receipt-indian-rupee.js.map
              citrus.js
              app-window.js
              monitor-pause.js
              swiss-franc.js.map
              binary.js
              text.js.map
              circle-slash.js
              arrow-down-01.js.map
              grid-2-x-2.js
              gallery-thumbnails.js
              locate.js
              check-square.js
              plus-square.js.map
              package.js.map
              book-audio.js.map
              forward.js.map
              arrow-up-right-square.js
              message-square-quote.js.map
              webhook.js
              circle-dot-dashed.js
              file-json-2.js
              hard-drive-upload.js
              leafy-green.js
              bar-chart-big.js
              alert-circle.js
              earth.js.map
              reply.js
              square-arrow-right.js
              tally-4.js.map
              flag-triangle-left.js
              panel-top-close.js.map
              table-cells-merge.js
              arrow-big-right-dash.js
              file-image.js.map
              user-round-minus.js
              layout-list.js.map
              corner-left-up.js
              file-down.js
              mail-open.js.map
              code-square.js.map
              parking-square.js.map
              bed-single.js.map
              calendar-plus.js
              heater.js
              cup-soda.js
              circle-fading-plus.js
              volume-x.js
              alarm-clock-off.js
              hop-off.js.map
              dice-3.js.map
              panel-bottom.js
              file-diff.js
              badge-x.js.map
              database.js
              import.js.map
              baseline.js.map
              file-music.js
              pause.js.map
              calendar-off.js.map
              square-dashed-kanban.js.map
              globe.js.map
              plus-circle.js.map
              power-square.js
              help-circle.js.map
              code.js
              corner-right-up.js
              arrow-down-left-square.js
              circle-minus.js.map
              map-pinned.js.map
              triangle-right.js.map
              drill.js
              panel-right.js
              message-square-code.js
              meh.js
              plug-zap-2.js.map
              form-input.js
              move-diagonal-2.js
              chevron-up-square.js
              shopping-bag.js
              mail.js.map
              contact-round.js
              square-parking-off.js.map
              file-digit.js
              circle-chevron-down.js
              headset.js
              arrow-up-right.js.map
              hotel.js.map
              grid-2x2-x.js.map
              maximize.js
              warehouse.js.map
              ratio.js
              badge-plus.js
              panel-right-inactive.js.map
              rabbit.js
              git-pull-request-arrow.js.map
              check-circle.js
              arrow-down-a-z.js.map
              beaker.js.map
              rows-4.js.map
              flip-horizontal-2.js.map
              git-commit-vertical.js.map
              bar-chart-horizontal-big.js.map
              user-minus.js
              test-tube.js.map
              folder-root.js
              plus-circle.js
              lamp-wall-up.js.map
              file-edit.js
              layout-panel-top.js.map
              alarm-clock-plus.js.map
              flag.js
              repeat-1.js.map
              gallery-vertical.js.map
              navigation-off.js.map
              gantt-chart.js.map
              hand.js.map
              arrow-down-01.js
              message-circle-off.js
              languages.js.map
              corner-down-right.js
              flip-vertical.js.map
              receipt.js
              rows-2.js
              pen-line.js
              milk-off.js
              file-plus.js.map
              arrow-up-10.js.map
              view.js.map
              file-code.js
              list-collapse.js
              loader-2.js.map
              minus.js
              align-vertical-distribute-start.js
              chevrons-left-right.js
              sunset.js.map
              file-diff.js.map
              list-start.js
              corner-left-down.js
              move-left.js.map
              trees.js.map
              webhook.js.map
              bell-electric.js
              shrink.js
              message-square-code.js.map
              users-2.js
              thumbs-down.js
              sidebar-close.js.map
              bold.js.map
              wine-off.js
              guitar.js
              baggage-claim.js.map
              sidebar-close.js
              cloudy.js.map
              lightbulb-off.js
              volume-x.js.map
              arrow-down-left-from-square.js
              arrow-up-from-line.js.map
              cable.js.map
              move-right.js.map
              square-divide.js
              image-off.js.map
              unplug.js
              loader-2.js
              monitor-stop.js
              lamp-desk.js
              test-tube-diagonal.js.map
              video-off.js.map
              eraser.js.map
              paintbrush-2.js
              download.js
              loader.js
              link-2-off.js.map
              table-columns-split.js.map
              file-pen.js
              kanban-square.js.map
              indian-rupee.js
              skip-back.js
              message-circle-dashed.js.map
              arrow-up-10.js
              heart-crack.js
              git-compare.js.map
              navigation-2-off.js
              container.js.map
              bomb.js.map
              circle-power.js.map
              panel-right-dashed.js.map
              align-vertical-distribute-end.js
              edit-2.js.map
              luggage.js
              sidebar-open.js.map
              align-vertical-justify-center.js.map
              power-circle.js.map
              headphones.js
              file-line-chart.js.map
              file-music.js.map
              flip-horizontal.js
              pin-off.js.map
              airplay.js.map
              blend.js
              arrow-down-square.js
              webhook-off.js
              align-horizontal-space-between.js.map
              party-popper.js.map
              flask-round.js.map
              octagon-alert.js.map
              banana.js.map
              keyboard.js.map
              thermometer-sun.js
              microscope.js
              file-pen-line.js.map
              focus.js
              tally-2.js.map
              clock-11.js
              square-split-horizontal.js
              award.js
              pen-square.js.map
              more-horizontal.js
              function-square.js
              copy-slash.js
              power-square.js.map
              scaling.js.map
              star-half.js.map
              picture-in-picture-2.js.map
              volume-2.js.map
              bug-play.js.map
              tram-front.js
              eclipse.js.map
              arrow-left-circle.js
              pen-tool.js
              underline.js
              heading-5.js
              badge-cent.js
              receipt-pound-sterling.js.map
              music-3.js.map
              quote.js
              case-upper.js.map
              arrow-up-0-1.js
              chevron-last.js
              panels-left-bottom.js.map
              dog.js.map
              container.js
              clock-10.js
              book-up.js.map
              school-2.js
              church.js
              text-select.js.map
              cctv.js
              shirt.js.map
              copy-plus.js
              expand.js.map
              badge-euro.js
              arrow-down-right-from-circle.js
              twitter.js.map
              book-plus.js
              x-circle.js.map
              underline.js.map
              send-to-back.js
              loader-circle.js.map
              plane-landing.js.map
              theater.js.map
              chevron-up-circle.js
              image.js.map
              wallet-2.js
              square-user.js
              pilcrow-square.js.map
              columns-2.js
              square-sigma.js.map
              filter-x.js.map
              git-pull-request.js
              arrow-up-from-line.js
              monitor.js.map
              slash-square.js
              folder-open.js.map
              between-horizontal-end.js.map
              book-dashed.js.map
              history.js
              copy-slash.js.map
              cloudy.js
              merge.js.map
              radical.js.map
              alert-triangle.js.map
              dna-off.js
              guitar.js.map
              mouse-pointer-2.js.map
              git-compare-arrows.js.map
              truck.js
              heart-pulse.js
              gamepad-2.js
              axis-3-d.js
              highlighter.js
              backpack.js.map
              book-open-check.js
              cloud.js
              timer-reset.js.map
              square-equal.js
              maximize-2.js.map
              podcast.js
              circuit-board.js.map
              clipboard-pen-line.js.map
              user-plus.js.map
              brackets.js.map
              check-square-2.js.map
              laugh.js.map
              maximize-2.js
              grab.js
              a-large-small.js
              arrow-up-square.js
              ear-off.js
              heading-3.js
              calendar-search.js.map
              braces.js
              message-circle-plus.js
              radio.js.map
              log-out.js.map
              align-vertical-distribute-start.js.map
              undo.js
              sticky-note.js
              circle-parking.js.map
              arrow-up-left.js
              tally-4.js
              server-off.js.map
              boom-box.js.map
              file-search.js
              arrow-up-right-from-square.js.map
              waves.js.map
              wine.js.map
              square-kanban.js.map
              cloud.js.map
              ghost.js.map
              circle-dashed.js
              chevron-first.js
              user-round-plus.js
              file-text.js.map
              settings.js
              arrow-right-to-line.js.map
              voicemail.js.map
              heart.js
              plus.js.map
              eye-off.js.map
              save.js.map
              square-terminal.js
              orbit.js.map
              clipboard-type.js
              paw-print.js
              message-square-dashed.js
              utility-pole.js.map
              heart-handshake.js
              quote.js.map
              circle-dollar-sign.js
              panel-right-open.js.map
              clipboard-signature.js
              user-round-plus.js.map
              copy-x.js
              scan-barcode.js.map
              trending-up.js.map
              music.js.map
              between-horizontal-start.js.map
              flip-horizontal-2.js
              slice.js
              bolt.js
              ticket-x.js
              tablet.js.map
              arrow-down-left-from-circle.js.map
              accessibility.js.map
              videotape.js.map
              contact.js
              triangle-alert.js.map
              panel-bottom-open.js
              briefcase-business.js
              tally-1.js
              radical.js
              drum.js.map
              chevron-right-square.js.map
              indent-increase.js
              milk.js.map
              refresh-cw-off.js
              move-vertical.js
              square-gantt-chart.js.map
              shrub.js.map
              monitor-play.js
              user-circle-2.js
              rocking-chair.js.map
              database.js.map
              circle-pause.js
              sliders.js.map
              arrow-up-right-square.js.map
              panel-bottom-dashed.js
              radius.js.map
              moon-star.js.map
              spray-can.js.map
              message-circle-reply.js.map
              mail-x.js
              spell-check-2.js.map
              pickaxe.js.map
              tally-3.js.map
              wrench.js
              git-merge.js
              table-2.js
              octagon-pause.js
              swords.js
              martini.js
              scan-text.js.map
              square-play.js.map
              trending-up.js
              cable-car.js.map
              user-plus.js
              file-digit.js.map
              factory.js.map
              dice-5.js.map
              message-square-more.js.map
              timer-reset.js
              copyright.js
              sun-snow.js.map
              message-circle-code.js
              sigma.js
              square-arrow-out-down-right.js
              panel-top-inactive.js.map
              ship-wheel.js.map
              align-end-vertical.js
              file-bar-chart-2.js
              torus.js.map
              satellite-dish.js.map
              align-vertical-distribute-center.js.map
              unlock-keyhole.js
              megaphone.js
              dog.js
              ungroup.js
              book-a.js
              check-circle.js.map
              volume-1.js.map
              pilcrow-left.js.map
              antenna.js.map
              file-code-2.js
              file-code-2.js.map
              creative-commons.js
              list-ordered.js.map
              lamp-floor.js.map
              circle-slash.js.map
              boxes.js
              store.js
              tags.js
              alarm-check.js.map
              watch.js
              align-horizontal-justify-center.js.map
              telescope.js.map
              pound-sterling.js
              search-x.js
              panel-left-open.js
              tablets.js
              book-headphones.js
              user-x-2.js
              file-bar-chart-2.js.map
              text-selection.js.map
              ticket-check.js
              glass-water.js
              book-image.js.map
              notebook-text.js.map
              mic-off.js.map
              calendar-minus.js.map
              door-closed.js
              app-window-mac.js
              stop-circle.js
              utility-pole.js
              calendar-x-2.js
              castle.js.map
              flower-2.js.map
              arrow-right-circle.js.map
              euro.js.map
              skip-forward.js
              indent-increase.js.map
              asterisk.js.map
              folder-symlink.js
              workflow.js.map
              squircle.js.map
              circle-slashed.js
              flag-triangle-left.js.map
              swiss-franc.js
              library.js
              square-play.js
              move-up-left.js
              sliders.js
              folder-up.js.map
              trash-2.js
              shield-ban.js
              parking-circle-off.js.map
              scan-barcode.js
              brain.js
              pocket.js
              flag.js.map
              bike.js
              shield-question.js
              smartphone.js.map
              cone.js.map
              clock-6.js
              circle-user.js
              toggle-right.js
              chevron-down.js.map
              shopping-basket.js.map
              arrow-big-down.js
              square-activity.js
              panel-left-inactive.js
              candy-cane.js.map
              alarm-clock.js
              cookie.js
              alarm-smoke.js.map
              shield-plus.js
              text-search.js.map
              feather.js
              plane-takeoff.js.map
              pen-square.js
              fish-symbol.js.map
              shield-half.js
              rectangle-vertical.js.map
              monitor-smartphone.js
              train-front-tunnel.js
              mic.js
              circle-power.js
              square-m.js.map
              pizza.js.map
              external-link.js
              align-center.js.map
              codepen.js
              cloud-rain-wind.js
              wind.js.map
              move-horizontal.js
              layers.js
              bitcoin.js.map
              folder-git.js
              folder-lock.js
              image-minus.js.map
              drumstick.js.map
              bell-dot.js
              circle-parking-off.js.map
              shield-close.js.map
              rocking-chair.js
              panel-left-close.js.map
              weight.js.map
              locate-off.js.map
              square-scissors.js
              bean.js.map
              move-vertical.js.map
              square-x.js.map
              signpost-big.js
              log-in.js.map
              clipboard-signature.js.map
              gamepad.js
              panel-bottom-close.js
              car-taxi-front.js
              radiation.js.map
              book-plus.js.map
              pin.js
              globe-2.js
              file-lock-2.js
              archive-restore.js.map
              cloud-upload.js.map
              toy-brick.js
              folder-symlink.js.map
              nut-off.js
              text-select.js
              sheet.js
              redo.js.map
              microscope.js.map
              code-xml.js
              heading-1.js.map
              lamp-wall-down.js
              plane.js.map
              message-circle-heart.js.map
              link-2.js
              clock-7.js.map
              terminal.js.map
              paperclip.js
              ampersands.js.map
              cloud-drizzle.js
              chevrons-left-right.js.map
              hand-platter.js.map
              arrow-down-to-dot.js.map
              building.js.map
              circle-arrow-out-up-right.js
              cake-slice.js
              chevrons-left.js
              receipt-russian-ruble.js.map
              layout-panel-top.js
              database-zap.js.map
              remove-formatting.js
              square-gantt-chart.js
              upload.js.map
              beaker.js
              search.js
              rocket.js
              bring-to-front.js.map
              arrow-up-left-from-circle.js
              folder-key.js
              grid-2-x-2.js.map
              notebook.js.map
              picture-in-picture.js.map
              square-pen.js
              file-axis-3d.js
              flag-off.js.map
              square-split-vertical.js.map
              curly-braces.js.map
              parentheses.js.map
              chevron-up.js
              square-activity.js.map
              battery-warning.js
              move-down-right.js.map
              between-vertical-start.js.map
              ban.js.map
              calendar-check-2.js.map
              square-user-round.js.map
              phone-forwarded.js.map
              biohazard.js.map
              chevron-left-square.js.map
              tree-palm.js.map
              arrow-down-to-line.js.map
              file-key-2.js
              hospital.js.map
              cloud-sun-rain.js.map
              disc-3.js
              fish.js.map
              git-compare-arrows.js
              air-vent.js.map
              panel-top.js.map
              bug.js.map
              circle-dollar-sign.js.map
              ham.js
              circle-help.js.map
              signal-low.js.map
              candy-off.js.map
              crown.js.map
              cloud-sun-rain.js
              star-half.js
              slice.js.map
              book-up-2.js.map
              file-code.js.map
              signal-high.js.map
              cloud-upload.js
              octagon-x.js.map
              user-square.js.map
              between-vertical-start.js
              git-branch.js
              archive.js
              book-open.js.map
              armchair.js
              captions-off.js.map
              filter.js
              square-chevron-down.js
              mouse.js
              align-center-vertical.js
              inbox.js
              life-buoy.js
              folder-down.js.map
              grid.js.map
              verified.js
              badge-check.js.map
              slash-square.js.map
              landmark.js.map
              cog.js.map
              align-horizontal-justify-end.js
              chevron-right.js.map
              package-search.js
              space.js
              user-round-cog.js
              send-to-back.js.map
              feather.js.map
              palmtree.js.map
              align-justify.js.map
              circle-equal.js.map
              text-search.js
              leafy-green.js.map
              user-round-check.js
              gallery-vertical-end.js.map
              align-vertical-justify-center.js
              user-circle.js
              book-check.js
              smile.js.map
              arrow-down.js
              scan-eye.js.map
              egg-fried.js
              stop-circle.js.map
              airplay.js
              arrow-down-right.js.map
              spade.js.map
              receipt-indian-rupee.js
              annoyed.js
              tractor.js
              parking-circle.js.map
              music-4.js.map
              square-bottom-dashed-scissors.js
              alarm-minus.js
              folder-x.js.map
              table-rows-split.js
              clipboard-list.js.map
              target.js
              slack.js
              arrow-up-wide-narrow.js
              heart-handshake.js.map
              hexagon.js.map
              user-plus-2.js.map
              life-buoy.js.map
              history.js.map
              russian-ruble.js.map
              sun-dim.js
              disc-album.js.map
              shopping-basket.js
              activity.js.map
              mouse-pointer-click.js.map
              square-chevron-left.js
              box.js
              globe-lock.js
              glass-water.js.map
              volume.js
              inspection-panel.js
              sunrise.js
              phone.js
              calendar-check-2.js
              folder-x.js
              martini.js.map
              sun.js
              arrow-left-from-line.js
              mail-warning.js.map
              move-left.js
              badge-russian-ruble.js.map
              navigation-2.js
              rectangle-ellipsis.js
              alert-octagon.js.map
              keyboard-music.js
              message-square-reply.js
              factory.js
              shield-minus.js
              radio.js
              refresh-ccw.js
              castle.js
              codesandbox.js
              skip-forward.js.map
              gallery-horizontal.js
              pencil.js
              search-slash.js
              a-arrow-down.js.map
              pipette.js
              square-arrow-out-down-left.js
              hammer.js.map
              user-cog-2.js
              highlighter.js.map
              sparkle.js.map
              flame-kindling.js.map
              chevrons-left.js.map
              clipboard-pen.js.map
              repeat.js.map
              grip.js
              printer.js.map
              square-arrow-down.js.map
              heading-1.js
              square-slash.js.map
              sun-medium.js
              square-dashed-kanban.js
              key-round.js
              sheet.js.map
              palette.js.map
              pilcrow-right.js.map
              lock-keyhole-open.js
              diamond-percent.js.map
              panels-top-bottom.js.map
              hard-drive-download.js.map
              battery-low.js
              clock-5.js.map
              message-circle-code.js.map
              stamp.js.map
              server-crash.js
              shield-minus.js.map
              sunset.js
              cpu.js
              folder-git.js.map
              badge-euro.js.map
              panel-top-open.js.map
              atom.js
              clapperboard.js
              image-down.js
              square-plus.js
              sofa.js
              arrow-down-10.js
              layout.js.map
              cloud-rain.js.map
              syringe.js
              users-round.js
              chevron-left-square.js
              image-off.js
              vote.js
              bookmark-check.js.map
              expand.js
              circuit-board.js
              alarm-clock-check.js
              refresh-cw-off.js.map
              check-check.js.map
              command.js.map
              arrow-big-up.js
              align-horizontal-space-between.js
              at-sign.js.map
              trees.js
              locate-off.js
              calendar-fold.js.map
              joystick.js
              replace.js
              wallet-minimal.js
              flip-vertical-2.js.map
              chevrons-down.js
              option.js
              route.js
              monitor-up.js.map
              folder-cog.js.map
              bean.js
              dice-3.js
              archive-x.js.map
              ellipsis-vertical.js.map
              church.js.map
              file-badge.js.map
              git-graph.js.map
              alert-triangle.js
              calendar-days.js.map
              book-minus.js
              anvil.js.map
              cat.js.map
              framer.js.map
              building-2.js
              user-plus-2.js
              kanban.js
              megaphone-off.js.map
              shield-ellipsis.js
              arrow-down-1-0.js.map
              square-pilcrow.js
              wand.js
              moon-star.js
              route-off.js.map
              cassette-tape.js
              ambulance.js
              laptop-2.js
              mouse-off.js.map
              trophy.js
              asterisk.js
              repeat-2.js.map
              plane-takeoff.js
              list-todo.js.map
              repeat.js
              crosshair.js.map
              align-justify.js
              footprints.js.map
              bar-chart-3.js
              undo-2.js.map
              indent.js.map
              arrow-up-az.js
              zoom-in.js
              kanban-square-dashed.js.map
              message-square.js
              move-diagonal-2.js.map
              user-circle.js.map
              signal-low.js
              file-cog-2.js
              locate-fixed.js.map
              arrow-right-square.js
              calendar-x.js
              forklift.js
              phone-off.js
              table-properties.js.map
              loader-pinwheel.js.map
              dice-5.js
              user.js.map
              book-x.js.map
              filter.js.map
              arrow-down-left.js
              image-plus.js.map
              cpu.js.map
              arrow-left-square.js
              cloud-off.js.map
              gallery-horizontal-end.js
              mails.js.map
              signal-zero.js
              sliders-vertical.js.map
              battery-warning.js.map
              book-down.js.map
              helping-hand.js
              wrap-text.js
              thermometer-snowflake.js
              minus-square.js
              badge-russian-ruble.js
              list-checks.js.map
              tree-deciduous.js.map
              rows.js
              cuboid.js.map
              shield-alert.js
              cigarette-off.js.map
              shrub.js
              inspection-panel.js.map
              file-badge-2.js
              arrow-right-square.js.map
              pen-tool.js.map
              parentheses.js
              file-down.js.map
              clock-4.js.map
              aperture.js.map
              diamond-percent.js
              folder-sync.js.map
              link.js
              headphones.js.map
              bot.js
              refrigerator.js.map
              rotate-ccw.js
              clipboard-minus.js
              bring-to-front.js
              book-open-check.js.map
              file-archive.js.map
              calendar-heart.js
              x.js
              user-check.js.map
              panel-right-close.js.map
              circle-dot.js
              user-check.js
              store.js.map
              scissors.js
              git-pull-request-draft.js
              book-dashed.js
              message-square-off.js
              square-chevron-right.js
              circle-slashed.js.map
              badge-percent.js
              bell-electric.js.map
              square-minus.js.map
              file-pie-chart.js.map
              arrow-up-right-from-square.js
              trello.js
              between-vertical-end.js.map
              rotate-ccw-square.js.map
              file-terminal.js
              badge.js
              file-sliders.js.map
              eraser.js
              arrow-big-left.js
              fire-extinguisher.js
              footprints.js
              washing-machine.js.map
              file-signature.js.map
              redo-dot.js.map
              circle-play.js
              text-quote.js.map
              ruler.js.map
              file-archive.js
              calendar-clock.js.map
              rows.js.map
              file-minus.js
              computer.js.map
              flask-conical.js
              newspaper.js.map
              baseline.js
              file-axis-3d.js.map
              square-radical.js
              square-parking.js.map
              gallery-vertical-end.js
              sliders-vertical.js
              chevron-down-square.js.map
              file-axis-3-d.js
              twitch.js.map
              ice-cream-cone.js.map
              sparkles.js
              grip-vertical.js.map
              file-stack.js
              list-video.js.map
              database-zap.js
              lock-keyhole.js.map
              file-volume.js.map
              message-circle-heart.js
              circle-check.js.map
              circle-chevron-up.js.map
              redo-2.js.map
              list-start.js.map
              forklift.js.map
              map-pin.js.map
              tv.js
              view.js
              square-menu.js
              cloud-hail.js.map
              webhook-off.js.map
              circle-gauge.js.map
              equal-not.js
              snail.js.map
              caravan.js.map
              video-off.js
              carrot.js
              panel-bottom.js.map
              message-circle-warning.js
              repeat-1.js
              a-arrow-up.js
              between-horizonal-end.js.map
              italic.js
              align-center-horizontal.js
              file-video.js
              fold-vertical.js
              folder-pen.js.map
              thermometer.js
              hand-platter.js
              bluetooth-off.js
              x-octagon.js.map
              text-cursor-input.js.map
              laptop-2.js.map
              piano.js.map
              grid-2x2-x.js
              eye.js
              star-off.js.map
              copyright.js.map
              text-cursor.js.map
              circle-arrow-out-up-right.js.map
              speech.js
              bomb.js
              percent.js.map
              clock-2.js.map
              droplet.js.map
              hash.js
              heart-off.js
              chevrons-up-down.js
              git-compare.js
              rail-symbol.js
              thumbs-up.js.map
              calendar.js.map
              book-image.js
              separator-horizontal.js.map
              pen-line.js.map
              search-x.js.map
              package-plus.js.map
              calendar-heart.js.map
              corner-right-down.js
              replace-all.js
              minimize-2.js
              dessert.js.map
              lamp.js.map
              star.js.map
              package-check.js.map
              shovel.js.map
              file-x.js
              library-big.js.map
              file-key-2.js.map
              mouse.js.map
              square-m.js
              satellite.js
              dock.js
              hand-helping.js.map
              ticket-slash.js
              arrow-down-a-z.js
              turtle.js
              chevron-left.js
              panel-left.js
              circle-percent.js.map
              drama.js.map
              hotel.js
              messages-square.js
              pointer.js
              grid-3x3.js
              book.js.map
              toy-brick.js.map
              sun-medium.js.map
              square-check-big.js.map
              circle-arrow-out-up-left.js
              phone-off.js.map
              layers-2.js
              bus-front.js.map
              image-up.js
              superscript.js.map
              squirrel.js
              ice-cream.js.map
              mouse-pointer-ban.js
              folder-git-2.js.map
              clipboard-plus.js.map
              switch-camera.js
              arrow-up-left.js.map
              trophy.js.map
              bone.js.map
              arrow-left-right.js.map
              battery-full.js
              square-percent.js.map
              search-check.js
              school-2.js.map
              grid-2x2.js.map
              circle-ellipsis.js.map
              message-circle.js.map
              lollipop.js
              arrow-big-up-dash.js.map
              shield-check.js.map
              between-horizontal-end.js
              ticket-percent.js.map
              arrow-up-az.js.map
              globe-2.js.map
              check.js
              bed.js.map
              pin-off.js
              panel-right.js.map
              settings-2.js
              captions.js.map
              move-3-d.js.map
              bar-chart.js.map
              cooking-pot.js
              blocks.js.map
              trash-2.js.map
              wand-sparkles.js.map
              table-rows-split.js.map
              screen-share-off.js
              disc-3.js.map
              square-parking-off.js
              gitlab.js.map
              file-type-2.js.map
              arrow-up-za.js
              badge.js.map
              list-music.js.map
              alert-circle.js.map
              redo.js
              users-2.js.map
              square-divide.js.map
              cannabis.js
              chevron-right-square.js
              brain-cog.js
              minimize-2.js.map
              file-input.js.map
              book-lock.js.map
              circle-chevron-right.js.map
              grid-3x3.js.map
              mic-vocal.js.map
              columns-3.js.map
              users.js
              m-square.js
              square.js.map
              linkedin.js.map
              gift.js.map
              file-axis-3-d.js.map
              square-function.js
              bitcoin.js
              gallery-vertical.js
              bone.js
              skull.js
              package-open.js.map
              ungroup.js.map
              share-2.js
              strikethrough.js.map
              circle-arrow-left.js.map
              lightbulb-off.js.map
              hard-drive-upload.js.map
              file-search.js.map
              swatch-book.js
              lightbulb.js.map
              check-square-2.js
              wifi-off.js.map
              cloud-rain.js
              merge.js
              touchpad.js.map
              tag.js
              squirrel.js.map
              indent-decrease.js.map
              triangle.js.map
              scale-3d.js
              battery-medium.js
              align-vertical-space-between.js
              bus.js
              cable-car.js
              candlestick-chart.js.map
              piggy-bank.js
              bluetooth-connected.js
              package-2.js
              square-stack.js.map
              align-vertical-space-between.js.map
              file-warning.js.map
              panels-left-bottom.js
              folder-root.js.map
              monitor-play.js.map
              index.js.map
              cloud-fog.js.map
              arrow-down-right-from-square.js.map
              nut-off.js.map
              power-circle.js
              iteration-cw.js
              corner-right-up.js.map
              a-arrow-down.js
              rectangle-ellipsis.js.map
              circle-x.js.map
              calendar.js
              mail-minus.js.map
              activity.js
              droplets.js
              satellite.js.map
              file-json-2.js.map
              atom.js.map
              shell.js.map
              badge-swiss-franc.js.map
              pause-circle.js
              hard-hat.js
              align-vertical-justify-end.js
              square-arrow-left.js.map
              ampersand.js.map
              alarm-clock-plus.js
              bar-chart-4.js
              palmtree.js
              grip-horizontal.js
              align-horizontal-justify-start.js.map
              baby.js.map
              circle-percent.js
              hourglass.js.map
              plug-2.js
              radio-tower.js
              milestone.js.map
              mail-open.js
              circle-alert.js.map
              door-closed.js.map
              badge-info.js
              octagon.js
              battery-medium.js.map
              layout-grid.js.map
              sprout.js.map
              user-cog.js.map
              dot-square.js
              axe.js
              message-square-dashed.js.map
              cake.js.map
              alert-octagon.js
              forward.js
              cloud-moon.js
              egg.js.map
              audio-waveform.js
              paw-print.js.map
              reply-all.js.map
              haze.js.map
              case-lower.js.map
              arrow-big-right-dash.js.map
              smile-plus.js
              alarm-clock-check.js.map
              user-2.js.map
              git-fork.js.map
              clipboard-list.js
              folder-plus.js
              waypoints.js
              github.js.map
              server-cog.js
              ferris-wheel.js.map
              sticker.js
              hand-coins.js.map
              captions-off.js
              minus-circle.js.map
              pocket.js.map
              tablets.js.map
              stretch-vertical.js.map
              monitor-x.js
              phone-outgoing.js.map
              clock-8.js.map
              text-quote.js
              code-2.js
              tornado.js.map
              pen-box.js.map
              smartphone-nfc.js
              zap.js
              folder-edit.js
              arrow-down-z-a.js
              table-cells-split.js
              square-chevron-down.js.map
              palette.js
              alarm-minus.js.map
              captions.js
              table-cells-merge.js.map
              file-check-2.js
              text-selection.js
              square-arrow-down.js
              mailbox.js.map
              message-square-plus.js.map
              bike.js.map
              maximize.js.map
              magnet.js
              stretch-horizontal.js
              file-x.js.map
              square-arrow-down-left.js
              contact-2.js
              laptop-minimal.js
              battery-charging.js.map
              blend.js.map
              file-spreadsheet.js.map
              umbrella.js
              chevrons-up.js
              git-commit-horizontal.js
              hourglass.js
              user-2.js
              tally-5.js
              arrow-down-square.js.map
              candy.js.map
              file-input.js
              pentagon.js.map
              star-off.js
              columns-4.js.map
              chevron-right-circle.js
              square-arrow-down-right.js.map
              fast-forward.js.map
              square-arrow-up-right.js
              search.js.map
              x-circle.js
              bell-off.js.map
              indian-rupee.js.map
              user-round-cog.js.map
              bar-chart-horizontal.js
              square-plus.js.map
              heading-3.js.map
              memory-stick.js.map
              loader-circle.js
              toggle-left.js
              panel-left.js.map
              touchpad-off.js.map
              scissors.js.map
              arrow-big-left-dash.js
              image-plus.js
              scissors-square.js.map
              badge-help.js
              zap-off.js
              file-bar-chart.js.map
              outdent.js
              undo-dot.js.map
              arrow-big-down-dash.js.map
              square-code.js.map
              heading-2.js
              share.js
              barcode.js.map
              italic.js.map
              subscript.js.map
              scaling.js
              refresh-cw.js
              circle-arrow-out-up-left.js.map
              plus-square.js
              zoom-out.js.map
              corner-up-left.js.map
              folder-edit.js.map
              smartphone-nfc.js.map
              bean-off.js
              square-user-round.js
              shopping-cart.js
              layout-template.js.map
              scissors-line-dashed.js.map
              square-arrow-up-left.js.map
              message-circle-more.js
              croissant.js.map
              tram-front.js.map
              mail-check.js
              arrow-down-az.js.map
              calendar-plus.js.map
              ribbon.js
              book-template.js.map
              redo-dot.js
              clipboard-check.js.map
              stethoscope.js.map
              message-circle-question.js
              arrow-left.js
              bed-double.js
              user-square-2.js
              git-commit-horizontal.js.map
              flashlight-off.js
              mouse-pointer-2.js
              file-pie-chart.js
              package-minus.js.map
              notebook-tabs.js.map
              subscript.js
              fish-off.js
              fold-vertical.js.map
              film.js.map
              book-minus.js.map
              laptop-minimal.js.map
              keyboard-off.js
              school.js.map
              coffee.js
              recycle.js
              arrow-down-right-from-circle.js.map
              worm.js.map
              file-minus.js.map
              file-json.js
              indent-decrease.js
              book-down.js
              cloud-moon-rain.js.map
              bed-double.js.map
              clock-9.js
              candy-off.js
              tags.js.map
              clipboard-edit.js
              venetian-mask.js
              wand-2.js
              user-search.js.map
              message-square-x.js.map
              step-back.js
              folder-minus.js
              videotape.js
              beer-off.js.map
              thumbs-up.js
              sun.js.map
              arrow-down-1-0.js
              ruler.js
              indent.js
              bird.js
              move-3d.js
              square-mouse-pointer.js.map
              image.js
              heart-crack.js.map
              x-square.js.map
              drill.js.map
              codepen.js.map
              volume-2.js
              panels-right-bottom.js.map
              utensils.js
              image-play.js
              mic-2.js.map
              person-standing.js
              cherry.js.map
              disc-2.js.map
              square-split-vertical.js
              server-crash.js.map
              toggle-right.js.map
              list-x.js
              parking-meter.js
              twitch.js
              train-front-tunnel.js.map
              ship.js.map
              luggage.js.map
              align-end-horizontal.js
              hand-metal.js.map
              line-chart.js.map
              arrow-up-down.js.map
              repeat-2.js
              clover.js.map
              move-horizontal.js.map
              percent.js
              grid.js
              map-pin.js
              badge-alert.js
              axis-3-d.js.map
              divide.js
              panel-top.js
              circle-divide.js
              brick-wall.js
              square-stack.js
              monitor-stop.js.map
              file-video.js.map
              unlock.js
              archive-restore.js
              panel-top-open.js
              bluetooth-searching.js
              arrow-up-down.js
              at-sign.js
              chevron-down.js
              handshake.js
              list-video.js
              badge-minus.js.map
              key-square.js
              clock-11.js.map
              scatter-chart.js
              receipt-japanese-yen.js.map
              copy-plus.js.map
              umbrella-off.js.map
              align-horizontal-distribute-center.js
              chevrons-right.js
              hash.js.map
              plug-zap.js
              map-pin-off.js.map
              salad.js.map
              ticket.js
              code.js.map
              candy.js
              folder-closed.js
              coffee.js.map
              info.js
              git-branch.js.map
              vibrate-off.js.map
              arrow-left-right.js
              file-x-2.js
              iteration-cw.js.map
              brain.js.map
              arrow-right-circle.js
              clock-7.js
              circle-arrow-out-down-left.js.map
              chevrons-up-down.js.map
              train.js
              key-round.js.map
              book-headphones.js.map
              ratio.js.map
              stretch-horizontal.js.map
              frown.js
              coins.js.map
              square-function.js.map
              rss.js.map
              salad.js
              clipboard-copy.js.map
              mails.js
              file-signature.js
              receipt.js.map
              folder-pen.js
              globe.js
              bell.js
              wallpaper.js
              paint-roller.js
              circle-arrow-out-down-left.js
              activity-square.js
              book-lock.js
              touchpad-off.js
              message-square.js.map
              space.js.map
              crown.js
              wheat.js.map
              user-cog.js
              party-popper.js
              sun-snow.js
              coins.js
              beef.js.map
              flower.js
              circle-stop.js.map
              badge-dollar-sign.js.map
              instagram.js
              file-stack.js.map
              chevrons-right.js.map
              message-square-x.js
              user-minus.js.map
              file-clock.js
              circle-check-big.js.map
              keyboard.js
              medal.js
              drumstick.js
              help-circle.js
              clipboard-type.js.map
              lasso.js.map
              vibrate.js.map
              navigation.js.map
              club.js.map
              message-square-warning.js.map
              bell-plus.js.map
              sunrise.js.map
              cloud-snow.js.map
              heading-4.js.map
              delete.js.map
              sigma.js.map
              clipboard-x.js.map
              message-circle-more.js.map
              case-sensitive.js.map
              bus.js.map
              contact.js.map
              inbox.js.map
              clock.js
              wind.js
              arrow-up-from-dot.js.map
              sticker.js.map
              layers-3.js.map
              align-horizontal-distribute-start.js
              message-circle-plus.js.map
              monitor-dot.js
              codesandbox.js.map
              plug-zap-2.js
              arrow-up-wide-narrow.js.map
              ligature.js.map
              grid-2x2-check.js
              laugh.js
              refresh-ccw-dot.js
              file-cog-2.js.map
              files.js.map
              app-window-mac.js.map
              circle-user-round.js
              box-select.js
              arrow-big-left-dash.js.map
              octagon-alert.js
              library-big.js
              area-chart.js.map
              picture-in-picture-2.js
              upload-cloud.js.map
              arrow-down-za.js
              bar-chart-horizontal-big.js
              grape.js
              phone-missed.js
              folder-search-2.js.map
              gallery-horizontal.js.map
              settings-2.js.map
              target.js.map
              file-clock.js.map
              folder-clock.js.map
              cylinder.js.map
              ellipsis.js.map
              send.js.map
              ambulance.js.map
              folder-search.js
              alarm-smoke.js
              pencil-ruler.js
              file-symlink.js.map
              edit.js
              vibrate.js
              list-end.js.map
              badge-japanese-yen.js.map
              receipt-euro.js.map
              receipt-cent.js.map
              rows-4.js
              square-pilcrow.js.map
              git-pull-request.js.map
              list-tree.js.map
              folder-input.js
              moon.js.map
              code-2.js.map
              battery-low.js.map
              flame-kindling.js
              network.js
              qr-code.js
              arrow-up.js.map
              signpost.js
              tally-2.js
              circle-slash-2.js.map
              grid-3-x-3.js
              circle-user-round.js.map
              parking-circle.js
              receipt-euro.js
              flower.js.map
              square-equal.js.map
              badge-pound-sterling.js
              square-check-big.js
              mountain-snow.js.map
              book-open-text.js.map
              boxes.js.map
              podcast.js.map
              recycle.js.map
              blinds.js.map
              refresh-ccw-dot.js.map
              arrows-up-from-line.js.map
              file-type-2.js
              orbit.js
              square-bottom-dashed-scissors.js.map
              dollar-sign.js.map
              image-up.js.map
              snail.js
              phone-call.js.map
              user-x.js.map
              message-square-diff.js
              projector.js
              circle-arrow-left.js
              bar-chart-horizontal.js.map
              plug-zap.js.map
              axis-3d.js.map
              percent-circle.js
              clipboard-x.js
              rotate-cw-square.js
              star.js
              square-dashed-bottom-code.js.map
              earth-lock.js.map
              eclipse.js
              pen.js
              pi.js.map
              heading-2.js.map
              file.js
              mouse-pointer-ban.js.map
              x-square.js
              percent-diamond.js.map
              clipboard.js.map
              cooking-pot.js.map
              fingerprint.js.map
              clock-12.js
              panel-left-dashed.js.map
              align-center-horizontal.js.map
              database-backup.js.map
              bookmark-plus.js
              megaphone.js.map
              bot-message-square.js.map
              timer-off.js
              square-arrow-out-up-right.js
              redo-2.js
              rows-3.js
              train-track.js
              goal.js
              circle-equal.js
              bot-off.js
              message-square-heart.js.map
              map.js
              grip-horizontal.js.map
              milk.js
              mail-minus.js
              whole-word.js.map
              diamond.js
              gamepad-2.js.map
              panels-left-right.js
              file-lock.js
              diamond-minus.js
              camera-off.js
              arrow-right-from-line.js.map
              utensils-crossed.js.map
              folder-tree.js
              a-arrow-up.js.map
              tower-control.js.map
              panel-bottom-dashed.js.map
              file-up.js.map
              scissors-square-dashed-bottom.js
              clock-1.js
              unfold-vertical.js
              pizza.js
              message-square-dot.js
              bar-chart-3.js.map
              mic-2.js
              plug.js.map
              rewind.js
              ticket-percent.js
              file-audio.js.map
              piano.js
              layout.js
              calendar-check.js.map
              triangle-right.js
              nfc.js.map
              mail-question.js.map
              cloud-snow.js
              rectangle-horizontal.js.map
              align-vertical-distribute-center.js
              briefcase-medical.js
              qr-code.js.map
              bookmark-plus.js.map
              gantt-chart-square.js
              folder-check.js
              folder-lock.js.map
              arrow-big-down-dash.js
              pi.js
              crop.js.map
              person-standing.js.map
              signal-medium.js
              flask-conical.js.map
              arrow-down-to-line.js
              user-minus-2.js.map
              monitor-check.js
              folder-check.js.map
              book-key.js.map
              usb.js.map
              arrow-up-left-from-square.js.map
              library.js.map
              play.js.map
              building-2.js.map
              circle-dot-dashed.js.map
              vegan.js
              monitor-up.js
              spline.js
              frame.js.map
              copy.js.map
              antenna.js
              pen-box.js
              zap-off.js.map
              flip-horizontal.js.map
              construction.js.map
              receipt-japanese-yen.js
              tree-pine.js
              thermometer.js.map
              truck.js.map
              circle-arrow-right.js.map
              arrow-up-right.js
              washing-machine.js
              sort-desc.js.map
              index.js
              leaf.js.map
              server.js
              map.js.map
              panel-right-close.js
              disc.js.map
              phone-forwarded.js
              tally-3.js
              facebook.js.map
              fast-forward.js
              clipboard-plus.js
              file-bar-chart.js
              car.js.map
              play-square.js
              croissant.js
              fence.js.map
              file-scan.js
              pipette.js.map
              group.js
              phone-missed.js.map
              notebook.js
              cross.js
              square.js
              parking-square-off.js
              sofa.js.map
              fish.js
              badge-cent.js.map
              git-pull-request-create-arrow.js
              package-x.js.map
              align-end-vertical.js.map
              align-horizontal-justify-end.js.map
              square-scissors.js.map
              sidebar-open.js
              move-diagonal.js
              folder-heart.js.map
              circle-play.js.map
              git-commit.js.map
              play-circle.js
              arrow-up-1-0.js
              book-x.js
              webcam.js
              layers-2.js.map
              table-2.js.map
              diamond.js.map
              folder-plus.js.map
              ice-cream-cone.js
              move-up-right.js.map
              message-circle-off.js.map
              film.js
              file.js.map
              shower-head.js
              check-square.js.map
              calendar-fold.js
              zoom-in.js.map
              smile.js
              m-square.js.map
              pin.js.map
              clipboard-minus.js.map
              briefcase.js.map
              plus.js
              arrow-up-01.js
              dock.js.map
              calculator.js
              square-asterisk.js
              copy-minus.js.map
              square-split-horizontal.js.map
              car-front.js
              file-cog.js
              languages.js
              radar.js.map
              sort-asc.js.map
              square-sigma.js
              folder-minus.js.map
              circle-dashed.js.map
              file-question.js.map
              square-arrow-right.js.map
              signpost.js.map
              regex.js.map
              send-horizontal.js
              flashlight-off.js.map
              power-off.js
              shuffle.js
              corner-up-right.js
              list-restart.js
              user-cog-2.js.map
              arrow-down-left-from-square.js.map
              earth-lock.js
              menu-square.js
              tent-tree.js
              move-3-d.js
              vibrate-off.js
              smartphone-charging.js
              arrow-down-from-line.js
              shield.js.map
              fuel.js
              arrow-up-z-a.js
              mouse-pointer-click.js
              filter-x.js
              parking-meter.js.map
              bell-minus.js
              panel-left-open.js.map
              arrow-big-up-dash.js
              user-square-2.js.map
              iteration-ccw.js
              smartphone-charging.js.map
              remove-formatting.js.map
              align-center.js
              notepad-text-dashed.js
              gamepad.js.map
              check.js.map
              align-horizontal-distribute-end.js
              grid-2x2-check.js.map
              gem.js
              split-square-vertical.js
              panels-right-bottom.js
              panel-left-inactive.js.map
              file-edit.js.map
              parking-square-off.js.map
              ice-cream.js
              git-fork.js
              scroll-text.js.map
              lock.js
              pen.js.map
              contact-2.js.map
              arrow-down-z-a.js.map
              router.js
              refrigerator.js
              columns-3.js
              percent-square.js.map
              align-right.js
              key-square.js.map
              user-search.js
              lock-open.js
              scan-search.js
              list-x.js.map
              chevron-left-circle.js
              arrow-down-wide-narrow.js
              tractor.js.map
              shirt.js
              timer-off.js.map
              badge-japanese-yen.js
              clock.js.map
              land-plot.js
              table-properties.js
              cigarette.js
              eye.js.map
              square-user.js.map
              clock-9.js.map
              file-audio-2.js
              percent-diamond.js
              waves.js
              heading.js.map
              file-video-2.js.map
              user-square.js
              tent.js
              book-text.js
              separator-vertical.js.map
              clock-8.js
              tangent.js.map
              move.js.map
              euro.js
              scatter-chart.js.map
              shield.js
              circle-user.js.map
              calendar-check.js
              columns-2.js.map
              search-code.js.map
              twitter.js
              fuel.js.map
              list.js
              x.js.map
              message-circle-dashed.js
              vault.js
              ship-wheel.js
              circle-chevron-right.js
              telescope.js
              arrow-up-a-z.js
              rss.js
              youtube.js.map
              file-spreadsheet.js
              banana.js
              package-2.js.map
              navigation.js
              russian-ruble.js
              unfold-horizontal.js.map
              hand.js
              contrast.js
              bookmark-x.js.map
              move-up-right.js
              unlink.js
              file-pen-line.js
              equal.js
              wand.js.map
              circle-off.js
              hand-heart.js.map
              chrome.js.map
              monitor.js
              skip-back.js.map
              arrow-left-circle.js.map
              message-square-share.js
              alarm-clock-off.js.map
              folder-open-dot.js
              package-minus.js
              volume.js.map
              folder-dot.js.map
              folder-sync.js
              vote.js.map
              file-audio.js
              circle-arrow-down.js
              binary.js.map
              bug-off.js
              briefcase.js
              arrow-right-left.js.map
              bell.js.map
              more-vertical.js.map
              receipt-cent.js
              rectangle-horizontal.js
              clipboard-edit.js.map
              arrow-up-a-z.js.map
              mail-search.js.map
              beer.js
              dot-square.js.map
              briefcase-business.js.map
              download-cloud.js.map
              touchpad.js
              arrow-up-circle.js
              paint-bucket.js
              arrow-right-to-line.js
              plane.js
              swords.js.map
              arrow-up-left-square.js
              scan-line.js
              computer.js
              glasses.js.map
              cctv.js.map
              book-type.js
              unlink.js.map
              align-horizontal-distribute-start.js.map
              axis-3d.js
              square-chevron-left.js.map
              folder-output.js
              arrow-left-square.js.map
              scan-eye.js
              ghost.js
              cloud-lightning.js
              biohazard.js
              move-down-right.js
              calendar-plus-2.js
              book-open.js
              rotate-3-d.js.map
              stethoscope.js
              dice-6.js
              variable.js.map
              clover.js
              clipboard-paste.js
              trash.js
              cloud-sun.js
              tree-deciduous.js
              audio-lines.js.map
              linkedin.js
              shield-plus.js.map
              folder-open-dot.js.map
              rat.js.map
              panel-left-close.js
              receipt-russian-ruble.js
              calendar-x-2.js.map
              pause-octagon.js
              octagon-pause.js.map
              square-dashed-mouse-pointer.js.map
              book-template.js
              microwave.js
              hard-drive-download.js
              arrow-up-right-from-circle.js.map
              laptop.js
              git-pull-request-create.js.map
              chevron-left.js.map
              git-pull-request-draft.js.map
              notepad-text.js
              square-minus.js
              circle-slash-2.js
              arrow-down-up.js.map
              stamp.js
              carrot.js.map
              terminal-square.js.map
              mic-vocal.js
              diameter.js.map
              square-terminal.js.map
              presentation.js
              bug-play.js
              instagram.js.map
              land-plot.js.map
              folder-search-2.js
              bluetooth-connected.js.map
              git-merge.js.map
              sun-moon.js.map
              flower-2.js
              ticket-plus.js.map
              equal-not.js.map
              strikethrough.js
              cat.js
              shield-off.js
              list-ordered.js
              clock-2.js
              book-marked.js
              arrow-down-narrow-wide.js.map
              wallet.js
              sprout.js
              square-check.js
              move.js
              panels-top-bottom.js
              fan.js.map
              chevron-last.js.map
              square-arrow-out-up-right.js.map
              youtube.js
              cable.js
              egg-fried.js.map
              tally-5.js.map
              code-xml.js.map
              images.js.map
              rewind.js.map
              move-down-left.js.map
              wrap-text.js.map
              badge-indian-rupee.js
              move-down.js.map
              calendar-off.js
              fold-horizontal.js
              zoom-out.js
              scan-face.js
              arrow-down-0-1.js.map
              torus.js
              chevron-up-circle.js.map
              chevron-right.js
              lock-keyhole.js
              cloud-moon-rain.js
              radar.js
              file-volume-2.js.map
              delete.js
              arrow-up-from-dot.js
              circle-dot.js.map
              flashlight.js.map
              square-dot.js.map
              music.js
              git-pull-request-closed.js.map
              grape.js.map
              rows-2.js.map
              volume-1.js
              shield-check.js
              more-vertical.js
              sidebar.js.map
              square-mouse-pointer.js
              asterisk-square.js
              rows-3.js.map
              barcode.js
              dice-2.js.map
              tower-control.js
              keyboard-off.js.map
              verified.js.map
              hard-drive.js.map
              message-square-share.js.map
              arrow-right-left.js
              chevron-down-square.js
              badge-plus.js.map
              align-start-vertical.js.map
              arrow-big-right.js
              scissors-square-dashed-bottom.js.map
              list-end.js
              receipt-swiss-franc.js
              paint-bucket.js.map
              mouse-pointer.js
              camera-off.js.map
              school.js
              pi-square.js
              notebook-pen.js
              square-chevron-right.js.map
              square-arrow-up-left.js
              syringe.js.map
              tablet.js
              boom-box.js
              link-2-off.js
              user-round.js.map
              layers-3.js
              user-round-check.js.map
              square-pen.js.map
              popsicle.js.map
              pilcrow-square.js
              ticket-slash.js.map
              file-cog.js.map
              reply.js.map
              align-start-horizontal.js.map
              sparkle.js
              book-text.js.map
              keyboard-music.js.map
              scan.js
              rotate-cw-square.js.map
              zap.js.map
              scale-3-d.js
              sliders-horizontal.js
              log-out.js
              menu.js.map
              loader-pinwheel.js
              scan-face.js.map
              nut.js
              files.js
              package-check.js
              bluetooth.js
              chevrons-down-up.js.map
              thumbs-down.js.map
              donut.js.map
              fullscreen.js.map
              circle-minus.js
              memory-stick.js
              square-kanban.js
              arrow-big-up.js.map
              dice-4.js
              flag-off.js
              gavel.js.map
              wallet-cards.js.map
              file-sliders.js
              messages-square.js.map
              arrow-down-0-1.js
              train-front.js.map
              bug.js
              git-commit-vertical.js
              layout-panel-left.js.map
              folder-archive.js.map
              grab.js.map
              pentagon.js
              award.js.map
              chevrons-down-up.js
              brush.js.map
              bean-off.js.map
              square-arrow-up.js.map
              arrow-down-wide-narrow.js.map
              navigation-2-off.js.map
              speaker.js
              umbrella.js.map
              area-chart.js
              sandwich.js.map
              signal-medium.js.map
              book-marked.js.map
              unfold-vertical.js.map
              goal.js.map
              layout-panel-left.js
              test-tube-diagonal.js
              dumbbell.js
              brain-circuit.js.map
              user-round-search.js
              anchor.js.map
              book-audio.js
              pocket-knife.js
              square-arrow-up.js
              bot-off.js.map
              calendar-plus-2.js.map
              layout-list.js
              locate.js.map
              ice-cream-bowl.js.map
              rainbow.js
              sword.js.map
              warehouse.js
              meh.js.map
              key.js
              square-dashed-mouse-pointer.js
              laptop.js.map
              loader.js.map
              trending-down.js
              message-circle-question.js.map
              book-a.js.map
              circle-pause.js.map
              tv.js.map
              reply-all.js
              disc-2.js
              line-chart.js
              gantt-chart-square.js.map
              split-square-vertical.js.map
              panel-bottom-inactive.js
              send-horizonal.js.map
              users-round.js.map
              helping-hand.js.map
              bar-chart.js
              file-json.js.map
              shield-x.js.map
              minus.js.map
              pause.js
              file-heart.js
              message-circle-reply.js
              trash.js.map
              file-box.js
              book-up.js
              git-branch-plus.js
              alarm-plus.js.map
              panels-top-left.js
              dumbbell.js.map
              file-heart.js.map
              compass.js.map
              triangle.js
              bookmark-minus.js.map
              bed-single.js
              utensils.js.map
              list-filter.js.map
              message-circle-x.js
              square-chevron-up.js.map
              function-square.js.map
              arrow-big-right.js.map
              sigma-square.js
              component.js.map
              chevron-first.js.map
              air-vent.js
              battery-full.js.map
              cigarette-off.js
              power.js
              shield-half.js.map
              case-lower.js
              signal-high.js
              dna.js.map
              drama.js
              rectangle-vertical.js
              panel-right-inactive.js
              tablet-smartphone.js
              rocket.js.map
              stars.js
              heater.js.map
              pencil-line.js.map
              folder-git-2.js
              lock-keyhole-open.js.map
              handshake.js.map
              cloud-fog.js
              frame.js
              share.js.map
              folder-kanban.js
              lamp-desk.js.map
              scan.js.map
              equal-square.js.map
              align-end-horizontal.js.map
              wand-2.js.map
              unplug.js.map
              lamp-wall-down.js.map
              wallet-2.js.map
              folder-down.js
              folder-output.js.map
              unfold-horizontal.js
              calculator.js.map
              edit-3.js.map
              import.js
              diamond-plus.js
              badge-pound-sterling.js.map
              popsicle.js
              ear.js.map
              shopping-cart.js.map
              arrow-right.js.map
              slack.js.map
              receipt-text.js.map
              turtle.js.map
              phone-incoming.js
              angry.js
              wheat-off.js.map
              badge-indian-rupee.js.map
              square-pi.js
              milestone.js
              brush.js
              notebook-text.js
              phone-call.js
              bookmark-minus.js
              square-menu.js.map
              wallpaper.js.map
              package-open.js
              chevron-up-square.js.map
              wine-off.js.map
              usb.js
              cloud-drizzle.js.map
              notebook-tabs.js
              diameter.js
              shower-head.js.map
              arrow-up-0-1.js.map
              donut.js
              file-badge.js
              bath.js.map
              origami.js.map
              square-asterisk.js.map
              bot.js.map
              list-music.js
              list-todo.js
              clock-1.js.map
              settings.js.map
              message-square-warning.js
              credit-card.js
              clock-5.js
              album.js
              scan-line.js.map
              alarm-clock.js.map
              command.js
              backpack.js
              folder-archive.js
              lamp.js
              tablet-smartphone.js.map
              arrow-down-up.js
              columns-4.js
              message-square-more.js
              wallet.js.map
              mail-warning.js
              divide-square.js.map
              align-start-vertical.js
              voicemail.js
              cloud-lightning.js.map
              file-plus.js
              rotate-3d.js
              tally-1.js.map
              diff.js
              scan-text.js
              network.js.map
              pill.js
              scale.js.map
              minimize.js.map
              circle-divide.js.map
              brain-cog.js.map
              utensils-crossed.js
              pc-case.js
              user-round-minus.js.map
              folder-closed.js.map
              circle-off.js.map
              waypoints.js.map
              flag-triangle-right.js
              ampersand.js
              pi-square.js.map
              arrow-up-01.js.map
              circle-plus.js.map
              pyramid.js
              bluetooth-off.js.map
              box-select.js.map
              soup.js.map
              code-square.js
              apple.js
              heading-6.js
              folder-input.js.map
              file-output.js.map
              club.js
              step-forward.js
              file-check-2.js.map
              pointer-off.js
              file-volume.js
              battery-charging.js
              screen-share.js.map
              cloud-cog.js.map
              smile-plus.js.map
              popcorn.js
              log-in.js
              bold.js
              book-user.js.map
              variable.js
              hdmi-port.js.map
              server.js.map
              align-vertical-space-around.js.map
              square-dashed-bottom.js.map
              square-library.js.map
              graduation-cap.js
              workflow.js
              between-vertical-end.js
              cylinder.js
              spell-check-2.js
              fullscreen.js
              package-plus.js
              drafting-compass.js.map
              calendar-days.js
              screen-share.js
              hard-hat.js.map
              copy.js
              download.js.map
              diff.js.map
              spell-check.js.map
              ham.js.map
              mountain-snow.js
              clock-3.js
              droplets.js.map
            shared/
      any-promise/
        package.json
        LICENSE
        loader.js
        register.js
        implementation.d.ts
        .jshintrc
        README.md
        .npmignore
        implementation.js
        optional.js
        index.d.ts
        register-shim.js
        index.js
        register.d.ts
        register/
          vow.d.ts
          lie.js
          bluebird.d.ts
          es6-promise.d.ts
          rsvp.js
          vow.js
          when.js
          q.js
          native-promise-only.js
          when.d.ts
          lie.d.ts
          promise.d.ts
          pinkie.js
          pinkie.d.ts
          es6-promise.js
          native-promise-only.d.ts
          promise.js
          q.d.ts
          rsvp.d.ts
          bluebird.js
      asynckit/
        package.json
        serialOrdered.js
        LICENSE
        stream.js
        README.md
        serial.js
        index.js
        bench.js
        parallel.js
        lib/
          streamify.js
          readable_serial_ordered.js
          defer.js
          readable_asynckit.js
          readable_serial.js
          terminator.js
          readable_parallel.js
          iterate.js
          state.js
          async.js
          abort.js
      vfile/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          minurl.browser.d.ts.map
          minurl.shared.js
          minurl.js
          minproc.d.ts.map
          minpath.d.ts.map
          minpath.browser.d.ts.map
          minproc.js
          minurl.d.ts
          minurl.shared.d.ts
          minproc.browser.d.ts
          minpath.browser.d.ts
          minurl.browser.d.ts
          index.d.ts
          minproc.browser.js
          minpath.d.ts
          minurl.browser.js
          minproc.d.ts
          minpath.js
          minurl.d.ts.map
          index.js
          minproc.browser.d.ts.map
          index.d.ts.map
          minpath.browser.js
          minurl.shared.d.ts.map
      unified/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          callable-instance.js
          callable-instance.d.ts
          index.d.ts
          index.js
          index.d.ts.map
          callable-instance.d.ts.map
        node_modules/
          is-plain-obj/
            package.json
            license
            readme.md
            index.d.ts
            index.js
      goober/
        package.json
        goober.d.ts
        LICENSE
        README.md
        typings.json
        dist/
          goober.esm.js
          goober.cjs
          goober.modern.js
          goober.umd.js
        global/
          package.json
          global.d.ts
          dist/
            goober-global.esm.js
            goober-global.umd.js
            goober-global.modern.js
            goober-global.cjs
          src/
            index.js
            __tests__/
              global.test.js
              integration.test.js
        src/
          styled.js
          css.js
          index.js
          core/
            astish.js
            to-hash.js
            update.js
            hash.js
            compile.js
            parse.js
            get-sheet.js
            __tests__/
              parse.test.js
              compile.test.js
              astish.test.js
              update.test.js
              hash.test.js
              get-sheet.test.js
              to-hash.test.js
          __tests__/
            integrations.test.js
            index.test.js
            css.test.js
            styled.test.js
        should-forward-prop/
          package.json
          should-forward-prop.d.ts
          dist/
            goober-should-forward-prop.esm.js
            goober-should-forward-prop.modern.js
            goober-should-forward-prop.cjs
            goober-should-forward-prop.umd.js
          src/
            index.js
            __tests__/
              shouldForwardProp.js
        prefixer/
          package.json
          README.md
          autoprefixer.d.ts
          dist/
            goober-autoprefixer.umd.js
            goober-autoprefixer.cjs
            goober-autoprefixer.modern.js
            goober-autoprefixer.esm.js
          src/
            index.js
        macro/
          package.json
          index.js
      character-entities-legacy/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      postcss-js/
        package.json
        index.mjs
        process-result.js
        LICENSE
        sync.js
        README.md
        parser.js
        objectifier.js
        index.js
        async.js
      vite/
        index.d.cts
        package.json
        README.md
        client.d.ts
        index.cjs
        LICENSE.md
        dist/
          node/
            constants.js
            types.d-aGj9QkWt.d.ts
            runtime.js
            cli.js
            runtime.d.ts
            index.d.ts
            index.js
            chunks/
              dep-D-7KCb9p.js
              dep-IQS-Za7F.js
              dep-BK3b2jBa.js
              dep-Dnp7gl8U.js
              dep-BB45zftN.js
          client/
            env.mjs
            client.mjs
          node-cjs/
            publicUtils.cjs
        bin/
          vite.js
          openChrome.applescript
        node_modules/
          .bin/
            rollup
          rollup/
            package.json
            README.md
            LICENSE.md
            dist/
              native.js
              rollup.js
              parseAst.d.ts
              parseAst.js
              getLogFilter.d.ts
              loadConfigFile.d.ts
              getLogFilter.js
              rollup.d.ts
              loadConfigFile.js
        types/
          customEvent.d.ts
          package.json
          importMeta.d.ts
          hmrPayload.d.ts
          importGlob.d.ts
          metadata.d.ts
          hot.d.ts
          import-meta.d.ts
      react-hot-toast/
        package.json
        LICENSE
        README.md
        dist/
          index.mjs
          index.js.map
          index.d.ts
          index.js
          index.mjs.map
        headless/
          index.mjs
          index.js.map
          index.d.ts
          index.js
          index.mjs.map
        src/
          index.ts
          core/
            toast.ts
            types.ts
            utils.ts
            store.ts
            use-toaster.ts
          components/
            loader.tsx
            error.tsx
            toast-bar.tsx
            toaster.tsx
            checkmark.tsx
            toast-icon.tsx
          headless/
            index.ts
      pify/
        package.json
        license
        readme.md
        index.js
      escalade/
        package.json
        license
        readme.md
        index.d.ts
        index.d.mts
        dist/
          index.mjs
          index.js
        sync/
          index.mjs
          index.d.ts
          index.js
          index.d.mts
      mdast-util-phrasing/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      @isaacs/
      motion-utils/
        package.json
        LICENSE.md
        dist/
          index.d.ts
          motion-utils.dev.js
          motion-utils.js
          es/
            pipe.mjs
            warn-once.mjs
            index.mjs
            errors.mjs
            is-zero-value-string.mjs
            global-config.mjs
            velocity-per-second.mjs
            time-conversion.mjs
            wrap.mjs
            is-numerical-string.mjs
            subscription-manager.mjs
            array.mjs
            is-object.mjs
            progress.mjs
            clamp.mjs
            memo.mjs
            noop.mjs
            format-error-message.mjs
            easing/
              circ.mjs
              anticipate.mjs
              back.mjs
              steps.mjs
              ease.mjs
              cubic-bezier.mjs
          cjs/
            index.js
      vfile-message/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      es-set-tostringtag/
        CHANGELOG.md
        package.json
        LICENSE
        tsconfig.json
        .nycrc
        README.md
        .eslintrc
        index.d.ts
        index.js
        test/
          index.js
      caniuse-lite/
        package.json
        LICENSE
        README.md
        dist/
          lib/
            supported.js
            statuses.js
          unpacker/
            region.js
            features.js
            browsers.js
            feature.js
            agents.js
            index.js
            browserVersions.js
        data/
          features.js
          browsers.js
          agents.js
          browserVersions.js
          regions/
            QA.js
            EG.js
            GB.js
            CY.js
            AT.js
            PN.js
            NG.js
            LI.js
            NC.js
            IT.js
            KE.js
            BN.js
            HR.js
            CD.js
            SH.js
            MY.js
            AR.js
            SM.js
            GH.js
            GU.js
            DZ.js
            SC.js
            SK.js
            GW.js
            WF.js
            alt-an.js
            MG.js
            NR.js
            AE.js
            JP.js
            SI.js
            MM.js
            AI.js
            BO.js
            MK.js
            ZM.js
            CR.js
            HK.js
            KP.js
            SN.js
            NF.js
            AG.js
            ML.js
            PF.js
            AO.js
            TV.js
            RW.js
            LY.js
            UY.js
            CZ.js
            BS.js
            PL.js
            MU.js
            BW.js
            TH.js
            MO.js
            alt-oc.js
            FO.js
            BD.js
            CA.js
            YE.js
            OM.js
            RU.js
            TL.js
            IE.js
            AS.js
            BJ.js
            DJ.js
            alt-sa.js
            BB.js
            LB.js
            ST.js
            NL.js
            VA.js
            GF.js
            GL.js
            PW.js
            IN.js
            VG.js
            PM.js
            BR.js
            CM.js
            US.js
            SZ.js
            MT.js
            KZ.js
            GY.js
            TM.js
            VE.js
            IM.js
            CK.js
            MN.js
            MS.js
            NI.js
            YT.js
            LC.js
            TD.js
            TO.js
            AM.js
            GN.js
            KW.js
            ZW.js
            JO.js
            CN.js
            IS.js
            IL.js
            alt-as.js
            KY.js
            MW.js
            PH.js
            CH.js
            SO.js
            TW.js
            DK.js
            AW.js
            ME.js
            HU.js
            HN.js
            BF.js
            BH.js
            JM.js
            FI.js
            CF.js
            AZ.js
            MA.js
            DO.js
            SL.js
            KG.js
            UZ.js
            DM.js
            WS.js
            CV.js
            KN.js
            MH.js
            BZ.js
            SV.js
            EC.js
            BI.js
            KM.js
            ER.js
            GT.js
            BM.js
            NO.js
            ZA.js
            NZ.js
            UA.js
            SE.js
            TC.js
            DE.js
            GI.js
            PA.js
            FM.js
            VN.js
            KH.js
            NA.js
            SR.js
            ID.js
            NE.js
            GQ.js
            AF.js
            SB.js
            BA.js
            VU.js
            MC.js
            alt-ww.js
            GR.js
            FJ.js
            alt-eu.js
            VC.js
            PE.js
            MX.js
            alt-af.js
            SY.js
            TG.js
            HT.js
            MD.js
            IQ.js
            EE.js
            LV.js
            TT.js
            MR.js
            TZ.js
            LS.js
            FR.js
            AL.js
            LK.js
            SG.js
            UG.js
            CG.js
            CI.js
            PY.js
            RO.js
            MZ.js
            CO.js
            AD.js
            FK.js
            BG.js
            MQ.js
            AX.js
            KI.js
            JE.js
            SA.js
            GP.js
            CX.js
            AU.js
            PK.js
            GA.js
            PG.js
            alt-na.js
            LR.js
            RS.js
            LA.js
            ES.js
            ET.js
            NU.js
            BY.js
            IR.js
            GM.js
            MP.js
            TN.js
            GG.js
            LT.js
            VI.js
            MV.js
            BT.js
            CL.js
            PR.js
            KR.js
            TR.js
            GE.js
            SD.js
            LU.js
            NP.js
            BE.js
            CU.js
            RE.js
            PS.js
            TJ.js
            PT.js
            GD.js
          features/
            css-env-function.js
            js-regexp-lookbehind.js
            webusb.js
            css-paged-media.js
            css-resize.js
            css-autofill.js
            font-family-system-ui.js
            mdn-css-unicode-bidi-isolate.js
            font-smooth.js
            input-number.js
            arrow-functions.js
            feature-policy.js
            wordwrap.js
            publickeypinning.js
            upgradeinsecurerequests.js
            run-in.js
            vibration.js
            svg-css.js
            flac.js
            intersectionobserver-v2.js
            ac3-ec3.js
            scrollintoviewifneeded.js
            css-canvas.js
            form-submit-attributes.js
            css-matches-pseudo.js
            sql-storage.js
            input-file-multiple.js
            loading-lazy-attr.js
            css-caret-color.js
            brotli.js
            css-marker-pseudo.js
            css-text-orientation.js
            font-variant-numeric.js
            input-pattern.js
            picture-in-picture.js
            background-clip-text.js
            cross-document-view-transitions.js
            css-font-rendering-controls.js
            proxy.js
            dom-manip-convenience.js
            imports.js
            import-maps.js
            push-api.js
            picture.js
            jpegxr.js
            queryselector.js
            menu.js
            css-page-break.js
            css-in-out-of-range.js
            flexbox-gap.js
            webworkers.js
            netinfo.js
            dialog.js
            bloburls.js
            web-share.js
            css-containment.js
            comparedocumentposition.js
            midi.js
            svg-html.js
            urlsearchparams.js
            pad-start-end.js
            shadowdomv1.js
            async-clipboard.js
            do-not-track.js
            viewport-units.js
            wake-lock.js
            css-default-pseudo.js
            wasm-simd.js
            css-font-stretch.js
            css-sticky.js
            meta-theme-color.js
            xhr2.js
            wbr-element.js
            portals.js
            css-opacity.js
            autofocus.js
            readonly-attr.js
            offline-apps.js
            spellcheck-attribute.js
            audio.js
            document-evaluate-xpath.js
            promise-finally.js
            flexbox.js
            maxlength.js
            css-scroll-behavior.js
            link-icon-svg.js
            css-boxdecorationbreak.js
            css3-cursors-newer.js
            es6-number.js
            speech-synthesis.js
            passwordrules.js
            customevent.js
            css-conic-gradients.js
            input-file-directory.js
            insertadjacenthtml.js
            websockets.js
            heif.js
            flow-root.js
            css-table.js
            link-rel-dns-prefetch.js
            es5.js
            wasm-threads.js
            document-currentscript.js
            css-paint-api.js
            css-text-indent.js
            clipboard.js
            wasm-extended-const.js
            srcset.js
            documenthead.js
            web-app-manifest.js
            css-featurequeries.js
            input-range.js
            matchesselector.js
            rellist.js
            custom-elements.js
            internationalization.js
            subresource-integrity.js
            webnfc.js
            css-module-scripts.js
            cors.js
            css-overflow-overlay.js
            rem.js
            webm.js
            pointer-events.js
            iframe-sandbox.js
            svg-html5.js
            form-validation.js
            css-cascade-layers.js
            es6-module-dynamic-import.js
            css-writing-mode.js
            input-datetime.js
            object-entries.js
            text-stroke.js
            audiotracks.js
            wasm-bigint.js
            css-nth-child-of.js
            css-focus-within.js
            webcodecs.js
            wav.js
            nav-timing.js
            css-filters.js
            filereader.js
            filereadersync.js
            keyboardevent-location.js
            kerning-pairs-ligatures.js
            hardwareconcurrency.js
            video.js
            chacha20-poly1305.js
            indexeddb2.js
            let.js
            canvas.js
            background-img-opts.js
            progress.js
            dragndrop.js
            currentcolor.js
            tabindex-attr.js
            zstd.js
            datauri.js
            use-strict.js
            es6-class.js
            console-basic.js
            text-decoration.js
            css-descendant-gtgt.js
            mdn-text-decoration-color.js
            css3-colors.js
            setimmediate.js
            stream.js
            css-variables.js
            css-fixed.js
            scrollintoview.js
            css-motion-paths.js
            html5semantic.js
            keyboardevent-charcode.js
            innertext.js
            css-relative-colors.js
            css-image-orientation.js
            justify-content-space-evenly.js
            classlist.js
            css-touch-action.js
            link-rel-preconnect.js
            css-zoom.js
            link-rel-prerender.js
            css-exclusions.js
            resizeobserver.js
            eme.js
            permissions-policy.js
            text-overflow.js
            css-selection.js
            download.js
            getrandomvalues.js
            alternate-stylesheet.js
            minmaxwh.js
            css-when-else.js
            background-position-x-y.js
            css-first-line.js
            css-read-only-write.js
            sdch.js
            link-rel-modulepreload.js
            server-timing.js
            mdn-css-unicode-bidi-isolate-override.js
            hevc.js
            webp.js
            transforms3d.js
            screen-orientation.js
            css-media-scripting.js
            typedarrays.js
            async-functions.js
            webkit-user-drag.js
            dommatrix.js
            touch.js
            textcontent.js
            css-unset-value.js
            user-timing.js
            history.js
            input-search.js
            asmjs.js
            css-snappoints.js
            broadcastchannel.js
            orientation-sensor.js
            css-case-insensitive.js
            childnode-remove.js
            css-cross-fade.js
            text-emphasis.js
            multibackgrounds.js
            css3-tabsize.js
            css-content-visibility.js
            wasm.js
            cookie-store-api.js
            webxr.js
            css-reflections.js
            dispatchevent.js
            link-rel-preload.js
            css-line-clamp.js
            mdn-text-decoration-shorthand.js
            deviceorientation.js
            path2d.js
            html-media-capture.js
            input-minlength.js
            pdf-viewer.js
            selection-api.js
            font-feature.js
            form-attribute.js
            css-masks.js
            mutationobserver.js
            css-logical-props.js
            input-file-accept.js
            css-placeholder.js
            serviceworkers.js
            input-autocomplete-onoff.js
            word-break.js
            payment-request.js
            sni.js
            high-resolution-time.js
            tls1-2.js
            css-overscroll-behavior.js
            rest-parameters.js
            input-inputmode.js
            css-hanging-punctuation.js
            streams.js
            document-execcommand.js
            link-icon-png.js
            gamepad.js
            colr.js
            json.js
            forms.js
            keyboardevent-getmodifierstate.js
            intrinsic-width.js
            svg.js
            blobbuilder.js
            css-container-queries-style.js
            objectrtc.js
            indeterminate-checkbox.js
            array-includes.js
            bigint.js
            css-rrggbbaa.js
            css-scrollbar.js
            contenteditable.js
            css-filter-function.js
            wasm-reference-types.js
            css-supports-api.js
            namevalue-storage.js
            css-gradients.js
            outline.js
            array-find-index.js
            style-scoped.js
            css-overflow.js
            css-backgroundblendmode.js
            page-transition-events.js
            xhtml.js
            css-crisp-edges.js
            object-observe.js
            lazyload.js
            mutation-events.js
            multicolumn.js
            avif.js
            css-text-spacing.js
            domcontentloaded.js
            array-find.js
            mdn-css-unicode-bidi-plaintext.js
            css-text-justify.js
            wasm-bulk-memory.js
            css-textshadow.js
            webtransport.js
            css-backdrop-filter.js
            css-sel3.js
            css-print-color-adjust.js
            ogg-vorbis.js
            client-hints-dpr-width-viewport.js
            fieldset-disabled.js
            css-text-box-trim.js
            css-boxshadow.js
            background-sync.js
            mdn-text-decoration-style.js
            x-frame-options.js
            requestidlecallback.js
            css3-attr.js
            css3-cursors-grab.js
            css-if.js
            media-fragments.js
            fileapi.js
            element-closest.js
            will-change.js
            svg-fragment.js
            css-revert-value.js
            indexeddb.js
            u2f.js
            auxclick.js
            css-shapes.js
            webgl2.js
            selectlist.js
            webgl.js
            hidden.js
            http-live-streaming.js
            ch-unit.js
            referrer-policy.js
            css-all.js
            temporal.js
            wasm-multi-memory.js
            eot.js
            object-values.js
            createimagebitmap.js
            keyboardevent-code.js
            const.js
            input-selection.js
            mediasource.js
            pointer.js
            wasm-mutable-globals.js
            inline-block.js
            css-container-query-units.js
            dom-range.js
            background-attachment.js
            mpeg-dash.js
            viewport-unit-variants.js
            input-event.js
            css-anchor-positioning.js
            date-tolocaledatestring.js
            webauthn.js
            css-any-link.js
            wasm-tail-calls.js
            getboundingclientrect.js
            css-unicode-bidi.js
            datalist.js
            fontface.js
            font-loading.js
            input-email-tel-url.js
            css-regions.js
            transforms2d.js
            css-indeterminate-pseudo.js
            notifications.js
            web-animation.js
            css-mediaqueries.js
            css-letter-spacing.js
            mediarecorder.js
            credential-management.js
            svg-smil.js
            css-media-interaction.js
            once-event-listener.js
            textencoder.js
            font-size-adjust.js
            web-bluetooth.js
            meter.js
            prefers-reduced-motion.js
            border-radius.js
            ping.js
            dnssec.js
            cryptography.js
            declarative-shadow-dom.js
            rel-noreferrer.js
            channel-messaging.js
            link-rel-prefetch.js
            wasm-nontrapping-fptoint.js
            pointerlock.js
            passkeys.js
            dataset.js
            webhid.js
            ttf.js
            css-appearance.js
            css-clip-path.js
            script-defer.js
            iframe-seamless.js
            opus.js
            svg-img.js
            web-serial.js
            sxg.js
            spdy.js
            rtcpeerconnection.js
            imagecapture.js
            array-flat.js
            magnetometer.js
            intersectionobserver.js
            css-color-function.js
            trusted-types.js
            font-variant-alternates.js
            jpeg2000.js
            woff2.js
            getcomputedstyle.js
            filesystem.js
            css-background-offsets.js
            keyboardevent-which.js
            details.js
            url-scroll-to-text-fragment.js
            jpegxl.js
            object-fit.js
            css-grid-animation.js
            ogv.js
            av1.js
            pagevisibility.js
            fetch.js
            es6-string-includes.js
            webvtt.js
            css-grid.js
            passive-event-listener.js
            css-container-queries.js
            css-cascade-scope.js
            battery-status.js
            css-has.js
            ruby.js
            getelementsbyclassname.js
            css-font-palette.js
            devicepixelratio.js
            input-placeholder.js
            variable-fonts.js
            document-scrollingelement.js
            view-transitions.js
            online-status.js
            script-async.js
            img-naturalwidth-naturalheight.js
            css-placeholder-shown.js
            mathml.js
            mdn-text-decoration-line.js
            font-kerning.js
            border-image.js
            css-media-range-syntax.js
            aac.js
            wasm-gc.js
            extended-system-fonts.js
            audio-api.js
            css-color-adjust.js
            eventsource.js
            beforeafterprint.js
            css-display-contents.js
            wasm-multi-value.js
            shadowdom.js
            css-math-functions.js
            localecompare.js
            beacon.js
            user-select-none.js
            custom-elementsv1.js
            permissions-api.js
            css-widows-orphans.js
            tls1-1.js
            css-optional-pseudo.js
            rel-noopener.js
            css3-boxsizing.js
            videotracks.js
            wasm-relaxed-simd.js
            accelerometer.js
            css-media-resolution.js
            text-size-adjust.js
            es6-generators.js
            xhtmlsmil.js
            iframe-srcdoc.js
            es6.js
            insert-adjacent.js
            css3-cursors.js
            css-nesting.js
            calc.js
            css-image-set.js
            css-width-stretch.js
            wasm-signext.js
            css-lch-lab.js
            template-literals.js
            css-overflow-anchor.js
            css-repeating-gradients.js
            addeventlistener.js
            hashchange.js
            focusin-focusout-events.js
            http3.js
            keyboardevent-key.js
            css-animation.js
            css-rebeccapurple.js
            ol-reversed.js
            webgpu.js
            css-hyphens.js
            same-site-cookie-attribute.js
            css-at-counter-style.js
            proximity.js
            css-namespaces.js
            native-filesystem-api.js
            promises.js
            font-unicode-range.js
            svg-filters.js
            css-transitions.js
            svg-fonts.js
            console-time.js
            es6-module.js
            webvr.js
            css-dir-pseudo.js
            gyroscope.js
            stricttransportsecurity.js
            unhandledrejection.js
            mediacapture-fromelement.js
            geolocation.js
            x-doc-messaging.js
            css-not-sel-list.js
            atob-btoa.js
            constraint-validation.js
            css-initial-letter.js
            prefers-color-scheme.js
            url.js
            xml-serializer.js
            subresource-bundling.js
            template.js
            css-gencontent.js
            css-subgrid.js
            css-text-wrap-balance.js
            css-counters.js
            sharedworkers.js
            css-deviceadaptation.js
            png-alpha.js
            speech-recognition.js
            css-file-selector-button.js
            vector-effect.js
            css-first-letter.js
            css-initial-value.js
            background-repeat-round-space.js
            canvas-blending.js
            offscreencanvas.js
            css-sel2.js
            canvas-text.js
            intl-pluralrules.js
            requestanimationframe.js
            abortcontroller.js
            mp3.js
            contentsecuritypolicy2.js
            tls1-3.js
            apng.js
            http2.js
            resource-timing.js
            matchmedia.js
            css-element-function.js
            wai-aria.js
            woff.js
            colr-v1.js
            element-scroll-methods.js
            registerprotocolhandler.js
            element-from-point.js
            input-color.js
            ime.js
            document-policy.js
            mpeg4.js
            ambient-light.js
            testfeat.js
            css-mixblendmode.js
            mdn-css-backdrop-pseudo-element.js
            sharedarraybuffer.js
            css-focus-visible.js
            decorators.js
            contentsecuritypolicy.js
            fullscreen.js
            css-text-align-last.js
      dequal/
        package.json
        license
        readme.md
        index.d.ts
        dist/
          index.mjs
          index.min.js
          index.js
        lite/
          index.mjs
          index.min.js
          index.d.ts
          index.js
      cssesc/
        package.json
        cssesc.js
        LICENSE-MIT.txt
        README.md
        man/
          cssesc.1
        bin/
          cssesc
      nanoid/
        index.d.cts
        package.json
        LICENSE
        README.md
        index.browser.js
        index.d.ts
        index.browser.cjs
        index.js
        nanoid.js
        index.cjs
        url-alphabet/
          package.json
          index.js
          index.cjs
        bin/
          nanoid.cjs
        async/
          package.json
          index.native.js
          index.browser.js
          index.d.ts
          index.browser.cjs
          index.js
          index.cjs
        non-secure/
          package.json
          index.d.ts
          index.js
          index.cjs
      follow-redirects/
        package.json
        LICENSE
        README.md
        http.js
        debug.js
        https.js
        index.js
      postcss-import/
        package.json
        LICENSE
        README.md
        index.js
        lib/
          load-content.js
          join-media.js
          assign-layer-names.js
          process-content.js
          resolve-id.js
          parse-statements.js
          data-url.js
          join-layer.js
      glob-parent/
        package.json
        LICENSE
        README.md
        index.js
      @types/
        node/
          http2.d.ts
          path.d.ts
          package.json
          https.d.ts
          child_process.d.ts
          zlib.d.ts
          inspector.d.ts
          process.d.ts
          test.d.ts
          os.d.ts
          domain.d.ts
          stream.d.ts
          v8.d.ts
          url.d.ts
          http.d.ts
          LICENSE
          util.d.ts
          string_decoder.d.ts
          diagnostics_channel.d.ts
          querystring.d.ts
          crypto.d.ts
          module.d.ts
          README.md
          dns.d.ts
          dgram.d.ts
          fs.d.ts
          punycode.d.ts
          globals.typedarray.d.ts
          sqlite.d.ts
          constants.d.ts
          console.d.ts
          readline.d.ts
          events.d.ts
          sea.d.ts
          index.d.ts
          buffer.buffer.d.ts
          cluster.d.ts
          worker_threads.d.ts
          inspector.generated.d.ts
          assert.d.ts
          trace_events.d.ts
          tty.d.ts
          async_hooks.d.ts
          vm.d.ts
          timers.d.ts
          wasi.d.ts
          tls.d.ts
          globals.d.ts
          net.d.ts
          buffer.d.ts
          perf_hooks.d.ts
          repl.d.ts
          compatibility/
            iterators.d.ts
          stream/
            consumers.d.ts
            promises.d.ts
            web.d.ts
          assert/
            strict.d.ts
          web-globals/
            streams.d.ts
            crypto.d.ts
            fetch.d.ts
            events.d.ts
            storage.d.ts
            abortcontroller.d.ts
            navigator.d.ts
            domexception.d.ts
          fs/
            promises.d.ts
          dns/
            promises.d.ts
          readline/
            promises.d.ts
          ts5.6/
            globals.typedarray.d.ts
            index.d.ts
            buffer.buffer.d.ts
            compatibility/
              float16array.d.ts
          timers/
            promises.d.ts
          ts5.7/
            index.d.ts
            compatibility/
              float16array.d.ts
        estree/
          package.json
          flow.d.ts
          LICENSE
          README.md
          index.d.ts
        estree-jsx/
          package.json
          LICENSE
          README.md
          index.d.ts
        ms/
          package.json
          LICENSE
          README.md
          index.d.ts
        babel__generator/
          package.json
          LICENSE
          README.md
          index.d.ts
        babel__template/
          package.json
          LICENSE
          README.md
          index.d.ts
        mdast/
          package.json
          LICENSE
          README.md
          index.d.ts
        trusted-types/
          package.json
          LICENSE
          README.md
          index.d.ts
          lib/
            index.d.ts
        unist/
          package.json
          LICENSE
          README.md
          index.d.ts
        hast/
          package.json
          LICENSE
          README.md
          index.d.ts
        babel__core/
          package.json
          LICENSE
          README.md
          index.d.ts
        babel__traverse/
          package.json
          LICENSE
          README.md
          index.d.ts
        react/
          package.json
          experimental.d.ts
          compiler-runtime.d.ts
          LICENSE
          jsx-dev-runtime.d.ts
          README.md
          jsx-runtime.d.ts
          global.d.ts
          index.d.ts
          canary.d.ts
          ts5.0/
            experimental.d.ts
            jsx-dev-runtime.d.ts
            jsx-runtime.d.ts
            global.d.ts
            index.d.ts
            canary.d.ts
        debug/
          package.json
          LICENSE
          README.md
          index.d.ts
      trim-lines/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      motion-dom/
        package.json
        LICENSE.md
        dist/
          size-rollup-style-effect.js
          motion-dom.dev.js
          motion-dom.js
          index.d.ts
          size-rollup-motion-value.js
          es/
            index.mjs
            view/
              queue.mjs
              index.mjs
              start.mjs
            stats/
              animation-count.mjs
              index.mjs
              buffer.mjs
            render/
            effects/
              MotionValueState.mjs
            value/
              index.mjs
              subscribe-value.mjs
              transform-value.mjs
              map-value.mjs
              spring-value.mjs
            animation/
              NativeAnimation.mjs
              AsyncMotionValueAnimation.mjs
              NativeAnimationWrapper.mjs
              NativeAnimationExtended.mjs
              GroupAnimationWithThen.mjs
              JSAnimation.mjs
              GroupAnimation.mjs
            utils/
              resolve-elements.mjs
              is-svg-svg-element.mjs
              stagger.mjs
              is-svg-element.mjs
              interpolate.mjs
              transform.mjs
              is-html-element.mjs
            frameloop/
              index-legacy.mjs
              order.mjs
              frame.mjs
              sync-time.mjs
              microtask.mjs
              render-step.mjs
              batcher.mjs
            scroll/
              observe.mjs
            gestures/
              hover.mjs
            resize/
              index.mjs
              handle-window.mjs
              handle-element.mjs
          cjs/
            index.js
      devlop/
        package.json
        license
        readme.md
        lib/
          development.d.ts
          development.js
          default.js
      @fontsource/
        vazirmatn/
          CHANGELOG.md
          arabic-900.css
          latin-500.css
          package.json
          100.css
          arabic-400.css
          unicode.json
          900.css
          arabic-300.css
          LICENSE
          latin-ext-600.css
          latin-ext.css
          arabic-800.css
          latin-ext-900.css
          latin-400.css
          arabic-100.css
          metadata.json
          README.md
          latin-900.css
          latin-ext-200.css
          300.css
          latin-800.css
          800.css
          latin-ext-700.css
          arabic-700.css
          latin-ext-300.css
          200.css
          latin-700.css
          700.css
          500.css
          index.css
          latin.css
          latin-300.css
          arabic-200.css
          latin-ext-800.css
          400.css
          latin-ext-500.css
          600.css
          arabic-600.css
          latin-ext-400.css
          arabic.css
          latin-200.css
          arabic-500.css
          latin-100.css
          latin-600.css
          latin-ext-100.css
          files/
            vazirmatn-arabic-900-normal.woff
            vazirmatn-arabic-800-normal.woff
            vazirmatn-latin-200-normal.woff
            vazirmatn-latin-100-normal.woff2
            vazirmatn-latin-ext-800-normal.woff
            vazirmatn-latin-500-normal.woff
            vazirmatn-latin-ext-200-normal.woff2
            vazirmatn-latin-800-normal.woff2
            vazirmatn-arabic-800-normal.woff2
            vazirmatn-latin-900-normal.woff
            vazirmatn-latin-ext-200-normal.woff
            vazirmatn-arabic-400-normal.woff
            vazirmatn-latin-ext-900-normal.woff2
            vazirmatn-latin-400-normal.woff
            vazirmatn-latin-ext-700-normal.woff
            vazirmatn-latin-100-normal.woff
            vazirmatn-arabic-900-normal.woff2
            vazirmatn-arabic-400-normal.woff2
            vazirmatn-arabic-500-normal.woff
            vazirmatn-latin-ext-500-normal.woff2
            vazirmatn-latin-ext-700-normal.woff2
            vazirmatn-arabic-700-normal.woff
            vazirmatn-latin-ext-400-normal.woff
            vazirmatn-latin-ext-600-normal.woff
            vazirmatn-arabic-100-normal.woff2
            vazirmatn-arabic-600-normal.woff
            vazirmatn-arabic-300-normal.woff2
            vazirmatn-arabic-600-normal.woff2
            vazirmatn-latin-600-normal.woff2
            vazirmatn-latin-300-normal.woff2
            vazirmatn-latin-300-normal.woff
            vazirmatn-latin-ext-100-normal.woff
            vazirmatn-latin-900-normal.woff2
            vazirmatn-latin-ext-500-normal.woff
            vazirmatn-latin-ext-800-normal.woff2
            vazirmatn-latin-700-normal.woff2
            vazirmatn-latin-500-normal.woff2
            vazirmatn-latin-ext-600-normal.woff2
            vazirmatn-arabic-300-normal.woff
            vazirmatn-latin-200-normal.woff2
            vazirmatn-arabic-700-normal.woff2
            vazirmatn-arabic-200-normal.woff2
            vazirmatn-latin-700-normal.woff
            vazirmatn-arabic-200-normal.woff
            vazirmatn-arabic-100-normal.woff
            vazirmatn-latin-800-normal.woff
            vazirmatn-arabic-500-normal.woff2
            vazirmatn-latin-ext-400-normal.woff2
            vazirmatn-latin-400-normal.woff2
            vazirmatn-latin-ext-100-normal.woff2
            vazirmatn-latin-ext-300-normal.woff
            vazirmatn-latin-ext-300-normal.woff2
            vazirmatn-latin-ext-900-normal.woff
            vazirmatn-latin-600-normal.woff
          scss/
            mixins.scss
            metadata.scss
        inter/
          CHANGELOG.md
          greek-ext-400.css
          cyrillic-ext-italic.css
          latin-500.css
          package.json
          cyrillic-ext-400.css
          100.css
          cyrillic-ext-600.css
          latin-ext-italic.css
          unicode.json
          vietnamese-italic.css
          cyrillic-900.css
          greek-ext-800-italic.css
          vietnamese-400-italic.css
          latin-ext-500-italic.css
          100-italic.css
          300-italic.css
          greek-ext-600.css
          900.css
          latin-ext-400-italic.css
          vietnamese-800.css
          vietnamese-300-italic.css
          greek-ext-600-italic.css
          greek-ext-200.css
          greek-400-italic.css
          greek-200.css
          vietnamese-100-italic.css
          cyrillic.css
          greek-900.css
          LICENSE
          vietnamese-700.css
          cyrillic-ext-800-italic.css
          latin-ext-600.css
          latin-ext-200-italic.css
          cyrillic-ext-400-italic.css
          latin-ext.css
          vietnamese-500-italic.css
          latin-700-italic.css
          greek-100-italic.css
          vietnamese-900.css
          latin-ext-900.css
          greek-400.css
          cyrillic-800-italic.css
          latin-400.css
          greek-100.css
          greek-ext-700.css
          vietnamese-200.css
          cyrillic-900-italic.css
          cyrillic-500-italic.css
          greek-ext-900.css
          cyrillic-700.css
          greek-ext-500-italic.css
          vietnamese-600.css
          greek-500-italic.css
          latin-200-italic.css
          cyrillic-ext.css
          vietnamese-600-italic.css
          latin-ext-700-italic.css
          900-italic.css
          cyrillic-ext-200-italic.css
          metadata.json
          README.md
          latin-900.css
          greek-ext-400-italic.css
          greek-ext.css
          latin-ext-200.css
          300.css
          greek-600-italic.css
          greek-ext-100-italic.css
          latin-800.css
          greek-ext-900-italic.css
          500-italic.css
          cyrillic-300.css
          cyrillic-600.css
          vietnamese-700-italic.css
          latin-900-italic.css
          700-italic.css
          cyrillic-200-italic.css
          latin-ext-800-italic.css
          800.css
          cyrillic-ext-800.css
          latin-300-italic.css
          cyrillic-ext-100-italic.css
          cyrillic-ext-300.css
          cyrillic-ext-900-italic.css
          latin-100-italic.css
          latin-600-italic.css
          greek-ext-300.css
          cyrillic-italic.css
          greek-700.css
          latin-400-italic.css
          latin-ext-700.css
          cyrillic-100.css
          greek-700-italic.css
          cyrillic-ext-200.css
          latin-ext-300.css
          600-italic.css
          cyrillic-ext-600-italic.css
          200.css
          latin-ext-100-italic.css
          vietnamese.css
          latin-700.css
          cyrillic-ext-900.css
          700.css
          cyrillic-ext-100.css
          200-italic.css
          500.css
          greek-ext-300-italic.css
          index.css
          cyrillic-500.css
          vietnamese-300.css
          greek.css
          greek-ext-200-italic.css
          greek-ext-italic.css
          cyrillic-600-italic.css
          cyrillic-300-italic.css
          latin-italic.css
          latin-500-italic.css
          800-italic.css
          vietnamese-800-italic.css
          latin.css
          cyrillic-700-italic.css
          latin-300.css
          cyrillic-800.css
          cyrillic-400-italic.css
          greek-ext-800.css
          latin-ext-600-italic.css
          greek-500.css
          greek-italic.css
          cyrillic-ext-300-italic.css
          latin-ext-800.css
          400.css
          vietnamese-900-italic.css
          cyrillic-ext-500.css
          greek-300-italic.css
          latin-800-italic.css
          latin-ext-500.css
          vietnamese-100.css
          cyrillic-200.css
          600.css
          latin-ext-400.css
          greek-200-italic.css
          cyrillic-ext-700.css
          greek-900-italic.css
          greek-800-italic.css
          greek-600.css
          400-italic.css
          greek-300.css
          greek-800.css
          vietnamese-500.css
          vietnamese-200-italic.css
          greek-ext-500.css
          cyrillic-400.css
          cyrillic-ext-500-italic.css
          latin-200.css
          latin-100.css
          greek-ext-700-italic.css
          vietnamese-400.css
          greek-ext-100.css
          cyrillic-ext-700-italic.css
          latin-ext-300-italic.css
          cyrillic-100-italic.css
          latin-ext-900-italic.css
          latin-600.css
          latin-ext-100.css
          files/
            inter-greek-ext-900-normal.woff
            inter-cyrillic-ext-800-italic.woff
            inter-latin-600-normal.woff2
            inter-cyrillic-ext-600-normal.woff2
            inter-greek-ext-900-italic.woff
            inter-cyrillic-200-italic.woff
            inter-cyrillic-800-italic.woff2
            inter-cyrillic-600-normal.woff
            inter-greek-ext-300-italic.woff
            inter-latin-ext-800-normal.woff
            inter-vietnamese-200-italic.woff2
            inter-cyrillic-ext-800-normal.woff
            inter-vietnamese-800-italic.woff
            inter-latin-600-italic.woff2
            inter-cyrillic-700-italic.woff2
            inter-cyrillic-ext-300-italic.woff2
            inter-cyrillic-400-italic.woff2
            inter-cyrillic-ext-200-italic.woff2
            inter-latin-800-normal.woff
            inter-latin-200-italic.woff
            inter-cyrillic-ext-100-italic.woff2
            inter-greek-ext-800-italic.woff
            inter-greek-ext-500-normal.woff2
            inter-greek-ext-800-italic.woff2
            inter-latin-500-italic.woff
            inter-latin-900-normal.woff
            inter-cyrillic-ext-500-normal.woff2
            inter-cyrillic-400-normal.woff2
            inter-greek-ext-200-italic.woff2
            inter-latin-400-normal.woff
            inter-vietnamese-300-italic.woff
            inter-latin-300-italic.woff2
            inter-greek-ext-200-italic.woff
            inter-latin-600-italic.woff
            inter-latin-ext-300-normal.woff
            inter-cyrillic-ext-300-normal.woff
            inter-cyrillic-300-normal.woff
            inter-latin-ext-500-italic.woff2
            inter-latin-100-normal.woff2
            inter-vietnamese-700-italic.woff2
            inter-cyrillic-400-normal.woff
            inter-cyrillic-100-italic.woff2
            inter-greek-300-normal.woff2
            inter-greek-ext-700-italic.woff2
            inter-vietnamese-900-italic.woff2
            inter-vietnamese-100-italic.woff2
            inter-greek-ext-100-italic.woff
            inter-latin-200-italic.woff2
            inter-latin-500-italic.woff2
            inter-latin-900-italic.woff2
            inter-greek-800-normal.woff
            inter-latin-ext-100-italic.woff
            inter-latin-300-italic.woff
            inter-vietnamese-400-normal.woff
            inter-vietnamese-600-normal.woff2
            inter-latin-400-italic.woff2
            inter-vietnamese-100-normal.woff2
            inter-greek-ext-300-normal.woff
            inter-latin-ext-700-italic.woff2
            inter-vietnamese-600-italic.woff2
            inter-cyrillic-600-italic.woff2
            inter-cyrillic-ext-800-italic.woff2
            inter-greek-ext-900-italic.woff2
            inter-latin-ext-400-normal.woff2
            inter-latin-ext-900-italic.woff
            inter-vietnamese-200-italic.woff
            inter-cyrillic-700-normal.woff
            inter-cyrillic-ext-900-normal.woff
            inter-latin-ext-500-italic.woff
            inter-latin-100-italic.woff
            inter-latin-ext-300-italic.woff2
            inter-latin-ext-200-italic.woff2
            inter-latin-300-normal.woff
            inter-greek-ext-200-normal.woff2
            inter-vietnamese-300-italic.woff2
            inter-latin-700-italic.woff
            inter-cyrillic-600-italic.woff
            inter-cyrillic-ext-600-italic.woff
            inter-greek-200-normal.woff
            inter-greek-100-normal.woff2
            inter-cyrillic-ext-500-normal.woff
            inter-greek-ext-400-normal.woff
            inter-latin-300-normal.woff2
            inter-latin-ext-700-italic.woff
            inter-cyrillic-ext-400-normal.woff
            inter-latin-900-italic.woff
            inter-latin-ext-700-normal.woff
            inter-latin-100-normal.woff
            inter-greek-700-normal.woff
            inter-latin-ext-400-italic.woff2
            inter-greek-400-normal.woff
            inter-greek-400-normal.woff2
            inter-latin-ext-900-normal.woff
            inter-latin-800-italic.woff
            inter-greek-ext-400-normal.woff2
            inter-cyrillic-ext-600-normal.woff
            inter-vietnamese-500-italic.woff2
            inter-greek-ext-600-italic.woff2
            inter-vietnamese-200-normal.woff
            inter-vietnamese-500-normal.woff
            inter-cyrillic-ext-300-italic.woff
            inter-greek-700-italic.woff
            inter-cyrillic-900-italic.woff
            inter-latin-800-italic.woff2
            inter-latin-ext-500-normal.woff
            inter-latin-ext-300-normal.woff2
            inter-greek-900-italic.woff2
            inter-cyrillic-ext-900-normal.woff2
            inter-cyrillic-ext-900-italic.woff2
            inter-latin-900-normal.woff2
            inter-greek-400-italic.woff2
            inter-cyrillic-400-italic.woff
            inter-cyrillic-500-normal.woff2
            inter-greek-200-normal.woff2
            inter-cyrillic-900-normal.woff2
            inter-cyrillic-100-normal.woff
            inter-latin-ext-100-italic.woff2
            inter-greek-800-normal.woff2
            inter-cyrillic-ext-500-italic.woff
            inter-latin-400-italic.woff
            inter-greek-ext-800-normal.woff2
            inter-cyrillic-700-italic.woff
            inter-cyrillic-200-italic.woff2
            inter-cyrillic-ext-600-italic.woff2
            inter-greek-100-normal.woff
            inter-vietnamese-800-normal.woff
            inter-greek-500-normal.woff
            inter-cyrillic-100-normal.woff2
            inter-vietnamese-400-italic.woff2
            inter-cyrillic-ext-700-normal.woff
            inter-vietnamese-500-normal.woff2
            inter-cyrillic-ext-800-normal.woff2
            inter-vietnamese-600-normal.woff
            inter-cyrillic-ext-100-italic.woff
            inter-vietnamese-900-normal.woff2
            inter-greek-700-italic.woff2
            inter-greek-400-italic.woff
            inter-vietnamese-700-normal.woff
            inter-cyrillic-500-italic.woff
            inter-cyrillic-ext-100-normal.woff2
            inter-latin-500-normal.woff2
            inter-latin-200-normal.woff
            inter-cyrillic-500-normal.woff
            inter-latin-ext-800-normal.woff2
            inter-greek-700-normal.woff2
            inter-latin-ext-200-normal.woff
            inter-greek-500-italic.woff2
            inter-vietnamese-400-normal.woff2
            inter-greek-ext-100-italic.woff2
            inter-cyrillic-900-normal.woff
            inter-greek-ext-300-italic.woff2
            inter-greek-900-normal.woff
            inter-cyrillic-ext-400-italic.woff
            inter-greek-ext-900-normal.woff2
            inter-vietnamese-700-normal.woff2
            inter-cyrillic-600-normal.woff2
            inter-cyrillic-ext-200-italic.woff
            inter-cyrillic-800-italic.woff
            inter-greek-300-italic.woff
            inter-latin-ext-200-italic.woff
            inter-cyrillic-ext-900-italic.woff
            inter-greek-ext-500-italic.woff
            inter-latin-700-italic.woff2
            inter-latin-100-italic.woff2
            inter-latin-ext-100-normal.woff
            inter-greek-200-italic.woff2
            inter-cyrillic-ext-400-normal.woff2
            inter-greek-600-italic.woff
            inter-latin-ext-900-normal.woff2
            inter-greek-500-italic.woff
            inter-cyrillic-ext-100-normal.woff
            inter-cyrillic-900-italic.woff2
            inter-vietnamese-300-normal.woff
            inter-cyrillic-ext-400-italic.woff2
            inter-vietnamese-200-normal.woff2
            inter-cyrillic-ext-500-italic.woff2
            inter-latin-ext-400-italic.woff
            inter-greek-ext-500-normal.woff
            inter-vietnamese-600-italic.woff
            inter-cyrillic-ext-700-normal.woff2
            inter-cyrillic-ext-200-normal.woff2
            inter-vietnamese-900-italic.woff
            inter-greek-300-normal.woff
            inter-greek-ext-700-normal.woff2
            inter-vietnamese-400-italic.woff
            inter-latin-ext-200-normal.woff2
            inter-cyrillic-ext-200-normal.woff
            inter-greek-ext-400-italic.woff2
            inter-cyrillic-200-normal.woff2
            inter-latin-800-normal.woff2
            inter-latin-700-normal.woff2
            inter-greek-600-normal.woff
            inter-vietnamese-300-normal.woff2
            inter-latin-600-normal.woff
            inter-vietnamese-700-italic.woff
            inter-latin-ext-800-italic.woff2
            inter-cyrillic-700-normal.woff2
            inter-greek-ext-100-normal.woff
            inter-greek-ext-800-normal.woff
            inter-latin-ext-700-normal.woff2
            inter-latin-ext-900-italic.woff2
            inter-greek-800-italic.woff
            inter-cyrillic-ext-700-italic.woff
            inter-greek-900-italic.woff
            inter-latin-ext-300-italic.woff
            inter-cyrillic-500-italic.woff2
            inter-latin-ext-800-italic.woff
            inter-latin-ext-100-normal.woff2
            inter-greek-ext-300-normal.woff2
            inter-cyrillic-800-normal.woff2
            inter-latin-ext-600-normal.woff2
            inter-greek-ext-600-italic.woff
            inter-greek-500-normal.woff2
            inter-greek-100-italic.woff2
            inter-latin-700-normal.woff
            inter-latin-400-normal.woff2
            inter-greek-100-italic.woff
            inter-cyrillic-ext-300-normal.woff2
            inter-greek-200-italic.woff
            inter-vietnamese-500-italic.woff
            inter-cyrillic-ext-700-italic.woff2
            inter-cyrillic-300-italic.woff
            inter-vietnamese-900-normal.woff
            inter-greek-300-italic.woff2
            inter-latin-200-normal.woff2
            inter-greek-ext-700-italic.woff
            inter-latin-ext-600-normal.woff
            inter-cyrillic-200-normal.woff
            inter-latin-500-normal.woff
            inter-greek-ext-100-normal.woff2
            inter-vietnamese-800-normal.woff2
            inter-greek-600-normal.woff2
            inter-greek-ext-400-italic.woff
            inter-cyrillic-100-italic.woff
            inter-cyrillic-300-italic.woff2
            inter-vietnamese-800-italic.woff2
            inter-latin-ext-500-normal.woff2
            inter-greek-ext-500-italic.woff2
            inter-cyrillic-300-normal.woff2
            inter-latin-ext-400-normal.woff
            inter-cyrillic-800-normal.woff
            inter-greek-ext-600-normal.woff
            inter-greek-ext-600-normal.woff2
            inter-greek-ext-700-normal.woff
            inter-greek-600-italic.woff2
            inter-greek-ext-200-normal.woff
            inter-latin-ext-600-italic.woff2
            inter-greek-900-normal.woff2
            inter-vietnamese-100-italic.woff
            inter-vietnamese-100-normal.woff
            inter-latin-ext-600-italic.woff
            inter-greek-800-italic.woff2
          scss/
            mixins.scss
            metadata.scss
      supports-preserve-symlinks-flag/
        browser.js
        CHANGELOG.md
        package.json
        LICENSE
        .nycrc
        README.md
        .eslintrc
        index.js
        test/
          index.js
        .github/
          FUNDING.yml
      @vitejs/
        plugin-react/
          package.json
          LICENSE
          README.md
          dist/
            index.d.cts
            refresh-runtime.js
            index.d.ts
            index.js
            index.cjs
          node_modules/
            react-refresh/
              babel.js
              package.json
              LICENSE
              README.md
              runtime.js
      remark-rehype/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      @esbuild/
        linux-x64/
          package.json
          README.md
          bin/
            esbuild
      is-number/
        package.json
        LICENSE
        README.md
        index.js
      micromark-util-decode-string/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      thenify-all/
        package.json
        LICENSE
        README.md
        History.md
        index.js
      hasown/
        CHANGELOG.md
        package.json
        LICENSE
        tsconfig.json
        .nycrc
        README.md
        .eslintrc
        index.d.ts
        index.js
        .github/
          FUNDING.yml
      fill-range/
        package.json
        LICENSE
        README.md
        index.js
      tslib/
        package.json
        SECURITY.md
        tslib.html
        CopyrightNotice.txt
        README.md
        tslib.js
        tslib.es6.js
        tslib.es6.html
        LICENSE.txt
        tslib.d.ts
        tslib.es6.mjs
        modules/
          package.json
          index.d.ts
          index.js
      mdast-util-to-hast/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          revert.d.ts.map
          state.d.ts.map
          state.d.ts
          revert.d.ts
          footer.d.ts
          footer.js
          revert.js
          index.d.ts
          state.js
          index.js
          index.d.ts.map
          footer.d.ts.map
          handlers/
            table-row.d.ts.map
            inline-code.d.ts.map
            root.d.ts.map
            inline-code.js
            table-cell.d.ts
            link-reference.d.ts
            list.d.ts.map
            thematic-break.d.ts.map
            table.js
            table-cell.js
            link.d.ts.map
            delete.d.ts
            html.d.ts.map
            text.js
            thematic-break.d.ts
            emphasis.d.ts.map
            heading.js
            table.d.ts.map
            delete.d.ts.map
            table-row.d.ts
            image.d.ts
            link.d.ts
            code.js
            blockquote.d.ts.map
            code.d.ts
            strong.js
            paragraph.js
            html.d.ts
            footnote-reference.js
            html.js
            list-item.d.ts
            footnote-reference.d.ts
            table.d.ts
            root.d.ts
            heading.d.ts
            strong.d.ts.map
            paragraph.d.ts.map
            image.d.ts.map
            list.d.ts
            link.js
            emphasis.d.ts
            list-item.d.ts.map
            table-cell.d.ts.map
            footnote-reference.d.ts.map
            image-reference.js
            blockquote.js
            root.js
            strong.d.ts
            image-reference.d.ts
            index.d.ts
            image.js
            paragraph.d.ts
            text.d.ts
            blockquote.d.ts
            text.d.ts.map
            link-reference.d.ts.map
            index.js
            break.d.ts
            index.d.ts.map
            code.d.ts.map
            emphasis.js
            list.js
            break.js
            delete.js
            thematic-break.js
            break.d.ts.map
            link-reference.js
            table-row.js
            image-reference.d.ts.map
            inline-code.d.ts
            list-item.js
            heading.d.ts.map
      didyoumean/
        package.json
        didYouMean-1.2.1.min.js
        LICENSE
        didYouMean-1.2.1.js
        README.md
      proxy-from-env/
        package.json
        LICENSE
        README.md
        .eslintrc
        test.js
        .travis.yml
        index.js
      get-intrinsic/
        CHANGELOG.md
        package.json
        LICENSE
        .nycrc
        README.md
        .eslintrc
        index.js
        test/
          GetIntrinsic.js
        .github/
          FUNDING.yml
      micromark-util-decode-numeric-character-reference/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      character-entities-html4/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      acorn/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        dist/
          acorn.d.mts
          bin.js
          acorn.js
          acorn.d.ts
          acorn.mjs
        bin/
          acorn
      source-map-js/
        package.json
        LICENSE
        README.md
        source-map.js
        source-map.d.ts
        lib/
          source-map-generator.js
          source-node.d.ts
          source-node.js
          source-map-consumer.d.ts
          source-map-generator.d.ts
          base64-vlq.js
          array-set.js
          base64.js
          source-map-consumer.js
          quick-sort.js
          binary-search.js
          util.js
          mapping-list.js
      hast-util-whitespace/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      braces/
        package.json
        LICENSE
        README.md
        index.js
        lib/
          utils.js
          constants.js
          stringify.js
          expand.js
          compile.js
          parse.js
      postcss/
        package.json
        LICENSE
        README.md
        lib/
          css-syntax-error.js
          warning.d.ts
          no-work-result.d.ts
          input.js
          at-rule.js
          warn-once.js
          document.d.ts
          stringifier.js
          processor.js
          rule.d.ts
          result.d.ts
          rule.js
          lazy-result.js
          stringify.js
          result.js
          no-work-result.js
          symbols.js
          lazy-result.d.ts
          processor.d.ts
          comment.d.ts
          container.js
          node.d.ts
          node.js
          declaration.js
          root.d.ts
          parser.js
          postcss.d.mts
          stringifier.d.ts
          map-generator.js
          declaration.d.ts
          list.d.ts
          fromJSON.js
          parse.d.ts
          css-syntax-error.d.ts
          postcss.js
          root.js
          input.d.ts
          fromJSON.d.ts
          document.js
          at-rule.d.ts
          postcss.d.ts
          terminal-highlight.js
          warning.js
          list.js
          tokenize.js
          comment.js
          container.d.ts
          postcss.mjs
          previous-map.d.ts
          stringify.d.ts
          parse.js
          previous-map.js
      ccount/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      arg/
        package.json
        README.md
        index.d.ts
        index.js
        LICENSE.md
      is-extglob/
        package.json
        LICENSE
        README.md
        index.js
      bail/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      es-errors/
        range.js
        ref.js
        CHANGELOG.md
        package.json
        type.d.ts
        ref.d.ts
        type.js
        LICENSE
        tsconfig.json
        README.md
        .eslintrc
        syntax.d.ts
        eval.js
        syntax.js
        index.d.ts
        uri.d.ts
        uri.js
        index.js
        range.d.ts
        eval.d.ts
        test/
          index.js
        .github/
          FUNDING.yml
      micromark-util-subtokenize/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          splice-buffer.d.ts.map
          splice-buffer.d.ts
          splice-buffer.js
        dev/
          index.d.ts
          index.js
          index.d.ts.map
          lib/
            splice-buffer.d.ts.map
            splice-buffer.d.ts
            splice-buffer.js
      undici-types/
        errors.d.ts
        package.json
        formdata.d.ts
        snapshot-agent.d.ts
        dispatcher.d.ts
        utility.d.ts
        patch.d.ts
        handlers.d.ts
        mock-call-history.d.ts
        connector.d.ts
        client-stats.d.ts
        h2c-client.d.ts
        header.d.ts
        diagnostics-channel.d.ts
        LICENSE
        cookies.d.ts
        util.d.ts
        mock-errors.d.ts
        websocket.d.ts
        global-dispatcher.d.ts
        mock-client.d.ts
        balanced-pool.d.ts
        README.md
        fetch.d.ts
        mock-pool.d.ts
        content-type.d.ts
        cache.d.ts
        pool-stats.d.ts
        webidl.d.ts
        pool.d.ts
        proxy-agent.d.ts
        readable.d.ts
        global-origin.d.ts
        retry-handler.d.ts
        api.d.ts
        index.d.ts
        mock-agent.d.ts
        interceptors.d.ts
        client.d.ts
        env-http-proxy-agent.d.ts
        cache-interceptor.d.ts
        mock-interceptor.d.ts
        retry-agent.d.ts
        eventsource.d.ts
        agent.d.ts
      react/
        package.json
        LICENSE
        react.shared-subset.js
        jsx-dev-runtime.js
        README.md
        jsx-runtime.js
        index.js
        umd/
          react.production.min.js
          react.profiling.min.js
          react.development.js
        cjs/
          react-jsx-runtime.profiling.min.js
          react.production.min.js
          react-jsx-dev-runtime.profiling.min.js
          react-jsx-runtime.development.js
          react.shared-subset.development.js
          react-jsx-dev-runtime.production.min.js
          react.shared-subset.production.min.js
          react-jsx-dev-runtime.development.js
          react-jsx-runtime.production.min.js
          react.development.js
      mdast-util-find-and-replace/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        lib/
          index.d.ts
          index.js
          index.d.ts.map
      esbuild/
        package.json
        install.js
        README.md
        LICENSE.md
        lib/
          main.js
          main.d.ts
        bin/
          esbuild
      mime-db/
        package.json
        db.json
        LICENSE
        README.md
        index.js
        HISTORY.md
      micromark-util-character/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      micromark-util-encode/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
      sucrase/
        package.json
        LICENSE
        README.md
        dist/
          NameManager.js
          Options.js
          Options-gen-types.js
          TokenProcessor.js
          CJSImportProcessor.js
          identifyShadowedGlobals.js
          register.js
          cli.js
          HelperManager.js
          computeSourceMap.js
          index.js
          parser/
            index.js
            traverser/
              expression.js
              lval.js
              util.js
              base.js
              statement.js
              index.js
            util/
              whitespace.js
              charcodes.js
              identifier.js
            tokenizer/
              readWord.js
              types.js
              state.js
              index.js
              readWordTree.js
              keywords.js
            plugins/
              typescript.js
              flow.js
              types.js
          util/
            getDeclarationInfo.js
            getIdentifierNames.js
            formatTokens.js
            getClassInfo.js
            shouldElideDefaultExport.js
            getNonTypeIdentifiers.js
            getJSXPragmaInfo.js
            removeMaybeImportAttributes.js
            elideImportEquals.js
            getTSImportedNames.js
            isExportFrom.js
            getImportExportSpecifierInfo.js
            isAsyncOperation.js
            isIdentifier.js
          transformers/
            ESMImportTransformer.js
            JSXTransformer.js
            RootTransformer.js
            FlowTransformer.js
            ReactHotLoaderTransformer.js
            OptionalChainingNullishTransformer.js
            JestHoistTransformer.js
            ReactDisplayNameTransformer.js
            Transformer.js
            CJSImportTransformer.js
            TypeScriptTransformer.js
            OptionalCatchBindingTransformer.js
            NumericSeparatorTransformer.js
          types/
            cli.d.ts
            identifyShadowedGlobals.d.ts
            Options-gen-types.d.ts
            Options.d.ts
            CJSImportProcessor.d.ts
            index.d.ts
            TokenProcessor.d.ts
            HelperManager.d.ts
            register.d.ts
            computeSourceMap.d.ts
            NameManager.d.ts
            parser/
              index.d.ts
            util/
              getIdentifierNames.d.ts
              isIdentifier.d.ts
              getNonTypeIdentifiers.d.ts
              getJSXPragmaInfo.d.ts
              isAsyncOperation.d.ts
              removeMaybeImportAttributes.d.ts
              getImportExportSpecifierInfo.d.ts
              getClassInfo.d.ts
              getTSImportedNames.d.ts
              shouldElideDefaultExport.d.ts
              getDeclarationInfo.d.ts
              elideImportEquals.d.ts
              isExportFrom.d.ts
              formatTokens.d.ts
            transformers/
              Transformer.d.ts
              ESMImportTransformer.d.ts
              JSXTransformer.d.ts
              OptionalChainingNullishTransformer.d.ts
              FlowTransformer.d.ts
              ReactHotLoaderTransformer.d.ts
              JestHoistTransformer.d.ts
              RootTransformer.d.ts
              NumericSeparatorTransformer.d.ts
              ReactDisplayNameTransformer.d.ts
              TypeScriptTransformer.d.ts
              OptionalCatchBindingTransformer.d.ts
              CJSImportTransformer.d.ts
          esm/
            NameManager.js
            Options.js
            Options-gen-types.js
            TokenProcessor.js
            CJSImportProcessor.js
            identifyShadowedGlobals.js
            register.js
            cli.js
            HelperManager.js
            computeSourceMap.js
            index.js
            parser/
              index.js
            util/
              getDeclarationInfo.js
              getIdentifierNames.js
              formatTokens.js
              getClassInfo.js
              shouldElideDefaultExport.js
              getNonTypeIdentifiers.js
              getJSXPragmaInfo.js
              removeMaybeImportAttributes.js
              elideImportEquals.js
              getTSImportedNames.js
              isExportFrom.js
              getImportExportSpecifierInfo.js
              isAsyncOperation.js
              isIdentifier.js
            transformers/
              ESMImportTransformer.js
              JSXTransformer.js
              RootTransformer.js
              FlowTransformer.js
              ReactHotLoaderTransformer.js
              OptionalChainingNullishTransformer.js
              JestHoistTransformer.js
              ReactDisplayNameTransformer.js
              Transformer.js
              CJSImportTransformer.js
              TypeScriptTransformer.js
              OptionalCatchBindingTransformer.js
              NumericSeparatorTransformer.js
        bin/
          sucrase-node
          sucrase
        ts-node-plugin/
          index.js
        register/
          js.js
          tsx-legacy-module-interop.js
          ts-legacy-module-interop.js
          tsx.js
          ts.js
          jsx.js
          index.js
      queue-microtask/
        package.json
        LICENSE
        README.md
        index.d.ts
        index.js
      @jridgewell/
        gen-mapping/
          package.json
          LICENSE
          README.md
          dist/
            gen-mapping.mjs.map
            gen-mapping.umd.js
            gen-mapping.mjs
            gen-mapping.umd.js.map
            types/
              sourcemap-segment.d.ts
              set-array.d.ts
              types.d.ts
              gen-mapping.d.ts
          src/
            set-array.ts
            types.ts
            gen-mapping.ts
            sourcemap-segment.ts
          types/
            sourcemap-segment.d.mts
            types.d.cts
            sourcemap-segment.d.mts.map
            types.d.mts
            sourcemap-segment.d.cts.map
            types.d.cts.map
            gen-mapping.d.cts.map
            set-array.d.mts.map
            gen-mapping.d.mts
            gen-mapping.d.cts
            gen-mapping.d.mts.map
            set-array.d.mts
            types.d.mts.map
            set-array.d.cts
            set-array.d.cts.map
            sourcemap-segment.d.cts
        resolve-uri/
          package.json
          LICENSE
          README.md
          dist/
            resolve-uri.mjs
            resolve-uri.umd.js.map
            resolve-uri.umd.js
            resolve-uri.mjs.map
            types/
              resolve-uri.d.ts
        sourcemap-codec/
          package.json
          LICENSE
          README.md
          dist/
            sourcemap-codec.mjs.map
            sourcemap-codec.mjs
            sourcemap-codec.umd.js
            sourcemap-codec.umd.js.map
          src/
            vlq.ts
            scopes.ts
            sourcemap-codec.ts
            strings.ts
          types/
            sourcemap-codec.d.cts.map
            scopes.d.mts
            strings.d.cts.map
            vlq.d.cts
            scopes.d.cts
            strings.d.cts
            strings.d.mts
            vlq.d.mts
            strings.d.mts.map
            vlq.d.mts.map
            sourcemap-codec.d.mts.map
            scopes.d.cts.map
            scopes.d.mts.map
            vlq.d.cts.map
            sourcemap-codec.d.mts
            sourcemap-codec.d.cts
        trace-mapping/
          package.json
          LICENSE
          README.md
          dist/
            trace-mapping.umd.js
            trace-mapping.mjs
            trace-mapping.mjs.map
            trace-mapping.umd.js.map
          src/
            binary-search.ts
            by-source.ts
            strip-filename.ts
            sort.ts
            resolve.ts
            types.ts
            sourcemap-segment.ts
            trace-mapping.ts
            flatten-map.ts
          types/
            by-source.d.mts
            strip-filename.d.mts
            sort.d.cts
            sourcemap-segment.d.mts
            by-source.d.cts.map
            types.d.cts
            resolve.d.cts
            sourcemap-segment.d.mts.map
            types.d.mts
            flatten-map.d.cts.map
            flatten-map.d.mts.map
            trace-mapping.d.mts.map
            sort.d.mts
            sourcemap-segment.d.cts.map
            resolve.d.cts.map
            resolve.d.mts.map
            types.d.cts.map
            trace-mapping.d.mts
            by-source.d.mts.map
            binary-search.d.cts.map
            flatten-map.d.mts
            strip-filename.d.mts.map
            by-source.d.cts
            resolve.d.mts
            strip-filename.d.cts.map
            binary-search.d.mts.map
            binary-search.d.cts
            sort.d.cts.map
            trace-mapping.d.cts
            flatten-map.d.cts
            binary-search.d.mts
            trace-mapping.d.cts.map
            types.d.mts.map
            sort.d.mts.map
            strip-filename.d.cts
            sourcemap-segment.d.cts
        source-map/
          package.json
          LICENSE
          README.md
          dist/
            source-map.umd.js.map
            source-map.mjs.map
            source-map.umd.js
            source-map.mjs
          src/
            source-map.ts
          types/
            source-map.d.cts.map
            source-map.d.cts
            source-map.d.mts.map
            source-map.d.mts
        remapping/
          package.json
          LICENSE
          README.md
          dist/
            remapping.umd.js
            remapping.umd.js.map
            remapping.mjs
            remapping.mjs.map
          src/
            source-map-tree.ts
            build-source-map-tree.ts
            types.ts
            remapping.ts
            source-map.ts
          types/
            source-map-tree.d.cts.map
            source-map.d.cts.map
            types.d.cts
            remapping.d.cts
            types.d.mts
            types.d.cts.map
            remapping.d.mts.map
            source-map.d.cts
            source-map-tree.d.mts
            source-map-tree.d.cts
            source-map-tree.d.mts.map
            build-source-map-tree.d.cts.map
            build-source-map-tree.d.cts
            remapping.d.cts.map
            remapping.d.mts
            source-map.d.mts.map
            types.d.mts.map
            source-map.d.mts
            build-source-map-tree.d.mts.map
            build-source-map-tree.d.mts
      space-separated-tokens/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      debug/
        package.json
        LICENSE
        README.md
        src/
          browser.js
          node.js
          common.js
          index.js
      lru-cache/
        package.json
        LICENSE
        README.md
        index.js
      tinyglobby/
        package.json
        LICENSE
        README.md
        dist/
          index.d.cts
          index.mjs
          index.cjs
          index.d.mts
        node_modules/
          picomatch/
            package.json
            LICENSE
            posix.js
            README.md
            index.js
            lib/
              utils.js
              constants.js
              picomatch.js
              scan.js
              parse.js
          fdir/
            package.json
            LICENSE
            README.md
            dist/
              index.d.cts
              index.mjs
              index.cjs
              index.d.mts
      micromark-extension-gfm-autolink-literal/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          html.d.ts
          html.js
          syntax.d.ts
          syntax.js
        dev/
          index.d.ts
          index.js
          lib/
            html.d.ts
            html.js
            syntax.d.ts
            syntax.js
      micromark-factory-label/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        index.d.ts.map
        dev/
          index.d.ts
          index.js
          index.d.ts.map
      micromark-extension-gfm-table/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          html.d.ts.map
          edit-map.js
          edit-map.d.ts
          infer.d.ts
          html.d.ts
          html.js
          syntax.d.ts
          infer.d.ts.map
          edit-map.d.ts.map
          syntax.js
          syntax.d.ts.map
          infer.js
        dev/
          index.d.ts
          index.js
          lib/
            html.d.ts.map
            edit-map.js
            edit-map.d.ts
            infer.d.ts
            html.d.ts
            html.js
            syntax.d.ts
            infer.d.ts.map
            edit-map.d.ts.map
            syntax.js
            syntax.d.ts.map
            infer.js
      comma-separated-tokens/
        package.json
        license
        readme.md
        index.d.ts
        index.js
      mdast-util-to-string/
        package.json
        license
        readme.md
        index.d.ts
        index.js
        lib/
          index.d.ts
          index.js
      call-bind-apply-helpers/
        applyBind.d.ts
        CHANGELOG.md
        package.json
        applyBind.js
        LICENSE
        tsconfig.json
        .nycrc
        reflectApply.js
        README.md
        .eslintrc
        functionCall.js
        index.d.ts
        functionCall.d.ts
        functionApply.js
        actualApply.d.ts
        index.js
        actualApply.js
        functionApply.d.ts
        reflectApply.d.ts
        test/
          index.js
        .github/
          FUNDING.yml
      marked/
        package.json
        marked.min.js
        README.md
        LICENSE.md
        lib/
          marked.cjs
          marked.umd.js
          marked.cjs.map
          marked.esm.js
          marked.d.ts
          marked.d.cts
          marked.esm.js.map
          marked.umd.js.map
        man/
          marked.1.md
          marked.1
        bin/
          main.js
          marked.js
      source-map-support/
        package.json
        register.js
        README.md
        browser-source-map-support.js
        source-map-support.js
        register-hook-require.js
        LICENSE.md
        node_modules/
          source-map/
            CHANGELOG.md
            package.json
            LICENSE
            README.md
            source-map.js
            source-map.d.ts
            dist/
              source-map.min.js
              source-map.min.js.map
              source-map.debug.js
              source-map.js
            lib/
              source-map-generator.js
              source-node.js
              base64-vlq.js
              array-set.js
              base64.js
              source-map-consumer.js
              quick-sort.js
              binary-search.js
              util.js
              mapping-list.js
      style-to-object/
        package.json
        LICENSE
        README.md
        dist/
          style-to-object.js.map
          style-to-object.js
          style-to-object.min.js
          style-to-object.min.js.map
        cjs/
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
        src/
          index.ts
        esm/
          index.mjs
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
          index.mjs.map
      cookie/
        package.json
        LICENSE
        README.md
        dist/
          index.js.map
          index.d.ts
          index.js
    src/
      main.jsx
      index.css.bak_1766770218
      index.css
      App.jsx
      index.css.bak_20251227_062826
      pages/
        auth/
        Auth/
        dashboard/
          DashboardPage.jsx
        comparator/
          CodeComparatorPage.jsx.bak_20251231_145434
          CodeComparatorPage.jsx
        landing/
          LandingPage.jsx
          LanguageSelect.jsx
        Compare/
        Landing/
        compare/
          CodeComparatorPage.jsx
        generator/
          GeneratorPage.jsx.bak_20251231_161246
          GeneratorPage.jsx
          GeneratorPage.jsx.bak_20251231_162546
        chat/
          ChatPage.jsx
      context/
        AuthContext.jsx
        LanguageContext.jsx
        ThemeContext.jsx
        hooks/
      assets/
      components/
        ProtectedRoute.jsx
        ui/
          CopyButton.jsx
          MarkdownBox.jsx.bak_20251225_110541
          MarkdownBox.jsx
          CodeCompareBox.jsx
          Tooltip.jsx
          HelpTip.jsx
          MarkdownRenderer.jsx
          CodeBlock.jsx
          Modal.jsx
          MarkdownView.jsx
          SectionedMarkdown.jsx
          BottomDrawer.jsx
          LoadingSpinner.jsx
          ToolResult.jsx
          WarningBox.jsx
        error/
          ErrorAnalyzerModal.jsx
          ErrorAnalyzerDrawer.jsx
        modals/
          WelcomeModal.jsx
          LanguageSelectModal.jsx
          ErrorAnalyzerModal.jsx
          AuthModal.jsx
          RoleSelectModal.jsx
        popup/
        shared/
        generator/
          KnowledgeSelector.jsx
          GeneratorForm.jsx
          ErrorHelper.jsx
          ModeSelector.jsx
        layout/
          Header.jsx
          Footer.jsx
          MainLayout.jsx
      styles/
        global.css
      hooks/
        useAppView.jsx
        useAuth.js
        useLanguage.js
      utils/
        validators.js
        formatter.js
        storage.js
      api/
        api.js
      config/
        app.js
        api.js
      services/
        authService.js
        aiService.js
        aiService.js.bak_20251225_110017
        userService.js
  server/
    aiRouter_DISABLED.js
    models/
      User.js
      Usage.js
      SavedScript.js
    auth/
    core/
      errors.js
      planConfig.js
      ccgError.js
      response.js
    utils/
      aiClient.js
      chatStore.js
      formatter.js
      promptBuilder.js
      outputFormatter.js
      promptTransformer.js
      aiClient.js.bak_20251231_150937
    middleware/
      optionalAuth.js
      usageLimit.js
      checkLimits.js
      checkAuth.j
      saveLimit.js
      auth.js
      ccgNormalize.js
      domainGuard.js.bak_20251231_152829
      domainGuard.js.bak_20251231_153325
      errorHandler.js
      ccgDebug.js
      domainGuard.js
    logs/
    routes/
      profileRoutes.js
      ccgRoutes.js
      authRoutes.js
      ccgRoutes.js.bak_20251231_152829
      chatRoutes.js
      scripts.js
      ccgRoutes.js.bak_20251231_161753
      ccgRoutes.js.bak_20251231_161246
      ccgRoutes.js.bak_20251231_145434
      googleAuthRoutes.js
    config/
      planConfig.js
  .github/
    workflows/
      release.yml
  node_modules/
    .package-lock.json
    unpipe/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    is-stream/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    execa/
      package.json
      license
      readme.md
      index.d.ts
      index.js
      lib/
        stream.js
        stdio.js
        error.js
        kill.js
        promise.js
        command.js
      node_modules/
        signal-exit/
          package.json
          signals.js
          README.md
          LICENSE.txt
          index.js
    json-schema-typed/
      package.json
      draft_07.js
      README.md
      draft_2020_12.js
      draft_07.d.ts
      draft_2019_09.d.ts
      draft_2019_09.js
      LICENSE.md
      draft_2020_12.d.ts
    punycode/
      package.json
      LICENSE-MIT.txt
      README.md
      punycode.js
      punycode.es6.js
    onetime/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    oauth/
      package.json
      Readme.md
      LICENSE
      index.js
      lib/
        oauth2.js
        oauth.js
        _utils.js
        sha1.js
    finalhandler/
      package.json
      SECURITY.md
      LICENSE
      README.md
      index.js
      HISTORY.md
      node_modules/
        ms/
          package.json
          license.md
          readme.md
          index.js
        debug/
          CHANGELOG.md
          package.json
          component.json
          Makefile
          LICENSE
          node.js
          README.md
          .npmignore
          .eslintrc
          karma.conf.js
          .travis.yml
          .coveralls.yml
          src/
            browser.js
            node.js
            debug.js
            index.js
            inspector-log.js
    sparse-bitfield/
      package.json
      LICENSE
      README.md
      .npmignore
      test.js
      .travis.yml
      index.js
    es-object-atoms/
      RequireObjectCoercible.d.ts
      CHANGELOG.md
      package.json
      ToObject.js
      LICENSE
      tsconfig.json
      isObject.js
      README.md
      .eslintrc
      RequireObjectCoercible.js
      ToObject.d.ts
      index.d.ts
      index.js
      isObject.d.ts
      test/
        index.js
      .github/
        FUNDING.yml
    is-core-module/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      core.json
      index.js
      test/
        index.js
    setprototypeof/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
      test/
        index.js
    debounce-fn/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    get-caller-file/
      package.json
      README.md
      index.js.map
      index.d.ts
      index.js
      LICENSE.md
    cross-env/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      src/
        is-windows.js
        index.js
        command.js
        variable.js
        bin/
          cross-env.js
          cross-env-shell.js
    fast-glob/
      package.json
      LICENSE
      README.md
      out/
        settings.js
        settings.d.ts
        index.d.ts
        index.js
        readers/
          stream.d.ts
          reader.d.ts
          stream.js
          sync.js
          sync.d.ts
          async.d.ts
          reader.js
          async.js
        utils/
          path.d.ts
          stream.d.ts
          pattern.d.ts
          array.js
          stream.js
          errno.js
          path.js
          pattern.js
          fs.d.ts
          array.d.ts
          errno.d.ts
          index.d.ts
          string.d.ts
          index.js
          string.js
          fs.js
        types/
          index.d.ts
          index.js
        providers/
          provider.js
          stream.d.ts
          stream.js
          sync.js
          provider.d.ts
          sync.d.ts
          async.d.ts
          async.js
          filters/
            entry.js
            error.js
            deep.d.ts
            deep.js
            entry.d.ts
            error.d.ts
          matchers/
            partial.d.ts
            matcher.d.ts
            partial.js
            matcher.js
          transformers/
            entry.js
            entry.d.ts
        managers/
          tasks.d.ts
          tasks.js
    ajv/
      package.json
      .runkit_example.js
      LICENSE
      README.md
      dist/
        2020.js.map
        core.js
        2019.js
        ajv.d.ts
        2020.d.ts
        2020.js
        jtd.d.ts
        ajv.js
        core.js.map
        core.d.ts
        2019.d.ts
        jtd.js
        2019.js.map
        jtd.js.map
        ajv.js.map
        standalone/
          instance.js
          instance.d.ts
          index.js.map
          instance.js.map
          index.d.ts
          index.js
        refs/
          json-schema-draft-06.json
          jtd-schema.js
          json-schema-secure.json
          data.json
          jtd-schema.js.map
          jtd-schema.d.ts
          json-schema-draft-07.json
          json-schema-2019-09/
            schema.json
            index.js.map
            index.d.ts
            index.js
            meta/
              meta-data.json
              validation.json
              applicator.json
              core.json
              content.json
              format.json
          json-schema-2020-12/
            schema.json
            index.js.map
            index.d.ts
            index.js
            meta/
              unevaluated.json
              meta-data.json
              validation.json
              applicator.json
              core.json
              format-annotation.json
              content.json
        runtime/
          equal.js.map
          re2.js
          parseJson.js.map
          validation_error.js.map
          validation_error.d.ts
          equal.d.ts
          ucs2length.d.ts
          quote.js
          parseJson.d.ts
          quote.js.map
          re2.js.map
          timestamp.d.ts
          timestamp.js
          quote.d.ts
          uri.js.map
          parseJson.js
          ucs2length.js.map
          uri.d.ts
          uri.js
          timestamp.js.map
          equal.js
          re2.d.ts
          ucs2length.js
          validation_error.js
        compile/
          errors.d.ts
          errors.js
          rules.d.ts
          ref_error.js.map
          names.js
          util.js.map
          util.d.ts
          resolve.d.ts
          resolve.js.map
          ref_error.d.ts
          util.js
          index.js.map
          index.d.ts
          ref_error.js
          names.js.map
          index.js
          names.d.ts
          errors.js.map
          rules.js.map
          rules.js
          resolve.js
          validate/
            boolSchema.js.map
            dataType.js
            defaults.d.ts
            applicability.js.map
            dataType.js.map
            applicability.d.ts
            applicability.js
            boolSchema.js
            keyword.js
            defaults.js.map
            subschema.d.ts
            index.js.map
            subschema.js
            dataType.d.ts
            index.d.ts
            keyword.d.ts
            index.js
            boolSchema.d.ts
            defaults.js
            keyword.js.map
            subschema.js.map
          codegen/
            scope.js.map
            code.js
            code.d.ts
            scope.d.ts
            index.js.map
            scope.js
            index.d.ts
            code.js.map
            index.js
          jtd/
            types.js.map
            serialize.d.ts
            types.d.ts
            serialize.js
            parse.d.ts
            types.js
            serialize.js.map
            parse.js.map
            parse.js
        vocabularies/
          errors.d.ts
          next.js.map
          errors.js
          draft2020.js.map
          draft7.d.ts
          code.js
          code.d.ts
          next.d.ts
          draft2020.js
          metadata.js
          draft7.js.map
          code.js.map
          metadata.js.map
          errors.js.map
          metadata.d.ts
          next.js
          draft7.js
          draft2020.d.ts
          discriminator/
            types.js.map
            types.d.ts
            index.js.map
            index.d.ts
            types.js
            index.js
          core/
            ref.js
            id.js
            ref.d.ts
            id.js.map
            ref.js.map
            index.js.map
            id.d.ts
            index.d.ts
            index.js
          jtd/
            ref.js
            values.d.ts
            discriminator.d.ts
            nullable.js
            type.js.map
            type.d.ts
            ref.d.ts
            type.js
            discriminator.js
            nullable.d.ts
            properties.d.ts
            error.js
            optionalProperties.js.map
            union.js.map
            values.js
            elements.js.map
            properties.js
            ref.js.map
            enum.js.map
            enum.js
            properties.js.map
            nullable.js.map
            metadata.js
            discriminator.js.map
            optionalProperties.js
            index.js.map
            index.d.ts
            error.js.map
            error.d.ts
            optionalProperties.d.ts
            elements.d.ts
            metadata.js.map
            index.js
            union.d.ts
            metadata.d.ts
            elements.js
            enum.d.ts
            union.js
            values.js.map
          dynamic/
            recursiveRef.js
            recursiveRef.d.ts
            recursiveAnchor.js
            dynamicRef.js
            dynamicAnchor.d.ts
            recursiveAnchor.js.map
            dynamicAnchor.js
            dynamicAnchor.js.map
            dynamicRef.js.map
            recursiveAnchor.d.ts
            index.js.map
            recursiveRef.js.map
            index.d.ts
            index.js
            dynamicRef.d.ts
          unevaluated/
            unevaluatedItems.d.ts
            unevaluatedProperties.js
            unevaluatedProperties.js.map
            unevaluatedItems.js
            index.js.map
            unevaluatedProperties.d.ts
            index.d.ts
            index.js
            unevaluatedItems.js.map
          validation/
            limitLength.d.ts
            multipleOf.js.map
            multipleOf.d.ts
            multipleOf.js
            pattern.d.ts
            uniqueItems.js
            limitNumber.js.map
            limitContains.js
            dependentRequired.js.map
            limitNumber.js
            limitNumber.d.ts
            pattern.js
            pattern.js.map
            required.js
            enum.js.map
            required.js.map
            enum.js
            dependentRequired.js
            const.js.map
            limitContains.js.map
            const.js
            limitLength.js
            index.js.map
            index.d.ts
            uniqueItems.js.map
            limitItems.d.ts
            dependentRequired.d.ts
            index.js
            uniqueItems.d.ts
            limitProperties.js
            required.d.ts
            limitProperties.d.ts
            const.d.ts
            enum.d.ts
            limitContains.d.ts
            limitItems.js.map
            limitProperties.js.map
            limitLength.js.map
            limitItems.js
          format/
            format.d.ts
            format.js
            index.js.map
            index.d.ts
            format.js.map
            index.js
          applicator/
            if.d.ts
            patternProperties.d.ts
            additionalItems.d.ts
            prefixItems.d.ts
            items2020.js
            dependentSchemas.d.ts
            dependentSchemas.js.map
            allOf.js.map
            anyOf.js
            anyOf.d.ts
            thenElse.js.map
            propertyNames.js.map
            not.js
            contains.js.map
            properties.d.ts
            if.js.map
            additionalProperties.js.map
            dependencies.js.map
            additionalItems.js.map
            oneOf.js.map
            propertyNames.js
            items.d.ts
            properties.js
            contains.js
            items2020.js.map
            properties.js.map
            oneOf.d.ts
            allOf.d.ts
            additionalItems.js
            patternProperties.js
            dependencies.d.ts
            additionalProperties.d.ts
            dependentSchemas.js
            index.js.map
            not.d.ts
            items.js.map
            prefixItems.js
            index.d.ts
            dependencies.js
            propertyNames.d.ts
            not.js.map
            items.js
            allOf.js
            items2020.d.ts
            index.js
            thenElse.js
            oneOf.js
            thenElse.d.ts
            prefixItems.js.map
            if.js
            contains.d.ts
            patternProperties.js.map
            additionalProperties.js
            anyOf.js.map
        types/
          jtd-schema.js
          json-schema.js.map
          jtd-schema.js.map
          jtd-schema.d.ts
          index.js.map
          index.d.ts
          index.js
          json-schema.d.ts
          json-schema.js
      lib/
        core.ts
        ajv.ts
        jtd.ts
        2019.ts
        2020.ts
        standalone/
          index.ts
          instance.ts
        refs/
          jtd-schema.ts
          json-schema-draft-06.json
          json-schema-secure.json
          data.json
          json-schema-draft-07.json
          json-schema-2019-09/
            index.ts
            schema.json
            meta/
              meta-data.json
              validation.json
              applicator.json
              core.json
              content.json
              format.json
          json-schema-2020-12/
            index.ts
            schema.json
            meta/
              unevaluated.json
              meta-data.json
              validation.json
              applicator.json
              core.json
              format-annotation.json
              content.json
        runtime/
          re2.ts
          parseJson.ts
          validation_error.ts
          equal.ts
          timestamp.ts
          quote.ts
          uri.ts
          ucs2length.ts
        compile/
          index.ts
          rules.ts
          ref_error.ts
          names.ts
          util.ts
          errors.ts
          resolve.ts
          validate/
            index.ts
            boolSchema.ts
            keyword.ts
            defaults.ts
            applicability.ts
            dataType.ts
            subschema.ts
          codegen/
            index.ts
            scope.ts
            code.ts
          jtd/
            serialize.ts
            types.ts
            parse.ts
        vocabularies/
          next.ts
          metadata.ts
          errors.ts
          draft7.ts
          draft2020.ts
          code.ts
          discriminator/
            index.ts
            types.ts
          core/
            index.ts
            id.ts
            ref.ts
          jtd/
            index.ts
            enum.ts
            type.ts
            discriminator.ts
            elements.ts
            properties.ts
            metadata.ts
            values.ts
            nullable.ts
            optionalProperties.ts
            error.ts
            ref.ts
            union.ts
          dynamic/
            index.ts
            recursiveRef.ts
            recursiveAnchor.ts
            dynamicAnchor.ts
            dynamicRef.ts
          unevaluated/
            index.ts
            unevaluatedProperties.ts
            unevaluatedItems.ts
          validation/
            required.ts
            index.ts
            limitContains.ts
            enum.ts
            limitNumber.ts
            const.ts
            limitLength.ts
            uniqueItems.ts
            multipleOf.ts
            limitProperties.ts
            dependentRequired.ts
            pattern.ts
            limitItems.ts
          format/
            index.ts
            format.ts
          applicator/
            oneOf.ts
            index.ts
            propertyNames.ts
            additionalProperties.ts
            if.ts
            additionalItems.ts
            properties.ts
            dependencies.ts
            contains.ts
            allOf.ts
            thenElse.ts
            patternProperties.ts
            anyOf.ts
            not.ts
            dependentSchemas.ts
            items.ts
            items2020.ts
            prefixItems.ts
        types/
          index.ts
          jtd-schema.ts
          json-schema.ts
    semver/
      package.json
      LICENSE
      range.bnf
      README.md
      preload.js
      index.js
      bin/
        semver.js
      internal/
        re.js
        constants.js
        identifiers.js
        lrucache.js
        debug.js
        parse-options.js
      classes/
        range.js
        semver.js
        comparator.js
        index.js
      functions/
        rcompare.js
        compare-loose.js
        gt.js
        lte.js
        gte.js
        sort.js
        compare-build.js
        rsort.js
        major.js
        patch.js
        coerce.js
        inc.js
        cmp.js
        minor.js
        valid.js
        clean.js
        compare.js
        satisfies.js
        lt.js
        neq.js
        eq.js
        parse.js
        diff.js
        prerelease.js
      ranges/
        simplify.js
        outside.js
        min-version.js
        intersects.js
        min-satisfying.js
        max-satisfying.js
        gtr.js
        valid.js
        to-comparators.js
        subset.js
        ltr.js
    url-join/
      package.json
      README.md
      .npmignore
      lib/
        url-join.js
      test/
        tests.js
    is-fullwidth-code-point/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    inversify/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      lib/
        tsconfig.tsbuildinfo
        inversify.js
        inversify.d.ts
        interfaces/
          interfaces.d.ts
          interfaces.js
        constants/
          error_msgs.d.ts
          metadata_keys.js
          literal_types.d.ts
          error_msgs.js
          metadata_keys.d.ts
          literal_types.js
        bindings/
          binding.js
          binding_count.d.ts
          binding.d.ts
          binding_count.js
        syntax/
          binding_to_syntax.js
          binding_when_on_syntax.d.ts
          binding_when_syntax.d.ts
          binding_to_syntax.d.ts
          binding_when_syntax.js
          constraint_helpers.d.ts
          binding_in_syntax.d.ts
          binding_in_when_on_syntax.d.ts
          binding_when_on_syntax.js
          binding_on_syntax.d.ts
          constraint_helpers.js
          binding_in_when_on_syntax.js
          binding_in_syntax.js
          binding_on_syntax.js
        container/
          module_activation_store.d.ts
          lookup.d.ts
          container_module.d.ts
          container.js
          module_activation_store.js
          container_module.js
          lookup.js
          container_snapshot.d.ts
          container.d.ts
          container_snapshot.js
        utils/
          js.js
          clonable.js
          binding_utils.js
          id.js
          clonable.d.ts
          exceptions.js
          serialization.js
          exceptions.d.ts
          async.d.ts
          id.d.ts
          js.d.ts
          binding_utils.d.ts
          serialization.d.ts
          async.js
          factory_type.d.ts
          factory_type.js
        resolution/
          resolver.js
          instantiation.d.ts
          instantiation.js
          resolver.d.ts
        planning/
          metadata_reader.d.ts
          planner.d.ts
          queryable_string.d.ts
          target.d.ts
          context.d.ts
          metadata_reader.js
          request.js
          planner.js
          target.js
          reflection_utils.js
          metadata.js
          plan.js
          reflection_utils.d.ts
          request.d.ts
          queryable_string.js
          metadata.d.ts
          plan.d.ts
          context.js
        annotation/
          property_event_decorator.js
          unmanaged.js
          pre_destroy.d.ts
          injectable.d.ts
          lazy_service_identifier.d.ts
          post_construct.d.ts
          multi_inject.d.ts
          named.d.ts
          property_event_decorator.d.ts
          lazy_service_identifier.js
          optional.d.ts
          tagged.d.ts
          injectable.js
          named.js
          optional.js
          tagged.js
          unmanaged.d.ts
          decorator_utils.js
          inject.d.ts
          target_name.d.ts
          decorator_utils.d.ts
          inject_base.js
          target_name.js
          multi_inject.js
          inject_base.d.ts
          inject.js
          pre_destroy.js
          post_construct.js
        scope/
          scope.d.ts
          scope.js
      es/
        package.json
        inversify.js
        inversify.d.ts
        interfaces/
          interfaces.d.ts
          interfaces.js
        constants/
          error_msgs.d.ts
          metadata_keys.js
          literal_types.d.ts
          error_msgs.js
          metadata_keys.d.ts
          literal_types.js
        bindings/
          binding.js
          binding_count.d.ts
          binding.d.ts
          binding_count.js
        syntax/
          binding_to_syntax.js
          binding_when_on_syntax.d.ts
          binding_when_syntax.d.ts
          binding_to_syntax.d.ts
          binding_when_syntax.js
          constraint_helpers.d.ts
          binding_in_syntax.d.ts
          binding_in_when_on_syntax.d.ts
          binding_when_on_syntax.js
          binding_on_syntax.d.ts
          constraint_helpers.js
          binding_in_when_on_syntax.js
          binding_in_syntax.js
          binding_on_syntax.js
        container/
          module_activation_store.d.ts
          lookup.d.ts
          container_module.d.ts
          container.js
          module_activation_store.js
          container_module.js
          lookup.js
          container_snapshot.d.ts
          container.d.ts
          container_snapshot.js
        utils/
          js.js
          clonable.js
          binding_utils.js
          id.js
          clonable.d.ts
          exceptions.js
          serialization.js
          exceptions.d.ts
          async.d.ts
          id.d.ts
          js.d.ts
          binding_utils.d.ts
          serialization.d.ts
          async.js
          factory_type.d.ts
          factory_type.js
        resolution/
          resolver.js
          instantiation.d.ts
          instantiation.js
          resolver.d.ts
        planning/
          metadata_reader.d.ts
          planner.d.ts
          queryable_string.d.ts
          context.d.ts
          metadata_reader.js
          request.js
          planner.js
          target.js
          reflection_utils.js
          metadata.js
          plan.js
          reflection_utils.d.ts
          request.d.ts
          queryable_string.js
          metadata.d.ts
          plan.d.ts
          context.js
        annotation/
          property_event_decorator.js
          unmanaged.js
          pre_destroy.d.ts
          injectable.d.ts
          post_construct.d.ts
          multi_inject.d.ts
          named.d.ts
          property_event_decorator.d.ts
          lazy_service_identifier.js
          optional.d.ts
          tagged.d.ts
          injectable.js
          named.js
          optional.js
          tagged.js
          unmanaged.d.ts
          decorator_utils.js
          inject.d.ts
          target_name.d.ts
          decorator_utils.d.ts
          inject_base.js
          target_name.js
          multi_inject.js
          inject_base.d.ts
          inject.js
          pre_destroy.js
          post_construct.js
        scope/
          scope.d.ts
          scope.js
      es6/
        inversify.js
        inversify.d.ts
        interfaces/
          interfaces.d.ts
          interfaces.js
        constants/
          error_msgs.d.ts
          metadata_keys.js
          literal_types.d.ts
          error_msgs.js
          metadata_keys.d.ts
          literal_types.js
        bindings/
          binding.js
          binding_count.d.ts
          binding.d.ts
          binding_count.js
        syntax/
          binding_to_syntax.js
          binding_when_on_syntax.d.ts
          binding_when_syntax.d.ts
          binding_to_syntax.d.ts
          binding_when_syntax.js
          constraint_helpers.d.ts
          binding_in_syntax.d.ts
          binding_in_when_on_syntax.d.ts
          binding_when_on_syntax.js
          binding_on_syntax.d.ts
          constraint_helpers.js
          binding_in_when_on_syntax.js
          binding_in_syntax.js
          binding_on_syntax.js
        container/
          module_activation_store.d.ts
          lookup.d.ts
          container_module.d.ts
          container.js
          module_activation_store.js
          container_module.js
          lookup.js
          container_snapshot.d.ts
          container.d.ts
          container_snapshot.js
        utils/
          js.js
          clonable.js
          binding_utils.js
          id.js
          clonable.d.ts
          exceptions.js
          serialization.js
          exceptions.d.ts
          async.d.ts
          id.d.ts
          js.d.ts
          binding_utils.d.ts
          serialization.d.ts
          async.js
          factory_type.d.ts
          factory_type.js
        resolution/
          resolver.js
          instantiation.d.ts
          instantiation.js
          resolver.d.ts
        planning/
          metadata_reader.d.ts
          planner.d.ts
          queryable_string.d.ts
          context.d.ts
          metadata_reader.js
          request.js
          planner.js
          target.js
          reflection_utils.js
          metadata.js
          plan.js
          reflection_utils.d.ts
          request.d.ts
          queryable_string.js
          metadata.d.ts
          plan.d.ts
          context.js
        annotation/
          property_event_decorator.js
          unmanaged.js
          pre_destroy.d.ts
          injectable.d.ts
          post_construct.d.ts
          multi_inject.d.ts
          named.d.ts
          property_event_decorator.d.ts
          lazy_service_identifier.js
          optional.d.ts
          tagged.d.ts
          injectable.js
          named.js
          optional.js
          tagged.js
          unmanaged.d.ts
          decorator_utils.js
          inject.d.ts
          target_name.d.ts
          decorator_utils.d.ts
          inject_base.js
          target_name.js
          multi_inject.js
          inject_base.d.ts
          inject.js
          pre_destroy.js
          post_construct.js
        scope/
          scope.d.ts
          scope.js
      amd/
        inversify.js
        inversify.d.ts
        interfaces/
          interfaces.d.ts
          interfaces.js
        constants/
          error_msgs.d.ts
          metadata_keys.js
          literal_types.d.ts
          error_msgs.js
          metadata_keys.d.ts
          literal_types.js
        bindings/
          binding.js
          binding_count.d.ts
          binding.d.ts
          binding_count.js
        syntax/
          binding_to_syntax.js
          binding_when_on_syntax.d.ts
          binding_when_syntax.d.ts
          binding_to_syntax.d.ts
          binding_when_syntax.js
          constraint_helpers.d.ts
          binding_in_syntax.d.ts
          binding_in_when_on_syntax.d.ts
          binding_when_on_syntax.js
          binding_on_syntax.d.ts
          constraint_helpers.js
          binding_in_when_on_syntax.js
          binding_in_syntax.js
          binding_on_syntax.js
        container/
          module_activation_store.d.ts
          lookup.d.ts
          container_module.d.ts
          container.js
          module_activation_store.js
          container_module.js
          lookup.js
          container_snapshot.d.ts
          container.d.ts
          container_snapshot.js
        utils/
          js.js
          clonable.js
          binding_utils.js
          id.js
          clonable.d.ts
          exceptions.js
          serialization.js
          exceptions.d.ts
          async.d.ts
          id.d.ts
          js.d.ts
          binding_utils.d.ts
          serialization.d.ts
          async.js
          factory_type.d.ts
          factory_type.js
        resolution/
          resolver.js
          instantiation.d.ts
          instantiation.js
          resolver.d.ts
        planning/
          metadata_reader.d.ts
          planner.d.ts
          queryable_string.d.ts
          context.d.ts
          metadata_reader.js
          request.js
          planner.js
          target.js
          reflection_utils.js
          metadata.js
          plan.js
          reflection_utils.d.ts
          request.d.ts
          queryable_string.js
          metadata.d.ts
          plan.d.ts
          context.js
        annotation/
          property_event_decorator.js
          unmanaged.js
          pre_destroy.d.ts
          injectable.d.ts
          post_construct.d.ts
          multi_inject.d.ts
          named.d.ts
          property_event_decorator.d.ts
          lazy_service_identifier.js
          optional.d.ts
          tagged.d.ts
          injectable.js
          named.js
          optional.js
          tagged.js
          unmanaged.d.ts
          decorator_utils.js
          inject.d.ts
          target_name.d.ts
          decorator_utils.d.ts
          inject_base.js
          target_name.js
          multi_inject.js
          inject_base.d.ts
          inject.js
          pre_destroy.js
          post_construct.js
        scope/
          scope.d.ts
          scope.js
    git-filter-repo/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      NOTICE
      dist/
        bundle.js.LICENSE.txt
        bundle.js
      lib/
        types.js.map
        socket.d.ts
        pip.js
        socket.js
        git.js.map
        types.d.ts
        git.d.ts
        pip.js.map
        gitDate.js.map
        pip.d.ts
        gitFilterRepo.js
        gitDate.d.ts
        index.js.map
        gitFilterRepo.js.map
        git.js
        index.d.ts
        types.js
        gitFilterRepo.d.ts
        index.js
        gitDate.js
        socket.js.map
      scripts/
        types.py
        callbacks.py
        dates.py
        socket.py
        test.py
      es/
        types.js.map
        pip.js
        socket.js
        git.js.map
        pip.js.map
        gitDate.js.map
        gitFilterRepo.js
        index.js.map
        gitFilterRepo.js.map
        git.js
        types.js
        index.js
        gitDate.js
        socket.js.map
    stubborn-fs/
      package.json
      license
      readme.md
      dist/
        handlers.d.ts
        constants.js
        handlers.js
        constants.d.ts
        index.d.ts
        index.js
    tagged-tag/
      package.json
      license
      readme.md
      index.d.ts
    bfg/
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      test/
        test.js
        fixtures/
          hello.txt
          hello.back.txt
      node_modules/
        commander/
          package.json
          Readme.md
          index.js
      src/
        tools.js
        disk.js
        formparser.js
        rackspace.js
        cli.js
        index.js
    levn/
      package.json
      LICENSE
      README.md
      lib/
        parse-string.js
        cast.js
        coerce.js
        index.js
        parse.js
    lodash.isinteger/
      package.json
      LICENSE
      README.md
      index.js
    which-typed-array/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    class-validator/
      package.json
      LICENSE
      README.md
      bundles/
        class-validator.umd.js.map
        class-validator.umd.js
        class-validator.umd.min.js.map
        class-validator.umd.min.js
      cjs/
        container.js.map
        container.js
        index.js.map
        index.js
        register-decorator.js.map
        register-decorator.js
        validation-schema/
          ValidationSchemaToMetadataTransformer.js
          ValidationSchema.js
          ValidationSchema.js.map
          ValidationSchemaToMetadataTransformer.js.map
        metadata/
          ValidationMetadata.js
          ConstraintMetadata.js.map
          ConstraintMetadata.js
          MetadataStorage.js.map
          ValidationMetadataArgs.js.map
          ValidationMetadata.js.map
          ValidationMetadataArgs.js
          MetadataStorage.js
        decorator/
          ValidationOptions.js
          ValidationOptions.js.map
          decorators.js.map
          decorators.js
          string/
            IsBase64.js
            IsISSN.js.map
            IsEmail.js
            Length.js
            IsISO31661Alpha2.js
            IsStrongPassword.js
            IsLocale.js.map
            IsISO31661Alpha3.js
            IsISO31661Alpha3.js.map
            MinLength.js.map
            IsISO8601.js.map
            IsBase58.js
            IsISBN.js
            IsEmail.js.map
            IsMilitaryTime.js
            IsIdentityCard.js.map
            IsByteLength.js.map
            IsLowercase.js
            IsBase58.js.map
            IsIBAN.js.map
            IsISIN.js.map
            IsCurrency.js
            IsBooleanString.js
            IsMacAddress.js
            IsTimeZone.js.map
            IsPhoneNumber.js
            IsISO31661Alpha2.js.map
            IsPassportNumber.js
            IsBooleanString.js.map
            IsCreditCard.js
            is-iso4217-currency-code.js
            IsSemVer.js
            Matches.js
            IsMongoId.js.map
            IsSemVer.js.map
            IsDateString.js
            IsNumberString.js.map
            IsPort.js
            IsCurrency.js.map
            IsBase32.js
            IsISBN.js.map
            IsEAN.js.map
            MaxLength.js
            IsFQDN.js
            IsHalfWidth.js
            IsMilitaryTime.js.map
            IsAscii.js.map
            IsFirebasePushId.js
            IsHalfWidth.js.map
            IsHSL.js.map
            Matches.js.map
            IsMacAddress.js.map
            IsRFC3339.js.map
            NotContains.js.map
            IsPort.js.map
            IsBtcAddress.js
            IsJWT.js.map
            IsPhoneNumber.js.map
            IsISSN.js
            is-tax-id.js
            IsMongoId.js
            IsISO8601.js
            is-iso4217-currency-code.js.map
            IsHash.js.map
            IsLowercase.js.map
            IsBIC.js.map
            IsEAN.js
            IsOctal.js.map
            IsHexadecimal.js.map
            IsDataURI.js
            IsPassportNumber.js.map
            IsFullWidth.js
            IsBase32.js.map
            IsUppercase.js
            IsVariableWidth.js
            IsHexadecimal.js
            IsVariableWidth.js.map
            IsISRC.js
            IsAlpha.js.map
            is-tax-id.js.map
            IsHSL.js
            IsHexColor.js
            IsMimeType.js
            IsPostalCode.js.map
            IsIdentityCard.js
            IsEthereumAddress.js.map
            IsRgbColor.js.map
            IsUppercase.js.map
            IsIP.js
            IsNumberString.js
            IsDataURI.js.map
            IsHash.js
            NotContains.js
            IsRgbColor.js
            IsOctal.js
            IsSurrogatePair.js.map
            IsFullWidth.js.map
            IsJSON.js
            IsJWT.js
            IsUrl.js.map
            IsISIN.js
            IsEthereumAddress.js
            IsMobilePhone.js
            IsPostalCode.js
            IsLocale.js
            MaxLength.js.map
            IsFirebasePushId.js.map
            IsUUID.js.map
            IsBtcAddress.js.map
            IsFQDN.js.map
            IsMultibyte.js
            IsSurrogatePair.js
            IsHexColor.js.map
            Contains.js.map
            IsCreditCard.js.map
            MinLength.js
            IsMultibyte.js.map
            IsMimeType.js.map
            IsDateString.js.map
            IsUUID.js
            IsAlphanumeric.js.map
            IsDecimal.js.map
            IsDecimal.js
            IsAlpha.js
            IsStrongPassword.js.map
            IsUrl.js
            IsMobilePhone.js.map
            IsByteLength.js
            Contains.js
            IsAlphanumeric.js
            IsISRC.js.map
            IsMagnetURI.js
            IsAscii.js
            IsIP.js.map
            IsMagnetURI.js.map
            IsBase64.js.map
            IsJSON.js.map
            IsBIC.js
            IsTimeZone.js
            Length.js.map
            IsRFC3339.js
            IsIBAN.js
          common/
            IsNotEmpty.js
            IsIn.js.map
            ValidateBy.js.map
            IsOptional.js
            IsEmpty.js
            IsIn.js
            IsDefined.js
            Validate.js.map
            IsNotEmpty.js.map
            ValidateNested.js.map
            IsOptional.js.map
            IsDefined.js.map
            IsLatitude.js.map
            IsEmpty.js.map
            ValidatePromise.js
            ValidatePromise.js.map
            IsLatLong.js
            Validate.js
            IsLatLong.js.map
            IsLongitude.js
            IsNotIn.js.map
            ValidateBy.js
            IsNotIn.js
            IsLatitude.js
            NotEquals.js.map
            Equals.js
            ValidateNested.js
            Allow.js.map
            ValidateIf.js
            ValidateIf.js.map
            Allow.js
            IsLongitude.js.map
            Equals.js.map
            NotEquals.js
          array/
            ArrayNotEmpty.js.map
            ArrayContains.js.map
            ArrayNotEmpty.js
            ArrayMinSize.js.map
            ArrayContains.js
            ArrayMinSize.js
            ArrayMaxSize.js
            ArrayNotContains.js.map
            ArrayMaxSize.js.map
            ArrayUnique.js
            ArrayUnique.js.map
            ArrayNotContains.js
          number/
            Min.js.map
            IsNegative.js
            IsDivisibleBy.js.map
            IsDivisibleBy.js
            Min.js
            Max.js.map
            IsNegative.js.map
            IsPositive.js
            Max.js
            IsPositive.js.map
          object/
            IsInstance.js
            IsInstance.js.map
            IsNotEmptyObject.js
            IsNotEmptyObject.js.map
          date/
            MaxDate.js.map
            MaxDate.js
            MinDate.js
            MinDate.js.map
          typechecker/
            IsDate.js.map
            IsEnum.js.map
            IsString.js
            IsArray.js
            IsInt.js
            IsEnum.js
            IsObject.js.map
            IsInt.js.map
            IsObject.js
            IsBoolean.js.map
            IsArray.js.map
            IsNumber.js.map
            IsDate.js
            IsString.js.map
            IsBoolean.js
            IsNumber.js
        utils/
          is-promise.util.js.map
          convert-to-array.util.js
          convert-to-array.util.js.map
          index.js.map
          is-promise.util.js
          get-global.util.js
          index.js
          get-global.util.js.map
        validation/
          ValidationArguments.js.map
          Validator.js.map
          ValidationUtils.js
          ValidationArguments.js
          ValidatorConstraintInterface.js.map
          ValidationExecutor.js
          ValidationError.js.map
          ValidationTypes.js.map
          ValidatorOptions.js.map
          ValidatorConstraintInterface.js
          ValidatorOptions.js
          Validator.js
          ValidationTypes.js
          ValidationExecutor.js.map
          ValidationError.js
          ValidationUtils.js.map
      esm2015/
        container.js.map
        container.js
        index.js.map
        index.js
        register-decorator.js.map
        register-decorator.js
        validation-schema/
          ValidationSchemaToMetadataTransformer.js
          ValidationSchema.js
          ValidationSchema.js.map
          ValidationSchemaToMetadataTransformer.js.map
        metadata/
          ValidationMetadata.js
          ConstraintMetadata.js.map
          ConstraintMetadata.js
          MetadataStorage.js.map
          ValidationMetadataArgs.js.map
          ValidationMetadata.js.map
          ValidationMetadataArgs.js
          MetadataStorage.js
        decorator/
          ValidationOptions.js
          ValidationOptions.js.map
          decorators.js.map
          decorators.js
          string/
            IsBase64.js
            IsISSN.js.map
            IsEmail.js
            Length.js
            IsISO31661Alpha2.js
            IsStrongPassword.js
            IsLocale.js.map
            IsISO31661Alpha3.js
            IsISO31661Alpha3.js.map
            MinLength.js.map
            IsISO8601.js.map
            IsBase58.js
            IsISBN.js
            IsEmail.js.map
            IsMilitaryTime.js
            IsIdentityCard.js.map
            IsByteLength.js.map
            IsLowercase.js
            IsBase58.js.map
            IsIBAN.js.map
            IsISIN.js.map
            IsCurrency.js
            IsBooleanString.js
            IsMacAddress.js
            IsTimeZone.js.map
            IsPhoneNumber.js
            IsISO31661Alpha2.js.map
            IsPassportNumber.js
            IsBooleanString.js.map
            IsCreditCard.js
            is-iso4217-currency-code.js
            IsSemVer.js
            Matches.js
            IsMongoId.js.map
            IsSemVer.js.map
            IsDateString.js
            IsNumberString.js.map
            IsPort.js
            IsCurrency.js.map
            IsBase32.js
            IsISBN.js.map
            IsEAN.js.map
            MaxLength.js
            IsFQDN.js
            IsHalfWidth.js
            IsMilitaryTime.js.map
            IsAscii.js.map
            IsFirebasePushId.js
            IsHalfWidth.js.map
            IsHSL.js.map
            Matches.js.map
            IsMacAddress.js.map
            IsRFC3339.js.map
            NotContains.js.map
            IsPort.js.map
            IsBtcAddress.js
            IsJWT.js.map
            IsPhoneNumber.js.map
            IsISSN.js
            is-tax-id.js
            IsMongoId.js
            IsISO8601.js
            is-iso4217-currency-code.js.map
            IsHash.js.map
            IsLowercase.js.map
            IsBIC.js.map
            IsEAN.js
            IsOctal.js.map
            IsHexadecimal.js.map
            IsDataURI.js
            IsPassportNumber.js.map
            IsFullWidth.js
            IsBase32.js.map
            IsUppercase.js
            IsVariableWidth.js
            IsHexadecimal.js
            IsVariableWidth.js.map
            IsISRC.js
            IsAlpha.js.map
            is-tax-id.js.map
            IsHSL.js
            IsHexColor.js
            IsMimeType.js
            IsPostalCode.js.map
            IsIdentityCard.js
            IsEthereumAddress.js.map
            IsRgbColor.js.map
            IsUppercase.js.map
            IsIP.js
            IsNumberString.js
            IsDataURI.js.map
            IsHash.js
            NotContains.js
            IsRgbColor.js
            IsOctal.js
            IsSurrogatePair.js.map
            IsFullWidth.js.map
            IsJSON.js
            IsJWT.js
            IsUrl.js.map
            IsISIN.js
            IsEthereumAddress.js
            IsMobilePhone.js
            IsPostalCode.js
            IsLocale.js
            MaxLength.js.map
            IsFirebasePushId.js.map
            IsUUID.js.map
            IsBtcAddress.js.map
            IsFQDN.js.map
            IsMultibyte.js
            IsSurrogatePair.js
            IsHexColor.js.map
            Contains.js.map
            IsCreditCard.js.map
            MinLength.js
            IsMultibyte.js.map
            IsMimeType.js.map
            IsDateString.js.map
            IsUUID.js
            IsAlphanumeric.js.map
            IsDecimal.js.map
            IsDecimal.js
            IsAlpha.js
            IsStrongPassword.js.map
            IsUrl.js
            IsMobilePhone.js.map
            IsByteLength.js
            Contains.js
            IsAlphanumeric.js
            IsISRC.js.map
            IsMagnetURI.js
            IsAscii.js
            IsIP.js.map
            IsMagnetURI.js.map
            IsBase64.js.map
            IsJSON.js.map
            IsBIC.js
            IsTimeZone.js
            Length.js.map
            IsRFC3339.js
            IsIBAN.js
          common/
            IsNotEmpty.js
            IsIn.js.map
            ValidateBy.js.map
            IsOptional.js
            IsEmpty.js
            IsIn.js
            IsDefined.js
            Validate.js.map
            IsNotEmpty.js.map
            ValidateNested.js.map
            IsOptional.js.map
            IsDefined.js.map
            IsLatitude.js.map
            IsEmpty.js.map
            ValidatePromise.js
            ValidatePromise.js.map
            IsLatLong.js
            Validate.js
            IsLatLong.js.map
            IsLongitude.js
            IsNotIn.js.map
            ValidateBy.js
            IsNotIn.js
            IsLatitude.js
            NotEquals.js.map
            Equals.js
            ValidateNested.js
            Allow.js.map
            ValidateIf.js
            ValidateIf.js.map
            Allow.js
            IsLongitude.js.map
            Equals.js.map
            NotEquals.js
          array/
            ArrayNotEmpty.js.map
            ArrayContains.js.map
            ArrayNotEmpty.js
            ArrayMinSize.js.map
            ArrayContains.js
            ArrayMinSize.js
            ArrayMaxSize.js
            ArrayNotContains.js.map
            ArrayMaxSize.js.map
            ArrayUnique.js
            ArrayUnique.js.map
            ArrayNotContains.js
          number/
            Min.js.map
            IsNegative.js
            IsDivisibleBy.js.map
            IsDivisibleBy.js
            Min.js
            Max.js.map
            IsNegative.js.map
            IsPositive.js
            Max.js
            IsPositive.js.map
          object/
            IsInstance.js
            IsInstance.js.map
            IsNotEmptyObject.js
            IsNotEmptyObject.js.map
          date/
            MaxDate.js.map
            MaxDate.js
            MinDate.js
            MinDate.js.map
          typechecker/
            IsDate.js.map
            IsEnum.js.map
            IsString.js
            IsArray.js
            IsInt.js
            IsEnum.js
            IsObject.js.map
            IsInt.js.map
            IsObject.js
            IsBoolean.js.map
            IsArray.js.map
            IsNumber.js.map
            IsDate.js
            IsString.js.map
            IsBoolean.js
            IsNumber.js
        utils/
          is-promise.util.js.map
          convert-to-array.util.js
          convert-to-array.util.js.map
          index.js.map
          is-promise.util.js
          get-global.util.js
          index.js
          get-global.util.js.map
        validation/
          ValidationArguments.js.map
          Validator.js.map
          ValidationUtils.js
          ValidationArguments.js
          ValidatorConstraintInterface.js.map
          ValidationExecutor.js
          ValidationError.js.map
          ValidationTypes.js.map
          ValidatorOptions.js.map
          ValidatorConstraintInterface.js
          ValidatorOptions.js
          Validator.js
          ValidationTypes.js
          ValidationExecutor.js.map
          ValidationError.js
          ValidationUtils.js.map
      esm5/
        container.js.map
        container.js
        index.js.map
        index.js
        register-decorator.js.map
        register-decorator.js
        validation-schema/
          ValidationSchemaToMetadataTransformer.js
          ValidationSchema.js
          ValidationSchema.js.map
          ValidationSchemaToMetadataTransformer.js.map
        metadata/
          ValidationMetadata.js
          ConstraintMetadata.js.map
          ConstraintMetadata.js
          MetadataStorage.js.map
          ValidationMetadataArgs.js.map
          ValidationMetadata.js.map
          ValidationMetadataArgs.js
          MetadataStorage.js
        decorator/
          ValidationOptions.js
          ValidationOptions.js.map
          decorators.js.map
          decorators.js
          string/
            IsBase64.js
            IsISSN.js.map
            IsEmail.js
            Length.js
            IsISO31661Alpha2.js
            IsStrongPassword.js
            IsLocale.js.map
            IsISO31661Alpha3.js
            IsISO31661Alpha3.js.map
            MinLength.js.map
            IsISO8601.js.map
            IsBase58.js
            IsISBN.js
            IsEmail.js.map
            IsMilitaryTime.js
            IsIdentityCard.js.map
            IsByteLength.js.map
            IsLowercase.js
            IsBase58.js.map
            IsIBAN.js.map
            IsISIN.js.map
            IsCurrency.js
            IsBooleanString.js
            IsMacAddress.js
            IsTimeZone.js.map
            IsPhoneNumber.js
            IsISO31661Alpha2.js.map
            IsPassportNumber.js
            IsBooleanString.js.map
            IsCreditCard.js
            is-iso4217-currency-code.js
            IsSemVer.js
            Matches.js
            IsMongoId.js.map
            IsSemVer.js.map
            IsDateString.js
            IsNumberString.js.map
            IsPort.js
            IsCurrency.js.map
            IsBase32.js
            IsISBN.js.map
            IsEAN.js.map
            MaxLength.js
            IsFQDN.js
            IsHalfWidth.js
            IsMilitaryTime.js.map
            IsAscii.js.map
            IsFirebasePushId.js
            IsHalfWidth.js.map
            IsHSL.js.map
            Matches.js.map
            IsMacAddress.js.map
            IsRFC3339.js.map
            NotContains.js.map
            IsPort.js.map
            IsBtcAddress.js
            IsJWT.js.map
            IsPhoneNumber.js.map
            IsISSN.js
            is-tax-id.js
            IsMongoId.js
            IsISO8601.js
            is-iso4217-currency-code.js.map
            IsHash.js.map
            IsLowercase.js.map
            IsBIC.js.map
            IsEAN.js
            IsOctal.js.map
            IsHexadecimal.js.map
            IsDataURI.js
            IsPassportNumber.js.map
            IsFullWidth.js
            IsBase32.js.map
            IsUppercase.js
            IsVariableWidth.js
            IsHexadecimal.js
            IsVariableWidth.js.map
            IsISRC.js
            IsAlpha.js.map
            is-tax-id.js.map
            IsHSL.js
            IsHexColor.js
            IsMimeType.js
            IsPostalCode.js.map
            IsIdentityCard.js
            IsEthereumAddress.js.map
            IsRgbColor.js.map
            IsUppercase.js.map
            IsIP.js
            IsNumberString.js
            IsDataURI.js.map
            IsHash.js
            NotContains.js
            IsRgbColor.js
            IsOctal.js
            IsSurrogatePair.js.map
            IsFullWidth.js.map
            IsJSON.js
            IsJWT.js
            IsUrl.js.map
            IsISIN.js
            IsEthereumAddress.js
            IsMobilePhone.js
            IsPostalCode.js
            IsLocale.js
            MaxLength.js.map
            IsFirebasePushId.js.map
            IsUUID.js.map
            IsBtcAddress.js.map
            IsFQDN.js.map
            IsMultibyte.js
            IsSurrogatePair.js
            IsHexColor.js.map
            Contains.js.map
            IsCreditCard.js.map
            MinLength.js
            IsMultibyte.js.map
            IsMimeType.js.map
            IsDateString.js.map
            IsUUID.js
            IsAlphanumeric.js.map
            IsDecimal.js.map
            IsDecimal.js
            IsAlpha.js
            IsStrongPassword.js.map
            IsUrl.js
            IsMobilePhone.js.map
            IsByteLength.js
            Contains.js
            IsAlphanumeric.js
            IsISRC.js.map
            IsMagnetURI.js
            IsAscii.js
            IsIP.js.map
            IsMagnetURI.js.map
            IsBase64.js.map
            IsJSON.js.map
            IsBIC.js
            IsTimeZone.js
            Length.js.map
            IsRFC3339.js
            IsIBAN.js
          common/
            IsNotEmpty.js
            IsIn.js.map
            ValidateBy.js.map
            IsOptional.js
            IsEmpty.js
            IsIn.js
            IsDefined.js
            Validate.js.map
            IsNotEmpty.js.map
            ValidateNested.js.map
            IsOptional.js.map
            IsDefined.js.map
            IsLatitude.js.map
            IsEmpty.js.map
            ValidatePromise.js
            ValidatePromise.js.map
            IsLatLong.js
            Validate.js
            IsLatLong.js.map
            IsLongitude.js
            IsNotIn.js.map
            ValidateBy.js
            IsNotIn.js
            IsLatitude.js
            NotEquals.js.map
            Equals.js
            ValidateNested.js
            Allow.js.map
            ValidateIf.js
            ValidateIf.js.map
            Allow.js
            IsLongitude.js.map
            Equals.js.map
            NotEquals.js
          array/
            ArrayNotEmpty.js.map
            ArrayContains.js.map
            ArrayNotEmpty.js
            ArrayMinSize.js.map
            ArrayContains.js
            ArrayMinSize.js
            ArrayMaxSize.js
            ArrayNotContains.js.map
            ArrayMaxSize.js.map
            ArrayUnique.js
            ArrayUnique.js.map
            ArrayNotContains.js
          number/
            Min.js.map
            IsNegative.js
            IsDivisibleBy.js.map
            IsDivisibleBy.js
            Min.js
            Max.js.map
            IsNegative.js.map
            IsPositive.js
            Max.js
            IsPositive.js.map
          object/
            IsInstance.js
            IsInstance.js.map
            IsNotEmptyObject.js
            IsNotEmptyObject.js.map
          date/
            MaxDate.js.map
            MaxDate.js
            MinDate.js
            MinDate.js.map
          typechecker/
            IsDate.js.map
            IsEnum.js.map
            IsString.js
            IsArray.js
            IsInt.js
            IsEnum.js
            IsObject.js.map
            IsInt.js.map
            IsObject.js
            IsBoolean.js.map
            IsArray.js.map
            IsNumber.js.map
            IsDate.js
            IsString.js.map
            IsBoolean.js
            IsNumber.js
        utils/
          is-promise.util.js.map
          convert-to-array.util.js
          convert-to-array.util.js.map
          index.js.map
          is-promise.util.js
          get-global.util.js
          index.js
          get-global.util.js.map
        validation/
          ValidationArguments.js.map
          Validator.js.map
          ValidationUtils.js
          ValidationArguments.js
          ValidatorConstraintInterface.js.map
          ValidationExecutor.js
          ValidationError.js.map
          ValidationTypes.js.map
          ValidatorOptions.js.map
          ValidatorConstraintInterface.js
          ValidatorOptions.js
          Validator.js
          ValidationTypes.js
          ValidationExecutor.js.map
          ValidationError.js
          ValidationUtils.js.map
      types/
        register-decorator.d.ts
        index.d.ts
        container.d.ts
        validation-schema/
          ValidationSchema.d.ts
          ValidationSchemaToMetadataTransformer.d.ts
        metadata/
          MetadataStorage.d.ts
          ConstraintMetadata.d.ts
          ValidationMetadataArgs.d.ts
          ValidationMetadata.d.ts
        decorator/
          decorators.d.ts
          ValidationOptions.d.ts
          string/
            IsJWT.d.ts
            IsBase64.d.ts
            MaxLength.d.ts
            IsRgbColor.d.ts
            IsMobilePhone.d.ts
            IsFQDN.d.ts
            is-tax-id.d.ts
            IsBooleanString.d.ts
            IsDecimal.d.ts
            IsLocale.d.ts
            IsISRC.d.ts
            IsEAN.d.ts
            IsHSL.d.ts
            IsISO31661Alpha3.d.ts
            IsIBAN.d.ts
            IsUUID.d.ts
            IsBIC.d.ts
            IsMongoId.d.ts
            Contains.d.ts
            IsMagnetURI.d.ts
            MinLength.d.ts
            IsFirebasePushId.d.ts
            IsSurrogatePair.d.ts
            IsOctal.d.ts
            IsEthereumAddress.d.ts
            Length.d.ts
            IsAlpha.d.ts
            IsLowercase.d.ts
            IsIP.d.ts
            NotContains.d.ts
            IsNumberString.d.ts
            Matches.d.ts
            IsISIN.d.ts
            IsCurrency.d.ts
            IsAlphanumeric.d.ts
            IsMultibyte.d.ts
            is-iso4217-currency-code.d.ts
            IsStrongPassword.d.ts
            IsUppercase.d.ts
            IsISO8601.d.ts
            IsMacAddress.d.ts
            IsPort.d.ts
            IsByteLength.d.ts
            IsPassportNumber.d.ts
            IsFullWidth.d.ts
            IsAscii.d.ts
            IsDataURI.d.ts
            IsEmail.d.ts
            IsHash.d.ts
            IsPostalCode.d.ts
            IsISBN.d.ts
            IsBase58.d.ts
            IsJSON.d.ts
            IsISO31661Alpha2.d.ts
            IsBase32.d.ts
            IsHexadecimal.d.ts
            IsTimeZone.d.ts
            IsPhoneNumber.d.ts
            IsIdentityCard.d.ts
            IsVariableWidth.d.ts
            IsMimeType.d.ts
            IsSemVer.d.ts
            IsRFC3339.d.ts
            IsHalfWidth.d.ts
            IsBtcAddress.d.ts
            IsUrl.d.ts
            IsHexColor.d.ts
            IsDateString.d.ts
            IsISSN.d.ts
            IsCreditCard.d.ts
            IsMilitaryTime.d.ts
          common/
            Equals.d.ts
            IsNotEmpty.d.ts
            IsLatLong.d.ts
            IsEmpty.d.ts
            Allow.d.ts
            IsIn.d.ts
            ValidatePromise.d.ts
            Validate.d.ts
            ValidateIf.d.ts
            NotEquals.d.ts
            IsNotIn.d.ts
            IsDefined.d.ts
            ValidateNested.d.ts
            IsLatitude.d.ts
            IsOptional.d.ts
            IsLongitude.d.ts
            ValidateBy.d.ts
          array/
            ArrayMaxSize.d.ts
            ArrayNotContains.d.ts
            ArrayContains.d.ts
            ArrayMinSize.d.ts
            ArrayUnique.d.ts
            ArrayNotEmpty.d.ts
          number/
            IsDivisibleBy.d.ts
            IsNegative.d.ts
            Max.d.ts
            Min.d.ts
            IsPositive.d.ts
          object/
            IsNotEmptyObject.d.ts
            IsInstance.d.ts
          date/
            MinDate.d.ts
            MaxDate.d.ts
          typechecker/
            IsInt.d.ts
            IsEnum.d.ts
            IsObject.d.ts
            IsBoolean.d.ts
            IsNumber.d.ts
            IsArray.d.ts
            IsDate.d.ts
            IsString.d.ts
        utils/
          convert-to-array.util.d.ts
          get-global.util.d.ts
          index.d.ts
          is-promise.util.d.ts
        validation/
          ValidationError.d.ts
          ValidatorConstraintInterface.d.ts
          ValidationUtils.d.ts
          ValidationExecutor.d.ts
          ValidatorOptions.d.ts
          Validator.d.ts
          ValidationTypes.d.ts
          ValidationArguments.d.ts
    base64-js/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
      base64js.min.js
    array-flatten/
      package.json
      LICENSE
      README.md
      array-flatten.js
    glob/
      package.json
      LICENSE
      README.md
      dist/
        commonjs/
          processor.d.ts.map
          package.json
          processor.js
          pattern.d.ts
          has-magic.js.map
          ignore.js.map
          glob.js.map
          processor.d.ts
          walker.js
          has-magic.d.ts.map
          ignore.d.ts.map
          pattern.js
          pattern.js.map
          pattern.d.ts.map
          ignore.d.ts
          walker.js.map
          index.js.map
          index.d.ts
          ignore.js
          glob.js
          index.js
          index.d.ts.map
          has-magic.d.ts
          glob.d.ts
          walker.d.ts.map
          has-magic.js
          walker.d.ts
          processor.js.map
          glob.d.ts.map
        esm/
          processor.d.ts.map
          package.json
          processor.js
          pattern.d.ts
          bin.d.mts
          bin.d.mts.map
          has-magic.js.map
          ignore.js.map
          bin.mjs
          glob.js.map
          processor.d.ts
          walker.js
          has-magic.d.ts.map
          ignore.d.ts.map
          pattern.js
          pattern.js.map
          pattern.d.ts.map
          ignore.d.ts
          walker.js.map
          index.js.map
          index.d.ts
          ignore.js
          glob.js
          index.js
          index.d.ts.map
          has-magic.d.ts
          glob.d.ts
          walker.d.ts.map
          has-magic.js
          walker.d.ts
          processor.js.map
          bin.mjs.map
          glob.d.ts.map
      node_modules/
        brace-expansion/
          package.json
          LICENSE
          README.md
          index.js
          .github/
            FUNDING.yml
        minimatch/
          package.json
          LICENSE
          README.md
          dist/
            commonjs/
              brace-expressions.d.ts.map
              escape.js
              package.json
              ast.js.map
              unescape.js
              unescape.d.ts.map
              unescape.d.ts
              assert-valid-pattern.js.map
              brace-expressions.js
              assert-valid-pattern.d.ts
              ast.js
              unescape.js.map
              ast.d.ts.map
              assert-valid-pattern.js
              index.js.map
              assert-valid-pattern.d.ts.map
              ast.d.ts
              brace-expressions.d.ts
              brace-expressions.js.map
              escape.js.map
              index.d.ts
              escape.d.ts
              escape.d.ts.map
              index.js
              index.d.ts.map
            esm/
              brace-expressions.d.ts.map
              escape.js
              package.json
              ast.js.map
              unescape.js
              unescape.d.ts.map
              unescape.d.ts
              assert-valid-pattern.js.map
              brace-expressions.js
              assert-valid-pattern.d.ts
              ast.js
              unescape.js.map
              ast.d.ts.map
              assert-valid-pattern.js
              index.js.map
              assert-valid-pattern.d.ts.map
              ast.d.ts
              brace-expressions.d.ts
              brace-expressions.js.map
              escape.js.map
              index.d.ts
              escape.d.ts
              escape.d.ts.map
              index.js
              index.d.ts.map
    reflect-metadata/
      package.json
      AUTHORS.md
      ReflectNoConflict.js
      LICENSE
      CopyrightNotice.txt
      README.md
      Reflect.js
      ReflectLite.js
      index.d.ts
      standalone.d.ts
      no-conflict.d.ts
    ini/
      package.json
      LICENSE
      README.md
      ini.js
    send/
      package.json
      SECURITY.md
      LICENSE
      README.md
      index.js
      HISTORY.md
      node_modules/
        debug/
          CHANGELOG.md
          package.json
          component.json
          Makefile
          LICENSE
          node.js
          README.md
          .npmignore
          .eslintrc
          karma.conf.js
          .travis.yml
          .coveralls.yml
          node_modules/
            ms/
              package.json
              license.md
              readme.md
              index.js
          src/
            browser.js
            node.js
            debug.js
            index.js
            inspector-log.js
    dir-glob/
      package.json
      license
      readme.md
      index.js
    arrify/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    fs-constants/
      browser.js
      package.json
      LICENSE
      README.md
      index.js
    object-assign/
      package.json
      license
      readme.md
      index.js
    https-proxy-agent/
      package.json
      README.md
      dist/
        parse-proxy-response.js
        agent.js
        agent.js.map
        parse-proxy-response.js.map
        index.js.map
        index.d.ts
        parse-proxy-response.d.ts
        index.js
        agent.d.ts
      node_modules/
        debug/
          package.json
          LICENSE
          README.md
          src/
            browser.js
            node.js
            common.js
            index.js
    dunder-proto/
      CHANGELOG.md
      package.json
      get.js
      LICENSE
      tsconfig.json
      set.js
      .nycrc
      README.md
      .eslintrc
      get.d.ts
      set.d.ts
      test/
        get.js
        set.js
        index.js
      .github/
        FUNDING.yml
    object.assign/
      CHANGELOG.md
      auto.js
      package.json
      LICENSE
      .nycrc
      polyfill.js
      README.md
      .eslintrc
      implementation.js
      .editorconfig
      hasSymbols.js
      index.js
      shim.js
      dist/
        browser.js
      test/
        native.js
        ses-compat.js
        implementation.js
        index.js
        shimmed.js
        tests.js
      .github/
        FUNDING.yml
    mongodb/
      package.json
      tsconfig.json
      mongodb.d.ts
      README.md
      LICENSE.md
      lib/
        beta.js.map
        db.js.map
        utils.js
        resource_management.js.map
        transactions.js.map
        bson.js.map
        admin.js
        constants.js
        sort.js.map
        sessions.js
        sort.js
        connection_string.js
        collection.js.map
        beta.js
        deps.js.map
        constants.js.map
        timeout.js
        error.js
        read_preference.js
        transactions.js
        write_concern.js
        admin.js.map
        change_stream.js.map
        connection_string.js.map
        utils.js.map
        read_preference.js.map
        mongo_client.js
        explain.js.map
        collection.js
        mongo_types.js
        mongo_client.js.map
        index.js.map
        sessions.js.map
        error.js.map
        write_concern.js.map
        mongo_types.js.map
        index.js
        mongo_logger.js.map
        beta.d.ts
        mongo_client_auth_providers.js
        read_concern.js.map
        encrypter.js.map
        read_concern.js
        explain.js
        deps.js
        resource_management.js
        timeout.js.map
        encrypter.js
        mongo_client_auth_providers.js.map
        db.js
        mongo_logger.js
        bson.js
        change_stream.js
        bulk/
          ordered.js
          common.js
          common.js.map
          unordered.js
          ordered.js.map
          unordered.js.map
        gridfs/
          upload.js
          download.js
          upload.js.map
          index.js.map
          index.js
          download.js.map
        cmap/
          connection.js
          connection_pool.js
          errors.js
          connect.js
          stream_description.js
          connection_pool_events.js.map
          commands.js.map
          stream_description.js.map
          connection_pool_events.js
          connection.js.map
          connection_pool.js.map
          metrics.js
          command_monitoring_events.js.map
          command_monitoring_events.js
          commands.js
          metrics.js.map
          errors.js.map
          connect.js.map
          handshake/
            client_metadata.js
            client_metadata.js.map
          auth/
            aws_temporary_credentials.js.map
            mongodb_oidc.js.map
            gssapi.js.map
            mongodb_oidc.js
            x509.js
            providers.js
            scram.js
            scram.js.map
            gssapi.js
            plain.js
            mongo_credentials.js
            mongo_credentials.js.map
            providers.js.map
            mongodb_aws.js
            auth_provider.js
            mongodb_aws.js.map
            x509.js.map
            plain.js.map
            aws_temporary_credentials.js
            auth_provider.js.map
            mongodb_oidc/
              azure_machine_workflow.js
              automated_callback_workflow.js
              callback_workflow.js
              callback_workflow.js.map
              token_machine_workflow.js.map
              token_cache.js
              command_builders.js
              human_callback_workflow.js
              k8s_machine_workflow.js
              gcp_machine_workflow.js.map
              automated_callback_workflow.js.map
              token_machine_workflow.js
              human_callback_workflow.js.map
              command_builders.js.map
              k8s_machine_workflow.js.map
              token_cache.js.map
              azure_machine_workflow.js.map
              gcp_machine_workflow.js
          wire_protocol/
            responses.js
            constants.js
            responses.js.map
            on_data.js.map
            shared.js
            constants.js.map
            shared.js.map
            compression.js.map
            compression.js
            on_data.js
            on_demand/
              document.js.map
              document.js
        sdam/
          server_description.js.map
          server_selection_events.js
          srv_polling.js.map
          topology_description.js
          server_selection.js
          server_description.js
          srv_polling.js
          events.js.map
          monitor.js.map
          topology.js
          common.js
          events.js
          common.js.map
          topology_description.js.map
          server_selection_events.js.map
          server.js
          monitor.js
          topology.js.map
          server_selection.js.map
          server.js.map
        operations/
          set_profiling_level.js
          remove_user.js
          get_more.js.map
          indexes.js
          count.js
          distinct.js.map
          find_and_modify.js.map
          count.js.map
          run_command.js
          run_command.js.map
          operation.js.map
          list_collections.js.map
          update.js
          estimated_document_count.js.map
          rename.js
          kill_cursors.js
          update.js.map
          find.js
          find.js.map
          list_databases.js
          stats.js.map
          get_more.js
          command.js.map
          rename.js.map
          drop.js
          insert.js
          execute_operation.js
          list_collections.js
          validate_collection.js.map
          aggregate.js
          aggregate.js.map
          execute_operation.js.map
          list_databases.js.map
          indexes.js.map
          distinct.js
          remove_user.js.map
          find_and_modify.js
          delete.js.map
          create_collection.js.map
          set_profiling_level.js.map
          kill_cursors.js.map
          profiling_level.js
          estimated_document_count.js
          drop.js.map
          validate_collection.js
          delete.js
          operation.js
          profiling_level.js.map
          insert.js.map
          stats.js
          command.js
          create_collection.js
          search_indexes/
            create.js.map
            update.js
            update.js.map
            create.js
            drop.js
            drop.js.map
          client_bulk_write/
            command_builder.js.map
            command_builder.js
            client_bulk_write.js
            results_merger.js.map
            executor.js.map
            common.js
            common.js.map
            results_merger.js
            client_bulk_write.js.map
            executor.js
        cursor/
          client_bulk_write_cursor.js
          list_search_indexes_cursor.js
          list_collections_cursor.js.map
          change_stream_cursor.js.map
          client_bulk_write_cursor.js.map
          list_search_indexes_cursor.js.map
          abstract_cursor.js
          list_indexes_cursor.js
          aggregation_cursor.js.map
          change_stream_cursor.js
          run_command_cursor.js.map
          explainable_cursor.js.map
          find_cursor.js.map
          find_cursor.js
          abstract_cursor.js.map
          run_command_cursor.js
          list_collections_cursor.js
          aggregation_cursor.js
          explainable_cursor.js
          list_indexes_cursor.js.map
        client-side-encryption/
          errors.js
          client_encryption.js
          mongocryptd_manager.js.map
          crypto_callbacks.js.map
          state_machine.js
          crypto_callbacks.js
          client_encryption.js.map
          state_machine.js.map
          mongocryptd_manager.js
          auto_encrypter.js.map
          auto_encrypter.js
          errors.js.map
          providers/
            azure.js.map
            gcp.js.map
            index.js.map
            aws.js
            gcp.js
            index.js
            aws.js.map
            azure.js
      etc/
        prepare.js
      src/
        index.ts
        mongo_client.ts
        resource_management.ts
        db.ts
        connection_string.ts
        encrypter.ts
        mongo_types.ts
        deps.ts
        beta.ts
        bson.ts
        transactions.ts
        mongo_client_auth_providers.ts
        sort.ts
        read_preference.ts
        mongo_logger.ts
        utils.ts
        timeout.ts
        read_concern.ts
        write_concern.ts
        collection.ts
        constants.ts
        error.ts
        admin.ts
        change_stream.ts
        sessions.ts
        explain.ts
        bulk/
          common.ts
          ordered.ts
          unordered.ts
        gridfs/
          index.ts
          download.ts
          upload.ts
        cmap/
          commands.ts
          connection_pool_events.ts
          stream_description.ts
          metrics.ts
          errors.ts
          connect.ts
          command_monitoring_events.ts
          connection_pool.ts
          connection.ts
          handshake/
            client_metadata.ts
          auth/
            mongodb_oidc.ts
            aws_temporary_credentials.ts
            providers.ts
            mongo_credentials.ts
            gssapi.ts
            x509.ts
            scram.ts
            auth_provider.ts
            plain.ts
            mongodb_aws.ts
            mongodb_oidc/
              callback_workflow.ts
              human_callback_workflow.ts
              token_machine_workflow.ts
              token_cache.ts
              automated_callback_workflow.ts
              azure_machine_workflow.ts
              gcp_machine_workflow.ts
              command_builders.ts
              k8s_machine_workflow.ts
          wire_protocol/
            compression.ts
            shared.ts
            responses.ts
            constants.ts
            on_data.ts
            on_demand/
              document.ts
        sdam/
          server_selection_events.ts
          common.ts
          server.ts
          topology.ts
          monitor.ts
          server_description.ts
          server_selection.ts
          srv_polling.ts
          topology_description.ts
          events.ts
        operations/
          get_more.ts
          find_and_modify.ts
          list_collections.ts
          distinct.ts
          find.ts
          delete.ts
          aggregate.ts
          estimated_document_count.ts
          run_command.ts
          rename.ts
          profiling_level.ts
          execute_operation.ts
          set_profiling_level.ts
          drop.ts
          indexes.ts
          list_databases.ts
          create_collection.ts
          validate_collection.ts
          stats.ts
          kill_cursors.ts
          count.ts
          operation.ts
          command.ts
          remove_user.ts
          update.ts
          insert.ts
          search_indexes/
            create.ts
            drop.ts
            update.ts
          client_bulk_write/
            common.ts
            client_bulk_write.ts
            executor.ts
            command_builder.ts
            results_merger.ts
        cursor/
          explainable_cursor.ts
          aggregation_cursor.ts
          list_collections_cursor.ts
          find_cursor.ts
          run_command_cursor.ts
          change_stream_cursor.ts
          list_indexes_cursor.ts
          client_bulk_write_cursor.ts
          list_search_indexes_cursor.ts
          abstract_cursor.ts
        client-side-encryption/
          crypto_callbacks.ts
          errors.ts
          mongocryptd_manager.ts
          auto_encrypter.ts
          state_machine.ts
          client_encryption.ts
          providers/
            index.ts
            azure.ts
            gcp.ts
            aws.ts
    @nodelib/
      fs.scandir/
        package.json
        LICENSE
        README.md
        out/
          constants.js
          settings.js
          settings.d.ts
          constants.d.ts
          index.d.ts
          index.js
          adapters/
            fs.d.ts
            fs.js
          utils/
            fs.d.ts
            index.d.ts
            index.js
            fs.js
          types/
            index.d.ts
            index.js
          providers/
            common.d.ts
            sync.js
            common.js
            sync.d.ts
            async.d.ts
            async.js
      fs.stat/
        package.json
        LICENSE
        README.md
        out/
          settings.js
          settings.d.ts
          index.d.ts
          index.js
          adapters/
            fs.d.ts
            fs.js
          types/
            index.d.ts
            index.js
          providers/
            sync.js
            sync.d.ts
            async.d.ts
            async.js
      fs.walk/
        package.json
        LICENSE
        README.md
        out/
          settings.js
          settings.d.ts
          index.d.ts
          index.js
          readers/
            common.d.ts
            reader.d.ts
            sync.js
            common.js
            sync.d.ts
            async.d.ts
            reader.js
            async.js
          types/
            index.d.ts
            index.js
          providers/
            stream.d.ts
            stream.js
            sync.js
            sync.d.ts
            async.d.ts
            index.d.ts
            index.js
            async.js
    side-channel-list/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      list.d.ts
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    strip-json-comments/
      package.json
      license
      readme.md
      index.js
    optionator/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      lib/
        util.js
        help.js
        index.js
    destroy/
      package.json
      LICENSE
      README.md
      index.js
    formdata-node/
      package.json
      license
      readme.md
      lib/
        node-domexception.d.ts
        cjs/
          browser.js
          package.json
          Blob.js
          File.js
          isBlob.js
          isFunction.js
          blobHelpers.js
          BlobPart.js
          fileFromPath.js
          isFile.js
          FormData.js
          index.js
          isPlainObject.js
          deprecateConstructorEntries.js
        esm/
          browser.js
          package.json
          Blob.js
          File.js
          isBlob.js
          isFunction.js
          blobHelpers.js
          BlobPart.js
          fileFromPath.js
          isFile.js
          FormData.js
          index.js
          isPlainObject.js
          deprecateConstructorEntries.js
      @type/
        isBlob.d.ts
        FormData.d.ts
        fileFromPath.d.ts
        isFunction.d.ts
        deprecateConstructorEntries.d.ts
        File.d.ts
        BlobPart.d.ts
        isFile.d.ts
        blobHelpers.d.ts
        Blob.d.ts
        index.d.ts
        browser.d.ts
        isPlainObject.d.ts
    default-browser-id/
      package.json
      license
      readme.md
      index.js
    object-inspect/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      .eslintrc
      test-core-js.js
      util.inspect.js
      index.js
      package-support.json
      readme.markdown
      test/
        number.js
        indent-option.js
        err.js
        inspect.js
        fakes.js
        undef.js
        values.js
        lowbyte.js
        bigint.js
        global.js
        has.js
        quoteStyle.js
        deep.js
        element.js
        circular.js
        fn.js
        toStringTag.js
        holes.js
        browser/
          dom.js
      .github/
        FUNDING.yml
      example/
        all.js
        inspect.js
        circular.js
        fn.js
    json-stringify-safe/
      package.json
      stringify.js
      LICENSE
      README.md
      test.js
    char-regex/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
    to-regex-range/
      package.json
      LICENSE
      README.md
      index.js
    charenc/
      package.json
      charenc.js
      README.js
      LICENSE.mkd
    google-logging-utils/
      package.json
      LICENSE
      README.md
      build/
        src/
          temporal.d.ts
          temporal.js.map
          colours.js.map
          logging-utils.d.ts
          colours.js
          logging-utils.js
          temporal.js
          index.js.map
          colours.d.ts
          index.d.ts
          index.js
          logging-utils.js.map
    side-channel-map/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    event-target-shim/
      package.json
      LICENSE
      README.md
      index.d.ts
      dist/
        event-target-shim.js.map
        event-target-shim.mjs
        event-target-shim.umd.js.map
        event-target-shim.js
        event-target-shim.mjs.map
        event-target-shim.umd.js
    lodash.isplainobject/
      package.json
      LICENSE
      README.md
      index.js
    available-typed-arrays/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    asn1/
      package.json
      LICENSE
      README.md
      .npmignore
      lib/
        index.js
        ber/
          errors.js
          writer.js
          reader.js
          types.js
          index.js
      tst/
        ber/
          writer.test.js
          reader.test.js
    object-is/
      CHANGELOG.md
      auto.js
      package.json
      LICENSE
      .nycrc
      polyfill.js
      README.md
      .eslintrc
      implementation.js
      index.js
      shim.js
      test/
        implementation.js
        index.js
        shimmed.js
        tests.js
    libphonenumber-js/
      CHANGELOG.md
      index.d.cts
      package.json
      .gitlab-ci.yml
      examples.mobile.json.d.ts
      types.d.cts
      rollup.config.mjs
      autoupdate.cmd
      AUTHORS
      metadata.mobile.json
      CODE_OF_CONDUCT.md
      autoupdate.sh
      LICENSE
      LICENSE.Apache
      custom.js
      types.d.ts
      metadata.full.json.d.ts
      metadata.max.json.d.ts
      metadata.min.json.d.cts
      index.cjs.js
      metadata.max.json.d.cts
      .nycrc
      custom.d.ts
      examples.mobile.json.d.cts
      README.md
      metadata.mobile.json.js
      examples.mobile.json
      .babelrc
      metadata.full.json
      metadata.max.json
      jest.config.json
      metadata.mobile.json.d.cts
      metadata.full.json.d.cts
      METADATA.md
      examples.mobile.json.js
      metadata.max.json.js
      index.d.ts
      metadata.mobile.json.d.ts
      metadata.min.json
      index.js
      metadata.min.json.d.ts
      index.es6.js
      index.cjs
      metadata.min.json.js
      metadata.full.json.js
      max/
        index.d.cts
        package.json
        index.cjs.js
        index.d.ts
        index.js
        index.cjs
        metadata/
          package.json
          metadata.max.json.d.ts
          metadata.max.json.d.cts
          metadata.max.json
          metadata.max.json.js
        exports/
          findPhoneNumbersInText.js
          PhoneNumberMatcher.js
          searchPhoneNumbersInText.js
          Metadata.js
          getExampleNumber.js
          formatIncompletePhoneNumber.js
          isSupportedCountry.js
          withMetadataArgument.js
          AsYouType.js
          parsePhoneNumberWithError.js
          searchNumbers.js
          parsePhoneNumber.js
          validatePhoneNumberLength.js
          isValidPhoneNumber.js
          getExtPrefix.js
          isPossiblePhoneNumber.js
          PhoneNumber.js
          getCountries.js
          getCountryCallingCode.js
          findNumbers.js
      source/
        getCountries.test.js
        findPhoneNumbersInText.js
        parsePhoneNumberWithError_.js
        isPossible.test.js
        parse.test.js
        normalizeArguments.js
        PhoneNumberMatcher.js
        AsYouTypeFormatter.PatternMatcher.d.ts
        validatePhoneNumberLength.test.js
        isPossiblePhoneNumber.test.js
        searchPhoneNumbersInText.js
        AsYouTypeFormatter.PatternParser.d.ts
        constants.js
        getExampleNumber.js
        isPossible.js
        formatIncompletePhoneNumber.js
        PhoneNumberMatcher.test.js
        PhoneNumber.test.js
        AsYouTypeFormatter.PatternParser.test.js
        AsYouTypeFormatter.util.test.js
        AsYouTypeFormatter.complete.js
        AsYouType.js
        parseIncompletePhoneNumber.test.js
        searchPhoneNumbersInText.test.js
        getCountryCallingCode.test.js
        parsePhoneNumber_.js
        AsYouTypeFormatter.util.js
        ParseError.js
        isValid.test.js
        format.js
        parsePhoneNumberWithError.js
        AsYouTypeFormatter.PatternParser.js
        parsePhoneNumberWithError.test.js
        AsYouTypeFormatter.PatternMatcher.test.js
        format.test.js
        metadata.js
        parseIncompletePhoneNumber.js
        parsePhoneNumber.test.js
        parsePhoneNumber.js
        AsYouTypeFormatter.js
        validatePhoneNumberLength.js
        AsYouTypeState.js
        isValidPhoneNumber.js
        formatPhoneNumberForMobileDialing.js
        AsYouType.test.js
        findPhoneNumbersInText.test.js
        isPossiblePhoneNumber.js
        isValid.js
        metadata.test.js
        PhoneNumber.js
        formatIncompletePhoneNumber.test.js
        getCountries.js
        getExampleNumber.test.js
        getCountryCallingCode.js
        AsYouTypeFormatter.PatternMatcher.js
        AsYouTypeParser.js
        isValidPhoneNumber.test.js
        parse.js
        findNumbers/
          Leniency.js
          parsePreCandidate.js
          RegExpCache.js
          isValidPreCandidate.js
          LRUCache.js
          isValidCandidate.js
          util.js
          matchPhoneNumberStringAgainstPhoneNumber.js
          utf-8.js
          util.test.js
        tools/
          semver-compare.js
          semver-compare.test.js
        legacy/
          isPossibleNumber.js
          parse.test.js
          getNumberType.test.js
          findNumbers.test.js
          isValidNumber.js
          findPhoneNumbers.test.js
          searchNumbers.test.js
          getNumberType.js
          findPhoneNumbers.js
          format.js
          searchNumbers.js
          isPossibleNumber.test.js
          PhoneNumberSearch.js
          format.test.js
          findPhoneNumbersInitialImplementation.js
          isValidNumberForRegion_.js
          isValidNumberForRegion.test.js
          isValidNumberForRegion.js
          isValidNumber.test.js
          findNumbers.js
          parse.js
        helpers/
          extractCountryCallingCode.js
          isViablePhoneNumber.js
          mergeArrays.test.js
          getNumberType.test.js
          stripIddPrefix.test.js
          extractNationalNumber.test.js
          extractCountryCallingCodeFromInternationalNumberWithoutPlusSign.js
          applyInternationalSeparatorStyle.test.js
          getCountryByCallingCode.js
          matchesEntirely.js
          extractPhoneContext.js
          getNumberType.js
          parseDigits.js
          isObject.js
          extractNationalNumber.js
          mergeArrays.js
          getPossibleCountriesForNumber.js
          parseDigits.test.js
          extractPhoneContext.test.js
          getIddPrefix.js
          applyInternationalSeparatorStyle.js
          extractCountryCallingCode.test.js
          checkNumberLength.js
          extractFormattedPhoneNumberFromPossibleRfc3966NumberUri.js
          extractNationalNumberFromPossiblyIncompleteNumber.js
          extractNationalNumberFromPossiblyIncompleteNumber.test.js
          matchesEntirely.test.js
          formatNationalNumberUsingFormat.js
          stripIddPrefix.js
          getCountryByNationalNumber.js
          RFC3966.js
          RFC3966.test.js
          checkNumberLength.test.js
          extension/
            extractExtension.js
            createExtensionPattern.js
      core/
        index.d.cts
        package.json
        index.cjs.js
        index.d.ts
        index.js
        index.cjs
      build-scripts/
        create-commonjs-package-json-file.js
        check-for-metadata-changes-and-release.js
        create-js-file-for-json-file.js
        check-for-metadata-changes-and-create-pull-request.js
        generate-country-codes-list-in-typescript.js
        check-for-uncommitted-files.js
        generate-metadata-from-google-metadata.js
        pull-google-metadata.js
        create-metadata-update-branch.js
        helpers/
          exec.js
          getUncommittedChanges.js
          commit.js
          updateMetadataFromGoogleMetadata.js
          sendEmail.js
      build/
        getCountries.test.js
        findPhoneNumbersInText.js
        isValid.test.js.map
        package.json
        isPossiblePhoneNumber.test.js.map
        parsePhoneNumberWithError_.js
        isPossible.test.js
        parseIncompletePhoneNumber.test.js.map
        searchPhoneNumbersInText.test.js.map
        PhoneNumber.js.map
        parse.test.js
        normalizeArguments.js
        PhoneNumberMatcher.js
        getCountryCallingCode.js.map
        getCountries.js.map
        validatePhoneNumberLength.test.js
        isPossiblePhoneNumber.test.js
        searchPhoneNumbersInText.js
        AsYouType.js.map
        AsYouType.test.js.map
        AsYouTypeState.js.map
        getCountries.test.js.map
        constants.js
        getExampleNumber.js
        validatePhoneNumberLength.test.js.map
        isPossible.js
        AsYouTypeFormatter.util.test.js.map
        AsYouTypeFormatter.PatternParser.js.map
        formatIncompletePhoneNumber.js
        PhoneNumberMatcher.test.js
        AsYouTypeFormatter.PatternMatcher.test.js.map
        ParseError.js.map
        PhoneNumber.test.js
        AsYouTypeFormatter.PatternParser.test.js
        AsYouTypeFormatter.util.test.js
        PhoneNumberMatcher.test.js.map
        PhoneNumber.test.js.map
        constants.js.map
        AsYouTypeFormatter.complete.js
        getExampleNumber.test.js.map
        AsYouType.js
        getCountryCallingCode.test.js.map
        parseIncompletePhoneNumber.test.js
        searchPhoneNumbersInText.test.js
        getCountryCallingCode.test.js
        parsePhoneNumber_.js
        AsYouTypeFormatter.util.js
        parsePhoneNumberWithError.test.js.map
        parse.test.js.map
        parsePhoneNumber_.js.map
        ParseError.js
        AsYouTypeFormatter.util.js.map
        isValid.test.js
        format.js
        parsePhoneNumberWithError.js
        metadata.test.js.map
        isPossible.test.js.map
        normalizeArguments.js.map
        AsYouTypeFormatter.PatternMatcher.js.map
        AsYouTypeFormatter.PatternParser.js
        parsePhoneNumberWithError.test.js
        parsePhoneNumberWithError_.js.map
        AsYouTypeFormatter.PatternMatcher.test.js
        format.test.js
        formatPhoneNumberForMobileDialing.js.map
        validatePhoneNumberLength.js.map
        isPossiblePhoneNumber.js.map
        metadata.js
        parseIncompletePhoneNumber.js
        parsePhoneNumberWithError.js.map
        parsePhoneNumber.test.js
        findPhoneNumbersInText.test.js.map
        parsePhoneNumber.js
        formatIncompletePhoneNumber.js.map
        AsYouTypeParser.js.map
        isValidPhoneNumber.js.map
        AsYouTypeFormatter.js
        validatePhoneNumberLength.js
        AsYouTypeState.js
        isValidPhoneNumber.js
        PhoneNumberMatcher.js.map
        formatPhoneNumberForMobileDialing.js
        AsYouType.test.js
        AsYouTypeFormatter.PatternParser.test.js.map
        findPhoneNumbersInText.test.js
        AsYouTypeFormatter.complete.js.map
        isPossiblePhoneNumber.js
        isValid.js
        getExampleNumber.js.map
        format.js.map
        metadata.test.js
        metadata.js.map
        PhoneNumber.js
        formatIncompletePhoneNumber.test.js
        getCountries.js
        isPossible.js.map
        getExampleNumber.test.js
        getCountryCallingCode.js
        isValid.js.map
        findPhoneNumbersInText.js.map
        AsYouTypeFormatter.PatternMatcher.js
        format.test.js.map
        parse.js.map
        AsYouTypeParser.js
        parseIncompletePhoneNumber.js.map
        parsePhoneNumber.test.js.map
        isValidPhoneNumber.test.js.map
        formatIncompletePhoneNumber.test.js.map
        searchPhoneNumbersInText.js.map
        AsYouTypeFormatter.js.map
        isValidPhoneNumber.test.js
        parse.js
        parsePhoneNumber.js.map
        findNumbers/
          isValidCandidate.js.map
          parsePreCandidate.js.map
          RegExpCache.js.map
          isValidPreCandidate.js.map
          Leniency.js
          matchPhoneNumberStringAgainstPhoneNumber.js.map
          util.js.map
          parsePreCandidate.js
          utf-8.js.map
          Leniency.js.map
          RegExpCache.js
          isValidPreCandidate.js
          LRUCache.js.map
          LRUCache.js
          isValidCandidate.js
          util.js
          matchPhoneNumberStringAgainstPhoneNumber.js
          utf-8.js
          util.test.js
          util.test.js.map
        tools/
          semver-compare.js
          semver-compare.test.js
          semver-compare.js.map
          semver-compare.test.js.map
        legacy/
          isPossibleNumber.js
          parse.test.js
          getNumberType.test.js
          isValidNumberForRegion.js.map
          findNumbers.test.js
          findPhoneNumbersInitialImplementation.js.map
          isValidNumber.js.map
          isValidNumber.js
          isPossibleNumber.js.map
          findPhoneNumbers.test.js
          PhoneNumberSearch.js.map
          searchNumbers.test.js
          getNumberType.js
          parse.test.js.map
          findPhoneNumbers.js
          format.js
          isPossibleNumber.test.js.map
          searchNumbers.js
          isPossibleNumber.test.js
          PhoneNumberSearch.js
          format.test.js
          searchNumbers.test.js.map
          findNumbers.js.map
          findPhoneNumbersInitialImplementation.js
          isValidNumberForRegion_.js
          isValidNumber.test.js.map
          findNumbers.test.js.map
          getNumberType.js.map
          format.js.map
          isValidNumberForRegion.test.js
          isValidNumberForRegion.test.js.map
          findPhoneNumbers.test.js.map
          searchNumbers.js.map
          isValidNumberForRegion_.js.map
          format.test.js.map
          parse.js.map
          isValidNumberForRegion.js
          isValidNumber.test.js
          findNumbers.js
          parse.js
          findPhoneNumbers.js.map
          getNumberType.test.js.map
        helpers/
          extractCountryCallingCode.js
          isViablePhoneNumber.js
          mergeArrays.test.js
          getNumberType.test.js
          extractPhoneContext.js.map
          extractNationalNumber.test.js.map
          extractNationalNumber.js.map
          stripIddPrefix.test.js
          extractCountryCallingCode.js.map
          applyInternationalSeparatorStyle.test.js.map
          getCountryByCallingCode.js.map
          getCountryByNationalNumber.js.map
          extractNationalNumber.test.js
          extractCountryCallingCodeFromInternationalNumberWithoutPlusSign.js
          stripIddPrefix.js.map
          applyInternationalSeparatorStyle.test.js
          getCountryByCallingCode.js
          matchesEntirely.js
          extractPhoneContext.js
          mergeArrays.js.map
          getNumberType.js
          extractCountryCallingCode.test.js.map
          parseDigits.js
          isObject.js
          extractNationalNumber.js
          mergeArrays.js
          RFC3966.test.js.map
          getPossibleCountriesForNumber.js
          matchesEntirely.test.js.map
          formatNationalNumberUsingFormat.js.map
          getPossibleCountriesForNumber.js.map
          parseDigits.test.js
          matchesEntirely.js.map
          getIddPrefix.js.map
          checkNumberLength.test.js.map
          extractPhoneContext.test.js
          getIddPrefix.js
          applyInternationalSeparatorStyle.js
          extractCountryCallingCode.test.js
          extractPhoneContext.test.js.map
          checkNumberLength.js
          checkNumberLength.js.map
          extractFormattedPhoneNumberFromPossibleRfc3966NumberUri.js
          stripIddPrefix.test.js.map
          extractNationalNumberFromPossiblyIncompleteNumber.test.js.map
          applyInternationalSeparatorStyle.js.map
          isViablePhoneNumber.js.map
          getNumberType.js.map
          extractNationalNumberFromPossiblyIncompleteNumber.js
          extractCountryCallingCodeFromInternationalNumberWithoutPlusSign.js.map
          isObject.js.map
          RFC3966.js.map
          parseDigits.test.js.map
          parseDigits.js.map
          extractFormattedPhoneNumberFromPossibleRfc3966NumberUri.js.map
          extractNationalNumberFromPossiblyIncompleteNumber.test.js
          matchesEntirely.test.js
          formatNationalNumberUsingFormat.js
          stripIddPrefix.js
          extractNationalNumberFromPossiblyIncompleteNumber.js.map
          getCountryByNationalNumber.js
          RFC3966.js
          mergeArrays.test.js.map
          RFC3966.test.js
          checkNumberLength.test.js
          getNumberType.test.js.map
          extension/
            extractExtension.js
            createExtensionPattern.js.map
            extractExtension.js.map
            createExtensionPattern.js
      mobile/
        index.d.cts
        package.json
        index.cjs.js
        index.d.ts
        index.js
        index.cjs
        examples/
          package.json
          examples.mobile.json.d.ts
          examples.mobile.json.d.cts
          examples.mobile.json
          examples.mobile.json.js
        metadata/
          package.json
          metadata.mobile.json
          metadata.mobile.json.js
          metadata.mobile.json.d.cts
          metadata.mobile.json.d.ts
        exports/
          findPhoneNumbersInText.js
          PhoneNumberMatcher.js
          searchPhoneNumbersInText.js
          Metadata.js
          getExampleNumber.js
          formatIncompletePhoneNumber.js
          isSupportedCountry.js
          withMetadataArgument.js
          AsYouType.js
          parsePhoneNumberWithError.js
          searchNumbers.js
          parsePhoneNumber.js
          validatePhoneNumberLength.js
          isValidPhoneNumber.js
          getExtPrefix.js
          isPossiblePhoneNumber.js
          PhoneNumber.js
          getCountries.js
          getCountryCallingCode.js
          findNumbers.js
      min/
        index.d.cts
        package.json
        index.cjs.js
        index.d.ts
        index.js
        index.cjs
        metadata/
          package.json
          metadata.min.json.d.cts
          metadata.min.json
          metadata.min.json.d.ts
          metadata.min.json.js
        exports/
          findPhoneNumbersInText.js
          PhoneNumberMatcher.js
          searchPhoneNumbersInText.js
          Metadata.js
          getExampleNumber.js
          formatIncompletePhoneNumber.js
          isSupportedCountry.js
          withMetadataArgument.js
          AsYouType.js
          parsePhoneNumberWithError.js
          searchNumbers.js
          parsePhoneNumber.js
          validatePhoneNumberLength.js
          isValidPhoneNumber.js
          getExtPrefix.js
          isPossiblePhoneNumber.js
          PhoneNumber.js
          getCountries.js
          getCountryCallingCode.js
          findNumbers.js
      es6/
        getCountries.test.js
        findPhoneNumbersInText.js
        isValid.test.js.map
        isPossiblePhoneNumber.test.js.map
        parsePhoneNumberWithError_.js
        isPossible.test.js
        parseIncompletePhoneNumber.test.js.map
        searchPhoneNumbersInText.test.js.map
        PhoneNumber.js.map
        parse.test.js
        normalizeArguments.js
        PhoneNumberMatcher.js
        getCountryCallingCode.js.map
        getCountries.js.map
        validatePhoneNumberLength.test.js
        isPossiblePhoneNumber.test.js
        searchPhoneNumbersInText.js
        AsYouType.js.map
        AsYouType.test.js.map
        AsYouTypeState.js.map
        getCountries.test.js.map
        constants.js
        getExampleNumber.js
        validatePhoneNumberLength.test.js.map
        isPossible.js
        AsYouTypeFormatter.util.test.js.map
        AsYouTypeFormatter.PatternParser.js.map
        formatIncompletePhoneNumber.js
        PhoneNumberMatcher.test.js
        AsYouTypeFormatter.PatternMatcher.test.js.map
        ParseError.js.map
        PhoneNumber.test.js
        AsYouTypeFormatter.PatternParser.test.js
        AsYouTypeFormatter.util.test.js
        PhoneNumberMatcher.test.js.map
        PhoneNumber.test.js.map
        constants.js.map
        AsYouTypeFormatter.complete.js
        getExampleNumber.test.js.map
        AsYouType.js
        getCountryCallingCode.test.js.map
        parseIncompletePhoneNumber.test.js
        searchPhoneNumbersInText.test.js
        getCountryCallingCode.test.js
        parsePhoneNumber_.js
        AsYouTypeFormatter.util.js
        parsePhoneNumberWithError.test.js.map
        parse.test.js.map
        parsePhoneNumber_.js.map
        ParseError.js
        AsYouTypeFormatter.util.js.map
        isValid.test.js
        format.js
        parsePhoneNumberWithError.js
        metadata.test.js.map
        isPossible.test.js.map
        normalizeArguments.js.map
        AsYouTypeFormatter.PatternMatcher.js.map
        AsYouTypeFormatter.PatternParser.js
        parsePhoneNumberWithError.test.js
        parsePhoneNumberWithError_.js.map
        AsYouTypeFormatter.PatternMatcher.test.js
        format.test.js
        formatPhoneNumberForMobileDialing.js.map
        validatePhoneNumberLength.js.map
        isPossiblePhoneNumber.js.map
        metadata.js
        parseIncompletePhoneNumber.js
        parsePhoneNumberWithError.js.map
        parsePhoneNumber.test.js
        findPhoneNumbersInText.test.js.map
        parsePhoneNumber.js
        formatIncompletePhoneNumber.js.map
        AsYouTypeParser.js.map
        isValidPhoneNumber.js.map
        AsYouTypeFormatter.js
        validatePhoneNumberLength.js
        AsYouTypeState.js
        isValidPhoneNumber.js
        PhoneNumberMatcher.js.map
        formatPhoneNumberForMobileDialing.js
        AsYouType.test.js
        AsYouTypeFormatter.PatternParser.test.js.map
        findPhoneNumbersInText.test.js
        AsYouTypeFormatter.complete.js.map
        isPossiblePhoneNumber.js
        isValid.js
        getExampleNumber.js.map
        format.js.map
        metadata.test.js
        metadata.js.map
        PhoneNumber.js
        formatIncompletePhoneNumber.test.js
        getCountries.js
        isPossible.js.map
        getExampleNumber.test.js
        getCountryCallingCode.js
        isValid.js.map
        findPhoneNumbersInText.js.map
        AsYouTypeFormatter.PatternMatcher.js
        format.test.js.map
        parse.js.map
        AsYouTypeParser.js
        parseIncompletePhoneNumber.js.map
        parsePhoneNumber.test.js.map
        isValidPhoneNumber.test.js.map
        formatIncompletePhoneNumber.test.js.map
        searchPhoneNumbersInText.js.map
        AsYouTypeFormatter.js.map
        isValidPhoneNumber.test.js
        parse.js
        parsePhoneNumber.js.map
        findNumbers/
          isValidCandidate.js.map
          parsePreCandidate.js.map
          RegExpCache.js.map
          isValidPreCandidate.js.map
          Leniency.js
          matchPhoneNumberStringAgainstPhoneNumber.js.map
          util.js.map
          parsePreCandidate.js
          utf-8.js.map
          Leniency.js.map
          RegExpCache.js
          isValidPreCandidate.js
          LRUCache.js.map
          LRUCache.js
          isValidCandidate.js
          util.js
          matchPhoneNumberStringAgainstPhoneNumber.js
          utf-8.js
          util.test.js
          util.test.js.map
        tools/
          semver-compare.js
          semver-compare.test.js
          semver-compare.js.map
          semver-compare.test.js.map
        legacy/
          isPossibleNumber.js
          parse.test.js
          getNumberType.test.js
          isValidNumberForRegion.js.map
          findNumbers.test.js
          findPhoneNumbersInitialImplementation.js.map
          isValidNumber.js.map
          isValidNumber.js
          isPossibleNumber.js.map
          findPhoneNumbers.test.js
          PhoneNumberSearch.js.map
          searchNumbers.test.js
          getNumberType.js
          parse.test.js.map
          findPhoneNumbers.js
          format.js
          isPossibleNumber.test.js.map
          searchNumbers.js
          isPossibleNumber.test.js
          PhoneNumberSearch.js
          format.test.js
          searchNumbers.test.js.map
          findNumbers.js.map
          findPhoneNumbersInitialImplementation.js
          isValidNumberForRegion_.js
          isValidNumber.test.js.map
          findNumbers.test.js.map
          getNumberType.js.map
          format.js.map
          isValidNumberForRegion.test.js
          isValidNumberForRegion.test.js.map
          findPhoneNumbers.test.js.map
          searchNumbers.js.map
          isValidNumberForRegion_.js.map
          format.test.js.map
          parse.js.map
          isValidNumberForRegion.js
          isValidNumber.test.js
          findNumbers.js
          parse.js
          findPhoneNumbers.js.map
          getNumberType.test.js.map
        helpers/
          extractCountryCallingCode.js
          isViablePhoneNumber.js
          mergeArrays.test.js
          getNumberType.test.js
          extractPhoneContext.js.map
          extractNationalNumber.test.js.map
          extractNationalNumber.js.map
          stripIddPrefix.test.js
          extractCountryCallingCode.js.map
          applyInternationalSeparatorStyle.test.js.map
          getCountryByCallingCode.js.map
          getCountryByNationalNumber.js.map
          extractNationalNumber.test.js
          extractCountryCallingCodeFromInternationalNumberWithoutPlusSign.js
          stripIddPrefix.js.map
          applyInternationalSeparatorStyle.test.js
          getCountryByCallingCode.js
          matchesEntirely.js
          extractPhoneContext.js
          mergeArrays.js.map
          getNumberType.js
          extractCountryCallingCode.test.js.map
          parseDigits.js
          isObject.js
          extractNationalNumber.js
          mergeArrays.js
          RFC3966.test.js.map
          getPossibleCountriesForNumber.js
          matchesEntirely.test.js.map
          formatNationalNumberUsingFormat.js.map
          getPossibleCountriesForNumber.js.map
          parseDigits.test.js
          matchesEntirely.js.map
          getIddPrefix.js.map
          checkNumberLength.test.js.map
          extractPhoneContext.test.js
          getIddPrefix.js
          applyInternationalSeparatorStyle.js
          extractCountryCallingCode.test.js
          extractPhoneContext.test.js.map
          checkNumberLength.js
          checkNumberLength.js.map
          extractFormattedPhoneNumberFromPossibleRfc3966NumberUri.js
          stripIddPrefix.test.js.map
          extractNationalNumberFromPossiblyIncompleteNumber.test.js.map
          applyInternationalSeparatorStyle.js.map
          isViablePhoneNumber.js.map
          getNumberType.js.map
          extractNationalNumberFromPossiblyIncompleteNumber.js
          extractCountryCallingCodeFromInternationalNumberWithoutPlusSign.js.map
          isObject.js.map
          RFC3966.js.map
          parseDigits.test.js.map
          parseDigits.js.map
          extractFormattedPhoneNumberFromPossibleRfc3966NumberUri.js.map
          extractNationalNumberFromPossiblyIncompleteNumber.test.js
          matchesEntirely.test.js
          formatNationalNumberUsingFormat.js
          stripIddPrefix.js
          extractNationalNumberFromPossiblyIncompleteNumber.js.map
          getCountryByNationalNumber.js
          RFC3966.js
          mergeArrays.test.js.map
          RFC3966.test.js
          checkNumberLength.test.js
          getNumberType.test.js.map
          extension/
            extractExtension.js
            createExtensionPattern.js.map
            extractExtension.js.map
            createExtensionPattern.js
      bundle/
        libphonenumber-mobile.js
        libphonenumber-min.js.map
        libphonenumber-js.min.js.map
        libphonenumber-mobile.js.map
        libphonenumber-max.js.map
        libphonenumber-min.js
        libphonenumber-max.js
        libphonenumber-js.min.js
      index.es6.exports/
        isPossibleNumber.js
        isValidNumber.js
        getNumberType.js
        searchPhoneNumbers.js
        findPhoneNumbers.js
        format.js
        PhoneNumberSearch.js
        isValidNumberForRegion.js
        parse.js
    pump/
      package.json
      SECURITY.md
      LICENSE
      test-node.js
      README.md
      .travis.yml
      index.js
      test-browser.js
      .github/
        FUNDING.yml
    utile/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      .npmignore
      .travis.yml
      lib/
        base64.js
        format.js
        file.js
        index.js
        args.js
      test/
        utile-test.js
        format-test.js
        require-directory-test.js
        file-test.js
        function-args-test.js
        random-string-test.js
        fixtures/
          require-directory/
            helloWorld.js
            directory/
              index.js
          read-json-file/
            config.json
        helpers/
          macros.js
      node_modules/
        glob/
          package.json
          LICENSE
          sync.js
          README.md
          common.js
          glob.js
        mkdirp/
          package.json
          LICENSE
          index.js
          readme.markdown
          bin/
            usage.txt
            cmd.js
        async/
          bower.json
          package.json
          component.json
          LICENSE
          README.md
          .travis.yml
          lib/
            async.js
          support/
            sync-package-managers.js
        .bin/
          mkdirp
          rimraf
        rimraf/
          package.json
          bin.js
          rimraf.js
          LICENSE
          README.md
    chownr/
      chownr.js
      package.json
      LICENSE
      README.md
    kiss-date/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      dist/
        bundle.js
      lib/
        index.js.map
        index.d.ts
        index.js
      es/
        index.js.map
        index.js
    set-function-length/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      env.d.ts
      env.js
      index.js
      .github/
        FUNDING.yml
    ctype/
      package.json
      README
      LICENSE
      .npmignore
      README.old
      ctype.js
      ctio.js
      CHANGELOG
      ctf.js
      man/
        man3ctype/
          ctio.3ctype
      tools/
        jsstyle
        jsl.conf
    lodash.isstring/
      package.json
      LICENSE
      README.md
      index.js
    rc/
      browser.js
      package.json
      LICENSE.BSD
      README.md
      LICENSE.APACHE2
      cli.js
      index.js
      LICENSE.MIT
      lib/
        utils.js
      test/
        ini.js
        test.js
        nested-env-vars.js
    math-intrinsics/
      CHANGELOG.md
      package.json
      floor.js
      abs.js
      sign.d.ts
      round.d.ts
      pow.d.ts
      mod.d.ts
      LICENSE
      pow.js
      tsconfig.json
      floor.d.ts
      isNaN.d.ts
      isNegativeZero.js
      isNaN.js
      max.js
      isFinite.d.ts
      min.d.ts
      README.md
      sign.js
      .eslintrc
      abs.d.ts
      isInteger.d.ts
      round.js
      isInteger.js
      mod.js
      isFinite.js
      min.js
      isNegativeZero.d.ts
      max.d.ts
      constants/
        maxValue.d.ts
        maxSafeInteger.d.ts
        maxSafeInteger.js
        maxValue.js
        maxArrayLength.d.ts
        maxArrayLength.js
      test/
        index.js
      .github/
        FUNDING.yml
    is-nan/
      CHANGELOG.md
      auto.js
      package.json
      LICENSE
      .nycrc
      polyfill.js
      README.md
      .eslintignore
      .eslintrc
      implementation.js
      index.js
      shim.js
      test/
        index.js
        shimmed.js
        tests.js
      .github/
        FUNDING.yml
    buffer-equal-constant-time/
      package.json
      README.md
      .npmignore
      test.js
      .travis.yml
      LICENSE.txt
      index.js
    ee-first/
      package.json
      LICENSE
      README.md
      index.js
    side-channel/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    npm-run-path/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    uid2/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    resolve/
      package.json
      SECURITY.md
      LICENSE
      sync.js
      .eslintrc
      .editorconfig
      index.js
      async.js
      readme.markdown
      lib/
        node-modules-paths.js
        core.js
        homedir.js
        normalize-options.js
        caller.js
        sync.js
        core.json
        is-core.js
        async.js
      test/
        mock_sync.js
        nonstring.js
        node-modules-paths.js
        resolver_sync.js
        resolver.js
        node_path.js
        core.js
        dotdot.js
        home_paths.js
        filter.js
        symlinks.js
        filter_sync.js
        subdirs.js
        precedence.js
        faulty_basedir.js
        home_paths_sync.js
        shadowed_core.js
        module_dir.js
        pathfilter.js
        mock.js
        shadowed_core/
          node_modules/
            util/
              index.js
        node_path/
          y/
            bbb/
              index.js
            ccc/
              index.js
          x/
            ccc/
              index.js
            aaa/
              index.js
        resolver/
          mug.coffee
          mug.js
          foo.js
          cup.coffee
          baz/
            package.json
            doom.js
            quux.js
          quux/
            foo/
              index.js
          browser_field/
            package.json
            b.js
            a.js
          same_names/
            foo.js
            foo/
              index.js
          invalid_main/
            package.json
          other_path/
            root.js
            lib/
              other-lib.js
          multirepo/
            package.json
            lerna.json
            packages/
          dot_slash_main/
            package.json
            index.js
          false_main/
            package.json
            index.js
          without_basedir/
            main.js
          symlinked/
            _/
            package/
              package.json
              bar.js
          nested_symlinks/
            mylib/
              package.json
              sync.js
              async.js
          incorrect_main/
            package.json
            index.js
          dot_main/
            package.json
            index.js
        dotdot/
          index.js
          abc/
            index.js
        pathfilter/
          deep_ref/
            main.js
        module_dir/
          xmodules/
            aaa/
              index.js
          zmodules/
            bbb/
              package.json
              main.js
          ymodules/
            aaa/
              index.js
        precedence/
          aaa.js
          bbb.js
          bbb/
            main.js
          aaa/
            index.js
            main.js
      bin/
        resolve
      .github/
        THREAT_MODEL.md
        FUNDING.yml
        INCIDENT_RESPONSE_PROCESS.md
      example/
        sync.js
        async.js
      node_modules/
        is-core-module/
          CHANGELOG.md
          package.json
          LICENSE
          .nycrc
          README.md
          .eslintrc
          core.json
          index.js
          test/
            index.js
    es-define-property/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    slash/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    expand-template/
      package.json
      LICENSE
      README.md
      test.js
      .travis.yml
      index.js
    jws/
      CHANGELOG.md
      package.json
      LICENSE
      readme.md
      index.js
      opslevel.yml
      lib/
        verify-stream.js
        data-stream.js
        sign-stream.js
        tostring.js
    methods/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    esprima/
      package.json
      LICENSE.BSD
      ChangeLog
      README.md
      dist/
        esprima.js
      bin/
        esparse.js
        esvalidate.js
    assert/
      package.json
      LICENSE
      README.md
      build/
        assert.js
        internal/
          errors.js
          assert/
            assertion_error.js
          util/
            comparisons.js
    string_decoder/
      package.json
      LICENSE
      README.md
      .travis.yml
      lib/
        string_decoder.js
      node_modules/
        safe-buffer/
          package.json
          LICENSE
          README.md
          index.d.ts
          index.js
    vary/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    is-buffer/
      package.json
      LICENSE
      README.md
      index.js
      test/
        basic.js
    string-width-cjs/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    path-to-regexp/
      package.json
      Readme.md
      LICENSE
      index.js
    multimatch/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    ms/
      package.json
      license.md
      readme.md
      index.js
    simple-concat/
      package.json
      LICENSE
      README.md
      .travis.yml
      index.js
      test/
        basic.js
    eslint-visitor-keys/
      package.json
      LICENSE
      README.md
      dist/
        visitor-keys.d.ts
        eslint-visitor-keys.d.cts
        index.d.ts
        eslint-visitor-keys.cjs
      lib/
        visitor-keys.js
        index.js
    get-proto/
      CHANGELOG.md
      package.json
      Reflect.getPrototypeOf.js
      Object.getPrototypeOf.d.ts
      LICENSE
      tsconfig.json
      Reflect.getPrototypeOf.d.ts
      .nycrc
      README.md
      .eslintrc
      Object.getPrototypeOf.js
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    color-name/
      package.json
      LICENSE
      README.md
      index.js
    is-inside-container/
      package.json
      license
      cli.js
      readme.md
      index.d.ts
      index.js
    word-wrap/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
    has-tostringtag/
      CHANGELOG.md
      package.json
      shams.js
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      shams.d.ts
      index.js
      test/
        index.js
        tests.js
        shams/
          get-own-property-symbols.js
          core-js.js
      .github/
        FUNDING.yml
    wrap-ansi/
      package.json
      license
      readme.md
      index.js
    ipaddr.js/
      package.json
      LICENSE
      README.md
      ipaddr.min.js
      lib/
        ipaddr.js
        ipaddr.js.d.ts
    strip-ansi-cjs/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    combined-stream/
      package.json
      Readme.md
      yarn.lock
      License
      lib/
        combined_stream.js
    to-fast-properties/
      package.json
      license
      readme.md
      index.js
    cookie-session/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    mpath/
      package.json
      SECURITY.md
      LICENSE
      README.md
      .travis.yml
      History.md
      index.js
      lib/
        index.js
        stringToParts.js
      test/
        .eslintrc.yml
        index.js
        stringToParts.js
    proxy-addr/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    is-arguments/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    bson/
      bson.d.ts
      package.json
      README.md
      LICENSE.md
      lib/
        bson.node.mjs
        bson.cjs
        bson.rn.cjs.map
        bson.node.mjs.map
        bson.cjs.map
        bson.mjs
        bson.bundle.js
        bson.rn.cjs
        bson.mjs.map
        bson.bundle.js.map
      vendor/
        base64/
          package.json
          LICENSE-MIT.txt
          base64.js
          README.md
        text-encoding/
          package.json
          README.md
          index.js
          LICENSE.md
          lib/
            encoding.js
            encoding-indexes.js
      etc/
        prepare.js
      src/
        index.ts
        binary.ts
        decimal128.ts
        parse_utf8.ts
        int_32.ts
        bson_value.ts
        symbol.ts
        extended_json.ts
        bson.ts
        double.ts
        long.ts
        timestamp.ts
        db_ref.ts
        constants.ts
        error.ts
        regexp.ts
        max_key.ts
        objectid.ts
        code.ts
        min_key.ts
        parser/
          serializer.ts
          utils.ts
          calculate_size.ts
          deserializer.ts
          on_demand/
            index.ts
            parse_to_elements.ts
        utils/
          string_utils.ts
          latin.ts
          number_utils.ts
          byte_utils.ts
          web_byte_utils.ts
          node_byte_utils.ts
    @mongodb-js/
      saslprep/
        package.json
        LICENSE
        readme.md
        dist/
          browser.js
          generate-code-points.js.map
          memory-code-points.d.ts.map
          code-points-data.js.map
          node.js.map
          code-points-src.d.ts
          generate-code-points.d.ts.map
          util.js.map
          util.d.ts
          util.d.ts.map
          memory-code-points.js
          code-points-data-browser.js
          code-points-src.js
          generate-code-points.d.ts
          node.d.ts
          code-points-data-browser.d.ts
          node.js
          code-points-data.d.ts
          browser.d.ts.map
          code-points-data.js
          util.js
          memory-code-points.js.map
          index.js.map
          node.d.ts.map
          browser.js.map
          index.d.ts
          generate-code-points.js
          memory-code-points.d.ts
          code-points-data-browser.js.map
          index.js
          browser.d.ts
          index.d.ts.map
          code-points-data.d.ts.map
          .esm-wrapper.mjs
          code-points-data-browser.d.ts.map
          code-points-src.js.map
          code-points-src.d.ts.map
    fast-deep-equal/
      package.json
      LICENSE
      README.md
      react.d.ts
      react.js
      index.d.ts
      index.js
      es6/
        react.d.ts
        react.js
        index.d.ts
        index.js
    regenerator-runtime/
      package.json
      LICENSE
      path.js
      README.md
      runtime.js
    path-parse/
      package.json
      LICENSE
      README.md
      index.js
    whatwg-url/
      package.json
      README.md
      webidl2js-wrapper.js
      LICENSE.txt
      index.js
      lib/
        utils.js
        URL-impl.js
        Function.js
        URLSearchParams-impl.js
        infra.js
        urlencoded.js
        percent-encoding.js
        URL.js
        encoding.js
        URLSearchParams.js
        VoidFunction.js
        url-state-machine.js
    for-each/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        test.js
      .github/
        SECURITY.md
        FUNDING.yml
    openai/
      CHANGELOG.md
      streaming.d.ts.map
      pagination.js.map
      package.json
      pagination.d.ts
      core.js
      resources.js
      pagination.js
      index.mjs
      core.d.ts.map
      resources.mjs.map
      uploads.js.map
      LICENSE
      core.mjs.map
      uploads.d.ts.map
      resource.js
      error.js
      version.d.ts.map
      uploads.mjs
      streaming.js
      uploads.mjs.map
      README.md
      resource.mjs.map
      version.mjs
      streaming.mjs.map
      uploads.js
      core.mjs
      error.d.ts.map
      core.js.map
      resource.js.map
      uploads.d.ts
      error.mjs.map
      index.js.map
      version.js.map
      core.d.ts
      streaming.js.map
      index.d.ts
      resources.d.ts.map
      pagination.d.ts.map
      resources.mjs
      error.js.map
      error.d.ts
      resource.d.ts
      streaming.d.ts
      resources.js.map
      streaming.mjs
      version.d.ts
      index.js
      index.d.ts.map
      resources.d.ts
      error.mjs
      index.mjs.map
      index.d.mts
      resource.mjs
      version.mjs.map
      pagination.mjs.map
      pagination.mjs
      version.js
      resource.d.ts.map
      lib/
        Util.d.ts
        chatCompletionUtils.d.ts.map
        AbstractChatCompletionRunner.d.ts.map
        parser.d.ts.map
        parser.js.map
        AssistantStream.d.ts
        Util.js.map
        AbstractChatCompletionRunner.js.map
        RunnableFunction.d.ts
        Util.d.ts.map
        parser.mjs.map
        EventEmitter.js.map
        EventStream.mjs
        AssistantStream.js
        ResponsesParser.js
        RunnableFunction.js.map
        EventStream.d.ts
        EventEmitter.d.ts.map
        ChatCompletionStreamingRunner.js.map
        jsonschema.mjs.map
        jsonschema.js.map
        ChatCompletionRunner.js.map
        RunnableFunction.js
        ChatCompletionStream.d.ts
        ChatCompletionStreamingRunner.mjs
        ChatCompletionRunner.d.ts.map
        jsonschema.js
        chatCompletionUtils.js.map
        ChatCompletionRunner.mjs.map
        ChatCompletionStream.mjs.map
        AssistantStream.mjs
        EventStream.d.ts.map
        Util.mjs.map
        chatCompletionUtils.mjs.map
        EventEmitter.mjs.map
        AbstractChatCompletionRunner.js
        Util.mjs
        ChatCompletionRunner.js
        RunnableFunction.mjs.map
        parser.js
        parser.d.ts
        ChatCompletionStream.js
        ChatCompletionRunner.mjs
        EventStream.js.map
        jsonschema.d.ts.map
        EventStream.mjs.map
        ChatCompletionStream.d.ts.map
        AbstractChatCompletionRunner.d.ts
        AssistantStream.mjs.map
        jsonschema.d.ts
        ResponsesParser.d.ts
        ResponsesParser.mjs
        EventEmitter.mjs
        EventStream.js
        RunnableFunction.mjs
        chatCompletionUtils.mjs
        ChatCompletionRunner.d.ts
        AssistantStream.d.ts.map
        ResponsesParser.d.ts.map
        EventEmitter.d.ts
        ChatCompletionStreamingRunner.js
        EventEmitter.js
        ChatCompletionStreamingRunner.mjs.map
        AbstractChatCompletionRunner.mjs
        ChatCompletionStream.mjs
        ResponsesParser.mjs.map
        ChatCompletionStreamingRunner.d.ts
        ResponsesParser.js.map
        RunnableFunction.d.ts.map
        Util.js
        ChatCompletionStream.js.map
        parser.mjs
        ChatCompletionStreamingRunner.d.ts.map
        jsonschema.mjs
        chatCompletionUtils.d.ts
        chatCompletionUtils.js
        AssistantStream.js.map
        AbstractChatCompletionRunner.mjs.map
        responses/
          EventTypes.d.ts
          EventTypes.mjs.map
          ResponseStream.js.map
          ResponseStream.mjs.map
          EventTypes.js
          ResponseStream.d.ts.map
          ResponseStream.js
          ResponseStream.d.ts
          EventTypes.js.map
          ResponseStream.mjs
          EventTypes.d.ts.map
          EventTypes.mjs
      beta/
        realtime/
          ws.js
          ws.d.ts
          internal-base.mjs.map
          ws.d.ts.map
          websocket.d.ts.map
          index.mjs
          websocket.js.map
          websocket.d.ts
          ws.js.map
          internal-base.mjs
          internal-base.js
          internal-base.js.map
          websocket.mjs.map
          internal-base.d.ts
          index.js.map
          internal-base.d.ts.map
          websocket.mjs
          index.d.ts
          ws.mjs
          ws.mjs.map
          index.js
          index.d.ts.map
          index.mjs.map
          websocket.js
      resources/
        completions.js.map
        batches.mjs.map
        files.mjs.map
        shared.mjs.map
        containers.d.ts.map
        moderations.mjs
        graders.d.ts.map
        graders.js.map
        graders.d.ts
        moderations.d.ts
        models.mjs
        index.mjs
        shared.d.ts.map
        batches.mjs
        images.mjs.map
        images.js
        moderations.js.map
        shared.js
        shared.js.map
        containers.d.ts
        files.d.ts.map
        embeddings.d.ts
        shared.mjs
        moderations.mjs.map
        images.d.ts
        models.js.map
        embeddings.js
        evals.js.map
        moderations.d.ts.map
        shared.d.ts
        images.d.ts.map
        evals.mjs.map
        evals.js
        moderations.js
        files.d.ts
        batches.js
        completions.d.ts.map
        containers.mjs
        containers.mjs.map
        graders.mjs.map
        embeddings.js.map
        models.d.ts
        graders.mjs
        batches.d.ts
        index.js.map
        embeddings.d.ts.map
        completions.mjs.map
        index.d.ts
        graders.js
        containers.js
        files.mjs
        evals.mjs
        files.js.map
        models.js
        index.js
        embeddings.mjs
        index.d.ts.map
        models.d.ts.map
        models.mjs.map
        batches.d.ts.map
        index.mjs.map
        embeddings.mjs.map
        images.js.map
        evals.d.ts.map
        batches.js.map
        files.js
        evals.d.ts
        completions.mjs
        completions.js
        completions.d.ts
        containers.js.map
        images.mjs
        beta/
          beta.js.map
          assistants.mjs
          index.mjs
          beta.d.ts.map
          beta.mjs
          beta.js
          beta.mjs.map
          assistants.js.map
          assistants.mjs.map
          index.js.map
          index.d.ts
          assistants.d.ts.map
          index.js
          beta.d.ts
          index.d.ts.map
          assistants.js
          index.mjs.map
          assistants.d.ts
          realtime/
            realtime.d.ts.map
            index.mjs
            transcription-sessions.d.ts
            sessions.js
            transcription-sessions.js.map
            realtime.mjs
            transcription-sessions.d.ts.map
            sessions.d.ts
            transcription-sessions.mjs.map
            sessions.mjs.map
            index.js.map
            transcription-sessions.js
            sessions.js.map
            index.d.ts
            sessions.mjs
            index.js
            transcription-sessions.mjs
            index.d.ts.map
            realtime.d.ts
            index.mjs.map
            realtime.js
            sessions.d.ts.map
            realtime.js.map
            realtime.mjs.map
          threads/
            threads.js
            threads.js.map
            index.mjs
            messages.d.ts.map
            threads.mjs.map
            messages.js
            messages.mjs.map
            messages.js.map
            index.js.map
            threads.mjs
            messages.d.ts
            index.d.ts
            threads.d.ts.map
            index.js
            index.d.ts.map
            index.mjs.map
            threads.d.ts
            messages.mjs
            runs/
              steps.js.map
              steps.js
              steps.d.ts
              runs.js.map
              runs.mjs.map
              index.mjs
              runs.js
              steps.d.ts.map
              steps.mjs
              index.js.map
              runs.d.ts
              runs.mjs
              index.d.ts
              index.js
              index.d.ts.map
              index.mjs.map
              runs.d.ts.map
              steps.mjs.map
          chat/
            completions.js.map
            chat.d.ts
            chat.js.map
            index.mjs
            chat.mjs
            completions.d.ts.map
            chat.js
            chat.d.ts.map
            chat.mjs.map
            index.js.map
            completions.mjs.map
            index.d.ts
            index.js
            index.d.ts.map
            index.mjs.map
            completions.mjs
            completions.js
            completions.d.ts
        responses/
          responses.js
          responses.d.ts.map
          responses.js.map
          index.mjs
          input-items.d.ts.map
          responses.d.ts
          input-items.js
          input-items.d.ts
          input-items.mjs.map
          index.js.map
          index.d.ts
          input-items.mjs
          index.js
          input-items.js.map
          index.d.ts.map
          index.mjs.map
          responses.mjs
          responses.mjs.map
        containers/
          files.mjs.map
          containers.d.ts.map
          index.mjs
          containers.d.ts
          files.d.ts.map
          files.d.ts
          containers.mjs
          containers.mjs.map
          index.js.map
          index.d.ts
          containers.js
          files.mjs
          files.js.map
          index.js
          index.d.ts.map
          index.mjs.map
          files.js
          containers.js.map
          files/
            content.d.ts.map
            content.d.ts
            files.mjs.map
            content.js.map
            content.mjs
            index.mjs
            files.d.ts.map
            files.d.ts
            content.mjs.map
            index.js.map
            content.js
            index.d.ts
            files.mjs
            files.js.map
            index.js
            index.d.ts.map
            index.mjs.map
            files.js
        graders/
          graders.d.ts.map
          graders.js.map
          graders.d.ts
          grader-models.mjs
          index.mjs
          grader-models.d.ts
          grader-models.js.map
          graders.mjs.map
          graders.mjs
          index.js.map
          index.d.ts
          grader-models.mjs.map
          grader-models.js
          graders.js
          index.js
          index.d.ts.map
          index.mjs.map
          grader-models.d.ts.map
        uploads/
          parts.mjs.map
          index.mjs
          uploads.js.map
          uploads.d.ts.map
          uploads.mjs
          uploads.mjs.map
          uploads.js
          uploads.d.ts
          index.js.map
          index.d.ts
          parts.mjs
          index.js
          index.d.ts.map
          parts.js.map
          parts.js
          index.mjs.map
          parts.d.ts
          parts.d.ts.map
        evals/
          runs.js.map
          runs.mjs.map
          index.mjs
          runs.js
          evals.js.map
          evals.mjs.map
          evals.js
          index.js.map
          runs.d.ts
          runs.mjs
          index.d.ts
          evals.mjs
          index.js
          index.d.ts.map
          index.mjs.map
          evals.d.ts.map
          runs.d.ts.map
          evals.d.ts
          runs/
            runs.js.map
            output-items.d.ts
            runs.mjs.map
            index.mjs
            output-items.d.ts.map
            output-items.mjs.map
            runs.js
            output-items.mjs
            output-items.js
            output-items.js.map
            index.js.map
            runs.d.ts
            runs.mjs
            index.d.ts
            index.js
            index.d.ts.map
            index.mjs.map
            runs.d.ts.map
        fine-tuning/
          checkpoints.d.ts.map
          index.mjs
          fine-tuning.d.ts
          alpha.d.ts.map
          checkpoints.js
          methods.d.ts.map
          checkpoints.mjs.map
          alpha.js
          checkpoints.mjs
          fine-tuning.js
          fine-tuning.mjs
          methods.js
          alpha.mjs.map
          methods.d.ts
          index.js.map
          index.d.ts
          fine-tuning.js.map
          methods.js.map
          fine-tuning.d.ts.map
          alpha.d.ts
          index.js
          methods.mjs.map
          index.d.ts.map
          alpha.mjs
          index.mjs.map
          fine-tuning.mjs.map
          methods.mjs
          checkpoints.d.ts
          checkpoints.js.map
          alpha.js.map
          jobs/
            checkpoints.d.ts.map
            index.mjs
            checkpoints.js
            jobs.d.ts.map
            checkpoints.mjs.map
            checkpoints.mjs
            jobs.mjs.map
            jobs.js.map
            index.js.map
            jobs.d.ts
            index.d.ts
            jobs.mjs
            index.js
            jobs.js
            index.d.ts.map
            index.mjs.map
            checkpoints.d.ts
            checkpoints.js.map
          alpha/
            graders.d.ts.map
            graders.js.map
            graders.d.ts
            index.mjs
            alpha.d.ts.map
            alpha.js
            graders.mjs.map
            alpha.mjs.map
            graders.mjs
            index.js.map
            index.d.ts
            graders.js
            alpha.d.ts
            index.js
            index.d.ts.map
            alpha.mjs
            index.mjs.map
            alpha.js.map
          checkpoints/
            permissions.d.ts.map
            checkpoints.d.ts.map
            index.mjs
            checkpoints.js
            checkpoints.mjs.map
            checkpoints.mjs
            permissions.mjs
            permissions.mjs.map
            permissions.js.map
            index.js.map
            index.d.ts
            index.js
            permissions.js
            index.d.ts.map
            permissions.d.ts
            index.mjs.map
            checkpoints.d.ts
            checkpoints.js.map
        audio/
          translations.d.ts.map
          speech.js.map
          audio.js
          index.mjs
          audio.d.ts
          translations.mjs.map
          audio.d.ts.map
          translations.js
          translations.js.map
          translations.mjs
          audio.js.map
          transcriptions.d.ts.map
          transcriptions.mjs.map
          transcriptions.js
          speech.mjs
          speech.js
          index.js.map
          audio.mjs
          speech.d.ts
          index.d.ts
          audio.mjs.map
          transcriptions.mjs
          index.js
          index.d.ts.map
          transcriptions.js.map
          index.mjs.map
          translations.d.ts
          speech.mjs.map
          speech.d.ts.map
          transcriptions.d.ts
        chat/
          completions.js.map
          chat.d.ts
          chat.js.map
          index.mjs
          chat.mjs
          completions.d.ts.map
          chat.js
          chat.d.ts.map
          chat.mjs.map
          index.js.map
          completions.mjs.map
          index.d.ts
          index.js
          index.d.ts.map
          index.mjs.map
          completions.mjs
          completions.js
          completions.d.ts
          completions/
            completions.js.map
            index.mjs
            messages.d.ts.map
            messages.js
            messages.mjs.map
            completions.d.ts.map
            messages.js.map
            index.js.map
            completions.mjs.map
            messages.d.ts
            index.d.ts
            index.js
            index.d.ts.map
            index.mjs.map
            completions.mjs
            completions.js
            completions.d.ts
            messages.mjs
        vector-stores/
          files.mjs.map
          file-batches.mjs
          index.mjs
          file-batches.d.ts.map
          file-batches.js.map
          vector-stores.js
          files.d.ts.map
          files.d.ts
          vector-stores.d.ts
          vector-stores.js.map
          index.js.map
          vector-stores.mjs.map
          index.d.ts
          file-batches.d.ts
          files.mjs
          files.js.map
          file-batches.mjs.map
          index.js
          index.d.ts.map
          file-batches.js
          index.mjs.map
          vector-stores.mjs
          files.js
          vector-stores.d.ts.map
      bin/
        cli
      internal/
        stream-utils.mjs.map
        stream-utils.mjs
        stream-utils.d.ts.map
        stream-utils.js.map
        stream-utils.d.ts
        stream-utils.js
        decoders/
          line.js.map
          line.mjs.map
          line.mjs
          line.js
          line.d.ts
          line.d.ts.map
        qs/
          types.js.map
          stringify.mjs.map
          utils.js
          formats.mjs.map
          index.mjs
          stringify.js
          types.d.ts
          formats.js.map
          utils.mjs.map
          utils.mjs
          types.mjs.map
          formats.d.ts.map
          utils.js.map
          utils.d.ts.map
          stringify.js.map
          index.js.map
          formats.mjs
          index.d.ts
          types.js
          index.js
          stringify.mjs
          types.d.ts.map
          index.d.ts.map
          utils.d.ts
          index.mjs.map
          formats.d.ts
          stringify.d.ts.map
          formats.js
          types.mjs
          stringify.d.ts
      _shims/
        bun-runtime.js.map
        registry.mjs.map
        web-runtime.d.ts
        web-runtime.mjs.map
        node-runtime.mjs
        index.mjs
        bun-runtime.mjs.map
        web-runtime.js
        manual-types.mjs
        web-types.js
        bun-runtime.mjs
        web-runtime.d.ts.map
        manual-types.d.ts
        node-types.mjs
        bun-runtime.d.ts
        node-runtime.mjs.map
        node-types.d.ts
        README.md
        MultipartBody.mjs.map
        MultipartBody.d.ts.map
        registry.d.ts
        node-runtime.d.ts.map
        registry.d.ts.map
        MultipartBody.d.ts
        node-runtime.d.ts
        manual-types.js
        web-types.d.ts
        index.d.ts
        node-runtime.js.map
        registry.js
        registry.mjs
        index.js
        web-runtime.mjs
        node-runtime.js
        web-types.mjs
        web-runtime.js.map
        bun-runtime.js
        MultipartBody.js
        registry.js.map
        MultipartBody.mjs
        MultipartBody.js.map
        node-types.js
        bun-runtime.d.ts.map
        auto/
          runtime-node.mjs
          types-node.js.map
          types.d.ts
          runtime-bun.js
          runtime-node.d.ts
          runtime.mjs.map
          runtime.js.map
          types-node.js
          runtime.d.ts.map
          runtime-bun.mjs
          runtime.js
          runtime.mjs
          types-node.d.ts.map
          runtime-bun.d.ts
          runtime-node.js.map
          runtime-node.d.ts.map
          runtime.d.ts
          runtime-node.mjs.map
          runtime-bun.js.map
          types.js
          types-node.mjs
          types-node.mjs.map
          runtime-bun.mjs.map
          types.mjs
          runtime-bun.d.ts.map
          runtime-node.js
          types-node.d.ts
      _vendor/
        zod-to-json-schema/
          Refs.js.map
          Options.d.ts.map
          errorMessages.d.ts
          Options.js
          util.mjs.map
          errorMessages.d.ts.map
          parseDef.d.ts
          errorMessages.mjs
          zodToJsonSchema.d.ts.map
          index.mjs
          zodToJsonSchema.d.ts
          util.js.map
          util.d.ts
          util.d.ts.map
          parseDef.js.map
          Refs.d.ts.map
          parseDef.d.ts.map
          Options.mjs
          zodToJsonSchema.js
          Refs.mjs
          parseDef.js
          Options.js.map
          Refs.js
          errorMessages.mjs.map
          parseDef.mjs
          Options.d.ts
          util.js
          util.mjs
          index.js.map
          index.d.ts
          errorMessages.js.map
          parseDef.mjs.map
          errorMessages.js
          Options.mjs.map
          index.js
          zodToJsonSchema.mjs.map
          index.d.ts.map
          index.mjs.map
          zodToJsonSchema.mjs
          zodToJsonSchema.js.map
          Refs.d.ts
          Refs.mjs.map
          parsers/
            intersection.js
            pipeline.js.map
            record.mjs.map
            branded.js.map
            promise.d.ts.map
            string.d.ts.map
            never.mjs
            optional.mjs.map
            date.mjs.map
            any.mjs
            null.mjs.map
            enum.d.ts.map
            undefined.d.ts
            number.js
            nullable.js
            boolean.d.ts
            catch.d.ts.map
            branded.d.ts
            null.d.ts
            default.mjs.map
            number.mjs.map
            branded.mjs.map
            undefined.mjs
            default.js.map
            tuple.js
            string.js.map
            readonly.d.ts
            set.mjs.map
            null.js
            string.mjs
            optional.js.map
            date.mjs
            set.js.map
            map.d.ts
            pipeline.mjs.map
            readonly.d.ts.map
            object.d.ts.map
            catch.js
            array.d.ts.map
            nativeEnum.d.ts.map
            promise.mjs
            undefined.d.ts.map
            union.mjs
            promise.js.map
            nullable.d.ts
            readonly.js.map
            array.mjs.map
            set.d.ts.map
            array.js
            catch.js.map
            nativeEnum.js
            nativeEnum.js.map
            literal.mjs
            string.mjs.map
            bigint.d.ts
            record.mjs
            intersection.js.map
            object.d.ts
            nativeEnum.mjs
            tuple.js.map
            map.mjs
            set.js
            number.d.ts.map
            intersection.mjs.map
            any.mjs.map
            union.js.map
            promise.mjs.map
            bigint.d.ts.map
            object.mjs
            tuple.mjs
            unknown.js
            enum.js.map
            record.d.ts.map
            tuple.d.ts
            branded.d.ts.map
            enum.js
            bigint.js
            never.js.map
            number.mjs
            object.js
            record.js
            nullable.js.map
            optional.d.ts
            enum.mjs.map
            promise.d.ts
            literal.js
            never.d.ts.map
            default.d.ts.map
            catch.mjs
            pipeline.d.ts
            nullable.mjs.map
            literal.js.map
            unknown.mjs.map
            bigint.mjs
            optional.js
            optional.mjs
            array.mjs
            set.mjs
            branded.js
            optional.d.ts.map
            intersection.mjs
            record.d.ts
            record.js.map
            null.js.map
            map.d.ts.map
            array.d.ts
            effects.d.ts.map
            unknown.d.ts
            bigint.js.map
            undefined.js.map
            nativeEnum.mjs.map
            number.js.map
            pipeline.mjs
            boolean.mjs.map
            map.mjs.map
            boolean.js.map
            undefined.mjs.map
            pipeline.js
            tuple.mjs.map
            enum.mjs
            catch.d.ts
            any.js
            default.mjs
            date.d.ts.map
            null.mjs
            array.js.map
            literal.d.ts.map
            string.d.ts
            boolean.js
            pipeline.d.ts.map
            effects.mjs
            map.js
            any.js.map
            default.d.ts
            nativeEnum.d.ts
            never.mjs.map
            map.js.map
            branded.mjs
            intersection.d.ts
            unknown.js.map
            catch.mjs.map
            intersection.d.ts.map
            effects.mjs.map
            undefined.js
            union.d.ts
            unknown.mjs
            number.d.ts
            any.d.ts.map
            readonly.js
            object.js.map
            effects.d.ts
            nullable.mjs
            readonly.mjs
            effects.js.map
            unknown.d.ts.map
            any.d.ts
            date.js
            date.d.ts
            promise.js
            union.d.ts.map
            effects.js
            set.d.ts
            string.js
            literal.mjs.map
            null.d.ts.map
            literal.d.ts
            default.js
            enum.d.ts
            boolean.d.ts.map
            boolean.mjs
            readonly.mjs.map
            date.js.map
            tuple.d.ts.map
            never.js
            bigint.mjs.map
            union.js
            never.d.ts
            union.mjs.map
            object.mjs.map
            nullable.d.ts.map
        partial-json-parser/
          parser.d.ts.map
          parser.js.map
          parser.mjs.map
          parser.js
          parser.d.ts
          parser.mjs
      src/
        index.ts
        core.ts
        streaming.ts
        tsconfig.json
        uploads.ts
        version.ts
        resource.ts
        resources.ts
        error.ts
        pagination.ts
        lib/
          AbstractChatCompletionRunner.ts
          .keep
          ChatCompletionStream.ts
          EventStream.ts
          chatCompletionUtils.ts
          jsonschema.ts
          ResponsesParser.ts
          RunnableFunction.ts
          EventEmitter.ts
          ChatCompletionRunner.ts
          ChatCompletionStreamingRunner.ts
          parser.ts
          Util.ts
          AssistantStream.ts
          responses/
            ResponseStream.ts
            EventTypes.ts
        beta/
          realtime/
            index.ts
            internal-base.ts
            websocket.ts
            ws.ts
        resources/
          evals.ts
          index.ts
          moderations.ts
          shared.ts
          models.ts
          completions.ts
          files.ts
          batches.ts
          embeddings.ts
          graders.ts
          images.ts
          containers.ts
          beta/
            index.ts
            assistants.ts
            beta.ts
            realtime/
              index.ts
              transcription-sessions.ts
              sessions.ts
              realtime.ts
            threads/
              index.ts
              threads.ts
              messages.ts
            chat/
              index.ts
              chat.ts
              completions.ts
          responses/
            index.ts
            responses.ts
            input-items.ts.orig
            input-items.ts
          containers/
            index.ts
            files.ts
            containers.ts
            files/
              index.ts
              files.ts
              content.ts
          graders/
            index.ts
            grader-models.ts
            graders.ts
          uploads/
            index.ts
            parts.ts
            uploads.ts
          evals/
            evals.ts
            index.ts
            runs.ts
            runs/
              index.ts
              output-items.ts
              runs.ts
          fine-tuning/
            index.ts
            fine-tuning.ts
            alpha.ts
            methods.ts
            checkpoints.ts
            jobs/
              index.ts
              jobs.ts
              checkpoints.ts
            alpha/
              index.ts
              alpha.ts
              graders.ts
            checkpoints/
              index.ts
              permissions.ts
              checkpoints.ts
          audio/
            index.ts
            audio.ts
            transcriptions.ts
            translations.ts
            speech.ts
          chat/
            index.ts
            chat.ts
            completions.ts
            completions/
              index.ts
              completions.ts
              messages.ts
          vector-stores/
            index.ts
            file-batches.ts
            vector-stores.ts
            files.ts
        internal/
          stream-utils.ts
          decoders/
            line.ts
          qs/
            index.ts
            README.md
            formats.ts
            types.ts
            utils.ts
            stringify.ts
            LICENSE.md
        _shims/
          web-runtime.ts
          index.mjs
          manual-types.mjs
          web-types.js
          MultipartBody.ts
          manual-types.d.ts
          node-types.mjs
          registry.ts
          node-types.d.ts
          README.md
          manual-types.js
          web-types.d.ts
          index.d.ts
          node-runtime.ts
          index.js
          web-types.mjs
          bun-runtime.ts
          node-types.js
          auto/
            types-node.ts
            runtime-bun.ts
            runtime.ts
            types.d.ts
            runtime-node.ts
            types.js
            types.mjs
        _vendor/
          zod-to-json-schema/
            index.ts
            Refs.ts
            LICENSE
            util.ts
            Options.ts
            README.md
            errorMessages.ts
            parseDef.ts
            zodToJsonSchema.ts
            parsers/
              catch.ts
              array.ts
              undefined.ts
              default.ts
              enum.ts
              promise.ts
              effects.ts
              branded.ts
              boolean.ts
              object.ts
              any.ts
              date.ts
              never.ts
              number.ts
              string.ts
              map.ts
              optional.ts
              set.ts
              nullable.ts
              pipeline.ts
              tuple.ts
              literal.ts
              intersection.ts
              bigint.ts
              readonly.ts
              nativeEnum.ts
              null.ts
              union.ts
              unknown.ts
              record.ts
          partial-json-parser/
            README.md
            parser.ts
        shims/
          node.ts
          web.ts
        helpers/
          zod.ts
          audio.ts
      shims/
        web.mjs
        node.js.map
        web.js
        node.d.ts
        node.mjs
        node.js
        node.mjs.map
        web.d.ts
        web.js.map
        web.d.ts.map
        web.mjs.map
        node.d.ts.map
      helpers/
        zod.js
        zod.js.map
        zod.mjs
        zod.mjs.map
        audio.js
        audio.d.ts
        audio.d.ts.map
        zod.d.ts.map
        audio.js.map
        audio.mjs
        audio.mjs.map
        zod.d.ts
    cookie-signature/
      package.json
      Readme.md
      History.md
      index.js
    content-disposition/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    json5/
      package.json
      README.md
      LICENSE.md
      dist/
        index.min.mjs
        index.mjs
        index.min.js
        index.js
      lib/
        unicode.d.ts
        stringify.js
        require.js
        util.d.ts
        register.js
        cli.js
        parse.d.ts
        util.js
        index.d.ts
        index.js
        unicode.js
        stringify.d.ts
        parse.js
    util/
      package.json
      LICENSE
      README.md
      util.js
      support/
        isBuffer.js
        isBufferBrowser.js
        types.js
    minimist/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      index.js
      test/
        bool.js
        long.js
        kv_short.js
        dash.js
        default_bool.js
        stop_early.js
        unknown.js
        short.js
        whitespace.js
        num.js
        proto.js
        dotted.js
        all_bool.js
        parse_modified.js
        parse.js
      .github/
        FUNDING.yml
      example/
        parse.js
    stringz/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      dist/
        index.d.ts
        index.js
        index.d.ts.map
    call-bind/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintignore
      .eslintrc
      index.js
      callBound.js
      test/
        index.js
        callBound.js
      .github/
        FUNDING.yml
    uuid/
      CHANGELOG.md
      package.json
      README.md
      wrapper.mjs
      CONTRIBUTING.md
      LICENSE.md
      dist/
        rng.js
        v4.js
        v1.js
        regex.js
        stringify.js
        nil.js
        validate.js
        v35.js
        md5-browser.js
        md5.js
        index.js
        rng-browser.js
        sha1-browser.js
        version.js
        v5.js
        v3.js
        sha1.js
        parse.js
        uuid-bin.js
        umd/
          uuidParse.min.js
          uuidv1.min.js
          uuidNIL.min.js
          uuidStringify.min.js
          uuidv4.min.js
          uuidv3.min.js
          uuidValidate.min.js
          uuidv5.min.js
          uuidVersion.min.js
          uuid.min.js
        bin/
          uuid
        esm-node/
          rng.js
          v4.js
          v1.js
          regex.js
          stringify.js
          nil.js
          validate.js
          v35.js
          md5.js
          index.js
          version.js
          v5.js
          v3.js
          sha1.js
          parse.js
        esm-browser/
          rng.js
          v4.js
          v1.js
          regex.js
          stringify.js
          nil.js
          validate.js
          v35.js
          md5.js
          index.js
          version.js
          v5.js
          v3.js
          sha1.js
          parse.js
    cors/
      package.json
      LICENSE
      README.md
      CONTRIBUTING.md
      HISTORY.md
      lib/
        index.js
    is-wsl/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    globby/
      package.json
      license
      readme.md
      index.d.ts
      stream-utils.js
      gitignore.js
      index.js
    compression/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
      node_modules/
        ms/
          package.json
          license.md
          readme.md
          index.js
        negotiator/
          package.json
          LICENSE
          README.md
          index.js
          HISTORY.md
          lib/
            language.js
            charset.js
            encoding.js
            mediaType.js
        debug/
          CHANGELOG.md
          package.json
          component.json
          Makefile
          LICENSE
          node.js
          README.md
          .npmignore
          .eslintrc
          karma.conf.js
          .travis.yml
          .coveralls.yml
          src/
            browser.js
            node.js
            debug.js
            index.js
            inspector-log.js
    busboy/
      package.json
      LICENSE
      README.md
      .travis.yml
      lib/
        utils.js
        main.js
        types/
          multipart.js
          urlencoded.js
      test/
        test-utils-decoder.js
        test-utils-parse-params.js
        test.js
        test-types-urlencoded.js
        test-types-multipart.js
      node_modules/
        string_decoder/
          package.json
          LICENSE
          README.md
          .npmignore
          index.js
        isarray/
          package.json
          component.json
          README.md
          index.js
          build/
            build.js
        readable-stream/
          package.json
          float.patch
          LICENSE
          README.md
          .npmignore
          readable.js
          duplex.js
          passthrough.js
          writable.js
          transform.js
          lib/
            _stream_readable.js
            _stream_passthrough.js
            _stream_transform.js
            _stream_duplex.js
            _stream_writable.js
      deps/
        encoding/
          encoding.js
          encoding-indexes.js
    side-channel-weakmap/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    express-rate-limit/
      package.json
      changelog.md
      tsconfig.json
      license.md
      readme.md
      dist/
        index.d.cts
        index.mjs
        index.d.ts
        index.cjs
        index.d.mts
    forever-agent/
      package.json
      LICENSE
      README.md
      index.js
    ignore/
      package.json
      legacy.js
      README.md
      LICENSE-MIT
      index.d.ts
      index.js
    strip-final-newline/
      package.json
      license
      readme.md
      index.js
    define-properties/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.js
      .github/
        FUNDING.yml
    mkdirp/
      package.json
      LICENSE
      readme.markdown
      dist/
        cjs/
          package.json
          src/
            bin.d.ts.map
            bin.js
            bin.d.ts
            find-made.d.ts
            find-made.js
            opts-arg.d.ts
            use-native.d.ts.map
            path-arg.js.map
            opts-arg.js
            opts-arg.d.ts.map
            path-arg.js
            index.js.map
            mkdirp-native.js
            use-native.js
            mkdirp-manual.d.ts
            index.d.ts
            path-arg.d.ts
            mkdirp-manual.d.ts.map
            use-native.d.ts
            find-made.js.map
            index.js
            mkdirp-manual.js
            index.d.ts.map
            find-made.d.ts.map
            path-arg.d.ts.map
            use-native.js.map
            mkdirp-native.d.ts
            mkdirp-manual.js.map
            mkdirp-native.js.map
            opts-arg.js.map
            bin.js.map
            mkdirp-native.d.ts.map
        mjs/
          package.json
          find-made.d.ts
          find-made.js
          opts-arg.d.ts
          use-native.d.ts.map
          path-arg.js.map
          opts-arg.js
          opts-arg.d.ts.map
          path-arg.js
          index.js.map
          mkdirp-native.js
          use-native.js
          mkdirp-manual.d.ts
          index.d.ts
          path-arg.d.ts
          mkdirp-manual.d.ts.map
          use-native.d.ts
          find-made.js.map
          index.js
          mkdirp-manual.js
          index.d.ts.map
          find-made.d.ts.map
          path-arg.d.ts.map
          use-native.js.map
          mkdirp-native.d.ts
          mkdirp-manual.js.map
          mkdirp-native.js.map
          opts-arg.js.map
          mkdirp-native.d.ts.map
    jackspeak/
      package.json
      README.md
      LICENSE.md
      dist/
        commonjs/
          package.json
          parse-args-cjs.d.cts.map
          parse-args.js
          parse-args-cjs.cjs.map
          index.js.map
          parse-args.d.ts
          index.d.ts
          index.js
          index.d.ts.map
        esm/
          package.json
          parse-args.js
          parse-args.d.ts.map
          parse-args.js.map
          index.js.map
          parse-args.d.ts
          index.d.ts
          index.js
          index.d.ts.map
    escape-html/
      package.json
      Readme.md
      LICENSE
      index.js
    pkginfo/
      package.json
      README.md
      .npmignore
      lib/
        pkginfo.js
      test/
        pkginfo-test.js
      examples/
        package.json
        single-property.js
        object-argument.js
        multiple-properties.js
        all-properties.js
        array-argument.js
      docs/
        docco.css
        pkginfo.html
    wrap-ansi-cjs/
      package.json
      license
      readme.md
      index.js
    through/
      package.json
      LICENSE.APACHE2
      .travis.yml
      index.js
      LICENSE.MIT
      readme.markdown
      test/
        end.js
        auto-destroy.js
        buffering.js
        index.js
        async.js
    esrecurse/
      package.json
      README.md
      .babelrc
      gulpfile.babel.js
      esrecurse.js
    conf/
      package.json
      license
      readme.md
      dist/
        source/
          types.d.ts
          index.d.ts
          types.js
          index.js
    fastq/
      package.json
      SECURITY.md
      example.mjs
      LICENSE
      README.md
      example.js
      queue.js
      index.d.ts
      bench.js
      test/
        tsconfig.json
        test.js
        example.ts
        promise.js
      .github/
        dependabot.yml
        workflows/
          ci.yml
    run-parallel/
      package.json
      LICENSE
      README.md
      index.js
    parseurl/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    pkg-fetch/
      package.json
      README.md
      license.md
      lib-es5/
        utils.js
        expected.d.ts
        verify.d.ts
        bin.js
        bin.d.ts
        places.js
        verify.js
        log.js
        expected.js
        places.d.ts
        system.js
        system.d.ts
        index.d.ts
        log.d.ts
        build.js
        index.js
        build.d.ts
        utils.d.ts
      patches/
        node.v18.5.0.cpp.patch
        node.v14.20.0.cpp.patch
        node.v10.24.1.cpp.patch
        node.v8.17.0.cpp.patch
        patches.json
        node.v12.22.11.cpp.patch
        node.v16.16.0.cpp.patch
    progress/
      CHANGELOG.md
      package.json
      Readme.md
      Makefile
      LICENSE
      index.js
      lib/
        node-progress.js
    brace-expansion/
      package.json
      LICENSE
      README.md
      index.js
    define-lazy-prop/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    lodash.isboolean/
      package.json
      LICENSE
      README.md
      index.js
    dotenv/
      CHANGELOG.md
      package.json
      SECURITY.md
      README-es.md
      LICENSE
      config.js
      README.md
      config.d.ts
      lib/
        cli-options.js
        env-options.js
        main.js
        main.d.ts
    core-util-is/
      package.json
      LICENSE
      README.md
      lib/
        util.js
    form-data-encoder/
      package.json
      license
      readme.md
      lib/
        cjs/
          FileLike.js
          package.json
          FormDataEncoder.js
          FormDataLike.js
          index.js
          util/
            isFileLike.js
            normalizeValue.js
            isFunction.js
            escapeName.js
            createBoundary.js
            isPlainObject.js
            isFormData.js
        esm/
          FileLike.js
          package.json
          FormDataEncoder.js
          FormDataLike.js
          index.js
          util/
            isFileLike.js
            normalizeValue.js
            isFunction.js
            escapeName.js
            createBoundary.js
            isPlainObject.js
            isFormData.js
      @type/
        FileLike.d.ts
        index.d.ts
        FormDataEncoder.d.ts
        FormDataLike.d.ts
        util/
          normalizeValue.d.ts
          isFunction.d.ts
          isFormData.d.ts
          isFileLike.d.ts
          isPlainObject.d.ts
          createBoundary.d.ts
          escapeName.d.ts
    multistream/
      package.json
      LICENSE
      README.md
      index.js
      node_modules/
        readable-stream/
          experimentalWarning.js
          package.json
          errors.js
          readable-browser.js
          LICENSE
          errors-browser.js
          README.md
          readable.js
          CONTRIBUTING.md
          GOVERNANCE.md
          lib/
            _stream_readable.js
            _stream_passthrough.js
            _stream_transform.js
            _stream_duplex.js
            _stream_writable.js
            internal/
    depd/
      package.json
      Readme.md
      LICENSE
      History.md
      index.js
      lib/
        browser/
          index.js
    cliui/
      CHANGELOG.md
      package.json
      index.mjs
      README.md
      LICENSE.txt
      build/
        index.cjs
        lib/
          string-utils.js
          index.js
    agent-base/
      package.json
      README.md
      dist/
        src/
          promisify.js.map
          promisify.js
          index.js.map
          index.d.ts
          index.js
          promisify.d.ts
      node_modules/
        debug/
          package.json
          LICENSE
          README.md
          src/
            browser.js
            node.js
            common.js
            index.js
      src/
        index.ts
        promisify.ts
    ecdsa-sig-formatter/
      package.json
      LICENSE
      README.md
      CODEOWNERS
      src/
        param-bytes-for-alg.js
        ecdsa-sig-formatter.js
        ecdsa-sig-formatter.d.ts
    @inversifyjs/
      common/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        webpack.config.mjs
        tsconfig.cjs.tsbuildinfo
        lib/
          cjs/
            package.json
            index.js.map
            index.d.ts
            index.js
            index.d.ts.map
            services/
          esm/
            package.json
            index.d.ts
            index.js
            index.d.ts.map
            services/
        .turbo/
          turbo-build.log
      core/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        webpack.config.mjs
        tsconfig.cjs.tsbuildinfo
        lib/
          cjs/
            package.json
            index.js.map
            index.d.ts
            index.js
            index.d.ts.map
            string/
            symbol/
            metadata/
            error/
            reflectMetadata/
            legacyTarget/
            prototype/
          esm/
            package.json
            index.d.ts
            index.js
            index.d.ts.map
            string/
            symbol/
            metadata/
            error/
            reflectMetadata/
            legacyTarget/
            prototype/
        .turbo/
          turbo-build.log
      reflect-metadata-utils/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        webpack.config.mjs
        lib/
          cjs/
            package.json
            index.js.map
            index.d.ts
            index.js
            index.d.ts.map
            reflectMetadata/
          esm/
            package.json
            index.d.ts
            index.js
            index.d.ts.map
            reflectMetadata/
        .turbo/
          turbo-build.log
    async/
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      index.js
      .gitmodules
      lib/
        async.js
    from2/
      package.json
      README.md
      test.js
      .travis.yml
      index.js
      LICENSE.md
    is-regex/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
    compressible/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    iconv-lite/
      package.json
      LICENSE
      README.md
      Changelog.md
      lib/
        streams.js
        extend-node.js
        index.d.ts
        index.js
        bom-handling.js
      encodings/
        utf7.js
        dbcs-codec.js
        sbcs-data.js
        dbcs-data.js
        utf16.js
        internal.js
        sbcs-codec.js
        index.js
        sbcs-data-generated.js
        tables/
          gb18030-ranges.json
          big5-added.json
          cp936.json
          cp950.json
          shiftjis.json
          gbk-added.json
          cp949.json
          eucjp.json
    env-paths/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    morgan/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
      node_modules/
        ms/
          package.json
          license.md
          readme.md
          index.js
        on-finished/
          package.json
          LICENSE
          README.md
          index.js
          HISTORY.md
        debug/
          CHANGELOG.md
          package.json
          component.json
          Makefile
          LICENSE
          node.js
          README.md
          .npmignore
          .eslintrc
          karma.conf.js
          .travis.yml
          .coveralls.yml
          src/
            browser.js
            node.js
            debug.js
            index.js
            inspector-log.js
    bytes/
      package.json
      Readme.md
      LICENSE
      History.md
      index.js
    .bin/
      cross-env
      semver
      bfg
      glob
      rc
      parser
      resolve
      is-inside-container
      openai
      json5
      uuid
      mkdirp
      pkg-fetch
      ncp
      mime
      jsesc
      node-which
      pkg
      javascript-obfuscator
      prebuild-install
      esparse
      esvalidate
      acorn
      rimraf
      is-docker
      cross-env-shell
    get-stream/
      package.json
      license
      buffer-stream.js
      readme.md
      index.d.ts
      index.js
    fs-extra/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      lib/
        index.js
        mkdirs/
          make-dir.js
          index.js
        util/
          stat.js
          utimes.js
        fs/
          index.js
        empty/
          index.js
        move/
          index.js
          move.js
        output/
          index.js
        ensure/
          symlink.js
          link.js
          symlink-type.js
          file.js
          index.js
          symlink-paths.js
        move-sync/
          move-sync.js
          index.js
        copy-sync/
          copy-sync.js
          index.js
        path-exists/
          index.js
        copy/
          index.js
          copy.js
        json/
          output-json-sync.js
          output-json.js
          jsonfile.js
          index.js
        remove/
          rimraf.js
          index.js
    kareem/
      CHANGELOG.md
      package.json
      SECURITY.md
      LICENSE
      README.md
      index.d.ts
      index.js
    memory-pager/
      package.json
      LICENSE
      README.md
      test.js
      .travis.yml
      index.js
    mimic-function/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    utils-merge/
      package.json
      LICENSE
      README.md
      .npmignore
      index.js
    wrappy/
      package.json
      LICENSE
      README.md
      wrappy.js
    passport-strategy/
      package.json
      LICENSE
      .jshintrc
      README.md
      .travis.yml
      lib/
        index.js
        strategy.js
    extend/
      CHANGELOG.md
      package.json
      component.json
      LICENSE
      README.md
      .eslintrc
      .editorconfig
      .travis.yml
      .jscs.json
      index.js
    passport/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      lib/
        sessionmanager.js
        authenticator.js
        index.js
        errors/
          authenticationerror.js
        strategies/
          session.js
        middleware/
          authenticate.js
          initialize.js
        http/
          request.js
        framework/
          connect.js
      etc/
        jsdoc.json
      sponsors/
        loginradius.png
        fusionauth.svg
        workos.png
        descope-dark.svg
        fusionauth.png
        snyk.png
        descope.svg
    stream-meter/
      package.json
      LICENSE
      README.md
      .npmignore
      index.js
      test/
        index.js
    require-directory/
      package.json
      LICENSE
      .jshintrc
      .npmignore
      .travis.yml
      index.js
      README.markdown
    process-nextick-args/
      package.json
      license.md
      readme.md
      index.js
    fs.realpath/
      package.json
      old.js
      LICENSE
      README.md
      index.js
    process/
      browser.js
      package.json
      LICENSE
      README.md
      .eslintrc
      test.js
      index.js
    ncp/
      package.json
      README.md
      .npmignore
      .travis.yml
      LICENSE.md
      lib/
        ncp.js
      test/
        ncp.js
        symlink-fixtures/
          src/
            foo
            dir/
              bar
        regular-fixtures/
          src/
            f
            b
            a
            e
            d
            c
            sub/
              b
              a
        modified-files/
          out/
            a
          src/
            a
      bin/
        ncp
    tunnel-agent/
      package.json
      LICENSE
      README.md
      index.js
    possible-typed-array-names/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    has-symbols/
      CHANGELOG.md
      package.json
      shams.js
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      shams.d.ts
      index.js
      test/
        index.js
        tests.js
        shams/
          get-own-property-symbols.js
          core-js.js
      .github/
        FUNDING.yml
    @babel/
      helper-string-parser/
        package.json
        LICENSE
        README.md
        lib/
          index.js.map
          index.js
      parser/
        CHANGELOG.md
        package.json
        LICENSE
        README.md
        typings/
          babel-parser.d.ts
        lib/
          index.js.map
          index.js
        bin/
          babel-parser.js
      helper-validator-identifier/
        package.json
        LICENSE
        README.md
        lib/
          keyword.js
          identifier.js.map
          index.js.map
          index.js
          identifier.js
          keyword.js.map
      runtime/
        package.json
        LICENSE
        README.md
        regenerator/
          index.js
        helpers/
          classPrivateFieldGet.js
          defineProperty.js
          AwaitValue.js
          applyDecs2203.js
          applyDecs2311.js
          classStaticPrivateFieldDestructureSet.js
          regeneratorValues.js
          classPrivateGetter.js
          classPrivateFieldSet.js
          identity.js
          classPrivateFieldDestructureSet.js
          classCheckPrivateStaticAccess.js
          possibleConstructorReturn.js
          unsupportedIterableToArray.js
          get.js
          applyDecs2203R.js
          regeneratorRuntime.js
          regenerator.js
          classExtractFieldDescriptor.js
          applyDecoratedDescriptor.js
          typeof.js
          objectSpread.js
          classPrivateMethodSet.js
          construct.js
          maybeArrayLike.js
          applyDecs.js
          toConsumableArray.js
          setPrototypeOf.js
          classPrivateSetter.js
          wrapRegExp.js
          initializerDefineProperty.js
          newArrowCheck.js
          iterableToArray.js
          isNativeReflectConstruct.js
          regeneratorDefine.js
          superPropBase.js
          toPropertyKey.js
          toArray.js
          classApplyDescriptorGet.js
          dispose.js
          set.js
          tsRewriteRelativeImportExtensions.js
          arrayWithoutHoles.js
          temporalRef.js
          setFunctionName.js
          arrayLikeToArray.js
          usingCtx.js
          classStaticPrivateMethodGet.js
          taggedTemplateLiteral.js
          regeneratorAsyncGen.js
          nonIterableSpread.js
          importDeferProxy.js
          classStaticPrivateFieldSpecSet.js
          wrapAsyncGenerator.js
          superPropGet.js
          iterableToArrayLimit.js
          toPrimitive.js
          classPrivateMethodInitSpec.js
          decorate.js
          applyDecs2301.js
          inherits.js
          classCheckPrivateStaticFieldDescriptor.js
          interopRequireWildcard.js
          classPrivateFieldLooseBase.js
          objectWithoutPropertiesLoose.js
          classPrivateFieldLooseKey.js
          createClass.js
          temporalUndefined.js
          classStaticPrivateFieldSpecGet.js
          initializerWarningHelper.js
          extends.js
          classPrivateFieldInitSpec.js
          classApplyDescriptorDestructureSet.js
          classApplyDescriptorSet.js
          wrapNativeSuper.js
          classPrivateFieldSet2.js
          jsx.js
          nonIterableRest.js
          instanceof.js
          objectWithoutProperties.js
          createForOfIteratorHelper.js
          asyncToGenerator.js
          defineAccessor.js
          asyncGeneratorDelegate.js
          writeOnlyError.js
          OverloadYield.js
          classNameTDZError.js
          classStaticPrivateMethodSet.js
          createSuper.js
          asyncIterator.js
          awaitAsyncGenerator.js
          checkPrivateRedeclaration.js
          assertClassBrand.js
          interopRequireDefault.js
          regeneratorAsync.js
          checkInRHS.js
          arrayWithHoles.js
          classPrivateMethodGet.js
          isNativeFunction.js
          readOnlyError.js
          getPrototypeOf.js
          classPrivateFieldGet2.js
          using.js
          regeneratorKeys.js
          nullishReceiverError.js
          inheritsLoose.js
          taggedTemplateLiteralLoose.js
          applyDecs2305.js
          classCallCheck.js
          assertThisInitialized.js
          superPropSet.js
          objectDestructuringEmpty.js
          defineEnumerableProperties.js
          defaults.js
          tdz.js
          regeneratorAsyncIterator.js
          skipFirstGeneratorNext.js
          objectSpread2.js
          toSetter.js
          slicedToArray.js
          callSuper.js
          createForOfIteratorHelperLoose.js
          esm/
            classPrivateFieldGet.js
            defineProperty.js
            AwaitValue.js
            applyDecs2203.js
            applyDecs2311.js
            classStaticPrivateFieldDestructureSet.js
            regeneratorValues.js
            package.json
            classPrivateGetter.js
            classPrivateFieldSet.js
            identity.js
            classPrivateFieldDestructureSet.js
            classCheckPrivateStaticAccess.js
            possibleConstructorReturn.js
            unsupportedIterableToArray.js
            get.js
            applyDecs2203R.js
            regeneratorRuntime.js
            regenerator.js
            classExtractFieldDescriptor.js
            applyDecoratedDescriptor.js
            typeof.js
            objectSpread.js
            classPrivateMethodSet.js
            construct.js
            maybeArrayLike.js
            applyDecs.js
            toConsumableArray.js
            setPrototypeOf.js
            classPrivateSetter.js
            wrapRegExp.js
            initializerDefineProperty.js
            newArrowCheck.js
            iterableToArray.js
            isNativeReflectConstruct.js
            regeneratorDefine.js
            superPropBase.js
            toPropertyKey.js
            toArray.js
            classApplyDescriptorGet.js
            dispose.js
            set.js
            tsRewriteRelativeImportExtensions.js
            arrayWithoutHoles.js
            temporalRef.js
            setFunctionName.js
            arrayLikeToArray.js
            usingCtx.js
            classStaticPrivateMethodGet.js
            taggedTemplateLiteral.js
            regeneratorAsyncGen.js
            nonIterableSpread.js
            importDeferProxy.js
            classStaticPrivateFieldSpecSet.js
            wrapAsyncGenerator.js
            superPropGet.js
            iterableToArrayLimit.js
            toPrimitive.js
            classPrivateMethodInitSpec.js
            decorate.js
            applyDecs2301.js
            inherits.js
            classCheckPrivateStaticFieldDescriptor.js
            interopRequireWildcard.js
            classPrivateFieldLooseBase.js
            objectWithoutPropertiesLoose.js
            classPrivateFieldLooseKey.js
            createClass.js
            temporalUndefined.js
            classStaticPrivateFieldSpecGet.js
            initializerWarningHelper.js
            extends.js
            classPrivateFieldInitSpec.js
            classApplyDescriptorDestructureSet.js
            classApplyDescriptorSet.js
            wrapNativeSuper.js
            classPrivateFieldSet2.js
            jsx.js
            nonIterableRest.js
            instanceof.js
            objectWithoutProperties.js
            createForOfIteratorHelper.js
            asyncToGenerator.js
            defineAccessor.js
            asyncGeneratorDelegate.js
            writeOnlyError.js
            OverloadYield.js
            classNameTDZError.js
            classStaticPrivateMethodSet.js
            createSuper.js
            asyncIterator.js
            awaitAsyncGenerator.js
            checkPrivateRedeclaration.js
            assertClassBrand.js
            interopRequireDefault.js
            regeneratorAsync.js
            checkInRHS.js
            arrayWithHoles.js
            classPrivateMethodGet.js
            isNativeFunction.js
            readOnlyError.js
            getPrototypeOf.js
            classPrivateFieldGet2.js
            using.js
            regeneratorKeys.js
            nullishReceiverError.js
            inheritsLoose.js
            taggedTemplateLiteralLoose.js
            applyDecs2305.js
            classCallCheck.js
            assertThisInitialized.js
            superPropSet.js
            objectDestructuringEmpty.js
            defineEnumerableProperties.js
            defaults.js
            tdz.js
            regeneratorAsyncIterator.js
            skipFirstGeneratorNext.js
            objectSpread2.js
            toSetter.js
            slicedToArray.js
            callSuper.js
            createForOfIteratorHelperLoose.js
      generator/
        package.json
        LICENSE
        README.md
        lib/
          printer.js
          source-map.js
          index.js
          buffer.js
          generators/
            modules.js
            statements.js
            classes.js
            expressions.js
            methods.js
            typescript.js
            jsx.js
            base.js
            flow.js
            types.js
            index.js
            template-literals.js
          node/
            whitespace.js
            parentheses.js
            index.js
      types/
        package.json
        LICENSE
        README.md
        lib/
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
          index.js.flow
          index-legacy.d.ts
          clone/
            clone.js.map
            cloneDeep.js.map
            clone.js
            cloneDeepWithoutLoc.js
            cloneNode.js.map
            cloneWithoutLoc.js
            cloneNode.js
            cloneDeepWithoutLoc.js.map
            cloneDeep.js
            cloneWithoutLoc.js.map
          converters/
            toBindingIdentifierName.js
            valueToNode.js.map
            toBindingIdentifierName.js.map
            gatherSequenceExpressions.js
            toComputedKey.js.map
            toStatement.js
            toExpression.js
            toSequenceExpression.js
            toStatement.js.map
            ensureBlock.js.map
            toSequenceExpression.js.map
            gatherSequenceExpressions.js.map
            toExpression.js.map
            toIdentifier.js
            toBlock.js.map
            toKeyAlias.js.map
            valueToNode.js
            toIdentifier.js.map
            toBlock.js
            toKeyAlias.js
            toComputedKey.js
            ensureBlock.js
          constants/
            index.js.map
            index.js
            generated/
              index.js.map
              index.js
          traverse/
            traverseFast.js
            traverse.js.map
            traverse.js
            traverseFast.js.map
          comments/
            removeComments.js.map
            inheritsComments.js.map
            addComment.js
            removeComments.js
            inheritInnerComments.js.map
            inheritLeadingComments.js
            inheritsComments.js
            addComment.js.map
            inheritLeadingComments.js.map
            inheritTrailingComments.js
            addComments.js
            inheritInnerComments.js
            addComments.js.map
            inheritTrailingComments.js.map
          ast-types/
            generated/
              index.js.map
              index.js
          retrievers/
            getOuterBindingIdentifiers.js.map
            getBindingIdentifiers.js
            getBindingIdentifiers.js.map
            getOuterBindingIdentifiers.js
          builders/
            validateNode.js
            validateNode.js.map
            typescript/
              createTSUnionType.js.map
              createTSUnionType.js
            generated/
              index.js.map
              uppercase.js
              index.js
              uppercase.js.map
            react/
              buildChildren.js
              buildChildren.js.map
            flow/
              createTypeAnnotationBasedOnTypeof.js.map
              createFlowUnionType.js
              createTypeAnnotationBasedOnTypeof.js
              createFlowUnionType.js.map
          utils/
            shallowEqual.js
            inherit.js
            inherit.js.map
            shallowEqual.js.map
            react/
              cleanJSXElementLiteralChild.js.map
              cleanJSXElementLiteralChild.js
          validators/
            isImmutable.js.map
            isType.js.map
            isReferenced.js.map
            isPlaceholderType.js.map
            is.js
            is.js.map
            matchesPattern.js
            isScope.js
            isValidIdentifier.js
            isNode.js.map
            isImmutable.js
            validate.js.map
            isValidES3Identifier.js.map
            isScope.js.map
            isType.js
            isNodesEquivalent.js
            isBlockScoped.js
            isBlockScoped.js.map
            validate.js
            matchesPattern.js.map
            isLet.js.map
            buildMatchMemberExpression.js
            isSpecifierDefault.js
            isBinding.js.map
            isBinding.js
            isLet.js
            isSpecifierDefault.js.map
            isValidIdentifier.js.map
            buildMatchMemberExpression.js.map
            isReferenced.js
            isNode.js
            isNodesEquivalent.js.map
            isValidES3Identifier.js
            isVar.js.map
            isVar.js
            isPlaceholderType.js
            generated/
              index.js.map
              index.js
            react/
              isCompatTag.js.map
              isCompatTag.js
              isReactComponent.js
              isReactComponent.js.map
          asserts/
            assertNode.js.map
            assertNode.js
            generated/
              index.js.map
              index.js
          definitions/
            utils.js
            placeholders.js.map
            experimental.js.map
            core.js
            typescript.js.map
            misc.js
            experimental.js
            flow.js.map
            utils.js.map
            core.js.map
            jsx.js.map
            typescript.js
            jsx.js
            index.js.map
            flow.js
            index.js
            placeholders.js
            misc.js.map
          modifications/
            removeProperties.js.map
            inherits.js.map
            removeProperties.js
            appendToMemberExpression.js
            prependToMemberExpression.js.map
            inherits.js
            appendToMemberExpression.js.map
            prependToMemberExpression.js
            removePropertiesDeep.js.map
            removePropertiesDeep.js
            typescript/
              removeTypeDuplicates.js.map
              removeTypeDuplicates.js
            flow/
              removeTypeDuplicates.js.map
              removeTypeDuplicates.js
        scripts/
          package.json
          generators/
            docs.js
            constants.js
            asserts.js
            validators.js
            ast-types.js
            typescript-legacy.js
            flow.js
            builders.js
          utils/
            formatBuilderName.js
            stringifyValidator.js
            lowerFirst.js
            toFunctionName.js
    cross-spawn/
      package.json
      LICENSE
      README.md
      index.js
      lib/
        enoent.js
        parse.js
        util/
          escape.js
          readShebang.js
          resolveCommand.js
    is-glob/
      package.json
      LICENSE
      README.md
      index.js
    gopd/
      CHANGELOG.md
      package.json
      gOPD.js
      LICENSE
      tsconfig.json
      README.md
      .eslintrc
      index.d.ts
      index.js
      gOPD.d.ts
      test/
        index.js
      .github/
        FUNDING.yml
    json-bigint/
      package.json
      LICENSE
      README.md
      index.js
      lib/
        stringify.js
        parse.js
    color-convert/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      route.js
      conversions.js
      index.js
    forwarded/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    prelude-ls/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      lib/
        List.js
        Str.js
        Func.js
        index.js
        Num.js
        Obj.js
    pause/
      package.json
      Readme.md
      Makefile
      .npmignore
      History.md
      index.js
    google-auth-library/
      package.json
      LICENSE
      README.md
      node_modules/
        gcp-metadata/
          package.json
          LICENSE
          README.md
          build/
            src/
              gcp-residency.js.map
              index.js.map
              index.d.ts
              index.js
              gcp-residency.d.ts
              gcp-residency.js
      build/
        src/
          shared.d.cts
          util.d.ts
          util.js
          index.d.ts
          index.js
          shared.cjs
          auth/
            jwtclient.js
            urlsubjecttokensupplier.js
            googleauth.d.ts
            oauth2common.d.ts
            externalclient.js
            computeclient.js
            computeclient.d.ts
            authclient.js
            oauth2common.js
            awsrequestsigner.js
            downscopedclient.js
            identitypoolclient.d.ts
            passthrough.d.ts
            iam.d.ts
            envDetect.d.ts
            loginticket.d.ts
            filesubjecttokensupplier.d.ts
            jwtclient.d.ts
            refreshclient.d.ts
            defaultawssecuritycredentialssupplier.d.ts
            pluggable-auth-client.js
            credentials.d.ts
            baseexternalclient.d.ts
            stscredentials.d.ts
            filesubjecttokensupplier.js
            googleauth.js
            authclient.d.ts
            oauth2client.js
            passthrough.js
            certificatesubjecttokensupplier.js
            refreshclient.js
            credentials.js
            externalAccountAuthorizedUserClient.d.ts
            idtokenclient.d.ts
            pluggable-auth-handler.d.ts
            certificatesubjecttokensupplier.d.ts
            impersonated.d.ts
            externalclient.d.ts
            executable-response.js
            iam.js
            awsrequestsigner.d.ts
            stscredentials.js
            awsclient.d.ts
            pluggable-auth-client.d.ts
            envDetect.js
            jwtaccess.d.ts
            defaultawssecuritycredentialssupplier.js
            impersonated.js
            jwtaccess.js
            pluggable-auth-handler.js
            loginticket.js
            oauth2client.d.ts
            baseexternalclient.js
            awsclient.js
            externalAccountAuthorizedUserClient.js
            executable-response.d.ts
            idtokenclient.js
            downscopedclient.d.ts
            identitypoolclient.js
            urlsubjecttokensupplier.d.ts
          crypto/
            shared.js
            crypto.d.ts
            shared.d.ts
            crypto.js
            node/
              crypto.d.ts
              crypto.js
            browser/
              crypto.d.ts
              crypto.js
    raw-body/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
    mimic-response/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    gtoken/
      package.json
      LICENSE
      README.md
      build/
        cjs/
          src/
            index.d.ts
            index.cjs
        esm/
          src/
            index.d.ts
            index.js
    sax/
      package.json
      README.md
      LICENSE.md
      lib/
        sax.js
    @pkgjs/
      parseargs/
        CHANGELOG.md
        utils.js
        package.json
        LICENSE
        README.md
        .editorconfig
        index.js
        examples/
          simple-hard-coded.js
          negate.js
          ordered-options.mjs
          limit-long-syntax.js
          is-default-value.js
          no-repeated-options.js
        internal/
          errors.js
          primordials.js
          validators.js
          util.js
    graceful-fs/
      graceful-fs.js
      package.json
      clone.js
      LICENSE
      README.md
      polyfills.js
      legacy-streams.js
    has/
      package.json
      README.md
      LICENSE-MIT
      test/
        index.js
      src/
        index.js
    napi-build-utils/
      package.json
      LICENSE
      README.md
      index.md
      index.js
    uint8array-extras/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    mime/
      CHANGELOG.md
      package.json
      mime.js
      LICENSE
      types.json
      README.md
      .npmignore
      cli.js
      src/
        test.js
        build.js
    statuses/
      package.json
      LICENSE
      README.md
      codes.json
      index.js
      HISTORY.md
    base64url/
      package.json
      LICENSE
      readme.md
      index.js
      dist/
        base64url.js
        pad-string.js
        pad-string.d.ts
        base64url.d.ts
        .gitkeep
    jsonfile/
      utils.js
      package.json
      LICENSE
      README.md
      index.js
    chance/
      package.json
      gulpfile.js
      LICENSE
      README.md
      .eslintignore
      chance.js
      .eslintrc.js
      dist/
        chance.min.js
        chance.min.js.map
      test/
        test.basic.js
        test.company.js
        test.address.js
        test.mobile.js
        test.animal.js
        test.music.js
        test.file.js
        test.time.js
        test.web.js
        test.helpers.js
        test.misc.js
        test.finance.js
        test.text.js
        test.person.js
        test.normal.js
        test.regional.js
        test.buffer.js
        test.fileWithContent.js
        helpers/
          phoneNumber.min.js
      .github/
        pull_request_template.md
        workflows/
          tests.yml
          publish.yml
          lint.yml
          coverage.yml
          docs.yml
      docs/
        chance.min.js
        inspector.png
        chance.css
        intro.md
        CNAME
        analytics.js
        README.md
        chance.min.js.map
        chance.js
        logo.png
        basics/
          natural.md
          bool.md
          character.md
          integer.md
          floating.md
          template.md
          prime.md
          falsy.md
          string.md
          letter.md
        finance/
          currency_pair.md
          exp_year.md
          euro.md
          exp.md
          currency.md
          exp_month.md
          dollar.md
          cc_type.md
          cc.md
        thing/
          animal.md
        person/
          cpf.md
          cf.md
          last.md
          aadhar.md
          ssn.md
          first.md
          gender.md
          name.md
          birthday.md
          prefix.md
          suffix.md
          zodiac.md
          age.md
        text/
          paragraph.md
          word.md
          syllable.md
          sentence.md
          emoji.md
        usage/
          browser.md
          cli.md
          node.md
          requirejs.md
          function.md
          bower.md
          seed.md
        music/
          note.md
          tempo.md
          music_genre.md
        time/
          millisecond.md
          date.md
          timestamp.md
          year.md
          month.md
          ampm.md
          hour.md
          second.md
          minute.md
          weekday.md
          hammertime.md
          timezone.md
        miscellaneous/
          normal.md
          n.md
          radio.md
          coin.md
          tv.md
          weighted.md
          unique.md
          rpg.md
          guid.md
          dice.md
          fileWithContent.md
          hash.md
          hidden.md
        web/
          color.md
          url.md
          twitter.md
          avatar.md
          google_analytics.md
          ipv6.md
          ip.md
          tld.md
          fbid.md
          company.md
          klout.md
          hashtag.md
          mac.md
          profession.md
          email.md
          domain.md
        location/
          city.md
          state.md
          longitude.md
          depth.md
          geohash.md
          street.md
          country.md
          phone.md
          province.md
          altitude.md
          coordinates.md
          areacode.md
          zip.md
          latitude.md
          locale.md
          address.md
          postal.md
          postcode.md
        mobile/
          bb_pin.md
          android_id.md
          apple_token.md
          wp8_anid2.md
          wp7_anid.md
        helpers/
          pad.md
          pickset.md
          mixin.md
          shuffle.md
          pickone.md
          pick.md
          capitalize.md
          set.md
    humanize-ms/
      package.json
      LICENSE
      README.md
      History.md
      index.js
    concat-map/
      package.json
      LICENSE
      .travis.yml
      index.js
      README.markdown
      test/
        map.js
      example/
        map.js
    ansi-styles/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    call-bound/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    passport-oauth2/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      lib/
        utils.js
        index.js
        strategy.js
        errors/
          tokenerror.js
          authorizationerror.js
          internaloautherror.js
        state/
          null.js
          store.js
          pkcesession.js
          session.js
      .github/
        FUNDING.yml
    isexe/
      package.json
      LICENSE
      README.md
      .npmignore
      index.js
      mode.js
      windows.js
      test/
        basic.js
    picomatch/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      index.js
      lib/
        utils.js
        constants.js
        picomatch.js
        scan.js
        parse.js
    which/
      CHANGELOG.md
      package.json
      which.js
      LICENSE
      README.md
      bin/
        node-which
    errs/
      package.json
      LICENSE
      README.md
      .npmignore
      .travis.yml
      lib/
        errs.js
      test/
        errs-test.js
        macros.js
        fixtures.js
      examples/
        handling-streams.js
        custom-error.js
        async-uncaught-exception.js
        stack.js
        sync-uncaught-exception.js
    open/
      package.json
      license
      readme.md
      index.d.ts
      index.js
      xdg-open
    package-json-from-dist/
      package.json
      README.md
      LICENSE.md
      dist/
        commonjs/
          package.json
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
        esm/
          package.json
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
    atomically/
      package.json
      license
      readme.md
      dist/
        constants.js
        types.d.ts
        constants.d.ts
        index.d.ts
        types.js
        index.js
        utils/
          lang.d.ts
          temp.d.ts
          scheduler.d.ts
          lang.js
          scheduler.js
          temp.js
      .nyc_output/
        af7432be-6f17-4c42-94eb-ac00c46b95fc.json
        ceeeef50-6926-41c0-91b2-771446718957.json
        a2b562cc-4021-472c-b0e7-61b08d0856cc.json
        3e844113-839b-4b48-a102-297deb37538a.json
        e69c4534-8d9f-4c8d-98f1-55020da1bd75.json
        processinfo/
          af7432be-6f17-4c42-94eb-ac00c46b95fc.json
          index.json
          ceeeef50-6926-41c0-91b2-771446718957.json
          a2b562cc-4021-472c-b0e7-61b08d0856cc.json
          3e844113-839b-4b48-a102-297deb37538a.json
          e69c4534-8d9f-4c8d-98f1-55020da1bd75.json
      .tap/
        processinfo/
          1139a7eb-c451-490b-a796-93ec17c301b4.json
          cbbc81f4-251f-4e57-969f-e5e3622d90cd.json
          2f325add-3ccd-4eb0-9a8e-03fcae4dda09.json
          727ff5b3-573d-4552-853f-883cb2c42a43.json
    node-uuid/
      bower.json
      package.json
      component.json
      README.md
      .npmignore
      uuid.js
      LICENSE.md
      v3.js
      lib/
        sha1-browser.js
      test/
        compare_v1.js
        test.js
        test.html
      bin/
        uuid
      benchmark/
        bench.gnu
        README.md
        bench.sh
        benchmark-native.c
        benchmark.js
    ansi-regex/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    eastasianwidth/
      package.json
      README.md
      eastasianwidth.js
    micromatch/
      package.json
      LICENSE
      README.md
      index.js
    path-is-absolute/
      package.json
      license
      readme.md
      index.js
    foreground-child/
      package.json
      LICENSE
      README.md
      dist/
        commonjs/
          package.json
          all-signals.js.map
          watchdog.js
          proxy-signals.d.ts.map
          proxy-signals.js.map
          all-signals.d.ts
          proxy-signals.d.ts
          proxy-signals.js
          index.js.map
          all-signals.d.ts.map
          all-signals.js
          index.d.ts
          watchdog.js.map
          watchdog.d.ts
          index.js
          watchdog.d.ts.map
          index.d.ts.map
        esm/
          package.json
          all-signals.js.map
          watchdog.js
          proxy-signals.d.ts.map
          proxy-signals.js.map
          all-signals.d.ts
          proxy-signals.d.ts
          proxy-signals.js
          index.js.map
          all-signals.d.ts.map
          all-signals.js
          index.d.ts
          watchdog.js.map
          watchdog.d.ts
          index.js
          watchdog.d.ts.map
          index.d.ts.map
    helmet/
      CHANGELOG.md
      index.d.cts
      package.json
      SECURITY.md
      index.mjs
      LICENSE
      README.md
      index.cjs
      index.d.mts
    xml2js/
      package.json
      LICENSE
      Cakefile
      README.md
      .npmignore
      lib/
        xml2js.js
      test/
        xml2js.test.coffee
        fixtures/
          sample.xml
      src/
        xml2js.coffee
    validator/
      package.json
      LICENSE
      validator.min.js
      README.md
      index.js
      validator.js
      lib/
        isAlphanumeric.js
        toDate.js
        isJWT.js
        isNumeric.js
        stripLow.js
        escape.js
        isDate.js
        ltrim.js
        isBase32.js
        isBoolean.js
        isLocale.js
        isISO6391.js
        isMACAddress.js
        isLength.js
        isEmail.js
        isULID.js
        isURL.js
        toInt.js
        unescape.js
        isHalfWidth.js
        isOctal.js
        isWhitelisted.js
        trim.js
        isLowercase.js
        rtrim.js
        isMobilePhone.js
        isISBN.js
        isCurrency.js
        isISO8601.js
        isUppercase.js
        isHash.js
        isFloat.js
        isBtcAddress.js
        isSurrogatePair.js
        isISIN.js
        isLatLong.js
        isMailtoURI.js
        alpha.js
        isMimeType.js
        isDecimal.js
        isHexColor.js
        isHexadecimal.js
        isBIC.js
        isMD5.js
        isISO31661Numeric.js
        isAlpha.js
        equals.js
        contains.js
        isISSN.js
        isByteLength.js
        isMagnetURI.js
        isHSL.js
        isVariableWidth.js
        isTime.js
        normalizeEmail.js
        isIP.js
        isPassportNumber.js
        isEthereumAddress.js
        isPort.js
        isAscii.js
        isBase64.js
        isFullWidth.js
        isIBAN.js
        isIPRange.js
        isAbaRouting.js
        isTaxID.js
        isJSON.js
        isPostalCode.js
        isMongoId.js
        isFQDN.js
        matches.js
        toFloat.js
        isUUID.js
        isVAT.js
        isSlug.js
        isEAN.js
        isISO31661Alpha3.js
        isRFC3339.js
        isIMEI.js
        isCreditCard.js
        isIdentityCard.js
        isInt.js
        isAfter.js
        isISO15924.js
        isStrongPassword.js
        toBoolean.js
        isEmpty.js
        isISRC.js
        isLuhnNumber.js
        whitelist.js
        isLicensePlate.js
        isISO4217.js
        isMultibyte.js
        isSemVer.js
        isIn.js
        isBase58.js
        isISO6346.js
        isDivisibleBy.js
        blacklist.js
        isDataURI.js
        isRgbColor.js
        isBefore.js
        isISO31661Alpha2.js
        util/
          algorithms.js
          nullUndefinedCheck.js
          includesString.js
          typeOf.js
          toString.js
          merge.js
          assertString.js
          checkHost.js
          includesArray.js
          multilineRegex.js
      es/
        index.js
        lib/
          isAlphanumeric.js
          toDate.js
          isJWT.js
          isNumeric.js
          stripLow.js
          escape.js
          isDate.js
          ltrim.js
          isBase32.js
          isBoolean.js
          isLocale.js
          isISO6391.js
          isMACAddress.js
          isLength.js
          isEmail.js
          isULID.js
          isURL.js
          toInt.js
          unescape.js
          isHalfWidth.js
          isOctal.js
          isWhitelisted.js
          trim.js
          isLowercase.js
          rtrim.js
          isMobilePhone.js
          isISBN.js
          isCurrency.js
          isISO8601.js
          isUppercase.js
          isHash.js
          isFloat.js
          isBtcAddress.js
          isSurrogatePair.js
          isISIN.js
          isLatLong.js
          isMailtoURI.js
          alpha.js
          isMimeType.js
          isDecimal.js
          isHexColor.js
          isHexadecimal.js
          isBIC.js
          isMD5.js
          isISO31661Numeric.js
          isAlpha.js
          equals.js
          contains.js
          isISSN.js
          isByteLength.js
          isMagnetURI.js
          isHSL.js
          isVariableWidth.js
          isTime.js
          normalizeEmail.js
          isIP.js
          isPassportNumber.js
          isEthereumAddress.js
          isPort.js
          isAscii.js
          isBase64.js
          isFullWidth.js
          isIBAN.js
          isIPRange.js
          isAbaRouting.js
          isTaxID.js
          isJSON.js
          isPostalCode.js
          isMongoId.js
          isFQDN.js
          matches.js
          toFloat.js
          isUUID.js
          isVAT.js
          isSlug.js
          isEAN.js
          isISO31661Alpha3.js
          isRFC3339.js
          isIMEI.js
          isCreditCard.js
          isIdentityCard.js
          isInt.js
          isAfter.js
          isISO15924.js
          isStrongPassword.js
          toBoolean.js
          isEmpty.js
          isISRC.js
          isLuhnNumber.js
          whitelist.js
          isLicensePlate.js
          isISO4217.js
          isMultibyte.js
          isSemVer.js
          isIn.js
          isBase58.js
          isISO6346.js
          isDivisibleBy.js
          blacklist.js
          isDataURI.js
          isRgbColor.js
          isBefore.js
          isISO31661Alpha2.js
          util/
            algorithms.js
            nullUndefinedCheck.js
            includesString.js
            typeOf.js
            toString.js
            merge.js
            assertString.js
            checkHost.js
            includesArray.js
            multilineRegex.js
    path-key/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    js-string-escape/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      index.js
    buffer/
      package.json
      AUTHORS.md
      LICENSE
      README.md
      index.d.ts
      index.js
    delayed-stream/
      package.json
      Readme.md
      Makefile
      .npmignore
      License
      lib/
        delayed_stream.js
    generator-function/
      CHANGELOG.md
      package.json
      index.mjs
      require.mjs
      legacy.js
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      index.d.mts
      LICENSE.md
      test/
        index.js
      .github/
        FUNDING.yml
    hash-wasm/
      CHANGELOG.md
      package.json
      biome.json
      rollup.config.mjs
      LICENSE
      tsconfig.json
      jest.config.js
      README.md
      .vscode/
        settings.json
      dist/
        xxhash3.umd.min.js
        index.esm.min.js
        sha512.umd.min.js
        blake2s.umd.min.js
        whirlpool.umd.min.js
        keccak.umd.min.js
        sha3.umd.min.js
        sha224.umd.min.js
        xxhash128.umd.min.js
        crc32.umd.min.js
        blake3.umd.min.js
        index.umd.min.js
        sha1.umd.min.js
        sha384.umd.min.js
        blake2b.umd.min.js
        hmac.umd.min.js
        pbkdf2.umd.min.js
        xxhash32.umd.min.js
        md4.umd.min.js
        md5.umd.min.js
        adler32.umd.min.js
        sm3.umd.min.js
        crc64.umd.min.js
        bcrypt.umd.min.js
        ripemd160.umd.min.js
        index.esm.js
        argon2.umd.min.js
        scrypt.umd.min.js
        xxhash64.umd.min.js
        sha256.umd.min.js
        index.umd.js
        lib/
          lockedCreate.d.ts
          xxhash3.d.ts
          xxhash64.d.ts
          blake2s.d.ts
          WASMInterface.d.ts
          keccak.d.ts
          argon2.d.ts
          sha384.d.ts
          crc64.d.ts
          sm3.d.ts
          blake2b.d.ts
          util.d.ts
          md4.d.ts
          ripemd160.d.ts
          md5.d.ts
          bcrypt.d.ts
          sha224.d.ts
          xxhash128.d.ts
          sha512.d.ts
          scrypt.d.ts
          hmac.d.ts
          whirlpool.d.ts
          blake3.d.ts
          adler32.d.ts
          pbkdf2.d.ts
          index.d.ts
          sha3.d.ts
          sha256.d.ts
          sha1.d.ts
          xxhash32.d.ts
          crc32.d.ts
          mutex.d.ts
      lib/
        index.ts
        scrypt.ts
        argon2.ts
        xxhash32.ts
        sha512.ts
        whirlpool.ts
        WASMInterface.ts
        xxhash3.ts
        lockedCreate.ts
        md5.ts
        blake3.ts
        sm3.ts
        bcrypt.ts
        util.ts
        pbkdf2.ts
        md4.ts
        hmac.ts
        ripemd160.ts
        mutex.ts
        sha384.ts
        crc32.ts
        sha1.ts
        blake2b.ts
        xxhash64.ts
        crc64.ts
        blake2s.ts
        keccak.ts
        sha224.ts
        xxhash128.ts
        adler32.ts
        sha256.ts
        sha3.ts
      src/
        adler32.c
        argon2.c
        xxhash32.c
        crc64.c
        blake2s.c
        sha512.c
        blake3.c
        xxhash128.c
        md5.c
        whirlpool.c
        sha3.c
        md4.c
        xxhash64.c
        blake2b.c
        sm3.c
        crc32.c
        ripemd160.c
        sha256.c
        sha1.c
        bcrypt.c
        scrypt.c
        xxhash3.c
        hash-wasm.h
    sntp/
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      .travis.yml
      index.js
      lib/
        index.js
      test/
        index.js
      examples/
        offset.js
        time.js
      node_modules/
        hoek/
          package.json
          Makefile
          LICENSE
          README.md
          .npmignore
          .travis.yml
          index.js
          lib/
            escape.js
            index.js
          images/
            hoek.png
          test/
            index.js
            escaper.js
            modules/
              test2.js
              test1.js
              test3.js
    cryptiles/
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      .travis.yml
      index.js
      lib/
        index.js
      test/
        index.js
    yargs-parser/
      browser.js
      CHANGELOG.md
      package.json
      README.md
      LICENSE.txt
      build/
        index.cjs
        lib/
          yargs-parser.js
          yargs-parser-types.js
          string-utils.js
          index.js
          tokenize-arg-string.js
    jsesc/
      package.json
      LICENSE-MIT.txt
      README.md
      jsesc.js
      man/
        jsesc.1
      bin/
        jsesc
    merge-stream/
      package.json
      LICENSE
      README.md
      index.js
    eventemitter2/
      package.json
      README.md
      index.js
      lib/
        eventemitter2.js
    encodeurl/
      package.json
      LICENSE
      README.md
      index.js
    request/
      package.json
      LICENSE
      README.md
      index.js
      tests/
        test-form.js
        test-onelineproxy.js
        test-https-strict.js
        test-proxy.js
        googledoodle.jpg
        squid.conf
        test-httpModule.js
        test-headers.js
        test-pipes.js
        test-emptyBody.js
        test-digest-auth.js
        test-http-signature.js
        test-localAddress.js
        test-protocol-changing-redirect.js
        test-follow-all.js
        test-qs.js
        unicycle.jpg
        run.js
        test-s3.js
        test-agentOptions.js
        test-oauth.js
        test-errors.js
        test-basic-auth.js
        test-timeout.js
        test-pool.js
        test-piped-redirect.js
        test-toJSON.js
        test-https.js
        test-follow-all-303.js
        test-redirect.js
        test-params.js
        server.js
        test-tunnel.js
        test-defaults.js
        test-body.js
        test-hawk.js
        ssl/
          npm-ca.crt
          test.crt
          test.key
          ca/
            ca.csr
            server.csr
            ca.cnf
            ca.crt
            server.crt
            ca.srl
            ca.crl
            ca.key
            server.js
            server.key
            server.cnf
      node_modules/
        combined-stream/
          package.json
          Readme.md
          License
          lib/
            combined_stream.js
        async/
          package.json
          component.json
          LICENSE
          README.md
          lib/
            async.js
        tunnel-agent/
          package.json
          LICENSE
          README.md
          index.js
        mime/
          package.json
          mime.js
          LICENSE
          README.md
          test.js
          types/
            node.types
            mime.types
        delayed-stream/
          package.json
          Readme.md
          Makefile
          .npmignore
          License
          lib/
            delayed_stream.js
          test/
            run.js
            common.js
            integration/
              test-pipe-resumes.js
              test-handle-source-errors.js
              test-delayed-stream-auto-pause.js
              test-delayed-http-upload.js
              test-max-data-size.js
              test-proxy-readable.js
              test-delayed-stream.js
              test-delayed-stream-pause.js
        form-data/
          node-form-data.sublime-project
          package.json
          Readme.md
          Makefile
          node-form-data.sublime-workspace
          .npmignore
          .travis.yml
          License
          sftp-config.json
          lib/
            form_data.js
          test/
            run.js
            common.js
            fixture/
              bacon.txt
              unicycle.jpg
            integration/
              test-get-boundary.js
              test-form-get-length.js
              test-submit-custom.js
              test-custom-filename.js
              test-submit.js
              test-pipe.js
              test-custom-headers.js
              test-http-response.js
        qs/
          package.json
          Readme.md
          .npmignore
          index.js
          .gitmodules
    toidentifier/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    array-differ/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    estraverse/
      package.json
      gulpfile.js
      LICENSE.BSD
      .jshintrc
      README.md
      estraverse.js
    detect-libc/
      package.json
      LICENSE
      README.md
      index.d.ts
      lib/
        elf.js
        process.js
        filesystem.js
        detect-libc.js
    yargs/
      CHANGELOG.md
      package.json
      index.mjs
      LICENSE
      browser.mjs
      README.md
      yargs
      index.cjs
      lib/
        platform-shims/
          browser.mjs
          esm.mjs
      build/
        index.cjs
        lib/
          completion.js
          completion-templates.js
          middleware.js
          validation.js
          yargs-factory.js
          yerror.js
          argsert.js
          parse-command.js
          usage.js
          command.js
          typings/
            yargs-parser-types.js
            common-types.js
          utils/
            is-promise.js
            set-blocking.js
            obj-filter.js
            which-module.js
            process-argv.js
            levenshtein.js
            apply-extends.js
      locales/
        en.json
        zh_CN.json
        hi.json
        pt.json
        zh_TW.json
        fi.json
        id.json
        nb.json
        pirate.json
        it.json
        fr.json
        ko.json
        de.json
        pt_BR.json
        pl.json
        th.json
        hu.json
        ja.json
        es.json
        nl.json
        tr.json
        nn.json
        be.json
        ru.json
      helpers/
        package.json
        helpers.mjs
        index.js
    has-flag/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    end-of-stream/
      package.json
      LICENSE
      README.md
      index.js
    merge-descriptors/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    inflight/
      package.json
      LICENSE
      README.md
      inflight.js
    bignumber.js/
      CHANGELOG.md
      package.json
      types.d.ts
      LICENCE.md
      README.md
      bignumber.js
      bignumber.mjs
      bignumber.d.ts
      bignumber.d.mts
      doc/
        API.html
    mimic-fn/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    merge2/
      package.json
      LICENSE
      README.md
      index.js
    universalify/
      package.json
      LICENSE
      README.md
      index.js
    jwa/
      package.json
      LICENSE
      README.md
      index.js
      opslevel.yml
    run-applescript/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    mime-types/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    commander/
      package.json
      Readme.md
      LICENSE
      esm.mjs
      index.js
      package-support.json
      typings/
        index.d.ts
        esm.d.mts
      lib/
        suggestSimilar.js
        error.js
        argument.js
        option.js
        help.js
        command.js
    aws-sign/
      package.json
      LICENSE
      README.md
      index.js
    dicer/
      package.json
      LICENSE
      README.md
      .travis.yml
      lib/
        Dicer.js
        HeaderParser.js
        PartStream.js
      test/
        test-endfinish.js
        test-headerparser.js
        test.js
        test-multipart.js
        test-multipart-extra-trailer.js
        test-multipart-nolisteners.js
        fixtures/
          many/
            original
            part6.header
            part2.header
            part3
            part4.header
            part4
            part1.header
            part6
            part7
            part7.header
            part5.header
            part3.header
            part5
            part1
            part2
          nested/
            original
            part2.header
            part1.header
            part1
            part2
          many-wrongboundary/
            original
            preamble.error
            preamble
          many-noend/
            original
            part6.header
            part2.header
            part3
            part4.header
            part4
            part1.header
            part6
            part7.header
            part5.header
            part3.header
            part5
            part1
            part2
          nested-full/
            original
            part2.header
            part1.header
            preamble.header
            part1
            part2
      bench/
        dicer-bench-multipart-parser.js
        parted-multipart.js
        parted-bench-multipart-parser.js
        multipartser-bench-multipart-parser.js
        multiparty-bench-multipart-parser.js
        formidable-bench-multipart-parser.js
      node_modules/
        string_decoder/
          package.json
          LICENSE
          README.md
          .npmignore
          index.js
        isarray/
          package.json
          component.json
          README.md
          index.js
          build/
            build.js
        readable-stream/
          package.json
          float.patch
          LICENSE
          README.md
          .npmignore
          readable.js
          duplex.js
          passthrough.js
          writable.js
          transform.js
          lib/
            _stream_readable.js
            _stream_passthrough.js
            _stream_transform.js
            _stream_duplex.js
            _stream_writable.js
    emoji-regex/
      package.json
      text.js
      LICENSE-MIT.txt
      README.md
      index.d.ts
      index.js
      es2015/
        text.js
        index.js
    sift/
      package.json
      sift.min.js.map
      sift.csp.min.js
      README.md
      MIT-LICENSE.txt
      index.d.ts
      sift.min.js
      sift.csp.min.js.map
      index.js
      lib/
        operations.d.ts
        index.js.map
        core.d.ts
        index.d.ts
        index.js
        utils.d.ts
      es/
        index.js.map
        index.js
      src/
        index.ts
        core.ts
        operations.ts
        utils.ts
      es5m/
        index.js.map
        index.js
    eslint-scope/
      package.json
      LICENSE
      README.md
      dist/
        eslint-scope.cjs
      lib/
        referencer.js
        scope-manager.js
        scope.js
        pattern-visitor.js
        assert.js
        definition.js
        index.js
        reference.js
        version.js
        variable.js
    buffer-from/
      package.json
      LICENSE
      readme.md
      index.js
    type-fest/
      package.json
      license-cc0
      readme.md
      index.d.ts
      license-mit
      source/
        if.d.ts
        opaque.d.ts
        camel-cased-properties.d.ts
        characters.d.ts
        require-at-least-one.d.ts
        literal-to-primitive.d.ts
        except.d.ts
        merge.d.ts
        required-keys-of.d.ts
        camel-case.d.ts
        int-closed-range.d.ts
        keys-of-union.d.ts
        arrayable.d.ts
        undefined-on-partial-deep.d.ts
        literal-union.d.ts
        pick-deep.d.ts
        is-uppercase.d.ts
        multidimensional-readonly-array.d.ts
        if-unknown.d.ts
        exclude-strict.d.ts
        union-to-intersection.d.ts
        exclusify-union.d.ts
        is-optional-key-of.d.ts
        tsconfig-json.d.ts
        has-optional-keys.d.ts
        less-than.d.ts
        conditional-simplify.d.ts
        structured-cloneable.d.ts
        async-return-type.d.ts
        pascal-case.d.ts
        set-return-type.d.ts
        optional-keys-of.d.ts
        multidimensional-array.d.ts
        partial-deep.d.ts
        is-never.d.ts
        require-exactly-one.d.ts
        kebab-cased-properties.d.ts
        string-slice.d.ts
        global-this.d.ts
        delimiter-cased-properties-deep.d.ts
        asyncify.d.ts
        shared-union-fields-deep.d.ts
        words.d.ts
        extract-strict.d.ts
        is-required-key-of.d.ts
        unknown-record.d.ts
        set-field-type.d.ts
        empty-object.d.ts
        conditional-simplify-deep.d.ts
        extends-strict.d.ts
        remove-prefix.d.ts
        partial-on-undefined-deep.d.ts
        exact.d.ts
        trim.d.ts
        entries.d.ts
        snake-case.d.ts
        is-any.d.ts
        non-empty-string.d.ts
        screaming-snake-case.d.ts
        camel-cased-properties-deep.d.ts
        all-union-fields.d.ts
        set-non-nullable-deep.d.ts
        readonly-keys-of.d.ts
        promisable.d.ts
        distributed-pick.d.ts
        exclude-rest-element.d.ts
        typed-array.d.ts
        set-non-nullable.d.ts
        int-range.d.ts
        numeric.d.ts
        if-empty-object.d.ts
        has-readonly-keys.d.ts
        merge-exclusive.d.ts
        has-required-keys.d.ts
        array-values.d.ts
        literal-to-primitive-deep.d.ts
        set-parameter-type.d.ts
        is-union.d.ts
        is-unknown.d.ts
        set-optional.d.ts
        conditional-keys.d.ts
        writable-deep.d.ts
        is-float.d.ts
        tuple-to-union.d.ts
        conditional-pick.d.ts
        shared-union-fields.d.ts
        pascal-cased-properties-deep.d.ts
        has-writable-keys.d.ts
        tuple-to-object.d.ts
        fixed-length-array.d.ts
        is-optional.d.ts
        greater-than.d.ts
        get.d.ts
        jsonifiable.d.ts
        snake-cased-properties.d.ts
        tagged.d.ts
        unknown-set.d.ts
        require-one-or-none.d.ts
        override-properties.d.ts
        single-key-object.d.ts
        conditional-pick-deep.d.ts
        is-undefined.d.ts
        set-readonly.d.ts
        is-null.d.ts
        is-equal.d.ts
        kebab-cased-properties-deep.d.ts
        if-null.d.ts
        conditional-except.d.ts
        basic.d.ts
        json-value.d.ts
        omit-deep.d.ts
        all-extend.d.ts
        is-literal.d.ts
        pick-index-signature.d.ts
        key-as-string.d.ts
        delimiter-cased-properties.d.ts
        entry.d.ts
        array-element.d.ts
        greater-than-or-equal.d.ts
        package-json.d.ts
        is-tuple.d.ts
        invariant-of.d.ts
        subtract.d.ts
        set-required-deep.d.ts
        non-empty-tuple.d.ts
        distributed-omit.d.ts
        or.d.ts
        simplify-deep.d.ts
        unknown-array.d.ts
        is-nullable.d.ts
        delimiter-case.d.ts
        value-of.d.ts
        unknown-map.d.ts
        spread.d.ts
        includes.d.ts
        primitive.d.ts
        required-deep.d.ts
        union-to-tuple.d.ts
        is-lowercase.d.ts
        pascal-cased-properties.d.ts
        omit-index-signature.d.ts
        less-than-or-equal.d.ts
        non-empty-object.d.ts
        is-writable-key-of.d.ts
        set-required.d.ts
        sum.d.ts
        schema.d.ts
        simplify.d.ts
        split-on-rest-element.d.ts
        writable.d.ts
        if-any.d.ts
        join.d.ts
        xor.d.ts
        require-all-or-none.d.ts
        stringified.d.ts
        find-global-type.d.ts
        jsonify.d.ts
        tuple-of.d.ts
        kebab-case.d.ts
        is-integer.d.ts
        if-never.d.ts
        string-repeat.d.ts
        array-splice.d.ts
        snake-cased-properties-deep.d.ts
        replace.d.ts
        writable-keys-of.d.ts
        split.d.ts
        array-indices.d.ts
        last-array-element.d.ts
        and.d.ts
        iterable-element.d.ts
        readonly-tuple.d.ts
        merge-deep.d.ts
        paths.d.ts
        array-tail.d.ts
        tagged-union.d.ts
        array-slice.d.ts
        readonly-deep.d.ts
        is-readonly-key-of.d.ts
        extract-rest-element.d.ts
        internal/
          characters.d.ts
          enforce-optional.d.ts
          type.d.ts
          object.d.ts
          numeric.d.ts
          tuple.d.ts
          keys.d.ts
          array.d.ts
          index.d.ts
          string.d.ts
        globals/
          observable-like.d.ts
          index.d.ts
    signal-exit/
      package.json
      README.md
      LICENSE.txt
      dist/
        cjs/
          browser.js
          signals.d.ts.map
          package.json
          signals.js
          browser.d.ts.map
          index.js.map
          browser.js.map
          index.d.ts
          signals.d.ts
          index.js
          browser.d.ts
          index.d.ts.map
          signals.js.map
        mjs/
          browser.js
          signals.d.ts.map
          package.json
          signals.js
          browser.d.ts.map
          index.js.map
          browser.js.map
          index.d.ts
          signals.d.ts
          index.js
          browser.d.ts
          index.d.ts.map
          signals.js.map
    path-type/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    fast-levenshtein/
      package.json
      README.md
      LICENSE.md
      levenshtein.js
    is-generator-function/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      .nvmrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        corejs.js
        uglified.js
        index.js
    axios/
      CHANGELOG.md
      index.d.cts
      package.json
      LICENSE
      README.md
      MIGRATION_GUIDE.md
      index.d.ts
      index.js
      dist/
        axios.js.map
        axios.js
        axios.min.js.map
        axios.min.js
        node/
          axios.cjs
          axios.cjs.map
        browser/
          axios.cjs
          axios.cjs.map
        esm/
          axios.js.map
          axios.js
          axios.min.js.map
          axios.min.js
      lib/
        utils.js
        axios.js
        defaults/
          index.js
          transitional.js
        platform/
          index.js
          node/
            index.js
            classes/
              URLSearchParams.js
              FormData.js
          common/
            utils.js
          browser/
            index.js
            classes/
              Blob.js
              URLSearchParams.js
              FormData.js
        env/
          README.md
          data.js
          classes/
            FormData.js
        core/
          mergeConfig.js
          Axios.js
          transformData.js
          AxiosHeaders.js
          README.md
          dispatchRequest.js
          AxiosError.js
          buildFullPath.js
          InterceptorManager.js
          settle.js
        adapters/
          adapters.js
          xhr.js
          README.md
          http.js
          fetch.js
        cancel/
          isCancel.js
          CancelToken.js
          CanceledError.js
        helpers/
          isAxiosError.js
          readBlob.js
          isAbsoluteURL.js
          parseProtocol.js
          null.js
          toFormData.js
          bind.js
          combineURLs.js
          buildURL.js
          ZlibHeaderTransformStream.js
          parseHeaders.js
          formDataToJSON.js
          speedometer.js
          README.md
          HttpStatusCode.js
          estimateDataURLDecodedBytes.js
          fromDataURI.js
          throttle.js
          cookies.js
          progressEventReducer.js
          AxiosURLSearchParams.js
          trackStream.js
          resolveConfig.js
          isURLSameOrigin.js
          callbackify.js
          validator.js
          AxiosTransformStream.js
          spread.js
          composeSignals.js
          deprecatedMethod.js
          toURLEncodedForm.js
          formDataToStream.js
    default-browser/
      package.json
      license
      readme.md
      index.d.ts
      index.js
      windows.js
    crypt/
      package.json
      crypt.js
      LICENSE.mkd
      README.mkd
    etag/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    function-bind/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      implementation.js
      index.js
      test/
        .eslintrc
        index.js
      .github/
        SECURITY.md
        FUNDING.yml
    safe-buffer/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
    github-from-package/
      package.json
      LICENSE
      .travis.yml
      index.js
      readme.markdown
      test/
        e.json
        d.json
        a.json
        b.json
        url.js
        c.json
      example/
        package.json
        url.js
    fetch-blob/
      package.json
      file.d.ts
      streams.cjs
      LICENSE
      from.js
      README.md
      from.d.ts
      index.d.ts
      file.js
      index.js
      node_modules/
        web-streams-polyfill/
          package.json
          LICENSE
          README.md
          dist/
            ponyfill.es2018.mjs
            polyfill.es6.js.map
            polyfill.es6.mjs
            polyfill.es2018.js
            polyfill.es2018.min.js.map
            ponyfill.js.map
            polyfill.es6.js
            polyfill.es6.min.js
            polyfill.js
            polyfill.es2018.mjs
            polyfill.js.map
            polyfill.es2018.mjs.map
            polyfill.mjs
            polyfill.es6.mjs.map
            ponyfill.es2018.js
            ponyfill.es6.mjs
            ponyfill.es6.js.map
            polyfill.es6.min.js.map
            polyfill.es2018.js.map
            polyfill.min.js
            ponyfill.mjs.map
            polyfill.min.js.map
            polyfill.mjs.map
            ponyfill.mjs
            polyfill.es2018.min.js
            ponyfill.es6.mjs.map
            ponyfill.es2018.js.map
            ponyfill.js
            ponyfill.es6.js
            ponyfill.es2018.mjs.map
            types/
              polyfill.d.ts
              ponyfill.d.ts
              tsdoc-metadata.json
          ponyfill/
            package.json
            es2018/
              package.json
            es6/
              package.json
          es2018/
            package.json
          es6/
            package.json
    pkgcloud/
      CHANGELOG.md
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      .travis.yml
      CONTRIBUTING.md
      lib/
        pkgcloud.js
        pkgcloud/
          azure/
            client.js
            index.js
            compute/
              flavor.js
              image.js
              index.js
              server.js
            utils/
              sharedkeytable.js
              templates.js
              constants.js
              hmacsha256sign.js
              azureApi.js
              cert.js
              sharedkey.js
              xml2json.js
            storage/
              utils.js
              container.js
              file.js
              index.js
            database/
              index.js
          iriscouch/
            index.js
            database/
              index.js
          common/
            http-signature.js
            azure-signature.js
            auth.js
            aws-signature.js
            index.js
            status.js
          openstack/
            client.js
            index.js
            network/
              port.js
              networkClient.js
              subnet.js
              network.js
              index.js
            context/
              identity.js
              serviceCatalog.js
              service.js
              index.js
            compute/
              computeClient.js
              flavor.js
              image.js
              index.js
              server.js
            storage/
              storageClient.js
              container.js
              file.js
              index.js
            identity/
              index.js
          telefonica/
            index.js
            compute/
              client.js
              index.js
          redistogo/
            index.js
            database/
              index.js
          mongolab/
            index.js
            database/
              index.js
          digitalocean/
            client.js
            index.js
            compute/
              flavor.js
              image.js
              index.js
              server.js
          core/
            loadbalancer/
              node.js
              loadbalancer.js
              index.js
            network/
              port.js
              subnet.js
              network.js
            base/
              client.js
              model.js
              index.js
            dns/
              record.js
              index.js
              zone.js
            compute/
              flavor.js
              image.js
              index.js
              server.js
            storage/
              container.js
              file.js
              index.js
          rackspace/
            client.js
            index.js
            loadbalancer/
              node.js
              virtualip.js
              loadbalancer.js
              index.js
              protocols.js
            blockstorage/
              volumetype.js
              snapshot.js
              volume.js
              index.js
            dns/
              record.js
              index.js
              zone.js
              status.js
            compute/
              index.js
              server.js
            storage/
              container.js
              file.js
              index.js
            identity/
              index.js
              rackspaceIdentity.js
            database/
              user.js
              instance.js
              database.js
              flavor.js
              index.js
          joyent/
            client.js
            index.js
            compute/
              flavor.js
              image.js
              index.js
              server.js
          mongohq/
            index.js
            database/
              index.js
          hp/
            client.js
            index.js
            network/
              index.js
            compute/
              index.js
            storage/
              index.js
            identity/
              hpIdentity.js
              index.js
          amazon/
            client.js
            index.js
            compute/
              flavor.js
              image.js
              index.js
              server.js
            storage/
              utils.js
              container.js
              file.js
              index.js
      examples/
        blockstorage/
          rackspace.js
        dns/
          rackspace.js
        compute/
          amazon.js
          rackspace.js
          joyent.js
          azure.js
        storage/
          amazon.js
          rackspace.js
          azure.js
        database/
          redistogo.js
          mongolab.js
          rackspace.js
          iriscouch.js
          azure.js
          mongohq.js
      node_modules/
        mime/
          package.json
          mime.js
          LICENSE
          README.md
          test.js
          types/
            node.types
            mime.types
        qs/
          package.json
          Readme.md
          .npmignore
          index.js
          .gitmodules
      docs/
        vocabulary.md
        logging-with-winston.md
        README.md
        providers/
          digitalocean.md
          amazon.md
          mongohq.md
          mongolab.md
          joyent.md
          iriscouch.md
          compute-commonality.md
          redistogo.md
          azure.md
          openstack/
            README.md
            network.md
            getting-started-compute.md
            storage.md
            compute.md
          rackspace/
            blockstorage.md
            databases.md
            README.md
            getting-started-compute.md
            storage.md
            compute.md
            loadbalancer.md
            dns.md
          hp/
            README.md
            network.md
            getting-started-compute.md
            storage.md
            compute.md
      .idea/
        encodings.xml
        pkgcloud.iml
        modules.xml
        workspace.xml
        jsLibraryMappings.xml
        vcs.xml
        misc.xml
        codeStyleSettings.xml
        scopes/
          scope_settings.xml
        dictionaries/
          kenn5998.xml
        libraries/
          Node_js_Dependencies_for_pkgcloud.xml
    ip/
      package.json
      README.md
      .npmignore
      lib/
        ip.js
      test/
        api-test.js
    filed/
      package.json
      README.md
      mimetypes.js
      rfc822.js
      main.js
      test/
        testdump-3
        testdump-1
        test.js
        testdump-2
        index.html
        server.js
    lodash.includes/
      package.json
      LICENSE
      README.md
      index.js
    once/
      package.json
      once.js
      LICENSE
      README.md
    source-map/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      source-map.js
      source-map.d.ts
      dist/
        source-map.min.js
        source-map.min.js.map
        source-map.debug.js
        source-map.js
      lib/
        source-map-generator.js
        source-node.js
        base64-vlq.js
        array-set.js
        base64.js
        source-map-consumer.js
        quick-sort.js
        binary-search.js
        util.js
        mapping-list.js
    webidl-conversions/
      package.json
      README.md
      LICENSE.md
      lib/
        index.js
    hawk/
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      .travis.yml
      index.js
      lib/
        browser.js
        utils.js
        client.js
        crypto.js
        index.js
        server.js
      images/
        hawk.png
        logo.png
      test/
        browser.js
        utils.js
        readme.js
        client.js
        crypto.js
        uri.js
        index.js
        server.js
      example/
        usage.js
    reusify/
      package.json
      SECURITY.md
      eslint.config.js
      LICENSE
      tsconfig.json
      README.md
      test.js
      reusify.d.ts
      reusify.js
      benchmarks/
        reuseNoCodeFunction.js
        createNoCodeFunction.js
        fib.js
      .github/
        dependabot.yml
        workflows/
          ci.yml
    tar-stream/
      package.json
      LICENSE
      pack.js
      README.md
      sandbox.js
      headers.js
      index.js
      extract.js
      node_modules/
        readable-stream/
          experimentalWarning.js
          package.json
          errors.js
          readable-browser.js
          LICENSE
          errors-browser.js
          README.md
          readable.js
          CONTRIBUTING.md
          GOVERNANCE.md
          lib/
            _stream_readable.js
            _stream_passthrough.js
            _stream_transform.js
            _stream_duplex.js
            _stream_writable.js
            internal/
    esutils/
      package.json
      LICENSE.BSD
      README.md
      lib/
        utils.js
        code.js
        ast.js
        keyword.js
    has-property-descriptors/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    util-deprecate/
      browser.js
      package.json
      LICENSE
      node.js
      README.md
      History.md
    passport-google-oauth20/
      package.json
      LICENSE
      README.md
      .npmignore
      CONTRIBUTING.md
      lib/
        index.js
        strategy.js
        errors/
          userinfoerror.js
          googleplusapierror.js
        profile/
          openid.js
          googleplus.js
      .github/
        PULL_REQUEST_TEMPLATE.md
        ISSUE_TEMPLATE.md
    asynckit/
      package.json
      serialOrdered.js
      LICENSE
      stream.js
      README.md
      serial.js
      index.js
      bench.js
      parallel.js
      lib/
        streamify.js
        readable_serial_ordered.js
        defer.js
        readable_asynckit.js
        readable_serial.js
        terminator.js
        readable_parallel.js
        iterate.js
        state.js
        async.js
        abort.js
    at-least-node/
      package.json
      LICENSE
      README.md
      index.js
    minimatch/
      package.json
      LICENSE
      README.md
      minimatch.js
    pkg/
      package.json
      LICENSE
      README.md
      dictionary/
        primus-spark-latency.js
        native-or-bluebird.js
        zeromq.js
        graceful-fs.js
        knex.js
        throng.js
        node-zookeeper-client.js
        nodemailer.js
        stripe-webhook-middleware.js
        colors.js
        ws.js
        puppeteer.js
        msgpack.js
        semver.js
        data-preflight.js
        regression.js
        v8flags.js
        exceljs.js
        pm2.js
        minstache.js
        pkginfo.js
        errors.js
        stylus.js
        exiftool.exe.js
        formidable.js
        steam-resources.js
        ed25519.js
        indexof.js
        steam.js
        connect-mongodb.js
        logform.js
        bunyan.js
        node-xlsx.js
        buffermaker.js
        socket.io-client.js
        electron.js
        fmt.js
        s3.js
        chokidar.js
        connect.js
        batch.js
        emailjs.js
        newrelic.js
        googleapis.js
        http-proxy.js
        transformers.js
        json-stringify-safe.js
        microjob.js
        mime.js
        github.js
        nightmare.js
        serialport.js
        fs-extra.js
        pg-types.js
        node-forge.js
        callsites.js
        multer.js
        feathers.js
        levelup.js
        cors.js
        grpc.js
        safe_datejs.js
        pg-cursor.js
        pg.js.js
        reload.js
        cross-env.js
        open.js
        log4js.js
        node-uuid.js
        nib.js
        moment.js
        sqlite3.js
        bytes.js
        require_optional.js
        http-server.js
        redis-parser.js
        got.js
        q.js
        pug.js
        webdriverio.js
        primus.js
        uglify-js.js
        ms.js
        octobat.js
        tiny-worker.js
        extender.js
        json-stringify-date.js
        connect-redis.js
        curve25519.js
        oauth2orize.js
        fsevents.js
        mongoose.js
        winston-uber.js
        module-deps.js
        gm.js
        markdown.js
        drivelist.js
        jsdom.js
        level.js
        svgo.js
        aws-sdk.js
        faye-websocket.js
        cookie.js
        update-notifier.js
        express.js
        leveldown.js
        node-libcurl.js
        supervisor.js
        gulp.js
        sails.js
        tesseract.js.js
        pouchdb.js
        request.js
        mdns.js
        opn.js
        yargs.js
        phantomjs-prebuilt.js
        nodegit.js
        heapdump.js
        nconf.js
        j.js
        time.js
        shelljs.js
        stripe.js
        blessed.js
        bcrypt.js
        babel-core.js
        lodash.js
        node-pre-gyp.js
        umd.js
        cross-spawn-async.js
        tmp.js
        engine.io.js
        muri.js
        minimatch.js
        verror.js
        underscore.js
        pmx.js
        phantom.js
        moment-timezone.js
        method-override.js
        kerberos.js
        voc.js
        node-notifier.js
        cron.js
        redis.js
        mongodb.js
        floordate.js
        coffee-script.js
        homebridge.js
        denymount.js
        sharp.js
        winston.js
        debug.js
        passport.js
        compression.js
        etcher-image-write.js
        npm-registry-client.js
        extsprintf.js
        pg.js
        connect-mongo.js
        publicsuffixlist.js
        pgpass.js
        express-load.js
        findup-sync.js
        errorhandler.js
        rechoir.js
        pg-query-stream.js
        steam-crypto.js
        nodemailer-sendmail-transport.js
        tabtab.js
        primus-emitter.js
        sinon.js
        nedb.js
        rc.js
        google-closure-compiler-java.js
        natives.js
        scrypt.js
        node-redis-pubsub.js
        machinepack-urls.js
        optimist.js
        any-promise.js
        mime-types.js
        pwd.js
        elasticsearch.js
        epoll.js
        node-sass.js
        punt.js
        compressjs.js
        geoip-lite.js
        nssocket.js
        hoek.js
        body-parser.js
        bindings.js
        later.js
        socket.io.js
        xlsx.js
        exiftool.pl.js
        hap-nodejs.js
        browserify.js
        async.js
        busboy.js
        sha3.js
        sax.js
        negotiator.js
        jsonwebtoken.js
        eslint.js
        express-session.js
        usage.js
        sequelize.js
        jade.js
        google-closure-compiler.js
        npm.js
        angular-bridge.js
        passport-local.js
        require-uncached.js
        xml2js.js
        raven.js
        ejs.js
        inquirer.js
        mongodb-core.js
        consolidate.js
        readable-stream.js
        bignum.js
        better-sqlite3.js
        strong-globalize.js
        tinify.js
        cookie-parser.js
        liftoff.js
        image-size.js
        diff.js
        mongoskin.js
        union.js
        sqip.js
        bson.js
      lib-es5/
        bin.js
        packer.js
        producer.js
        walker.js
        log.js
        chmod.js
        common.js
        detector.js
        refiner.js
        follow.js
        index.d.ts
        types.js
        help.js
        mach-o.js
        index.js
        compress_type.js
        fabricator.js
      prelude/
        diagnostic.js
        bootstrap.js
    bcryptjs/
      bower.json
      package.json
      LICENSE
      README.md
      .npmignore
      .travis.yml
      index.js
      .vscode/
        settings.json
      dist/
        bcrypt.min.js
        bcrypt.min.map
        README.md
        bcrypt.js
        bcrypt.min.js.gz
      bin/
        bcrypt
      scripts/
        build.js
      tests/
        suite.js
        quickbrown.txt
      externs/
        bcrypt.js
        minimal-env.js
      src/
        bower.json
        wrap.js
        bcrypt.js
        bcrypt/
          util.js
          impl.js
          util/
            base64.js
          prng/
            accum.js
            README.md
            isaac.js
    require-from-string/
      package.json
      license
      readme.md
      index.js
    mkdirp-classic/
      package.json
      LICENSE
      README.md
      index.js
    ieee754/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
    fresh/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    cookie-jar/
      package.json
      LICENSE
      README.md
      jar.js
      index.js
      tests/
        run.js
        test-cookiejar.js
        test-cookie.js
    stubborn-utils/
      package.json
      license
      readme.md
      dist/
        retryify_sync.js
        constants.js
        types.d.ts
        retryify_sync.d.ts
        retryify_async.js
        attemptify_sync.js
        attemptify_async.js
        attemptify_sync.d.ts
        constants.d.ts
        retryify_async.d.ts
        index.d.ts
        types.js
        index.js
        attemptify_async.d.ts
    escalade/
      package.json
      license
      readme.md
      index.d.ts
      index.d.mts
      dist/
        index.mjs
        index.js
      sync/
        index.mjs
        index.d.ts
        index.js
        index.d.mts
    inherits/
      package.json
      LICENSE
      README.md
      inherits.js
      inherits_browser.js
    negotiator/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
      lib/
        language.js
        charset.js
        encoding.js
        mediaType.js
    md5/
      package.json
      LICENSE
      webpack.config.js
      README.md
      test.js
      .travis.yml
      md5.js
      dist/
        md5.min.js
      demo/
        index.html
    data-uri-to-buffer/
      package.json
      README.md
      dist/
        index.js.map
        index.d.ts
        index.js
      src/
        index.ts
    array-union/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    is-callable/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    web-streams-polyfill/
      package.json
      LICENSE
      README.md
      dist/
        polyfill.es5.js
        polyfill.js
        ponyfill.es5.js
        ponyfill.mjs
        ponyfill.es5.mjs
        ponyfill.js
      polyfill/
        package.json
        es5/
          package.json
      es5/
        package.json
      types/
        polyfill.d.ts
        ponyfill.d.ts
        tsdoc-metadata.json
    @isaacs/
      cliui/
        package.json
        index.mjs
        README.md
        LICENSE.txt
        node_modules/
          wrap-ansi/
            package.json
            license
            readme.md
            index.d.ts
            index.js
          ansi-styles/
            package.json
            license
            readme.md
            index.d.ts
            index.js
          ansi-regex/
            package.json
            license
            readme.md
            index.d.ts
            index.js
          emoji-regex/
            package.json
            RGI_Emoji.d.ts
            text.js
            LICENSE-MIT.txt
            README.md
            index.d.ts
            text.d.ts
            index.js
            RGI_Emoji.js
            es2015/
              RGI_Emoji.d.ts
              text.js
              index.d.ts
              text.d.ts
              index.js
              RGI_Emoji.js
          strip-ansi/
            package.json
            license
            readme.md
            index.d.ts
            index.js
          string-width/
            package.json
            license
            readme.md
            index.d.ts
            index.js
        build/
          index.d.cts
          index.cjs
          lib/
            index.js
    content-type/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    javascript-obfuscator/
      CHANGELOG.md
      package.json
      LICENSE.BSD
      CODE_OF_CONDUCT.md
      tsconfig.json
      CLAUDE.md
      .nycrc.json
      README.md
      .eslintignore
      .prettierignore
      .eslintrc.js
      CONTRIBUTING.md
      .prettierrc.js
      .mocharc.json
      .ncurc
      typings/
        index.d.ts
        src/
          ASTParserFacade.d.ts
          JavaScriptObfuscatorCLIFacade.d.ts
          JavaScriptObfuscatorFacade.d.ts
          JavaScriptObfuscator.d.ts
          generators/
            identifier-names-generators/
              AbstractIdentifierNamesGenerator.d.ts
              MangledShuffledIdentifierNamesGenerator.d.ts
              DictionaryIdentifierNamesGenerator.d.ts
              MangledIdentifierNamesGenerator.d.ts
              HexadecimalIdentifierNamesGenerator.d.ts
          interfaces/
            IGeneratorOutput.d.ts
            IInitializable.d.ts
            ITransformer.d.ts
            IJavaScriptObfsucator.d.ts
            IEncodedValue.d.ts
            generators/
            code-transformers/
              ICodeTransformersRunner.d.ts
              ICodeTransformer.d.ts
            node/
              IScopeThroughIdentifiersTraverserCallbackData.d.ts
              IScopeIdentifiersTraverser.d.ts
              IScopeIdentifiersTraverserCallbackData.d.ts
            source-code/
              IObfuscationResult.d.ts
              ISourceCode.d.ts
              ISourceMap.d.ts
            logger/
              ILogger.d.ts
            container/
              IInversifyContainerFacade.d.ts
            node-transformers/
              IVisitor.d.ts
              INodeTransformer.d.ts
              INodeTransformersRunner.d.ts
            utils/
              IEscapeSequenceEncoder.d.ts
              IRandomGenerator.d.ts
              ISetUtils.d.ts
              ICryptUtilsStringArray.d.ts
              IArrayUtils.d.ts
              ILevelledTopologicalSorter.d.ts
              ICryptUtils.d.ts
              ITransformerNamesGroupsBuilder.d.ts
            storages/
              IWeakMapStorage.d.ts
              IArrayStorage.d.ts
              IMapStorage.d.ts
            options/
              ICLIOptions.d.ts
              IOptionsNormalizer.d.ts
              IOptions.d.ts
            analyzers/
              IAnalyzer.d.ts
            custom-code-helpers/
              ICustomCodeHelperObfuscator.d.ts
              ICustomCodeHelperGroup.d.ts
              ICustomCodeHelperFormatter.d.ts
              ICustomCodeHelper.d.ts
            custom-nodes/
              ICustomNode.d.ts
            cli/
              IFileData.d.ts
          code-transformers/
            CodeTransformersRunner.d.ts
            AbstractCodeTransformer.d.ts
            CodeTransformerNamesGroupsBuilder.d.ts
            preparing-transformers/
              HashbangOperatorTransformer.d.ts
          node/
            NodeLiteralUtils.d.ts
            NodeFactory.d.ts
            NodeUtils.d.ts
            NodeStatementUtils.d.ts
            NodeGuards.d.ts
            NodeMetadata.d.ts
            ScopeIdentifiersTraverser.d.ts
            NodeLexicalScopeUtils.d.ts
            NumericalExpressionDataToNodeConverter.d.ts
            NodeAppender.d.ts
          constants/
            Base64Alphabet.d.ts
            EcmaVersion.d.ts
            ProAdvertiseMessage.d.ts
            AlphabetStringUppercase.d.ts
            Base64AlphabetSwapped.d.ts
            AlphabetString.d.ts
            ReservedIdentifierNames.d.ts
            NumbersString.d.ts
          decorators/
            Initializable.d.ts
          source-code/
            ObfuscationResult.d.ts
            SourceCode.d.ts
          logger/
            Logger.d.ts
          container/
            InversifyContainerFacade.d.ts
            ServiceIdentifiers.d.ts
            modules/
          node-transformers/
            AbstractNodeTransformer.d.ts
            NodeTransformersRunner.d.ts
            NodeTransformerNamesGroupsBuilder.d.ts
            control-flow-transformers/
              StringArrayControlFlowTransformer.d.ts
              FunctionControlFlowTransformer.d.ts
              BlockStatementControlFlowTransformer.d.ts
            finalizing-transformers/
              EscapeSequenceTransformer.d.ts
              DirectivePlacementTransformer.d.ts
            string-array-transformers/
              StringArrayTransformer.d.ts
              StringArrayRotateFunctionTransformer.d.ts
              StringArrayScopeCallsWrapperTransformer.d.ts
            dead-code-injection-transformers/
              DeadCodeInjectionIdentifiersTransformer.d.ts
              DeadCodeInjectionTransformer.d.ts
            preparing-transformers/
              CustomCodeHelpersTransformer.d.ts
              ParentificationTransformer.d.ts
              MetadataTransformer.d.ts
              ObfuscatingGuardsTransformer.d.ts
              EvalCallExpressionTransformer.d.ts
              VariablePreserveTransformer.d.ts
            initializing-transformers/
              CommentsTransformer.d.ts
            rename-properties-transformers/
              RenamePropertiesTransformer.d.ts
            converting-transformers/
              TemplateLiteralTransformer.d.ts
              NumberToNumericalExpressionTransformer.d.ts
              BooleanLiteralTransformer.d.ts
              ObjectPatternPropertiesTransformer.d.ts
              SplitStringTransformer.d.ts
              ClassFieldTransformer.d.ts
              NumberLiteralTransformer.d.ts
              ExportSpecifierTransformer.d.ts
              MemberExpressionTransformer.d.ts
              ObjectExpressionKeysTransformer.d.ts
              ObjectExpressionTransformer.d.ts
            simplifying-transformers/
              BlockStatementSimplifyTransformer.d.ts
              ExpressionStatementsMergeTransformer.d.ts
              IfStatementSimplifyTransformer.d.ts
              VariableDeclarationsMergeTransformer.d.ts
              AbstractStatementSimplifyTransformer.d.ts
            rename-identifiers-transformers/
              ScopeThroughIdentifiersTransformer.d.ts
              LabeledStatementTransformer.d.ts
              ScopeIdentifiersTransformer.d.ts
          utils/
            RandomGenerator.d.ts
            Utils.d.ts
            LevelledTopologicalSorter.d.ts
            AdvertisementUtils.d.ts
            StringUtils.d.ts
            CryptUtilsStringArray.d.ts
            SetUtils.d.ts
            EscapeSequenceEncoder.d.ts
            NumberUtils.d.ts
            CryptUtils.d.ts
            AbstractTransformerNamesGroupsBuilder.d.ts
            ArrayUtils.d.ts
          storages/
            ArrayStorage.d.ts
            MapStorage.d.ts
            WeakMapStorage.d.ts
            control-flow-transformers/
              FunctionControlFlowStorage.d.ts
              StringControlFlowStorage.d.ts
            string-array-transformers/
              StringArrayStorage.d.ts
              LiteralNodesCacheStorage.d.ts
              StringArrayScopeCallsWrappersDataStorage.d.ts
              VisitedLexicalScopeNodesStackStorage.d.ts
            identifier-names-cache/
              PropertyIdentifierNamesCacheStorage.d.ts
              GlobalIdentifierNamesCacheStorage.d.ts
            custom-code-helpers/
              CustomCodeHelperGroupStorage.d.ts
          options/
            OptionsNormalizer.d.ts
            Options.d.ts
            ValidationErrorsFormatter.d.ts
            presets/
              Default.d.ts
              MediumObfuscation.d.ts
              LowObfuscation.d.ts
              NoCustomNodes.d.ts
              HighObfuscation.d.ts
            validators/
              IsInputFileName.d.ts
              IsAllowedForObfuscationTargets.d.ts
              IsDomainLockRedirectUrl.d.ts
              IsIdentifierNamesCache.d.ts
            normalizer-rules/
              IdentifierNamesCacheRule.d.ts
              DeadCodeInjectionRule.d.ts
              SourceMapFileNameRule.d.ts
              SplitStringsChunkLengthRule.d.ts
              SourceMapBaseUrlRule.d.ts
              InputFileNameRule.d.ts
              StringArrayEncodingRule.d.ts
              StringArrayWappersChainedCalls.d.ts
              ControlFlowFlatteningThresholdRule.d.ts
              DomainLockRule.d.ts
              DomainLockRedirectUrlRule.d.ts
              StringArrayCallsTransformThresholdRule.d.ts
              StringArrayRule.d.ts
              DeadCodeInjectionThresholdRule.d.ts
              SelfDefendingRule.d.ts
              SeedRule.d.ts
          analyzers/
            string-array-storage-analyzer/
              StringArrayStorageAnalyzer.d.ts
            calls-graph-analyzer/
              CallsGraphAnalyzer.d.ts
            scope-analyzer/
              ScopeAnalyzer.d.ts
            number-numerical-expression-analyzer/
              NumberNumericalExpressionAnalyzer.d.ts
            prevailing-kind-of-variables-analyzer/
              PrevailingKindOfVariablesAnalyzer.d.ts
          custom-code-helpers/
            AbstractCustomCodeHelperGroup.d.ts
            CustomCodeHelperFormatter.d.ts
            CustomCodeHelperObfuscator.d.ts
            AbstractCustomCodeHelper.d.ts
            console-output/
              ConsoleOutputDisableCodeHelper.d.ts
            calls-controller/
              CallsControllerFunctionCodeHelper.d.ts
            string-array/
              StringArrayRotateFunctionCodeHelper.d.ts
              StringArrayCallsWrapperBase64CodeHelper.d.ts
              StringArrayCallsWrapperRc4CodeHelper.d.ts
              StringArrayCodeHelper.d.ts
              StringArrayCallsWrapperCodeHelper.d.ts
            common/
            domain-lock/
              DomainLockCodeHelper.d.ts
            self-defending/
              SelfDefendingCodeHelper.d.ts
            debug-protection/
              DebugProtectionFunctionIntervalCodeHelper.d.ts
              DebugProtectionFunctionCallCodeHelper.d.ts
              DebugProtectionFunctionCodeHelper.d.ts
          custom-nodes/
            AbstractCustomNode.d.ts
            string-array-nodes/
              AbstractStringArrayCallNode.d.ts
              StringArrayScopeCallsWrapperVariableNode.d.ts
              StringArrayScopeCallsWrapperFunctionNode.d.ts
              StringArrayCallNode.d.ts
            control-flow-flattening-nodes/
              CallExpressionFunctionNode.d.ts
              BinaryExpressionFunctionNode.d.ts
              LiteralNode.d.ts
              LogicalExpressionFunctionNode.d.ts
              BlockStatementControlFlowFlatteningNode.d.ts
            object-expression-keys-transformer-nodes/
              ObjectExpressionVariableDeclarationHostNode.d.ts
            dead-code-injection-nodes/
              BlockStatementDeadCodeInjectionNode.d.ts
          types/
            TConstructor.d.ts
            TDictionary.d.ts
            TInitialData.d.ts
            TObfuscationResultsObject.d.ts
            TIdentifierNamesCacheDictionary.d.ts
            TIdentifierNamesCache.d.ts
            node/
              TObfuscatingGuard.d.ts
              TNumberLiteralNode.d.ts
              TScopeIdentifiersTraverserCallback.d.ts
              TNodeWithSingleStatementBody.d.ts
              TStringLiteralNode.d.ts
              TNumericalExpressionDataToNodeConverterLiteralNodeGetter.d.ts
              TNodeWithStatements.d.ts
              TNodeWithLexicalScope.d.ts
              TStatement.d.ts
              TNodeWithLexicalScopeStatements.d.ts
            container/
            node-transformers/
              TVisitorDirection.d.ts
              TVisitorFunction.d.ts
              TVisitorResult.d.ts
            utils/
              TTransformersRelationEdge.d.ts
              TTypeFromEnum.d.ts
            storages/
              TCustomCodeHelperGroupStorage.d.ts
            options/
              TRenamePropertiesMode.d.ts
              TInputOptions.d.ts
              TOptionsPreset.d.ts
              TOptionsNormalizerRule.d.ts
              TStringArrayIndexesType.d.ts
              TStringArrayEncoding.d.ts
              TInputCLIOptions.d.ts
              TStringArrayWrappersType.d.ts
            analyzers/
            custom-code-helpers/
              TCustomCodeHelpersGroupAppendMethodName.d.ts
              TCustomCodeHelpersGroupAppendMethods.d.ts
            cli/
              TCLISanitizer.d.ts
          cli/
            JavaScriptObfuscatorCLI.d.ts
            utils/
              IdentifierNamesCacheFileUtils.d.ts
              CLIUtils.d.ts
              ObfuscatedCodeFileUtils.d.ts
              SourceCodeFileUtils.d.ts
            sanitizers/
              BooleanSanitizer.d.ts
              ArraySanitizer.d.ts
          enums/
            ObfuscationTarget.d.ts
            StringSeparator.d.ts
            generators/
            code-transformers/
              CodeTransformer.d.ts
              CodeTransformationStage.d.ts
            node/
              NodeType.d.ts
              ObfuscatingGuardResult.d.ts
            logger/
              LoggingPrefix.d.ts
              LoggingMessage.d.ts
            node-transformers/
              NodeTransformationStage.d.ts
              NodeTransformer.d.ts
              VisitorDirection.d.ts
            storages/
              ControlFlowStorage.d.ts
            source-map/
              SourceMapMode.d.ts
              SourceMapSourcesMode.d.ts
            options/
            analyzers/
            custom-code-helpers/
              CustomCodeHelperGroup.d.ts
              CustomCodeHelper.d.ts
            custom-nodes/
              ControlFlowCustomNode.d.ts
              ObjectExpressionKeysTransformerCustomNode.d.ts
              DeadCodeInjectionCustomNode.d.ts
              StringArrayCustomNode.d.ts
      dist/
        index.cli.js
        index.js.LICENSE.txt
        index_debug.js
        index.cli.js.map
        index_debug.js.map
        index.js.map
        index.browser.js
        index_debug.js.LICENSE.txt
        index.browser.js.LICENSE.txt
        index.js
        index.browser.js.map
        index.cli.js.LICENSE.txt
      bin/
        javascript-obfuscator
      .husky/
        pre-commit
    fast-uri/
      package.json
      eslint.config.js
      .gitattributes
      LICENSE
      tsconfig.json
      README.md
      index.js
      lib/
        utils.js
        schemes.js
      test/
        parse.test.js
        ajv.test.js
        rfc-3986.test.js
        resolve.test.js
        uri-js.test.js
        equal.test.js
        util.test.js
        uri-js-compatibility.test.js
        serialize.test.js
        fixtures/
          uri-js-parse.json
          uri-js-serialize.json
      .github/
        tests_checker.yml
        .stale.yml
        dependabot.yml
        workflows/
          ci.yml
          package-manager-ci.yml
      benchmark/
        package.json
        string-array-to-hex-stripped.mjs
        non-simple-domain.mjs
        ws-is-secure.mjs
        benchmark.mjs
        equal.mjs
      types/
        index.test-d.ts
        index.d.ts
    es-set-tostringtag/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        index.js
    http-signature/
      package.json
      LICENSE
      README.md
      http_signing.md
      .npmignore
      .dir-locals.el
      lib/
        verify.js
        signer.js
        parser.js
        util.js
        index.js
    path-scurry/
      package.json
      README.md
      LICENSE.md
      dist/
        commonjs/
          package.json
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
        esm/
          package.json
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
    is-typed-array/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    range-parser/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    supports-color/
      browser.js
      package.json
      license
      readme.md
      index.js
    balanced-match/
      package.json
      README.md
      index.js
      LICENSE.md
      .github/
        FUNDING.yml
    formdata-polyfill/
      package.json
      formdata-to-blob.js
      LICENSE
      README.md
      esm.min.d.ts
      esm.min.js
      formdata.min.js
      FormData.js
    minipass/
      package.json
      LICENSE
      README.md
      dist/
        commonjs/
          package.json
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
        esm/
          package.json
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
    basic-auth/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
      node_modules/
        safe-buffer/
          package.json
          LICENSE
          README.md
          index.d.ts
          index.js
    type-is/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    media-typer/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    isarray/
      package.json
      component.json
      Makefile
      README.md
      .npmignore
      test.js
      .travis.yml
      index.js
    deep-is/
      package.json
      LICENSE
      .travis.yml
      index.js
      README.markdown
      test/
        NaN.js
        cmp.js
        neg-vs-pos-0.js
      example/
        cmp.js
    follow-redirects/
      package.json
      LICENSE
      README.md
      http.js
      debug.js
      https.js
      index.js
    streamsearch/
      package.json
      LICENSE
      README.md
      lib/
        sbmh.js
    http-errors/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    human-signals/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      build/
        src/
          core.js
          signals.js
          main.js.map
          core.js.map
          main.js
          realtime.js
          main.d.ts
          realtime.js.map
          signals.js.map
    underscore/
      package.json
      LICENSE
      CNAME
      README.md
      .npmignore
      underscore.js
      .travis.yml
      index.html
      CONTRIBUTING.md
      underscore-min.js
      index.js
      favicon.ico
    prebuild-install/
      CHANGELOG.md
      help.txt
      package.json
      proxy.js
      bin.js
      LICENSE
      download.js
      error.js
      asset.js
      log.js
      README.md
      util.js
      rc.js
      CONTRIBUTING.md
      index.js
    p-is-promise/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    body-parser/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
      lib/
        read.js
        types/
          text.js
          urlencoded.js
          json.js
          raw.js
      node_modules/
        ms/
          package.json
          license.md
          readme.md
          index.js
        debug/
          CHANGELOG.md
          package.json
          component.json
          Makefile
          LICENSE
          node.js
          README.md
          .npmignore
          .eslintrc
          karma.conf.js
          .travis.yml
          .coveralls.yml
          src/
            browser.js
            node.js
            debug.js
            index.js
            inspector-log.js
    glob-parent/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      index.js
    @types/
      node/
        http2.d.ts
        path.d.ts
        package.json
        https.d.ts
        child_process.d.ts
        zlib.d.ts
        process.d.ts
        test.d.ts
        os.d.ts
        domain.d.ts
        stream.d.ts
        v8.d.ts
        url.d.ts
        http.d.ts
        LICENSE
        util.d.ts
        string_decoder.d.ts
        diagnostics_channel.d.ts
        querystring.d.ts
        crypto.d.ts
        module.d.ts
        README.md
        dns.d.ts
        dgram.d.ts
        fs.d.ts
        punycode.d.ts
        globals.typedarray.d.ts
        constants.d.ts
        console.d.ts
        readline.d.ts
        events.d.ts
        index.d.ts
        buffer.buffer.d.ts
        cluster.d.ts
        worker_threads.d.ts
        inspector.generated.d.ts
        assert.d.ts
        trace_events.d.ts
        tty.d.ts
        async_hooks.d.ts
        vm.d.ts
        timers.d.ts
        wasi.d.ts
        tls.d.ts
        globals.d.ts
        net.d.ts
        buffer.d.ts
        perf_hooks.d.ts
        repl.d.ts
        compatibility/
          disposable.d.ts
          indexable.d.ts
          iterators.d.ts
          index.d.ts
        stream/
          consumers.d.ts
          promises.d.ts
          web.d.ts
        assert/
          strict.d.ts
        web-globals/
          fetch.d.ts
          events.d.ts
          abortcontroller.d.ts
          domexception.d.ts
        fs/
          promises.d.ts
        dns/
          promises.d.ts
        readline/
          promises.d.ts
        ts5.6/
          globals.typedarray.d.ts
          index.d.ts
          buffer.buffer.d.ts
        timers/
          promises.d.ts
      whatwg-url/
        package.json
        LICENSE
        README.md
        index.d.ts
        webidl2js-wrapper.d.ts
        lib/
          URL-impl.d.ts
          URLSearchParams.d.ts
          URLSearchParams-impl.d.ts
          URL.d.ts
      validator/
        package.json
        LICENSE
        README.md
        index.d.ts
        lib/
          isISO31661Alpha2.d.ts
          isPort.d.ts
          ltrim.d.ts
          isDecimal.d.ts
          isIP.d.ts
          isMD5.d.ts
          isIn.d.ts
          whitelist.d.ts
          isMailtoURI.d.ts
          isFQDN.d.ts
          isISSN.d.ts
          isISBN.d.ts
          isJWT.d.ts
          isCurrency.d.ts
          isLowercase.d.ts
          isLength.d.ts
          isRgbColor.d.ts
          isByteLength.d.ts
          isBefore.d.ts
          isISO4217.d.ts
          rtrim.d.ts
          isDate.d.ts
          isMultibyte.d.ts
          isFloat.d.ts
          isUppercase.d.ts
          isSlug.d.ts
          trim.d.ts
          isVariableWidth.d.ts
          isIMEI.d.ts
          isMongoId.d.ts
          isISO31661Alpha3.d.ts
          isInt.d.ts
          isAscii.d.ts
          isIdentityCard.d.ts
          isEAN.d.ts
          isFullWidth.d.ts
          toDate.d.ts
          unescape.d.ts
          isSemVer.d.ts
          isURL.d.ts
          isBase64.d.ts
          isULID.d.ts
          isLicensePlate.d.ts
          isOctal.d.ts
          isBoolean.d.ts
          isISO6391.d.ts
          isEmail.d.ts
          isISIN.d.ts
          isCreditCard.d.ts
          isEthereumAddress.d.ts
          equals.d.ts
          isWhitelisted.d.ts
          isDivisibleBy.d.ts
          isTaxID.d.ts
          isAbaRouting.d.ts
          isBIC.d.ts
          stripLow.d.ts
          isISO31661Numeric.d.ts
          isIPRange.d.ts
          isMagnetURI.d.ts
          matches.d.ts
          isLatLong.d.ts
          isNumeric.d.ts
          isHalfWidth.d.ts
          isISO15924.d.ts
          isRFC3339.d.ts
          isStrongPassword.d.ts
          isTime.d.ts
          isHexadecimal.d.ts
          isBtcAddress.d.ts
          escape.d.ts
          isMACAddress.d.ts
          isPassportNumber.d.ts
          toFloat.d.ts
          isAfter.d.ts
          isPostalCode.d.ts
          isBase32.d.ts
          isLuhnNumber.d.ts
          isUUID.d.ts
          isDataURI.d.ts
          isBase58.d.ts
          isISO8601.d.ts
          normalizeEmail.d.ts
          isMimeType.d.ts
          isEmpty.d.ts
          isAlpha.d.ts
          isLocale.d.ts
          isIBAN.d.ts
          contains.d.ts
          isHexColor.d.ts
          isMobilePhone.d.ts
          isHash.d.ts
          isSurrogatePair.d.ts
          isHSL.d.ts
          blacklist.d.ts
          toInt.d.ts
          isISO6346.d.ts
          isVAT.d.ts
          isAlphanumeric.d.ts
          isISRC.d.ts
          toBoolean.d.ts
          isJSON.d.ts
        es/
          lib/
            isISO31661Alpha2.d.ts
            isPort.d.ts
            ltrim.d.ts
            isDecimal.d.ts
            isIP.d.ts
            isMD5.d.ts
            isIn.d.ts
            whitelist.d.ts
            isMailtoURI.d.ts
            isFQDN.d.ts
            isISSN.d.ts
            isISBN.d.ts
            isJWT.d.ts
            isCurrency.d.ts
            isLowercase.d.ts
            isLength.d.ts
            isRgbColor.d.ts
            isByteLength.d.ts
            isBefore.d.ts
            isISO4217.d.ts
            rtrim.d.ts
            isDate.d.ts
            isMultibyte.d.ts
            isFloat.d.ts
            isUppercase.d.ts
            isSlug.d.ts
            trim.d.ts
            isVariableWidth.d.ts
            isMongoId.d.ts
            isISO31661Alpha3.d.ts
            isInt.d.ts
            isAscii.d.ts
            isIdentityCard.d.ts
            isEAN.d.ts
            isFullWidth.d.ts
            toDate.d.ts
            unescape.d.ts
            isSemVer.d.ts
            isURL.d.ts
            isBase64.d.ts
            isULID.d.ts
            isLicensePlate.d.ts
            isOctal.d.ts
            isBoolean.d.ts
            isISO6391.d.ts
            isEmail.d.ts
            isISIN.d.ts
            isCreditCard.d.ts
            isEthereumAddress.d.ts
            equals.d.ts
            isWhitelisted.d.ts
            isDivisibleBy.d.ts
            isTaxID.d.ts
            isAbaRouting.d.ts
            isBIC.d.ts
            stripLow.d.ts
            isISO31661Numeric.d.ts
            isIPRange.d.ts
            isMagnetURI.d.ts
            matches.d.ts
            isLatLong.d.ts
            isNumeric.d.ts
            isHalfWidth.d.ts
            isISO15924.d.ts
            isRFC3339.d.ts
            isStrongPassword.d.ts
            isTime.d.ts
            isHexadecimal.d.ts
            isBtcAddress.d.ts
            escape.d.ts
            isMACAddress.d.ts
            isPassportNumber.d.ts
            toFloat.d.ts
            isAfter.d.ts
            isPostalCode.d.ts
            isBase32.d.ts
            isLuhnNumber.d.ts
            isUUID.d.ts
            isDataURI.d.ts
            isBase58.d.ts
            isISO8601.d.ts
            normalizeEmail.d.ts
            isMimeType.d.ts
            isEmpty.d.ts
            isAlpha.d.ts
            isLocale.d.ts
            isIBAN.d.ts
            contains.d.ts
            isHexColor.d.ts
            isMobilePhone.d.ts
            isHash.d.ts
            isSurrogatePair.d.ts
            isHSL.d.ts
            blacklist.d.ts
            toInt.d.ts
            isISO6346.d.ts
            isVAT.d.ts
            isAlphanumeric.d.ts
            isISRC.d.ts
            toBoolean.d.ts
            isJSON.d.ts
      webidl-conversions/
        package.json
        LICENSE
        README.md
        index.d.ts
      minimatch/
        package.json
        LICENSE
        README.md
        index.d.ts
      node-fetch/
        package.json
        LICENSE
        externals.d.ts
        README.md
        index.d.ts
    deep-equal/
      package.json
      LICENSE
      .travis.yml
      index.js
      readme.markdown
      lib/
        keys.js
        is_arguments.js
      test/
        cmp.js
      example/
        cmp.js
    deep-extend/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      index.js
      lib/
        deep-extend.js
    simple-get/
      package.json
      LICENSE
      README.md
      index.js
      .github/
        dependabot.yml
        workflows/
          ci.yml
    on-headers/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    when-exit/
      package.json
      license
      readme.md
      dist/
        types.d.ts
        types.js
        node/
          interceptor.d.ts
          signals.js
          constants.js
          constants.d.ts
          interceptor.js
          index.d.ts
          signals.d.ts
          index.js
        browser/
          interceptor.d.ts
          interceptor.js
          index.d.ts
          index.js
    lodash/
      range.js
      wrapperValue.js
      omit.js
      minBy.js
      invoke.js
      isSymbol.js
      concat.js
      _arraySampleSize.js
      _composeArgsRight.js
      _baseIsArrayBuffer.js
      _baseKeys.js
      castArray.js
      toLower.js
      intersection.js
      before.js
      iteratee.js
      zipWith.js
      ary.js
      _arrayIncludesWith.js
      _initCloneArray.js
      _createHybrid.js
      _arrayReduceRight.js
      _baseMap.js
      _arraySample.js
      _nativeKeys.js
      _setToPairs.js
      _baseInvoke.js
      _baseSum.js
      _getFuncName.js
      _copySymbolsIn.js
      _mapCacheGet.js
      _arrayEach.js
      reverse.js
      escape.js
      partialRight.js
      isDate.js
      gt.js
      package.json
      sortedIndexOf.js
      split.js
      over.js
      isBoolean.js
      _baseTimes.js
      defaultsDeep.js
      mean.js
      _composeArgs.js
      rest.js
      floor.js
      property.js
      _mapToArray.js
      identity.js
      number.js
      _getValue.js
      _createCaseFirst.js
      matchesProperty.js
      _flatRest.js
      isArrayBuffer.js
      _replaceHolders.js
      _createCompounder.js
      flip.js
      _parent.js
      _baseClone.js
      lte.js
      _castArrayLikeObject.js
      startCase.js
      _isFlattenable.js
      isLength.js
      lastIndexOf.js
      _baseIteratee.js
      thru.js
      uniq.js
      _arrayMap.js
      _insertWrapDetails.js
      _baseValues.js
      get.js
      _setCacheAdd.js
      chunk.js
      groupBy.js
      _stringSize.js
      _createFlow.js
      _LazyWrapper.js
      isBuffer.js
      pull.js
      curryRight.js
      flatMapDepth.js
      _arrayReduce.js
      _equalArrays.js
      _baseCreate.js
      core.js
      clone.js
      at.js
      _getHolder.js
      _mapCacheDelete.js
      toIterator.js
      pullAllBy.js
      padEnd.js
      setWith.js
      _stackClear.js
      _baseAt.js
      isMatchWith.js
      cloneWith.js
      toPath.js
      isObjectLike.js
      _baseUniq.js
      trimStart.js
      flatMapDeep.js
      _compareMultiple.js
      _asciiWords.js
      toNumber.js
      _safeGet.js
      unescape.js
      _baseRandom.js
      _setWrapToString.js
      chain.js
      _hashGet.js
      each.js
      _baseEvery.js
      _createRecurry.js
      _baseSetData.js
      trim.js
      sortBy.js
      gte.js
      bind.js
      difference.js
      _createPartial.js
      _baseToPairs.js
      after.js
      _createBaseEach.js
      _asciiToArray.js
      _castSlice.js
      core.min.js
      _baseIsTypedArray.js
      templateSettings.js
      last.js
      once.js
      _createCurry.js
      _WeakMap.js
      result.js
      deburr.js
      _basePullAll.js
      pickBy.js
      _toKey.js
      defer.js
      _listCacheSet.js
      _countHolders.js
      _cloneTypedArray.js
      curry.js
      LICENSE
      sortedLastIndexBy.js
      isArguments.js
      unset.js
      _stackSet.js
      isNumber.js
      xorBy.js
      _equalObjects.js
      take.js
      _baseToNumber.js
      function.js
      remove.js
      _nodeUtil.js
      _strictIndexOf.js
      cond.js
      isTypedArray.js
      pullAll.js
      flatMap.js
      _memoizeCapped.js
      negate.js
      _isIterateeCall.js
      array.js
      _MapCache.js
      wrap.js
      propertyOf.js
      pullAt.js
      _charsEndIndex.js
      _customOmitClone.js
      _baseForOwnRight.js
      _setToArray.js
      _baseSortedIndex.js
      fromPairs.js
      attempt.js
      wrapperAt.js
      toFinite.js
      includes.js
      compact.js
      toArray.js
      plant.js
      _createMathOperation.js
      assignWith.js
      _baseSample.js
      camelCase.js
      xorWith.js
      unzipWith.js
      _listCacheDelete.js
      _baseReduce.js
      _baseClamp.js
      sortedIndex.js
      _DataView.js
      set.js
      zipObjectDeep.js
      _baseMatchesProperty.js
      _mapCacheHas.js
      commit.js
      isMap.js
      _cloneSymbol.js
      _mapCacheSet.js
      mapKeys.js
      _mergeData.js
      isNaN.js
      update.js
      _castFunction.js
      max.js
      eachRight.js
      _baseRange.js
      _baseGt.js
      partition.js
      _Symbol.js
      sortedLastIndex.js
      takeWhile.js
      _wrapperClone.js
      reduceRight.js
      _customDefaultsMerge.js
      _stringToPath.js
      _baseWrapperValue.js
      _Set.js
      lodash.min.js
      some.js
      entries.js
      sampleSize.js
      cloneDeepWith.js
      toInteger.js
      _baseIsEqual.js
      slice.js
      takeRightWhile.js
      isWeakSet.js
      _isMaskable.js
      stubTrue.js
      _initCloneObject.js
      tail.js
      _baseFindIndex.js
      toPlainObject.js
      _basePullAt.js
      _initCloneByTag.js
      _baseAggregator.js
      omitBy.js
      _createPadding.js
      find.js
      isObject.js
      kebabCase.js
      _baseGetTag.js
      _baseDelay.js
      create.js
      orderBy.js
      value.js
      entriesIn.js
      toPairsIn.js
      values.js
      xor.js
      _cloneRegExp.js
      isEqual.js
      _root.js
      README.md
      join.js
      isNative.js
      keys.js
      _setData.js
      _isIndex.js
      isError.js
      _baseProperty.js
      isArrayLikeObject.js
      _baseExtremum.js
      invokeMap.js
      _matchesStrictComparable.js
      pick.js
      pullAllWith.js
      sumBy.js
      sample.js
      _baseFill.js
      _baseInRange.js
      _ListCache.js
      differenceWith.js
      _baseAssign.js
      unionWith.js
      _baseForOwn.js
      _listCacheHas.js
      _baseShuffle.js
      _createCtor.js
      sum.js
      _baseFor.js
      _baseDifference.js
      _arraySome.js
      lowerFirst.js
      filter.js
      _baseToString.js
      _baseTrim.js
      add.js
      _createToPairs.js
      meanBy.js
      functionsIn.js
      math.js
      keyBy.js
      intersectionWith.js
      has.js
      reject.js
      sortedLastIndexOf.js
      object.js
      _baseHas.js
      _hasUnicodeWord.js
      _baseFlatten.js
      _arrayShuffle.js
      _baseLt.js
      _isStrictComparable.js
      toString.js
      _hashHas.js
      _baseSortedIndexBy.js
      methodOf.js
      isArrayLike.js
      _basePropertyOf.js
      _arrayLikeKeys.js
      upperFirst.js
      lodash.js
      replace.js
      first.js
      times.js
      isSet.js
      isUndefined.js
      _createRelationalOperation.js
      _assignValue.js
      uniqueId.js
      without.js
      isRegExp.js
      repeat.js
      toJSON.js
      findLastIndex.js
      isFunction.js
      findIndex.js
      _realNames.js
      _baseIndexOf.js
      _baseIsNative.js
      nthArg.js
      _baseIsArguments.js
      _baseMergeDeep.js
      _escapeHtmlChar.js
      _baseIntersection.js
      _assignMergeValue.js
      _baseSampleSize.js
      _copyObject.js
      _baseNth.js
      seq.js
      _isMasked.js
      _overRest.js
      mapValues.js
      bindAll.js
      _baseUpdate.js
      head.js
      flowRight.js
      _shuffleSelf.js
      collection.js
      flatten.js
      _stackDelete.js
      _baseSet.js
      _baseFunctions.js
      _baseSortBy.js
      findLast.js
      method.js
      _baseConforms.js
      conformsTo.js
      _baseIsMatch.js
      toLength.js
      uniqBy.js
      uniqWith.js
      _Hash.js
      now.js
      isMatch.js
      _Map.js
      _iteratorToArray.js
      drop.js
      isArray.js
      _apply.js
      _createFind.js
      _createBaseFor.js
      flattenDepth.js
      upperCase.js
      _baseXor.js
      ceil.js
      _getRawTag.js
      fill.js
      _objectToString.js
      _deburrLetter.js
      util.js
      stubArray.js
      _shortOut.js
      _baseHasIn.js
      words.js
      rangeRight.js
      merge.js
      _getView.js
      valuesIn.js
      findKey.js
      _baseAssignValue.js
      _basePick.js
      _toSource.js
      _isPrototype.js
      _customDefaultsAssignIn.js
      _getAllKeysIn.js
      _Stack.js
      assign.js
      toPairs.js
      isNull.js
      _nativeKeysIn.js
      stubFalse.js
      zip.js
      _arrayPush.js
      _arrayEvery.js
      flow.js
      startsWith.js
      _reEscape.js
      matches.js
      conforms.js
      _createOver.js
      escapeRegExp.js
      _stackGet.js
      extend.js
      valueOf.js
      _getSymbolsIn.js
      snakeCase.js
      _nativeCreate.js
      _equalByTag.js
      _getWrapDetails.js
      _listCacheGet.js
      round.js
      flake.lock
      sortedUniqBy.js
      partial.js
      _unicodeSize.js
      _stringToArray.js
      _baseForRight.js
      throttle.js
      _isKey.js
      _hasUnicode.js
      _unescapeHtmlChar.js
      _baseIsEqualDeep.js
      _castPath.js
      isInteger.js
      _baseZipObject.js
      random.js
      _copySymbols.js
      invert.js
      _baseIsMap.js
      wrapperReverse.js
      overEvery.js
      _isKeyable.js
      findLastKey.js
      dropWhile.js
      divide.js
      _baseFindKey.js
      dropRightWhile.js
      _getTag.js
      _baseMatches.js
      flake.nix
      _unicodeToArray.js
      defaultTo.js
      isWeakMap.js
      debounce.js
      _assocIndexOf.js
      _escapeStringChar.js
      _stackHas.js
      _castRest.js
      _arrayEachRight.js
      keysIn.js
      lt.js
      _hashSet.js
      _baseIsRegExp.js
      padStart.js
      _isLaziable.js
      clamp.js
      unzip.js
      _createAggregator.js
      _asciiSize.js
      _getMatchData.js
      bindKey.js
      memoize.js
      _createAssigner.js
      toSafeInteger.js
      _baseSlice.js
      _metaMap.js
      assignInWith.js
      unary.js
      _getSymbols.js
      _basePickBy.js
      multiply.js
      _setToString.js
      takeRight.js
      trimEnd.js
      maxBy.js
      _updateWrapDetails.js
      map.js
      _reorder.js
      indexOf.js
      _listCacheClear.js
      _baseEach.js
      sortedUniq.js
      every.js
      stubString.js
      stubObject.js
      sortedIndexBy.js
      _basePropertyDeep.js
      _baseLodash.js
      _createSet.js
      _baseIndexOfWith.js
      _coreJsData.js
      _getNative.js
      index.js
      nth.js
      inRange.js
      noop.js
      _cacheHas.js
      pad.js
      updateWith.js
      flattenDeep.js
      _reEvaluate.js
      _baseFilter.js
      _getPrototype.js
      endsWith.js
      shuffle.js
      _setCacheHas.js
      isEmpty.js
      forEachRight.js
      _baseRepeat.js
      _hasPath.js
      transform.js
      _baseOrderBy.js
      wrapperChain.js
      initial.js
      _baseUnset.js
      _baseInverter.js
      _baseSortedUniq.js
      _compareAscending.js
      _arrayFilter.js
      eq.js
      overArgs.js
      lang.js
      assignIn.js
      reduce.js
      _hashClear.js
      unionBy.js
      countBy.js
      _baseIsSet.js
      _baseIsDate.js
      _SetCache.js
      mergeWith.js
      _createBind.js
      lowerCase.js
      _charsStartIndex.js
      _arrayAggregator.js
      _baseGet.js
      spread.js
      forOwnRight.js
      differenceBy.js
      rearg.js
      _createWrap.js
      _baseUnary.js
      _baseEachRight.js
      forIn.js
      functions.js
      toUpper.js
      _trimmedEndIndex.js
      zipObject.js
      overSome.js
      _baseAssignIn.js
      _overArg.js
      mixin.js
      date.js
      _createInverter.js
      isFinite.js
      subtract.js
      _mapCacheClear.js
      _reInterpolate.js
      _strictLastIndexOf.js
      next.js
      dropRight.js
      isString.js
      truncate.js
      _getMapData.js
      _baseMerge.js
      isNil.js
      _lazyReverse.js
      isEqualWith.js
      wrapperLodash.js
      parseInt.js
      _lazyClone.js
      _defineProperty.js
      forInRight.js
      string.js
      _baseMean.js
      min.js
      template.js
      isPlainObject.js
      _baseSetToString.js
      release.md
      _createRange.js
      defaults.js
      _getAllKeys.js
      intersectionBy.js
      size.js
      _hashDelete.js
      _baseConformsTo.js
      capitalize.js
      _LodashWrapper.js
      _cloneArrayBuffer.js
      _getData.js
      _baseGetAllKeys.js
      fp.js
      _baseSome.js
      forEach.js
      _cloneBuffer.js
      _cloneDataView.js
      _unicodeWords.js
      cloneDeep.js
      _copyArray.js
      _Uint8Array.js
      extendWith.js
      _freeGlobal.js
      _baseKeysIn.js
      _baseIsNaN.js
      isSafeInteger.js
      isElement.js
      forOwn.js
      _createRound.js
      _Promise.js
      _arrayIncludes.js
      _baseWhile.js
      hasIn.js
      union.js
      delay.js
      invertBy.js
      _baseRest.js
      tap.js
      constant.js
      _lazyValue.js
      fp/
        range.js
        wrapperValue.js
        omit.js
        minBy.js
        invoke.js
        isSymbol.js
        _util.js
        concat.js
        paths.js
        _falseOptions.js
        castArray.js
        toLower.js
        intersection.js
        before.js
        iteratee.js
        zipWith.js
        ary.js
        findFrom.js
        findLastFrom.js
        padCharsStart.js
        reverse.js
        escape.js
        prop.js
        partialRight.js
        isDate.js
        gt.js
        sortedIndexOf.js
        split.js
        over.js
        isBoolean.js
        defaultsDeep.js
        mean.js
        rest.js
        floor.js
        all.js
        property.js
        identity.js
        number.js
        matchesProperty.js
        isArrayBuffer.js
        assignInAllWith.js
        flip.js
        assignInAll.js
        assoc.js
        lte.js
        startCase.js
        isLength.js
        lastIndexOf.js
        thru.js
        uniq.js
        get.js
        chunk.js
        groupBy.js
        isBuffer.js
        pull.js
        curryRight.js
        flatMapDepth.js
        clone.js
        at.js
        takeLastWhile.js
        toIterator.js
        pullAllBy.js
        padEnd.js
        pipe.js
        setWith.js
        trimCharsEnd.js
        isMatchWith.js
        nAry.js
        cloneWith.js
        toPath.js
        isObjectLike.js
        trimStart.js
        apply.js
        flatMapDeep.js
        toNumber.js
        unescape.js
        convert.js
        chain.js
        rangeStep.js
        each.js
        extendAll.js
        trimCharsStart.js
        trim.js
        sortBy.js
        gte.js
        bind.js
        difference.js
        whereEq.js
        getOr.js
        after.js
        mergeAll.js
        templateSettings.js
        last.js
        once.js
        result.js
        deburr.js
        pickBy.js
        defer.js
        zipAll.js
        curry.js
        sortedLastIndexBy.js
        isArguments.js
        unset.js
        isNumber.js
        xorBy.js
        take.js
        function.js
        remove.js
        cond.js
        isTypedArray.js
        pullAll.js
        flatMap.js
        negate.js
        spreadFrom.js
        array.js
        wrap.js
        propertyOf.js
        pullAt.js
        mergeAllWith.js
        fromPairs.js
        indexBy.js
        attempt.js
        wrapperAt.js
        toFinite.js
        includes.js
        compact.js
        toArray.js
        plant.js
        assignWith.js
        camelCase.js
        xorWith.js
        unzipWith.js
        _convertBrowser.js
        sortedIndex.js
        where.js
        always.js
        set.js
        zipObjectDeep.js
        commit.js
        isMap.js
        T.js
        mapKeys.js
        isNaN.js
        update.js
        max.js
        eachRight.js
        partition.js
        sortedLastIndex.js
        takeWhile.js
        reduceRight.js
        placeholder.js
        some.js
        entries.js
        sampleSize.js
        cloneDeepWith.js
        toInteger.js
        slice.js
        takeRightWhile.js
        isWeakSet.js
        stubTrue.js
        _mapping.js
        dropLast.js
        extendAllWith.js
        tail.js
        path.js
        toPlainObject.js
        omitBy.js
        restFrom.js
        find.js
        isObject.js
        kebabCase.js
        pathEq.js
        create.js
        orderBy.js
        value.js
        entriesIn.js
        toPairsIn.js
        padChars.js
        values.js
        xor.js
        isEqual.js
        propOr.js
        invokeArgsMap.js
        join.js
        isNative.js
        findLastIndexFrom.js
        keys.js
        equals.js
        isError.js
        contains.js
        isArrayLikeObject.js
        __.js
        invokeMap.js
        pick.js
        pullAllWith.js
        sumBy.js
        sample.js
        differenceWith.js
        F.js
        unionWith.js
        sum.js
        lowerFirst.js
        filter.js
        add.js
        findIndexFrom.js
        meanBy.js
        functionsIn.js
        math.js
        keyBy.js
        intersectionWith.js
        has.js
        reject.js
        sortedLastIndexOf.js
        object.js
        toString.js
        methodOf.js
        isArrayLike.js
        upperFirst.js
        replace.js
        first.js
        times.js
        isSet.js
        isUndefined.js
        propEq.js
        uniqueId.js
        without.js
        isRegExp.js
        repeat.js
        toJSON.js
        findLastIndex.js
        dissocPath.js
        isFunction.js
        findIndex.js
        nthArg.js
        allPass.js
        indexOfFrom.js
        seq.js
        mapValues.js
        bindAll.js
        head.js
        flowRight.js
        collection.js
        flatten.js
        findLast.js
        method.js
        conformsTo.js
        toLength.js
        uniqBy.js
        uniqWith.js
        now.js
        isMatch.js
        invertObj.js
        drop.js
        isArray.js
        flattenDepth.js
        assocPath.js
        upperCase.js
        ceil.js
        fill.js
        util.js
        stubArray.js
        zipObj.js
        words.js
        init.js
        rangeRight.js
        merge.js
        symmetricDifferenceBy.js
        valuesIn.js
        anyPass.js
        findKey.js
        assign.js
        toPairs.js
        isNull.js
        stubFalse.js
        zip.js
        flow.js
        startsWith.js
        matches.js
        conforms.js
        curryN.js
        escapeRegExp.js
        extend.js
        valueOf.js
        rangeStepRight.js
        snakeCase.js
        round.js
        sortedUniqBy.js
        partial.js
        throttle.js
        isInteger.js
        random.js
        invert.js
        wrapperReverse.js
        overEvery.js
        findLastKey.js
        dropWhile.js
        divide.js
        dropRightWhile.js
        takeLast.js
        identical.js
        defaultTo.js
        isWeakMap.js
        debounce.js
        any.js
        keysIn.js
        lt.js
        _baseConvert.js
        padStart.js
        clamp.js
        unzip.js
        bindKey.js
        memoize.js
        pluck.js
        toSafeInteger.js
        assignInWith.js
        unary.js
        curryRightN.js
        multiply.js
        symmetricDifference.js
        takeRight.js
        trimEnd.js
        maxBy.js
        symmetricDifferenceWith.js
        map.js
        indexOf.js
        sortedUniq.js
        every.js
        stubString.js
        stubObject.js
        sortedIndexBy.js
        padCharsEnd.js
        nth.js
        inRange.js
        noop.js
        pad.js
        updateWith.js
        flattenDeep.js
        assignAll.js
        juxt.js
        endsWith.js
        shuffle.js
        isEmpty.js
        defaultsDeepAll.js
        forEachRight.js
        trimChars.js
        transform.js
        wrapperChain.js
        initial.js
        props.js
        eq.js
        overArgs.js
        lang.js
        assignIn.js
        reduce.js
        unionBy.js
        countBy.js
        mergeWith.js
        lowerCase.js
        spread.js
        forOwnRight.js
        differenceBy.js
        rearg.js
        forIn.js
        functions.js
        toUpper.js
        zipObject.js
        overSome.js
        mixin.js
        date.js
        isFinite.js
        subtract.js
        next.js
        dropRight.js
        isString.js
        unapply.js
        truncate.js
        isNil.js
        isEqualWith.js
        wrapperLodash.js
        parseInt.js
        forInRight.js
        string.js
        min.js
        template.js
        isPlainObject.js
        pathOr.js
        defaults.js
        intersectionBy.js
        size.js
        capitalize.js
        forEach.js
        cloneDeep.js
        extendWith.js
        pickAll.js
        isSafeInteger.js
        isElement.js
        forOwn.js
        unnest.js
        invokeArgs.js
        defaultsAll.js
        useWith.js
        dropLastWhile.js
        compose.js
        includesFrom.js
        hasIn.js
        omitAll.js
        union.js
        delay.js
        invertBy.js
        assignAllWith.js
        tap.js
        constant.js
        dissoc.js
        lastIndexOfFrom.js
        complement.js
    supports-preserve-symlinks-flag/
      browser.js
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    keygrip/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    chalk/
      package.json
      license
      readme.md
      index.d.ts
      source/
        templates.js
        util.js
        index.js
    is-number/
      package.json
      LICENSE
      README.md
      index.js
    json-schema-traverse/
      package.json
      LICENSE
      README.md
      .eslintrc.yml
      index.d.ts
      index.js
      spec/
        index.spec.js
        .eslintrc.yml
        fixtures/
          schema.js
      .github/
        FUNDING.yml
        workflows/
          build.yml
          publish.yml
    hasown/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      .github/
        FUNDING.yml
    fill-range/
      package.json
      LICENSE
      README.md
      index.js
    express/
      package.json
      Readme.md
      LICENSE
      History.md
      index.js
      lib/
        utils.js
        express.js
        request.js
        view.js
        application.js
        response.js
        router/
          route.js
          layer.js
          index.js
        middleware/
          init.js
          query.js
      node_modules/
        ms/
          package.json
          license.md
          readme.md
          index.js
        debug/
          CHANGELOG.md
          package.json
          component.json
          Makefile
          LICENSE
          node.js
          README.md
          .npmignore
          .eslintrc
          karma.conf.js
          .travis.yml
          .coveralls.yml
          src/
            browser.js
            node.js
            debug.js
            index.js
            inspector-log.js
    accepts/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    agentkeepalive/
      browser.js
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
      lib/
        constants.js
        agent.js
        https_agent.js
    tslib/
      package.json
      SECURITY.md
      tslib.html
      CopyrightNotice.txt
      README.md
      tslib.js
      tslib.es6.js
      tslib.es6.html
      LICENSE.txt
      tslib.d.ts
      tslib.es6.mjs
      modules/
        package.json
        index.d.ts
        index.js
    safer-buffer/
      package.json
      Readme.md
      LICENSE
      dangerous.js
      Porting-Buffer.md
      safer.js
      tests.js
    gcp-metadata/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      node_modules/
        gaxios/
          CHANGELOG.md
          package.json
          LICENSE
          README.md
          build/
            src/
              common.d.ts
              retry.js.map
              retry.js
              gaxios.d.ts
              gaxios.js
              common.js
              gaxios.js.map
              index.js.map
              common.js.map
              retry.d.ts
              index.d.ts
              index.js
      build/
        src/
          gcp-residency.js.map
          index.js.map
          index.d.ts
          index.js
          gcp-residency.d.ts
          gcp-residency.js
    proxy-from-env/
      package.json
      LICENSE
      README.md
      .eslintrc
      test.js
      .travis.yml
      index.js
    tr46/
      package.json
      README.md
      index.js
      LICENSE.md
      lib/
        mappingTable.json
        regexes.js
        statusMapping.js
    mquery/
      package.json
      SECURITY.md
      LICENSE
      README.md
      History.md
      lib/
        utils.js
        mquery.js
        env.js
        permissions.js
        collection/
          node.js
          collection.js
          index.js
      .github/
        PULL_REQUEST_TEMPLATE.md
        ISSUE_TEMPLATE.md
      node_modules/
        debug/
          package.json
          LICENSE
          README.md
          src/
            browser.js
            node.js
            common.js
            index.js
    get-intrinsic/
      CHANGELOG.md
      package.json
      LICENSE
      .nycrc
      README.md
      .eslintrc
      index.js
      test/
        GetIntrinsic.js
      .github/
        FUNDING.yml
    hoek/
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      .travis.yml
      index.js
      lib/
        escape.js
        index.js
      images/
        hoek.png
      test/
        index.js
        escaper.js
        modules/
          test2.js
          test1.js
          test3.js
    on-finished/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    strip-ansi/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    acorn/
      CHANGELOG.md
      package.json
      LICENSE
      README.md
      dist/
        acorn.d.mts
        bin.js
        acorn.js
        acorn.d.ts
        acorn.mjs
      bin/
        acorn
    mongodb-connection-string-url/
      package.json
      LICENSE
      README.md
      .esm-wrapper.mjs
      lib/
        index.js.map
        redact.js
        index.d.ts
        redact.d.ts
        redact.js.map
        index.js
    gaxios/
      package.json
      LICENSE
      README.md
      node_modules/
        https-proxy-agent/
          package.json
          LICENSE
          README.md
          dist/
            parse-proxy-response.js
            parse-proxy-response.js.map
            index.js.map
            index.d.ts
            parse-proxy-response.d.ts
            index.js
            index.d.ts.map
            parse-proxy-response.d.ts.map
        agent-base/
          package.json
          LICENSE
          README.md
          dist/
            helpers.js.map
            helpers.js
            helpers.d.ts
            index.js.map
            helpers.d.ts.map
            index.d.ts
            index.js
            index.d.ts.map
        debug/
          package.json
          LICENSE
          README.md
          src/
            browser.js
            node.js
            common.js
            index.js
        node-fetch/
          package.json
          README.md
          LICENSE.md
          src/
            request.js
            body.js
            headers.js
            response.js
            index.js
            errors/
              abort-error.js
              fetch-error.js
              base.js
            utils/
              is.js
              multipart-parser.js
              is-redirect.js
              referrer.js
              get-search.js
          @types/
            index.d.ts
      build/
        cjs/
          tsconfig.cjs.tsbuildinfo
          test/
            test.retry.d.ts
            test.index.js.map
            test.retry.js.map
            test.getch.js.map
            test.getch.d.ts
            test.index.d.ts
            test.index.js
            test.getch.js
            test.retry.js
          browser-test/
            browser-test-runner.d.ts
            browser-test-runner.js
            browser-test-runner.js.map
            test.browser.js
            test.browser.js.map
            test.browser.d.ts
          src/
            interceptor.d.ts
            common.d.ts
            retry.js.map
            retry.js
            gaxios.d.ts
            gaxios.js
            interceptor.js.map
            common.js
            util.cjs
            gaxios.js.map
            index.js.map
            interceptor.js
            common.js.map
            util.d.cts
            retry.d.ts
            index.d.ts
            index.js
            util.cjs.map
          system-test/
            test.install.d.ts
            test.install.js
            test.install.js.map
        esm/
          tsconfig.tsbuildinfo
          package.json
          test/
            test.retry.d.ts
            test.index.js.map
            test.retry.js.map
            test.getch.js.map
            test.getch.d.ts
            test.index.d.ts
            test.index.js
            test.getch.js
            test.retry.js
          browser-test/
            browser-test-runner.d.ts
            browser-test-runner.js
            browser-test-runner.js.map
            test.browser.js
            test.browser.js.map
            test.browser.d.ts
          src/
            interceptor.d.ts
            common.d.ts
            retry.js.map
            retry.js
            gaxios.d.ts
            gaxios.js
            interceptor.js.map
            common.js
            util.cjs
            gaxios.js.map
            index.js.map
            interceptor.js
            common.js.map
            util.d.cts
            retry.d.ts
            index.d.ts
            index.js
            util.cjs.map
          system-test/
            test.install.d.ts
            test.install.js
            test.install.js.map
    form-data/
      CHANGELOG.md
      package.json
      README.md
      index.d.ts
      License
      lib/
        browser.js
        form_data.js
        populate.js
    mongoose/
      browser.js
      package.json
      SECURITY.md
      README.md
      index.js
      LICENSE.md
      dist/
        browser.umd.js
      lib/
        connection.js
        browser.js
        utils.js
        documentProvider.js
        validOptions.js
        options.js
        connectionState.js
        constants.js
        cast.js
        schemaType.js
        model.js
        mongoose.js
        schema.js
        browserDocument.js
        collection.js
        driver.js
        internal.js
        aggregate.js
        modifiedPathsSnapshot.js
        document.js
        index.js
        virtualType.js
        stateMachine.js
        query.js
        queryHelpers.js
        drivers/
          SPEC.md
          node-mongodb-native/
            connection.js
            bulkWriteResult.js
            collection.js
            index.js
          browser/
            binary.js
            objectid.js
            index.js
            decimal128.js
        plugins/
          saveSubdocs.js
          validateBeforeSave.js
          index.js
          trackTransaction.js
          sharding.js
        error/
          eachAsyncMultiError.js
          bulkSaveIncompleteError.js
          serverSelection.js
          parallelSave.js
          createCollectionsError.js
          cast.js
          messages.js
          mongooseError.js
          divergentArray.js
          validation.js
          strict.js
          syncIndexes.js
          objectExpected.js
          overwriteModel.js
          notFound.js
          objectParameter.js
          strictPopulate.js
          browserMissingSchema.js
          setOptionError.js
          invalidSchemaOption.js
          index.js
          parallelValidate.js
          validator.js
          missingSchema.js
          version.js
          bulkWriteError.js
        schema/
          number.js
          documentArray.js
          documentArrayElement.js
          array.js
          symbols.js
          int32.js
          bigint.js
          subdocument.js
          mixed.js
          boolean.js
          uuid.js
          map.js
          index.js
          objectId.js
          date.js
          string.js
          buffer.js
          double.js
          decimal128.js
          union.js
          operators/
            helpers.js
            text.js
            type.js
            geospatial.js
            exists.js
            bitwise.js
        options/
          saveOptions.js
          schemaUnionOptions.js
          schemaMapOptions.js
          schemaObjectIdOptions.js
          schemaTypeOptions.js
          propertyOptions.js
          schemaBufferOptions.js
          schemaNumberOptions.js
          schemaArrayOptions.js
          schemaDateOptions.js
          schemaSubdocumentOptions.js
          schemaStringOptions.js
          virtualOptions.js
          populateOptions.js
          schemaDocumentArrayOptions.js
        cast/
          number.js
          int32.js
          objectid.js
          bigint.js
          boolean.js
          uuid.js
          date.js
          string.js
          double.js
          decimal128.js
        cursor/
          queryCursor.js
          aggregationCursor.js
          changeStream.js
        types/
          arraySubdocument.js
          objectid.js
          subdocument.js
          uuid.js
          map.js
          index.js
          buffer.js
          double.js
          decimal128.js
          array/
            isMongooseArray.js
            index.js
            methods/
              index.js
          documentArray/
            isMongooseDocumentArray.js
            index.js
            methods/
              index.js
        helpers/
          arrayDepth.js
          isSimpleValidator.js
          setDefaultsOnInsert.js
          parallelLimit.js
          specialProperties.js
          minimize.js
          createJSONSchemaTypeDefinition.js
          get.js
          clone.js
          immediate.js
          each.js
          once.js
          isPOJO.js
          promiseOrCallback.js
          timers.js
          symbols.js
          omitUndefined.js
          firstKey.js
          updateValidators.js
          pluralize.js
          isObject.js
          printJestWarning.js
          getDefaultBulkwriteResult.js
          common.js
          isBsonType.js
          getFunctionName.js
          isPromise.js
          isAsyncFunction.js
          isMongooseObject.js
          getConstructorName.js
          processConnectionOptions.js
          discriminator/
            checkEmbeddedDiscriminatorKeyProjection.js
            applyEmbeddedDiscriminators.js
            getSchemaDiscriminatorByValue.js
            mergeDiscriminatorSchema.js
            getConstructor.js
            getDiscriminatorByValue.js
            areDiscriminatorValuesEqual.js
          model/
            pushNestedArrayPaths.js
            discriminator.js
            castBulkWrite.js
            applyDefaultsToPOJO.js
            applyStaticHooks.js
            decorateBulkWriteResult.js
            applyMethods.js
            applyStatics.js
            applyHooks.js
          schematype/
            handleImmutable.js
          timestamps/
            setDocumentTimestamps.js
            setupTimestamps.js
          update/
            moveImmutableProperties.js
            removeUnusedArrayFilters.js
            updatedPathsByArrayFilter.js
            castArrayFilters.js
            applyTimestampsToChildren.js
            modifiedPaths.js
            applyTimestampsToUpdate.js
            decorateUpdateWithVersionKey.js
          document/
            handleSpreadDoc.js
            applyDefaults.js
            getDeepestSubdocumentForPath.js
            applyTimestamps.js
            getEmbeddedDiscriminatorPath.js
            cleanModifiedSubpaths.js
            applyVirtuals.js
            compile.js
          error/
            combinePathErrors.js
          aggregate/
            prepareDiscriminatorPipeline.js
            stringifyFunctionOperators.js
          projection/
            isInclusive.js
            isNestedProjection.js
            parseProjection.js
            isSubpath.js
            hasIncludedChildren.js
            isPathSelectedInclusive.js
            applyProjection.js
            isExclusive.js
            isDefiningProjection.js
            isPathExcluded.js
          path/
            setDottedPath.js
            parentPaths.js
          schema/
            applyPlugins.js
            getIndexes.js
            applyWriteConcern.js
            applyReadConcern.js
            getKeysInSchemaOrder.js
            getPath.js
            handleTimestampOption.js
            addAutoId.js
            cleanPositionalOperators.js
            merge.js
            handleIdOption.js
            getSubdocumentStrictValue.js
            idGetter.js
            applyBuiltinPlugins.js
          query/
            trusted.js
            isOperator.js
            sanitizeFilter.js
            castFilterPath.js
            handleReadPreferenceAliases.js
            cast$expr.js
            handleImmutable.js
            hasDollarKeys.js
            castUpdate.js
            applyGlobalOption.js
            getEmbeddedDiscriminatorPath.js
            sanitizeProjection.js
            validOps.js
            selectPopulatedFields.js
          cursor/
            eachAsync.js
          topology/
            isSSLError.js
            isAtlas.js
            allServersUnknown.js
          indexes/
            isTextIndex.js
            isIndexEqual.js
            isDefaultIdIndex.js
            getRelatedIndexes.js
            applySchemaCollation.js
            isIndexSpecEqual.js
            isTimeseriesIndex.js
            decorateDiscriminatorIndexOptions.js
          populate/
            validateRef.js
            getSchemaTypes.js
            removeDeselectedForeignField.js
            getVirtual.js
            skipPopulateValue.js
            createPopulateQueryFilter.js
            leanPopulateMap.js
            setPopulatedVirtualValue.js
            lookupLocalFields.js
            markArraySubdocsPopulated.js
            assignVals.js
            modelNamesFromRefPath.js
            assignRawDocsToIdStructure.js
            getModelsMapForPopulate.js
      types/
        inferschematype.d.ts
        schematypes.d.ts
        utility.d.ts
        cursor.d.ts
        document.d.ts
        types.d.ts
        helpers.d.ts
        session.d.ts
        populate.d.ts
        augmentations.d.ts
        aggregate.d.ts
        inferrawdoctype.d.ts
        models.d.ts
        connection.d.ts
        collection.d.ts
        validation.d.ts
        indexes.d.ts
        query.d.ts
        index.d.ts
        error.d.ts
        expressions.d.ts
        mongooseoptions.d.ts
        middlewares.d.ts
        pipelinestage.d.ts
        callback.d.ts
        schemaoptions.d.ts
        virtuals.d.ts
    string-width/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    braces/
      package.json
      LICENSE
      README.md
      index.js
      lib/
        utils.js
        constants.js
        stringify.js
        expand.js
        compile.js
        parse.js
    readable-stream/
      package.json
      readable-browser.js
      LICENSE
      duplex-browser.js
      README.md
      readable.js
      duplex.js
      passthrough.js
      writable-browser.js
      .travis.yml
      CONTRIBUTING.md
      writable.js
      transform.js
      GOVERNANCE.md
      lib/
        _stream_readable.js
        _stream_passthrough.js
        _stream_transform.js
        _stream_duplex.js
        _stream_writable.js
        internal/
          streams/
            destroy.js
            stream.js
            BufferList.js
            stream-browser.js
      doc/
        wg-meetings/
          2015-01-30.md
      node_modules/
        safe-buffer/
          package.json
          LICENSE
          README.md
          index.d.ts
          index.js
    serve-static/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    type-check/
      package.json
      LICENSE
      README.md
      lib/
        check.js
        parse-type.js
        index.js
    bundle-name/
      package.json
      license
      readme.md
      index.js
    tsscmp/
      package.json
      LICENSE
      README.md
      appveyor.yml
      .travis.yml
      lib/
        index.js
      test/
        unit/
          index.js
        benchmark/
          index.js
    node-abi/
      package.json
      abi_registry.json
      LICENSE
      README.md
      index.js
    is-extglob/
      package.json
      LICENSE
      README.md
      index.js
    lodash.isnumber/
      package.json
      LICENSE
      README.md
      index.js
    abort-controller/
      browser.js
      package.json
      LICENSE
      browser.mjs
      polyfill.js
      README.md
      polyfill.mjs
      dist/
        abort-controller.umd.js.map
        abort-controller.d.ts
        abort-controller.mjs.map
        abort-controller.js.map
        abort-controller.js
        abort-controller.umd.js
        abort-controller.mjs
    cookies/
      package.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    rimraf/
      package.json
      LICENSE
      README.md
      dist/
        commonjs/
          package.json
          rimraf-manual.js
          fs.d.ts.map
          rimraf-native.d.ts
          readdir-or-error.js.map
          ignore-enoent.js
          rimraf-windows.js
          rimraf-posix.d.ts
          rimraf-native.d.ts.map
          rimraf-manual.js.map
          fix-eperm.js.map
          ignore-enoent.js.map
          readdir-or-error.js
          rimraf-windows.d.ts.map
          fix-eperm.d.ts.map
          fix-eperm.js
          rimraf-move-remove.d.ts.map
          rimraf-manual.d.ts
          retry-busy.d.ts.map
          retry-busy.js.map
          platform.d.ts
          use-native.d.ts.map
          rimraf-windows.js.map
          readdir-or-error.d.ts.map
          platform.js
          opt-arg.d.ts
          rimraf-move-remove.d.ts
          path-arg.js.map
          fix-eperm.d.ts
          rimraf-move-remove.js.map
          fs.d.ts
          fs.js.map
          rimraf-posix.js
          rimraf-native.js.map
          ignore-enoent.d.ts.map
          retry-busy.d.ts
          path-arg.js
          index.js.map
          rimraf-native.js
          rimraf-posix.d.ts.map
          use-native.js
          default-tmp.js
          index.d.ts
          readdir-or-error.d.ts
          rimraf-manual.d.ts.map
          ignore-enoent.d.ts
          default-tmp.js.map
          rimraf-windows.d.ts
          path-arg.d.ts
          rimraf-posix.js.map
          default-tmp.d.ts
          retry-busy.js
          use-native.d.ts
          index.js
          opt-arg.js
          opt-arg.js.map
          rimraf-move-remove.js
          index.d.ts.map
          path-arg.d.ts.map
          default-tmp.d.ts.map
          use-native.js.map
          platform.d.ts.map
          opt-arg.d.ts.map
          platform.js.map
          fs.js
        esm/
          package.json
          rimraf-manual.js
          fs.d.ts.map
          rimraf-native.d.ts
          readdir-or-error.js.map
          ignore-enoent.js
          rimraf-windows.js
          rimraf-posix.d.ts
          rimraf-native.d.ts.map
          rimraf-manual.js.map
          fix-eperm.js.map
          bin.d.mts
          ignore-enoent.js.map
          readdir-or-error.js
          rimraf-windows.d.ts.map
          bin.d.mts.map
          fix-eperm.d.ts.map
          fix-eperm.js
          bin.mjs
          rimraf-move-remove.d.ts.map
          rimraf-manual.d.ts
          retry-busy.d.ts.map
          retry-busy.js.map
          platform.d.ts
          use-native.d.ts.map
          rimraf-windows.js.map
          readdir-or-error.d.ts.map
          platform.js
          opt-arg.d.ts
          rimraf-move-remove.d.ts
          path-arg.js.map
          fix-eperm.d.ts
          rimraf-move-remove.js.map
          fs.d.ts
          fs.js.map
          rimraf-posix.js
          rimraf-native.js.map
          ignore-enoent.d.ts.map
          retry-busy.d.ts
          path-arg.js
          index.js.map
          rimraf-native.js
          rimraf-posix.d.ts.map
          use-native.js
          default-tmp.js
          index.d.ts
          readdir-or-error.d.ts
          rimraf-manual.d.ts.map
          ignore-enoent.d.ts
          default-tmp.js.map
          rimraf-windows.d.ts
          path-arg.d.ts
          rimraf-posix.js.map
          default-tmp.d.ts
          retry-busy.js
          use-native.d.ts
          index.js
          opt-arg.js
          opt-arg.js.map
          rimraf-move-remove.js
          index.d.ts.map
          path-arg.d.ts.map
          default-tmp.d.ts.map
          use-native.js.map
          platform.d.ts.map
          opt-arg.d.ts.map
          bin.mjs.map
          platform.js.map
          fs.js
    shebang-regex/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    into-stream/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    define-data-property/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    object-keys/
      CHANGELOG.md
      package.json
      LICENSE
      isArguments.js
      README.md
      .eslintrc
      implementation.js
      .editorconfig
      .travis.yml
      index.js
      test/
        index.js
    es-errors/
      range.js
      ref.js
      CHANGELOG.md
      package.json
      type.d.ts
      ref.d.ts
      type.js
      LICENSE
      tsconfig.json
      README.md
      .eslintrc
      syntax.d.ts
      eval.js
      syntax.js
      index.d.ts
      uri.d.ts
      uri.js
      index.js
      range.d.ts
      eval.d.ts
      test/
        index.js
      .github/
        FUNDING.yml
    ajv-formats/
      package.json
      LICENSE
      README.md
      dist/
        limit.d.ts
        formats.js.map
        limit.js.map
        index.js.map
        index.d.ts
        index.js
        formats.d.ts
        formats.js
        limit.js
      src/
        index.ts
        formats.ts
        limit.ts
    decompress-response/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    jsonwebtoken/
      package.json
      LICENSE
      verify.js
      decode.js
      README.md
      sign.js
      index.js
      lib/
        validateAsymmetricKey.js
        timespan.js
        asymmetricKeyDetailsSupported.js
        NotBeforeError.js
        psSupported.js
        rsaPssKeyDetailsSupported.js
        TokenExpiredError.js
        JsonWebTokenError.js
    undici-types/
      errors.d.ts
      package.json
      file.d.ts
      formdata.d.ts
      dispatcher.d.ts
      patch.d.ts
      handlers.d.ts
      connector.d.ts
      header.d.ts
      diagnostics-channel.d.ts
      cookies.d.ts
      mock-errors.d.ts
      websocket.d.ts
      global-dispatcher.d.ts
      mock-client.d.ts
      balanced-pool.d.ts
      README.md
      fetch.d.ts
      mock-pool.d.ts
      content-type.d.ts
      cache.d.ts
      pool-stats.d.ts
      webidl.d.ts
      pool.d.ts
      proxy-agent.d.ts
      readable.d.ts
      global-origin.d.ts
      api.d.ts
      index.d.ts
      mock-agent.d.ts
      interceptors.d.ts
      client.d.ts
      mock-interceptor.d.ts
      filereader.d.ts
      agent.d.ts
    string-template/
      package.json
      Readme.md
      .npmignore
      LICENCE
      .travis.yml
      index.js
      compile.js
      coverage/
        prettify.css
        coverage.json
        sort-arrow-sprite.png
        base.css
        prettify.js
        index.html
        sorter.js
        string-template/
          compile.js.html
          index.js.html
          index.html
    express-validator/
      package.json
      LICENSE
      README.md
      lib/
        field-selection.js
        utils.js
        context-builder.js
        validation-result.d.ts
        express-validator.js
        options.js
        context.d.ts
        options.d.ts
        field-selection.d.ts
        context-builder.d.ts
        validation-result.js
        base.js
        base.d.ts
        index.d.ts
        index.js
        utils.d.ts
        matched-data.js
        context.js
        express-validator.d.ts
        matched-data.d.ts
        context-items/
          custom-validation.d.ts
          bail.d.ts
          custom-condition.js
          custom-condition.d.ts
          context-item.d.ts
          sanitization.d.ts
          chain-condition.js
          custom-validation.js
          sanitization.js
          standard-validation.js
          index.d.ts
          chain-condition.d.ts
          index.js
          standard-validation.d.ts
          bail.js
          context-item.js
        middlewares/
          validation-chain-builders.d.ts
          exact.d.ts
          schema.js
          check.d.ts
          one-of.d.ts
          check.js
          one-of.js
          exact.js
          schema.d.ts
          validation-chain-builders.js
        chain/
          context-runner.d.ts
          validators-impl.js
          validators.js
          validation-chain.d.ts
          sanitizers.js
          context-runner-impl.d.ts
          context-handler.d.ts
          validators.d.ts
          context-runner.js
          validation-chain.js
          sanitizers-impl.js
          index.d.ts
          sanitizers-impl.d.ts
          context-runner-impl.js
          validators-impl.d.ts
          context-handler-impl.js
          index.js
          sanitizers.d.ts
          context-handler.js
          context-handler-impl.d.ts
    y18n/
      CHANGELOG.md
      package.json
      index.mjs
      LICENSE
      README.md
      build/
        index.cjs
        lib/
          cjs.js
          index.js
          platform-shims/
            node.js
    shebang-command/
      package.json
      license
      readme.md
      index.js
    mime-db/
      package.json
      db.json
      LICENSE
      README.md
      index.js
      HISTORY.md
    queue-microtask/
      package.json
      LICENSE
      README.md
      index.d.ts
      index.js
    tar-fs/
      package.json
      LICENSE
      README.md
      .travis.yml
      index.js
      test/
        index.js
        fixtures/
          invalid.tar
          b/
            a/
              test.txt
          a/
            hello.txt
          e/
            file
            directory/
              .ignore
          d/
            file1
            file2
            sub-dir/
              file5
            sub-files/
              file3
              file4
    @jridgewell/
      gen-mapping/
        package.json
        LICENSE
        README.md
        dist/
          gen-mapping.mjs.map
          gen-mapping.umd.js
          gen-mapping.mjs
          gen-mapping.umd.js.map
          types/
            sourcemap-segment.d.ts
            set-array.d.ts
            types.d.ts
            gen-mapping.d.ts
        src/
          set-array.ts
          types.ts
          gen-mapping.ts
          sourcemap-segment.ts
        types/
          sourcemap-segment.d.mts
          types.d.cts
          sourcemap-segment.d.mts.map
          types.d.mts
          sourcemap-segment.d.cts.map
          types.d.cts.map
          gen-mapping.d.cts.map
          set-array.d.mts.map
          gen-mapping.d.mts
          gen-mapping.d.cts
          gen-mapping.d.mts.map
          set-array.d.mts
          types.d.mts.map
          set-array.d.cts
          set-array.d.cts.map
          sourcemap-segment.d.cts
      resolve-uri/
        package.json
        LICENSE
        README.md
        dist/
          resolve-uri.mjs
          resolve-uri.umd.js.map
          resolve-uri.umd.js
          resolve-uri.mjs.map
          types/
            resolve-uri.d.ts
      sourcemap-codec/
        package.json
        LICENSE
        README.md
        dist/
          sourcemap-codec.mjs.map
          sourcemap-codec.mjs
          sourcemap-codec.umd.js
          sourcemap-codec.umd.js.map
        src/
          vlq.ts
          scopes.ts
          sourcemap-codec.ts
          strings.ts
        types/
          sourcemap-codec.d.cts.map
          scopes.d.mts
          strings.d.cts.map
          vlq.d.cts
          scopes.d.cts
          strings.d.cts
          strings.d.mts
          vlq.d.mts
          strings.d.mts.map
          vlq.d.mts.map
          sourcemap-codec.d.mts.map
          scopes.d.cts.map
          scopes.d.mts.map
          vlq.d.cts.map
          sourcemap-codec.d.mts
          sourcemap-codec.d.cts
      trace-mapping/
        package.json
        LICENSE
        README.md
        dist/
          trace-mapping.umd.js
          trace-mapping.mjs
          trace-mapping.mjs.map
          trace-mapping.umd.js.map
        src/
          binary-search.ts
          by-source.ts
          strip-filename.ts
          sort.ts
          resolve.ts
          types.ts
          sourcemap-segment.ts
          trace-mapping.ts
          flatten-map.ts
        types/
          by-source.d.mts
          strip-filename.d.mts
          sort.d.cts
          sourcemap-segment.d.mts
          by-source.d.cts.map
          types.d.cts
          resolve.d.cts
          sourcemap-segment.d.mts.map
          types.d.mts
          flatten-map.d.cts.map
          flatten-map.d.mts.map
          trace-mapping.d.mts.map
          sort.d.mts
          sourcemap-segment.d.cts.map
          resolve.d.cts.map
          resolve.d.mts.map
          types.d.cts.map
          trace-mapping.d.mts
          by-source.d.mts.map
          binary-search.d.cts.map
          flatten-map.d.mts
          strip-filename.d.mts.map
          by-source.d.cts
          resolve.d.mts
          strip-filename.d.cts.map
          binary-search.d.mts.map
          binary-search.d.cts
          sort.d.cts.map
          trace-mapping.d.cts
          flatten-map.d.cts
          binary-search.d.mts
          trace-mapping.d.cts.map
          types.d.mts.map
          sort.d.mts.map
          strip-filename.d.cts
          sourcemap-segment.d.cts
    core-js/
      package.json
      LICENSE
      postinstall.js
      README.md
      index.js
      configurator.js
      full/
        escape.js
        get-iterator.js
        global-this.js
        parse-int.js
        set-timeout.js
        unescape.js
        composite-symbol.js
        suppressed-error.js
        set-immediate.js
        aggregate-error.js
        is-iterable.js
        get-iterator-method.js
        README.md
        structured-clone.js
        atob.js
        set-interval.js
        clear-immediate.js
        parse-float.js
        queue-microtask.js
        composite-key.js
        index.js
        btoa.js
        self.js
        instance/
          concat.js
          to-well-formed.js
          reverse.js
          copy-within.js
          to-sorted.js
          group-by-to-map.js
          at.js
          code-points.js
          trim-start.js
          for-each.js
          trim.js
          sort.js
          bind.js
          find-last.js
          flat-map.js
          includes.js
          find-index.js
          demethodize.js
          some.js
          entries.js
          slice.js
          is-well-formed.js
          find.js
          unique-by.js
          reduce-right.js
          values.js
          trim-end.js
          ends-with.js
          keys.js
          un-this.js
          filter.js
          starts-with.js
          find-last-index.js
          trim-right.js
          group-by.js
          repeat.js
          flat.js
          replace-all.js
          unshift.js
          fill.js
          code-point-at.js
          splice.js
          trim-left.js
          clamp.js
          map.js
          match-all.js
          every.js
          group.js
          last-index-of.js
          to-reversed.js
          filter-reject.js
          pad-start.js
          reduce.js
          group-to-map.js
          with.js
          flags.js
          to-spliced.js
          push.js
          pad-end.js
          filter-out.js
          index-of.js
        observable/
          index.js
        data-view/
          set-float16.js
          get-float16.js
          set-uint8-clamped.js
          get-uint8-clamped.js
          index.js
        disposable-stack/
          constructor.js
          index.js
        string/
          iterator.js
          to-well-formed.js
          split.js
          strike.js
          fontsize.js
          dedent.js
          at.js
          code-points.js
          trim-start.js
          italics.js
          trim.js
          sub.js
          anchor.js
          includes.js
          blink.js
          is-well-formed.js
          trim-end.js
          ends-with.js
          search.js
          small.js
          starts-with.js
          match.js
          trim-right.js
          replace.js
          repeat.js
          link.js
          replace-all.js
          code-point-at.js
          from-code-point.js
          trim-left.js
          cooked.js
          match-all.js
          substr.js
          index.js
          sup.js
          pad-start.js
          raw.js
          big.js
          pad-end.js
          fixed.js
          fontcolor.js
          bold.js
          virtual/
            iterator.js
            to-well-formed.js
            strike.js
            fontsize.js
            at.js
            code-points.js
            trim-start.js
            italics.js
            trim.js
            sub.js
            anchor.js
            includes.js
            blink.js
            is-well-formed.js
            trim-end.js
            ends-with.js
            small.js
            starts-with.js
            trim-right.js
            repeat.js
            link.js
            replace-all.js
            code-point-at.js
            trim-left.js
            match-all.js
            substr.js
            index.js
            sup.js
            pad-start.js
            big.js
            pad-end.js
            fixed.js
            fontcolor.js
            bold.js
        array/
          iterator.js
          concat.js
          reverse.js
          copy-within.js
          to-sorted.js
          group-by-to-map.js
          at.js
          is-template-object.js
          for-each.js
          sort.js
          of.js
          find-last.js
          flat-map.js
          last-item.js
          is-array.js
          includes.js
          from.js
          find-index.js
          some.js
          entries.js
          slice.js
          find.js
          unique-by.js
          reduce-right.js
          values.js
          join.js
          keys.js
          filter.js
          find-last-index.js
          group-by.js
          flat.js
          unshift.js
          fill.js
          from-async.js
          splice.js
          map.js
          last-index.js
          every.js
          index.js
          group.js
          last-index-of.js
          to-reversed.js
          filter-reject.js
          reduce.js
          group-to-map.js
          with.js
          to-spliced.js
          push.js
          filter-out.js
          index-of.js
          virtual/
            iterator.js
            concat.js
            reverse.js
            copy-within.js
            to-sorted.js
            group-by-to-map.js
            at.js
            for-each.js
            sort.js
            find-last.js
            flat-map.js
            includes.js
            find-index.js
            some.js
            entries.js
            slice.js
            find.js
            unique-by.js
            reduce-right.js
            values.js
            join.js
            keys.js
            filter.js
            find-last-index.js
            group-by.js
            flat.js
            unshift.js
            fill.js
            splice.js
            map.js
            every.js
            index.js
            group.js
            last-index-of.js
            to-reversed.js
            filter-reject.js
            reduce.js
            group-to-map.js
            with.js
            to-spliced.js
            push.js
            filter-out.js
            index-of.js
        set/
          intersection.js
          difference.js
          of.js
          from.js
          some.js
          find.js
          join.js
          is-subset-of.js
          filter.js
          symmetric-difference.js
          delete-all.js
          is-disjoint-from.js
          map.js
          every.js
          index.js
          is-superset-of.js
          reduce.js
          add-all.js
          union.js
        weak-map/
          get-or-insert.js
          of.js
          from.js
          delete-all.js
          index.js
          get-or-insert-computed.js
          upsert.js
          emplace.js
        dom-exception/
          constructor.js
          index.js
          to-string-tag.js
        symbol/
          iterator.js
          split.js
          description.js
          has-instance.js
          species.js
          dispose.js
          is-concat-spreadable.js
          pattern-match.js
          is-well-known.js
          search.js
          is-registered-symbol.js
          match.js
          replace.js
          custom-matcher.js
          metadata-key.js
          replace-all.js
          metadata.js
          async-iterator.js
          key-for.js
          async-dispose.js
          unscopables.js
          match-all.js
          index.js
          is-well-known-symbol.js
          for.js
          to-primitive.js
          observable.js
          matcher.js
          to-string-tag.js
          is-registered.js
        number/
          range.js
          parse-int.js
          is-finite.js
          is-nan.js
          to-exponential.js
          is-integer.js
          parse-float.js
          constructor.js
          epsilon.js
          clamp.js
          is-safe-integer.js
          index.js
          to-fixed.js
          max-safe-integer.js
          to-precision.js
          min-safe-integer.js
          from-string.js
          virtual/
            to-exponential.js
            clamp.js
            index.js
            to-fixed.js
            to-precision.js
        async-disposable-stack/
          constructor.js
          index.js
        regexp/
          escape.js
          split.js
          to-string.js
          search.js
          dot-all.js
          match.js
          sticky.js
          replace.js
          test.js
          constructor.js
          index.js
          flags.js
        map/
          map-keys.js
          key-by.js
          get-or-insert.js
          key-of.js
          of.js
          includes.js
          from.js
          update.js
          some.js
          find.js
          filter.js
          group-by.js
          update-or-insert.js
          merge.js
          delete-all.js
          map-values.js
          every.js
          index.js
          reduce.js
          get-or-insert-computed.js
          find-key.js
          upsert.js
          emplace.js
        iterator/
          range.js
          concat.js
          as-indexed-pairs.js
          to-array.js
          indexed.js
          for-each.js
          take.js
          flat-map.js
          dispose.js
          from.js
          zip-keyed.js
          some.js
          find.js
          sliding.js
          filter.js
          chunks.js
          drop.js
          zip.js
          to-async.js
          map.js
          every.js
          index.js
          reduce.js
          windows.js
        weak-set/
          of.js
          from.js
          delete-all.js
          index.js
          add-all.js
        math/
          scale.js
          degrees.js
          log2.js
          deg-per-rad.js
          f16round.js
          acosh.js
          radians.js
          signbit.js
          imul.js
          cosh.js
          hypot.js
          sign.js
          fscale.js
          log10.js
          sinh.js
          fround.js
          tanh.js
          log1p.js
          umulh.js
          clz32.js
          expm1.js
          imulh.js
          clamp.js
          rad-per-deg.js
          atanh.js
          sum-precise.js
          index.js
          asinh.js
          trunc.js
          cbrt.js
          isubh.js
          iaddh.js
          seeded-prng.js
          to-string-tag.js
        async-iterator/
          as-indexed-pairs.js
          to-array.js
          indexed.js
          for-each.js
          take.js
          flat-map.js
          from.js
          some.js
          find.js
          filter.js
          drop.js
          async-dispose.js
          map.js
          every.js
          index.js
          reduce.js
        error/
          to-string.js
          is-error.js
          constructor.js
          index.js
        typed-array/
          iterator.js
          reverse.js
          uint16-array.js
          copy-within.js
          to-sorted.js
          int8-array.js
          uint32-array.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          int16-array.js
          float64-array.js
          includes.js
          float32-array.js
          to-base64.js
          from.js
          set.js
          find-index.js
          to-string.js
          some.js
          entries.js
          slice.js
          find.js
          unique-by.js
          reduce-right.js
          values.js
          join.js
          keys.js
          methods.js
          filter.js
          uint8-clamped-array.js
          find-last-index.js
          from-base64.js
          group-by.js
          fill.js
          from-async.js
          subarray.js
          set-from-hex.js
          map.js
          from-hex.js
          every.js
          index.js
          to-hex.js
          last-index-of.js
          to-reversed.js
          filter-reject.js
          uint8-array.js
          reduce.js
          to-locale-string.js
          with.js
          to-spliced.js
          set-from-base64.js
          int32-array.js
          filter-out.js
          index-of.js
        promise/
          finally.js
          try.js
          any.js
          index.js
          all-settled.js
          with-resolvers.js
        object/
          is-extensible.js
          is.js
          prevent-extensions.js
          iterate-entries.js
          define-properties.js
          get-own-property-symbols.js
          freeze.js
          set-prototype-of.js
          get-own-property-descriptors.js
          get-own-property-names.js
          to-string.js
          entries.js
          create.js
          values.js
          iterate-keys.js
          keys.js
          get-prototype-of.js
          from-entries.js
          lookup-getter.js
          group-by.js
          get-own-property-descriptor.js
          proto.js
          iterate-values.js
          lookup-setter.js
          is-sealed.js
          assign.js
          is-frozen.js
          define-getter.js
          index.js
          define-setter.js
          has-own.js
          define-property.js
          seal.js
        url/
          to-json.js
          can-parse.js
          index.js
          parse.js
        date/
          to-gmt-string.js
          to-string.js
          to-json.js
          to-iso-string.js
          now.js
          index.js
          get-year.js
          set-year.js
          to-primitive.js
        function/
          has-instance.js
          bind.js
          name.js
          demethodize.js
          un-this.js
          metadata.js
          is-constructor.js
          index.js
          is-callable.js
          virtual/
            bind.js
            demethodize.js
            un-this.js
            index.js
        url-search-params/
          index.js
        array-buffer/
          is-view.js
          slice.js
          detached.js
          transfer-to-fixed-length.js
          constructor.js
          index.js
          transfer.js
        json/
          stringify.js
          is-raw-json.js
          raw-json.js
          index.js
          to-string-tag.js
          parse.js
        bigint/
          range.js
          index.js
        reflect/
          own-keys.js
          is-extensible.js
          get.js
          prevent-extensions.js
          has-own-metadata.js
          apply.js
          construct.js
          set-prototype-of.js
          define-metadata.js
          set.js
          has-metadata.js
          get-prototype-of.js
          has.js
          get-metadata-keys.js
          get-own-property-descriptor.js
          get-metadata.js
          metadata.js
          get-own-metadata.js
          delete-metadata.js
          index.js
          get-own-metadata-keys.js
          delete-property.js
          to-string-tag.js
          define-property.js
        dom-collections/
          iterator.js
          for-each.js
          index.js
      es/
        escape.js
        get-iterator.js
        global-this.js
        parse-int.js
        unescape.js
        suppressed-error.js
        aggregate-error.js
        is-iterable.js
        get-iterator-method.js
        README.md
        parse-float.js
        index.js
        instance/
          concat.js
          to-well-formed.js
          reverse.js
          copy-within.js
          to-sorted.js
          at.js
          trim-start.js
          for-each.js
          trim.js
          sort.js
          bind.js
          find-last.js
          flat-map.js
          includes.js
          find-index.js
          some.js
          entries.js
          slice.js
          is-well-formed.js
          find.js
          reduce-right.js
          values.js
          trim-end.js
          ends-with.js
          keys.js
          filter.js
          starts-with.js
          find-last-index.js
          trim-right.js
          repeat.js
          flat.js
          replace-all.js
          unshift.js
          fill.js
          code-point-at.js
          splice.js
          trim-left.js
          map.js
          match-all.js
          every.js
          last-index-of.js
          to-reversed.js
          pad-start.js
          reduce.js
          with.js
          flags.js
          to-spliced.js
          push.js
          pad-end.js
          index-of.js
        data-view/
          set-float16.js
          get-float16.js
          index.js
        disposable-stack/
          constructor.js
          index.js
        string/
          iterator.js
          to-well-formed.js
          split.js
          strike.js
          fontsize.js
          at.js
          trim-start.js
          italics.js
          trim.js
          sub.js
          anchor.js
          includes.js
          blink.js
          is-well-formed.js
          trim-end.js
          ends-with.js
          search.js
          small.js
          starts-with.js
          match.js
          trim-right.js
          replace.js
          repeat.js
          link.js
          replace-all.js
          code-point-at.js
          from-code-point.js
          trim-left.js
          match-all.js
          substr.js
          index.js
          sup.js
          pad-start.js
          raw.js
          big.js
          pad-end.js
          fixed.js
          fontcolor.js
          bold.js
          virtual/
            iterator.js
            to-well-formed.js
            strike.js
            fontsize.js
            at.js
            trim-start.js
            italics.js
            trim.js
            sub.js
            anchor.js
            includes.js
            blink.js
            is-well-formed.js
            trim-end.js
            ends-with.js
            small.js
            starts-with.js
            trim-right.js
            repeat.js
            link.js
            replace-all.js
            code-point-at.js
            trim-left.js
            match-all.js
            substr.js
            index.js
            sup.js
            pad-start.js
            big.js
            pad-end.js
            fixed.js
            fontcolor.js
            bold.js
        array/
          iterator.js
          concat.js
          reverse.js
          copy-within.js
          to-sorted.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          flat-map.js
          is-array.js
          includes.js
          from.js
          find-index.js
          some.js
          entries.js
          slice.js
          find.js
          reduce-right.js
          values.js
          join.js
          keys.js
          filter.js
          find-last-index.js
          flat.js
          unshift.js
          fill.js
          from-async.js
          splice.js
          map.js
          every.js
          index.js
          last-index-of.js
          to-reversed.js
          reduce.js
          with.js
          to-spliced.js
          push.js
          index-of.js
          virtual/
            iterator.js
            concat.js
            reverse.js
            copy-within.js
            to-sorted.js
            at.js
            for-each.js
            sort.js
            find-last.js
            flat-map.js
            includes.js
            find-index.js
            some.js
            entries.js
            slice.js
            find.js
            reduce-right.js
            values.js
            join.js
            keys.js
            filter.js
            find-last-index.js
            flat.js
            unshift.js
            fill.js
            splice.js
            map.js
            every.js
            index.js
            last-index-of.js
            to-reversed.js
            reduce.js
            with.js
            to-spliced.js
            push.js
            index-of.js
        set/
          intersection.js
          difference.js
          is-subset-of.js
          symmetric-difference.js
          is-disjoint-from.js
          index.js
          is-superset-of.js
          union.js
        weak-map/
          index.js
        symbol/
          iterator.js
          split.js
          description.js
          has-instance.js
          species.js
          dispose.js
          is-concat-spreadable.js
          search.js
          match.js
          replace.js
          async-iterator.js
          key-for.js
          async-dispose.js
          unscopables.js
          match-all.js
          index.js
          for.js
          to-primitive.js
          to-string-tag.js
        number/
          parse-int.js
          is-finite.js
          is-nan.js
          to-exponential.js
          is-integer.js
          parse-float.js
          constructor.js
          epsilon.js
          is-safe-integer.js
          index.js
          to-fixed.js
          max-safe-integer.js
          to-precision.js
          min-safe-integer.js
          virtual/
            to-exponential.js
            index.js
            to-fixed.js
            to-precision.js
        async-disposable-stack/
          constructor.js
          index.js
        regexp/
          escape.js
          split.js
          to-string.js
          search.js
          dot-all.js
          match.js
          sticky.js
          replace.js
          test.js
          constructor.js
          index.js
          flags.js
        map/
          group-by.js
          index.js
        iterator/
          concat.js
          to-array.js
          for-each.js
          take.js
          flat-map.js
          dispose.js
          from.js
          some.js
          find.js
          filter.js
          drop.js
          map.js
          every.js
          index.js
          reduce.js
        weak-set/
          index.js
        math/
          log2.js
          f16round.js
          acosh.js
          imul.js
          cosh.js
          hypot.js
          sign.js
          log10.js
          sinh.js
          fround.js
          tanh.js
          log1p.js
          clz32.js
          expm1.js
          atanh.js
          sum-precise.js
          index.js
          asinh.js
          trunc.js
          cbrt.js
          to-string-tag.js
        async-iterator/
          async-dispose.js
          index.js
        error/
          to-string.js
          is-error.js
          constructor.js
          index.js
        typed-array/
          iterator.js
          reverse.js
          uint16-array.js
          copy-within.js
          to-sorted.js
          int8-array.js
          uint32-array.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          int16-array.js
          float64-array.js
          includes.js
          float32-array.js
          to-base64.js
          from.js
          set.js
          find-index.js
          to-string.js
          some.js
          entries.js
          slice.js
          find.js
          reduce-right.js
          values.js
          join.js
          keys.js
          methods.js
          filter.js
          uint8-clamped-array.js
          find-last-index.js
          from-base64.js
          fill.js
          subarray.js
          set-from-hex.js
          map.js
          from-hex.js
          every.js
          index.js
          to-hex.js
          last-index-of.js
          to-reversed.js
          uint8-array.js
          reduce.js
          to-locale-string.js
          with.js
          set-from-base64.js
          int32-array.js
          index-of.js
        promise/
          finally.js
          try.js
          any.js
          index.js
          all-settled.js
          with-resolvers.js
        object/
          is-extensible.js
          is.js
          prevent-extensions.js
          define-properties.js
          get-own-property-symbols.js
          freeze.js
          set-prototype-of.js
          get-own-property-descriptors.js
          get-own-property-names.js
          to-string.js
          entries.js
          create.js
          values.js
          keys.js
          get-prototype-of.js
          from-entries.js
          lookup-getter.js
          group-by.js
          get-own-property-descriptor.js
          proto.js
          lookup-setter.js
          is-sealed.js
          assign.js
          is-frozen.js
          define-getter.js
          index.js
          define-setter.js
          has-own.js
          define-property.js
          seal.js
        date/
          to-gmt-string.js
          to-string.js
          to-json.js
          to-iso-string.js
          now.js
          index.js
          get-year.js
          set-year.js
          to-primitive.js
        function/
          has-instance.js
          bind.js
          name.js
          index.js
          virtual/
            bind.js
            index.js
        array-buffer/
          is-view.js
          slice.js
          detached.js
          transfer-to-fixed-length.js
          constructor.js
          index.js
          transfer.js
        json/
          stringify.js
          is-raw-json.js
          raw-json.js
          index.js
          to-string-tag.js
          parse.js
        reflect/
          own-keys.js
          is-extensible.js
          get.js
          prevent-extensions.js
          apply.js
          construct.js
          set-prototype-of.js
          set.js
          get-prototype-of.js
          has.js
          get-own-property-descriptor.js
          index.js
          delete-property.js
          to-string-tag.js
          define-property.js
      stage/
        0.js
        README.md
        2.7.js
        1.js
        3.js
        index.js
        4.js
        pre.js
        2.js
      web/
        url-search-params.js
        immediate.js
        timers.js
        dom-collections.js
        README.md
        structured-clone.js
        dom-exception.js
        queue-microtask.js
        index.js
        url.js
      proposals/
        promise-any.js
        iterator-sequencing.js
        function-demethodize.js
        array-grouping-v2.js
        array-unique.js
        global-this.js
        string-at.js
        function-un-this.js
        string-left-right-trim.js
        promise-finally.js
        set-methods-v2.js
        promise-all-settled.js
        decorator-metadata-v2.js
        promise-try.js
        data-view-get-set-uint8-clamped.js
        promise-with-resolvers.js
        iterator-range.js
        array-filtering-stage-1.js
        iterator-helpers-stage-3.js
        object-getownpropertydescriptors.js
        well-formed-unicode-strings.js
        map-upsert.js
        string-code-points.js
        array-find-from-last.js
        math-extensions.js
        joint-iteration.js
        array-grouping-stage-3-2.js
        symbol-description.js
        keys-composition.js
        change-array-by-copy.js
        array-includes.js
        string-replace-all.js
        change-array-by-copy-stage-4.js
        symbol-predicates-v2.js
        array-is-template-object.js
        array-filtering.js
        symbol-predicates.js
        json-parse-with-source.js
        async-iterator-helpers.js
        string-replace-all-stage-4.js
        map-update-or-insert.js
        string-padding.js
        async-explicit-resource-management.js
        number-from-string.js
        iterator-chunking.js
        map-upsert-stage-2.js
        collection-methods.js
        array-grouping.js
        array-buffer-transfer.js
        regexp-escaping.js
        relative-indexing-method.js
        array-flat-map.js
        string-match-all.js
        math-sum.js
        regexp-named-groups.js
        is-error.js
        math-clamp.js
        accessible-object-hasownproperty.js
        array-grouping-stage-3.js
        number-range.js
        array-last.js
        decorator-metadata.js
        reflect-metadata.js
        async-iteration.js
        string-cooked.js
        well-formed-stringify.js
        pattern-matching-v2.js
        math-clamp-v2.js
        iterator-helpers.js
        collection-of-from.js
        array-from-async-stage-2.js
        array-buffer-base64.js
        index.js
        error-cause.js
        math-signbit.js
        iterator-helpers-stage-3-2.js
        object-from-entries.js
        using-statement.js
        float16.js
        seeded-random.js
        explicit-resource-management.js
        function-is-callable-is-constructor.js
        iterator-chunking-v2.js
        efficient-64-bit-arithmetic.js
        array-from-async.js
        observable.js
        object-iteration.js
        set-methods.js
        object-values-entries.js
        url.js
        extractors.js
        map-upsert-v4.js
        regexp-dotall-flag.js
        string-dedent.js
        pattern-matching.js
        decorators.js
      internals/
        function-call.js
        well-known-symbol.js
        microtask.js
        own-keys.js
        to-uint8-clamped.js
        array-species-constructor.js
        math-sign.js
        array-unique-by.js
        inherit-if-required.js
        weak-map-basic-detection.js
        wrap-error-constructor-with-cause.js
        iterator-define.js
        is-regexp.js
        symbol-constructor-detection.js
        array-buffer-basic-detection.js
        parse-json-string.js
        get-iterator.js
        function-demethodize.js
        symbol-is-well-known.js
        get-set-record.js
        weak-set-helpers.js
        number-parse-float.js
        string-trim.js
        a-possible-prototype.js
        global-this.js
        is-null-or-undefined.js
        normalize-string-argument.js
        structured-clone-proper-transfer.js
        to-object.js
        inspect-source.js
        add-to-unscopables.js
        array-buffer-byte-length.js
        environment-user-agent.js
        require-object-coercible.js
        set-helpers.js
        a-string.js
        string-trim-start.js
        a-weak-set.js
        object-get-prototype-of.js
        fix-regexp-well-known-symbol-logic.js
        get-built-in-node-module.js
        iterator-create-constructor.js
        new-promise-capability.js
        promise-resolve.js
        array-for-each.js
        object-create.js
        create-non-enumerable-property.js
        number-is-finite.js
        get-async-iterator.js
        date-to-primitive.js
        function-name.js
        this-number-value.js
        object-is-prototype-of.js
        iterator-close.js
        error-stack-installable.js
        array-buffer.js
        classof-raw.js
        regexp-exec.js
        set-difference.js
        create-iter-result-object.js
        a-number.js
        array-iteration-from-last.js
        host-report-errors.js
        math-log1p.js
        array-buffer-is-detached.js
        object-iterator.js
        set-is-subset-of.js
        regexp-exec-abstract.js
        iterator-helper-throws-on-invalid-iterator.js
        is-possible-prototype.js
        async-iterator-indexed.js
        a-data-view.js
        a-set.js
        iterator-helper-without-closing-on-early-error.js
        math-float-round.js
        well-known-symbol-define.js
        object-define-properties.js
        is-raw-json.js
        async-iterator-close.js
        iterators.js
        to-offset.js
        enum-bug-keys.js
        create-property-descriptor.js
        perform.js
        function-uncurry-this-accessor.js
        ieee754.js
        collection-weak.js
        define-built-in.js
        environment-is-ie-or-edge.js
        environment-is-ios.js
        advance-string-index.js
        function-uncurry-this-clause.js
        async-from-sync-iterator.js
        regexp-flags-detection.js
        object-keys.js
        is-array.js
        array-group-to-map.js
        math-fround.js
        shared.js
        caller.js
        array-to-reversed.js
        set-method-get-keys-before-cloning-detection.js
        number-parse-int.js
        get-built-in.js
        async-iterator-map.js
        error-stack-install.js
        document-create-element.js
        to-set-like.js
        an-object-or-undefined.js
        math-trunc.js
        error-to-string.js
        array-iteration.js
        v8-prototype-define-bug.js
        get-alphabet-option.js
        map-upsert.js
        whitespaces.js
        environment-v8-version.js
        check-correctness-of-iteration.js
        object-get-own-property-symbols.js
        is-data-descriptor.js
        array-from.js
        to-string.js
        hidden-keys.js
        set-clone.js
        typed-array-constructors-require-wrappers.js
        is-symbol.js
        path.js
        promise-constructor-detection.js
        string-punycode-to-ascii.js
        is-iterable.js
        get-mode-option.js
        a-constructor.js
        set-iterate.js
        use-symbol-as-uid.js
        html.js
        function-bind.js
        same-value-zero.js
        get-iterator-method.js
        async-iterator-wrap.js
        README.md
        not-a-nan.js
        collection-from.js
        make-built-in.js
        math-scale.js
        object-to-string.js
        string-multibyte.js
        iterate-simple.js
        object-define-property.js
        set-union.js
        uint8-from-hex.js
        promise-statics-incorrect-iteration.js
        get-async-iterator-flattenable.js
        iterator-close-all.js
        collection-strong.js
        array-slice.js
        date-to-iso-string.js
        is-forced.js
        array-includes.js
        string-html-forced.js
        iterator-indexed.js
        species-constructor.js
        set-species.js
        async-iterator-iteration.js
        an-instance.js
        typed-array-constructor.js
        get-built-in-prototype-method.js
        not-a-regexp.js
        has-own-property.js
        try-to-string.js
        internal-state.js
        environment.js
        to-indexed-object.js
        uint8-from-base64.js
        install-error-cause.js
        object-get-own-property-names.js
        object-property-is-enumerable.js
        collection-of.js
        classof.js
        weak-map-helpers.js
        object-get-own-property-descriptor.js
        dom-iterables.js
        math-log2.js
        array-species-create.js
        is-pure.js
        entry-unbind.js
        freezing.js
        environment-is-node.js
        symbol-define-to-primitive.js
        validate-arguments-length.js
        an-object.js
        symbol-is-registered.js
        url-constructor-detection.js
        collection.js
        regexp-sticky-helpers.js
        set-intersection.js
        delete-property-or-throw.js
        fails.js
        typed-array-from.js
        array-copy-within.js
        set-method-accept-set-like.js
        array-group.js
        array-buffer-non-extensible.js
        string-trim-forced.js
        regexp-flags.js
        to-big-int.js
        object-to-array.js
        symbol-registry-detection.js
        set-is-superset-of.js
        a-callable.js
        iterator-create-proxy.js
        string-trim-end.js
        object-set-prototype-of.js
        set-to-string-tag.js
        add-disposable-resource.js
        call-with-safe-iteration-closing.js
        async-iterator-prototype.js
        string-pad.js
        function-uncurry-this.js
        object-get-own-property-names-external.js
        iterator-zip.js
        well-known-symbol-wrapped.js
        dom-exception-constants.js
        to-absolute-index.js
        to-string-tag-support.js
        array-buffer-transfer.js
        to-length.js
        safe-get-built-in.js
        is-integral-number.js
        a-weak-key.js
        to-index.js
        ordinary-to-primitive.js
        internal-metadata.js
        string-repeat.js
        set-symmetric-difference.js
        math-clamp.js
        indexed-object.js
        a-weak-map.js
        math-expm1.js
        define-global-property.js
        is-array-iterator-method.js
        queue.js
        array-buffer-view-core.js
        iterator-window.js
        iterators-core.js
        reflect-metadata.js
        composite-key.js
        iterate.js
        is-big-int-array.js
        does-not-exceed-safe-integer.js
        string-cooked.js
        descriptors.js
        math-log10.js
        set-is-disjoint-from.js
        get-substitution.js
        get-iterator-flattenable.js
        task.js
        array-sort.js
        array-buffer-not-detached.js
        array-with.js
        shared-key.js
        same-value.js
        an-uint8-array.js
        array-from-constructor-and-list.js
        environment-ff-version.js
        ie8-dom-define.js
        object-is-extensible.js
        set-size.js
        function-bind-context.js
        is-constructor.js
        object-assign.js
        array-method-has-species-support.js
        correct-prototype-getter.js
        is-callable.js
        copy-constructor-properties.js
        flatten-into-array.js
        define-built-in-accessor.js
        array-reduce.js
        dom-token-list-prototype.js
        environment-webkit-version.js
        string-parse.js
        get-iterator-direct.js
        object-keys-internal.js
        proxy-accessor.js
        string-pad-webkit-bug.js
        to-property-key.js
        uid.js
        promise-native-constructor.js
        regexp-unsupported-ncg.js
        array-fill.js
        get-iterator-record.js
        to-primitive.js
        array-from-async.js
        base64-map.js
        create-html.js
        environment-is-webos-webkit.js
        typed-array-from-same-type-and-list.js
        native-raw-json.js
        environment-is-ios-pebble.js
        regexp-get-flags.js
        function-bind-native.js
        function-apply.js
        export.js
        to-integer-or-infinity.js
        length-of-array-like.js
        a-map.js
        entry-virtual.js
        math-round-ties-to-even.js
        to-positive-integer.js
        array-method-is-strict.js
        shared-store.js
        map-helpers.js
        is-object.js
        error-stack-clear.js
        map-iterate.js
        array-last-index-of.js
        detach-transferable.js
        numeric-range-iterator.js
        create-property.js
        define-built-ins.js
        get-method.js
        regexp-unsupported-dot-all.js
        object-prototype-accessors-forced.js
        array-set-length.js
        async-iterator-create-proxy.js
        correct-is-regexp-logic.js
        schedulers-fix.js
      modules/
        es.string.substr.js
        es.iterator.find.js
        web.timers.js
        web.set-timeout.js
        esnext.weak-set.delete-all.js
        web.dom-exception.to-string-tag.js
        es.array.flat-map.js
        esnext.set.difference.v2.js
        web.set-interval.js
        esnext.set.union.v2.js
        esnext.string.dedent.js
        esnext.reflect.has-metadata.js
        es.regexp.exec.js
        es.string.bold.js
        es.symbol.is-concat-spreadable.js
        es.array.join.js
        es.object.group-by.js
        esnext.array.group-to-map.js
        es.string.fixed.js
        es.object.prevent-extensions.js
        esnext.promise.any.js
        es.parse-int.js
        esnext.array.unique-by.js
        esnext.json.raw-json.js
        es.math.f16round.js
        esnext.typed-array.group-by.js
        es.typed-array.iterator.js
        es.array.find-index.js
        es.typed-array.uint32-array.js
        esnext.map.key-by.js
        es.function.bind.js
        es.string.trim-right.js
        web.url.can-parse.js
        esnext.array.is-template-object.js
        es.aggregate-error.constructor.js
        esnext.symbol.observable.js
        es.promise.any.js
        esnext.async-iterator.map.js
        esnext.data-view.get-uint8-clamped.js
        es.iterator.take.js
        esnext.async-iterator.to-array.js
        esnext.promise.with-resolvers.js
        es.weak-set.js
        esnext.error.is-error.js
        web.atob.js
        es.math.expm1.js
        esnext.promise.try.js
        es.global-this.js
        esnext.set.some.js
        es.symbol.search.js
        es.object.define-properties.js
        es.typed-array.int8-array.js
        es.string.to-well-formed.js
        web.url-search-params.size.js
        web.url-search-params.js
        esnext.async-iterator.find.js
        es.json.stringify.js
        es.promise.all.js
        es.array.map.js
        es.string.search.js
        es.typed-array.copy-within.js
        es.string.pad-end.js
        esnext.symbol.metadata.js
        esnext.observable.js
        es.string.blink.js
        es.number.parse-float.js
        esnext.iterator.from.js
        es.object.get-prototype-of.js
        es.symbol.has-instance.js
        esnext.map.upsert.js
        esnext.async-iterator.from.js
        es.object.is.js
        esnext.typed-array.find-last.js
        es.math.cbrt.js
        esnext.weak-set.of.js
        esnext.set.every.js
        es.string.italics.js
        es.object.define-property.js
        esnext.typed-array.to-spliced.js
        es.math.sign.js
        esnext.function.metadata.js
        es.typed-array.to-locale-string.js
        es.reflect.set.js
        esnext.iterator.to-array.js
        esnext.weak-set.add-all.js
        es.symbol.key-for.js
        es.typed-array.join.js
        es.set.union.v2.js
        es.reflect.is-extensible.js
        es.array.last-index-of.js
        web.dom-exception.constructor.js
        es.set.symmetric-difference.v2.js
        es.array.fill.js
        es.typed-array.find-index.js
        es.array.from-async.js
        es.array.find-last.js
        esnext.string.at.js
        esnext.weak-map.get-or-insert.js
        es.math.hypot.js
        es.iterator.reduce.js
        es.typed-array.reduce.js
        esnext.map.merge.js
        es.object.define-setter.js
        esnext.set.intersection.js
        es.typed-array.uint16-array.js
        esnext.set.is-superset-of.js
        es.math.clz32.js
        es.promise.constructor.js
        es.array.sort.js
        es.math.atanh.js
        es.typed-array.int16-array.js
        esnext.iterator.as-indexed-pairs.js
        esnext.async-iterator.indexed.js
        es.array.species.js
        esnext.string.is-well-formed.js
        es.error.is-error.js
        es.typed-array.at.js
        es.parse-float.js
        es.set.js
        es.array.some.js
        es.array.copy-within.js
        esnext.async-iterator.reduce.js
        es.data-view.js
        es.symbol.replace.js
        es.object.values.js
        es.promise.all-settled.js
        es.string.trim-start.js
        es.object.freeze.js
        esnext.array.from-async.js
        esnext.map.from.js
        esnext.set.difference.js
        es.date.set-year.js
        web.url.constructor.js
        es.array.to-sorted.js
        esnext.data-view.set-uint8-clamped.js
        es.string.match.js
        esnext.weak-map.upsert.js
        es.disposable-stack.constructor.js
        es.typed-array.filter.js
        es.reflect.construct.js
        esnext.async-iterator.some.js
        es.array.reduce.js
        esnext.array.filter-out.js
        es.typed-array.some.js
        es.typed-array.map.js
        esnext.async-iterator.drop.js
        esnext.symbol.pattern-match.js
        esnext.async-iterator.take.js
        es.symbol.async-dispose.js
        es.symbol.to-primitive.js
        es.typed-array.every.js
        es.string.iterator.js
        es.regexp.sticky.js
        esnext.async-iterator.every.js
        es.regexp.constructor.js
        esnext.object.iterate-entries.js
        esnext.symbol.replace-all.js
        esnext.map.every.js
        esnext.symbol.custom-matcher.js
        esnext.array.to-spliced.js
        es.array.at.js
        esnext.math.radians.js
        es.unescape.js
        es.iterator.map.js
        es.array.reverse.js
        esnext.map.find-key.js
        es.array.slice.js
        esnext.iterator.flat-map.js
        web.dom-collections.iterator.js
        esnext.set.symmetric-difference.js
        es.iterator.drop.js
        esnext.map.key-of.js
        es.string.big.js
        esnext.typed-array.unique-by.js
        es.string.raw.js
        web.url.js
        esnext.iterator.dispose.js
        es.symbol.species.js
        es.string.repeat.js
        esnext.set.union.js
        es.string.split.js
        es.string.replace.js
        es.typed-array.with.js
        es.object.has-own.js
        esnext.iterator.windows.js
        es.math.imul.js
        es.reflect.get-prototype-of.js
        web.queue-microtask.js
        esnext.observable.constructor.js
        esnext.suppressed-error.constructor.js
        esnext.set.is-subset-of.v2.js
        es.number.is-safe-integer.js
        esnext.string.at-alternative.js
        esnext.array.last-index.js
        es.suppressed-error.constructor.js
        esnext.symbol.async-dispose.js
        esnext.typed-array.filter-reject.js
        esnext.weak-map.delete-all.js
        es.string.sup.js
        esnext.data-view.set-float16.js
        es.object.is-sealed.js
        esnext.array.group.js
        esnext.map.get-or-insert-computed.js
        es.symbol.for.js
        es.object.entries.js
        es.symbol.async-iterator.js
        esnext.map.includes.js
        es.weak-map.constructor.js
        es.set.is-subset-of.v2.js
        esnext.reflect.delete-metadata.js
        esnext.array.last-item.js
        es.symbol.to-string-tag.js
        esnext.function.demethodize.js
        esnext.set.symmetric-difference.v2.js
        esnext.json.is-raw-json.js
        README.md
        es.symbol.description.js
        es.iterator.to-array.js
        esnext.function.un-this.js
        esnext.array.find-last.js
        web.self.js
        esnext.map.delete-all.js
        web.immediate.js
        esnext.data-view.get-float16.js
        es.array-buffer.transfer.js
        esnext.iterator.concat.js
        es.array.push.js
        es.iterator.flat-map.js
        es.typed-array.index-of.js
        es.weak-set.constructor.js
        es.symbol.iterator.js
        es.uint8-array.from-base64.js
        esnext.bigint.range.js
        esnext.symbol.is-well-known-symbol.js
        es.number.to-fixed.js
        esnext.math.deg-per-rad.js
        esnext.iterator.sliding.js
        es.string.ends-with.js
        es.set.is-disjoint-from.v2.js
        es.array.filter.js
        es.array.from.js
        esnext.set.is-disjoint-from.v2.js
        es.reflect.to-string-tag.js
        esnext.reflect.define-metadata.js
        es.string.trim.js
        esnext.array.to-reversed.js
        es.typed-array.uint8-array.js
        es.number.is-finite.js
        es.array.find.js
        es.date.to-gmt-string.js
        es.array.to-reversed.js
        es.iterator.constructor.js
        esnext.composite-symbol.js
        es.array.unscopables.flat-map.js
        es.array-buffer.slice.js
        es.object.from-entries.js
        web.btoa.js
        es.string.fontsize.js
        esnext.json.parse.js
        web.url-search-params.constructor.js
        esnext.array.group-by-to-map.js
        es.string.match-all.js
        es.math.acosh.js
        esnext.uint8-array.to-base64.js
        es.reflect.define-property.js
        esnext.object.group-by.js
        esnext.array.group-by.js
        esnext.map.filter.js
        es.function.has-instance.js
        esnext.weak-set.from.js
        esnext.number.clamp.js
        esnext.set.intersection.v2.js
        es.number.is-integer.js
        esnext.set.join.js
        es.promise.reject.js
        es.typed-array.float32-array.js
        esnext.map.get-or-insert.js
        esnext.set.delete-all.js
        es.symbol.match.js
        es.array.includes.js
        esnext.set.add-all.js
        esnext.typed-array.find-last-index.js
        esnext.uint8-array.set-from-hex.js
        es.math.to-string-tag.js
        esnext.reflect.metadata.js
        esnext.symbol.is-registered.js
        es.number.min-safe-integer.js
        es.typed-array.last-index-of.js
        esnext.observable.of.js
        es.typed-array.of.js
        esnext.math.clamp.js
        esnext.typed-array.to-reversed.js
        es.reflect.get-own-property-descriptor.js
        esnext.map.group-by.js
        es.number.max-safe-integer.js
        es.array.to-spliced.js
        es.typed-array.subarray.js
        es.string.code-point-at.js
        es.iterator.concat.js
        es.date.to-iso-string.js
        esnext.iterator.every.js
        es.number.epsilon.js
        esnext.async-iterator.constructor.js
        esnext.symbol.dispose.js
        es.typed-array.fill.js
        esnext.math.scale.js
        es.iterator.filter.js
        esnext.symbol.is-well-known.js
        es.symbol.js
        es.object.to-string.js
        es.string.includes.js
        es.regexp.escape.js
        es.uint8-array.set-from-base64.js
        esnext.iterator.filter.js
        es.uint8-array.set-from-hex.js
        es.regexp.to-string.js
        esnext.reflect.get-metadata.js
        es.typed-array.find-last-index.js
        es.set.is-superset-of.v2.js
        es.math.log10.js
        es.typed-array.for-each.js
        es.math.log1p.js
        esnext.number.range.js
        es.typed-array.slice.js
        esnext.math.signbit.js
        es.string.trim-left.js
        es.array-buffer.is-view.js
        es.typed-array.set.js
        web.clear-immediate.js
        es.object.lookup-getter.js
        esnext.uint8-array.from-hex.js
        esnext.array.with.js
        es.symbol.split.js
        es.array.of.js
        es.object.keys.js
        es.error.to-string.js
        es.array.every.js
        es.object.is-extensible.js
        es.regexp.dot-all.js
        esnext.iterator.some.js
        esnext.string.match-all.js
        es.reflect.has.js
        es.iterator.from.js
        esnext.iterator.range.js
        es.data-view.constructor.js
        es.set.constructor.js
        es.promise.finally.js
        esnext.math.isubh.js
        es.reflect.prevent-extensions.js
        es.uint8-array.to-base64.js
        es.iterator.dispose.js
        es.symbol.match-all.js
        es.array.index-of.js
        esnext.math.f16round.js
        esnext.weak-map.from.js
        es.typed-array.sort.js
        esnext.async-iterator.as-indexed-pairs.js
        es.string.at-alternative.js
        web.structured-clone.js
        es.date.now.js
        esnext.math.imulh.js
        es.number.parse-int.js
        esnext.object.has-own.js
        es.math.cosh.js
        esnext.typed-array.filter-out.js
        esnext.iterator.indexed.js
        esnext.math.seeded-prng.js
        es.number.to-exponential.js
        es.array.splice.js
        es.array.reduce-right.js
        esnext.iterator.to-async.js
        esnext.string.cooked.js
        esnext.uint8-array.to-hex.js
        es.math.sinh.js
        es.map.constructor.js
        esnext.weak-map.emplace.js
        esnext.iterator.reduce.js
        es.object.get-own-property-names.js
        es.symbol.constructor.js
        esnext.iterator.zip.js
        es.array-buffer.constructor.js
        es.array.iterator.js
        esnext.array.find-last-index.js
        es.object.get-own-property-descriptor.js
        es.object.is-frozen.js
        es.math.asinh.js
        esnext.weak-map.get-or-insert-computed.js
        es.object.define-getter.js
        es.string.link.js
        esnext.map.update-or-insert.js
        esnext.set.from.js
        es.math.tanh.js
        esnext.function.is-callable.js
        esnext.array.filter-reject.js
        web.dom-exception.stack.js
        esnext.set.find.js
        es.array.with.js
        web.url.to-json.js
        esnext.disposable-stack.constructor.js
        esnext.iterator.constructor.js
        esnext.async-iterator.for-each.js
        esnext.object.iterate-keys.js
        esnext.set.reduce.js
        esnext.number.from-string.js
        esnext.array.at.js
        es.array-buffer.detached.js
        esnext.async-iterator.filter.js
        esnext.symbol.metadata-key.js
        es.data-view.set-float16.js
        esnext.math.umulh.js
        es.date.get-year.js
        es.date.to-json.js
        esnext.typed-array.with.js
        es.typed-array.uint8-clamped-array.js
        es.json.to-string-tag.js
        es.array.flat.js
        es.promise.try.js
        esnext.async-iterator.flat-map.js
        es.uint8-array.from-hex.js
        esnext.typed-array.from-async.js
        es.number.to-precision.js
        es.error.cause.js
        esnext.map.some.js
        es.string.sub.js
        es.escape.js
        es.aggregate-error.cause.js
        esnext.composite-key.js
        es.date.to-string.js
        es.string.fontcolor.js
        esnext.typed-array.at.js
        es.object.proto.js
        es.date.to-primitive.js
        es.array.for-each.js
        es.typed-array.find-last.js
        esnext.weak-map.of.js
        es.object.set-prototype-of.js
        es.typed-array.to-sorted.js
        es.string.anchor.js
        es.math.fround.js
        esnext.uint8-array.set-from-base64.js
        es.typed-array.int32-array.js
        esnext.iterator.map.js
        es.typed-array.reduce-right.js
        esnext.reflect.get-own-metadata-keys.js
        es.number.constructor.js
        esnext.observable.from.js
        es.string.strike.js
        web.url-search-params.has.js
        es.symbol.unscopables.js
        web.url.parse.js
        es.math.trunc.js
        es.array.is-array.js
        esnext.async-iterator.async-dispose.js
        es.typed-array.find.js
        es.object.create.js
        es.reflect.apply.js
        esnext.map.find.js
        es.array.unscopables.flat.js
        esnext.math.sum-precise.js
        web.dom-collections.for-each.js
        es.async-iterator.async-dispose.js
        es.set.difference.v2.js
        esnext.math.iaddh.js
        es.symbol.dispose.js
        es.iterator.for-each.js
        es.string.starts-with.js
        es.reflect.set-prototype-of.js
        esnext.array.to-sorted.js
        es.number.is-nan.js
        esnext.map.of.js
        esnext.set.is-disjoint-from.js
        es.promise.race.js
        es.math.sum-precise.js
        esnext.string.replace-all.js
        esnext.object.iterate-values.js
        esnext.promise.all-settled.js
        es.object.get-own-property-symbols.js
        esnext.array-buffer.transfer-to-fixed-length.js
        es.async-disposable-stack.constructor.js
        esnext.iterator.zip-keyed.js
        es.object.lookup-setter.js
        es.string.from-code-point.js
        es.string.small.js
        esnext.math.rad-per-deg.js
        esnext.map.emplace.js
        esnext.uint8-array.from-base64.js
        es.typed-array.reverse.js
        es.string.trim-end.js
        es.string.replace-all.js
        esnext.iterator.chunks.js
        es.reflect.get.js
        esnext.string.to-well-formed.js
        esnext.math.degrees.js
        es.typed-array.to-string.js
        es.typed-array.includes.js
        esnext.string.code-points.js
        es.promise.with-resolvers.js
        esnext.global-this.js
        es.typed-array.to-reversed.js
        es.typed-array.float64-array.js
        es.object.get-own-property-descriptors.js
        es.function.name.js
        esnext.iterator.drop.js
        esnext.reflect.has-own-metadata.js
        es.iterator.some.js
        es.promise.resolve.js
        esnext.iterator.find.js
        es.weak-map.js
        esnext.iterator.take.js
        esnext.aggregate-error.js
        es.array.find-last-index.js
        esnext.set.of.js
        es.regexp.flags.js
        esnext.array-buffer.transfer.js
        esnext.function.is-constructor.js
        esnext.array-buffer.detached.js
        es.aggregate-error.js
        es.set.intersection.v2.js
        es.map.js
        esnext.typed-array.to-sorted.js
        web.url-search-params.delete.js
        es.typed-array.from.js
        esnext.reflect.get-own-metadata.js
        esnext.iterator.for-each.js
        es.reflect.own-keys.js
        esnext.set.is-superset-of.v2.js
        es.json.parse.js
        esnext.map.reduce.js
        esnext.map.map-keys.js
        esnext.symbol.matcher.js
        es.object.assign.js
        es.math.log2.js
        esnext.map.map-values.js
        es.reflect.delete-property.js
        esnext.math.fscale.js
        es.json.raw-json.js
        es.regexp.test.js
        es.object.seal.js
        es.string.is-well-formed.js
        es.map.group-by.js
        esnext.regexp.escape.js
        es.array-buffer.transfer-to-fixed-length.js
        esnext.async-disposable-stack.constructor.js
        es.data-view.get-float16.js
        esnext.set.is-subset-of.js
        esnext.set.filter.js
        esnext.map.update.js
        esnext.set.map.js
        es.promise.js
        esnext.symbol.is-registered-symbol.js
        es.array.unshift.js
        es.uint8-array.to-hex.js
        es.json.is-raw-json.js
        es.promise.catch.js
        esnext.reflect.get-metadata-keys.js
        es.iterator.every.js
        es.string.pad-start.js
        web.set-immediate.js
        es.array.concat.js
      stable/
        escape.js
        get-iterator.js
        global-this.js
        parse-int.js
        set-timeout.js
        unescape.js
        suppressed-error.js
        set-immediate.js
        aggregate-error.js
        is-iterable.js
        get-iterator-method.js
        README.md
        structured-clone.js
        atob.js
        set-interval.js
        clear-immediate.js
        parse-float.js
        queue-microtask.js
        index.js
        btoa.js
        self.js
        instance/
          concat.js
          to-well-formed.js
          reverse.js
          copy-within.js
          to-sorted.js
          at.js
          trim-start.js
          for-each.js
          trim.js
          sort.js
          bind.js
          find-last.js
          flat-map.js
          includes.js
          find-index.js
          some.js
          entries.js
          slice.js
          is-well-formed.js
          find.js
          reduce-right.js
          values.js
          trim-end.js
          ends-with.js
          keys.js
          filter.js
          starts-with.js
          find-last-index.js
          trim-right.js
          repeat.js
          flat.js
          replace-all.js
          unshift.js
          fill.js
          code-point-at.js
          splice.js
          trim-left.js
          map.js
          match-all.js
          every.js
          last-index-of.js
          to-reversed.js
          pad-start.js
          reduce.js
          with.js
          flags.js
          to-spliced.js
          push.js
          pad-end.js
          index-of.js
        data-view/
          set-float16.js
          get-float16.js
          index.js
        disposable-stack/
          constructor.js
          index.js
        string/
          iterator.js
          to-well-formed.js
          split.js
          strike.js
          fontsize.js
          at.js
          trim-start.js
          italics.js
          trim.js
          sub.js
          anchor.js
          includes.js
          blink.js
          is-well-formed.js
          trim-end.js
          ends-with.js
          search.js
          small.js
          starts-with.js
          match.js
          trim-right.js
          replace.js
          repeat.js
          link.js
          replace-all.js
          code-point-at.js
          from-code-point.js
          trim-left.js
          match-all.js
          substr.js
          index.js
          sup.js
          pad-start.js
          raw.js
          big.js
          pad-end.js
          fixed.js
          fontcolor.js
          bold.js
          virtual/
            iterator.js
            to-well-formed.js
            strike.js
            fontsize.js
            at.js
            trim-start.js
            italics.js
            trim.js
            sub.js
            anchor.js
            includes.js
            blink.js
            is-well-formed.js
            trim-end.js
            ends-with.js
            small.js
            starts-with.js
            trim-right.js
            repeat.js
            link.js
            replace-all.js
            code-point-at.js
            trim-left.js
            match-all.js
            substr.js
            index.js
            sup.js
            pad-start.js
            big.js
            pad-end.js
            fixed.js
            fontcolor.js
            bold.js
        array/
          iterator.js
          concat.js
          reverse.js
          copy-within.js
          to-sorted.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          flat-map.js
          is-array.js
          includes.js
          from.js
          find-index.js
          some.js
          entries.js
          slice.js
          find.js
          reduce-right.js
          values.js
          join.js
          keys.js
          filter.js
          find-last-index.js
          flat.js
          unshift.js
          fill.js
          from-async.js
          splice.js
          map.js
          every.js
          index.js
          last-index-of.js
          to-reversed.js
          reduce.js
          with.js
          to-spliced.js
          push.js
          index-of.js
          virtual/
            iterator.js
            concat.js
            reverse.js
            copy-within.js
            to-sorted.js
            at.js
            for-each.js
            sort.js
            find-last.js
            flat-map.js
            includes.js
            find-index.js
            some.js
            entries.js
            slice.js
            find.js
            reduce-right.js
            values.js
            join.js
            keys.js
            filter.js
            find-last-index.js
            flat.js
            unshift.js
            fill.js
            splice.js
            map.js
            every.js
            index.js
            last-index-of.js
            to-reversed.js
            reduce.js
            with.js
            to-spliced.js
            push.js
            index-of.js
        set/
          intersection.js
          difference.js
          is-subset-of.js
          symmetric-difference.js
          is-disjoint-from.js
          index.js
          is-superset-of.js
          union.js
        weak-map/
          index.js
        dom-exception/
          constructor.js
          index.js
          to-string-tag.js
        symbol/
          iterator.js
          split.js
          description.js
          has-instance.js
          species.js
          dispose.js
          is-concat-spreadable.js
          search.js
          match.js
          replace.js
          async-iterator.js
          key-for.js
          async-dispose.js
          unscopables.js
          match-all.js
          index.js
          for.js
          to-primitive.js
          to-string-tag.js
        number/
          parse-int.js
          is-finite.js
          is-nan.js
          to-exponential.js
          is-integer.js
          parse-float.js
          constructor.js
          epsilon.js
          is-safe-integer.js
          index.js
          to-fixed.js
          max-safe-integer.js
          to-precision.js
          min-safe-integer.js
          virtual/
            to-exponential.js
            index.js
            to-fixed.js
            to-precision.js
        async-disposable-stack/
          constructor.js
          index.js
        regexp/
          escape.js
          split.js
          to-string.js
          search.js
          dot-all.js
          match.js
          sticky.js
          replace.js
          test.js
          constructor.js
          index.js
          flags.js
        map/
          group-by.js
          index.js
        iterator/
          concat.js
          to-array.js
          for-each.js
          take.js
          flat-map.js
          dispose.js
          from.js
          some.js
          find.js
          filter.js
          drop.js
          map.js
          every.js
          index.js
          reduce.js
        weak-set/
          index.js
        math/
          log2.js
          f16round.js
          acosh.js
          imul.js
          cosh.js
          hypot.js
          sign.js
          log10.js
          sinh.js
          fround.js
          tanh.js
          log1p.js
          clz32.js
          expm1.js
          atanh.js
          sum-precise.js
          index.js
          asinh.js
          trunc.js
          cbrt.js
          to-string-tag.js
        async-iterator/
          async-dispose.js
          index.js
        error/
          to-string.js
          is-error.js
          constructor.js
          index.js
        typed-array/
          iterator.js
          reverse.js
          uint16-array.js
          copy-within.js
          to-sorted.js
          int8-array.js
          uint32-array.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          int16-array.js
          float64-array.js
          includes.js
          float32-array.js
          to-base64.js
          from.js
          set.js
          find-index.js
          to-string.js
          some.js
          entries.js
          slice.js
          find.js
          reduce-right.js
          values.js
          join.js
          keys.js
          methods.js
          filter.js
          uint8-clamped-array.js
          find-last-index.js
          from-base64.js
          fill.js
          subarray.js
          set-from-hex.js
          map.js
          from-hex.js
          every.js
          index.js
          to-hex.js
          last-index-of.js
          to-reversed.js
          uint8-array.js
          reduce.js
          to-locale-string.js
          with.js
          set-from-base64.js
          int32-array.js
          index-of.js
        promise/
          finally.js
          try.js
          any.js
          index.js
          all-settled.js
          with-resolvers.js
        object/
          is-extensible.js
          is.js
          prevent-extensions.js
          define-properties.js
          get-own-property-symbols.js
          freeze.js
          set-prototype-of.js
          get-own-property-descriptors.js
          get-own-property-names.js
          to-string.js
          entries.js
          create.js
          values.js
          keys.js
          get-prototype-of.js
          from-entries.js
          lookup-getter.js
          group-by.js
          get-own-property-descriptor.js
          proto.js
          lookup-setter.js
          is-sealed.js
          assign.js
          is-frozen.js
          define-getter.js
          index.js
          define-setter.js
          has-own.js
          define-property.js
          seal.js
        url/
          to-json.js
          can-parse.js
          index.js
          parse.js
        date/
          to-gmt-string.js
          to-string.js
          to-json.js
          to-iso-string.js
          now.js
          index.js
          get-year.js
          set-year.js
          to-primitive.js
        function/
          has-instance.js
          bind.js
          name.js
          index.js
          virtual/
            bind.js
            index.js
        url-search-params/
          index.js
        array-buffer/
          is-view.js
          slice.js
          detached.js
          transfer-to-fixed-length.js
          constructor.js
          index.js
          transfer.js
        json/
          stringify.js
          is-raw-json.js
          raw-json.js
          index.js
          to-string-tag.js
          parse.js
        reflect/
          own-keys.js
          is-extensible.js
          get.js
          prevent-extensions.js
          apply.js
          construct.js
          set-prototype-of.js
          set.js
          get-prototype-of.js
          has.js
          get-own-property-descriptor.js
          index.js
          delete-property.js
          to-string-tag.js
          define-property.js
        dom-collections/
          iterator.js
          for-each.js
          index.js
      features/
        escape.js
        get-iterator.js
        global-this.js
        parse-int.js
        set-timeout.js
        unescape.js
        composite-symbol.js
        suppressed-error.js
        set-immediate.js
        aggregate-error.js
        is-iterable.js
        get-iterator-method.js
        structured-clone.js
        atob.js
        set-interval.js
        clear-immediate.js
        parse-float.js
        queue-microtask.js
        composite-key.js
        index.js
        btoa.js
        self.js
        instance/
          concat.js
          to-well-formed.js
          reverse.js
          copy-within.js
          to-sorted.js
          group-by-to-map.js
          at.js
          code-points.js
          trim-start.js
          for-each.js
          trim.js
          sort.js
          bind.js
          find-last.js
          flat-map.js
          includes.js
          find-index.js
          demethodize.js
          some.js
          entries.js
          slice.js
          is-well-formed.js
          find.js
          unique-by.js
          reduce-right.js
          values.js
          trim-end.js
          ends-with.js
          keys.js
          un-this.js
          filter.js
          starts-with.js
          find-last-index.js
          trim-right.js
          group-by.js
          repeat.js
          flat.js
          replace-all.js
          unshift.js
          fill.js
          code-point-at.js
          splice.js
          trim-left.js
          clamp.js
          map.js
          match-all.js
          every.js
          group.js
          last-index-of.js
          to-reversed.js
          filter-reject.js
          pad-start.js
          reduce.js
          group-to-map.js
          with.js
          flags.js
          to-spliced.js
          push.js
          pad-end.js
          filter-out.js
          index-of.js
        observable/
          index.js
        data-view/
          set-float16.js
          get-float16.js
          set-uint8-clamped.js
          get-uint8-clamped.js
          index.js
        disposable-stack/
          constructor.js
          index.js
        string/
          iterator.js
          to-well-formed.js
          split.js
          strike.js
          fontsize.js
          dedent.js
          at.js
          code-points.js
          trim-start.js
          italics.js
          trim.js
          sub.js
          anchor.js
          includes.js
          blink.js
          is-well-formed.js
          trim-end.js
          ends-with.js
          search.js
          small.js
          starts-with.js
          match.js
          trim-right.js
          replace.js
          repeat.js
          link.js
          replace-all.js
          code-point-at.js
          from-code-point.js
          trim-left.js
          cooked.js
          match-all.js
          substr.js
          index.js
          sup.js
          pad-start.js
          raw.js
          big.js
          pad-end.js
          fixed.js
          fontcolor.js
          bold.js
          virtual/
            iterator.js
            to-well-formed.js
            strike.js
            fontsize.js
            at.js
            code-points.js
            trim-start.js
            italics.js
            trim.js
            sub.js
            anchor.js
            includes.js
            blink.js
            is-well-formed.js
            trim-end.js
            ends-with.js
            small.js
            starts-with.js
            trim-right.js
            repeat.js
            link.js
            replace-all.js
            code-point-at.js
            trim-left.js
            match-all.js
            substr.js
            index.js
            sup.js
            pad-start.js
            big.js
            pad-end.js
            fixed.js
            fontcolor.js
            bold.js
        array/
          iterator.js
          concat.js
          reverse.js
          copy-within.js
          to-sorted.js
          group-by-to-map.js
          at.js
          is-template-object.js
          for-each.js
          sort.js
          of.js
          find-last.js
          flat-map.js
          last-item.js
          is-array.js
          includes.js
          from.js
          find-index.js
          some.js
          entries.js
          slice.js
          find.js
          unique-by.js
          reduce-right.js
          values.js
          join.js
          keys.js
          filter.js
          find-last-index.js
          group-by.js
          flat.js
          unshift.js
          fill.js
          from-async.js
          splice.js
          map.js
          last-index.js
          every.js
          index.js
          group.js
          last-index-of.js
          to-reversed.js
          filter-reject.js
          reduce.js
          group-to-map.js
          with.js
          to-spliced.js
          push.js
          filter-out.js
          index-of.js
          virtual/
            iterator.js
            concat.js
            reverse.js
            copy-within.js
            to-sorted.js
            group-by-to-map.js
            at.js
            for-each.js
            sort.js
            find-last.js
            flat-map.js
            includes.js
            find-index.js
            some.js
            entries.js
            slice.js
            find.js
            unique-by.js
            reduce-right.js
            values.js
            join.js
            keys.js
            filter.js
            find-last-index.js
            group-by.js
            flat.js
            unshift.js
            fill.js
            splice.js
            map.js
            every.js
            index.js
            group.js
            last-index-of.js
            to-reversed.js
            filter-reject.js
            reduce.js
            group-to-map.js
            with.js
            to-spliced.js
            push.js
            filter-out.js
            index-of.js
        set/
          intersection.js
          difference.js
          of.js
          from.js
          some.js
          find.js
          join.js
          is-subset-of.js
          filter.js
          symmetric-difference.js
          delete-all.js
          is-disjoint-from.js
          map.js
          every.js
          index.js
          is-superset-of.js
          reduce.js
          add-all.js
          union.js
        weak-map/
          get-or-insert.js
          of.js
          from.js
          delete-all.js
          index.js
          get-or-insert-computed.js
          upsert.js
          emplace.js
        dom-exception/
          constructor.js
          index.js
          to-string-tag.js
        symbol/
          iterator.js
          split.js
          description.js
          has-instance.js
          species.js
          dispose.js
          is-concat-spreadable.js
          pattern-match.js
          is-well-known.js
          search.js
          is-registered-symbol.js
          match.js
          replace.js
          custom-matcher.js
          metadata-key.js
          replace-all.js
          metadata.js
          async-iterator.js
          key-for.js
          async-dispose.js
          unscopables.js
          match-all.js
          index.js
          is-well-known-symbol.js
          for.js
          to-primitive.js
          observable.js
          matcher.js
          to-string-tag.js
          is-registered.js
        number/
          range.js
          parse-int.js
          is-finite.js
          is-nan.js
          to-exponential.js
          is-integer.js
          parse-float.js
          constructor.js
          epsilon.js
          clamp.js
          is-safe-integer.js
          index.js
          to-fixed.js
          max-safe-integer.js
          to-precision.js
          min-safe-integer.js
          from-string.js
          virtual/
            to-exponential.js
            clamp.js
            index.js
            to-fixed.js
            to-precision.js
        async-disposable-stack/
          constructor.js
          index.js
        regexp/
          escape.js
          split.js
          to-string.js
          search.js
          dot-all.js
          match.js
          sticky.js
          replace.js
          test.js
          constructor.js
          index.js
          flags.js
        map/
          map-keys.js
          key-by.js
          get-or-insert.js
          key-of.js
          of.js
          includes.js
          from.js
          update.js
          some.js
          find.js
          filter.js
          group-by.js
          update-or-insert.js
          merge.js
          delete-all.js
          map-values.js
          every.js
          index.js
          reduce.js
          get-or-insert-computed.js
          find-key.js
          upsert.js
          emplace.js
        iterator/
          range.js
          concat.js
          as-indexed-pairs.js
          to-array.js
          indexed.js
          for-each.js
          take.js
          flat-map.js
          dispose.js
          from.js
          zip-keyed.js
          some.js
          find.js
          sliding.js
          filter.js
          chunks.js
          drop.js
          zip.js
          to-async.js
          map.js
          every.js
          index.js
          reduce.js
          windows.js
        weak-set/
          of.js
          from.js
          delete-all.js
          index.js
          add-all.js
        math/
          scale.js
          degrees.js
          log2.js
          deg-per-rad.js
          f16round.js
          acosh.js
          radians.js
          signbit.js
          imul.js
          cosh.js
          hypot.js
          sign.js
          fscale.js
          log10.js
          sinh.js
          fround.js
          tanh.js
          log1p.js
          umulh.js
          clz32.js
          expm1.js
          imulh.js
          clamp.js
          rad-per-deg.js
          atanh.js
          sum-precise.js
          index.js
          asinh.js
          trunc.js
          cbrt.js
          isubh.js
          iaddh.js
          seeded-prng.js
          to-string-tag.js
        async-iterator/
          as-indexed-pairs.js
          to-array.js
          indexed.js
          for-each.js
          take.js
          flat-map.js
          from.js
          some.js
          find.js
          filter.js
          drop.js
          async-dispose.js
          map.js
          every.js
          index.js
          reduce.js
        error/
          to-string.js
          is-error.js
          constructor.js
          index.js
        typed-array/
          iterator.js
          reverse.js
          uint16-array.js
          copy-within.js
          to-sorted.js
          int8-array.js
          uint32-array.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          int16-array.js
          float64-array.js
          includes.js
          float32-array.js
          to-base64.js
          from.js
          set.js
          find-index.js
          to-string.js
          some.js
          entries.js
          slice.js
          find.js
          unique-by.js
          reduce-right.js
          values.js
          join.js
          keys.js
          methods.js
          filter.js
          uint8-clamped-array.js
          find-last-index.js
          from-base64.js
          group-by.js
          fill.js
          from-async.js
          subarray.js
          set-from-hex.js
          map.js
          from-hex.js
          every.js
          index.js
          to-hex.js
          last-index-of.js
          to-reversed.js
          filter-reject.js
          uint8-array.js
          reduce.js
          to-locale-string.js
          with.js
          to-spliced.js
          set-from-base64.js
          int32-array.js
          filter-out.js
          index-of.js
        promise/
          finally.js
          try.js
          any.js
          index.js
          all-settled.js
          with-resolvers.js
        object/
          is-extensible.js
          is.js
          prevent-extensions.js
          iterate-entries.js
          define-properties.js
          get-own-property-symbols.js
          freeze.js
          set-prototype-of.js
          get-own-property-descriptors.js
          get-own-property-names.js
          to-string.js
          entries.js
          create.js
          values.js
          iterate-keys.js
          keys.js
          get-prototype-of.js
          from-entries.js
          lookup-getter.js
          group-by.js
          get-own-property-descriptor.js
          proto.js
          iterate-values.js
          lookup-setter.js
          is-sealed.js
          assign.js
          is-frozen.js
          define-getter.js
          index.js
          define-setter.js
          has-own.js
          define-property.js
          seal.js
        url/
          to-json.js
          can-parse.js
          index.js
          parse.js
        date/
          to-gmt-string.js
          to-string.js
          to-json.js
          to-iso-string.js
          now.js
          index.js
          get-year.js
          set-year.js
          to-primitive.js
        function/
          has-instance.js
          bind.js
          name.js
          demethodize.js
          un-this.js
          metadata.js
          is-constructor.js
          index.js
          is-callable.js
          virtual/
            bind.js
            demethodize.js
            un-this.js
            index.js
        url-search-params/
          index.js
        array-buffer/
          is-view.js
          slice.js
          detached.js
          transfer-to-fixed-length.js
          constructor.js
          index.js
          transfer.js
        json/
          stringify.js
          is-raw-json.js
          raw-json.js
          index.js
          to-string-tag.js
          parse.js
        bigint/
          range.js
          index.js
        reflect/
          own-keys.js
          is-extensible.js
          get.js
          prevent-extensions.js
          has-own-metadata.js
          apply.js
          construct.js
          set-prototype-of.js
          define-metadata.js
          set.js
          has-metadata.js
          get-prototype-of.js
          has.js
          get-metadata-keys.js
          get-own-property-descriptor.js
          get-metadata.js
          metadata.js
          get-own-metadata.js
          delete-metadata.js
          index.js
          get-own-metadata-keys.js
          delete-property.js
          to-string-tag.js
          define-property.js
        dom-collections/
          iterator.js
          for-each.js
          index.js
      actual/
        escape.js
        get-iterator.js
        global-this.js
        parse-int.js
        set-timeout.js
        unescape.js
        suppressed-error.js
        set-immediate.js
        aggregate-error.js
        is-iterable.js
        get-iterator-method.js
        README.md
        structured-clone.js
        atob.js
        set-interval.js
        clear-immediate.js
        parse-float.js
        queue-microtask.js
        index.js
        btoa.js
        self.js
        instance/
          concat.js
          to-well-formed.js
          reverse.js
          copy-within.js
          to-sorted.js
          group-by-to-map.js
          at.js
          trim-start.js
          for-each.js
          trim.js
          sort.js
          bind.js
          find-last.js
          flat-map.js
          includes.js
          find-index.js
          some.js
          entries.js
          slice.js
          is-well-formed.js
          find.js
          reduce-right.js
          values.js
          trim-end.js
          ends-with.js
          keys.js
          filter.js
          starts-with.js
          find-last-index.js
          trim-right.js
          group-by.js
          repeat.js
          flat.js
          replace-all.js
          unshift.js
          fill.js
          code-point-at.js
          splice.js
          trim-left.js
          map.js
          match-all.js
          every.js
          group.js
          last-index-of.js
          to-reversed.js
          pad-start.js
          reduce.js
          group-to-map.js
          with.js
          flags.js
          to-spliced.js
          push.js
          pad-end.js
          index-of.js
        data-view/
          set-float16.js
          get-float16.js
          index.js
        disposable-stack/
          constructor.js
          index.js
        string/
          iterator.js
          to-well-formed.js
          split.js
          strike.js
          fontsize.js
          at.js
          trim-start.js
          italics.js
          trim.js
          sub.js
          anchor.js
          includes.js
          blink.js
          is-well-formed.js
          trim-end.js
          ends-with.js
          search.js
          small.js
          starts-with.js
          match.js
          trim-right.js
          replace.js
          repeat.js
          link.js
          replace-all.js
          code-point-at.js
          from-code-point.js
          trim-left.js
          match-all.js
          substr.js
          index.js
          sup.js
          pad-start.js
          raw.js
          big.js
          pad-end.js
          fixed.js
          fontcolor.js
          bold.js
          virtual/
            iterator.js
            to-well-formed.js
            strike.js
            fontsize.js
            at.js
            trim-start.js
            italics.js
            trim.js
            sub.js
            anchor.js
            includes.js
            blink.js
            is-well-formed.js
            trim-end.js
            ends-with.js
            small.js
            starts-with.js
            trim-right.js
            repeat.js
            link.js
            replace-all.js
            code-point-at.js
            trim-left.js
            match-all.js
            substr.js
            index.js
            sup.js
            pad-start.js
            big.js
            pad-end.js
            fixed.js
            fontcolor.js
            bold.js
        array/
          iterator.js
          concat.js
          reverse.js
          copy-within.js
          to-sorted.js
          group-by-to-map.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          flat-map.js
          is-array.js
          includes.js
          from.js
          find-index.js
          some.js
          entries.js
          slice.js
          find.js
          reduce-right.js
          values.js
          join.js
          keys.js
          filter.js
          find-last-index.js
          group-by.js
          flat.js
          unshift.js
          fill.js
          from-async.js
          splice.js
          map.js
          every.js
          index.js
          group.js
          last-index-of.js
          to-reversed.js
          reduce.js
          group-to-map.js
          with.js
          to-spliced.js
          push.js
          index-of.js
          virtual/
            iterator.js
            concat.js
            reverse.js
            copy-within.js
            to-sorted.js
            group-by-to-map.js
            at.js
            for-each.js
            sort.js
            find-last.js
            flat-map.js
            includes.js
            find-index.js
            some.js
            entries.js
            slice.js
            find.js
            reduce-right.js
            values.js
            join.js
            keys.js
            filter.js
            find-last-index.js
            group-by.js
            flat.js
            unshift.js
            fill.js
            splice.js
            map.js
            every.js
            index.js
            group.js
            last-index-of.js
            to-reversed.js
            reduce.js
            group-to-map.js
            with.js
            to-spliced.js
            push.js
            index-of.js
        set/
          intersection.js
          difference.js
          is-subset-of.js
          symmetric-difference.js
          is-disjoint-from.js
          index.js
          is-superset-of.js
          union.js
        weak-map/
          get-or-insert.js
          index.js
          get-or-insert-computed.js
        dom-exception/
          constructor.js
          index.js
          to-string-tag.js
        symbol/
          iterator.js
          split.js
          description.js
          has-instance.js
          species.js
          dispose.js
          is-concat-spreadable.js
          search.js
          match.js
          replace.js
          metadata.js
          async-iterator.js
          key-for.js
          async-dispose.js
          unscopables.js
          match-all.js
          index.js
          for.js
          to-primitive.js
          to-string-tag.js
        number/
          parse-int.js
          is-finite.js
          is-nan.js
          to-exponential.js
          is-integer.js
          parse-float.js
          constructor.js
          epsilon.js
          is-safe-integer.js
          index.js
          to-fixed.js
          max-safe-integer.js
          to-precision.js
          min-safe-integer.js
          virtual/
            to-exponential.js
            index.js
            to-fixed.js
            to-precision.js
        async-disposable-stack/
          constructor.js
          index.js
        regexp/
          escape.js
          split.js
          to-string.js
          search.js
          dot-all.js
          match.js
          sticky.js
          replace.js
          test.js
          constructor.js
          index.js
          flags.js
        map/
          get-or-insert.js
          group-by.js
          index.js
          get-or-insert-computed.js
        iterator/
          concat.js
          to-array.js
          for-each.js
          take.js
          flat-map.js
          dispose.js
          from.js
          zip-keyed.js
          some.js
          find.js
          filter.js
          drop.js
          zip.js
          to-async.js
          map.js
          every.js
          index.js
          reduce.js
        weak-set/
          index.js
        math/
          log2.js
          f16round.js
          acosh.js
          imul.js
          cosh.js
          hypot.js
          sign.js
          log10.js
          sinh.js
          fround.js
          tanh.js
          log1p.js
          clz32.js
          expm1.js
          atanh.js
          sum-precise.js
          index.js
          asinh.js
          trunc.js
          cbrt.js
          to-string-tag.js
        async-iterator/
          to-array.js
          for-each.js
          take.js
          flat-map.js
          from.js
          some.js
          find.js
          filter.js
          drop.js
          async-dispose.js
          map.js
          every.js
          index.js
          reduce.js
        error/
          to-string.js
          is-error.js
          constructor.js
          index.js
        typed-array/
          iterator.js
          reverse.js
          uint16-array.js
          copy-within.js
          to-sorted.js
          int8-array.js
          uint32-array.js
          at.js
          for-each.js
          sort.js
          of.js
          find-last.js
          int16-array.js
          float64-array.js
          includes.js
          float32-array.js
          to-base64.js
          from.js
          set.js
          find-index.js
          to-string.js
          some.js
          entries.js
          slice.js
          find.js
          reduce-right.js
          values.js
          join.js
          keys.js
          methods.js
          filter.js
          uint8-clamped-array.js
          find-last-index.js
          from-base64.js
          fill.js
          subarray.js
          set-from-hex.js
          map.js
          from-hex.js
          every.js
          index.js
          to-hex.js
          last-index-of.js
          to-reversed.js
          uint8-array.js
          reduce.js
          to-locale-string.js
          with.js
          to-spliced.js
          set-from-base64.js
          int32-array.js
          index-of.js
        promise/
          finally.js
          try.js
          any.js
          index.js
          all-settled.js
          with-resolvers.js
        object/
          is-extensible.js
          is.js
          prevent-extensions.js
          define-properties.js
          get-own-property-symbols.js
          freeze.js
          set-prototype-of.js
          get-own-property-descriptors.js
          get-own-property-names.js
          to-string.js
          entries.js
          create.js
          values.js
          keys.js
          get-prototype-of.js
          from-entries.js
          lookup-getter.js
          group-by.js
          get-own-property-descriptor.js
          proto.js
          lookup-setter.js
          is-sealed.js
          assign.js
          is-frozen.js
          define-getter.js
          index.js
          define-setter.js
          has-own.js
          define-property.js
          seal.js
        url/
          to-json.js
          can-parse.js
          index.js
          parse.js
        date/
          to-gmt-string.js
          to-string.js
          to-json.js
          to-iso-string.js
          now.js
          index.js
          get-year.js
          set-year.js
          to-primitive.js
        function/
          has-instance.js
          bind.js
          name.js
          metadata.js
          index.js
          virtual/
            bind.js
            index.js
        url-search-params/
          index.js
        array-buffer/
          is-view.js
          slice.js
          detached.js
          transfer-to-fixed-length.js
          constructor.js
          index.js
          transfer.js
        json/
          stringify.js
          is-raw-json.js
          raw-json.js
          index.js
          to-string-tag.js
          parse.js
        reflect/
          own-keys.js
          is-extensible.js
          get.js
          prevent-extensions.js
          apply.js
          construct.js
          set-prototype-of.js
          set.js
          get-prototype-of.js
          has.js
          get-own-property-descriptor.js
          index.js
          delete-property.js
          to-string-tag.js
          define-property.js
        dom-collections/
          iterator.js
          for-each.js
          index.js
    debug/
      CHANGELOG.md
      package.json
      LICENSE
      node.js
      README.md
      src/
        browser.js
        node.js
        common.js
        index.js
    i/
      package.json
      LICENSE
      README.md
      lib/
        native.js
        methods.js
        util.js
        inflections.js
        defaults.js
        inflect.js
      test/
        utils/
          array-test.js
          string-test.js
        inflector/
          methods-test.js
          inflections-test.js
          cases.js
      .github/
        dependabot.yml
        workflows/
          ci.yml
    lru-cache/
      package.json
      LICENSE
      README.md
      dist/
        commonjs/
          package.json
          index.min.js.map
          index.min.js
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
        esm/
          package.json
          index.min.js.map
          index.min.js
          index.js.map
          index.d.ts
          index.js
          index.d.ts.map
    bl/
      package.json
      bl.js
      README.md
      .travis.yml
      BufferList.js
      LICENSE.md
      test/
        convert.js
        test.js
        indexOf.js
        isBufferList.js
      node_modules/
        readable-stream/
          experimentalWarning.js
          package.json
          errors.js
          readable-browser.js
          LICENSE
          errors-browser.js
          README.md
          readable.js
          CONTRIBUTING.md
          GOVERNANCE.md
          lib/
            _stream_readable.js
            _stream_passthrough.js
            _stream_transform.js
            _stream_duplex.js
            _stream_writable.js
            internal/
    qs/
      CHANGELOG.md
      package.json
      .nycrc
      README.md
      .eslintrc
      .editorconfig
      LICENSE.md
      dist/
        qs.js
      lib/
        utils.js
        stringify.js
        index.js
        formats.js
        parse.js
      test/
        utils.js
        empty-keys-cases.js
        stringify.js
        parse.js
      .github/
        FUNDING.yml
    assert-plus/
      package.json
      README.md
      assert.js
    safe-regex-test/
      CHANGELOG.md
      package.json
      LICENSE
      tsconfig.json
      .nycrc
      README.md
      .eslintrc
      index.d.ts
      index.js
      test/
        index.js
      .github/
        FUNDING.yml
    boom/
      package.json
      Makefile
      LICENSE
      README.md
      .npmignore
      .travis.yml
      index.js
      lib/
        index.js
      images/
        boom.png
      test/
        index.js
      node_modules/
        hoek/
          package.json
          Makefile
          LICENSE
          README.md
          .npmignore
          .travis.yml
          index.js
          lib/
            escape.js
            index.js
          images/
            hoek.png
          test/
            index.js
            escaper.js
            modules/
              test2.js
              test1.js
              test3.js
    node-fetch/
      browser.js
      package.json
      README.md
      LICENSE.md
      lib/
        index.mjs
        index.es.js
        index.js
      node_modules/
        whatwg-url/
          package.json
          README.md
          LICENSE.txt
          lib/
            utils.js
            URL-impl.js
            public-api.js
            URL.js
            url-state-machine.js
        webidl-conversions/
          package.json
          README.md
          LICENSE.md
          lib/
            index.js
        tr46/
          package.json
          .npmignore
          index.js
          lib/
            mappingTable.json
            .gitkeep
    wsl-utils/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    oauth-sign/
      package.json
      LICENSE
      README.md
      test.js
      index.js
    @javascript-obfuscator/
      estraverse/
        package.json
        gulpfile.js
        LICENSE.BSD
        .jshintrc
        README.md
        estraverse.js
      escodegen/
        CHANGELOG.md
        package.json
        LICENSE.BSD
        README.md
        escodegen.js
    node-domexception/
      package.json
      LICENSE
      README.md
      index.js
      .history/
        index_20210527204418.js
        index_20210527212722.js
        README_20210527213345.md
        README_20210527214323.md
        package_20210527205145.json
        index_20210527204756.js
        package_20210527204913.json
        index_20210527214700.js
        index_20210527213843.js
        README_20210527214408.md
        test_20210527205603.js
        README_20210527203617.md
        README_20210527212714.md
        index_20210527203842.js
        test_20210527205957.js
        index_20210527204833.js
        test_20210527210021.js
        package_20210527204621.json
        index_20210527214654.js
        index_20210527213022.js
        index_20210527213822.js
        package_20210527204925.json
        index_20210527211248.js
        index_20210527211208.js
        index_20210527212731.js
        index_20210527213852.js
        index_20210527212746.js
        index_20210527204259.js
        README_20210527213803.md
        index_20210527214643.js
        package_20210527203733.json
        package_20210527203825.json
        index_20210527203947.js
        package_20210527205156.json
        index_20210527214034.js
        README_20210527213411.md
        index_20210527213910.js
        index_20210527212900.js
    is-docker/
      package.json
      license
      cli.js
      readme.md
      index.d.ts
      index.js
    dot-prop/
      package.json
      license
      readme.md
      index.d.ts
      index.js
    call-bind-apply-helpers/
      applyBind.d.ts
      CHANGELOG.md
      package.json
      applyBind.js
      LICENSE
      tsconfig.json
      .nycrc
      reflectApply.js
      README.md
      .eslintrc
      functionCall.js
      index.d.ts
      functionCall.d.ts
      functionApply.js
      actualApply.d.ts
      index.js
      actualApply.js
      functionApply.d.ts
      reflectApply.d.ts
      test/
        index.js
      .github/
        FUNDING.yml
    lodash.once/
      package.json
      LICENSE
      README.md
      index.js
    source-map-support/
      package.json
      register.js
      README.md
      browser-source-map-support.js
      source-map-support.js
      register-hook-require.js
      LICENSE.md
    cookie/
      package.json
      SECURITY.md
      LICENSE
      README.md
      index.js
  middleware/
    ccgNormalize.js
  .git/
    HEAD
    ORIG_HEAD
    packed-refs
    description
    COMMIT_EDITMSG
    index
    config
    filter-repo/
      ref-map
      already_ran
      suboptimal-issues
      commit-map
    info/
      exclude
      refs
    refs/
      remotes/
        origin/
          main
      replace/
      tags/
      heads/
        main
    hooks/
      fsmonitor-watchman.sample
      sendemail-validate.sample
      applypatch-msg.sample
      pre-merge-commit.sample
      pre-rebase.sample
      update.sample
      prepare-commit-msg.sample
      pre-push.sample
      push-to-checkout.sample
      pre-receive.sample
      pre-applypatch.sample
      post-update.sample
      commit-msg.sample
      pre-commit.sample
    logs/
      HEAD
      refs/
        remotes/
          origin/
            main
        heads/
          main
    objects/
      6f/
        2c6d1b6ba9f9978570348f117452eb981e173d
      e2/
        ddb8b6353c01d9877363e1a2e4ed02caf353cf
        9b9cb369ceb71b37f6f3f3ca02af65bb03c315
      c8/
        da7829c9ef5111fcb4e864a02fd4db32c90b1e
        cb60abe04d2a26c4796f9f0c97d709b244612c
      59/
        f3184b252b7a9b5b8799e4ccbace1374504280
        921ce2ef83253e3c35fd6c49d62e3663d9e586
      70/
        94f25203442eb950c3c49019c4bb3e8dbc3909
      34/
        551cc5efacff6354c1f5ff8a5c9a2a9b722992
      d6/
        6e616f946da3655e7b58da307f1c4bfc32337a
        41117d37f173638dfae591d040abd8911fcae4
      1e/
        07f4d837643beeacd1b7ae591f00f7f129332c
      c6/
        e7edb21cb23969b387e2aa10f9d19e08a71015
      cb/
        c10de36f04c714d9b6468e4cb4aaba9588b0f7
        4333fff087e60fd358a6c27e6a012243a825a7
      b5/
        5afa18fb6f7c8b55a510ee96b86274e43086dc
        a9287b998ebb84c07b316e692584887ef41dc9
      44/
        4a4e81a9e3dec419590f9c5c5335d2aa8a3f94
      2f/
        656a1043ef9ec293aa526e02f7c4fe04601f5f
      91/
        cd2a7e3ba18d8da529d9a365db6a299459c1c1
      60/
        df4a6b9d5dd7a506fe5ab95e7aaa00f2a0a3d3
      69/
        541a69520b98d681c5ef4f515ddefe25a56c21
      75/
        287ed67f8d11510ba7ba4502daa7769c6e2755
      32/
        592b715b270bd71b1d27a1ff780ab3ae9fa8a6
      ea/
        214d9f83d3939cc1ac530aafb95cbd30ed8305
      c5/
        647a4b128b4aed606c848e2a97741a80042d9a
      96/
        b5fe92242cc1ddf6be921b36f15c85fb080ef2
        6c53820a04f10db9bb155a36d6a7fee7c701c9
      e7/
        e1cbbafcc0755d7b615fe9fb44d9cada0ea96a
      3b/
        19d407ca1c062696e0f024aa929f72e9ea8175
      6c/
        75d8756004fce6df8b5eccc1b2f2e78adc277b
      3d/
        c04addd8b6cefa1f87ebb1481454c446208c63
      82/
        1bded081fc999815d3cf9fcd5dd980c98b6a85
      8b/
        e3daea3f33c533c2d9a801841ae0c473cbdcf1
      0c/
        28dbbcb462ab16cb50ddc6b2a12e0f433738d0
      98/
        813bd9fdb281b9b9dc4046dabf3f2a045c0720
      2a/
        fff30815e04da7a1014bf98f81d037299aeb86
      3f/
        708f788763cf990419d24fb5643e06fc50f0d6
      0e/
        7a1592736c0bd17f2605b850b9b98da422b4e8
      77/
        e0b337995bbfc6c37c675e23e41e6c908a7669
        545e9a0b0039212821176ce2f28ecfb6e1e488
      63/
        3cf58c3ffdd031bfad1bd16825faccd76abf3e
      84/
        d3072d0d0f259f8a451ff952cdc835ff67d12c
      e1/
        58eb93761199b8e8b0e56afb679db69844ee01
      df/
        3e729dab3e065447775ae5955ef2f2f89067ce
      info/
        packs
      08/
        cab4a94d3f501508ff77218843eb36ebe8c8f0
      4e/
        03c59a04553a29b432e11f710512a1f9415e93
      5f/
        c0ba1d06df08ec5873d70dec451d38fe5f35a4
      f8/
        61fbb24fe0685d5aa45b9f01da4147e00279ac
      f5/
        161fcd805556f9f63f911037de7e8d224f396f
      16/
        80cd23a7e5b1579e78e7663c004ed5bc201f05
      ed/
        a82f85f513df134f2df9c4873fcec6835b7526
      5c/
        a696645bfb6701be8ab5c3e6de0fdef2bcb17a
      de/
        b44af26db8ae29719b66a0c8fcd20240e55310
        cf3589d4a383b1a34f0d8a538a07ffb60ac486
      48/
        9d5500c0344eb05aa9919015cc9ed36bfbeee0
        ddc3db55fe28d4999dfbbfc9a9ad26ab719217
      ad/
        a721a1074cf288646c386a215aec62c087cd64
      b2/
        543e32f233d1ceda95e3d259e98f43b5672c5b
      80/
        2660cc2937e690fb514334ae058d0baf99b3d1
      pack/
        pack-541df1637f25ca62f238613ba509cb195d521b09.idx
        pack-541df1637f25ca62f238613ba509cb195d521b09.pack
        pack-541df1637f25ca62f238613ba509cb195d521b09.rev
      3a/
        40f768fa8b8de7a97d8662306f5b08a442e06a
      19/
        f5ce7c5fcec9d8db78b8061450c5421d4af33a
      07/
        5f70573b7ac9f2b98c113ff659b4082e4f92c5
      a6/
        a8e4267f33b94948d708d88bdc4502624e50b8
      20/
        5b8588253a11ca9df03cabfad25aacfea59f1d
      d2/
        4daa42c032f755c31b838c430edaf5d391a899
      d0/
        032bede6b27ec853229bf1fc7881485114325f
      fd/
        61a83b172037ad0b32c3ec1274547238d7f29f
      bf/
        2e5349d920d8f71ca720864cf156fb3a2cb4f1
      2e/
        9fa8a806ae1b4169298638d301ed10e2679843
      ae/
        e1c8d81a406a63f6930d59542a5257e9e3fea9
      90/
        e867efe73558af3b0fa1b89fb274d1e50488de
      d7/
        8093416f8169f1e163ad1bb42cad0bbcae2449
      f2/
        b1ab14fa65411cc9fb6436f46a3d9d0a3907fa
      41/
        030f2886a05a13e5ec9e14c94711183ac7a84a
      79/
        65cb8343a2ad10f28bb2e24d6bc90a1f50c677
      c9/
        95c589c4303d073cbb2d64edd09208e849d3ca
        a61ce61e130b32c075a5ccc4edcb7f7229f737
      54/
        e5aaf90961c47aac99392985a37b963759ce53
      78/
        40707a7234c60f7225db66423b24589e08e6da
      92/
        b7f83d84fb4b250148a6bd20ea0a93cfe4a639
      39/
        d9c75fc659bebfc7b1dbea265fc05128072352
      56/
        855048f95aa0f8c26c8b9fc2e422e3dd953ce6
        2a7b611d37e30a07b51f4f64c3ede241c5979f
      f4/
        9ad5df7d9f372c31622de5c92eed528ce065f7
      1d/
        7a6fd27fd14d371df87b83814ad964b273f0d6
      35/
        79ec7ddbbfa8e1b9cfca1c23b6dabe45fc9c1f
      1c/
        fb8d476b9525da4aac12e7d14ec2668d21ad72
      31/
        989676f93a3788ed776cc5b118ff25c010cfba
        062ab2d65efd801fa582450caad06546e8d54e
      02/
        d9307d4c13a7c174baffa99e109544cfd4b690
      a9/
        a479c2f9a5968de62d09d12d871e8fa6b2d7f6
      ce/
        66fba4fe878b1ee95a56e7cd3d631e2f8c8586
      38/
        391ef3ba3944da6ad93a1435b3913dbd9785d8
      2c/
        311e509d81803f2d32fd676bbe9c10044e976f
      e6/
        d9069ee6446c70143c500f3a5725627a32c30f
      49/
        de8bc896f75e82a117b40bc2438d6acda58651
      65/
        14a72afee5ee6371216128c0b8e48ddeb97122
      cf/
        2ae99bceb84c8f0d2203a9045b2f88157b3a64
      a8/
        adedf5ffbb4f9da610cd34c9d9b673c4a37216
      b6/
        1385ba574ba3952a5928ddb777004097b22bf7
        c3be1c9a8ca26b6fb1ce926d62f61f8d79a744
        00453715a30f946cffdfdc3420a1b4e96bf5a1
      1a/
        560e90201ad640750bf32a8f17156867db20e9
      0b/
        59aee87784962efa6eaf4a06d1bab88b6924c4
      14/
        6327f77a936bf363a88bde783c23463ce7db10
        0ab9646dfb9d2f11c6b524f0ed07934e3616ba
        2b6bd18c6a4bbdc93fb51312f7c0eb86c63e9a
      4c/
        5e47104abf3d31d78b929da7da9db249a74e75
      d3/
        55a4abf746b2b06eab85cae6dc3b926a336010
      05/
        6148ac01f8b80fcb4d541a3ab7f2231ed89c6e
      fe/
        ba71226b71acfbebf6c45aae1f661fe51d369c
      15/
        27811eff832a2c259ea4436d803fb39729a800
      db/
        c0102382f26320a3a8bdad5139dc410a44a4b2
      a2/
        d688203fb8751cd3b809eb2283ffd291a2539d
      4a/
        9e89ed787d4d30508292b9e562c682f9428171
    branches/
  cli/
    package.json
    history-enhanced.js
    apiService-cli.js
    responseParser-cli.js
    cmdgen-cli.js
    modules/
      codeCompare.js
  .nofiles/
    dump_backend_ccg.sh
    nano
    files
    view_backend_usage_files.sh
    DONE
    ccg_debug_20251226_085349.txt
    fix_day2_generator_hardening.sh


===== SELECTED FILE CONTENTS =====

================================================================================
FILE: .ccg_backups/tool_output_final/20260103_045619/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-style post-processor for Generator.
// Goals:
// - FIRST thing: exactly ONE fenced code block for command/script.
// - The fence must contain ONLY commands (no prose inside).
// - For markdown outputType: ensure sections (ØªÙˆØ¶ÛŒØ­/Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§/Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§). If missing => fill.
// - Add safe defaults for sensitive ops (reboot/shutdown/ufw/rm -rf).
// Backward compatible exports: formatOutput + formatToolResponse

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function hasFaChars(s) {
  return /[\u0600-\u06FF]/.test(String(s || ""));
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .replace(/\r/g, "")
    .split("\n")
    .map((x) => x.trim());

  const out = [];
  for (let i = 0; i < lines.length; i++) {
    const line = (lines[i] || "").trim();
    if (!line) continue;

    // stop if prose slips in
    if (hasFaChars(line)) break;
    if (/[.ØŒØ›!?]$/.test(line)) break;
    if (/^(Ø¨Ø±Ø§ÛŒ|ØªÙˆØ¶ÛŒØ­|Ù‡Ø´Ø¯Ø§Ø±|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†)/.test(line)) break;

    out.push(line);

    // keep tight; allow continuation for multiline commands
    const cont = /\\\s*$/.test(line) || /\&\&\s*$/.test(line) || /\|\s*$/.test(line);
    if (!cont && out.length >= 1) break;
    if (out.length >= 6) break;
  }

  return out.join("\n").trim();
}

function guessCommandFromText(text) {
  const lines = String(text ?? "")
    .replace(/\r/g, "")
    .split("\n")
    .map((x) => x.trim())
    .filter(Boolean);

  for (const line of lines) {
    if (line.length > 160) continue;
    if (hasFaChars(line)) continue;
    if (/[.ØŒØ›!?]$/.test(line)) continue;
    if (/^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(line)) return line;
  }
  return "";
}

function escapeRegExp(s) {
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function ensureSection(md, titleFa) {
  const re = new RegExp(`(^|\\n)\\s*##\\s*${escapeRegExp(titleFa)}\\s*(\\n|$)`, "i");
  if (re.test(md)) return md;
  return (md ? md + "\n\n" : "") + `## ${titleFa}\n- Ù†Ø¯Ø§Ø±Ø¯`;
}

function upsertBullets(md, titleFa, bullets) {
  const re = new RegExp(`(^|\\n)(\\s*##\\s*${escapeRegExp(titleFa)}\\s*\\n)([\\s\\S]*?)(?=\\n\\s*##\\s*|\\s*$)`, "i");
  const m = md.match(re);
  if (!m) return md;

  const head = m[2];
  let body = (m[3] || "").trim();

  if (!body || body === "- Ù†Ø¯Ø§Ø±Ø¯") {
    body = bullets.join("\n");
  } else {
    // append only if not already present (simple contains check)
    for (const b of bullets) {
      const key = b.replace(/[`]/g, "");
      if (!body.includes(key)) body += "\n" + b;
    }
  }

  return md.replace(re, (all, p1) => `${p1}${head}${body}\n`);
}

function enrichSensitive({ cmd, md }) {
  const c = String(cmd || "").toLowerCase();

  if (/\b(reboot|shutdown)\b/.test(c) || /\bsystemctl\s+reboot\b/.test(c)) {
    md = ensureSection(md, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§");
    md = ensureSection(md, "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§");

    md = upsertBullets(md, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", [
      "- Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±ØªØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†.",
      "- Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH/Ø±ÛŒÙ…ÙˆØª Ù‡Ø³ØªÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ø±ØªØ¨Ø§Ø· Ù‚Ø·Ø¹ Ø´ÙˆØ¯Ø› Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø±ÛŒ.",
      "- Ø±ÙˆÛŒ Production Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· (Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§/Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù‚Ø·Ø¹ Ø´ÙˆÙ†Ø¯).",
    ]);

    md = upsertBullets(md, "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", [
      "- `sudo shutdown -r now`",
      "- `sudo systemctl reboot`",
      "- `sudo reboot`",
    ]);
  }

  if (/\bufw\s+(enable|disable)\b/.test(c)) {
    md = ensureSection(md, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§");
    md = upsertBullets(md, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", [
      "- Ø§Ú¯Ø± SSH Ø¯Ø§Ø±ÛŒØŒ Ù‚Ø¨Ù„ Ø§Ø² ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ UFW Ù¾ÙˆØ±Øª SSH Ø±Ø§ allow Ú©Ù† ØªØ§ Ù‚ÙÙ„ Ù†Ø´ÛŒ (Ù…Ø«Ù„Ø§Ù‹ 22).",
    ]);
  }

  if (/\brm\s+-rf\b/.test(c)) {
    md = ensureSection(md, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§");
    md = upsertBullets(md, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", [
      "- `rm -rf` ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³ØªØ› Ù…Ø³ÛŒØ± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø± Ú†Ú© Ú©Ù†.",
    ]);
  }

  return md.trim();
}

export function formatOutput({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase().trim();
  const raw = String(text ?? "").trim();
  if (!raw) return raw;

  const wantOnly = (ot === "command" || ot === "script");

  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  let cmd = codeRaw ? normalizeCodeToCommands(codeRaw) : "";
  if (!cmd) cmd = guessCommandFromText(raw);

  const fenceLang = fenceLangFromCli(cli, ot);
  const fence = cmd ? `\`\`\`${fenceLang}\n${cmd}\n\`\`\`` : "";

  if (wantOnly) return fence || raw;

  let body = String(rest || "").trim();

  body = ensureSection(body, "ØªÙˆØ¶ÛŒØ­");
  body = ensureSection(body, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§");
  body = ensureSection(body, "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§");

  body = enrichSensitive({ cmd, md: body });

  if (!fence) return body || raw;
  return `${fence}\n\n${body}`.trim();
}

export function formatToolResponse(args) {
  return formatOutput(args);
}

================================================================================
FILE: .ccg_backups/tool_output_final/20260103_050838/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// CCG Tool-Style Post-Processor (Generator)
// Guarantees (for outputType: "markdown" or "tool"):
// 1) FIRST thing is exactly ONE fenced code block.
// 2) Code fence contains ONLY command-like lines (no prose).
// 3) Always has sections: ØªÙˆØ¶ÛŒØ­ / Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (filled if missing).
// Backward-compatible exports:
// - formatOutput
// - formatToolResponse (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function hasFaChars(s) {
  return /[\u0600-\u06FF]/.test(String(s || ""));
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;

  // very long lines are often prose
  if (s.length > 220) return false;

  // reject common prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;

  // reject lines that contain Persian prose (usually explanation), but allow paths with fa rarely
  if (hasFaChars(s) && !/[\/._-]/.test(s)) return false;

  // allow comments
  if (s.startsWith("#") || s.startsWith("::")) return true;

  // starts with sudo or common tools/commands
  if (/^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s)) return true;

  return false;
}

// keep only command-like lines from code block
function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map((l) => l.replace(/\r/g, "").trim())
    .filter(Boolean);

  const kept = [];
  for (const l of lines) {
    if (looksLikeCommand(l)) kept.push(l);
  }
  return kept.join("\n").trim();
}

// if there is no code block, try to pick first command-ish lines from full text
function guessCommandsFromText(fullText) {
  const lines = String(fullText || "")
    .split("\n")
    .map((l) => l.replace(/\r/g, "").trim())
    .filter(Boolean);

  const kept = [];
  for (const l of lines) {
    // stop early if we already found a command and then prose begins
    if (kept.length && (!looksLikeCommand(l) || hasFaChars(l))) break;
    if (looksLikeCommand(l)) kept.push(l);
    if (kept.length >= 4) break;
  }
  return kept.join("\n").trim();
}

function parseSections(rest) {
  // supports both fa + en headings
  const t = String(rest || "").trim();
  if (!t) return { exp: "", warn: "", alt: "" };

  const lines = t.split("\n");
  const out = { exp: "", warn: "", alt: "", other: "" };
  let cur = "other";

  function keyOfHeading(h) {
    const hh = h.trim().toLowerCase();
    if (/^#+\s*(ØªÙˆØ¶ÛŒØ­|Ø´Ø±Ø­|explanation)\s*$/.test(hh)) return "exp";
    if (/^#+\s*(Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§|Ù‡Ø´Ø¯Ø§Ø±|warnings?)\s*$/.test(hh)) return "warn";
    if (/^#+\s*(Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù‡Ø§|alternatives?)\s*$/.test(hh)) return "alt";
    return "";
  }

  for (const line of lines) {
    const k = keyOfHeading(line);
    if (k) {
      cur = k;
      continue;
    }
    out[cur] += (out[cur] ? "\n" : "") + line;
  }

  return {
    exp: out.exp.trim() || out.other.trim(), // if explanation missing, use other as exp
    warn: out.warn.trim(),
    alt: out.alt.trim(),
  };
}

function ensureBullets(text, lang = "fa") {
  const t = String(text || "").trim();
  if (!t) return "";
  // if already has bullets/numbering, keep
  if (/^\s*([-*]|\d+\.)\s+/m.test(t)) return t;
  // otherwise make single bullet list line-by-line
  const lines = t.split("\n").map((l) => l.trim()).filter(Boolean);
  if (!lines.length) return "";
  return lines.map((l) => `- ${l}`).join("\n");
}

function autoHintsFromCommand(cmd, lang = "fa") {
  const c = String(cmd || "").toLowerCase();
  const fa = String(lang || "fa").toLowerCase().startsWith("fa");

  const hints = { warn: [], alt: [] };

  // reboot/shutdown
  if (/\b(reboot|shutdown)\b/.test(c) || /\bsystemctl\s+reboot\b/.test(c)) {
    if (fa) {
      hints.warn.push("Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±ØªØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.");
      hints.warn.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ø±ÛŒÙ…ÙˆØª Ù‡Ø³ØªÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ SSH Ù‚Ø·Ø¹ Ø´ÙˆØ¯.");
      hints.alt.push("shutdown -r now");
      hints.alt.push("systemctl reboot");
    } else {
      hints.warn.push("Save any unsaved work before rebooting.");
      hints.warn.push("On remote servers, your SSH session will disconnect.");
      hints.alt.push("shutdown -r now");
      hints.alt.push("systemctl reboot");
    }
  }

  // rm -rf
  if (/\brm\s+-rf\b/.test(c) || /\brm\s+-r(f)?\b/.test(c)) {
    if (fa) {
      hints.warn.push("rm -rf Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÛŒØ± Ø§Ø³ØªØ› Ù‚Ø¨Ù„Ø´ Ù…Ø³ÛŒØ± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø± Ú†Ú© Ú©Ù†ÛŒØ¯.");
      hints.alt.push("Ø§ÙˆÙ„ Ø¨Ø§ ls / echo Ù…Ø³ÛŒØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ rm Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
    } else {
      hints.warn.push("rm -rf is destructive; double-check the path first.");
      hints.alt.push("Inspect with ls/echo first, then run rm.");
    }
  }

  // ufw
  if (/\bufw\b/.test(c)) {
    if (fa) {
      hints.warn.push("ØªØºÛŒÛŒØ±Ø§Øª ÙØ§ÛŒØ±ÙˆØ§Ù„ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ SSH Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†Ø¯Ø› rule Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ SSH Ø±Ø§ Ù‚Ø¨Ù„Ø´ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯.");
      hints.alt.push("ufw status verbose");
    } else {
      hints.warn.push("Firewall changes may cut off SSH; ensure SSH rules first.");
      hints.alt.push("ufw status verbose");
    }
  }

  return hints;
}

export function formatOutput({ outputType = "markdown", text = "", cli = "bash", lang = "fa" } = {}) {
  const ot = String(outputType || "markdown").toLowerCase();

  // "tool" acts like markdown but enforced structure
  const isTool = ot === "tool" || ot === "markdown";
  const fenceLang = fenceLangFromCli(cli, ot);

  const { codeRaw, rest } = splitFirstCodeBlock(text);
  let code = normalizeCodeToCommands(codeRaw);
  if (!code) code = guessCommandsFromText(text);

  const fenced = `\`\`\`${fenceLang}\n${code || ""}\n\`\`\``.trim();

  // command/script/python => return only code fence (CLI-friendly)
  if (!isTool) return fenced;

  const sections = parseSections(rest);
  const cmdForHints = code.split("\n").find(Boolean) || "";
  const hints = autoHintsFromCommand(cmdForHints, lang);

  const fa = String(lang || "fa").toLowerCase().startsWith("fa");
  const H_EXP = fa ? "## ØªÙˆØ¶ÛŒØ­" : "## Explanation";
  const H_WARN = fa ? "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "## Warnings";
  const H_ALT = fa ? "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" : "## Alternatives";

  const exp = sections.exp || (fa ? "â€”" : "â€”");
  const warn = ensureBullets(sections.warn || hints.warn.join("\n"), lang) || (fa ? "- Ù†Ø¯Ø§Ø±Ø¯" : "- none");
  const alt = ensureBullets(sections.alt || hints.alt.join("\n"), lang) || (fa ? "- Ù†Ø¯Ø§Ø±Ø¯" : "- none");

  const body =
`${H_EXP}
${exp}

${H_WARN}
${warn}

${H_ALT}
${alt}`.trim();

  return `${fenced}\n\n${body}`.trim();
}

// backward compat
export const formatToolResponse = formatOutput;

================================================================================
FILE: .ccg_backups/fix_formatted_loop_20260103_092024/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Stable Tool Contract for Generator
// Returns:
// - tool: { primary:{lang,command}, explanation:string, warnings:string[], alternatives:[{note,command}] }
// - markdown: fixed template for fallback
//
// Backward-compatible exports:
// - formatToolResponse
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false; // prose ending
  // basic "command-ish"
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .replace(/\r/g, "")
    .split("\n")
    .map((x) => x.trim())
    .filter(Boolean);

  const cmdLines = [];
  for (const ln of lines) {
    if (looksLikeCommand(ln)) cmdLines.push(ln);
  }
  return cmdLines.join("\n").trim();
}

function extractSection(rest, names) {
  // names: array of heading titles in fa/en
  const t = String(rest || "");
  for (const name of names) {
    const re = new RegExp(`(^|\\n)\\s*##\\s*${name}\\s*\\n([\\s\\S]*?)(?=\\n\\s*##\\s*|$)`, "i");
    const m = t.match(re);
    if (m) return String(m[2] || "").trim();
  }
  return "";
}

function bulletsFromText(s) {
  const lines = String(s || "").split("\n").map(x => x.trim()).filter(Boolean);
  const out = [];
  for (const ln of lines) {
    const m = ln.match(/^[-*â€¢]\s+(.*)$/);
    if (m) out.push(m[1].trim());
  }
  if (out.length) return out.slice(0, 8);
  // if no bullets, split sentences lightly
  const flat = String(s || "").replace(/\s+/g, " ").trim();
  if (!flat) return [];
  return [flat].slice(0, 3);
}

function guessPrimaryCommandFromText(text) {
  const t = String(text || "").replace(/\r/g, "");
  const lines = t.split("\n").map(x => x.trim()).filter(Boolean);
  for (const ln of lines) {
    if (looksLikeCommand(ln)) return ln;
  }
  return "";
}

function defaultWarningsFor(command, cli = "bash") {
  const c = String(command || "").toLowerCase();
  const out = [];
  if (c.includes("reboot") || c.includes("shutdown")) {
    out.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
    out.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø³ÛŒØ³ØªÙ… Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ø¯.");
    out.push("Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Production Ø¨Ø¯ÙˆÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ (maintenance window) Ø§Ø¬Ø±Ø§ Ù†Ú©Ù†ÛŒØ¯.");
  } else if (c.includes("rm ") || c.includes("del ") || c.includes("format")) {
    out.push("Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø¹Ø« Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´ÙˆØ¯Ø› Ù‚Ø¨Ù„Ø´ Ù…Ø³ÛŒØ±/ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú†Ú© Ú©Ù†ÛŒØ¯.");
    out.push("Ø§Ú¯Ø± Ù…Ù…Ú©Ù† Ø§Ø³ØªØŒ Ø§ÙˆÙ„ Dry-run ÛŒØ§ Ù„ÛŒØ³Øªâ€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ø²Ù†ÛŒØ¯.");
  } else {
    out.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø±ÙˆÛŒ Ù…Ø§Ø´ÛŒÙ†/Ù…Ø­ÛŒØ· Ø¯Ø±Ø³Øª Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.");
    out.push("Ø§Ú¯Ø± Ø®Ø±ÙˆØ¬ÛŒ/Ø§Ø«Ø± Ø¯Ø³ØªÙˆØ± Ø­Ø³Ø§Ø³ Ø§Ø³ØªØŒ Ø§ÙˆÙ„ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
  }
  return out.slice(0, 3);
}

function defaultAlternativesFor(command, cli = "bash") {
  const c = String(command || "").toLowerCase();
  const cliL = String(cli || "").toLowerCase();

  // reboot (linux)
  if (c.includes("reboot") || c.includes("shutdown -r")) {
    return [
      { note: "Ø§Ú¯Ø± systemd Ø¯Ø§Ø±ÛŒØ¯ (Ø±Ø³Ù…ÛŒâ€ŒØªØ±)", command: "sudo systemctl reboot" },
      { note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ", command: "sudo shutdown -r now" },
      { note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±", command: "sudo shutdown -r +1" },
    ];
  }

  // windows: list users
  if (cliL.includes("cmd") && (c.startsWith("net user") || c === "net user")) {
    return [
      { note: "Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø¨Ø§ Ø´Ù…Ø§Ø±Ø´ Ø®Ø·ÙˆØ·)", command: 'net user | find /c /v ""' },
      { note: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ WMIC (Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ Ù‚Ø¯ÛŒÙ…ÛŒ/ØºÛŒØ±ÙØ¹Ø§Ù„)", command: "wmic useraccount get name" },
      { note: "PowerShell (Ø§Ú¯Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª)", command: 'powershell -NoProfile -Command "Get-LocalUser | Select -Expand Name"' },
    ];
  }

  // generic helpful alternatives
  const base = command.split(/\s+/)[0] || "command";
  return [
    { note: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹", command: `${base} --help` },
    { note: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ (Ø§Ú¯Ø± Ù†ØµØ¨ Ø§Ø³Øª)", command: `man ${base}` },
    { note: "Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ (Ø§Ú¯Ø± Ù†ØµØ¨ Ø§Ø³Øª)", command: `tldr ${base}` },
  ];
}

function ensureExactly3Alternatives(alts, fallbackCmd, cli) {
  const clean = (Array.isArray(alts) ? alts : [])
    .filter(x => x && typeof x.command === "string" && x.command.trim())
    .map(x => ({ note: String(x.note || "").trim(), command: String(x.command).trim() }));

  if (clean.length >= 3) return clean.slice(0, 3);
  const fill = defaultAlternativesFor(fallbackCmd, cli);
  const out = [...clean];
  for (const a of fill) {
    if (out.length >= 3) break;
    if (!out.some(x => x.command === a.command)) out.push(a);
  }
  while (out.length < 3) out.push({ note: "Ú¯Ø²ÛŒÙ†Ù‡ Ø¯ÛŒÚ¯Ø±", command: fallbackCmd });
  return out.slice(0, 3);
}

function toFixedMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const cmd = tool?.primary?.command || "";
  const expl = tool?.explanation || "";
  const warns = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warns.length ? warns.map(w => `- ${w}`).join("\n") : "- Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ù…Ø­ØªØ§Ø· Ø¨Ø§Ø´ÛŒØ¯.";
  const altBlocks = alts.slice(0,3).map((a, i) => {
    const note = a.note ? `**${i+1}) ${a.note}**` : `**${i+1}) Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†**`;
    return `${note}\n\`\`\`${lang}\n${a.command}\n\`\`\``;
  }).join("\n\n");

  return `\`\`\`${lang}\n${cmd}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${expl}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks}`.trim();
}

export function formatToolResponse({ text, cli = "bash", outputType = "markdown", lang = "fa", userRequest = "" }) {
  const raw = String(text || "").trim();
  const fenceLang = fenceLangFromCli(cli, outputType);

  // primary command
  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  let primary = normalizeCodeToCommands(codeRaw);
  if (!primary) primary = guessPrimaryCommandFromText(raw);
  if (!primary) primary = ""; // still allowed, but we'll fill warnings/alts safely

  // explanation
  let explanation =
    extractSection(rest, ["ØªÙˆØ¶ÛŒØ­", "Ø´Ø±Ø­", "Explanation", "Ø´Ø±Ø­ Ú©Ø§Ø±"]) ||
    String(rest || "").trim();

  explanation = explanation.replace(/\n{3,}/g, "\n\n").trim();
  if (!explanation) {
    if (primary) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø±Ù Ø®ÙˆØ§Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§/Ù…Ø­ÛŒØ· Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
    else explanation = "Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ù‚Ø·Ø¹ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯Ø› Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯ (OS/CLI/Ù‡Ø¯Ù Ø¯Ù‚ÛŒÙ‚).";
  }
  // keep explanation short-ish
  if (explanation.length > 420) explanation = explanation.slice(0, 420).trim() + "â€¦";

  // warnings
  const warnText = extractSection(rest, ["Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Ù‡Ø´Ø¯Ø§Ø±", "Warnings", "Warning"]);
  let warnings = bulletsFromText(warnText);
  if (!warnings.length) warnings = defaultWarningsFor(primary || userRequest, cli);

  // alternatives
  // try to parse alternatives section very lightly (if any fenced blocks exist there)
  const altText = extractSection(rest, ["Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†", "Alternatives", "Alternative"]);
  let alternatives = [];
  if (altText) {
    const blocks = [...altText.matchAll(/```[^\n]*\n([\s\S]*?)```/g)].map(m => String(m[1]||"").trim()).filter(Boolean);
    for (const b of blocks) {
      const cmd = normalizeCodeToCommands(b) || guessPrimaryCommandFromText(b);
      if (cmd) alternatives.push({ note: "", command: cmd });
    }
  }
  alternatives = ensureExactly3Alternatives(alternatives, primary || guessPrimaryCommandFromText(raw) || "", cli);

  // outputType command/script => only primary command as copy-ready fence
  if (String(outputType || "").toLowerCase() === "command" || String(outputType || "").toLowerCase() === "script") {
    const only = primary ? `\`\`\`${fenceLang}\n${primary}\n\`\`\`` : "";
    return {
      tool: {
        primary: { lang: fenceLang, command: primary },
        explanation,
        warnings,
        alternatives,
      },
      markdown: only,
    };
  }

  const tool = {
    primary: { lang: fenceLang, command: primary },
    explanation,
    warnings,
    alternatives,
  };

  return { tool, markdown: toFixedMarkdown(tool) };
}

// alias for older code
export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/day2_generator_polish_20260108_052549/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useRef, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";

const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom)" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  mac: ["zsh", "bash"],
  windows: ["powershell", "cmd"],
  other: ["bash", "zsh", "sh", "powershell", "cmd"],
};

const LINUX_DISTROS = ["Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES","Alpine","Kali"];
const WINDOWS_EDITIONS = ["Windows 11","Windows 10","Windows Server 2022","Windows Server 2019"];
const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "mikrotik", label: "MikroTik" },
  { value: "fortinet", label: "Fortinet" },
  { value: "juniper", label: "Juniper" },
  { value: "paloalto", label: "Palo Alto" },
  { value: "arista", label: "Arista" },
  { value: "hpe_aruba", label: "HPE Aruba" },
  { value: "ubiquiti", label: "Ubiquiti" },
  { value: "other", label: "Other" },
];

const NETWORK_DEVICE_TYPES = [
  { value: "router", label: "Router" },
  { value: "switch", label: "Switch" },
  { value: "firewall", label: "Firewall" },
  { value: "loadbalancer", label: "Load Balancer" },
  { value: "wireless", label: "Wireless/AP" },
  { value: "vpn", label: "VPN Gateway" },
  { value: "general", label: "General" },
];

const NETWORK_OS_FLAVOR = {
  cisco: ["Cisco IOS", "Cisco IOS-XE", "Cisco NX-OS", "Cisco ASA", "Cisco FTD"],
  mikrotik: ["RouterOS"],
  fortinet: ["FortiOS"],
  juniper: ["JunOS"],
  paloalto: ["PAN-OS"],
  arista: ["EOS"],
  hpe_aruba: ["ArubaOS-CX", "ArubaOS"],
  ubiquiti: ["EdgeOS", "UniFi OS"],
  other: ["Network OS"],
};

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 2, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen || s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

function qsSet(params) {
  const p = new URLSearchParams();
  Object.entries(params).forEach(([k,v]) => {
    if (v === undefined || v === null) return;
    const s = String(v).trim();
    if (!s) return;
    p.set(k, s);
  });
  const q = p.toString();
  const url = q ? `?${q}` : location.pathname;
  window.history.replaceState({}, "", url);
}

function qsGet(key) {
  try { return new URLSearchParams(location.search).get(key); } catch { return null; }
}

export default function GeneratorPage() {
  const { lang, t } = useLanguage();

  // core
  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool"); // tool | markdown
  const [verbosity, setVerbosity] = useState("normal"); // brief|normal|detailed

  // input/output
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");
  const [formErr, setFormErr] = useState("");

  const [markdown, setMarkdown] = useState("");
  const [toolResult, setToolResult] = useState(null);

  // network fields (NORMAL)
  const [vendor, setVendor] = useState("cisco");
  const [deviceType, setDeviceType] = useState("general");

  // advanced toggles
  const [advanced, setAdvanced] = useState(false);
  const [customEnabled, setCustomEnabled] = useState(false);

  // advanced per platform
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [linuxVersion, setLinuxVersion] = useState("");

  const [windowsEdition, setWindowsEdition] = useState("Windows 11");
  const [windowsVersion, setWindowsVersion] = useState("");

  const [macVersion, setMacVersion] = useState("");

  const [netOs, setNetOs] = useState("Cisco IOS");
  const [netOsVersion, setNetOsVersion] = useState("");

  // custom (validated before API)
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  const isNetwork = platform === "network";

  const shellOptions = useMemo(() => {
    if (isNetwork) return ["network"];
    const arr = SHELL_BY_PLATFORM[platform] || ["bash"];
    return arr;
  }, [platform, isNetwork]);

  // keep cli valid when platform changes
  useEffect(() => {
    if (isNetwork) {
      setCli("network");
      return;
    }
    const opts = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!opts.includes(cli)) setCli(opts[0]);
  }, [platform, isNetwork]); // eslint-disable-line

  // advanced options must follow platform (no mismatch)
  useEffect(() => {
    setFormErr("");
    setApiErr("");
    if (platform === "linux") {
      // keep sane defaults
      if (!LINUX_DISTROS.includes(linuxDistro)) setLinuxDistro("Ubuntu");
    }
    if (platform === "windows") {
      if (!WINDOWS_EDITIONS.includes(windowsEdition)) setWindowsEdition("Windows 11");
    }
    if (platform === "network") {
      const list = NETWORK_OS_FLAVOR[vendor] || ["Network OS"];
      if (!list.includes(netOs)) setNetOs(list[0]);
    }
    if (platform !== "other") {
      // custom mode only meaningful inside advanced, but keep state
    }
  }, [platform, vendor]); // eslint-disable-line

  // persistence (localStorage + URL query)
  const firstLoad = useRef(true);
  useEffect(() => {
    const saved = (() => {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; }
    })();

    const qPlatform = qsGet("platform");
    const qCli = qsGet("cli");
    const qVerb = qsGet("v");
    const qOut = qsGet("out");

    const s = saved || {};
    setPlatform(qPlatform || s.platform || "linux");
    setCli(qCli || s.cli || "bash");
    setVerbosity(qVerb || s.verbosity || "normal");
    setOutputType(qOut || s.outputType || "tool");

    setVendor(s.vendor || "cisco");
    setDeviceType(s.deviceType || "general");

    setAdvanced(Boolean(s.advanced));
    setCustomEnabled(Boolean(s.customEnabled));

    setLinuxDistro(s.linuxDistro || "Ubuntu");
    setLinuxVersion(s.linuxVersion || "");

    setWindowsEdition(s.windowsEdition || "Windows 11");
    setWindowsVersion(s.windowsVersion || "");

    setMacVersion(s.macVersion || "");

    setNetOs(s.netOs || "Cisco IOS");
    setNetOsVersion(s.netOsVersion || "");

    setCustomOS(s.customOS || "");
    setCustomShell(s.customShell || "");

    firstLoad.current = false;
  }, []);

  useEffect(() => {
    if (firstLoad.current) return;

    const state = {
      platform, cli, outputType, verbosity,
      vendor, deviceType,
      advanced, customEnabled,
      linuxDistro, linuxVersion,
      windowsEdition, windowsVersion,
      macVersion,
      netOs, netOsVersion,
      customOS, customShell,
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {}
    qsSet({ platform, cli, v: verbosity, out: outputType });
  }, [
    platform, cli, outputType, verbosity,
    vendor, deviceType, advanced, customEnabled,
    linuxDistro, linuxVersion, windowsEdition, windowsVersion, macVersion,
    netOs, netOsVersion, customOS, customShell
  ]);

  function buildOsString() {
    if (!advanced) {
      // minimal: platform name only
      if (platform === "linux") return "linux";
      if (platform === "windows") return "windows";
      if (platform === "mac") return "mac";
      if (platform === "network") return "network";
      return "other";
    }

    if (customEnabled) {
      return cleanToken(customOS);
    }

    if (platform === "linux") {
      const base = linuxDistro;
      const ver = cleanToken(linuxVersion);
      return ver ? `${base} ${ver}` : base;
    }
    if (platform === "windows") {
      const base = windowsEdition;
      const ver = cleanToken(windowsVersion);
      return ver ? `${base} ${ver}` : base;
    }
    if (platform === "mac") {
      const ver = cleanToken(macVersion);
      return ver ? `macOS ${ver}` : "macOS";
    }
    if (platform === "network") {
      const ver = cleanToken(netOsVersion);
      return ver ? `${netOs} ${ver}` : netOs;
    }
    return "other";
  }

  function validateBeforeSend() {
    setFormErr("");

    if (!input.trim()) {
      setFormErr(lang === "fa" ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯." : "Please enter a request.");
      return false;
    }

    if (customEnabled) {
      const osOk = isSafeFreeText(customOS, 2, 40);
      const shOk = isSafeFreeText(customShell, 2, 20);

      if (!osOk && !shOk) {
        setFormErr(lang === "fa"
          ? "Custom OS Ùˆ Custom Shell Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. ÙÙ‚Ø· Ø­Ø±ÙˆÙ/Ø¹Ø¯Ø¯/ÙØ§ØµÙ„Ù‡ Ùˆ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ . _ + - / Ù…Ø¬Ø§Ø² Ø§Ø³Øª (Û² ØªØ§ Û´Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)."
          : "Invalid Custom OS/Shell (allowed: letters/numbers/space and . _ + - /).");
        return false;
      }
      if (!osOk) {
        setFormErr(lang === "fa"
          ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù…Ø«Ø§Ù„ Ø¯Ø±Ø³Øª: Ubuntu, FreeBSD, Windows Server 2022"
          : "Invalid Custom OS.");
        return false;
      }
      if (!shOk) {
        setFormErr(lang === "fa"
          ? "Custom Shell Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù…Ø«Ø§Ù„ Ø¯Ø±Ø³Øª: bash, zsh, cmd, powershell"
          : "Invalid Custom Shell.");
        return false;
      }
    }

    // prevent mismatch: network must not send non-network cli
    if (isNetwork && cli !== "network") setCli("network");

    return true;
  }

  function payloadForGenerate() {
    const osString = buildOsString();

    // IMPORTANT: when customEnabled, do not send vendor/deviceType or other advanced OS fields
    if (customEnabled) {
      return {
        mode: "generate",
        lang,
        user_request: input.trim(),
        outputType,
        verbosity,
        platform: "other",
        os: cleanToken(customOS),
        cli: cleanToken(customShell),
      };
    }

    return {
      mode: "generate",
      lang,
      user_request: input.trim(),
      outputType,
      verbosity,
      platform,
      os: osString,
      cli,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  }

  function payloadForExplain(targetCommand) {
    const osString = buildOsString();

    if (customEnabled) {
      return {
        mode: "explain",
        lang,
        targetCommand,
        user_request: input.trim() || "context",
        outputType,
        verbosity,
        platform: "other",
        os: cleanToken(customOS),
        cli: cleanToken(customShell),
      };
    }

    return {
      mode: "explain",
      lang,
      targetCommand,
      user_request: input.trim() || "context",
      outputType,
      verbosity,
      platform,
      os: osString,
      cli,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  }

  const onGenerate = async () => {
    if (loading) return;
    setApiErr("");
    setToolResult(null);
    setMarkdown("");

    if (!validateBeforeSend()) return;

    setLoading(true);
    try {
      const res = await callCCG(payloadForGenerate());
      const tool = res?.tool && typeof res.tool === "object" ? res.tool : null;
      const md = String(res?.output || res?.markdown || res?.result || "").trim();

      if (outputType === "tool") {
        setToolResult(tool);
        setMarkdown(md);
      } else {
        setMarkdown(md);
      }
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  const onExplain = async () => {
    if (!toolResult?.primary?.command) {
      setFormErr(lang === "fa" ? "Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø±ÙˆØ¬ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù† ØªÙˆØ¶ÛŒØ­ Ø¯Ø§Ø¯." : "Generate first, then explain.");
      return;
    }
    if (loading) return;
    setApiErr("");
    setFormErr("");

    setLoading(true);
    try {
      const target = String(toolResult.primary.command).trim();
      const res = await callCCG(payloadForExplain(target));
      const tool = res?.tool && typeof res.tool === "object" ? res.tool : null;
      const md = String(res?.output || res?.markdown || res?.result || "").trim();
      setToolResult(tool);
      setMarkdown(md);
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-4">
            <div className="flex items-center gap-2">
              <span className="text-sm text-slate-700 dark:text-slate-200/80">{t("platform") || "Platform"}</span>
              <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
                {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>
            </div>

            {!isNetwork ? (
              <div className="flex items-center gap-2">
                <span className="text-sm text-slate-700 dark:text-slate-200/80">{t("shell") || "Shell"}</span>
                <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm">
                  {shellOptions.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
            ) : (
              <>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-slate-700 dark:text-slate-200/80">{t("vendor") || "Vendor"}</span>
                  <select value={vendor} onChange={(e)=>setVendor(e.target.value)} className="ccg-select text-sm">
                    {NETWORK_VENDORS.map(v => <option key={v.value} value={v.value}>{v.label}</option>)}
                  </select>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-slate-700 dark:text-slate-200/80">{t("deviceType") || "Device"}</span>
                  <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select text-sm">
                    {NETWORK_DEVICE_TYPES.map(d => <option key={d.value} value={d.value}>{d.label}</option>)}
                  </select>
                </div>
              </>
            )}

            <div className="flex items-center gap-2">
              <span className="text-sm text-slate-700 dark:text-slate-200/80">Output</span>
              <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
                <option value="tool">Tool (UI)</option>
                <option value="markdown">Markdown</option>
              </select>
            </div>

            <div className="flex items-center gap-2">
              <span className="text-sm text-slate-700 dark:text-slate-200/80">Verbosity</span>
              <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
                <option value="brief">brief</option>
                <option value="normal">normal</option>
                <option value="detailed">detailed</option>
              </select>
            </div>

            <label className="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200/80">
              <input type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              Advanced
            </label>
          </div>

          {advanced ? (
            <div className="mt-4 rounded-xl border border-[var(--border)] p-4 space-y-3">
              <label className="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-200/80">
                <input type="checkbox" checked={customEnabled} onChange={(e)=>setCustomEnabled(e.target.checked)} />
                Custom OS/Shell
              </label>

              {customEnabled ? (
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Custom OS (validated)</div>
                    <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input text-sm w-full" placeholder="Ubuntu / FreeBSD / Windows Server 2022" />
                  </div>
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Custom Shell/CLI (validated)</div>
                    <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input text-sm w-full" placeholder="bash / zsh / cmd / powershell" />
                  </div>
                </div>
              ) : platform === "linux" ? (
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Distro</div>
                    <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select text-sm w-full">
                      {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                    </select>
                  </div>
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Version (optional)</div>
                    <input value={linuxVersion} onChange={(e)=>setLinuxVersion(e.target.value)} className="ccg-input text-sm w-full" placeholder="22.04 / 12 / 9 ..." />
                  </div>
                </div>
              ) : platform === "windows" ? (
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Edition</div>
                    <select value={windowsEdition} onChange={(e)=>setWindowsEdition(e.target.value)} className="ccg-select text-sm w-full">
                      {WINDOWS_EDITIONS.map(x => <option key={x} value={x}>{x}</option>)}
                    </select>
                  </div>
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Version/Build (optional)</div>
                    <input value={windowsVersion} onChange={(e)=>setWindowsVersion(e.target.value)} className="ccg-input text-sm w-full" placeholder="23H2 / build 22631 ..." />
                  </div>
                </div>
              ) : platform === "mac" ? (
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-slate-500 mb-1">macOS Version (optional)</div>
                    <input value={macVersion} onChange={(e)=>setMacVersion(e.target.value)} className="ccg-input text-sm w-full" placeholder="14 / 13.6 ..." />
                  </div>
                </div>
              ) : platform === "network" ? (
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Network OS</div>
                    <select value={netOs} onChange={(e)=>setNetOs(e.target.value)} className="ccg-select text-sm w-full">
                      {(NETWORK_OS_FLAVOR[vendor] || ["Network OS"]).map(x => <option key={x} value={x}>{x}</option>)}
                    </select>
                  </div>
                  <div>
                    <div className="text-xs text-slate-500 mb-1">OS Version (optional)</div>
                    <input value={netOsVersion} onChange={(e)=>setNetOsVersion(e.target.value)} className="ccg-input text-sm w-full" placeholder="16.12 / 7.2 / ..." />
                  </div>
                </div>
              ) : (
                <div className="text-sm text-slate-500">Advanced options for this platform are limited.</div>
              )}
            </div>
          ) : null}
        </div>
      </div>

      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 space-y-4">
          <textarea
            value={input}
            onChange={(e)=>setInput(e.target.value)}
            rows={4}
            className="ccg-textarea w-full"
            placeholder={t("placeholderReq") || "Ø¯Ø±Ø®ÙˆØ§Ø³ØªØª Ø±Ø§ ÙˆØ§Ø¶Ø­ Ø¨Ù†ÙˆÛŒØ³."}
          />

          {formErr ? (
            <div className="ccg-error">
              <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
              <div className="text-sm">{formErr}</div>
            </div>
          ) : null}

          {apiErr ? (
            <div className="ccg-error">
              <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
              <div className="text-sm">{apiErr}</div>
            </div>
          ) : null}

          <div className="flex flex-col sm:flex-row gap-3">
            <button className="ccg-btn w-full sm:w-auto" onClick={onGenerate} disabled={loading}>
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯..." : "Generating...") : (lang === "fa" ? "Generate" : "Generate")}
            </button>

            <button className="ccg-btn w-full sm:w-auto" onClick={onExplain} disabled={loading || !toolResult?.primary?.command}>
              {lang === "fa" ? "Explain command" : "Explain command"}
            </button>
          </div>
        </div>
      </div>

      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-8">
          <h2 className="text-lg font-semibold mb-4">{t("output") || "Output"}</h2>

          {outputType === "tool" && toolResult ? (
            <ToolResult tool={toolResult} />
          ) : markdown ? (
            <SectionedMarkdown markdown={markdown} lang={lang} />
          ) : (
            <div className="text-sm text-slate-500 dark:text-slate-300/70">
              {t("outputPlaceholder") || "Output will appear here."}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/day2_generator_polish_20260108_052549/client/src/components/ui/ToolResult.jsx
================================================================================

import React, { useMemo, useState } from "react";

function CopyBtn({ value }) {
  const [ok, setOk] = useState(false);

  const onCopy = async () => {
    try {
      await navigator.clipboard.writeText(String(value || ""));
      setOk(true);
      setTimeout(() => setOk(false), 900);
    } catch {
      // ignore
    }
  };

  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn px-3 py-1 text-xs"
      disabled={!value}
      title={value ? "Copy" : "Nothing to copy"}
    >
      {ok ? "Copied" : "Copy"}
    </button>
  );
}

function oneLineCommand(s) {
  const t = String(s || "").trim();
  const m = t.match(/^\s*```[^\n]*\n([\s\S]*?)\n?```\s*$/);
  const un = (m ? m[1] : t).trim();
  const first = un.split("\n").map(x=>x.trim()).find(Boolean) || "";
  return first;
}

export default function ToolResult({ tool }) {
  const t = tool || {};
  const primary = t.primary || {};
  const cmd = useMemo(() => oneLineCommand(primary.command || ""), [primary.command]);
  const lang = String(primary.lang || "bash");

  const warnings = Array.isArray(t.warnings) ? t.warnings : [];
  const alts = Array.isArray(t.alternatives) ? t.alternatives : [];

  return (
    <div className="space-y-5">
      <div className="flex items-start justify-between gap-3">
        <div className="flex-1">
          <div className="text-sm font-semibold mb-2">Command</div>
          <div className="rounded-xl border border-[var(--border)] bg-white/60 dark:bg-white/5 p-3">
            <div className="flex items-start justify-between gap-3">
              <pre className="text-sm overflow-auto m-0 leading-6"><code>{cmd}</code></pre>
              <CopyBtn value={cmd} />
            </div>
            <div className="text-xs text-slate-500 mt-2">lang: {lang}</div>
          </div>
        </div>
      </div>

      <div>
        <div className="text-sm font-semibold mb-2">Explanation</div>
        <div className="text-sm text-slate-700 dark:text-slate-200/80 whitespace-pre-wrap">
          {String(t.explanation || "").trim()}
        </div>
      </div>

      <div>
        <div className="text-sm font-semibold mb-2">Warnings</div>
        <ul className="list-disc pr-5 text-sm text-slate-700 dark:text-slate-200/80 space-y-1">
          {warnings.map((w, i) => (
            <li key={i}>{String(w)}</li>
          ))}
        </ul>
      </div>

      <div>
        <div className="text-sm font-semibold mb-2">Alternatives</div>
        <div className="space-y-3">
          {alts.map((a, i) => {
            const c = oneLineCommand(a?.command || "");
            const note = String(a?.note || "").trim();
            return (
              <div key={i} className="rounded-xl border border-[var(--border)] p-3">
                {note ? <div className="text-xs text-slate-500 mb-2">{note}</div> : null}
                <div className="flex items-start justify-between gap-3">
                  <pre className="text-sm overflow-auto m-0 leading-6"><code>{c}</code></pre>
                  <CopyBtn value={c} />
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_generator_blank_20260107_092609/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

// ---- Advanced: validation allowlists (client-side) ----
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES",
  "Amazon Linux","Oracle Linux","Kali","Gentoo","Alpine",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = [
  "bash","zsh","sh","fish",
  "cmd","powershell","pwsh",
  "ksh","tcsh"
];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 0, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{1,40}$/.test(s);
}


const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  
  const [customOSName, setCustomOSName] = useState("Ubuntu");
  const [customOSVersion, setCustomOSVersion] = useState("");
  const [customShell, setCustomShell] = useState("bash");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  
  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    const isOther = platform === "other";

    // Defaults (even when Advanced is closed)
    const safeMode = modeStyle || "operational";
    const safeLevel = knowledgeLevel || "intermediate";

    // Base OS/CLI mapping
    let osValue = isNetwork ? "network" : (platform || "linux");
    let cliValue = isNetwork ? "network-cli" : (shell || "bash");

    // If Other: use custom fields (validated)
    if (isOther) {
      const name = cleanToken(customOSName);
      const ver  = cleanToken(customOSVersion);
      const sh   = cleanToken(customShell).toLowerCase();

      const nameOk = !!name && (OS_ALLOWLIST.includes(name) || isSafeFreeText(name, 2, 40));
      const verOk  = ver ? isSafeFreeText(ver, 1, 20) : true;
      const shOk   = !!sh && SHELL_ALLOWLIST.includes(sh);

      const finalName = nameOk ? name : "Ubuntu";
      const finalVer  = (verOk ? ver : "");
      const finalShell= shOk ? sh : "bash";

      osValue = finalVer ? `${finalName} ${finalVer}` : finalName;
      cliValue = finalShell;
    }

    return {
      mode: "generate",
      lang: lang || "fa",
      user_request: input.trim(),

      outputType: outputType,
      modeStyle: safeMode,
      knowledgeLevel: safeLevel,

      platform: isNetwork ? "network" : (platform || "linux"),
      os: osValue,
      cli: cliValue,

      vendor: isNetwork ? (vendor || "") : "",
      deviceType: isNetwork ? (deviceType || "general") : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }

  useEffect(() => {
    document.body.classList.add("night-mode");
    document.body.classList.add("day-mode");
  }, []);


  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}

// --- auto-closed by safe EOF fixer ---

}

================================================================================
FILE: .ccg_backups/day2_advanced_os_shell_20260107_053633/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (platform === "other" && (!customOS.trim() || !customShell.trim())))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_tool_json_leak_20260107_142753/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract Normalizer (Generator + Explain)
//
// Returns:
//  - tool: { primary:{command,lang}, explanation, warnings[], alternatives[] }
//  - markdown: string (strict template)
//  - output: markdown (alias)
//
// Explain mode: if forcedCommand provided, primary.command MUST stay exactly that.
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh" || c === "powershell") return "powershell";
  if (c.includes("cmd") || c === "cmd") return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  if (/^(explain|context|note|warning|tip)\b/i.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizeCommandFromText(rawText) {
  const { codeRaw } = splitFirstCodeBlock(rawText);
  if (codeRaw) {
    const lines = codeRaw.split("\n").map(l => l.trim()).filter(Boolean);
    const cmdLines = lines.filter(looksLikeCommand);
    if (cmdLines.length) return cmdLines.join("\n");
  }
  const lines = String(rawText || "").split("\n").map(l => l.trim());
  for (const l of lines) if (looksLikeCommand(l)) return l;
  return "";
}

function pickWarnings(rawText, os, cli) {
  const base = ["Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯."];
  if (/ssh/i.test(String(rawText || ""))) base.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø´ÙˆØ¯.");
  if (String(os || "").toLowerCase().includes("linux")) base.push("Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ sudo Ù†ÛŒØ§Ø² Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.");
  if (String(cli || "").toLowerCase().includes("cmd")) base.push("Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù…ÙˆØ§Ø±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Administrator Ø§Ø³Øª.");
  return base;
}

function ensure3Alternatives(alts) {
  const out = Array.isArray(alts) ? alts.filter(a => a && a.command) : [];
  while (out.length < 3) out.push({ command: "", note: "" });
  return out.slice(0, 3);
}

function buildMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const primary = String(tool?.primary?.command || "").trim() || 'echo "No command produced"';
  const explanation = String(tool?.explanation || "").trim() || "â€”";
  const warnings = (Array.isArray(tool?.warnings) && tool.warnings.length) ? tool.warnings : ["â€”"];
  const alternatives = ensure3Alternatives(tool?.alternatives);

  const warnLines = warnings.map(w => `- ${String(w).trim()}`).join("\n");

  const altBlocks = alternatives.map(a => {
    const note = String(a?.note || "").trim() || "â€”";
    const cmd = String(a?.command || "").trim() || "â€”";
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `\`\`\`${lang}\n${primary}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${explanation}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks}\n`;
}

export function formatToolResponse(opts = {}) {
  const rawText = String(opts.rawText ?? opts.text ?? "").trim();
  const cli = opts.cli || "bash";
  const outputType = opts.outputType || "tool";
  const lang = fenceLangFromCli(cli, outputType);

  const forced = String(opts.forcedCommand || "").trim();
  const primaryCommand = forced || normalizeCommandFromText(rawText) || 'echo "No command produced"';

  const { rest } = splitFirstCodeBlock(rawText);
  const explanation = (rest && rest.length < 4000) ? rest : "â€”";

  const tool = {
    primary: { command: primaryCommand, lang },
    explanation,
    warnings: pickWarnings(rawText, opts.os, cli),
    alternatives: Array.isArray(opts.alternatives) ? opts.alternatives : []
  };

  // Auto alternatives if empty
  if (!tool.alternatives.length) {
    const c = String(cli || "").toLowerCase();
    if (c.includes("cmd")) {
      tool.alternatives = [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† ÙÙˆØ±ÛŒ" },
        { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø¹Ø¯ Ø§Ø² 60 Ø«Ø§Ù†ÛŒÙ‡" },
      ];
    } else if (String(opts.os || "").toLowerCase().includes("linux")) {
      tool.alternatives = [
        { command: "sudo shutdown -h +1", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      ];
    } else {
      tool.alternatives = [
        { command: primaryCommand, note: "Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ±" },
        { command: primaryCommand, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Û²" },
        { command: primaryCommand, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Û³" },
      ];
    }
  }

  const markdown = buildMarkdown(tool);
  return { tool, markdown, output: markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/lock_tool_contract_20260103_093401/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/lock_tool_contract_20260103_093401/client/src/components/ui/MarkdownBox.jsx
================================================================================

// client/src/components/ui/MarkdownBox.jsx
import { useMemo, useState } from "react";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";

function CopyMini({ value, labelCopy, labelCopied }) {
  const [copied, setCopied] = useState(false);

  async function onCopy() {
    try {
      await navigator.clipboard.writeText(value || "");
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {}
  }

  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn ccg-btn-ghost px-3 py-1 text-xs"
      title={labelCopy}
    >
      {copied ? labelCopied : labelCopy}
    </button>
  );
}

/**
 * âœ… Fix 1: Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ prop:
 * - content
 * - markdown
 *
 * âœ… Fix 2: Section boxing
 * Ø§Ú¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ Heading Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø¨ÛŒØ§Ø¯ (Command/Explanation/Warnings/Alternatives Ùˆ ...)
 * Ù‡Ø± Ø¨Ø®Ø´ ØªÙˆÛŒ ÛŒÚ© Ú©Ø§Ø¯Ø± Ø¬Ø¯Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡.
 */
export default function MarkdownBox({ content, markdown, lang = "fa" }) {
  const t = useMemo(() => {
    const fa = { copy: "Ú©Ù¾ÛŒ", copied: "Ú©Ù¾ÛŒ Ø´Ø¯" };
    const en = { copy: "Copy", copied: "Copied" };
    return lang === "fa" ? fa : en;
  }, [lang]);

  const raw = (typeof content === "string" ? content : "") || (typeof markdown === "string" ? markdown : "");
  const text = raw || "";

  const sections = useMemo(() => {
    // split by headings (## or #)
    // keep heading with its body
    const lines = text.split("\n");
    const out = [];
    let cur = { title: "", body: [] };

    function pushCur() {
      const body = cur.body.join("\n").trim();
      if (cur.title || body) out.push({ title: cur.title.trim(), body });
    }

    for (const line of lines) {
      const m = line.match(/^(#{1,3})\s+(.*)$/);
      if (m) {
        pushCur();
        cur = { title: m[2] || "", body: [] };
      } else {
        cur.body.push(line);
      }
    }
    pushCur();

    // Ø§Ú¯Ø± Ù‡ÛŒÚ† heading Ù†Ø¨ÙˆØ¯ â†’ ÛŒÚ© Ø³Ú©Ø´Ù†
    if (out.length === 0) return [{ title: "", body: text }];
    // Ø§Ú¯Ø± heading Ø§ÙˆÙ„ Ø®Ø§Ù„ÛŒÙ‡ Ùˆ body Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†ÛŒÚ©Ù‡ â†’ Ø­Ø°Ù
    return out;
  }, [text]);

  if (!text.trim()) {
    return (
      <div className="rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-slate-400">
        {lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}
      </div>
    );
  }

  return (
    <div className={`space-y-4 ${lang === "fa" ? "rtl" : "ltr"}`}>
      {sections.map((s, idx) => {
        const value = (s.body || "").replace(/\n$/, "");
        return (
          <div key={idx} className="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div className="flex items-center justify-between gap-3 mb-3">
              <div className="text-sm font-semibold text-slate-100">
                {s.title || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result")}
              </div>
              <CopyMini value={value} labelCopy={t.copy} labelCopied={t.copied} />
            </div>

            <div className="prose prose-invert max-w-none text-sm">
              <ReactMarkdown
                remarkPlugins={[remarkGfm]}
                components={{
                  code({ inline, className, children }) {
                    const raw = String(children ?? "");
                    const v = raw.replace(/\n$/, "");
                    const isBlock = !inline;
                    if (!isBlock) return <code className="px-1 py-0.5 rounded bg-black/30">{children}</code>;

                    const langName = (className || "").replace("language-", "") || "CODE";
                    return (
                      <div className="rounded-2xl border border-white/10 bg-black/30 overflow-hidden">
                        <div className="flex items-center justify-between px-3 py-2 border-b border-white/10">
                          <div className="text-xs font-semibold text-slate-200">{langName}</div>
                          <CopyMini value={v} labelCopy={t.copy} labelCopied={t.copied} />
                        </div>
                        <pre className="overflow-auto p-3 text-xs leading-6">
                          <code dir="ltr">{v}</code>
                        </pre>
                      </div>
                    );
                  },
                }}
              >
                {s.body || ""}
              </ReactMarkdown>
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/lock_tool_contract_20260103_093401/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo } from "react";

function CopyBtn({ text }) {
  return (
    <button
      className="px-3 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-white/80 text-xs"
      onClick={async () => {
        try { await navigator.clipboard.writeText(text); } catch {}
      }}
      type="button"
    >
      Ú©Ù¾ÛŒ
    </button>
  );
}

function Card({ title, right, children, danger }) {
  return (
    <div className={`rounded-2xl border ${danger ? "border-red-500/40 bg-red-500/10" : "border-white/10 bg-white/5"} p-4`}>
      <div className="flex items-center justify-between mb-3">
        <div className="text-white/90 font-semibold">{title}</div>
        {right}
      </div>
      {children}
    </div>
  );
}

function CodeBlock({ lang = "bash", code }) {
  return (
    <pre className="rounded-xl border border-white/10 bg-black/30 p-3 overflow-auto text-sm text-white/90">
      <code>{code}</code>
    </pre>
  );
}

export default function ToolResult({ tool }) {
  const primary = tool?.primary?.command || "";
  const lang = tool?.primary?.lang || "bash";
  const explanation = tool?.explanation || "";
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alternatives = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnText = useMemo(() => warnings.join("\n"), [warnings]);

  return (
    <div className="space-y-4">
      <Card title="Ú©Ø§Ù…Ù†Ø¯ Ø§ØµÙ„ÛŒ" right={<CopyBtn text={primary} />}>
        <CodeBlock lang={lang} code={primary} />
      </Card>

      <Card title="ØªÙˆØ¶ÛŒØ­">
        <div className="text-white/80 leading-7 whitespace-pre-wrap">{explanation}</div>
      </Card>

      <Card title="Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" danger right={<CopyBtn text={warnText} />}>
        <ul className="list-disc pr-5 space-y-2 text-white/85">
          {(warnings.length ? warnings : ["Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."]).map((w, i) => (
            <li key={i} className="leading-7">{w}</li>
          ))}
        </ul>
      </Card>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {(alternatives.length ? alternatives.slice(0,3) : []).map((a, i) => (
          <Card
            key={i}
            title={`Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† ${i + 1}`}
            right={<CopyBtn text={a.command || ""} />}
          >
            {a.note ? <div className="text-white/70 text-sm mb-2">{a.note}</div> : null}
            <CodeBlock lang={lang} code={a.command || ""} />
          </Card>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/lock_tool_contract_20260103_093401/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Stable Tool Contract for Generator
// Returns:
// - tool: { primary:{lang,command}, explanation:string, warnings:string[], alternatives:[{note,command}] }
// - markdown: fixed template for fallback
//
// Backward-compatible exports:
// - formatToolResponse
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false; // prose ending
  // basic "command-ish"
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .replace(/\r/g, "")
    .split("\n")
    .map((x) => x.trim())
    .filter(Boolean);

  const cmdLines = [];
  for (const ln of lines) {
    if (looksLikeCommand(ln)) cmdLines.push(ln);
  }
  return cmdLines.join("\n").trim();
}

function extractSection(rest, names) {
  // names: array of heading titles in fa/en
  const t = String(rest || "");
  for (const name of names) {
    const re = new RegExp(`(^|\\n)\\s*##\\s*${name}\\s*\\n([\\s\\S]*?)(?=\\n\\s*##\\s*|$)`, "i");
    const m = t.match(re);
    if (m) return String(m[2] || "").trim();
  }
  return "";
}

function bulletsFromText(s) {
  const lines = String(s || "").split("\n").map(x => x.trim()).filter(Boolean);
  const out = [];
  for (const ln of lines) {
    const m = ln.match(/^[-*â€¢]\s+(.*)$/);
    if (m) out.push(m[1].trim());
  }
  if (out.length) return out.slice(0, 8);
  // if no bullets, split sentences lightly
  const flat = String(s || "").replace(/\s+/g, " ").trim();
  if (!flat) return [];
  return [flat].slice(0, 3);
}

function guessPrimaryCommandFromText(text) {
  const t = String(text || "").replace(/\r/g, "");
  const lines = t.split("\n").map(x => x.trim()).filter(Boolean);
  for (const ln of lines) {
    if (looksLikeCommand(ln)) return ln;
  }
  return "";
}

function defaultWarningsFor(command, cli = "bash") {
  const c = String(command || "").toLowerCase();
  const out = [];
  if (c.includes("reboot") || c.includes("shutdown")) {
    out.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
    out.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø³ÛŒØ³ØªÙ… Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ø¯.");
    out.push("Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Production Ø¨Ø¯ÙˆÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ (maintenance window) Ø§Ø¬Ø±Ø§ Ù†Ú©Ù†ÛŒØ¯.");
  } else if (c.includes("rm ") || c.includes("del ") || c.includes("format")) {
    out.push("Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø¹Ø« Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´ÙˆØ¯Ø› Ù‚Ø¨Ù„Ø´ Ù…Ø³ÛŒØ±/ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú†Ú© Ú©Ù†ÛŒØ¯.");
    out.push("Ø§Ú¯Ø± Ù…Ù…Ú©Ù† Ø§Ø³ØªØŒ Ø§ÙˆÙ„ Dry-run ÛŒØ§ Ù„ÛŒØ³Øªâ€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ø²Ù†ÛŒØ¯.");
  } else {
    out.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø±ÙˆÛŒ Ù…Ø§Ø´ÛŒÙ†/Ù…Ø­ÛŒØ· Ø¯Ø±Ø³Øª Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.");
    out.push("Ø§Ú¯Ø± Ø®Ø±ÙˆØ¬ÛŒ/Ø§Ø«Ø± Ø¯Ø³ØªÙˆØ± Ø­Ø³Ø§Ø³ Ø§Ø³ØªØŒ Ø§ÙˆÙ„ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
  }
  return out.slice(0, 3);
}

function defaultAlternativesFor(command, cli = "bash") {
  const c = String(command || "").toLowerCase();
  const cliL = String(cli || "").toLowerCase();

  // reboot (linux)
  if (c.includes("reboot") || c.includes("shutdown -r")) {
    return [
      { note: "Ø§Ú¯Ø± systemd Ø¯Ø§Ø±ÛŒØ¯ (Ø±Ø³Ù…ÛŒâ€ŒØªØ±)", command: "sudo systemctl reboot" },
      { note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ", command: "sudo shutdown -r now" },
      { note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±", command: "sudo shutdown -r +1" },
    ];
  }

  // windows: list users
  if (cliL.includes("cmd") && (c.startsWith("net user") || c === "net user")) {
    return [
      { note: "Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø¨Ø§ Ø´Ù…Ø§Ø±Ø´ Ø®Ø·ÙˆØ·)", command: 'net user | find /c /v ""' },
      { note: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ WMIC (Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ Ù‚Ø¯ÛŒÙ…ÛŒ/ØºÛŒØ±ÙØ¹Ø§Ù„)", command: "wmic useraccount get name" },
      { note: "PowerShell (Ø§Ú¯Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª)", command: 'powershell -NoProfile -Command "Get-LocalUser | Select -Expand Name"' },
    ];
  }

  // generic helpful alternatives
  const base = command.split(/\s+/)[0] || "command";
  return [
    { note: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹", command: `${base} --help` },
    { note: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ (Ø§Ú¯Ø± Ù†ØµØ¨ Ø§Ø³Øª)", command: `man ${base}` },
    { note: "Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ (Ø§Ú¯Ø± Ù†ØµØ¨ Ø§Ø³Øª)", command: `tldr ${base}` },
  ];
}

function ensureExactly3Alternatives(alts, fallbackCmd, cli) {
  const clean = (Array.isArray(alts) ? alts : [])
    .filter(x => x && typeof x.command === "string" && x.command.trim())
    .map(x => ({ note: String(x.note || "").trim(), command: String(x.command).trim() }));

  if (clean.length >= 3) return clean.slice(0, 3);
  const fill = defaultAlternativesFor(fallbackCmd, cli);
  const out = [...clean];
  for (const a of fill) {
    if (out.length >= 3) break;
    if (!out.some(x => x.command === a.command)) out.push(a);
  }
  while (out.length < 3) out.push({ note: "Ú¯Ø²ÛŒÙ†Ù‡ Ø¯ÛŒÚ¯Ø±", command: fallbackCmd });
  return out.slice(0, 3);
}

function toFixedMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const cmd = tool?.primary?.command || "";
  const expl = tool?.explanation || "";
  const warns = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warns.length ? warns.map(w => `- ${w}`).join("\n") : "- Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ù…Ø­ØªØ§Ø· Ø¨Ø§Ø´ÛŒØ¯.";
  const altBlocks = alts.slice(0,3).map((a, i) => {
    const note = a.note ? `**${i+1}) ${a.note}**` : `**${i+1}) Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†**`;
    return `${note}\n\`\`\`${lang}\n${a.command}\n\`\`\``;
  }).join("\n\n");

  return `\`\`\`${lang}\n${cmd}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${expl}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks}`.trim();
}

export function formatToolResponse({ text, cli = "bash", outputType = "markdown", lang = "fa", userRequest = "" }) {
  const raw = String(text || "").trim();
  const fenceLang = fenceLangFromCli(cli, outputType);

  // primary command
  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  let primary = normalizeCodeToCommands(codeRaw);
  if (!primary) primary = guessPrimaryCommandFromText(raw);
  if (!primary) primary = ""; // still allowed, but we'll fill warnings/alts safely

  // explanation
  let explanation =
    extractSection(rest, ["ØªÙˆØ¶ÛŒØ­", "Ø´Ø±Ø­", "Explanation", "Ø´Ø±Ø­ Ú©Ø§Ø±"]) ||
    String(rest || "").trim();

  explanation = explanation.replace(/\n{3,}/g, "\n\n").trim();
  if (!explanation) {
    if (primary) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø±Ù Ø®ÙˆØ§Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§/Ù…Ø­ÛŒØ· Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
    else explanation = "Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ù‚Ø·Ø¹ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯Ø› Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯ (OS/CLI/Ù‡Ø¯Ù Ø¯Ù‚ÛŒÙ‚).";
  }
  // keep explanation short-ish
  if (explanation.length > 420) explanation = explanation.slice(0, 420).trim() + "â€¦";

  // warnings
  const warnText = extractSection(rest, ["Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Ù‡Ø´Ø¯Ø§Ø±", "Warnings", "Warning"]);
  let warnings = bulletsFromText(warnText);
  if (!warnings.length) warnings = defaultWarningsFor(primary || userRequest, cli);

  // alternatives
  // try to parse alternatives section very lightly (if any fenced blocks exist there)
  const altText = extractSection(rest, ["Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†", "Alternatives", "Alternative"]);
  let alternatives = [];
  if (altText) {
    const blocks = [...altText.matchAll(/```[^\n]*\n([\s\S]*?)```/g)].map(m => String(m[1]||"").trim()).filter(Boolean);
    for (const b of blocks) {
      const cmd = normalizeCodeToCommands(b) || guessPrimaryCommandFromText(b);
      if (cmd) alternatives.push({ note: "", command: cmd });
    }
  }
  alternatives = ensureExactly3Alternatives(alternatives, primary || guessPrimaryCommandFromText(raw) || "", cli);

  // outputType command/script => only primary command as copy-ready fence
  if (String(outputType || "").toLowerCase() === "command" || String(outputType || "").toLowerCase() === "script") {
    const only = primary ? `\`\`\`${fenceLang}\n${primary}\n\`\`\`` : "";
    return {
      tool: {
        primary: { lang: fenceLang, command: primary },
        explanation,
        warnings,
        alternatives,
      },
      markdown: only,
    };
  }

  const tool = {
    primary: { lang: fenceLang, command: primary },
    explanation,
    warnings,
    alternatives,
  };

  return { tool, markdown: toFixedMarkdown(tool) };
}

// alias for older code
export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_object_object_ui/20260103_100241/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_object_object_ui/20260103_100241/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo } from "react";
import MarkdownBox from "./MarkdownBox";

function CodeBlock({ lang, value }) {
  const md = useMemo(() => `\`\`\`${lang}\n${value}\n\`\`\``, [lang, value]);
  return <MarkdownBox markdown={md} lang="fa" />;
}

export default function ToolResult({ tool, langUi = "fa" }) {
  if (!tool) return null;

  const primary = tool?.primary?.command || "";
  const fenceLang = tool?.primary?.lang || "bash";
  const explanation = tool?.explanation || "";
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  return (
    <div className="ccg-section-grid">
      <div className="ccg-section-card">
        <div className="ccg-section-title">{langUi === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result"}</div>
        <CodeBlock lang={fenceLang} value={primary} />
      </div>

      <div className="ccg-section-card">
        <div className="ccg-section-title">{langUi === "fa" ? "ØªÙˆØ¶ÛŒØ­" : "Explanation"}</div>
        <div className={`ccg-markdown ${langUi === "fa" ? "rtl" : "ltr"}`}>
          <div className="text-sm leading-7">{explanation}</div>
        </div>
      </div>

      <div className="ccg-section-card ccg-warn">
        <div className="ccg-section-title">{langUi === "fa" ? "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "Warnings"}</div>
        <div className={`ccg-markdown ${langUi === "fa" ? "rtl" : "ltr"}`}>
          <ul className="text-sm leading-7">
            {(warnings.length ? warnings : [langUi === "fa" ? "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯." : "Review before running."]).map((w, i) => (
              <li key={i}>{w}</li>
            ))}
          </ul>
        </div>
      </div>

      <div className="ccg-section-card">
        <div className="ccg-section-title">{langUi === "fa" ? "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" : "Alternatives"}</div>

        <div className="grid gap-3">
          {(alts.slice(0, 3).length ? alts.slice(0, 3) : [{ command: primary, note: "Alternative" }]).map((a, i) => (
            <div key={i} className="ccg-alt-card">
              <div className={`ccg-markdown ${langUi === "fa" ? "rtl" : "ltr"}`}>
                <div className="text-xs opacity-80 mb-2">{a?.note || (langUi === "fa" ? "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" : "Alternative")}</div>
              </div>
              <CodeBlock lang={fenceLang} value={a?.command || ""} />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/generator_toolstyle_fix/20260102_113354/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-first formatter for CCG.
// Ù‡Ø¯Ù: Ø®Ø±ÙˆØ¬ÛŒ Generator Ù…Ø«Ù„ Ø§Ø¨Ø²Ø§Ø± DevOps Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø´ÙˆØ¯ (command/script/markdown) Ùˆ Ú†Øªâ€ŒÚ¯ÙˆÙ†Ù‡ Ù†Ø´ÙˆØ¯.

function pickFenceLang({ cli = "bash", outputType = "command" } = {}) {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function extractFirstCodeBlock(text) {
  const t = String(text ?? "");
  const m = t.match(/```(?:[\w-]+)?\s*\n([\s\S]*?)```/);
  return m ? String(m[1] ?? "").trim() : "";
}

function stripCodeFences(text) {
  const t = String(text ?? "");
  return t.replace(/```[\s\S]*?```/g, "").trim();
}

// Very conservative command guess: first non-empty line that looks like a shell command.
function guessCommandLine(text) {
  const t = String(text ?? "");
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);
  for (const l of lines) {
    // skip obvious prose headings
    if (/^(##+|\-|\*|>|\[context|\(|\{)/i.test(l)) continue;
    if (/^(ØªÙˆØ¶ÛŒØ­|Ù‡Ø´Ø¯Ø§Ø±|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†|Ù†ØªÛŒØ¬Ù‡|Ø®Ø±ÙˆØ¬ÛŒ|Ø´Ø±Ø­|example|explanation|warning|alternatives)\b/i.test(l)) continue;

    // looks like command-ish
    if (/^(sudo|systemctl|service|journalctl|cat|ls|cd|pwd|grep|awk|sed|tail|head|curl|wget|ping|ip|ss|netstat|lsof|ps|top|htop|df|du|free|chmod|chown|rm|mv|cp|mkdir|docker|kubectl|git|npm|pnpm|yarn|python|pip|node)\b/.test(l)) {
      return l;
    }
  }
  return "";
}

// Existing behavior: if outputType=command/script => return ONLY fenced code.
export function formatOutput({ outputType, text, preferredLang = "bash" }) {
  const t = String(text ?? "").trim();
  const ot = String(outputType ?? "").toLowerCase();
  if (!["script", "command", "python"].includes(ot)) return t;

  const code = extractFirstCodeBlock(t) || guessCommandLine(t) || t;
  const lang = (ot === "python") ? "python" : preferredLang;
  return `\`\`\`${lang}\n${String(code).trim()}\n\`\`\``;
}

// Tool-first response normalizer for Generator:
export function formatToolResponse({
  lang = "fa",
  modeStyle = "learn",        // learn | operational
  outputType = "command",     // command | python | markdown
  cli = "bash",
  text = ""
} = {}) {
  const isFa = String(lang).toLowerCase().startsWith("fa");
  const fenceLang = pickFenceLang({ cli, outputType });

  const raw = String(text ?? "").trim();
  const code = extractFirstCodeBlock(raw) || guessCommandLine(raw);

  // operational: MINIMAL (only code fence)
  if (String(modeStyle).toLowerCase() === "operational") {
    const only = code || raw;
    return `\`\`\`${fenceLang}\n${String(only).trim()}\n\`\`\``;
  }

  // learn/tool: enforce sections (Command / Explanation / Warnings / Alternatives)
  const body = stripCodeFences(raw);

  // If model already returned structured sections, keep it but ensure there is at least one code fence at top.
  const hasSections =
    /(^|\n)#{2,3}\s*(command|ÙØ±Ù…Ø§Ù†|Ø®Ø±ÙˆØ¬ÛŒ)\b/i.test(raw) ||
    /(^|\n)#{2,3}\s*(explanation|ØªÙˆØ¶ÛŒØ­)\b/i.test(raw);

  if (hasSections) {
    // just ensure a code fence exists somewhere; if not, add based on extracted code.
    if (/```[\s\S]*?```/.test(raw)) return raw;
    if (code) {
      const head = isFa ? "## ÙØ±Ù…Ø§Ù†" : "## Command";
      return `${head}\n\n\`\`\`${fenceLang}\n${code}\n\`\`\`\n\n${body}`;
    }
    return raw;
  }

  const H_CMD = isFa ? "## ÙØ±Ù…Ø§Ù†" : "## Command";
  const H_EXP = isFa ? "## ØªÙˆØ¶ÛŒØ­" : "## Explanation";
  const H_WRN = isFa ? "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "## Warnings";
  const H_ALT = isFa ? "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" : "## Alternatives";

  const exp = body || (isFa ? "â€”" : "â€”");

  // NOTE: we keep warnings/alternatives minimal if the model didn't provide them.
  const warnings = isFa
    ? "- Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±/Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ø³Øª Ù‡Ø³Øª Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ùˆ Ø¯Ø§Ø±ÛŒ.\n- Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ± destructive Ø¨ÙˆØ¯ (Ù…Ø«Ù„ rm/format)ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú†Ú© Ú©Ù†."
    : "- Before running, make sure you're on the correct host and have the right permissions.\n- If the command is destructive (rm/format), double-check.";

  const alts = isFa
    ? "- Ø§Ú¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ´ Ø¬ÙˆØ§Ø¨ Ù†Ø¯Ø§Ø¯ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø®Ø·Ø§/Ù„Ø§Ú¯ Ø±Ùˆ Ø¨ÙØ±Ø³Øª ØªØ§ Ù‚Ø¯Ù…â€ŒØ¨Ù‡â€ŒÙ‚Ø¯Ù… Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒÙ…."
    : "- If this doesn't work, share the error/log output and we can iterate step-by-step.";

  const cmdBlock = code
    ? `\`\`\`${fenceLang}\n${code}\n\`\`\``
    : (raw ? `\`\`\`${fenceLang}\n${raw}\n\`\`\`` : `\`\`\`${fenceLang}\n# (no command detected)\n\`\`\``);

  return [
    H_CMD, "", cmdBlock, "",
    H_EXP, "", exp, "",
    H_WRN, "", warnings, "",
    H_ALT, "", alts
  ].join("\n");
}

================================================================================
FILE: .ccg_backups/generator_toolstyle_fix/20260102_125743/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Ù‡Ø¯Ù:
// - Generator: Ø§Ø¨Ø²Ø§Ø±-Ù…Ø­ÙˆØ± (command/script + ØªÙˆØ¶ÛŒØ­ + Ù‡Ø´Ø¯Ø§Ø± + Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†)
// - Chat: Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒØŒ Ø§Ù…Ø§ Ø§Ú¯Ø± outputType=command/script Ø¨ÙˆØ¯ ÙÙ‚Ø· fenced code Ø¨Ø¯Ù‡ (Ù†Ù‡ Ø¨Ø®Ø´â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ù†Ú¯ÛŒÙ†)
//
// NOTE: parser Ù…ÙˆØ¬ÙˆØ¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (server/utils/formatter.js)
import { formatAIResponse } from "./formatter.js";

function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function mdList(items) {
  const arr = Array.isArray(items) ? items.filter(Boolean) : [];
  if (!arr.length) return "";
  return arr.map((x) => `- ${String(x).trim()}`).join("\n");
}

function stripOuterFence(codeOrText = "") {
  const t = String(codeOrText || "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```/);
  return (m ? m[1] : t).trim();
}

/**
 * formatOutput
 * @param {object} p
 * @param {string} p.text         raw AI text
 * @param {string} p.outputType   command | script | markdown | ...
 * @param {string} p.cli          bash | powershell | ...
 * @param {string} p.lang         fa | en
 * @param {string} p.toolStyle    "generator" | "chat"
 */
export function formatOutput({ text, outputType = "markdown", cli = "bash", lang = "fa", toolStyle = "chat" }) {
  const ot = String(outputType || "markdown").toLowerCase();
  const raw = String(text ?? "").trim();
  if (!raw) return "";

  // parse using existing formatter (extracts code/explanation/warnings/alternatives when possible)
  let parsed;
  try {
    parsed = formatAIResponse({ text: raw, outputType: ot, cli });
  } catch {
    parsed = { code: "", explanation: raw, warnings: [], alternatives: [] };
  }

  const fenceLang = fenceLangFromCli(cli);

  // For command/script: ALWAYS ensure a single top fence
  if (ot === "command" || ot === "script") {
    const code = stripOuterFence(parsed?.code || raw);
    const fence = `\`\`\`${fenceLang}\n${code}\n\`\`\``;

    // Chat should be minimal: just the fence (fast copy)
    if (toolStyle === "chat") return fence;

    // Generator should be tool-style: fence + sections
    const exp = String(parsed?.explanation || "").trim();
    const warn = mdList(parsed?.warnings);
    const alt = mdList(parsed?.alternatives);

    const fa = String(lang || "fa").toLowerCase().startsWith("fa");
    const hExp = fa ? "## ØªÙˆØ¶ÛŒØ­" : "## Explanation";
    const hWarn = fa ? "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "## Warnings";
    const hAlt = fa ? "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" : "## Alternatives";

    let out = fence;
    if (exp) out += `\n\n${hExp}\n${exp}`;
    if (warn) out += `\n\n${hWarn}\n${warn}`;
    if (alt) out += `\n\n${hAlt}\n${alt}`;
    return out.trim();
  }

  // Otherwise (markdown/etc): return as-is
  return raw;
}

================================================================================
FILE: .ccg_backups/generator_toolstyle_v2/20260102_113847/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Generator output should feel like a DevOps tool (not a chat):
// - First: ONE code fence (command/script)
// - Then: Explanation / Warnings / Alternatives (short, structured)
// Also: we inject a strict format hint into user_request so Stored Prompt follows it.

import { formatAIResponse } from "./formatter.js";

function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  if (c.includes("python")) return "python";
  return "bash";
}

function bullets(items = []) {
  const arr = Array.isArray(items) ? items : [];
  return arr.filter(Boolean).map((x) => `- ${String(x).trim()}`).join("\n");
}

export function toolifyUserRequest(userRequest, body = {}) {
  const ur = String(userRequest || "").trim();
  if (!ur) return ur;

  // don't double-inject
  if (ur.includes("CCG_TOOL_FORMAT_V1")) return ur;

  const outputType = String(body.outputType || "").toLowerCase();
  // Only force tool format for generator-like output types
  if (!["command", "script", "markdown"].includes(outputType)) return ur;

  const cli = String(body.cli || "bash");
  const langFence = fenceLangFromCli(cli);

  // IMPORTANT: headings are English so server/utils/formatter.js can parse.
  // Content language can still be fa.
  const hint = `
CCG_TOOL_FORMAT_V1
You are a DevOps/SysAdmin command generator.
NO greetings, NO emojis, NO small talk.
Return STRICT Markdown in EXACT order:

\`\`\`${langFence}
<the command or script (single block)>
\`\`\`

## Explanation
<2-6 short lines, practical>

## Warnings
- <0-5 bullets, write "- none" if no warnings>

## Alternatives
- <0-5 bullets, write "- none" if no alternatives>

Rules:
- Put the real command/script ONLY in the first code block.
- Keep it concise and operational.
`.trim();

  return `${hint}\n\nUser request:\n${ur}`;
}

export function formatGeneratorOutput({ raw, cli = "bash", lang = "fa" } = {}) {
  const text = String(raw || "").trim();
  const parsed = formatAIResponse(text);

  const fenceLang = fenceLangFromCli(cli);
  const code = String(parsed.code || "").trim();

  // Build a stable tool-style markdown regardless of what model returned.
  // If explanation/warnings/alternatives missing, we keep them but show "none".
  const explanation = String(parsed.explanation || "").trim();
  const warnings = (parsed.warnings && parsed.warnings.length) ? parsed.warnings : ["none"];
  const alternatives = (parsed.alternatives && parsed.alternatives.length) ? parsed.alternatives : ["none"];

  // Persian labels (but keep parser headings in raw; here we render UX nicer)
  const mdParts = [];

  if (code) {
    mdParts.push(`\`\`\`${fenceLang}\n${code}\n\`\`\``);
  } else {
    // fallback: return the raw text
    return {
      markdown: text,
      command: "",
      explanation: explanation || "",
      warnings: warnings,
      alternatives: alternatives,
    };
  }

  // Tool-style sections (Persian UX)
  if (explanation) {
    mdParts.push(`### ØªÙˆØ¶ÛŒØ­\n${explanation}`);
  } else {
    mdParts.push(`### ØªÙˆØ¶ÛŒØ­\n(ØªÙˆØ¶ÛŒØ­ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ù†Ø´Ø¯)`);
  }

  mdParts.push(`### Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${bullets(warnings)}`);
  mdParts.push(`### Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${bullets(alternatives)}`);

  return {
    markdown: mdParts.join("\n\n"),
    command: code,
    explanation,
    warnings,
    alternatives,
  };
}

================================================================================
FILE: .ccg_backups/fix_generator_t_block_20260108_072438/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";

// local storage keys
const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom OS)" },
];

const OUTPUT_TYPES = [
  { value: "tool", labelFa: "Tool (Ú©Ø§Ù…Ù„)", labelEn: "Tool (Full)" },
  { value: "command", labelFa: "Command (ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±)", labelEn: "Command (Commands only)" },
  { value: "python", labelFa: "Python", labelEn: "Python" },
];

const VERBOSITY = [
  { value: "brief", labelFa: "Ø®Ù„Ø§ØµÙ‡", labelEn: "Brief" },
  { value: "normal", labelFa: "Ù†Ø±Ù…Ø§Ù„", labelEn: "Normal" },
  { value: "detailed", labelFa: "Ø¬Ø²Ø¦ÛŒ", labelEn: "Detailed" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  windows: ["powershell", "cmd"],
  mac: ["zsh", "bash"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "powershell", "cmd"],
};

const LINUX_DISTROS = ["Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","Alpine","Kali"];
const WINDOWS_FLAVORS = ["Windows 10","Windows 11","Windows Server 2019","Windows Server 2022"];
const MAC_FLAVORS = ["macOS"];

const NETWORK_VENDORS = ["Cisco","MikroTik","FortiGate","Juniper","Aruba","Huawei","Generic"];
const DEVICE_TYPES_BY_VENDOR = {
  Cisco: ["switch","router","firewall"],
  MikroTik: ["router","switch"],
  FortiGate: ["firewall"],
  Juniper: ["switch","router","firewall"],
  Aruba: ["switch","controller"],
  Huawei: ["switch","router","firewall"],
  Generic: ["router","switch","firewall","appliance"],
};

function isSafeFreeText(v, min=2, max=40) {
  const s = String(v||"").trim().replace(/\s+/g," ");
  if (s.length < min || s.length > max) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

function qsToObj() {
  const q = new URLSearchParams(window.location.search);
  return {
    platform: q.get("platform") || "",
    cli: q.get("cli") || "",
    out: q.get("out") || "",
    v: q.get("v") || "",
    adv: q.get("adv") || "",
    swap: q.get("swap") || "",
    lang: q.get("lang") || "",
  };
}
function setQS(p) {
  const q = new URLSearchParams(window.location.search);
  Object.entries(p).forEach(([k,v]) => {
    if (v === "" || v == null) q.delete(k);
    else q.set(k, String(v));
  });
  const url = `${window.location.pathname}?${q.toString()}`;
  window.history.replaceState({}, "", url);
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm opacity-90">{label}</span>
      {tip ? (
        <span className="relative group">
          <button
            type="button"
            className="w-5 h-5 rounded-full border text-xs opacity-70 hover:opacity-100 dark:border-white/10"
            aria-label={`${label} help`}
          >
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-80 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  const { lang, setLang, t } = useLanguage();
  const isRTL = (lang === "fa");

    const en = {
      platform: "Platform",
      outputType: "Output type",
      cli: "Shell / CLI",
      verbosity: "Verbosity",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "Distro / Flavor",
      version: "Version (optional)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Request",
      gen: "Generate",
      explain: "Explain command",
      swap: "Swap",
      errFix: "Fix this first:",
      tip_platform: "Target platform to generate commands for.",
      tip_output: "Tool: full output. Command: command + warnings + alternatives (no explanation). Python: python code only.",
      tip_cli: "Target shell/CLI (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Brief: short. Normal: standard. Detailed: full explanation + examples.",
      tip_advanced: "Advanced fields for the selected platform only.",
      tip_custom: "Use for custom OS/Shell. Invalid values will be blocked before sending.",
      placeholder: "Write a clear request (goal + constraints). Example: â€œRestart my systemâ€",
    };
    return isRTL ? fa : en;
  }, [isRTL]);

  // Defaults
  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");
  const [advanced, setAdvanced] = useState(false);
  const [swap, setSwap] = useState(false);

  // advanced per-platform
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [windowsFlavor, setWindowsFlavor] = useState("Windows 11");
  const [macFlavor, setMacFlavor] = useState("macOS");
  const [osVersion, setOsVersion] = useState("");

  // network
  const [vendor, setVendor] = useState("Cisco");
  const [deviceType, setDeviceType] = useState("router");

  // custom
  const [customOn, setCustomOn] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [output, setOutput] = useState("");
  const [tool, setTool] = useState(null);

  // Load persisted state
  useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      const q = qsToObj();

      const p = q.platform || saved.platform || "linux";
      const c = q.cli || saved.cli || (SHELL_BY_PLATFORM[p]?.[0] || "bash");
      const out = q.out || saved.outputType || "tool";
      const v = q.v || saved.verbosity || "normal";
      const adv = (q.adv ? q.adv === "1" : !!saved.advanced);
      const sw = (q.swap ? q.swap === "1" : !!saved.swap);

      if (q.lang) setLang(q.lang);

      setPlatform(p);
      setCli(c);
      setOutputType(out);
      setVerbosity(v);
      setAdvanced(adv);
      setSwap(sw);

      setLinuxDistro(saved.linuxDistro || "Ubuntu");
      setWindowsFlavor(saved.windowsFlavor || "Windows 11");
      setMacFlavor(saved.macFlavor || "macOS");
      setOsVersion(saved.osVersion || "");

      setVendor(saved.vendor || "Cisco");
      setDeviceType(saved.deviceType || "router");

      setCustomOn(!!saved.customOn);
      setCustomOS(saved.customOS || "");
      setCustomShell(saved.customShell || "");

      setInput(saved.input || "");
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Keep cli valid per platform
  useEffect(() => {
    const allowed = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!allowed.includes(cli)) setCli(allowed[0]);
    // If leaving network, reset vendor/deviceType
    if (platform !== "network") {
      setVendor("Cisco");
      setDeviceType("router");
    }
    // Custom only relevant on "other"
    if (platform !== "other") setCustomOn(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [platform]);

  // persist state + URL
  useEffect(() => {
    const st = {
      platform, cli, outputType, verbosity, advanced, swap,
      linuxDistro, windowsFlavor, macFlavor, osVersion,
      vendor, deviceType,
      customOn, customOS, customShell,
      input
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
    setQS({
      platform,
      cli,
      out: outputType,
      v: verbosity,
      adv: advanced ? "1" : "",
      swap: swap ? "1" : "",
      lang,
    });
  }, [platform, cli, outputType, verbosity, advanced, swap, linuxDistro, windowsFlavor, macFlavor, osVersion, vendor, deviceType, customOn, customOS, customShell, input, lang]);

  function validateBeforeSend() {
    const errs = [];

    if (!input.trim()) errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª." : "Request is empty.");

    // outputType strict
    if (!["tool","command","python"].includes(outputType)) errs.push("Invalid output type.");

    // platform strict
    if (!["linux","windows","mac","network","other"].includes(platform)) errs.push("Invalid platform.");

    // Custom validation (block before API)
    if (platform === "other" && customOn) {
      if (!isSafeFreeText(customOS, 2, 40)) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom OS.");
      if (!isSafeFreeText(customShell, 2, 20)) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom Shell/CLI.");
    }

    // Advanced validation: only for selected platform
    if (advanced && platform === "linux") {
      if (linuxDistro && !LINUX_DISTROS.includes(linuxDistro)) errs.push(isRTL ? "Distro Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid distro.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }
    if (advanced && platform === "windows") {
      if (windowsFlavor && !WINDOWS_FLAVORS.includes(windowsFlavor)) errs.push(isRTL ? "Windows Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Windows flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version/Build Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version/build (optional).");
    }
    if (advanced && platform === "mac") {
      if (macFlavor && !MAC_FLAVORS.includes(macFlavor)) errs.push(isRTL ? "macOS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid macOS flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    // Network validation always available in normal mode (not hidden)
    if (platform === "network") {
      if (!NETWORK_VENDORS.includes(vendor)) errs.push(isRTL ? "Vendor Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid vendor.");
      const dt = DEVICE_TYPES_BY_VENDOR[vendor] || [];
      if (!dt.includes(deviceType)) errs.push(isRTL ? "Device type Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid device type.");
    }

    return errs;
  }

  function computeOS() {
    // version optional, but don't force users to fill it
    if (platform === "linux") return advanced ? (osVersion ? `${linuxDistro} ${osVersion}` : linuxDistro) : "linux";
    if (platform === "windows") return advanced ? (osVersion ? `${windowsFlavor} ${osVersion}` : windowsFlavor) : "windows";
    if (platform === "mac") return advanced ? (osVersion ? `${macFlavor} ${osVersion}` : macFlavor) : "mac";
    if (platform === "network") return "network";
    if (platform === "other") return customOn ? customOS.trim() : "other";
    return platform;
  }

  function payloadFor(mode="generate", targetCommand="") {
    const base = {
      mode,
      lang,
      user_request: input.trim(),
      outputType,
      verbosity,
    };

    // custom ON => send ONLY custom fields (no extra)
    if (platform === "other" && customOn) {
      return {
        ...base,
        platform: "other",
        os: customOS.trim(),
        cli: customShell.trim(),
        vendor: "",
        deviceType: "general",
        ...(mode === "explain" ? { targetCommand } : {}),
      };
    }

    // normal platforms
    const pl = platform;
    const os = computeOS();
    const c = cli;

    return {
      ...base,
      platform: pl,
      os,
      cli: c,
      vendor: pl === "network" ? vendor : "",
      deviceType: pl === "network" ? deviceType : "general",
      ...(mode === "explain" ? { targetCommand } : {}),
    };
  }

  async function runGenerate() {
    const errs = validateBeforeSend();
    if (errs.length) { setErr(`${t.errFix} ${errs[0]}`); return; }

    setErr("");
    setLoading(true);
    setOutput("");
    setTool(null);

    try {
      const res = await callCCG(payloadFor("generate"));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  async function runExplain() {
    // explain should use last produced tool.primary.command if possible
    const cmd = tool?.primary?.command ? String(tool.primary.command) : "";
    if (!cmd.trim()) { setErr(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø¯Ø³ØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯." : "Generate a command first."); return; }

    setErr("");
    setLoading(true);
    try {
      const res = await callCCG(payloadFor("explain", cmd.trim()));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  const cliOptions = SHELL_BY_PLATFORM[platform] || ["bash"];

  const leftPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-2" : "order-1") : (isRTL ? "order-1" : "order-2"))}`;
  const rightPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-1" : "order-2") : (isRTL ? "order-2" : "order-1"))}`;

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4 justify-between">

            <div className="flex flex-wrap items-center gap-3 sm:gap-4">
              <FieldLabel label={t.platform} tip={t.tip_platform} />
              <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
                {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>

              <FieldLabel label={t.cli} tip={t.tip_cli} />
              <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm">
                {cliOptions.map(v => <option key={v} value={v}>{v}</option>)}
              </select>

              <FieldLabel label={t.outputType} tip={t.tip_output} />
              <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
                {OUTPUT_TYPES.map(o => (
                  <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>
                ))}
              </select>

              <FieldLabel label={t.verbosity} tip={t.tip_verbosity} />
              <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
                {VERBOSITY.map(o => <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>)}
              </select>

              <div className="flex items-center gap-2">
                <input id="ccg-adv" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
                <label htmlFor="ccg-adv" className="text-sm opacity-90">{t.advanced}</label>
              </div>

              <button type="button" className="ccg-btn text-sm" onClick={()=>setSwap(s=>!s)}>
                {t.swap}
              </button>
            </div>

            <div className="flex items-center gap-2">
              <button type="button" className="ccg-btn text-sm" onClick={()=>setLang(isRTL ? "en" : "fa")}>
                {isRTL ? "EN" : "FA"}
              </button>
            </div>

          </div>

          {/* Advanced row (platform-specific only) */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] p-4">
              <div className="flex flex-wrap items-center gap-4 justify-between">
                <div className="text-sm opacity-80">{t.tip_advanced}</div>

                {platform === "other" ? (
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customOn} onChange={(e)=>setCustomOn(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">{t.custom}</label>
                  </div>
                ) : null}
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                {platform === "linux" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select w-full">
                        {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                    </div>
                  </>
                ) : null}

                {platform === "windows" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={windowsFlavor} onChange={(e)=>setWindowsFlavor(e.target.value)} className="ccg-select w-full">
                        {WINDOWS_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "mac" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={macFlavor} onChange={(e)=>setMacFlavor(e.target.value)} className="ccg-select w-full">
                        {MAC_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "network" ? (
                  <>
                    <div>
                      <FieldLabel label={t.vendor} />
                      <select value={vendor} onChange={(e)=>{ setVendor(e.target.value); setDeviceType((DEVICE_TYPES_BY_VENDOR[e.target.value]||["router"])[0]); }} className="ccg-select w-full">
                        {NETWORK_VENDORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.deviceType} />
                      <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select w-full">
                        {(DEVICE_TYPES_BY_VENDOR[vendor] || []).map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                  </>
                ) : null}

                {platform === "other" && customOn ? (
                  <>
                    <div>
                      <FieldLabel label="Custom OS" tip={t.tip_custom} />
                      <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                    </div>
                    <div>
                      <FieldLabel label="Custom Shell/CLI" tip={t.tip_custom} />
                      <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ tcsh" : "e.g. tcsh"} />
                    </div>
                  </>
                ) : null}
              </div>
            </div>
          ) : null}

        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          {/* Request */}
          <div className={rightPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{t.request}</h2>
            <textarea
              className="ccg-textarea w-full min-h-[200px]"
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              placeholder={t.placeholder}
            />
            {err ? (
              <div className="ccg-error mt-3">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{err}</div>
              </div>
            ) : null}

            <div className="mt-4 flex items-center gap-3 justify-end">
              <button className="ccg-btn" type="button" disabled={loading} onClick={runExplain}>
                {t.explain}
              </button>
              <button className="ccg-btn primary" type="button" disabled={loading} onClick={runGenerate}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§..." : "Running...") : t.gen}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={leftPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>
            {outputType === "tool" && tool ? (
              <ToolResult tool={tool} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/ui_contract_stabilize/20260103_103042/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/ui_contract_stabilize/20260103_103042/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo } from "react";

function CopyBtn({ text }) {
  return (
    <button
      type="button"
      className="ccg-btn text-xs"
      onClick={() => navigator.clipboard?.writeText(String(text || ""))}
      title="Copy"
    >
      Ú©Ù¾ÛŒ
    </button>
  );
}

function CodeBlock({ lang = "bash", code = "" }) {
  const safe = String(code || "").trim();
  return (
    <div className="ccg-codeblock">
      <div className="ccg-codeblock-head">
        <div className="ccg-codeblock-title">{lang}</div>
        <CopyBtn text={safe} />
      </div>
      <pre className="ccg-pre">
        <code>{safe}</code>
      </pre>
    </div>
  );
}

export default function ToolResult({ tool }) {
  const t = tool || {};
  const primary = t.primary || {};
  const warnings = Array.isArray(t.warnings) ? t.warnings : [];
  const alternatives = Array.isArray(t.alternatives) ? t.alternatives : [];

  const alt3 = useMemo(() => {
    // Ù‡Ù…ÛŒØ´Ù‡ 3 ØªØ§
    const a = alternatives.slice(0, 3);
    while (a.length < 3) a.push({ command: "", note: "" });
    return a;
  }, [alternatives]);

  return (
    <div className="ccg-section-grid">
      <div className="ccg-section-card">
        <div className="ccg-section-title">Ø®Ø±ÙˆØ¬ÛŒ</div>
        <CodeBlock lang={primary.lang || "bash"} code={primary.command || ""} />
      </div>

      <div className="ccg-section-card">
        <div className="ccg-section-title">ØªÙˆØ¶ÛŒØ­</div>
        <div className="ccg-section-body whitespace-pre-wrap text-sm">
          {String(t.explanation || "").trim() || "â€”"}
        </div>
      </div>

      <div className="ccg-section-card ccg-warn">
        <div className="ccg-section-title">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
        <div className="ccg-section-body text-sm">
          {warnings.length ? (
            <ul className="list-disc ps-5 space-y-1">
              {warnings.map((w, i) => (
                <li key={i}>{String(w)}</li>
              ))}
            </ul>
          ) : (
            <div>Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ø§Ø«Ø±Ø§Øª Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†.</div>
          )}
        </div>
      </div>

      <div className="ccg-section-card">
        <div className="ccg-section-title">Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§</div>
        <div className="space-y-4">
          {alt3.map((a, i) => (
            <div key={i}>
              <div className="text-sm mb-2">{String(a?.note || "").trim() || "â€”"}</div>
              <CodeBlock lang={primary.lang || "bash"} code={a?.command || ""} />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_formatted_var/20260103_071421/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool-Style Output (Generator)
// Goal: Always return a stable tool-like template (not chatty)
// Template (markdown/tool):
// 1) Primary command as ONE fenced block (ONLY command lines)
// 2) ## ØªÙˆØ¶ÛŒØ­
// 3) ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
// 4) ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (3 alternatives, each: short note + its own fenced block)
//
// Backward-compatible exports:
// - formatToolResponse
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return {
    codeRaw: String(m[1] ?? "").trim(),
    rest: t.replace(m[0], "").trim(),
  };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  // reject Persian/Arabic prose inside code fences
  if (/[\u0600-\u06FF]/.test(s)) return false;
  // too long prose line
  if (s.length > 220) return false;
  // ends with punctuation -> likely prose
  if (/[.!?ØŒØ›:]$/.test(s)) return false;

  // allow typical shells/tools & sudo
  return /^(sudo\s+)?([a-zA-Z0-9._/-]+)(\s+|$)/.test(s);
}

function normalizePrimaryCommand(codeRaw, fullText) {
  // 1) from first code block if exists
  const lines = String(codeRaw || "").split("\n").map(l => l.trim());
  const cmdLines = [];
  for (const l of lines) {
    if (!l) continue;
    if (!looksLikeCommand(l)) continue;
    cmdLines.push(l);
  }
  if (cmdLines.length) return cmdLines[0];

  // 2) fallback: scan entire text line-by-line for first command-like line
  const all = String(fullText || "").replace(/\r\n/g, "\n").split("\n");
  for (const raw of all) {
    const l = String(raw || "").trim();
    if (looksLikeCommand(l)) return l;
  }
  return "";
}

function pickSection(md, titles) {
  const t = String(md || "").replace(/\r\n/g, "\n");
  // split by headings
  const lines = t.split("\n");
  const sections = [];
  let curTitle = null;
  let curBody = [];
  const push = () => {
    const body = curBody.join("\n").trim();
    if (curTitle || body) sections.push({ title: curTitle, body });
  };
  for (const line of lines) {
    const m = line.match(/^(#{2,6})\s+(.+)\s*$/);
    if (m) {
      push();
      curTitle = m[2].trim();
      curBody = [];
      continue;
    }
    curBody.push(line);
  }
  push();

  // find title match
  const lowTitles = titles.map(x => String(x).toLowerCase());
  const found = sections.find(s => lowTitles.includes(String(s.title || "").toLowerCase()));
  return found ? String(found.body || "").trim() : "";
}

function extractBullets(text) {
  const out = [];
  const lines = String(text || "").replace(/\r\n/g, "\n").split("\n");
  for (const l of lines) {
    const m = l.match(/^\s*[-*]\s+(.*)$/);
    if (m) out.push(m[1].trim());
  }
  // if no bullets, use non-empty lines
  if (!out.length) {
    for (const l of lines) {
      const s = l.trim();
      if (s) out.push(s);
    }
  }
  return out.filter(Boolean);
}

function uniq(arr) {
  const seen = new Set();
  const out = [];
  for (const x of arr) {
    const k = String(x || "").trim();
    if (!k) continue;
    if (seen.has(k)) continue;
    seen.add(k);
    out.push(k);
  }
  return out;
}

function defaultsForCommand(cmd, lang = "fa") {
  const c = String(cmd || "").toLowerCase();

  const warnings = [];
  const alts = [];

  // generic
  if (c.startsWith("sudo ")) warnings.push(lang === "fa" ? "Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ sudo/Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø§Ø±Ø¯." : "Requires sudo/admin privileges.");

  // reboot/shutdown
  if (/\b(reboot|shutdown)\b/.test(c)) {
    warnings.unshift(
      lang === "fa" ? "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø±ÛŒØ¯." : "If you're on SSH, connection will dropâ€”ensure you can regain access.",
      lang === "fa" ? "Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±ØªØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯." : "Save unsaved work before restarting."
    );
    alts.push(
      { command: "sudo systemctl reboot", note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ systemd" : "Reboot via systemd" },
      { command: "sudo shutdown -r now", note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" : "Immediate restart" },
      { command: "sudo shutdown -r +1", note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" : "Restart in 1 minute" }
    );
  }

  // ufw/firewall
  if (/\bufw\b/.test(c) || /\biptables\b/.test(c)) {
    warnings.unshift(
      lang === "fa" ? "ØªØºÛŒÛŒØ± ÙØ§ÛŒØ±ÙˆØ§Ù„ Ù…Ù…Ú©Ù† Ø§Ø³Øª SSH Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†Ø¯Ø› Ù‚Ø¨Ù„Ø´ rule Ù„Ø§Ø²Ù… Ø±Ø§ allow Ú©Ù†ÛŒØ¯." : "Firewall changes may lock you out; allow SSH before applying."
    );
  }

  // rm -rf
  if (/\brm\b/.test(c) && /-rf/.test(c)) {
    warnings.unshift(
      lang === "fa" ? "rm -rf Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÛŒØ± Ø§Ø³ØªØ› Ù…Ø³ÛŒØ± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú†Ú© Ú©Ù†ÛŒØ¯." : "rm -rf is irreversible; double-check the path."
    );
  }

  return { warnings: uniq(warnings), alternatives: alts };
}

function parseAlternativesFromMarkdown(md) {
  // Extract code blocks inside alternatives section if present
  const altBody = pickSection(md, ["Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "alternatives"]);
  if (!altBody) return [];

  const blocks = [];
  const re = /```[^\n]*\n([\s\S]*?)```/g;
  let m;
  while ((m = re.exec(altBody))) {
    const raw = String(m[1] || "").trim();
    const lines = raw.split("\n").map(x => x.trim()).filter(Boolean);
    // keep only first command-like line as an alternative command
    const cmd = lines.find(looksLikeCommand) || "";
    if (cmd) blocks.push({ command: cmd, note: "" });
  }

  // If no fenced blocks, try line-based commands
  if (!blocks.length) {
    const lines = altBody.split("\n").map(x => x.trim()).filter(Boolean);
    for (const l of lines) {
      if (looksLikeCommand(l)) blocks.push({ command: l, note: "" });
    }
  }

  // cap 3
  const uniqCmd = [];
  const seen = new Set();
  for (const a of blocks) {
    const k = String(a.command || "").trim();
    if (!k || seen.has(k)) continue;
    seen.add(k);
    uniqCmd.push({ command: k, note: a.note || "" });
    if (uniqCmd.length >= 3) break;
  }
  return uniqCmd;
}

function buildStableMarkdown({ primary, explanation, warnings, alternatives, cli }) {
  const langFence = fenceLangFromCli(cli, "command");
  const warnLines = (warnings && warnings.length) ? warnings : ["-"];
  const alts = (alternatives && alternatives.length) ? alternatives : [];

  const warnMd = warnLines.map(w => `- ${String(w).trim()}`).join("\n");

  const altMd = alts.map((a, i) => {
    const note = String(a.note || "").trim();
    const noteLine = note ? `${i + 1}) ${note}\n` : `${i + 1})\n`;
    return (
      `${noteLine}` +
      `\`\`\`${langFence}\n${String(a.command || "").trim()}\n\`\`\``
    );
  }).join("\n\n");

  return [
    `\`\`\`${langFence}\n${String(primary || "").trim()}\n\`\`\``,
    ``,
    `## ØªÙˆØ¶ÛŒØ­`,
    `${String(explanation || "").trim() || "â€”"}`,
    ``,
    `## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§`,
    warnMd || "-",
    ``,
    `## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§`,
    altMd || "â€”",
  ].join("\n");
}

export function formatToolResponse({ outputType = "markdown", text = "", cli = "bash", lang = "fa" } = {}) {
  const ot = String(outputType || "").toLowerCase();
  const raw = String(text || "").trim();

  // For command/script: just ensure a clean single command fence
  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  const primary = normalizePrimaryCommand(codeRaw, raw);

  // If outputType is strictly "command", return only command fence
  if (ot === "command" || ot === "script") {
    const langFence = fenceLangFromCli(cli, ot);
    return `\`\`\`${langFence}\n${primary || ""}\n\`\`\``.trim();
  }

  // Explanation: prefer "ØªÙˆØ¶ÛŒØ­" section, else use rest
  const explanationFromSec = pickSection(raw, ["ØªÙˆØ¶ÛŒØ­", "explanation"]);
  const explanation = (explanationFromSec || rest || "").trim();

  // Warnings: prefer "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" section, else defaults
  const warnSec = pickSection(raw, ["Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "warnings"]);
  let warnings = warnSec ? extractBullets(warnSec) : [];
  let alternatives = parseAlternativesFromMarkdown(raw);

  // Add defaults if missing/short
  const d = defaultsForCommand(primary, lang);
  if (!warnings.length) warnings = d.warnings;
  if (!alternatives.length) alternatives = d.alternatives;

  // Ensure 3 alternatives max and not equal to primary
  alternatives = alternatives
    .filter(a => String(a.command || "").trim() && String(a.command || "").trim() !== String(primary || "").trim())
    .slice(0, 3);

  // If still < 3, pad with safe empties? better keep as-is
  const md = buildStableMarkdown({ primary, explanation, warnings, alternatives, cli });
  return md;
}

// Alias
export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/lock_generate_json_contract/20260106_090951/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/lock_generate_json_contract/20260106_090951/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Stable Tool Contract Normalizer for GENERATOR
//
// Contract (tool):
// {
//   primary: { command: string, lang: string },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command: string, note: string }, ...] // exactly 3
// }
//
// Markdown order (always):
// 1) Primary command (ONE fenced block)
// 2) ## ØªÙˆØ¶ÛŒØ­
// 3) ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§  (rendered in UI as red card if supported)
// 4) ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (3 items, each: note + its own fenced block)
//
// Notes:
// - This file should NOT invent Linux alternatives for Windows (OS-aware).
// - If request is ambiguous: return a short ask-for-details + suggest chat mode.

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  // network-cli or unknown -> keep bash-like fence (UI will still copy)
  if (c.includes("network")) return "text";
  return "bash";
}

function stripFences(s) {
  const t = String(s || "").trim();
  // remove a single surrounding fence if it's pure fenced content
  const m = t.match(/^```[^\n]*\n([\s\S]*?)\n```$/);
  return m ? String(m[1] || "").trim() : t;
}

function tryParseToolJSON(rawText) {
  const t = stripFences(rawText);
  // Find first JSON object in text (robust to leading prose)
  const start = t.indexOf("{");
  const end = t.lastIndexOf("}");
  if (start < 0 || end <= start) return null;
  const candidate = t.slice(start, end + 1);
  try {
    const obj = JSON.parse(candidate);
    // accept either direct contract or {tool:{...}}
    const tool = obj?.tool && typeof obj.tool === "object" ? obj.tool : obj;
    if (tool?.primary?.command && tool?.alternatives) return tool;
    return null;
  } catch {
    return null;
  }
}

function isAmbiguous(userRequest) {
  const u = String(userRequest || "").trim();
  if (!u) return true;
  // too short / generic
  if (u.length < 8) return true;
  // generic words without action/context
  const weak = ["Ú©Ù…Ú©", "help", "Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ù…", "Ù†Ù…ÛŒØ§Ø¯", "Ú©Ø§Ø± Ù†Ù…ÛŒÚ©Ù†Ù‡", "ÛŒÙ‡ Ú†ÛŒØ²ÛŒ Ø¨Ú¯Ùˆ"];
  if (weak.some(w => u.includes(w))) return true;
  return false;
}

function ensure3(arr, fillFn) {
  const a = Array.isArray(arr) ? arr.filter(Boolean) : [];
  while (a.length < 3) a.push(fillFn(a.length));
  return a.slice(0, 3);
}

function osKey(os) {
  const o = String(os || "").toLowerCase();
  if (o.includes("win")) return "windows";
  if (o.includes("mac") || o.includes("darwin")) return "mac";
  if (o.includes("network")) return "network";
  return "linux";
}

function defaultWarnings({ os, cli, outputType }) {
  const o = osKey(os);
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();

  // Python automation warnings (generic)
  if (ot === "python") {
    return [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø³ÛŒØ±Ù‡Ø§/Ø§Ø¹ØªØ¨Ø§Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (credentials) Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
      "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø§Ø¨ØªØ¯Ø§ Dry-run/Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      "Ø®Ø±ÙˆØ¬ÛŒ/Ù„Ø§Ú¯ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ù‚Ø§Ø¨Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¨Ø§Ø´Ø¯.",
    ];
  }

  if (o === "windows") {
    const isPs = c.includes("powershell") || c === "pwsh";
    return [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ± Ù†ÛŒØ§Ø² Ø¨Ù‡ Admin Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ Run as Administrator Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      isPs ? "Ø¯Ø± PowerShellØŒ Policy/ExecutionPolicy Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø±ÙˆÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ Ø§Ø«Ø± Ø¨Ú¯Ø°Ø§Ø±Ø¯." : "Ø¯Ø± CMDØŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø±Ø§ Ø¯Ù‚ÛŒÙ‚ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯.",
    ];
  }

  if (o === "network") {
    return [
      "Ø±ÙˆÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø´Ø¨Ú©Ù‡ØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² Ú©Ø§Ù†ÙÛŒÚ¯ Backup Ø¨Ú¯ÛŒØ±ÛŒØ¯.",
      "Ø¯Ø± ØµÙˆØ±Øª Ø§Ù…Ú©Ø§Ù† ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¯Ø± Maintenance window Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ø¹Ø« Ù‚Ø·Ø¹ Ø§Ø±ØªØ¨Ø§Ø· Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø¯Ø³ØªØ±Ø³ÛŒ Out-of-band Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.",
    ];
  }

  // linux/mac default
  return [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
    "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø´ÙˆØ¯.",
    "Ø¯Ø± Ù…Ø­ÛŒØ· ProductionØŒ Ø§Ø¨ØªØ¯Ø§ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
  ];
}

function pickOSAwareAlternatives({ userRequest, os, cli }) {
  const o = osKey(os);
  const u = String(userRequest || "").toLowerCase();

  // Shutdown / reboot family
  const wantsShutdown = u.includes("Ø®Ø§Ù…ÙˆØ´") || u.includes("shutdown") || u.includes("power off");
  const wantsReboot = u.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || u.includes("restart") || u.includes("reboot");
  const hasDelay = u.includes("Ø¯Ù‚ÛŒÙ‚Ù‡") || u.includes("minute") || u.match(/\b\d+\b/);

  if (o === "windows") {
    // CMD/PowerShell both can use shutdown.exe
    if (wantsShutdown) {
      return [
        { command: "shutdown /s /t 60", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø¨Ø§ ØªØ£Ø®ÛŒØ± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ (Ù†Ù…ÙˆÙ†Ù‡ Ø±Ø§ÛŒØ¬)" },
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù†/Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† ÙÙˆØ±ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÛŒØ±)" },
      ];
    }
    if (wantsReboot) {
      return [
        { command: "shutdown /r /t 0", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
        { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ ØªØ£Ø®ÛŒØ± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡" },
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      ];
    }
    // generic windows
    return [
      { command: "where <command>", note: "Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ÛŒØ± Ø§Ø¬Ø±Ø§ÛŒ ÛŒÚ© Ø¯Ø³ØªÙˆØ± (CMD)" },
      { command: "whoami", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ" },
      { command: "systeminfo", note: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…" },
    ];
  }

  if (o === "linux" || o === "mac") {
    if (wantsShutdown) {
      return [
        { command: "sudo shutdown -h +1", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† ÙÙˆØ±ÛŒ" },
      ];
    }
    if (wantsReboot) {
      return [
        { command: "sudo reboot", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      ];
    }
    return [
      { command: "uname -a", note: "Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø±Ù†Ù„/Ø³ÛŒØ³ØªÙ…" },
      { command: "whoami", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ" },
      { command: "id", note: "Ù†Ù…Ø§ÛŒØ´ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ Ùˆ UID/GID" },
    ];
  }

  // network fallback (vendor-aware could be expanded later)
  return [
    { command: "show version", note: "Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø³Ø®Ù‡/Ø³ÛŒØ³ØªÙ… (Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Vendor)" },
    { command: "show running-config", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù†ÙÛŒÚ¯ ÙØ¹Ù„ÛŒ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø§Ø´Ø¯)" },
    { command: "show interfaces", note: "Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø§ÛŒÙ†ØªØ±ÙÛŒØ³â€ŒÙ‡Ø§" },
  ];
}

function renderMarkdown(tool) {
  const primary = tool?.primary?.command || "";
  const lang = tool?.primary?.lang || "bash";
  const explanation = String(tool?.explanation || "").trim();
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alternatives = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warnings.filter(Boolean).map(w => `- ${String(w).trim()}`).join("\n") || "- (Ù†Ø¯Ø§Ø±Ø¯)";
  const altBlocks = alternatives.map(a => {
    const note = String(a?.note || "").trim() || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = String(a?.command || "").trim();
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `\`\`\`${lang}\n${primary}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${explanation || "(Ù†Ø¯Ø§Ø±Ø¯)"}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks || "(Ù†Ø¯Ø§Ø±Ø¯)"}`.trim();
}

export function formatToolResponse({
  rawText,
  userRequest,
  os,
  cli,
  knowledgeLevel,
  outputType,
}) {
  const langTag = fenceLangFromCli(cli, outputType);

  // Ambiguity handling
  if (isAmbiguous(userRequest)) {
    const tool = {
      primary: { command: "", lang: langTag },
      explanation: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ù…Ø¨Ù‡Ù… Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø³Ø±ÙˆÛŒØ³/ÙØ§ÛŒÙ„/Ø¢ÛŒâ€ŒÙ¾ÛŒ/Ù†Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡/Ø®Ø±ÙˆØ¬ÛŒ Ø®Ø·Ø§). ÛŒØ§ Ø§Ø² Ø­Ø§Ù„Øª Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ (Chat) Ø¨Ø±Ø§ÛŒ Troubleshooting Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
      warnings: defaultWarnings({ os, cli, outputType }),
      alternatives: ensure3([], (i) => ({ command: "", note: "â€”" })),
    };
    return { tool, markdown: renderMarkdown(tool) };
  }

  // Prefer model-provided JSON contract if present
  const parsed = tryParseToolJSON(rawText);
  if (parsed) {
    const tool = {
      primary: {
        command: String(parsed?.primary?.command || "").trim(),
        lang: String(parsed?.primary?.lang || langTag).trim() || langTag,
      },
      explanation: String(parsed?.explanation || "").trim(),
      warnings: ensure3(parsed?.warnings, (i)=> defaultWarnings({os,cli,outputType})[i] || "Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯."),
      alternatives: ensure3(parsed?.alternatives, (i)=> pickOSAwareAlternatives({userRequest,os,cli})[i]),
    };
    // Force exactly 3 alternatives
    tool.alternatives = tool.alternatives.slice(0, 3);
    return { tool, markdown: renderMarkdown(tool) };
  }

  // If no JSON: do OS-aware minimal synthesis (NOT cross-OS)
  const alts = pickOSAwareAlternatives({ userRequest, os, cli });
  // Primary: choose the first alternative as best default if model didn't give a clean primary command
  const primaryCmd = String(alts?.[0]?.command || "").trim();

  const tool = {
    primary: { command: primaryCmd, lang: langTag },
    explanation: "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ (OS/CLI/Ø³Ø·Ø­ Ø¯Ø§Ù†Ø´) ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Chat Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
    warnings: defaultWarnings({ os, cli, outputType }),
    alternatives: ensure3(alts, (i)=> alts[i] || { command: primaryCmd, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" }),
  };

  return { tool, markdown: renderMarkdown(tool) };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_t_tdz_20260108_070352/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";

// local storage keys
const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom OS)" },
];

const OUTPUT_TYPES = [
  { value: "tool", labelFa: "Tool (Ú©Ø§Ù…Ù„)", labelEn: "Tool (Full)" },
  { value: "command", labelFa: "Command (ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±)", labelEn: "Command (Commands only)" },
  { value: "python", labelFa: "Python", labelEn: "Python" },
];

const VERBOSITY = [
  { value: "brief", labelFa: "Ø®Ù„Ø§ØµÙ‡", labelEn: "Brief" },
  { value: "normal", labelFa: "Ù†Ø±Ù…Ø§Ù„", labelEn: "Normal" },
  { value: "detailed", labelFa: "Ø¬Ø²Ø¦ÛŒ", labelEn: "Detailed" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  windows: ["powershell", "cmd"],
  mac: ["zsh", "bash"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "powershell", "cmd"],
};

const LINUX_DISTROS = ["Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","Alpine","Kali"];
const WINDOWS_FLAVORS = ["Windows 10","Windows 11","Windows Server 2019","Windows Server 2022"];
const MAC_FLAVORS = ["macOS"];

const NETWORK_VENDORS = ["Cisco","MikroTik","FortiGate","Juniper","Aruba","Huawei","Generic"];
const DEVICE_TYPES_BY_VENDOR = {
  Cisco: ["switch","router","firewall"],
  MikroTik: ["router","switch"],
  FortiGate: ["firewall"],
  Juniper: ["switch","router","firewall"],
  Aruba: ["switch","controller"],
  Huawei: ["switch","router","firewall"],
  Generic: ["router","switch","firewall","appliance"],
};

function isSafeFreeText(v, min=2, max=40) {
  const s = String(v||"").trim().replace(/\s+/g," ");
  if (s.length < min || s.length > max) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

function qsToObj() {
  const q = new URLSearchParams(window.location.search);
  return {
    platform: q.get("platform") || "",
    cli: q.get("cli") || "",
    out: q.get("out") || "",
    v: q.get("v") || "",
    adv: q.get("adv") || "",
    swap: q.get("swap") || "",
    lang: q.get("lang") || "",
  };
}
function setQS(p) {
  const q = new URLSearchParams(window.location.search);
  Object.entries(p).forEach(([k,v]) => {
    if (v === "" || v == null) q.delete(k);
    else q.set(k, String(v));
  });
  const url = `${window.location.pathname}?${q.toString()}`;
  window.history.replaceState({}, "", url);
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm opacity-90">{label}</span>
      {tip ? (
        <span className="relative group">
          <button
            type="button"
            className="w-5 h-5 rounded-full border text-xs opacity-70 hover:opacity-100 dark:border-white/10"
            aria-label={`${label} help`}
          >
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-80 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  const { lang, setLang } = useLanguage();
  const isRTL = (lang === "fa");

  const t = useMemo(() => {
    const fa = {
      platform: "Ù¾Ù„ØªÙØ±Ù…",
      outputType: "Ù†ÙˆØ¹ Ø®Ø±ÙˆØ¬ÛŒ",
      cli: "Ø´Ù„ / CLI",
      verbosity: "Ø³Ø·Ø­ ØªÙˆØ¶ÛŒØ­",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "ØªÙˆØ²ÛŒØ¹ / Ù†ÙˆØ¹",
      version: "Version (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª",
      gen: "Generate",
      explain: "Explain command",
      swap: "Ø¬Ø§Ø¨Ø¬Ø§",
      errFix: "Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯:",
      tip_platform: "Ù¾Ù„ØªÙØ±Ù… Ù‡Ø¯ÙÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¢Ù† ØªÙˆÙ„ÛŒØ¯ Ø´ÙˆØ¯.",
      tip_output: "Tool: Ø®Ø±ÙˆØ¬ÛŒ Ú©Ø§Ù…Ù„. Command: ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ± + Ù‡Ø´Ø¯Ø§Ø± + Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§. Python: ÙÙ‚Ø· Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ†.",
      tip_cli: "Ø´Ù„/CLI Ù‡Ø¯Ù (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Ø®Ù„Ø§ØµÙ‡: Ú©ÙˆØªØ§Ù‡. Ù†Ø±Ù…Ø§Ù„: ØªÙˆØ¶ÛŒØ­ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯. Ø¬Ø²Ø¦ÛŒ: ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ + Ù…Ø«Ø§Ù„.",
      tip_advanced: "Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§ØªÙ Ù‡Ù…Ø§Ù† Ù¾Ù„ØªÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (Ù…Ø«Ù„Ø§Ù‹ distro Ù„ÛŒÙ†ÙˆÚ©Ø³ ÛŒØ§ Ù†ÙˆØ¹ Windows).",
      tip_custom: "Ø§Ú¯Ø± Ø³ÛŒØ³ØªÙ…/Ø´Ù„ Ø®Ø§Øµ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø³ÙØ§Ø±Ø´ÛŒ Ú©Ù†ÛŒØ¯. ÙÙ‚Ø· Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      placeholder: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø¶Ø­ Ø¨Ù†ÙˆÛŒØ³ (Ù‡Ø¯Ù + Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§). Ù…Ø«Ø§Ù„: Â«Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø³ÛŒØ³ØªÙ… Ø±Ùˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ù†Ù…Â»",
    };
    const en = {
      platform: "Platform",
      outputType: "Output type",
      cli: "Shell / CLI",
      verbosity: "Verbosity",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "Distro / Flavor",
      version: "Version (optional)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Request",
      gen: "Generate",
      explain: "Explain command",
      swap: "Swap",
      errFix: "Fix this first:",
      tip_platform: "Target platform to generate commands for.",
      tip_output: "Tool: full output. Command: command + warnings + alternatives (no explanation). Python: python code only.",
      tip_cli: "Target shell/CLI (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Brief: short. Normal: standard. Detailed: full explanation + examples.",
      tip_advanced: "Advanced fields for the selected platform only.",
      tip_custom: "Use for custom OS/Shell. Invalid values will be blocked before sending.",
      placeholder: "Write a clear request (goal + constraints). Example: â€œRestart my systemâ€",
    };
    return isRTL ? fa : en;
  }, [isRTL]);

  // Defaults
  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");
  const [advanced, setAdvanced] = useState(false);
  const [swap, setSwap] = useState(false);

  // advanced per-platform
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [windowsFlavor, setWindowsFlavor] = useState("Windows 11");
  const [macFlavor, setMacFlavor] = useState("macOS");
  const [osVersion, setOsVersion] = useState("");

  // network
  const [vendor, setVendor] = useState("Cisco");
  const [deviceType, setDeviceType] = useState("router");

  // custom
  const [customOn, setCustomOn] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [output, setOutput] = useState("");
  const [tool, setTool] = useState(null);

  // Load persisted state
  useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      const q = qsToObj();

      const p = q.platform || saved.platform || "linux";
      const c = q.cli || saved.cli || (SHELL_BY_PLATFORM[p]?.[0] || "bash");
      const out = q.out || saved.outputType || "tool";
      const v = q.v || saved.verbosity || "normal";
      const adv = (q.adv ? q.adv === "1" : !!saved.advanced);
      const sw = (q.swap ? q.swap === "1" : !!saved.swap);

      if (q.lang) setLang(q.lang);

      setPlatform(p);
      setCli(c);
      setOutputType(out);
      setVerbosity(v);
      setAdvanced(adv);
      setSwap(sw);

      setLinuxDistro(saved.linuxDistro || "Ubuntu");
      setWindowsFlavor(saved.windowsFlavor || "Windows 11");
      setMacFlavor(saved.macFlavor || "macOS");
      setOsVersion(saved.osVersion || "");

      setVendor(saved.vendor || "Cisco");
      setDeviceType(saved.deviceType || "router");

      setCustomOn(!!saved.customOn);
      setCustomOS(saved.customOS || "");
      setCustomShell(saved.customShell || "");

      setInput(saved.input || "");
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Keep cli valid per platform
  useEffect(() => {
    const allowed = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!allowed.includes(cli)) setCli(allowed[0]);
    // If leaving network, reset vendor/deviceType
    if (platform !== "network") {
      setVendor("Cisco");
      setDeviceType("router");
    }
    // Custom only relevant on "other"
    if (platform !== "other") setCustomOn(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [platform]);

  // persist state + URL
  useEffect(() => {
    const st = {
      platform, cli, outputType, verbosity, advanced, swap,
      linuxDistro, windowsFlavor, macFlavor, osVersion,
      vendor, deviceType,
      customOn, customOS, customShell,
      input
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
    setQS({
      platform,
      cli,
      out: outputType,
      v: verbosity,
      adv: advanced ? "1" : "",
      swap: swap ? "1" : "",
      lang,
    });
  }, [platform, cli, outputType, verbosity, advanced, swap, linuxDistro, windowsFlavor, macFlavor, osVersion, vendor, deviceType, customOn, customOS, customShell, input, lang]);

  function validateBeforeSend() {
    const errs = [];

    if (!input.trim()) errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª." : "Request is empty.");

    // outputType strict
    if (!["tool","command","python"].includes(outputType)) errs.push("Invalid output type.");

    // platform strict
    if (!["linux","windows","mac","network","other"].includes(platform)) errs.push("Invalid platform.");

    // Custom validation (block before API)
    if (platform === "other" && customOn) {
      if (!isSafeFreeText(customOS, 2, 40)) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom OS.");
      if (!isSafeFreeText(customShell, 2, 20)) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom Shell/CLI.");
    }

    // Advanced validation: only for selected platform
    if (advanced && platform === "linux") {
      if (linuxDistro && !LINUX_DISTROS.includes(linuxDistro)) errs.push(isRTL ? "Distro Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid distro.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }
    if (advanced && platform === "windows") {
      if (windowsFlavor && !WINDOWS_FLAVORS.includes(windowsFlavor)) errs.push(isRTL ? "Windows Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Windows flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version/Build Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version/build (optional).");
    }
    if (advanced && platform === "mac") {
      if (macFlavor && !MAC_FLAVORS.includes(macFlavor)) errs.push(isRTL ? "macOS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid macOS flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    // Network validation always available in normal mode (not hidden)
    if (platform === "network") {
      if (!NETWORK_VENDORS.includes(vendor)) errs.push(isRTL ? "Vendor Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid vendor.");
      const dt = DEVICE_TYPES_BY_VENDOR[vendor] || [];
      if (!dt.includes(deviceType)) errs.push(isRTL ? "Device type Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid device type.");
    }

    return errs;
  }

  function computeOS() {
    // version optional, but don't force users to fill it
    if (platform === "linux") return advanced ? (osVersion ? `${linuxDistro} ${osVersion}` : linuxDistro) : "linux";
    if (platform === "windows") return advanced ? (osVersion ? `${windowsFlavor} ${osVersion}` : windowsFlavor) : "windows";
    if (platform === "mac") return advanced ? (osVersion ? `${macFlavor} ${osVersion}` : macFlavor) : "mac";
    if (platform === "network") return "network";
    if (platform === "other") return customOn ? customOS.trim() : "other";
    return platform;
  }

  function payloadFor(mode="generate", targetCommand="") {
    const base = {
      mode,
      lang,
      user_request: input.trim(),
      outputType,
      verbosity,
    };

    // custom ON => send ONLY custom fields (no extra)
    if (platform === "other" && customOn) {
      return {
        ...base,
        platform: "other",
        os: customOS.trim(),
        cli: customShell.trim(),
        vendor: "",
        deviceType: "general",
        ...(mode === "explain" ? { targetCommand } : {}),
      };
    }

    // normal platforms
    const pl = platform;
    const os = computeOS();
    const c = cli;

    return {
      ...base,
      platform: pl,
      os,
      cli: c,
      vendor: pl === "network" ? vendor : "",
      deviceType: pl === "network" ? deviceType : "general",
      ...(mode === "explain" ? { targetCommand } : {}),
    };
  }

  async function runGenerate() {
    const errs = validateBeforeSend();
    if (errs.length) { setErr(`${t.errFix} ${errs[0]}`); return; }

    setErr("");
    setLoading(true);
    setOutput("");
    setTool(null);

    try {
      const res = await callCCG(payloadFor("generate"));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  async function runExplain() {
    // explain should use last produced tool.primary.command if possible
    const cmd = tool?.primary?.command ? String(tool.primary.command) : "";
    if (!cmd.trim()) { setErr(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø¯Ø³ØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯." : "Generate a command first."); return; }

    setErr("");
    setLoading(true);
    try {
      const res = await callCCG(payloadFor("explain", cmd.trim()));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  const cliOptions = SHELL_BY_PLATFORM[platform] || ["bash"];

  const leftPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-2" : "order-1") : (isRTL ? "order-1" : "order-2"))}`;
  const rightPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-1" : "order-2") : (isRTL ? "order-2" : "order-1"))}`;

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4 justify-between">

            <div className="flex flex-wrap items-center gap-3 sm:gap-4">
              <FieldLabel label={t.platform} tip={t.tip_platform} />
              <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
                {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>

              <FieldLabel label={t.cli} tip={t.tip_cli} />
              <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm">
                {cliOptions.map(v => <option key={v} value={v}>{v}</option>)}
              </select>

              <FieldLabel label={t.outputType} tip={t.tip_output} />
              <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
                {OUTPUT_TYPES.map(o => (
                  <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>
                ))}
              </select>

              <FieldLabel label={t.verbosity} tip={t.tip_verbosity} />
              <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
                {VERBOSITY.map(o => <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>)}
              </select>

              <div className="flex items-center gap-2">
                <input id="ccg-adv" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
                <label htmlFor="ccg-adv" className="text-sm opacity-90">{t.advanced}</label>
              </div>

              <button type="button" className="ccg-btn text-sm" onClick={()=>setSwap(s=>!s)}>
                {t.swap}
              </button>
            </div>

            <div className="flex items-center gap-2">
              <button type="button" className="ccg-btn text-sm" onClick={()=>setLang(isRTL ? "en" : "fa")}>
                {isRTL ? "EN" : "FA"}
              </button>
            </div>

          </div>

          {/* Advanced row (platform-specific only) */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] p-4">
              <div className="flex flex-wrap items-center gap-4 justify-between">
                <div className="text-sm opacity-80">{t.tip_advanced}</div>

                {platform === "other" ? (
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customOn} onChange={(e)=>setCustomOn(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">{t.custom}</label>
                  </div>
                ) : null}
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                {platform === "linux" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select w-full">
                        {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                    </div>
                  </>
                ) : null}

                {platform === "windows" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={windowsFlavor} onChange={(e)=>setWindowsFlavor(e.target.value)} className="ccg-select w-full">
                        {WINDOWS_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "mac" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={macFlavor} onChange={(e)=>setMacFlavor(e.target.value)} className="ccg-select w-full">
                        {MAC_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "network" ? (
                  <>
                    <div>
                      <FieldLabel label={t.vendor} />
                      <select value={vendor} onChange={(e)=>{ setVendor(e.target.value); setDeviceType((DEVICE_TYPES_BY_VENDOR[e.target.value]||["router"])[0]); }} className="ccg-select w-full">
                        {NETWORK_VENDORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.deviceType} />
                      <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select w-full">
                        {(DEVICE_TYPES_BY_VENDOR[vendor] || []).map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                  </>
                ) : null}

                {platform === "other" && customOn ? (
                  <>
                    <div>
                      <FieldLabel label="Custom OS" tip={t.tip_custom} />
                      <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                    </div>
                    <div>
                      <FieldLabel label="Custom Shell/CLI" tip={t.tip_custom} />
                      <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ tcsh" : "e.g. tcsh"} />
                    </div>
                  </>
                ) : null}
              </div>
            </div>
          ) : null}

        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          {/* Request */}
          <div className={rightPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{t.request}</h2>
            <textarea
              className="ccg-textarea w-full min-h-[200px]"
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              placeholder={t.placeholder}
            />
            {err ? (
              <div className="ccg-error mt-3">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{err}</div>
              </div>
            ) : null}

            <div className="mt-4 flex items-center gap-3 justify-end">
              <button className="ccg-btn" type="button" disabled={loading} onClick={runExplain}>
                {t.explain}
              </button>
              <button className="ccg-btn primary" type="button" disabled={loading} onClick={runGenerate}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§..." : "Running...") : t.gen}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={leftPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>
            {outputType === "tool" && tool ? (
              <ToolResult tool={tool} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_jsx_escape_20260107_054507/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";



// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with \"Other:\" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : \"\";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || \"\").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||\"\"));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_contract_20260106_062417/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_contract_20260106_062417/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool Contract (LOCKED)
// Produces:
//   tool: { primary{command,lang}, explanation, warnings[], alternatives[{command,note}*3] }
//   markdown: string (stable template)
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 200) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizePrimaryCommand(rawText) {
  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const fromFence = (codeRaw || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromFence.length) return { command: fromFence.join("\n"), rest };

  const fromText = String(rawText || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromText.length) return { command: fromText[0], rest };
  return { command: "", rest };
}

function ensure3Alts(alts, fallbackCmd, os, cli) {
  const out = Array.isArray(alts) ? alts.filter(Boolean) : [];
  while (out.length < 3) {
    out.push({ command: fallbackCmd || "", note: "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });
  }
  return out.slice(0, 3);
}

function defaultWarnings(os, cli, userRequest) {
  const o = String(os || "").toLowerCase();
  const c = String(cli || "").toLowerCase();
  const req = String(userRequest || "").toLowerCase();
  const w = [];
  w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…ÙˆØ§Ø±Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
  if (req.includes("shutdown") || req.includes("Ø®Ø§Ù…ÙˆØ´") || req.includes("reboot") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª")) {
    w.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH/Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.");
    w.push("Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.");
  } else {
    w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ ProductionØŒ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
    w.push("Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Admin/sudo Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.");
  }
  if (o === "network" || req.includes("cisco") || req.includes("mikrotik") || req.includes("forti")) {
    w.unshift("Ø±ÙˆÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø´Ø¨Ú©Ù‡ØŒ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² config Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯ Ùˆ Ø²Ù…Ø§Ù† maintenance Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.");
  }
  if (c.includes("cmd")) {
    // ÙˆÛŒÙ†Ø¯ÙˆØ² Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ sudo Ù†Ø¯Ø§Ø±Ø¯
    // keep generic warning
  }
  return w.slice(0, 3);
}

// Try parse JSON tool payload if model returned it
function tryParseJsonTool(text) {
  const t = String(text || "").trim();
  if (!t.startsWith("{")) return null;
  try {
    const obj = JSON.parse(t);
    return obj && typeof obj === "object" ? obj : null;
  } catch {
    return null;
  }
}

function renderMarkdown(tool) {
  const p = tool?.primary || {};
  const primaryFence = `\`\`\`${p.lang || "bash"}\n${p.command || ""}\n\`\`\``;

  const expl = tool?.explanation ? String(tool.explanation).trim() : "";
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warnings.length ? warnings.map((x) => `- ${x}`).join("\n") : "- (Ù†Ø¯Ø§Ø±Ø¯)";
  const altBlocks = alts
    .slice(0, 3)
    .map((a) => {
      const note = String(a?.note || "").trim() || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
      const cmd = String(a?.command || "").trim();
      return `- ${note}\n\n\`\`\`${p.lang || "bash"}\n${cmd}\n\`\`\``;
    })
    .join("\n\n");

  return `${primaryFence}\n\n## ØªÙˆØ¶ÛŒØ­\n${expl || "(ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª)"}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks || "- (Ù†Ø¯Ø§Ø±Ø¯)"}`;
}

export function formatToolResponse({
  text,
  cli = "bash",
  os = "linux",
  userRequest = "",
  outputType = "command", // command|python
  lang = "fa",
  knowledgeLevel = "beginner",
} = {}) {
  const cliLang = fenceLangFromCli(cli, outputType);

  // (A) If model returned strict JSON, trust it (but normalize)
  const parsed = tryParseJsonTool(text);
  if (parsed?.primary?.command) {
    const tool = {
      primary: { command: String(parsed.primary.command).trim(), lang: parsed.primary.lang || cliLang },
      explanation: String(parsed.explanation || "").trim(),
      warnings: Array.isArray(parsed.warnings) ? parsed.warnings.map(String) : [],
      alternatives: Array.isArray(parsed.alternatives) ? parsed.alternatives : [],
    };
    tool.warnings = tool.warnings.filter(Boolean).slice(0, 5);
    tool.alternatives = ensure3Alts(tool.alternatives, tool.primary.command, os, cli);
    const markdown = renderMarkdown(tool);
    return { tool, markdown };
  }

  // (B) Otherwise parse from markdown-ish text
  const { command, rest } = normalizePrimaryCommand(text);
  const warnings = defaultWarnings(os, cli, userRequest);

  // Simple explanation extraction: first non-empty prose chunk from rest
  const expl = String(rest || "").split("\n").map((x) => x.trim()).filter(Boolean).slice(0, 6).join("\n");
  const tool = {
    primary: { command: command || "", lang: cliLang },
    explanation: expl || (lang === "fa" ? "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯." : "This command performs the primary action for your request."),
    warnings,
    alternatives: ensure3Alts([], command, os, cli),
  };

  // If no primary command, keep template but empty command
  const markdown = renderMarkdown(tool);
  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_output_ui_contract_20260108_055417/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useRef, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";

const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const VERBOSITY = [
  { value: "brief", label: "brief" },
  { value: "normal", label: "normal" },
  { value: "detailed", label: "detailed" },
];

const OUTPUT_TYPES = [
  { value: "tool", label: "Tool (UI)" },
  { value: "markdown", label: "Markdown" },
  { value: "command", label: "Command" },
  { value: "python", label: "Python" },
];

// Platform-specific Advanced options
const LINUX_DISTROS = ["Ubuntu", "Debian", "RHEL", "Rocky", "AlmaLinux", "CentOS", "Fedora", "Arch", "Manjaro", "openSUSE", "Alpine", "Kali"];
const WINDOWS_EDITIONS = ["Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022"];
const MACOS_VERSIONS = ["macOS (generic)", "Sonoma (14)", "Ventura (13)", "Monterey (12)"];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh", "fish"],
  mac: ["zsh", "bash"],
  windows: ["powershell", "cmd"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "fish", "powershell", "cmd", "pwsh", "ksh", "tcsh"],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "mikrotik", label: "MikroTik" },
  { value: "fortinet", label: "Fortinet" },
  { value: "juniper", label: "Juniper" },
  { value: "huawei", label: "Huawei" },
  { value: "generic", label: "Generic" },
];

const NETWORK_DEVICE_TYPES = {
  cisco: ["router", "switch", "firewall"],
  mikrotik: ["router", "switch"],
  fortinet: ["firewall", "router"],
  juniper: ["router", "switch", "firewall"],
  huawei: ["router", "switch", "firewall"],
  generic: ["router", "switch", "firewall", "ap", "loadbalancer", "general"],
};

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}
function isSafeFreeText(v, minLen = 2, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}
function readUrlState() {
  try {
    const u = new URL(window.location.href);
    const q = u.searchParams;
    const obj = {
      platform: q.get("platform") || "",
      cli: q.get("cli") || "",
      out: q.get("out") || "",
      v: q.get("v") || "",
      advanced: q.get("adv") || "",
      swap: q.get("swap") || "",
      distro: q.get("distro") || "",
      osver: q.get("osver") || "",
      win: q.get("win") || "",
      mac: q.get("mac") || "",
      vendor: q.get("vendor") || "",
      dtype: q.get("dtype") || "",
      custom: q.get("custom") || "",
      cos: q.get("cos") || "",
      csh: q.get("csh") || "",
    };
    return obj;
  } catch {
    return {};
  }
}
function writeUrlState(patch) {
  try {
    const u = new URL(window.location.href);
    const q = u.searchParams;
    Object.entries(patch).forEach(([k, v]) => {
      if (v === undefined || v === null || v === "" || v === false) q.delete(k);
      else q.set(k, String(v));
    });
    window.history.replaceState({}, "", u.toString());
  } catch {}
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active ? "bg-blue-600 text-white" : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}
function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      {tip ? (
        <span className="relative group">
          <button type="button" className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10" aria-label={`${label} help`}>
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  const { lang, t } = useLanguage();
  const isRTL = lang === "fa";

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");
  const [valErr, setValErr] = useState("");
  const [output, setOutput] = useState("");
  const [toolResult, setToolResult] = useState(null);

  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");

  const [advanced, setAdvanced] = useState(false);
  const [swapLayout, setSwapLayout] = useState(false);

  // Advanced fields (platform-specific)
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [osVersion, setOsVersion] = useState("");
  const [windowsEdition, setWindowsEdition] = useState("Windows 11");
  const [macosVersion, setMacosVersion] = useState("macOS (generic)");

  // Network fields (always visible when platform=network)
  const [vendor, setVendor] = useState("cisco");
  const [deviceType, setDeviceType] = useState("router");

  // Other/custom
  const [customEnabled, setCustomEnabled] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  // Restore state from URL/localStorage
  const didInit = useRef(false);
  useEffect(() => {
    if (didInit.current) return;
    didInit.current = true;

    const url = readUrlState();
    let ls = {};
    try { ls = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch {}

    const src = { ...ls, ...url };

    if (src.platform) setPlatform(src.platform);
    if (src.cli) setCli(src.cli);
    if (src.out) setOutputType(src.out);
    if (src.v) setVerbosity(src.v);

    if (src.adv !== "") setAdvanced(src.adv === "1" || src.adv === "true");
    if (src.swap !== "") setSwapLayout(src.swap === "1" || src.swap === "true");

    if (src.distro) setLinuxDistro(src.distro);
    if (src.osver) setOsVersion(src.osver);

    if (src.win) setWindowsEdition(src.win);
    if (src.mac) setMacosVersion(src.mac);

    if (src.vendor) setVendor(src.vendor);
    if (src.dtype) setDeviceType(src.dtype);

    if (src.custom !== "") setCustomEnabled(src.custom === "1" || src.custom === "true");
    if (src.cos) setCustomOS(src.cos);
    if (src.csh) setCustomShell(src.csh);
  }, []);

  // Keep cli list synced with platform
  const cliOptions = useMemo(() => {
    const list = SHELL_BY_PLATFORM[platform] || ["bash"];
    return list;
  }, [platform]);

  useEffect(() => {
    // If current cli not valid for platform, reset to first
    const list = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!list.includes(cli)) setCli(list[0]);
  }, [platform]); // eslint-disable-line

  useEffect(() => {
    // keep deviceType synced with vendor
    const d = NETWORK_DEVICE_TYPES[vendor] || NETWORK_DEVICE_TYPES.generic;
    if (!d.includes(deviceType)) setDeviceType(d[0]);
  }, [vendor]); // eslint-disable-line

  // Persist state to localStorage + URL (safe, lightweight)
  useEffect(() => {
    const snap = {
      platform, cli, out: outputType, v: verbosity,
      adv: advanced, swap: swapLayout,
      distro: linuxDistro, osver: osVersion,
      win: windowsEdition, mac: macosVersion,
      vendor, dtype: deviceType,
      custom: customEnabled, cos: customOS, csh: customShell,
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(snap)); } catch {}
    writeUrlState({
      platform, cli, out: outputType, v: verbosity,
      adv: advanced ? "1" : "",
      swap: swapLayout ? "1" : "",
      distro: platform === "linux" ? linuxDistro : "",
      osver: advanced ? osVersion : "",
      win: platform === "windows" ? windowsEdition : "",
      mac: platform === "mac" ? macosVersion : "",
      vendor: platform === "network" ? vendor : "",
      dtype: platform === "network" ? deviceType : "",
      custom: (platform === "other" && advanced && customEnabled) ? "1" : "",
      cos: (platform === "other" && advanced && customEnabled) ? customOS : "",
      csh: (platform === "other" && advanced && customEnabled) ? customShell : "",
    });
  }, [platform, cli, outputType, verbosity, advanced, swapLayout, linuxDistro, osVersion, windowsEdition, macosVersion, vendor, deviceType, customEnabled, customOS, customShell]);

  function buildOsCli() {
    if (platform === "linux") {
      const name = linuxDistro || "Linux";
      const ver = advanced ? cleanToken(osVersion) : "";
      return { os: ver ? `${name} ${ver}` : name, cli };
    }
    if (platform === "windows") {
      const name = windowsEdition || "Windows";
      const ver = advanced ? cleanToken(osVersion) : "";
      // Allow "11 23H2" style in version, optional
      return { os: ver ? `${name} ${ver}` : name, cli };
    }
    if (platform === "mac") {
      const name = macosVersion || "macOS";
      const ver = advanced ? cleanToken(osVersion) : "";
      return { os: ver ? `${name} ${ver}` : name, cli };
    }
    if (platform === "network") {
      return { os: "network", cli: "cli" };
    }
    // other
    return { os: cleanToken(customOS), cli: cleanToken(customShell || cli) };
  }

  function validateBeforeSend({ mode }) {
    const errs = [];

    if (!input.trim() && mode === "generate") errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯." : "Enter your request.");
    if (mode === "explain" && !toolResult?.primary?.command) errs.push(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ú¯ÛŒØ± ØªØ§ Command Ø¨Ø±Ø§ÛŒ ØªÙˆØ¶ÛŒØ­ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯." : "Generate first to have a command to explain.");

    if (platform === "other") {
      if (!advanced) errs.push(isRTL ? "Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² OtherØŒ Advanced Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯." : "Enable Advanced for Other.");
      if (!customEnabled) errs.push(isRTL ? "Ø¨Ø±Ø§ÛŒ Other Ø¨Ø§ÛŒØ¯ Custom OS/Shell Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯." : "Enable Custom OS/Shell for Other.");
      const osOk = isSafeFreeText(customOS, 2, 40);
      const shOk = isSafeFreeText(customShell, 2, 20);
      if (!osOk) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. ÙÙ‚Ø· Ø­Ø±ÙˆÙ/Ø¹Ø¯Ø¯/ÙØ§ØµÙ„Ù‡ Ùˆ . _ + - / (Û² ØªØ§ Û´Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)." : "Invalid Custom OS.");
      if (!shOk) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Û² ØªØ§ Û²Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)." : "Invalid Custom Shell/CLI.");
    }

    if (platform === "linux" && advanced) {
      if (osVersion && !isSafeFreeText(osVersion, 0, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    if (platform === "network") {
      if (!vendor) errs.push(isRTL ? "Vendor Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯." : "Pick a vendor.");
      if (!deviceType) errs.push(isRTL ? "Device type Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯." : "Pick a device type.");
    }

    return errs;
  }

  function buildPayload(mode) {
    const base = {
      mode,
      lang,
      outputType,
      verbosity,
      user_request: mode === "generate" ? input.trim() : (input.trim() || "Explain this command"),
    };

    // If custom enabled (Other), ONLY send minimal required fields (no noise)
    if (platform === "other" && advanced && customEnabled) {
      return {
        ...base,
        platform: "other",
        os: cleanToken(customOS),
        cli: cleanToken(customShell),
      };
    }

    if (platform === "network") {
      return {
        ...base,
        platform: "network",
        os: "network",
        cli: "cli",
        vendor,
        deviceType,
      };
    }

    const { os, cli: c } = buildOsCli();
    return {
      ...base,
      platform,
      os,
      cli: c,
    };
  }

  async function generate() {
    setApiErr("");
    setValErr("");
    setToolResult(null);
    setOutput("");

    const errs = validateBeforeSend({ mode: "generate" });
    if (errs.length) { setValErr(errs.join("\n")); return; }

    setLoading(true);
    try {
      const payload = buildPayload("generate");
      const res = await callCCG(payload);
      const md = res?.markdown || res?.output || "";
      const tool = res?.tool || null;

      setToolResult(tool);
      // render preference:
      if (outputType === "tool" && tool) setOutput(md || "");
      else setOutput(md || "");
    } catch (e) {
      setApiErr(String(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error")));
    } finally {
      setLoading(false);
    }
  }

  async function explainLast() {
    setApiErr("");
    setValErr("");

    const errs = validateBeforeSend({ mode: "explain" });
    if (errs.length) { setValErr(errs.join("\n")); return; }

    setLoading(true);
    try {
      const target = toolResult?.primary?.command || "";
      const payload = {
        ...buildPayload("explain"),
        targetCommand: target,
        user_request: input.trim() || (isRTL ? "Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø´Ø®ØµÛŒ" : "Personal system"),
      };
      const res = await callCCG(payload);
      setToolResult(res?.tool || null);
      setOutput(res?.markdown || res?.output || "");
    } catch (e) {
      setApiErr(String(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error")));
    } finally {
      setLoading(false);
    }
  }

  const requestOrder = useMemo(() => {
    if (swapLayout) return "order-1";
    return isRTL ? "order-2" : "order-1";
  }, [swapLayout, isRTL]);

  const outputOrder = useMemo(() => {
    if (swapLayout) return "order-2";
    return isRTL ? "order-1" : "order-2";
  }, [swapLayout, isRTL]);

  const networkDeviceOptions = useMemo(() => (NETWORK_DEVICE_TYPES[vendor] || NETWORK_DEVICE_TYPES.generic), [vendor]);

  const requestPlaceholder = isRTL
    ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø¶Ø­ Ø¨Ù†ÙˆÛŒØ³ (Ù‡Ø¯Ù + Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§). Ù…Ø«Ø§Ù„: Â«Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… ÙØ¶Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø¯ÛŒØ³Ú© Ø±Ùˆ Ø¨Ø¨ÛŒÙ†Ù…Â»"
    : "Write your request clearly (goal + constraints). e.g. â€œCheck disk free spaceâ€";

  return (
    <div dir={isRTL ? "rtl" : "ltr"} className="space-y-8">
      {/* Context / Controls */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            <FieldLabel label={isRTL ? "Ù¾Ù„ØªÙØ±Ù…" : "Platform"} tip={isRTL ? "Ø³ÛŒØ³ØªÙ…/Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù‡Ø¯Ù Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†." : "Select target system/device."} />
            <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
              {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <FieldLabel label={isRTL ? "CLI / Ø´ÙÙ„" : "CLI/Shell"} tip={isRTL ? "Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± (bash/cmd/pwsh...)" : "Execution shell/CLI."} />
            <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm" disabled={platform==="network"}>
              {cliOptions.map(x => <option key={x} value={x}>{x}</option>)}
            </select>

            <FieldLabel label={isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"} tip={isRTL ? "Tool Ø¨Ø±Ø§ÛŒ UI Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡ØŒ Markdown Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ú©Ø§Ù…Ù„ØŒ Command ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±." : "Tool UI / Markdown / Command only."} />
            <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
              {OUTPUT_TYPES.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <FieldLabel label="Verbosity" tip={isRTL ? "Ø³Ø·Ø­ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆØ¶ÛŒØ­ (Ø±ÙˆÛŒ Explain Ø§Ø«Ø± Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø±Ø¯)." : "Explanation detail level (affects Explain)."} />
            <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
              {VERBOSITY.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <div className="flex items-center gap-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm opacity-80">{isRTL ? "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨ÛŒØ´ØªØ±" : "Advanced"}</label>
            </div>

            <div className="flex items-center gap-2">
              <input id="ccg-swap" type="checkbox" checked={swapLayout} onChange={(e)=>setSwapLayout(e.target.checked)} />
              <label htmlFor="ccg-swap" className="text-sm opacity-80">{isRTL ? "Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§" : "Swap columns"}</label>
            </div>
          </div>

          {/* Advanced panel */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] bg-white/5 p-4">
              {platform === "linux" ? (
                <div className="flex flex-wrap gap-4 items-center">
                  <FieldLabel label={isRTL ? "ØªÙˆØ²ÛŒØ¹" : "Distro"} tip={isRTL ? "ØªÙˆØ²ÛŒØ¹ Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ ÙˆÙ„ÛŒ Ù…ÙÛŒØ¯)." : "Linux distribution (optional but helpful)."} />
                  <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select text-sm">
                    {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                  </select>

                  <FieldLabel label={isRTL ? "ÙˆØ±Ú˜Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "Version (optional)"} tip={isRTL ? "Ø§Ú¯Ø± Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÛŒ Ø®Ø§Ù„ÛŒ Ø¨Ø°Ø§Ø±." : "Leave empty if unsure."} />
                  <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input text-sm" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                </div>
              ) : null}

              {platform === "windows" ? (
                <div className="flex flex-wrap gap-4 items-center">
                  <FieldLabel label={isRTL ? "Ù†Ø³Ø®Ù‡ ÙˆÛŒÙ†Ø¯ÙˆØ²" : "Windows edition"} tip={isRTL ? "Windows 10/11 ÛŒØ§ Server..." : "Pick Windows edition."} />
                  <select value={windowsEdition} onChange={(e)=>setWindowsEdition(e.target.value)} className="ccg-select text-sm">
                    {WINDOWS_EDITIONS.map(x => <option key={x} value={x}>{x}</option>)}
                  </select>

                  <FieldLabel label={isRTL ? "ÙˆØ±Ú˜Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "Version (optional)"} tip={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 23H2 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "e.g. 23H2 (optional)"} />
                  <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input text-sm" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 23H2" : "e.g. 23H2"} />
                </div>
              ) : null}

              {platform === "mac" ? (
                <div className="flex flex-wrap gap-4 items-center">
                  <FieldLabel label={isRTL ? "Ù†Ø³Ø®Ù‡ macOS" : "macOS version"} tip={isRTL ? "Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ¯ÙˆÙ†ÛŒ generic Ø¨Ø²Ù†." : "Use generic if unsure."} />
                  <select value={macosVersion} onChange={(e)=>setMacosVersion(e.target.value)} className="ccg-select text-sm">
                    {MACOS_VERSIONS.map(x => <option key={x} value={x}>{x}</option>)}
                  </select>

                  <FieldLabel label={isRTL ? "ÙˆØ±Ú˜Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "Version (optional)"} tip={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "Optional"} />
                  <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input text-sm" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                </div>
              ) : null}

              {platform === "other" ? (
                <div className="space-y-3">
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customEnabled} onChange={(e)=>setCustomEnabled(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">
                      {isRTL ? "Custom OS/Shell" : "Custom OS/Shell"}
                    </label>
                  </div>

                  {customEnabled ? (
                    <div className="flex flex-wrap gap-4 items-center">
                      <div className="min-w-[240px]">
                        <FieldLabel label={isRTL ? "Ù†Ø§Ù… Ø³ÛŒØ³ØªÙ…â€ŒØ¹Ø§Ù…Ù„" : "Custom OS"} tip={isRTL ? "ÙÙ‚Ø· Ø­Ø±ÙˆÙ/Ø¹Ø¯Ø¯/ÙØ§ØµÙ„Ù‡ Ùˆ . _ + - /" : "Letters/numbers/space and . _ + - / only"} />
                        <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input text-sm w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                      </div>
                      <div className="min-w-[200px]">
                        <FieldLabel label={isRTL ? "Ø´ÙÙ„/CLI" : "Custom Shell/CLI"} tip={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ bash ÛŒØ§ cmd ÛŒØ§ pwsh" : "e.g. bash/cmd/pwsh"} />
                        <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input text-sm w-full" placeholder="bash" />
                      </div>
                    </div>
                  ) : null}
                </div>
              ) : null}
            </div>
          ) : null}

          {/* Network (always visible for network) */}
          {platform === "network" ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] bg-white/5 p-4">
              <div className="flex flex-wrap gap-4 items-center">
                <FieldLabel label={isRTL ? "Vendor" : "Vendor"} tip={isRTL ? "Ø¨Ø±Ù†Ø¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ø¨Ú©Ù‡" : "Network vendor"} />
                <select value={vendor} onChange={(e)=>setVendor(e.target.value)} className="ccg-select text-sm">
                  {NETWORK_VENDORS.map(v => <option key={v.value} value={v.value}>{v.label}</option>)}
                </select>

                <FieldLabel label={isRTL ? "Device type" : "Device type"} tip={isRTL ? "Ù†ÙˆØ¹ Ø¯Ø³ØªÚ¯Ø§Ù‡ (router/switch/firewall...)" : "router/switch/firewall..."} />
                <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select text-sm">
                  {networkDeviceOptions.map(x => <option key={x} value={x}>{x}</option>)}
                </select>
              </div>
            </div>
          ) : null}
        </div>
      </div>

      {/* Main grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Request */}
          <div className={`ccg-card p-5 sm:p-7 ${requestOrder}`}>
            <h2 className="text-lg font-semibold mb-4">{isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª" : "Request"}</h2>

            <textarea
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              className="ccg-textarea"
              placeholder={requestPlaceholder}
              rows={8}
            />

            {valErr ? (
              <div className="ccg-error mt-3 whitespace-pre-wrap">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ" : "Input error"}</div>
                <div className="text-sm">{valErr}</div>
              </div>
            ) : null}

            {apiErr ? (
              <div className="ccg-error mt-3 whitespace-pre-wrap">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§ÛŒ API" : "API error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            <div className="mt-4 flex gap-3 justify-end">
              <button className="ccg-btn" type="button" onClick={explainLast} disabled={loading || !toolResult?.primary?.command}>
                {isRTL ? "ØªÙˆØ¶ÛŒØ­ Ø¯Ø³ØªÙˆØ±" : "Explain command"}
              </button>
              <button className="ccg-btn-primary" type="button" onClick={generate} disabled={loading}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯..." : "Generating...") : (isRTL ? "ØªÙˆÙ„ÛŒØ¯" : "Generate")}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={`ccg-card p-5 sm:p-7 ${outputOrder}`}>
            <h2 className="text-lg font-semibold mb-4">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>

            {outputType === "tool" && toolResult ? (
              <ToolResult tool={toolResult} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_output_ui_contract_20260108_055417/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo, useState } from "react";

function CopyBtn({ text }) {
  const [ok, setOk] = useState(false);
  const onCopy = async () => {
    try {
      await navigator.clipboard.writeText(String(text || ""));
      setOk(true);
      setTimeout(() => setOk(false), 900);
    } catch {
      setOk(false);
    }
  };
  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn px-3 py-1 text-xs"
      aria-label="Copy"
      title="Copy"
    >
      {ok ? "Copied" : "Copy"}
    </button>
  );
}

function CodeBox({ lang = "bash", code = "" }) {
  const safe = String(code || "").trim();
  return (
    <div className="rounded-xl border border-[var(--border)] bg-white/5 p-3">
      <div className="flex items-center justify-between gap-3 mb-2">
        <div className="text-xs opacity-70">lang: {lang}</div>
        <CopyBtn text={safe} />
      </div>
      <pre className="overflow-auto text-sm leading-relaxed whitespace-pre-wrap">
        <code>{safe}</code>
      </pre>
    </div>
  );
}

export default function ToolResult({ tool }) {
  const t = tool && typeof tool === "object" ? tool : null;

  const primary = t?.primary && typeof t.primary === "object" ? t.primary : { command: "", lang: "bash" };
  const explanation = typeof t?.explanation === "string" ? t.explanation : "";
  const warnings = Array.isArray(t?.warnings) ? t.warnings.filter(Boolean) : [];
  const alternatives = Array.isArray(t?.alternatives) ? t.alternatives.filter(Boolean) : [];

  const altItems = useMemo(() => {
    return alternatives.map((a) => {
      if (typeof a === "string") return { command: a, note: "" };
      return {
        command: String(a?.command || "").trim(),
        note: String(a?.note || "").trim(),
      };
    }).filter(x => x.command);
  }, [alternatives]);

  if (!t) return null;

  return (
    <div className="space-y-6">
      {/* Command */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <h3 className="text-base font-semibold">Command</h3>
        </div>
        <CodeBox lang={primary?.lang || "bash"} code={primary?.command || ""} />
      </div>

      {/* Explanation */}
      {explanation ? (
        <div>
          <h3 className="text-base font-semibold mb-2">Explanation</h3>
          <div className="text-sm leading-7 whitespace-pre-wrap">{explanation}</div>
        </div>
      ) : null}

      {/* Warnings */}
      {warnings.length ? (
        <div>
          <h3 className="text-base font-semibold mb-2">Warnings</h3>
          <ul className="list-disc pl-6 text-sm leading-7">
            {warnings.map((w, i) => <li key={i}>{String(w)}</li>)}
          </ul>
        </div>
      ) : null}

      {/* Alternatives */}
      {altItems.length ? (
        <div>
          <h3 className="text-base font-semibold mb-2">Alternatives</h3>
          <div className="space-y-3">
            {altItems.map((a, i) => (
              <div key={i} className="rounded-2xl border border-[var(--border)] bg-white/5 p-3">
                <div className="flex items-start justify-between gap-3">
                  <div className="text-sm font-medium">{a.note || `Alternative ${i+1}`}</div>
                  <CopyBtn text={a.command} />
                </div>
                <pre className="mt-2 overflow-auto text-sm whitespace-pre-wrap"><code>{a.command}</code></pre>
              </div>
            ))}
          </div>
        </div>
      ) : null}
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_output_ui_contract_20260108_055417/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract Normalizer (Generator + Explain)
//
// Returns:
//  - tool: { primary:{command,lang}, explanation, warnings[], alternatives[] }
//  - markdown: string (strict template)
//  - output: markdown (alias)
//
// Explain mode: if forcedCommand provided, primary.command MUST stay exactly that.
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh" || c === "powershell") return "powershell";
  if (c.includes("cmd") || c === "cmd") return "cmd";
  return "bash";
}

function tryParseJSONMaybe(text) {
  const t = String(text || "").trim();
  if (!t) return null;
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try { return JSON.parse(t); } catch { return null; }
}

function stripFences(s) {
  const t = String(s ?? "").trim();
  // ```lang\n...\n```
  const m = t.match(/^\s*```[^\n]*\n([\s\S]*?)\n?```\s*$/);
  return (m ? m[1] : t).trim();
}

function stripInlineBackticks(s) {
  return String(s ?? "").replace(/`+/g, "").trim();
}

function toOneLineCommand(s) {
  const t = stripInlineBackticks(stripFences(s));
  // take first non-empty line
  const line = t.split("\n").map(x=>x.trim()).find(Boolean) || "";
  return line;
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  if (/^\{.*\}$/.test(s)) return false;
  // avoid headings
  if (/^#{1,6}\s/.test(s)) return false;
  return true;
}

function pickCommandFromText(rawText) {
  const t = String(rawText ?? "").trim();
  if (!t) return "";
  const { codeRaw } = splitFirstCodeBlock(t);
  if (codeRaw) {
    const first = codeRaw.split("\n").map(x=>x.trim()).find(Boolean) || "";
    if (looksLikeCommand(first)) return first;
  }
  const lines = t.split("\n").map(x=>x.trim()).filter(Boolean);
  const cand = lines.find(looksLikeCommand) || "";
  return cand;
}

function ensure3Alternatives(arr) {
  const a = Array.isArray(arr) ? arr.slice(0, 3) : [];
  while (a.length < 3) a.push({ command: "", note: "" });
  return a.map(x => ({
    command: toOneLineCommand(x?.command || ""),
    note: String(x?.note || "").trim()
  }));
}

function mdList(items) {
  const arr = Array.isArray(items) ? items.filter(Boolean) : [];
  if (!arr.length) return "- (none)";
  return arr.map(x => `- ${String(x).trim()}`).join("\n");
}

function altMarkdown(alts, lang) {
  const a = ensure3Alternatives(alts);
  return a.map((x) => {
    const note = x.note ? `- ${x.note}\n\n` : "";
    const cmd = x.command || "";
    return `${note}\`\`\`${lang}\n${cmd}\n\`\`\``.trim();
  }).join("\n\n");
}

export function formatToolResponse({
  rawText = "",
  text = "",
  cli = "bash",
  outputType = "tool",
  verbosity = "normal", // brief | normal | detailed
  forcedCommand = "",
} = {}) {
  const lang = fenceLangFromCli(cli, outputType);
  const src = (typeof rawText === "string" && rawText.trim()) ? rawText : String(text || "");

  // Unwrap JSON tool if model returned JSON
  const parsed = tryParseJSONMaybe(src);
  const toolFromJson = parsed?.tool && typeof parsed.tool === "object" ? parsed.tool : null;
  const markdownFromJson = typeof parsed?.markdown === "string" ? parsed.markdown : "";

  let primaryCmd = "";
  let explanation = "";
  let warnings = [];
  let alternatives = [];

  if (toolFromJson) {
    primaryCmd = toOneLineCommand(toolFromJson?.primary?.command || "");
    explanation = String(toolFromJson?.explanation || "").trim();
    warnings = Array.isArray(toolFromJson?.warnings) ? toolFromJson.warnings.map(x=>String(x).trim()).filter(Boolean) : [];
    alternatives = Array.isArray(toolFromJson?.alternatives) ? toolFromJson.alternatives : [];
  }

  // Forced command wins (Explain mode)
  if (forcedCommand) primaryCmd = toOneLineCommand(forcedCommand);

  // Fallback extraction
  if (!primaryCmd) primaryCmd = pickCommandFromText(markdownFromJson || src);
  primaryCmd = toOneLineCommand(primaryCmd);

  // Explanation fallback
  if (!explanation) {
    // remove any code fences and keep rest
    const rest = splitFirstCodeBlock(markdownFromJson || src).rest;
    explanation = String(rest || "").trim();
  }

  // Make verbosity behavior deterministic for explain UX
  if (verbosity === "brief") {
    // keep 1â€“2 sentences
    explanation = explanation.split("\n").join(" ").trim();
    explanation = explanation.split("ã€‚").join("."); // just normalize punctuation a bit
    if (explanation.length > 180) explanation = explanation.slice(0, 180).trim() + "â€¦";
  } else if (verbosity === "detailed") {
    // if no obvious example section, add minimal example hint
    if (!/Ù…Ø«Ø§Ù„|example/i.test(explanation)) {
      explanation = `${explanation}\n\nÙ…Ø«Ø§Ù„:\n- Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø±Ø§ Ù„ØºÙˆ Ú©Ù†ÛŒØŒ Ø§Ø² Ø¯Ø³ØªÙˆØ±/Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.`;
    }
  }

  // Warnings fallback minimal safe set if empty
  if (!warnings.length) {
    warnings = [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH/Remote Ù‡Ø³ØªÛŒØ¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø´ÙˆØ¯.",
      "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ø§Ø«Ø±Ø§Øª Ùˆ Rollback Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
    ];
  }

  alternatives = ensure3Alternatives(alternatives);

  const tool = {
    primary: { command: primaryCmd, lang },
    explanation,
    warnings,
    alternatives
  };

  const md =
`\`\`\`${lang}
${primaryCmd}
\`\`\`

## ØªÙˆØ¶ÛŒØ­
${explanation}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${mdList(warnings)}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
${altMarkdown(alternatives, lang)}
`.trim();

  return { tool, markdown: md, output: md };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_markdownbox_t_tdz_20260108_082704/MarkdownBox.jsx
================================================================================

// client/src/components/ui/MarkdownBox.jsx
import { useMemo, useState } from "react";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";

function CopyMini({ value, labelCopy, labelCopied }) {
  const [copied, setCopied] = useState(false);

  async function onCopy() {
    try {
      await navigator.clipboard.writeText(value || "");
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {}
  }

  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn ccg-btn-ghost px-3 py-1 text-xs"
      title={labelCopy}
    >
      {copied ? labelCopied : labelCopy}
    </button>
  );
}

/**
 * âœ… Fix 1: Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ prop:
 * - content
 * - markdown
 *
 * âœ… Fix 2: Section boxing
 * Ø§Ú¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ Heading Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø¨ÛŒØ§Ø¯ (Command/Explanation/Warnings/Alternatives Ùˆ ...)
 * Ù‡Ø± Ø¨Ø®Ø´ ØªÙˆÛŒ ÛŒÚ© Ú©Ø§Ø¯Ø± Ø¬Ø¯Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡.
 */
export default function MarkdownBox({ content, markdown, lang = "fa" }) {
  const t = useMemo(() => {
    const fa = { copy: "Ú©Ù¾ÛŒ", copied: "Ú©Ù¾ÛŒ Ø´Ø¯" };
    const en = { copy: "Copy", copied: "Copied" };
    return lang === "fa" ? fa : en;
  }, [lang]);

  const raw = (typeof content === "string" ? content : "") || (typeof markdown === "string" ? markdown : "");
  const text = raw || "";

  const sections = useMemo(() => {
    // split by headings (## or #)
    // keep heading with its body
    const lines = text.split("\n");
    const out = [];
    let cur = { title: "", body: [] };

    function pushCur() {
      const body = cur.body.join("\n").trim();
      if (cur.title || body) out.push({ title: cur.title.trim(), body });
    }

    for (const line of lines) {
      const m = line.match(/^(#{1,3})\s+(.*)$/);
      if (m) {
        pushCur();
        cur = { title: m[2] || "", body: [] };
      } else {
        cur.body.push(line);
      }
    }
    pushCur();

    // Ø§Ú¯Ø± Ù‡ÛŒÚ† heading Ù†Ø¨ÙˆØ¯ â†’ ÛŒÚ© Ø³Ú©Ø´Ù†
    if (out.length === 0) return [{ title: "", body: text }];
    // Ø§Ú¯Ø± heading Ø§ÙˆÙ„ Ø®Ø§Ù„ÛŒÙ‡ Ùˆ body Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†ÛŒÚ©Ù‡ â†’ Ø­Ø°Ù
    return out;
  }, [text]);

  if (!text.trim()) {
    return (
      <div className="rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-slate-400">
        {lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}
      </div>
    );
  }

  return (
    <div className={`space-y-4 ${lang === "fa" ? "rtl" : "ltr"}`}>
      {sections.map((s, idx) => {
        const value = (s.body || "").replace(/\n$/, "");
        return (
          <div key={idx} className="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div className="flex items-center justify-between gap-3 mb-3">
              <div className="text-sm font-semibold text-slate-100">
                {s.title || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result")}
              </div>
              <CopyMini value={value} labelCopy={t.copy} labelCopied={t.copied} />
            </div>

            <div className="prose prose-invert max-w-none text-sm">
              <ReactMarkdown
                remarkPlugins={[remarkGfm]}
                components={{
                  code({ inline, className, children }) {
                    const raw = String(children ?? "");
                    const v = raw.replace(/\n$/, "");
                    const isBlock = !inline;
                    if (!isBlock) return <code className="px-1 py-0.5 rounded bg-black/30">{children}</code>;

                    const langName = (className || "").replace("language-", "") || "CODE";
                    return (
                      <div className="rounded-2xl border border-white/10 bg-black/30 overflow-hidden">
                        <div className="flex items-center justify-between px-3 py-2 border-b border-white/10">
                          <div className="text-xs font-semibold text-slate-200">{langName}</div>
                          <CopyMini value={v} labelCopy={t.copy} labelCopied={t.copied} />
                        </div>
                        <pre className="overflow-auto p-3 text-xs leading-6">
                          <code dir="ltr">{v}</code>
                        </pre>
                      </div>
                    );
                  },
                }}
              >
                {s.body || ""}
              </ReactMarkdown>
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/day2_hardening_20260107_160523/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";

const LS_PRESET = "ccg_generator_preset_v1";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom OS)" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
  network: [
    { value: "network", label: "network" },
  ],
  other: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
    { value: "pwsh", label: "pwsh" },
    { value: "cmd", label: "cmd" },
  ],
};

const OS_ALLOWLIST = [
  // Linux
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES",
  "Amazon Linux","Oracle Linux","Kali","Gentoo","Alpine",
  // BSD/Unix
  "FreeBSD","OpenBSD","NetBSD","AIX","HP-UX","Solaris","Illumos",
  // Windows
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  // macOS
  "macOS",
  // Network names (optional use)
  "Cisco IOS","Cisco IOS-XE","MikroTik RouterOS","FortiOS"
];

const SHELL_ALLOWLIST = ["bash","zsh","sh","fish","cmd","powershell","pwsh","ksh","tcsh"];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}
function isSafeFreeText(v, minLen = 2, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen || s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

export default function GeneratorPage() {
  const { lang, t } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const shellOptions = useMemo(() => SHELL_BY_PLATFORM[platform] || SHELL_BY_PLATFORM.linux, [platform]);
  const [cli, setCli] = useState("bash");

  const [outputType, setOutputType] = useState("tool"); // tool | command | python
  const [verbosity, setVerbosity] = useState("normal"); // concise | normal | detailed

  const [advanced, setAdvanced] = useState(false);

  // Advanced OS details
  const [osName, setOsName] = useState("Ubuntu");
  const [osVersion, setOsVersion] = useState("");

  // Advanced custom OS/shell
  const [useCustomOS, setUseCustomOS] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [useCustomShell, setUseCustomShell] = useState(false);
  const [customShell, setCustomShell] = useState("");

  // Request + output
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");
  const [markdown, setMarkdown] = useState("");
  const [toolResult, setToolResult] = useState(null);

  const effectiveCli = useMemo(() => {
    if (advanced && useCustomShell && isSafeFreeText(customShell, 2, 20) && SHELL_ALLOWLIST.includes(cleanToken(customShell).toLowerCase())) {
      return cleanToken(customShell).toLowerCase();
    }
    return (cli || "bash");
  }, [advanced, useCustomShell, customShell, cli]);

  const effectiveOS = useMemo(() => {
    if (!advanced) {
      // minimal payload in normal mode
      return platform === "windows" ? "Windows" : platform === "mac" ? "macOS" : platform === "network" ? "network" : "Linux";
    }

    // advanced mode: allowlist or validated custom
    if (useCustomOS) {
      const v = cleanToken(customOS);
      if (isSafeFreeText(v, 2, 40)) return `Other: ${v}`;
      return "Other";
    }

    const name = cleanToken(osName);
    const ver = cleanToken(osVersion);
    const okName = OS_ALLOWLIST.includes(name);
    const okVer = !ver || /^[0-9A-Za-z.\-_]{1,12}$/.test(ver);
    if (okName && okVer) return ver ? `${name} ${ver}` : name;

    // fallback
    return okName ? name : (platform === "windows" ? "Windows" : platform === "mac" ? "macOS" : "Linux");
  }, [advanced, platform, useCustomOS, customOS, osName, osVersion]);

  function payloadBase(mode) {
    return {
      mode, // generate | explain
      lang: lang || "fa",
      user_request: input.trim(),
      outputType,
      verbosity, // only affects explanation depth
      platform,
      os: effectiveOS,
      cli: effectiveCli,
    };
  }

  async function generate() {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setMarkdown("");
    setToolResult(null);

    try {
      const res = await callCCG(payloadBase("generate"));
      setToolResult(res?.tool || null);
      setMarkdown(res?.output || res?.markdown || "");
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆÛŒØ³" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  async function explain() {
    const cmd = toolResult?.primary?.command;
    if (!cmd || loading) return;

    setLoading(true);
    setApiErr("");
    try {
      const payload = {
        ...payloadBase("explain"),
        targetCommand: cmd,
        // Explanation should be richer by default
        verbosity: "detailed",
      };
      const res = await callCCG(payload);
      setToolResult(res?.tool || toolResult); // keep command stable
      setMarkdown(res?.output || res?.markdown || "");
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± ØªÙˆØ¶ÛŒØ­" : "Explain error"));
    } finally {
      setLoading(false);
    }
  }

  function savePreset() {
    const preset = {
      platform,
      cli,
      outputType,
      verbosity,
      advanced,
      osName,
      osVersion,
      useCustomOS,
      customOS,
      useCustomShell,
      customShell,
    };
    localStorage.setItem(LS_PRESET, JSON.stringify(preset));
  }

  function loadPreset() {
    try {
      const raw = localStorage.getItem(LS_PRESET);
      if (!raw) return;
      const p = JSON.parse(raw);
      setPlatform(p.platform || "linux");
      setCli(p.cli || "bash");
      setOutputType(p.outputType || "tool");
      setVerbosity(p.verbosity || "normal");
      setAdvanced(!!p.advanced);
      setOsName(p.osName || "Ubuntu");
      setOsVersion(p.osVersion || "");
      setUseCustomOS(!!p.useCustomOS);
      setCustomOS(p.customOS || "");
      setUseCustomShell(!!p.useCustomShell);
      setCustomShell(p.customShell || "");
    } catch {}
  }

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-5">
          <div className="flex flex-wrap items-center gap-4">
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select value={platform} onChange={(e) => { setPlatform(e.target.value); }} className="ccg-select text-sm">
              {PLATFORM_OPTIONS.map((o) => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <FieldLabel label={t("shell")} tip={t("tip_shell")} />
            <select value={cli} onChange={(e) => setCli(e.target.value)} className="ccg-select text-sm">
              {shellOptions.map((o) => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "tool"} onClick={() => setOutputType("tool")}>{t("tool")}</Toggle>
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>{t("commandShell")}</Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>{t("pythonAutomation")}</Toggle>
            </div>

            <div className="flex items-center gap-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e) => setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>

            {advanced ? (
              <div className="w-full mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                <div className="ccg-card p-3">
                  <div className="text-sm font-semibold mb-2">{t("verbosity")}</div>
                  <select value={verbosity} onChange={(e) => setVerbosity(e.target.value)} className="ccg-select text-sm w-full">
                    <option value="concise">{t("concise")}</option>
                    <option value="normal">{t("normal")}</option>
                    <option value="detailed">{t("detailed")}</option>
                  </select>
                  <div className="text-xs text-slate-500 mt-2">{t("tip_verbosity")}</div>
                </div>

                <div className="ccg-card p-3">
                  <div className="text-sm font-semibold mb-2">{t("osDetails")}</div>
                  <select value={osName} onChange={(e) => setOsName(e.target.value)} className="ccg-select text-sm w-full">
                    {OS_ALLOWLIST.map((n) => <option key={n} value={n}>{n}</option>)}
                  </select>
                  <input
                    value={osVersion}
                    onChange={(e) => setOsVersion(e.target.value)}
                    placeholder={t("osVersion")}
                    className="ccg-input text-sm w-full mt-2"
                  />
                </div>

                <div className="ccg-card p-3">
                  <div className="text-sm font-semibold mb-2">Custom</div>

                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" checked={useCustomOS} onChange={(e)=>setUseCustomOS(e.target.checked)} />
                    {t("customOS")}
                  </label>
                  {useCustomOS ? (
                    <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input text-sm w-full mt-2" placeholder="e.g. Android / BusyBox / Yocto" />
                  ) : null}

                  <label className="flex items-center gap-2 text-sm mt-3">
                    <input type="checkbox" checked={useCustomShell} onChange={(e)=>setUseCustomShell(e.target.checked)} />
                    {t("customShell")}
                  </label>
                  {useCustomShell ? (
                    <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input text-sm w-full mt-2" placeholder="bash | zsh | pwsh | cmd | ..." />
                  ) : null}

                  <div className="flex gap-2 mt-3">
                    <button type="button" className="ccg-btn" onClick={savePreset}>Save preset</button>
                    <button type="button" className="ccg-btn" onClick={loadPreset}>Load</button>
                  </div>
                </div>
              </div>
            ) : null}
          </div>
        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="ccg-card p-5 sm:p-6">
            <h2 className="text-lg font-semibold mb-3">{t("request")}</h2>
            <textarea
              className="ccg-textarea w-full"
              rows={7}
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
            />
            <div className="flex flex-wrap gap-2 mt-4">
              <button className="ccg-btn" type="button" onClick={generate} disabled={loading || !input.trim()}>
                {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
              </button>

              <button className="ccg-btn" type="button" onClick={explain} disabled={loading || !toolResult?.primary?.command}>
                {t("explainMore")}
              </button>
            </div>
          </div>

          <div className="ccg-card p-5 sm:p-6">
            <h2 className="text-lg font-semibold mb-3">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {markdown ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={markdown} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">{t("outputPlaceholder")}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/day2_hardening_20260107_160523/client/src/components/ui/ToolResult.jsx
================================================================================

import React from "react";

function CodeBlock({ lang = "bash", code = "" }) {
  return (
    <pre className="rounded-xl border border-slate-200/70 dark:border-white/10 bg-slate-50 dark:bg-white/5 p-3 overflow-auto text-sm">
      <code className={`language-${lang}`}>{code}</code>
    </pre>
  );
}

export default function ToolResult({ tool }) {
  if (!tool) return null;

  const primary = tool.primary || {};
  const warnings = Array.isArray(tool.warnings) ? tool.warnings : [];
  const alternatives = Array.isArray(tool.alternatives) ? tool.alternatives : [];

  return (
    <div className="space-y-4">
      <div>
        <CodeBlock lang={primary.lang || "bash"} code={primary.command || ""} />
      </div>

      <div className="space-y-2">
        <h3 className="text-sm font-semibold text-slate-800 dark:text-white/90">ØªÙˆØ¶ÛŒØ­</h3>
        <div className="text-sm text-slate-700 dark:text-white/80 whitespace-pre-wrap">
          {tool.explanation || "â€”"}
        </div>
      </div>

      <div className="space-y-2">
        <h3 className="text-sm font-semibold text-red-600 dark:text-red-400">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</h3>
        <ul className="list-disc pr-5 text-sm text-red-700 dark:text-red-300 space-y-1">
          {(warnings.length ? warnings : ["Ø§Ø­ØªÛŒØ§Ø· Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."]).map((w, i) => (
            <li key={i}>{w}</li>
          ))}
        </ul>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-slate-800 dark:text-white/90">Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§</h3>
        {(alternatives.length ? alternatives.slice(0, 3) : []).map((a, i) => (
          <div key={i} className="space-y-2">
            <div className="text-xs text-slate-600 dark:text-white/60">{a.note || "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†"}</div>
            <CodeBlock lang={a.lang || primary.lang || "bash"} code={a.command || ""} />
          </div>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/day2_hardening_20260107_160523/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract Normalizer (Generator + Explain)
//
// Always returns an object:
// {
//   tool: { primary:{command,lang}, explanation:string, warnings:string[], alternatives:[{command,note} x3] },
//   markdown: string,
//   output: string (alias of markdown)
// }
//
// If rawText is JSON like { tool, markdown } or { primary, explanation, ... } => unwrap and render.
// If forcedCommand is provided (Explain mode), primary.command MUST stay exactly that.

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh" || c === "powershell") return "powershell";
  if (c.includes("cmd") || c === "cmd") return "cmd";
  return "bash";
}

function tryParseJSONMaybe(text) {
  const t = String(text || "").trim();
  if (!t) return null;
  // quick guard
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try { return JSON.parse(t); } catch { return null; }
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // reject obvious prose starters
  if (/^(Ø¨Ø±Ø§ÛŒ|Ø§ÛŒÙ†|Ù†Ú©ØªÙ‡|ØªÙˆØ¶ÛŒØ­|Ù‡Ø´Ø¯Ø§Ø±|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†|Ù…Ø«Ø§Ù„)\b/.test(s)) return false;
  // starts with common tool token (or sudo)
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizeCommandsFromRaw(codeRaw) {
  const lines = String(codeRaw || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const cmdLines = lines.filter(looksLikeCommand);
  // If none look like command, keep first 1-2 lines (best effort)
  const out = (cmdLines.length ? cmdLines : lines.slice(0, 2)).join("\n").trim();
  return out;
}

function ensure3Alternatives(alts, primaryCmd) {
  const a = Array.isArray(alts) ? alts.filter(x => x && typeof x === "object") : [];
  const out = a.slice(0, 3).map(x => ({
    command: String(x.command || "").trim(),
    note: String(x.note || "").trim()
  })).filter(x => x.command);

  // Fill missing
  while (out.length < 3) {
    out.push({ command: primaryCmd || "", note: out.length === 0 ? "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± Ø§ØµÙ„ÛŒ" : "Ú¯Ø²ÛŒÙ†Ù‡ Ù…Ø´Ø§Ø¨Ù‡" });
  }
  return out.slice(0, 3);
}

function ensureWarnings(ws) {
  const w = Array.isArray(ws) ? ws.map(x => String(x || "").trim()).filter(Boolean) : [];
  if (w.length) return w.slice(0, 6);
  return [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§/ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
    "Ø§Ú¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Administrator / sudo Ø¨Ø§Ø´Ø¯.",
    "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø§Ø«Ø±Ø§Øª Ø¬Ø§Ù†Ø¨ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
  ];
}

function toolToMarkdown(tool) {
  const primary = tool?.primary?.command ? String(tool.primary.command).trim() : "";
  const lang = tool?.primary?.lang ? String(tool.primary.lang).trim() : "bash";
  const explanation = String(tool?.explanation || "").trim() || "ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.";
  const warnings = ensureWarnings(tool?.warnings);
  const alts = ensure3Alternatives(tool?.alternatives, primary);

  const parts = [];
  parts.push("```" + lang + "\n" + (primary || "echo \"No command produced\"") + "\n```");
  parts.push("\n## ØªÙˆØ¶ÛŒØ­\n" + explanation);
  parts.push("\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n" + warnings.map(x => `- ${x}`).join("\n"));
  parts.push("\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n" +
    alts.map(a =>
      `- ${a.note || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†"}\n\n\`\`\`${lang}\n${a.command}\n\`\`\``
    ).join("\n\n")
  );
  return parts.join("\n\n").trim() + "\n";
}

function coerceToolFromJson(obj, cli, forcedCommand) {
  // Supports:
  //  - { tool, markdown }
  //  - { primary, explanation, warnings, alternatives }
  const inner = obj?.tool && typeof obj.tool === "object" ? obj.tool : obj;
  const lang = fenceLangFromCli(cli, "tool");
  const primaryCmd = forcedCommand ? String(forcedCommand).trim() : String(inner?.primary?.command || inner?.command || "").trim();

  const tool = {
    primary: { command: primaryCmd, lang },
    explanation: String(inner?.explanation || "").trim(),
    warnings: ensureWarnings(inner?.warnings),
    alternatives: ensure3Alternatives(inner?.alternatives, primaryCmd)
  };
  return tool;
}

export function formatToolResponse({
  rawText = "",
  text = "",
  cli = "bash",
  outputType = "tool",
  forcedCommand = "",
} = {}) {
  const lang = fenceLangFromCli(cli, outputType);
  const input = String(rawText || text || "").trim();

  // 1) If AI returned JSON, unwrap it
  const parsed = tryParseJSONMaybe(input);
  if (parsed) {
    const tool = coerceToolFromJson(parsed, cli, forcedCommand);
    const md = typeof parsed?.markdown === "string" && parsed.markdown.trim()
      ? parsed.markdown.trim()
      : toolToMarkdown(tool);
    return { tool, markdown: md, output: md };
  }

  // 2) Else extract first code block as primary command
  const { codeRaw, rest } = splitFirstCodeBlock(input);
  let primaryCmd = normalizeCommandsFromRaw(codeRaw);
  if (forcedCommand) primaryCmd = String(forcedCommand).trim();

  const tool = {
    primary: { command: primaryCmd || "", lang },
    explanation: "",
    warnings: [],
    alternatives: []
  };

  // Very simple section extraction from markdown-ish content
  // explanation = rest without headings
  let explanation = rest;
  explanation = explanation.replace(/##\s*Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§[\s\S]*$/m, "").trim();
  explanation = explanation.replace(/##\s*Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§[\s\S]*$/m, "").trim();
  tool.explanation = explanation || "ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.";

  // warnings: try parse from a "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" section if exists
  const wMatch = String(rest).match(/##\s*Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\s*([\s\S]*?)(?:##\s*Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§|$)/m);
  if (wMatch) {
    const ws = wMatch[1].split(/\r?\n/).map(l => l.replace(/^\s*-\s*/, "").trim()).filter(Boolean);
    tool.warnings = ensureWarnings(ws);
  } else {
    tool.warnings = ensureWarnings([]);
  }

  // alternatives: try parse code blocks under "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§"
  const aMatch = String(rest).match(/##\s*Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\s*([\s\S]*?)$/m);
  if (aMatch) {
    const block = aMatch[1];
    const codeBlocks = [...block.matchAll(/```[^\n]*\n([\s\S]*?)```/g)].map(m => String(m[1]||"").trim());
    const notes = block.split(/```[\s\S]*?```/).map(s=>s.trim()).filter(Boolean);
    const alts = [];
    for (let i=0;i<codeBlocks.length && alts.length<3;i++){
      const cmd = normalizeCommandsFromRaw(codeBlocks[i]);
      const note = notes[i] ? notes[i].replace(/^-+\s*/,"").split(/\r?\n/)[0].trim() : "";
      if (cmd) alts.push({ command: cmd, note });
    }
    tool.alternatives = ensure3Alternatives(alts, primaryCmd);
  } else {
    tool.alternatives = ensure3Alternatives([], primaryCmd);
  }

  const md = toolToMarkdown(tool);
  return { tool, markdown: md, output: md };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";

// local storage keys
const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom OS)" },
];

const OUTPUT_TYPES = [
  { value: "tool", labelFa: "Tool (Ú©Ø§Ù…Ù„)", labelEn: "Tool (Full)" },
  { value: "command", labelFa: "Command (ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±)", labelEn: "Command (Commands only)" },
  { value: "python", labelFa: "Python", labelEn: "Python" },
];

const VERBOSITY = [
  { value: "brief", labelFa: "Ø®Ù„Ø§ØµÙ‡", labelEn: "Brief" },
  { value: "normal", labelFa: "Ù†Ø±Ù…Ø§Ù„", labelEn: "Normal" },
  { value: "detailed", labelFa: "Ø¬Ø²Ø¦ÛŒ", labelEn: "Detailed" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  windows: ["powershell", "cmd"],
  mac: ["zsh", "bash"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "powershell", "cmd"],
};

const LINUX_DISTROS = ["Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","Alpine","Kali"];
const WINDOWS_FLAVORS = ["Windows 10","Windows 11","Windows Server 2019","Windows Server 2022"];
const MAC_FLAVORS = ["macOS"];

const NETWORK_VENDORS = ["Cisco","MikroTik","FortiGate","Juniper","Aruba","Huawei","Generic"];
const DEVICE_TYPES_BY_VENDOR = {
  Cisco: ["switch","router","firewall"],
  MikroTik: ["router","switch"],
  FortiGate: ["firewall"],
  Juniper: ["switch","router","firewall"],
  Aruba: ["switch","controller"],
  Huawei: ["switch","router","firewall"],
  Generic: ["router","switch","firewall","appliance"],
};

function isSafeFreeText(v, min=2, max=40) {
  const s = String(v||"").trim().replace(/\s+/g," ");
  if (s.length < min || s.length > max) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

function qsToObj() {
  const q = new URLSearchParams(window.location.search);
  return {
    platform: q.get("platform") || "",
    cli: q.get("cli") || "",
    out: q.get("out") || "",
    v: q.get("v") || "",
    adv: q.get("adv") || "",
    swap: q.get("swap") || "",
    lang: q.get("lang") || "",
  };
}
function setQS(p) {
  const q = new URLSearchParams(window.location.search);
  Object.entries(p).forEach(([k,v]) => {
    if (v === "" || v == null) q.delete(k);
    else q.set(k, String(v));
  });
  const url = `${window.location.pathname}?${q.toString()}`;
  window.history.replaceState({}, "", url);
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm opacity-90">{label}</span>
      {tip ? (
        <span className="relative group">
          <button
            type="button"
            className="w-5 h-5 rounded-full border text-xs opacity-70 hover:opacity-100 dark:border-white/10"
            aria-label={`${label} help`}
          >
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-80 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  const { lang, setLang, t } = useLanguage();
  const isRTL = (lang === "fa");

    const en = {
      platform: "Platform",
      outputType: "Output type",
      cli: "Shell / CLI",
      verbosity: "Verbosity",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "Distro / Flavor",
      version: "Version (optional)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Request",
      gen: "Generate",
      explain: "Explain command",
      swap: "Swap",
      errFix: "Fix this first:",
      tip_platform: "Target platform to generate commands for.",
      tip_output: "Tool: full output. Command: command + warnings + alternatives (no explanation). Python: python code only.",
      tip_cli: "Target shell/CLI (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Brief: short. Normal: standard. Detailed: full explanation + examples.",
      tip_advanced: "Advanced fields for the selected platform only.",
      tip_custom: "Use for custom OS/Shell. Invalid values will be blocked before sending.",
      placeholder: "Write a clear request (goal + constraints). Example: â€œRestart my systemâ€",
    };

  // Defaults
  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");
  const [advanced, setAdvanced] = useState(false);
  const [swap, setSwap] = useState(false);

  // advanced per-platform
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [windowsFlavor, setWindowsFlavor] = useState("Windows 11");
  const [macFlavor, setMacFlavor] = useState("macOS");
  const [osVersion, setOsVersion] = useState("");

  // network
  const [vendor, setVendor] = useState("Cisco");
  const [deviceType, setDeviceType] = useState("router");

  // custom
  const [customOn, setCustomOn] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [output, setOutput] = useState("");
  const [tool, setTool] = useState(null);

  // Load persisted state
  useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      const q = qsToObj();

      const p = q.platform || saved.platform || "linux";
      const c = q.cli || saved.cli || (SHELL_BY_PLATFORM[p]?.[0] || "bash");
      const out = q.out || saved.outputType || "tool";
      const v = q.v || saved.verbosity || "normal";
      const adv = (q.adv ? q.adv === "1" : !!saved.advanced);
      const sw = (q.swap ? q.swap === "1" : !!saved.swap);

      if (q.lang) setLang(q.lang);

      setPlatform(p);
      setCli(c);
      setOutputType(out);
      setVerbosity(v);
      setAdvanced(adv);
      setSwap(sw);

      setLinuxDistro(saved.linuxDistro || "Ubuntu");
      setWindowsFlavor(saved.windowsFlavor || "Windows 11");
      setMacFlavor(saved.macFlavor || "macOS");
      setOsVersion(saved.osVersion || "");

      setVendor(saved.vendor || "Cisco");
      setDeviceType(saved.deviceType || "router");

      setCustomOn(!!saved.customOn);
      setCustomOS(saved.customOS || "");
      setCustomShell(saved.customShell || "");

      setInput(saved.input || "");
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Keep cli valid per platform
  useEffect(() => {
    const allowed = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!allowed.includes(cli)) setCli(allowed[0]);
    // If leaving network, reset vendor/deviceType
    if (platform !== "network") {
      setVendor("Cisco");
      setDeviceType("router");
    }
    // Custom only relevant on "other"
    if (platform !== "other") setCustomOn(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [platform]);

  // persist state + URL
  useEffect(() => {
    const st = {
      platform, cli, outputType, verbosity, advanced, swap,
      linuxDistro, windowsFlavor, macFlavor, osVersion,
      vendor, deviceType,
      customOn, customOS, customShell,
      input
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
    setQS({
      platform,
      cli,
      out: outputType,
      v: verbosity,
      adv: advanced ? "1" : "",
      swap: swap ? "1" : "",
      lang,
    });
  }, [platform, cli, outputType, verbosity, advanced, swap, linuxDistro, windowsFlavor, macFlavor, osVersion, vendor, deviceType, customOn, customOS, customShell, input, lang]);

  function validateBeforeSend() {
    const errs = [];

    if (!input.trim()) errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª." : "Request is empty.");

    // outputType strict
    if (!["tool","command","python"].includes(outputType)) errs.push("Invalid output type.");

    // platform strict
    if (!["linux","windows","mac","network","other"].includes(platform)) errs.push("Invalid platform.");

    // Custom validation (block before API)
    if (platform === "other" && customOn) {
      if (!isSafeFreeText(customOS, 2, 40)) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom OS.");
      if (!isSafeFreeText(customShell, 2, 20)) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom Shell/CLI.");
    }

    // Advanced validation: only for selected platform
    if (advanced && platform === "linux") {
      if (linuxDistro && !LINUX_DISTROS.includes(linuxDistro)) errs.push(isRTL ? "Distro Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid distro.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }
    if (advanced && platform === "windows") {
      if (windowsFlavor && !WINDOWS_FLAVORS.includes(windowsFlavor)) errs.push(isRTL ? "Windows Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Windows flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version/Build Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version/build (optional).");
    }
    if (advanced && platform === "mac") {
      if (macFlavor && !MAC_FLAVORS.includes(macFlavor)) errs.push(isRTL ? "macOS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid macOS flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    // Network validation always available in normal mode (not hidden)
    if (platform === "network") {
      if (!NETWORK_VENDORS.includes(vendor)) errs.push(isRTL ? "Vendor Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid vendor.");
      const dt = DEVICE_TYPES_BY_VENDOR[vendor] || [];
      if (!dt.includes(deviceType)) errs.push(isRTL ? "Device type Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid device type.");
    }

    return errs;
  }

  function computeOS() {
    // version optional, but don't force users to fill it
    if (platform === "linux") return advanced ? (osVersion ? `${linuxDistro} ${osVersion}` : linuxDistro) : "linux";
    if (platform === "windows") return advanced ? (osVersion ? `${windowsFlavor} ${osVersion}` : windowsFlavor) : "windows";
    if (platform === "mac") return advanced ? (osVersion ? `${macFlavor} ${osVersion}` : macFlavor) : "mac";
    if (platform === "network") return "network";
    if (platform === "other") return customOn ? customOS.trim() : "other";
    return platform;
  }

  function payloadFor(mode="generate", targetCommand="") {
    const base = {
      mode,
      lang,
      user_request: input.trim(),
      outputType,
      verbosity,
    };

    // custom ON => send ONLY custom fields (no extra)
    if (platform === "other" && customOn) {
      return {
        ...base,
        platform: "other",
        os: customOS.trim(),
        cli: customShell.trim(),
        vendor: "",
        deviceType: "general",
        ...(mode === "explain" ? { targetCommand } : {}),
      };
    }

    // normal platforms
    const pl = platform;
    const os = computeOS();
    const c = cli;

    return {
      ...base,
      platform: pl,
      os,
      cli: c,
      vendor: pl === "network" ? vendor : "",
      deviceType: pl === "network" ? deviceType : "general",
      ...(mode === "explain" ? { targetCommand } : {}),
    };
  }

  async function runGenerate() {
    const errs = validateBeforeSend();
    if (errs.length) { setErr(`${t.errFix} ${errs[0]}`); return; }

    setErr("");
    setLoading(true);
    setOutput("");
    setTool(null);

    try {
      const res = await callCCG(payloadFor("generate"));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  async function runExplain() {
    // explain should use last produced tool.primary.command if possible
    const cmd = tool?.primary?.command ? String(tool.primary.command) : "";
    if (!cmd.trim()) { setErr(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø¯Ø³ØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯." : "Generate a command first."); return; }

    setErr("");
    setLoading(true);
    try {
      const res = await callCCG(payloadFor("explain", cmd.trim()));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  const cliOptions = SHELL_BY_PLATFORM[platform] || ["bash"];

  const leftPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-2" : "order-1") : (isRTL ? "order-1" : "order-2"))}`;
  const rightPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-1" : "order-2") : (isRTL ? "order-2" : "order-1"))}`;

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4 justify-between">

            <div className="flex flex-wrap items-center gap-3 sm:gap-4">
              <FieldLabel label={t.platform} tip={t.tip_platform} />
              <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
                {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>

              <FieldLabel label={t.cli} tip={t.tip_cli} />
              <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm">
                {cliOptions.map(v => <option key={v} value={v}>{v}</option>)}
              </select>

              <FieldLabel label={t.outputType} tip={t.tip_output} />
              <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
                {OUTPUT_TYPES.map(o => (
                  <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>
                ))}
              </select>

              <FieldLabel label={t.verbosity} tip={t.tip_verbosity} />
              <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
                {VERBOSITY.map(o => <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>)}
              </select>

              <div className="flex items-center gap-2">
                <input id="ccg-adv" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
                <label htmlFor="ccg-adv" className="text-sm opacity-90">{t.advanced}</label>
              </div>

              <button type="button" className="ccg-btn text-sm" onClick={()=>setSwap(s=>!s)}>
                {t.swap}
              </button>
            </div>

            <div className="flex items-center gap-2">
              <button type="button" className="ccg-btn text-sm" onClick={()=>setLang(isRTL ? "en" : "fa")}>
                {isRTL ? "EN" : "FA"}
              </button>
            </div>

          </div>

          {/* Advanced row (platform-specific only) */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] p-4">
              <div className="flex flex-wrap items-center gap-4 justify-between">
                <div className="text-sm opacity-80">{t.tip_advanced}</div>

                {platform === "other" ? (
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customOn} onChange={(e)=>setCustomOn(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">{t.custom}</label>
                  </div>
                ) : null}
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                {platform === "linux" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select w-full">
                        {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                    </div>
                  </>
                ) : null}

                {platform === "windows" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={windowsFlavor} onChange={(e)=>setWindowsFlavor(e.target.value)} className="ccg-select w-full">
                        {WINDOWS_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "mac" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={macFlavor} onChange={(e)=>setMacFlavor(e.target.value)} className="ccg-select w-full">
                        {MAC_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "network" ? (
                  <>
                    <div>
                      <FieldLabel label={t.vendor} />
                      <select value={vendor} onChange={(e)=>{ setVendor(e.target.value); setDeviceType((DEVICE_TYPES_BY_VENDOR[e.target.value]||["router"])[0]); }} className="ccg-select w-full">
                        {NETWORK_VENDORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.deviceType} />
                      <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select w-full">
                        {(DEVICE_TYPES_BY_VENDOR[vendor] || []).map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                  </>
                ) : null}

                {platform === "other" && customOn ? (
                  <>
                    <div>
                      <FieldLabel label="Custom OS" tip={t.tip_custom} />
                      <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                    </div>
                    <div>
                      <FieldLabel label="Custom Shell/CLI" tip={t.tip_custom} />
                      <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ tcsh" : "e.g. tcsh"} />
                    </div>
                  </>
                ) : null}
              </div>
            </div>
          ) : null}

        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          {/* Request */}
          <div className={rightPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{t.request}</h2>
            <textarea
              className="ccg-textarea w-full min-h-[200px]"
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              placeholder={t.placeholder}
            />
            {err ? (
              <div className="ccg-error mt-3">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{err}</div>
              </div>
            ) : null}

            <div className="mt-4 flex items-center gap-3 justify-end">
              <button className="ccg-btn" type="button" disabled={loading} onClick={runExplain}>
                {t.explain}
              </button>
              <button className="ccg-btn primary" type="button" disabled={loading} onClick={runGenerate}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§..." : "Running...") : t.gen}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={leftPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>
            {outputType === "tool" && tool ? (
              <ToolResult tool={tool} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/components/ui/MarkdownBox.jsx
================================================================================

// client/src/components/ui/MarkdownBox.jsx
import { useMemo, useState } from "react";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";

function CopyMini({ value, labelCopy, labelCopied }) {
  const [copied, setCopied] = useState(false);

  async function onCopy() {
    try {
      await navigator.clipboard.writeText(value || "");
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {}
  }

  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn ccg-btn-ghost px-3 py-1 text-xs"
      title={labelCopy}
    >
      {copied ? labelCopied : labelCopy}
    </button>
  );
}

/**
 * âœ… Fix 1: Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ prop:
 * - content
 * - markdown
 *
 * âœ… Fix 2: Section boxing
 * Ø§Ú¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ Heading Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø¨ÛŒØ§Ø¯ (Command/Explanation/Warnings/Alternatives Ùˆ ...)
 * Ù‡Ø± Ø¨Ø®Ø´ ØªÙˆÛŒ ÛŒÚ© Ú©Ø§Ø¯Ø± Ø¬Ø¯Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡.
 */
export default function MarkdownBox({ content, markdown, lang = "fa" }) {
  const t = useMemo(() => {
    const fa = { copy: "Ú©Ù¾ÛŒ", copied: "Ú©Ù¾ÛŒ Ø´Ø¯" };
    const en = { copy: "Copy", copied: "Copied" };
    return lang === "fa" ? fa : en;
  }, [lang]);

  const raw = (typeof content === "string" ? content : "") || (typeof markdown === "string" ? markdown : "");
  const text = raw || "";

  const sections = useMemo(() => {
    // split by headings (## or #)
    // keep heading with its body
    const lines = text.split("\n");
    const out = [];
    let cur = { title: "", body: [] };

    function pushCur() {
      const body = cur.body.join("\n").trim();
      if (cur.title || body) out.push({ title: cur.title.trim(), body });
    }

    for (const line of lines) {
      const m = line.match(/^(#{1,3})\s+(.*)$/);
      if (m) {
        pushCur();
        cur = { title: m[2] || "", body: [] };
      } else {
        cur.body.push(line);
      }
    }
    pushCur();

    // Ø§Ú¯Ø± Ù‡ÛŒÚ† heading Ù†Ø¨ÙˆØ¯ â†’ ÛŒÚ© Ø³Ú©Ø´Ù†
    if (out.length === 0) return [{ title: "", body: text }];
    // Ø§Ú¯Ø± heading Ø§ÙˆÙ„ Ø®Ø§Ù„ÛŒÙ‡ Ùˆ body Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†ÛŒÚ©Ù‡ â†’ Ø­Ø°Ù
    return out;
  }, [text]);

  if (!text.trim()) {
    return (
      <div className="rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-slate-400">
        {lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}
      </div>
    );
  }

  return (
    <div className={`space-y-4 ${lang === "fa" ? "rtl" : "ltr"}`}>
      {sections.map((s, idx) => {
        const value = (s.body || "").replace(/\n$/, "");
        return (
          <div key={idx} className="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div className="flex items-center justify-between gap-3 mb-3">
              <div className="text-sm font-semibold text-slate-100">
                {s.title || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result")}
              </div>
              <CopyMini value={value} labelCopy={t.copy} labelCopied={t.copied} />
            </div>

            <div className="prose prose-invert max-w-none text-sm">
              <ReactMarkdown
                remarkPlugins={[remarkGfm]}
                components={{
                  code({ inline, className, children }) {
                    const raw = String(children ?? "");
                    const v = raw.replace(/\n$/, "");
                    const isBlock = !inline;
                    if (!isBlock) return <code className="px-1 py-0.5 rounded bg-black/30">{children}</code>;

                    const langName = (className || "").replace("language-", "") || "CODE";
                    return (
                      <div className="rounded-2xl border border-white/10 bg-black/30 overflow-hidden">
                        <div className="flex items-center justify-between px-3 py-2 border-b border-white/10">
                          <div className="text-xs font-semibold text-slate-200">{langName}</div>
                          <CopyMini value={v} labelCopy={t.copy} labelCopied={t.copied} />
                        </div>
                        <pre className="overflow-auto p-3 text-xs leading-6">
                          <code dir="ltr">{v}</code>
                        </pre>
                      </div>
                    );
                  },
                }}
              >
                {s.body || ""}
              </ReactMarkdown>
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/components/ui/Tooltip.jsx
================================================================================

// client/src/components/ui/Tooltip.jsx
import { useEffect, useMemo, useRef, useState } from "react";
import { createPortal } from "react-dom";

/**
 * Tooltip Portaled:
 * - Ù…Ø´Ú©Ù„ Ø±ÙØªÙ† Ù…ØªÙ† Ø²ÛŒØ± Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§/overflow Ø±Ø§ Ø­Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
 * - Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ click Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
 */
export default function Tooltip({ text, side = "top" }) {
  const btnRef = useRef(null);
  const [open, setOpen] = useState(false);
  const [pos, setPos] = useState({ top: 0, left: 0, width: 280 });

  const bubbleStyle = useMemo(() => {
    return {
      position: "fixed",
      top: pos.top,
      left: pos.left,
      width: pos.width,
      zIndex: 99999,
    };
  }, [pos]);

  useEffect(() => {
    function onDoc(e) {
      if (!open) return;
      const b = btnRef.current;
      if (!b) return;
      if (b.contains(e.target)) return;
      setOpen(false);
    }
    document.addEventListener("click", onDoc, true);
    return () => document.removeEventListener("click", onDoc, true);
  }, [open]);

  useEffect(() => {
    if (!open) return;

    const b = btnRef.current;
    if (!b) return;

    const r = b.getBoundingClientRect();
    const vw = Math.min(window.innerWidth, 520);
    const width = Math.min(320, vw - 24);

    let left = r.left + r.width / 2 - width / 2;
    left = Math.max(12, Math.min(left, window.innerWidth - width - 12));

    let top;
    if (side === "bottom") top = r.bottom + 10;
    else top = r.top - 10;

    // Ø§Ú¯Ø± Ø¨Ø§Ù„Ø§ Ø¬Ø§ Ù†Ø¨ÙˆØ¯ â†’ Ù¾Ø§ÛŒÛŒÙ†
    if (top < 10) top = r.bottom + 10;
    // Ø§Ú¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ù‡Ù… Ø¬Ø§ Ù†Ø¨ÙˆØ¯ â†’ Ø¨Ø§Ù„Ø§
    if (top + 90 > window.innerHeight) top = Math.max(10, r.top - 100);

    setPos({ top, left, width });
  }, [open, side]);

  if (!text) return null;

  return (
    <>
      <button
        ref={btnRef}
        type="button"
        onClick={() => setOpen((v) => !v)}
        className="w-5 h-5 rounded-full border text-xs text-slate-400 hover:bg-white/5 dark:border-white/10"
        aria-label="Help"
        title="Help"
      >
        ?
      </button>

      {open
        ? createPortal(
            <div style={bubbleStyle} dir="auto">
              <div className="rounded-xl border border-white/10 bg-slate-950/95 text-slate-100 shadow-2xl p-3 text-xs leading-6">
                {text}
              </div>
            </div>,
            document.body
          )
        : null}
    </>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/components/ui/MarkdownRenderer.jsx
================================================================================

import ReactMarkdown from "react-markdown";

export default function MarkdownRenderer({ content }) {
  return (
    <div className="prose prose-invert max-w-none">
      <ReactMarkdown>{content}</ReactMarkdown>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/components/ui/MarkdownView.jsx
================================================================================

import ReactMarkdown from "react-markdown";

export default function MarkdownView({ content }) {
  if (!content) return null;

  return (
    <div className="prose prose-invert max-w-none prose-pre:bg-slate-950 prose-pre:border prose-pre:border-slate-800">
      <ReactMarkdown>{content}</ReactMarkdown>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/components/ui/SectionedMarkdown.jsx
================================================================================

import { useMemo } from "react";
import MarkdownBox from "./MarkdownBox";

function splitByHeadings(md) {
  const raw = String(md || "").replace(/\r\n/g, "\n");
  const lines = raw.split("\n");

  const sections = [];
  let current = { title: null, body: [] };

  const pushCurrent = () => {
    const body = current.body.join("\n").trim();
    if (!current.title && !body) return;
    sections.push({ title: current.title, body });
  };

  for (const line of lines) {
    const m = line.match(/^(#{2,6})\s+(.+)\s*$/);
    if (m) {
      if (current.title !== null || current.body.length) pushCurrent();
      current = { title: m[2].trim(), body: [] };
      continue;
    }
    current.body.push(line);
  }

  pushCurrent();

  if (!sections.length && raw.trim()) return [{ title: null, body: raw.trim() }];

  return sections.filter((s) => (s.title || s.body).toString().trim().length > 0);
}

export default function SectionedMarkdown({ markdown, content, lang = "fa", defaultTitle }) {
  const md = content ?? markdown ?? "";
  const sections = useMemo(() => splitByHeadings(md), [md]);

  if (!md || !String(md).trim()) return <MarkdownBox markdown={""} lang={lang} />;

  if (sections.length === 1 && !sections[0].title) {
    return <MarkdownBox markdown={sections[0].body} lang={lang} />;
  }

  return (
    <div className="ccg-section-grid">
      {sections.map((sec, idx) => {
        const title = sec.title || defaultTitle || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result");
        
        const isWarnTitle = /^(Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§|Ù‡Ø´Ø¯Ø§Ø±|warnings?|warning)$/i.test(String(title || "").trim());
        const cardClass = isWarnTitle ? "ccg-section-card ccg-warn" : "ccg-section-card";
return (
          <div key={`${title}-${idx}`} className={cardClass}>
            <div className="ccg-section-title">{title}</div>
            <div className="ccg-section-body">
              <MarkdownBox markdown={sec.body} lang={lang} />
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo, useState } from "react";



// CCG_TOOLRESULT_JSON_GUARD_V1
function tryParseToolJsonString(maybe) {
  const t = String(maybe || "").trim();
  if (!t) return null;
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try {
    const obj = JSON.parse(t);
    const tool = (obj && typeof obj.tool === "object") ? obj.tool : obj;
    if (!tool || typeof tool !== "object") return null;
    if (!fixedTool.primary || typeof fixedTool.primary !== "object") return null;
    if (typeof fixedTool.primary.command !== "string") return null;
    return tool;
  } catch {
    return null;
  }
}


function CopyBtn({ text }) {
  const [ok, setOk] = useState(false);

  const copy = async () => {
    try {
      await navigator.clipboard.writeText(text || "");
      setOk(true);
      setTimeout(() => setOk(false), 900);
    } catch {}
  };

  return (
    <button className="ccg-btn text-xs px-3 py-1" type="button" onClick={copy}>
      {ok ? "Copied" : "Copy"}
    </button>
  );
}

function CodeBlock({ lang, code }) {
  return (
    <div className="rounded-xl border border-[var(--border)] overflow-hidden">
      <div className="flex items-center justify-between px-3 py-2 text-xs bg-white/5">
        <span className="opacity-80">lang: {lang || "bash"}</span>
        <CopyBtn text={code} />
      </div>
      <pre className="p-3 text-sm overflow-auto"><code>{code}</code></pre>
    </div>
  );
}

export default function ToolResult({ tool }) {
  
  const fixedTool = (() => {
    const parsed = tryParseToolJsonString(fixedTool?.explanation);
    return parsed ? { ...tool, ...parsed } : tool;
  })();
const safe = useMemo(() => {
    const t = (tool && typeof tool === "object") ? tool : {};
    const primary = (t.primary && typeof t.primary === "object") ? t.primary : {};
    return {
      primary: { command: String(primary.command || ""), lang: String(primary.lang || "bash") },
      explanation: typeof t.explanation === "string" ? t.explanation : "",
      warnings: Array.isArray(t.warnings) ? t.warnings : [],
      alternatives: Array.isArray(t.alternatives) ? t.alternatives : []
    };
  }, [tool]);

  const cmd = safe.primary.command.trim();

  return (
    <div className="space-y-6">
      <div>
        <div className="text-sm font-semibold mb-2">Command</div>
        <CodeBlock lang={safe.primary.lang} code={cmd || 'echo "No command produced"'} />
      </div>

      {safe.explanation?.trim() ? (
        <div>
          <div className="text-sm font-semibold mb-2">Explanation</div>
          <div className="text-sm leading-7 opacity-90 whitespace-pre-wrap">{safe.explanation}</div>
        </div>
      ) : null}

      {safe.warnings?.length ? (
        <div>
          <div className="text-sm font-semibold mb-2">Warnings</div>
          <ul className="list-disc pl-5 text-sm leading-7 opacity-90">
            {safe.warnings.map((w, i) => <li key={i}>{w}</li>)}
          </ul>
        </div>
      ) : null}

      {safe.alternatives?.length ? (
        <div>
          <div className="text-sm font-semibold mb-2">Alternatives</div>
          <div className="space-y-4">
            {safe.alternatives.slice(0,3).map((a, i) => (
              <div key={i} className="space-y-2">
                {a?.note ? <div className="text-xs opacity-75">- {a.note}</div> : null}
                <CodeBlock lang={safe.primary.lang} code={String(a.command || "").trim()} />
              </div>
            ))}
          </div>
        </div>
      ) : null}
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_t_tdz_global_20260108_074123/client/src/components/generator/GeneratorForm.jsx
================================================================================

import { useState } from "react";
import { generateCommand } from "../../services/aiService";
import CodeBlock from "../ui/CodeBlock";
import MarkdownRenderer from "../ui/MarkdownRenderer";
import WarningBox from "../ui/WarningBox";
import { useLanguage } from "../../context/LanguageContext";

export default function GeneratorForm() {
  const { lang, isRTL } = useLanguage();
  const [request, setRequest] = useState("");
  const [os, setOs] = useState("linux");
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);

  const submit = async () => {
    setLoading(true);
    setResult(null);
    try {
      const res = await generateCommand({
        user_request: request,
        os,
        lang,
      });
      setResult(res);
    } catch (e) {
      setResult({ error: e.message });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      {/* FORM */}
      <div className="space-y-4">
        <textarea
          dir={isRTL ? "rtl" : "ltr"}
          value={request}
          onChange={(e) => setRequest(e.target.value)}
          placeholder={isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦" : "Describe your requestâ€¦"}
          className="w-full min-h-[160px] rounded-lg bg-slate-900 border border-slate-800 p-4"
        />

        <select
          value={os}
          onChange={(e) => setOs(e.target.value)}
          className="w-full rounded-lg bg-slate-900 border border-slate-800 p-3"
        >
          <option value="linux">Linux</option>
          <option value="windows">Windows</option>
          <option value="windows-server">Windows Server</option>
          <option value="mac">macOS</option>
          <option value="cisco">Cisco</option>
          <option value="mikrotik">MikroTik</option>
          <option value="fortigate">FortiGate</option>
        </select>

        <button
          onClick={submit}
          disabled={loading}
          className="w-full rounded-lg bg-blue-500 py-3 font-semibold text-black"
        >
          {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´â€¦" : "Generatingâ€¦") : (isRTL ? "ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ" : "Generate")}
        </button>
      </div>

      {/* OUTPUT */}
      <div className="rounded-xl border border-slate-800 bg-slate-900 p-4 space-y-4">
        {!result && (
          <div className="text-slate-500 text-sm">
            {isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}
          </div>
        )}

        {result?.output && (
          <MarkdownRenderer content={result.output} />
        )}

        {result?.error && (
          <WarningBox warnings={[result.error]} />
        )}
      </div>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/lock_generate_contract_v2/20260106_080311/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/lock_generate_contract_v2/20260106_080311/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Locked Tool Contract normalizer for Generator
// Guarantees (for outputType: markdown/tool):
// 1) Primary command FIRST as ONE fenced block (ONLY command-like lines)
// 2) Then: ## ØªÙˆØ¶ÛŒØ­ / ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (always present, always meaningful)
// 3) Alternatives: always 3, OS/CLI-consistent
//
// Backward-compatible exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function norm(s) { return String(s ?? "").trim(); }

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = norm(text);
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = norm(m[1] ?? "");
  const rest = norm(t.replace(m[0], ""));
  return { codeRaw, rest };
}

function looksLikeCommandLine(line) {
  const s = norm(line);
  if (!s) return false;
  if (s.length > 220) return false;
  // reject prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // allow typical command patterns
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s) || /^shutdown(\s+|$)/i.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "").split(/\r?\n/);
  const cmds = [];
  for (const ln of lines) {
    const s = norm(ln);
    if (!s) continue;
    if (looksLikeCommandLine(s)) cmds.push(s);
  }
  // keep unique, preserve order
  const seen = new Set();
  const out = [];
  for (const c of cmds) {
    const k = c.toLowerCase();
    if (!seen.has(k)) { seen.add(k); out.push(c); }
  }
  return out.join("\n").trim();
}

function detectIntentFa(userRequest) {
  const u = norm(userRequest);
  if (!u) return "";
  if (u.includes("Ø®Ø§Ù…ÙˆØ´") || u.includes("shutdown") || u.includes("turn off")) return "shutdown";
  if (u.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || u.includes("reboot") || u.includes("restart")) return "restart";
  return "";
}

function windowsTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "shutdown /s /t 60",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¯Ø± CMD Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ Ø­Ø³Ø§Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª (Ø¢Ù¾Ø¯ÛŒØª/Ø¨Ú©Ø§Ù¾)ØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø±Ø§ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù†ÛŒØ¯.",
        "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø­ØªÙ…Ø§Ù‹ Ø¯Ø³ØªÙˆØ± Ù„ØºÙˆ Ø±Ø§ Ø¨Ø¯Ø§Ù†ÛŒØ¯."
      ],
      alternatives: [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "shutdown /s /t 300", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
      ],
    };
  }
  // restart
  return {
    primary: "shutdown /r /t 0",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¯Ø± CMDØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³/ProductionØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯."
    ],
    alternatives: [
      { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
      { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      { command: "shutdown /r /f /t 0", note: "Ø±ÛŒØ³ØªØ§Ø±Øª + Ø¨Ø³ØªÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" }
    ],
  };
}

function linuxTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "sudo shutdown -h +1",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
        "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "sudo shutdown -h now", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }
      ],
    };
  }
  return {
    primary: "sudo reboot",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ÛŒØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
    ],
    alternatives: [
      { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ systemd" },
      { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
      { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
    ],
  };
}

function buildMarkdown(tool) {
  const p = tool?.primary?.command ? tool.primary.command : "";
  const lang = tool?.primary?.lang || "bash";

  const fence = p ? "```" + lang + "\n" + p + "\n```\n" : "";

  const exp = norm(tool?.explanation) || "â€”";
  const warns = Array.isArray(tool?.warnings) && tool.warnings.length ? tool.warnings : ["Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ù†ÛŒØ§Ø² Ø´Ù…Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø§Ø³Øª."];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives.slice(0,3) : [];

  const warnMd = warns.map(w => `- ${norm(w)}`).join("\n");
  const altMd = alts.map(a => {
    const note = norm(a?.note) || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = norm(a?.command);
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `${fence}
## ØªÙˆØ¶ÛŒØ­
${exp}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${warnMd}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
${altMd}
`.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType }) {
  const OT = String(outputType || "markdown").toLowerCase();
  const CLI = String(cli || "bash");
  const OS = String(os || "linux").toLowerCase();
  const lang = fenceLangFromCli(CLI, OT);

  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const primaryFromBlock = normalizeCodeToCommands(codeRaw);

  // intent + template fallback
  const intent = detectIntentFa(userRequest);

  let tpl = null;
  if (OS.includes("win") || lang === "cmd" || String(CLI).toLowerCase().includes("cmd")) {
    tpl = windowsTemplates(intent || "restart");
  } else {
    tpl = linuxTemplates(intent || "restart");
  }

  // choose primary: prefer extracted command if it looks valid and OS-consistent
  let primary = primaryFromBlock || tpl.primary;

  // very basic OS consistency guard for alternatives:
  const isWin = (OS.includes("win") || lang === "cmd");
  if (isWin) {
    // if extracted command contains sudo/systemctl, it's wrong for cmd -> use template
    if (/sudo|systemctl|shutdown\s+-/i.test(primary)) primary = tpl.primary;
  } else {
    // linux: if extracted contains windows-style /s /t, it's wrong -> use template
    if (/shutdown\s+\/[srat]\b/i.test(primary) || /\bnet\s+user\b/i.test(primary)) primary = tpl.primary;
  }

  // explanation: keep model text if it exists, otherwise template. Keep beginner a bit more instructive.
  let explanation = norm(rest);
  if (!explanation) explanation = tpl.explanation;

  if (String(knowledgeLevel || "").toLowerCase().includes("begin")) {
    // add minimal steps, but keep short
    if (isWin) explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: CMD Ø±Ø§ Ø¨Ø§ Win+R â†’ cmd Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
    else explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
  } else {
    // keep concise for intermediate/pro
    explanation = explanation.split("\n").slice(0, 6).join("\n").trim() || tpl.explanation;
  }

  const tool = {
    primary: { command: primary, lang },
    explanation,
    warnings: tpl.warnings,
    alternatives: tpl.alternatives.map(a => ({ command: a.command, note: a.note })),
  };

  const markdown = buildMarkdown(tool);

  // For pure command/script output types, return only copy-ready primary fence (but still attach tool)
  const onlyFence = "```" + lang + "\n" + primary + "\n```" + "\n";

  return {
    tool,
    markdown: (OT === "command" || OT === "script") ? onlyFence : markdown,
  };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/stabilize_tool_contract/20260103_073656/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool-Style Output normalizer (Generator)
// Guarantees (for outputType: markdown/tool):
// 1) FIRST: one fenced code block containing ONLY command lines
// 2) Then: ## ØªÙˆØ¶ÛŒØ­  / ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (fills missing sections)
// Backward-compatible exports:
// - formatToolResponse
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 200) return false;
  // reject prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // starts with sudo/tool
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean);

  const cmds = [];
  for (const l of lines) {
    // stop if line becomes prose-ish
    if (!looksLikeCommand(l)) continue;
    cmds.push(l);
  }
  return cmds.join("\n").trim();
}

function heuristicsForAlternatives(primaryCmd, { os = "linux" } = {}) {
  const cmd = String(primaryCmd || "").toLowerCase();
  const alts = [];

  // reboot/shutdown
  if (cmd.includes("reboot")) {
    alts.push({ note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø¨Ø§ shutdown", command: "sudo shutdown -r now" });
    alts.push({ note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡ (Û± Ø¯Ù‚ÛŒÙ‚Ù‡)", command: "sudo shutdown -r +1" });
    alts.push({ note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ systemctl", command: "sudo systemctl reboot" });
  } else if (cmd.includes("shutdown")) {
    alts.push({ note: "Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† ÙÙˆØ±ÛŒ", command: "sudo poweroff" });
    alts.push({ note: "Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø¨Ø§ systemctl", command: "sudo systemctl poweroff" });
    alts.push({ note: "Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡ (Û± Ø¯Ù‚ÛŒÙ‚Ù‡)", command: "sudo shutdown +1" });
  }

  // nginx status
  if (cmd.includes("nginx") && cmd.includes("status")) {
    alts.length = 0;
    alts.push({ note: "ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ systemctl", command: "systemctl status nginx" });
    alts.push({ note: "Ú†Ú© Ø³Ø±ÛŒØ¹ ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„", command: "systemctl is-active nginx" });
    alts.push({ note: "Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±", command: "journalctl -u nginx -n 50 --no-pager" });
  }

  // default filler if we still have <3
  while (alts.length < 3) {
    alts.push({ note: "â€”", command: "â€”" });
  }
  return alts.slice(0, 3);
}

function ensureSections(restText, primaryCmd, ctx) {
  const t = String(restText || "").trim();
  const hasExplain = /##\s*ØªÙˆØ¶ÛŒØ­/.test(t);
  const hasWarn = /##\s*Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§/.test(t);
  const hasAlt = /##\s*Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§/.test(t);

  // keep existing content if already structured
  if (hasExplain && hasWarn && hasAlt) return t;

  const explain = hasExplain ? "" : "## ØªÙˆØ¶ÛŒØ­\n- ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ø§ÛŒÙ†Ú©Ù‡ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.\n";
  const warnings = hasWarn ? "" : "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n- Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.\n- Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¯Ø§Ø±Ø¯ (Ù…Ù…Ú©Ù† Ø§Ø³Øª sudo Ø¨Ø®ÙˆØ§Ù‡Ø¯).\n";
  const alts = heuristicsForAlternatives(primaryCmd, ctx);
  const altBlock = hasAlt ? "" : (
    "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n" +
    `1) ${alts[0].note}\n\`\`\`${ctx.fenceLang}\n${alts[0].command}\n\`\`\`\n\n` +
    `2) ${alts[1].note}\n\`\`\`${ctx.fenceLang}\n${alts[1].command}\n\`\`\`\n\n` +
    `3) ${alts[2].note}\n\`\`\`${ctx.fenceLang}\n${alts[2].command}\n\`\`\`\n`
  );

  const body = t ? (t + "\n\n") : "";
  return [explain, body, warnings, "\n", altBlock].join("").trim();
}

export function formatToolResponse({ outputType = "markdown", text = "", cli = "bash", os = "linux" } = {}) {
  const ot = String(outputType || "").toLowerCase();
  const fenceLang = fenceLangFromCli(cli, ot);

  const raw = String(text ?? "").trim();
  const { codeRaw, rest } = splitFirstCodeBlock(raw);

  // Pick primary command
  let primary = normalizeCodeToCommands(codeRaw);

  // If no code block, try take first command-like line from text
  if (!primary) {
    const lines = raw.split("\n").map(l => l.trim()).filter(Boolean);
    const firstCmd = lines.find(looksLikeCommand) || "";
    primary = firstCmd;
  }

  // For outputType=command/script: just return fenced block (copyable)
  if (ot === "command" || ot === "script") {
    const only = primary ? primary : raw;
    return `\`\`\`${fenceLang}\n${only.trim()}\n\`\`\``;
  }

  // For markdown/tool: full template
  const codeBlock = `\`\`\`${fenceLang}\n${(primary || "â€”").trim()}\n\`\`\``;
  const fullRest = ensureSections(rest, primary, { fenceLang, os });

  return `${codeBlock}\n\n${fullRest}`.trim();
}

// Alias for older code
export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_formatter_json_leak_20260107_144454/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract Normalizer (Generator + Explain)
//
// Returns ALWAYS:
//  - tool: { primary:{command,lang}, explanation, warnings[], alternatives[] }
//  - markdown: string (strict template)
//  - output: markdown (alias)
//
// If rawText is JSON (e.g. {"tool":...,"markdown":...}) => unwrap safely.
// Explain mode: if forcedCommand provided, primary.command MUST stay exactly that.
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh" || c === "powershell") return "powershell";
  if (c.includes("cmd") || c === "cmd") return "cmd";
  return "bash";
}

function tryParseJSONMaybe(text) {
  const t = String(text || "").trim();
  if (!t) return null;
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try { return JSON.parse(t); } catch { return null; }
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  if (/^(explain|context|note|warning|tip)\b/i.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizeCommandFromText(rawText) {
  const { codeRaw } = splitFirstCodeBlock(rawText);
  if (codeRaw) {
    const lines = codeRaw.split("\n").map(l => l.trim()).filter(Boolean);
    const cmdLines = lines.filter(looksLikeCommand);
    if (cmdLines.length) return cmdLines.join("\n");
  }
  const lines = String(rawText || "").split("\n").map(l => l.trim());
  for (const l of lines) if (looksLikeCommand(l)) return l;
  return "";
}

function pickWarnings(rawText, os, cli) {
  const w = [];
  w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.");
  if (String(rawText || "").toLowerCase().includes("ssh")) w.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø´ÙˆØ¯.");
  if (String(os || "").toLowerCase().includes("linux")) w.push("Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ sudo Ù†ÛŒØ§Ø² Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.");
  if (String(cli || "").toLowerCase().includes("cmd")) w.push("Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù…ÙˆØ§Ø±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Administrator Ø§Ø³Øª.");
  return w;
}

function ensure3Alternatives(alts) {
  const out = Array.isArray(alts) ? alts.filter(a => a && a.command) : [];
  while (out.length < 3) out.push({ command: "â€”", note: "â€”" });
  return out.slice(0, 3);
}

function buildMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const primary = String(tool?.primary?.command || "").trim() || 'echo "No command produced"';
  const explanation = String(tool?.explanation || "").trim() || "â€”";
  const warnings = (Array.isArray(tool?.warnings) && tool.warnings.length) ? tool.warnings : ["â€”"];
  const alternatives = ensure3Alternatives(tool?.alternatives);

  const warnLines = warnings.map(x => `- ${String(x).trim()}`).join("\n");
  const altBlocks = alternatives.map(a => {
    const note = String(a?.note || "").trim() || "â€”";
    const cmd = String(a?.command || "").trim() || "â€”";
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `\`\`\`${lang}\n${primary}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${explanation}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks}\n`;
}

export function formatToolResponse(opts = {}) {
  // 1) raw input
  let rawText = String(opts.rawText ?? opts.text ?? "").trim();

  // 2) If rawText is JSON with tool/markdown => unwrap
  const parsed = tryParseJSONMaybe(rawText);
  if (parsed && typeof parsed === "object") {
    // common shapes:
    // { tool:{...}, markdown:"..." } OR { output:{tool,markdown} }
    const directTool = parsed.tool && typeof parsed.tool === "object" ? parsed.tool : null;
    const directMd = typeof parsed.markdown === "string" ? parsed.markdown : null;

    const nested = parsed.output && typeof parsed.output === "object" ? parsed.output : null;
    const nestedTool = nested?.tool && typeof nested.tool === "object" ? nested.tool : null;
    const nestedMd = typeof nested?.markdown === "string" ? nested.markdown : null;

    const toolObj = directTool || nestedTool;
    const md = directMd || nestedMd;

    if (toolObj && md) {
      // Enforce forcedCommand if in explain
      if (opts.forcedCommand) {
        toolObj.primary = toolObj.primary || {};
        toolObj.primary.command = String(opts.forcedCommand).trim();
      }
      return { tool: toolObj, markdown: md, output: md };
    }
    // If it was JSON but not our contract, keep going
  }

  const cli = opts.cli || "bash";
  const outputType = opts.outputType || "tool";
  const lang = fenceLangFromCli(cli, outputType);

  const forced = String(opts.forcedCommand || "").trim();
  const primaryCommand = forced || normalizeCommandFromText(rawText) || 'echo "No command produced"';

  const { rest } = splitFirstCodeBlock(rawText);
  const explanation = (rest && rest.length < 6000) ? rest : "â€”";

  const tool = {
    primary: { command: primaryCommand, lang },
    explanation,
    warnings: pickWarnings(rawText, opts.os, cli),
    alternatives: Array.isArray(opts.alternatives) ? opts.alternatives : []
  };

  if (!tool.alternatives.length) {
    const c = String(cli || "").toLowerCase();
    if (c.includes("cmd")) {
      tool.alternatives = [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† ÙÙˆØ±ÛŒ" },
        { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø¹Ø¯ Ø§Ø² 60 Ø«Ø§Ù†ÛŒÙ‡" },
      ];
    } else if (String(opts.os || "").toLowerCase().includes("linux")) {
      tool.alternatives = [
        { command: "sudo shutdown -h +1", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      ];
    } else {
      tool.alternatives = [
        { command: primaryCommand, note: "Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ±" },
        { command: primaryCommand, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Û²" },
        { command: primaryCommand, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Û³" },
      ];
    }
  }

  const markdown = buildMarkdown(tool);
  return { tool, markdown, output: markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/final_format_lock/20260103_081321/client/src/components/ui/SectionedMarkdown.jsx
================================================================================

import { useMemo } from "react";
import MarkdownBox from "./MarkdownBox";

function splitByHeadings(md) {
  const raw = String(md || "").replace(/\r\n/g, "\n");
  const lines = raw.split("\n");

  const sections = [];
  let current = { title: null, body: [] };

  const pushCurrent = () => {
    const body = current.body.join("\n").trim();
    if (!current.title && !body) return;
    sections.push({ title: current.title, body });
  };

  for (const line of lines) {
    const m = line.match(/^(#{2,6})\s+(.+)\s*$/);
    if (m) {
      if (current.title !== null || current.body.length) pushCurrent();
      current = { title: m[2].trim(), body: [] };
      continue;
    }
    current.body.push(line);
  }

  pushCurrent();

  if (!sections.length && raw.trim()) return [{ title: null, body: raw.trim() }];

  return sections.filter((s) => (s.title || s.body).toString().trim().length > 0);
}

export default function SectionedMarkdown({ markdown, content, lang = "fa", defaultTitle }) {
  const md = content ?? markdown ?? "";
  const sections = useMemo(() => splitByHeadings(md), [md]);

  if (!md || !String(md).trim()) return <MarkdownBox markdown={""} lang={lang} />;

  if (sections.length === 1 && !sections[0].title) {
    return <MarkdownBox markdown={sections[0].body} lang={lang} />;
  }

  return (
    <div className="ccg-section-grid">
      {sections.map((sec, idx) => {
        const title = sec.title || defaultTitle || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result");
        
        const isWarnTitle = /^(Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§|Ù‡Ø´Ø¯Ø§Ø±|warnings?|warning)$/i.test(String(title || "").trim());
        const cardClass = isWarnTitle ? "ccg-section-card ccg-warn" : "ccg-section-card";
return (
          <div key={`${title}-${idx}`} className={cardClass}>
            <div className="ccg-section-title">{title}</div>
            <div className="ccg-section-body">
              <MarkdownBox markdown={sec.body} lang={lang} />
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/final_format_lock/20260103_081321/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Stable tool-style formatter (Generator)
// Exports (backward compatible):
// - formatToolResponse
// - formatOutput (alias)
//
// Rules:
// - For outputType=command/script: return only ONE fenced code block (copy-ready)
// - For markdown/tool: return:
//   1) Primary command fenced block
//   2) ## ØªÙˆØ¶ÛŒØ­
//   3) ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
//   4) ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (3)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 200) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizeCommandLines(codeRaw) {
  const lines = String(codeRaw || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const cmd = lines.filter(looksLikeCommand);
  return cmd.length ? cmd.join("\n") : "";
}

function guessPrimaryCommandFromText(text) {
  const t = String(text || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const first = t.find(looksLikeCommand);
  return first || "";
}

function ensureSections(rest, langFa = true) {
  let r = String(rest || "").trim();

  const hasExplain = /(^|\n)##\s*(ØªÙˆØ¶ÛŒØ­|Explanation)\b/i.test(r);
  const hasWarn = /(^|\n)##\s*(Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§|Warnings?)\b/i.test(r);
  const hasAlt = /(^|\n)##\s*(Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§|Alternatives?)\b/i.test(r);

  if (!hasExplain) r = `## ${langFa ? "ØªÙˆØ¶ÛŒØ­" : "Explanation"}\n- (ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯)\n\n` + r;
  if (!hasWarn) r = r + `\n\n## ${langFa ? "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "Warnings"}\n- (Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯)\n`;
  if (!hasAlt) r = r + `\n\n## ${langFa ? "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" : "Alternatives"}\n- (Ø³Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©ÙˆØªØ§Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯)\n`;

  return r.trim();
}

export function formatToolResponse({ outputType, text, cli = "bash", lang = "fa" } = {}) {
  const ot = String(outputType || "").toLowerCase();
  const raw = String(text ?? "").trim();

  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  const primary = normalizeCommandLines(codeRaw) || guessPrimaryCommandFromText(raw);

  const fenceLang = fenceLangFromCli(cli, ot);

  // command/script => only fenced code (copy-ready)
  if (ot === "command" || ot === "script") {
    const cmd = primary || "";
    return cmd ? `\`\`\`${fenceLang}\n${cmd}\n\`\`\`` : raw;
  }

  // markdown/tool => tool template + keep rest (but make sure sections exist)
  const langFa = String(lang || "").toLowerCase().startsWith("fa");
  const cmd = primary || "";
  const body = ensureSections(rest, langFa);

  if (!cmd) return body; // fallback if we couldn't detect command
  return `\`\`\`${fenceLang}\n${cmd}\n\`\`\`\n\n${body}`;
}

// alias for older code
export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_object_object_20260103_095046/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Tool Contract for Generator (stable, non-chatty UI)
// Output (tool):
// {
//   primary: { command, lang },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command, note }, ...] (always 3)
// }
// Also returns markdown (same template) as fallback.
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false; // prose ending
  // starts with sudo/tool-ish token
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizePrimaryCommand(rawText, cliLang) {
  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  let cmd = "";

  if (codeRaw) {
    const lines = codeRaw.split("\n").map((x) => x.trim()).filter(Boolean);
    const cmdLines = lines.filter(looksLikeCommand);
    cmd = (cmdLines.length ? cmdLines : lines.slice(0, 1)).join("\n").trim();
  }

  if (!cmd) {
    // fallback: first command-like line from whole text
    const lines = String(rawText || "").split("\n").map((x) => x.trim());
    const first = lines.find(looksLikeCommand);
    if (first) cmd = first;
  }

  // last fallback
  if (!cmd) cmd = cliLang === "powershell" ? "Get-Help <command>" : "man <command>";

  return { cmd, restText: rest || "" };
}

function pickDefaultsByHeuristic(cmd, cliLang, os, userRequest) {
  const c = String(cmd || "").toLowerCase();
  const req = String(userRequest || "").toLowerCase();

  // defaults
  let explanation = "";
  let warnings = [];
  let alternatives = [];

  const isWindowsCmd = cliLang === "cmd";
  const isPowershell = cliLang === "powershell";

  // --- Reboot / shutdown
  if (c.includes("reboot") || c.includes("shutdown") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || req.includes("reboot")) {
    explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
    warnings = [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
    ];
    alternatives = [
      { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ systemd" },
      { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
      { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
    ];
    return { explanation, warnings, alternatives };
  }

  // --- Linux service restart
  if (c.startsWith("systemctl") && (c.includes("restart") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³"))) {
    explanation = "Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ§ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯ ÛŒØ§ Ù…Ø´Ú©Ù„ Ù…ÙˆÙ‚Øª Ø¨Ø±Ø·Ø±Ù Ø´ÙˆØ¯.";
    warnings = [
      "Ø±ÛŒØ³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ù‚Ø·Ø¹ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø´ÙˆØ¯.",
      "Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ stateful Ø§Ø³ØªØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
    ];
    alternatives = [
      { command: cmd.replace(/\brestart\b/i, "status"), note: "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ù‚Ø¯Ø§Ù…ØŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³" },
      { command: cmd.replace(/\brestart\b/i, "reload"), note: "Ø§Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´ÙˆØ¯ØŒ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹ Ú©Ø§Ù…Ù„" },
      { command: cmd.replace(/\brestart\b/i, "try-restart"), note: "ÙÙ‚Ø· Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø§Ø´Ø¯" },
    ];
    return { explanation, warnings, alternatives };
  }

  // --- Windows local users
  if ((req.includes("ÛŒÙˆØ²Ø±") || req.includes("Ú©Ø§Ø±Ø¨Ø±") || req.includes("user")) && (c.startsWith("net user") || c === "net user")) {
    explanation = "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø­Ù„ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.";
    warnings = [
      "Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ DomainØŒ Ø®Ø±ÙˆØ¬ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø§Ù…Ù†Ù‡ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯.",
      "Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø®ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Administrator Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯."
    ];
    alternatives = [
      { command: "net user | find /c /v \"\"", note: "ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø´Ù…Ø§Ø±Ø´ Ø®Ø·ÙˆØ· Ø®Ø±ÙˆØ¬ÛŒ)" },
      { command: "powershell -Command \"Get-LocalUser | Select -Expand Name\"", note: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ PowerShell" },
      { command: "whoami", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ù†ÛŒØ³ØªØŒ Ø§Ù…Ø§ Ø±Ø§ÛŒØ¬)" },
    ];
    return { explanation, warnings, alternatives };
  }

  // --- Fallback generic
  explanation = "Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.";
  warnings = [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø±ÙˆÛŒ Ø³ÛŒØ³ØªÙ…/Ù…Ø­ÛŒØ· Ø¯Ø±Ø³Øª Ù‡Ø³ØªÛŒØ¯.",
    "Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø§Ù„Ø§ØŒ Ø§Ø² sudo/Administrator Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."
  ];
  alternatives = [
    { command: cmd, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (Ø§ØµÙ„ÛŒ)" },
    { command: isWindowsCmd ? "help" : "--help", note: "Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø¨Ø²Ø§Ø±" },
    { command: isWindowsCmd ? "where <command>" : "which <command>", note: "Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ÛŒØ±/ÙˆØ¬ÙˆØ¯ Ø¯Ø³ØªÙˆØ±" },
  ];
  return { explanation, warnings, alternatives };
}

function renderMarkdown(primary, explanation, warnings, alternatives, langTag) {
  const altMd = alternatives.map((a, i) =>
    `- ${a.note}\n\n\`\`\`${langTag}\n${a.command}\n\`\`\``
  ).join("\n\n");

  const warnMd = warnings.map((w) => `- ${w}`).join("\n");

  return `\`\`\`${langTag}\n${primary}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${explanation}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnMd}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altMd}\n`;
}

export function formatToolResponse({ text, cli = "bash", outputType = "markdown", os = "linux", lang = "fa", userRequest = "" }) {
  const langTag = fenceLangFromCli(cli, outputType);
  const raw = String(text ?? "").trim();

  // Primary command extraction
  const { cmd, restText } = normalizePrimaryCommand(raw, langTag);

  // Try to reuse some explanation from model if it exists (short), else heuristic
  const heuristic = pickDefaultsByHeuristic(cmd, langTag, os, userRequest);

  let explanation = heuristic.explanation;
  if (restText && restText.length >= 10 && restText.length <= 420) {
    // use short remainder as explanation if it looks like prose
    explanation = restText.replace(/^#+\s*/g, "").trim() || explanation;
  }

  // ensure always 3 alternatives
  const alternatives = (heuristic.alternatives || []).slice(0, 3);
  while (alternatives.length < 3) alternatives.push({ command: cmd, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });

  const tool = {
    primary: { command: cmd, lang: langTag },
    explanation,
    warnings: (heuristic.warnings || []).length ? heuristic.warnings : ["Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."],
    alternatives
  };

  const markdown = renderMarkdown(
    tool.primary.command,
    tool.explanation,
    tool.warnings,
    tool.alternatives,
    tool.primary.lang
  );

  return { tool, markdown };
}

// Back-compat alias
export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/generator_toolstyle_stable/20260102_140213/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Ù‡Ø¯Ù: Ø®Ø±ÙˆØ¬ÛŒ Generator Ø­Ø§Ù„Øª "Ø§Ø¨Ø²Ø§Ø±ÛŒ/DevOps" Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ (Ù†Ù‡ Ú†Øªâ€ŒÚ¯ÙˆÙ†Ù‡)
// - Ø§ÙˆÙ„: ÛŒÚ© code fence Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (command/script)
// - Ø¨Ø¹Ø¯: Ø¨Ù‚ÛŒÙ‡ Ù…ØªÙ† (Explanation/Warn/Alternatives) Ø­ÙØ¸ Ø´ÙˆØ¯
// - Ù‡Ù…Ú†Ù†ÛŒÙ†: ÛŒÚ© hint Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÙ…Øª Ø¨Ù‡ user_request Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function isCommandLike(line) {
  const s = String(line || "").trim();
  if (!s) return False;
  # dummy
}

function pickFirstCommandLine(text) {
  const lines = String(text ?? "").split("\n").map(l => l.trim()).filter(Boolean);
  if (!lines.length) return "";
  const re = /^(?:sudo\s+)?[a-zA-Z0-9_./-]+(?:\s+[-a-zA-Z0-9_./:=,"'\\|<>]+)*$/;
  for (const ln of lines) {
    // Ù†Ø°Ø§Ø± Ø¬Ù…Ù„Ù‡â€ŒÛŒ ÙØ§Ø±Ø³ÛŒ/ØªÙˆØ¶ÛŒØ­ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† command ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
    const hasLatin = /[a-zA-Z0-9]/.test(ln);
    if (hasLatin && re.test(ln) && ln.length <= 180) return ln;
  }
  // fallback: Ø§ÙˆÙ„ÛŒÙ† Ø®Ø·ÛŒ Ú©Ù‡ Ù„Ø§ØªÛŒÙ† Ø¯Ø§Ø´Øª
  for (const ln of lines) {
    if (/[a-zA-Z0-9]/.test(ln)) return ln;
  }
  return lines[0];
}

function removeOneLine(text, lineToRemove) {
  const t = String(text ?? "");
  const esc = reEscape(lineToRemove);
  const rx = new RegExp("^\\s*" + esc + "\\s*$", "m");
  return t.replace(rx, "").trim();
}

function reEscape(s) {
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

// Hint to force tool-style output from stored prompt/model
export function toolFormatHint({ userRequest, body }) {
  const u = String(userRequest ?? "").trim();
  const b = (body && typeof body === "object") ? body : {};
  const mode = String(b.mode ?? "generate").toLowerCase();
  const outputType = String(b.outputType ?? "markdown").toLowerCase();
  const cli = String(b.cli ?? "bash");
  const langFence = fenceLangFromCli(cli, outputType);

  // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø¬Ù†Ø±ÛŒØª (Ù†Ù‡ compare/error)
  if (["compare", "error", "explain"].includes(mode)) return u;

  // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ hint Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø²Ù†
  if (u.includes("[OUTPUT FORMAT") || u.includes("[ÙØ±Ù…Øª Ø®Ø±ÙˆØ¬ÛŒ")) return u;

  const hint = [
    "[OUTPUT FORMAT - STRICT TOOL MODE]",
    "No greetings. No chatty tone. Be concise & operational.",
    "Reply in Markdown.",
    "Structure MUST be exactly:",
    "1) One fenced code block FIRST (only the command/script), language: " + langFence,
    "2) ## Explanation (2-5 bullets)",
    "3) ## Warnings (0-5 bullets; if none: - N/A)",
    "4) ## Alternatives (1-4 bullets; if none: - N/A)",
    "Important: Headings must be exactly: Explanation / Warnings / Alternatives.",
    "[/OUTPUT FORMAT]"
  ].join("\\n");

  return hint + "\\n\\n" + u;
}

// Main formatter (keeps rest text, only normalizes first code fence)
export function formatOutput({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase();
  const raw = String(text ?? "").trim();
  if (!raw) return "";

  // only enforce for tool-ish outputs
  if (!["command", "script", "markdown"].includes(ot)) return raw;

  const langFence = fenceLangFromCli(cli, ot);

  // If already has a code block -> normalize the first one
  const { code, rest } = splitFirstCodeBlock(raw);
  if (code) {
    const fenced = "```" + langFence + "\\n" + code.trim() + "\\n```";
    return rest ? (fenced + "\\n\\n" + rest) : fenced;
  }

  // No code block exists: extract command line for command/markdown
  const cmd = pickFirstCommandLine(raw);

  // For script: keep as multi-line until first blank line
  if (ot === "script") {
    const parts = raw.split("\\n\\n", 1);
    const scriptBlock = parts[0].trim();
    const rest2 = raw.slice(scriptBlock.length).trim();
    const fenced = "```" + langFence + "\\n" + scriptBlock + "\\n```";
    return rest2 ? (fenced + "\\n\\n" + rest2) : fenced;
  }

  // command/markdown: only one-liner in code fence
  const rest2 = removeOneLine(raw, cmd);
  const fenced = "```" + langFence + "\\n" + cmd.trim() + "\\n```";
  return rest2 ? (fenced + "\\n\\n" + rest2) : fenced;
}

// Backward-compatible export name (in case older code imports it)
export const formatToolResponse = formatOutput;

================================================================================
FILE: .ccg_backups/day2_other_platform_20260107_052815/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/final_tool_format_20260103_065450/client/src/components/ui/SectionedMarkdown.jsx
================================================================================

import { useMemo } from "react";
import MarkdownBox from "./MarkdownBox";

function splitByHeadings(md) {
  const raw = String(md || "").replace(/\r\n/g, "\n");
  const lines = raw.split("\n");

  const sections = [];
  let current = { title: null, body: [] };

  const pushCurrent = () => {
    const body = current.body.join("\n").trim();
    if (!current.title && !body) return;
    sections.push({ title: current.title, body });
  };

  for (const line of lines) {
    const m = line.match(/^(#{2,6})\s+(.+)\s*$/);
    if (m) {
      if (current.title !== null || current.body.length) pushCurrent();
      current = { title: m[2].trim(), body: [] };
      continue;
    }
    current.body.push(line);
  }

  pushCurrent();

  if (!sections.length && raw.trim()) return [{ title: null, body: raw.trim() }];

  return sections.filter((s) => (s.title || s.body).toString().trim().length > 0);
}

export default function SectionedMarkdown({ markdown, content, lang = "fa", defaultTitle }) {
  const md = content ?? markdown ?? "";
  const sections = useMemo(() => splitByHeadings(md), [md]);

  if (!md || !String(md).trim()) return <MarkdownBox markdown={""} lang={lang} />;

  if (sections.length === 1 && !sections[0].title) {
    return <MarkdownBox markdown={sections[0].body} lang={lang} />;
  }

  return (
    <div className="ccg-section-grid">
      {sections.map((sec, idx) => {
        const title = sec.title || defaultTitle || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result");
        return (
          <div key={`${title}-${idx}`} className="ccg-section-card">
            <div className="ccg-section-title">{title}</div>
            <div className="ccg-section-body">
              <MarkdownBox markdown={sec.body} lang={lang} />
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/final_tool_format_20260103_065450/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// CCG Tool Contract (stable):
// - primary command (string) (no prose inside)
// - explanation (string)
// - warnings (array of strings)
// - alternatives (array of {command, note})
// Backward compatible exports:
// - formatToolResponse
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 180) return false;
  // reject obvious prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // reject lines that contain a lot of Persian text
  if (/[\u0600-\u06FF]{3,}/.test(s)) return false;
  // allow pipes/redirects and typical flags
  if (/^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s)) return true;
  return false;
}

function normalizeCommandLines(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean);

  const cmds = [];
  for (const l of lines) {
    // strip leading "$"
    const line = l.replace(/^\$\s*/, "").trim();
    if (looksLikeCommand(line)) cmds.push(line);
  }
  // de-dup preserving order
  return [...new Set(cmds)];
}

function extractSectionsByH2(text) {
  // Supports Persian + English headings, e.g. "## ØªÙˆØ¶ÛŒØ­", "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", ...
  const t = String(text || "").trim();
  const re = /^##\s+(.+?)\s*$/gm;
  const idx = [];
  let m;
  while ((m = re.exec(t)) !== null) {
    idx.push({ title: m[1].trim(), pos: m.index });
  }
  if (idx.length === 0) return { pre: t, sections: {} };

  const sections = {};
  for (let i = 0; i < idx.length; i++) {
    const start = idx[i].pos;
    const end = (i + 1 < idx.length) ? idx[i + 1].pos : t.length;
    const block = t.slice(start, end);
    const title = idx[i].title.toLowerCase();
    const body = block.replace(/^##\s+.+?\s*$/m, "").trim();
    sections[title] = body;
  }
  const pre = t.slice(0, idx[0].pos).trim();
  return { pre, sections };
}

function pickSection(sections, keys) {
  for (const k of Object.keys(sections)) {
    for (const want of keys) {
      if (k.includes(want)) return sections[k];
    }
  }
  return "";
}

function bulletsFromText(txt) {
  const t = String(txt || "").trim();
  if (!t) return [];
  const lines = t.split("\n").map(x => x.trim()).filter(Boolean);
  const out = [];
  for (const l of lines) {
    const s = l.replace(/^[-*â€¢]\s*/, "").trim();
    if (!s) continue;
    out.push(s);
  }
  return out;
}

function guessDefaultWarnings(primaryCmd) {
  const c = String(primaryCmd || "").toLowerCase();
  const w = [];

  if (/(^|\s)(reboot|shutdown)(\s|$)/.test(c)) {
    w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§/Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.");
    w.push("Ø§Ú¯Ø± Ø§Ø² Ø·Ø±ÛŒÙ‚ SSH ÙˆØµÙ„ Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØµÙ„ Ø´ÙˆÛŒØ¯.");
    w.push("Ø¯Ø± Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ÛŒ (Production) Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.");
  } else if (/rm\s+-rf\b/.test(c) || /\brm\b/.test(c)) {
    w.push("Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØºÛŒØ±Ù‚Ø§Ø¨Ù„â€ŒØ¨Ø§Ø²Ú¯Ø´Øª Ø¨Ø§Ø´Ø¯Ø› Ù…Ø³ÛŒØ±Ù‡Ø§ Ø±Ø§ Ø¯Ù‚ÛŒÙ‚ Ú†Ú© Ú©Ù†ÛŒØ¯.");
    w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°ÙØŒ ÛŒÚ© Ù„ÛŒØ³Øªâ€ŒÚ¯ÛŒØ±ÛŒ (ls) ÛŒØ§ dry-run Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.");
  } else if (/\bufw\b/.test(c) || /\biptables\b/.test(c)) {
    w.push("ØªØºÛŒÛŒØ± ÙØ§ÛŒØ±ÙˆØ§Ù„ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ SSH Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†Ø¯Ø› Ø­ØªÙ…Ø§Ù‹ Ø±ÙˆÙ„ SSH Ø±Ø§ Ù‚Ø¨Ù„Ø´ Ù…Ø¬Ø§Ø² Ú©Ù†ÛŒØ¯.");
  } else if (/\bsystemctl\b/.test(c) && /\brestart\b/.test(c)) {
    w.push("Restart Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ù‚Ø·Ø¹ Ú©ÙˆØªØ§Ù‡ Ø³Ø±ÙˆÛŒØ³ Ø´ÙˆØ¯Ø› Ø¯Ø± Ø²Ù…Ø§Ù† Ù…Ù†Ø§Ø³Ø¨ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
  } else {
    w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ø¨Ø§ Ù†ÛŒØ§Ø² Ø´Ù…Ø§ ØªØ·Ø§Ø¨Ù‚ Ø¯Ø§Ø±Ø¯ Ùˆ Ø±ÙˆÛŒ Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ø³Øª Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
    w.push("Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ sudo Ø¯Ø§Ø±Ø¯ØŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ù…Ø¬Ø§Ø² Ø¨Ø§Ø´Ø¯.");
  }
  return w;
}

function guessAlternatives(primaryCmd) {
  const c = String(primaryCmd || "").trim();
  const cl = c.toLowerCase();

  // Reboot family
  if (/(^|\s)(reboot)(\s|$)/.test(cl) || /shutdown\s+-r/.test(cl) || /systemctl\s+reboot/.test(cl)) {
    return [
      { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø±ÙˆÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ systemd" },
      { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø¨Ø§ shutdown" },
      { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ± (Ø¨Ø±Ø§ÛŒ ÙØ±ØµØª Ø°Ø®ÛŒØ±Ù‡)" },
    ];
  }

  // nginx status example
  if (/\bnginx\b/.test(cl) && /\bstatus\b/.test(cl)) {
    return [
      { command: "systemctl status nginx", note: "Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³ (systemd)" },
      { command: "service nginx status", note: "Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± (service)" },
      { command: "journalctl -u nginx -n 50 --no-pager", note: "Ø¢Ø®Ø±ÛŒÙ† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ nginx" },
    ];
  }

  // fallback generic
  return [
    { command: c, note: "Ø§Ø¬Ø±Ø§ÛŒ Ù†Ø³Ø®Ù‡ Ø§ØµÙ„ÛŒ" },
    { command: c, note: "Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´ØªØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø®Ø·Ø§ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯" },
    { command: c, note: "Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª/ØºÛŒØ±ØªÙˆÙ„ÛŒØ¯ÛŒ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯" },
  ];
}

function sanitizeAlternatives(alts, primaryCmd) {
  const out = [];
  const seen = new Set();
  for (const a of (alts || [])) {
    const cmd = String(a?.command || "").trim();
    if (!cmd) continue;
    if (seen.has(cmd)) continue;
    seen.add(cmd);
    out.push({ command: cmd, note: String(a?.note || "").trim() });
    if (out.length >= 3) break;
  }
  while (out.length < 3) {
    const fill = guessAlternatives(primaryCmd)[out.length];
    if (!fill) break;
    if (!seen.has(fill.command)) {
      seen.add(fill.command);
      out.push(fill);
    } else {
      out.push({ command: fill.command, note: fill.note });
    }
  }
  return out.slice(0, 3);
}

export function formatToolResponse({ outputType, text, cli = "bash", lang = "fa" }) {
  const raw = String(text ?? "").trim();
  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  const cmds = normalizeCommandLines(codeRaw);

  const primaryCmd = cmds[0] || "";

  const { pre, sections } = extractSectionsByH2(rest);
  const explanationTxt =
    pickSection(sections, ["ØªÙˆØ¶ÛŒØ­", "Ø´Ø±Ø­", "explanation", "how"]) ||
    (pre ? pre : "");

  const warningsTxt = pickSection(sections, ["Ù‡Ø´Ø¯Ø§Ø±", "warnings", "caution"]);
  const alternativesTxt = pickSection(sections, ["Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†", "alternatives", "option"]);

  let warnings = bulletsFromText(warningsTxt);
  if (warnings.length === 0) warnings = guessDefaultWarnings(primaryCmd);

  // parse alternatives: try extracting code blocks or command-like lines
  const altList = [];
  const altCodeBlocks = String(alternativesTxt || "").match(/```[^\n]*\n([\s\S]*?)```/g) || [];
  for (const blk of altCodeBlocks) {
    const inner = blk.replace(/```[^\n]*\n/, "").replace(/```$/, "").trim();
    const cmdLines = normalizeCommandLines(inner);
    for (const c of cmdLines) altList.push({ command: c, note: "" });
  }
  if (altList.length < 3) {
    const lines = String(alternativesTxt || "").split("\n").map(x => x.trim()).filter(Boolean);
    for (const l of lines) {
      const s = l.replace(/^(\d+[\).\s]+|[-*â€¢]\s*)/, "").trim();
      if (looksLikeCommand(s)) altList.push({ command: s, note: "" });
      if (altList.length >= 3) break;
    }
  }

  const alternatives = sanitizeAlternatives(altList, primaryCmd);

  const tool = {
    primary: { lang: fenceLangFromCli(cli, outputType), command: primaryCmd || cmds[0] || "" },
    explanation: String(explanationTxt || "").trim(),
    warnings,
    alternatives,
  };

  // markdown fallback (for old UI)
  const md =
`\\\`\\\`\\\`${tool.primary.lang}
${tool.primary.command}
\\\`\\\`\\\`

## ØªÙˆØ¶ÛŒØ­
${tool.explanation || "â€”"}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${tool.warnings.map(x => `- ${x}`).join("\n")}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
${tool.alternatives.map((a, i) => `### ${i+1}) ${a.note || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†"}\n\\\`\\\`\\\`${tool.primary.lang}\n${a.command}\n\\\`\\\`\\\``).join("\n\n")}
`;

  return { tool, markdown: md };
}

// alias for newer callers
export function formatOutput(args) {
  return formatToolResponse(args);
}

================================================================================
FILE: .ccg_backups/fix_backend_frontend_20260103_091446/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/mainpage_chat_hybrid_v1/20260102_095356/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/mainpage_chat_hybrid_v1/20260102_095356/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
function firstCodeBlock(text) {
  const t = String(text ?? "");
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```/);
  return m ? String(m[1] || "").trim() : "";
}

// heuristic: pick first "command-like" line when model returns prose
function firstCommandLikeLine(text) {
  const lines = String(text ?? "")
    .replace(/\r\n/g, "\n")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean);

  // Prefer lines that start with sudo, apt, systemctl, docker, kubectl, etc.
  const preferred = lines.find((l) => /^(sudo\s+)?(systemctl|service|apt|apt-get|dnf|yum|pacman|docker|kubectl|git|npm|pnpm|yarn|python|node|curl|wget|journalctl|ls|cd|cat|grep|awk|sed)\b/.test(l));
  if (preferred) return preferred;

  // Otherwise first line that does not contain Persian/Arabic chars (often prose)
  const nonFa = lines.find((l) => !/[\u0600-\u06FF]/.test(l));
  if (nonFa) return nonFa;

  return lines[0] || "";
}

export function formatOutput({ outputType, text, fenceLang = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase();
  const raw = String(text ?? "").trim();

  if (!["command", "script"].includes(ot)) return raw;

  const code = firstCodeBlock(raw) || firstCommandLikeLine(raw) || raw;
  return `\`\`\`${fenceLang}\n${String(code).trim()}\n\`\`\``;
}

================================================================================
FILE: .ccg_backups/night_lock_contract_20260107_132348/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";

/* CCG_ADV_OTHER_V1 */

// CCG_OS_ALLOWLIST_V1
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES","Alpine","Kali",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = ["bash","zsh","sh","fish","cmd","powershell","pwsh","ksh","tcsh"];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 2, maxLen = 40) {
  const x = cleanToken(v);
  if (x.length < minLen || x.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(x);
}

function normalizeShell(v) {
  const x = cleanToken(v).toLowerCase();
  if (!x) return "";
  if (x === "powershell") return "powershell";
  if (x === "pwsh") return "pwsh";
  if (x === "cmd" || x === "cmd.exe") return "cmd";
  return x;
}

import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);

  // Advanced (target) fields
  const [targetOSName, setTargetOSName] = useState("");
  const [targetOSCustom, setTargetOSCustom] = useState("");
  const [targetOSVersion, setTargetOSVersion] = useState("");
  const [targetShell, setTargetShell] = useState("");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    
    // CCG_ADV_PAYLOAD_V1
    const advOn = !!advanced;

    // defaults
    let osValue = platform === "network" ? "network" : (platform || "linux");
    let cliValue = typeof shell === "string" && shell ? shell : (platform === "windows" ? "powershell" : "bash");

    if (advOn) {
      const name = cleanToken(targetOSName);
      const custom = cleanToken(targetOSCustom);
      const ver = cleanToken(targetOSVersion);

      let finalName = name;
      if (finalName === "Custom") finalName = custom;

      const okName = (OS_ALLOWLIST.includes(finalName) || isSafeFreeText(finalName));
      if (okName && finalName) {
        osValue = ver ? `${finalName} ${ver}` : finalName;
      }

      const sh = normalizeShell(targetShell) || normalizeShell(cliValue);
      const okShell = SHELL_ALLOWLIST.includes(sh) || isSafeFreeText(sh, 2, 20);
      if (sh && okShell) cliValue = sh;
    }
const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

              {/* CCG_ADV_UI_V1 */}
              <div className="flex items-center gap-2 mt-2">
                <input
                  id="ccg-advanced"
                  type="checkbox"
                  checked={advanced}
                  onChange={(e) => setAdvanced(e.target.checked)}
                />
                <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">
                  {t("advanced")}
                </label>
              </div>

              {advanced ? (
                <div className="mt-3 w-full grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <FieldLabel label={t("targetOSName")} tip={t("tip_targetOSName")} />
                    <select
                      className="ccg-select text-sm w-full"
                      value={targetOSName}
                      onChange={(e) => setTargetOSName(e.target.value)}
                    >
                      <option value="">{lang === "fa" ? "Ø§Ù†ØªØ®Ø§Ø¨..." : "Select..."}</option>
                      {OS_ALLOWLIST.map((x) => (
                        <option key={x} value={x}>{x}</option>
                      ))}
                      <option value="Custom">Custom</option>
                    </select>

                    {targetOSName === "Custom" ? (
                      <input
                        className="ccg-input mt-2 w-full text-sm"
                        value={targetOSCustom}
                        onChange={(e) => setTargetOSCustom(e.target.value)}
                        placeholder={t("customHint")}
                      />
                    ) : null}
                  </div>

                  <div>
                    <FieldLabel label={t("targetOSVersion")} tip={t("tip_targetOSVersion")} />
                    <input
                      className="ccg-input w-full text-sm"
                      value={targetOSVersion}
                      onChange={(e) => setTargetOSVersion(e.target.value)}
                      placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 22.04 / 2019 / 13.2" : "e.g., 22.04 / 2019 / 13.2"}
                    />
                  </div>

                  <div>
                    <FieldLabel label={t("targetShell")} tip={t("tip_targetShell")} />
                    <select
                      className="ccg-select text-sm w-full"
                      value={targetShell}
                      onChange={(e) => setTargetShell(e.target.value)}
                    >
                      <option value="">{lang === "fa" ? "Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø² Ø´Ù„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ" : "Default (selected shell)"}</option>
                      {SHELL_ALLOWLIST.map((x) => (
                        <option key={x} value={x}>{x}</option>
                      ))}
                    </select>
                  </div>
                </div>
              ) : null}


            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/night_lock_contract_20260107_132348/client/src/components/ui/SectionedMarkdown.jsx
================================================================================

import { useMemo } from "react";
import MarkdownBox from "./MarkdownBox";

function splitByHeadings(md) {
  const raw = String(md || "").replace(/\r\n/g, "\n");
  const lines = raw.split("\n");

  const sections = [];
  let current = { title: null, body: [] };

  const pushCurrent = () => {
    const body = current.body.join("\n").trim();
    if (!current.title && !body) return;
    sections.push({ title: current.title, body });
  };

  for (const line of lines) {
    const m = line.match(/^(#{2,6})\s+(.+)\s*$/);
    if (m) {
      if (current.title !== null || current.body.length) pushCurrent();
      current = { title: m[2].trim(), body: [] };
      continue;
    }
    current.body.push(line);
  }

  pushCurrent();

  if (!sections.length && raw.trim()) return [{ title: null, body: raw.trim() }];

  return sections.filter((s) => (s.title || s.body).toString().trim().length > 0);
}

export default function SectionedMarkdown({ markdown, content, lang = "fa", defaultTitle }) {
  const md = content ?? markdown ?? "";
  const sections = useMemo(() => splitByHeadings(md), [md]);

  if (!md || !String(md).trim()) return <MarkdownBox markdown={""} lang={lang} />;

  if (sections.length === 1 && !sections[0].title) {
    return <MarkdownBox markdown={sections[0].body} lang={lang} />;
  }

  return (
    <div className="ccg-section-grid">
      {sections.map((sec, idx) => {
        const title = sec.title || defaultTitle || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result");
        
        const isWarnTitle = /^(Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§|Ù‡Ø´Ø¯Ø§Ø±|warnings?|warning)$/i.test(String(title || "").trim());
        const cardClass = isWarnTitle ? "ccg-section-card ccg-warn" : "ccg-section-card";
return (
          <div key={`${title}-${idx}`} className={cardClass}>
            <div className="ccg-section-title">{title}</div>
            <div className="ccg-section-body">
              <MarkdownBox markdown={sec.body} lang={lang} />
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/night_lock_contract_20260107_132348/client/src/components/ui/ToolResult.jsx
================================================================================

import React from "react";

function CodeBlock({ lang = "bash", code = "" }) {
  return (
    <pre className="rounded-xl border border-slate-200/70 dark:border-white/10 bg-slate-50 dark:bg-white/5 p-3 overflow-auto text-sm">
      <code className={`language-${lang}`}>{code}</code>
    </pre>
  );
}

export default function ToolResult({ tool }) {
  if (!tool) return null;

  const primary = tool.primary || {};
  const warnings = Array.isArray(tool.warnings) ? tool.warnings : [];
  const alternatives = Array.isArray(tool.alternatives) ? tool.alternatives : [];

  return (
    <div className="space-y-4">
      <div>
        <CodeBlock lang={primary.lang || "bash"} code={primary.command || ""} />
      </div>

      <div className="space-y-2">
        <h3 className="text-sm font-semibold text-slate-800 dark:text-white/90">ØªÙˆØ¶ÛŒØ­</h3>
        <div className="text-sm text-slate-700 dark:text-white/80 whitespace-pre-wrap">
          {tool.explanation || "â€”"}
        </div>
      </div>

      <div className="space-y-2">
        <h3 className="text-sm font-semibold text-red-600 dark:text-red-400">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</h3>
        <ul className="list-disc pr-5 text-sm text-red-700 dark:text-red-300 space-y-1">
          {(warnings.length ? warnings : ["Ø§Ø­ØªÛŒØ§Ø· Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."]).map((w, i) => (
            <li key={i}>{w}</li>
          ))}
        </ul>
      </div>

      <div className="space-y-3">
        <h3 className="text-sm font-semibold text-slate-800 dark:text-white/90">Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§</h3>
        {(alternatives.length ? alternatives.slice(0, 3) : []).map((a, i) => (
          <div key={i} className="space-y-2">
            <div className="text-xs text-slate-600 dark:text-white/60">{a.note || "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†"}</div>
            <CodeBlock lang={a.lang || primary.lang || "bash"} code={a.command || ""} />
          </div>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/night_lock_contract_20260107_132348/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Stable tool contract handling for "generate".
// - Extract JSON object from model output
// - Validate OS/CLI consistency (basic guardrails)
// - Always return { tool, markdown }

function safeJsonParse(s) { try { return JSON.parse(s); } catch { return null; } }

function extractFirstJsonObject(raw) {
  const t = String(raw ?? "").trim();
  // Find first '{' ... matching '}' (simple stack)
  const start = t.indexOf("{");
  if (start < 0) return null;
  let depth = 0;
  for (let i = start; i < t.length; i++) {
    const ch = t[i];
    if (ch === "{") depth++;
    else if (ch === "}") {
      depth--;
      if (depth === 0) {
        const slice = t.slice(start, i + 1);
        const obj = safeJsonParse(slice);
        if (obj) return obj;
      }
    }
  }
  return null;
}

function fenceLangFromCli(cli = "bash", outputType = "markdown") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function normalizeTool(tool, { os, cli, undefined } = {}) {
  const lang = fenceLangFromCli(cli, "markdown");
  const t = tool && typeof tool === "object" ? tool : {};

  const primaryCmd = String(t?.primary?.command ?? "").trim();
  const explanation = String(t?.explanation ?? "").trim();
  const warnings = Array.isArray(t?.warnings) ? t.warnings.map(x => String(x).trim()).filter(Boolean) : [];
  const alternatives = Array.isArray(t?.alternatives) ? t.alternatives : [];

  // Ensure arrays length
  while (warnings.length < 3) warnings.push("Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Backup Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
  warnings.length = 3;

  const alts = alternatives
    .map(a => ({
      command: String(a?.command ?? "").trim(),
      note: String(a?.note ?? "").trim(),
    }))
    .filter(a => a.command);

  // Ensure exactly 3 alternatives (fill safe minimal related)
  while (alts.length < 3) alts.push({ command: "", note: "" });
  alts.length = 3;

  // Basic OS/CLI guard: if windows selected, reject obvious linux commands and vice versa
  const osL = String(os || "").toLowerCase();
  const cliL = String(cli || "").toLowerCase();
  const looksLinux = (s) => /\b(sudo|systemctl|journalctl|apt|yum|dnf|shutdown\s+-)/i.test(s);
  const looksWindows = (s) => /\b(shutdown\s+\/|net\s+user|ipconfig|powershell|Get-)/i.test(s);

  const mismatch =
    (osL.includes("win") && looksLinux(primaryCmd)) ||
    ((osL.includes("linux") || osL.includes("mac")) && looksWindows(primaryCmd));

  if (mismatch || !primaryCmd) {
    return {
      primary: { command: "", lang },
      explanation: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¨Ù‡Ù…/Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ Ø¨Ø§ OS/CLI Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø­Ø§Ù„Øª Chat Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…Ø·Ù…Ø¦Ù† Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.",
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø³ÛŒØ³ØªÙ…ÛŒØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡/Backup Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ø§ÛŒÙ† Ú©Ø§Ø± Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±/Production Ø§Ø³ØªØŒ Ø­ØªÙ…Ø§Ù‹ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      ],
      alternatives: [
        { command: "", note: "Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´ÙˆØ¯." },
        { command: "", note: "Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Chat Ù…Ø³ÛŒØ± Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ TroubleShoot Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯." },
        { command: "", note: "OS/CLI ØµØ­ÛŒØ­ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Generate Ø¨Ø²Ù†ÛŒØ¯." },
      ],
    };
  }

  // KnowledgeLevel shaping (only affects explanation a bit if model is vague)
  let exp = explanation;
  if (!exp) {
    if (String(undefined).toLowerCase() === "beginner") exp = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¢Ù† Ø±Ø§ Ø¯Ø± ØªØ±Ù…ÛŒÙ†Ø§Ù„/Ø®Ø· ÙØ±Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.";
    else if (String(undefined).toLowerCase() === "intermediate") exp = "Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø§Ø³Øª.";
    else exp = "Ø¯Ø³ØªÙˆØ± Ù…Ø³ØªÙ‚ÛŒÙ….";
  }

  // Ensure alt notes are short
  for (const a of alts) {
    if (!a.note) a.note = "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø±ØªØ¨Ø·";
    if (a.note.length > 90) a.note = a.note.slice(0, 87) + "...";
  }

  return {
    primary: { command: primaryCmd, lang },
    explanation: exp,
    warnings,
    alternatives: alts,
  };
}

function toolToMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const cmd = tool?.primary?.command ? tool.primary.command.trim() : "";
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];
  const warn = Array.isArray(tool?.warnings) ? tool.warnings : [];

  const fence = cmd ? "```" + lang + "\n" + cmd + "\n```" : "```" + lang + "\n" + "\n```";

  const lines = [];
  lines.push(fence);
  lines.push("");
  lines.push("## ØªÙˆØ¶ÛŒØ­");
  lines.push(tool?.explanation || "");
  lines.push("");
  lines.push("## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§");
  for (const w of warn) lines.push("- " + w);
  lines.push("");
  lines.push("## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§");
  for (const a of alts) {
    const note = a?.note ? String(a.note) : "";
    const c = a?.command ? String(a.command).trim() : "";
    lines.push("- " + note);
    lines.push("");
    lines.push("```" + lang + "\n" + c + "\n```");
    lines.push("");
  }
  return lines.join("\n").trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, outputType }) {
  const extracted = extractFirstJsonObject(rawText);
  const tool = normalizeTool(extracted, { os, cli, undefined });

  const markdown = toolToMarkdown(tool);

  // For outputType command/script: only show primary copy block (as you wanted)
  const ot = String(outputType || "markdown").toLowerCase();
  if (ot === "command" || ot === "script") {
    const lang = tool?.primary?.lang || fenceLangFromCli(cli, "markdown");
    const cmd = tool?.primary?.command || "";
    return { tool, markdown: "```" + lang + "\n" + cmd + "\n```" };
  }

  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/20260108_102830/client/src/components/ui/ToolResult.jsx
================================================================================

// CCG_TOOLRESULT_JSON_GUARD_V2 (TDZ-safe)
import { useMemo, useState } from "react";

function tryParseToolJsonString(maybe) {
  try {
    if (typeof maybe !== "string") return null;
    const s = maybe.trim();
    if (!s) return null;
    if (!(s.startsWith("{") && s.endsWith("}"))) return null;
    const obj = JSON.parse(s);
    if (!obj || typeof obj !== "object") return null;
    return obj;
  } catch {
    return null;
  }
}

function CopyBtn({ value, lang }) {
  const [copied, setCopied] = useState(false);

  const labelCopy = lang === "fa" ? "Ú©Ù¾ÛŒ" : "Copy";
  const labelCopied = lang === "fa" ? "Ú©Ù¾ÛŒ Ø´Ø¯" : "Copied";

  async function copy() {
    try {
      const v = String(value || "");
      if (!v) return;
      if (navigator?.clipboard?.writeText) {
        await navigator.clipboard.writeText(v);
        setCopied(true);
        window.setTimeout(() => setCopied(false), 900);
      }
    } catch (e) {
      console.error("Clipboard copy failed:", e);
    }
  }

  return (
    <button
      type="button"
      className="ccg-btn ccg-btn-ghost ccg-btn-xs"
      onClick={copy}
      disabled={!value}
      title={labelCopy}
    >
      {copied ? labelCopied : labelCopy}
    </button>
  );
}

function CodeBlock({ title, value, lang }) {
  const v = String(value || "");
  return (
    <div className="ccg-codeblock">
      <div className="ccg-codeblock-head">
        <div className="ccg-codeblock-title">{title || "CODE"}</div>
        <CopyBtn value={v} lang={lang} />
      </div>
      <pre className="ccg-pre">
        <code dir="ltr">{v}</code>
      </pre>
    </div>
  );
}

/**
 * ToolResult contract:
 * - "tool" outputType => render ONLY tool result (no mixed markdown)
 * - Robust against JSON-string tool payloads
 */
export default function ToolResult({ tool, lang = "fa" }) {
  const normalized = useMemo(() => {
    const parsed = tryParseToolJsonString(tool);
    if (parsed) return parsed;
    if (tool && typeof tool === "object") return tool;
    return null;
  }, [tool]);

  if (!normalized) return null;

  const primary = normalized.primary || normalized.tool || normalized;
  const command =
    primary?.command ||
    primary?.cmd ||
    normalized?.command ||
    normalized?.cmd ||
    "";

  const python =
    primary?.python ||
    normalized?.python ||
    "";

  // Prefer explicit fields; fallback: stringify
  const rawJson = (() => {
    try {
      return JSON.stringify(normalized, null, 2);
    } catch {
      return String(normalized);
    }
  })();

  return (
    <div className="space-y-3">
      {command ? <CodeBlock title="command" value={command} lang={lang} /> : null}
      {python ? <CodeBlock title="python" value={python} lang={lang} /> : null}
      <CodeBlock title="ToolResult" value={rawJson} lang={lang} />
    </div>
  );
}

================================================================================
FILE: .ccg_backups/day2_ui_other_lock_fix_20260107_072745/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";



// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_eof_generatorpage/20260107_090439/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

// ---- Advanced: validation allowlists (client-side) ----
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES",
  "Amazon Linux","Oracle Linux","Kali","Gentoo","Alpine",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = [
  "bash","zsh","sh","fish",
  "cmd","powershell","pwsh",
  "ksh","tcsh"
];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 0, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{1,40}$/.test(s);
}


const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  
  const [customOSName, setCustomOSName] = useState("Ubuntu");
  const [customOSVersion, setCustomOSVersion] = useState("");
  const [customShell, setCustomShell] = useState("bash");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  
  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    const isOther = platform === "other";

    // Defaults (even when Advanced is closed)
    const safeMode = modeStyle || "operational";
    const safeLevel = knowledgeLevel || "intermediate";

    // Base OS/CLI mapping
    let osValue = isNetwork ? "network" : (platform || "linux");
    let cliValue = isNetwork ? "network-cli" : (shell || "bash");

    // If Other: use custom fields (validated)
    if (isOther) {
      const name = cleanToken(customOSName);
      const ver  = cleanToken(customOSVersion);
      const sh   = cleanToken(customShell).toLowerCase();

      const nameOk = !!name && (OS_ALLOWLIST.includes(name) || isSafeFreeText(name, 2, 40));
      const verOk  = ver ? isSafeFreeText(ver, 1, 20) : true;
      const shOk   = !!sh && SHELL_ALLOWLIST.includes(sh);

      const finalName = nameOk ? name : "Ubuntu";
      const finalVer  = (verOk ? ver : "");
      const finalShell= shOk ? sh : "bash";

      osValue = finalVer ? `${finalName} ${finalVer}` : finalName;
      cliValue = finalShell;
    }

    return {
      mode: "generate",
      lang: lang || "fa",
      user_request: input.trim(),

      outputType: outputType,
      modeStyle: safeMode,
      knowledgeLevel: safeLevel,

      platform: isNetwork ? "network" : (platform || "linux"),
      os: osValue,
      cli: cliValue,

      vendor: isNetwork ? (vendor || "") : "",
      deviceType: isNetwork ? (deviceType || "general") : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }

  useEffect(() => {
    document.body.classList.add("night-mode");
    document.body.classList.add("day-mode");
  }, []);


  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}


================================================================================
FILE: .ccg_backups/day2_ui_other_lock_20260107_071003/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";



// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_generator_dup_lang_t_20260108_065609/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";

// local storage keys
const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom OS)" },
];

const OUTPUT_TYPES = [
  { value: "tool", labelFa: "Tool (Ú©Ø§Ù…Ù„)", labelEn: "Tool (Full)" },
  { value: "command", labelFa: "Command (ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±)", labelEn: "Command (Commands only)" },
  { value: "python", labelFa: "Python", labelEn: "Python" },
];

const VERBOSITY = [
  { value: "brief", labelFa: "Ø®Ù„Ø§ØµÙ‡", labelEn: "Brief" },
  { value: "normal", labelFa: "Ù†Ø±Ù…Ø§Ù„", labelEn: "Normal" },
  { value: "detailed", labelFa: "Ø¬Ø²Ø¦ÛŒ", labelEn: "Detailed" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  windows: ["powershell", "cmd"],
  mac: ["zsh", "bash"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "powershell", "cmd"],
};

const LINUX_DISTROS = ["Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","Alpine","Kali"];
const WINDOWS_FLAVORS = ["Windows 10","Windows 11","Windows Server 2019","Windows Server 2022"];
const MAC_FLAVORS = ["macOS"];

const NETWORK_VENDORS = ["Cisco","MikroTik","FortiGate","Juniper","Aruba","Huawei","Generic"];
const DEVICE_TYPES_BY_VENDOR = {
  Cisco: ["switch","router","firewall"],
  MikroTik: ["router","switch"],
  FortiGate: ["firewall"],
  Juniper: ["switch","router","firewall"],
  Aruba: ["switch","controller"],
  Huawei: ["switch","router","firewall"],
  Generic: ["router","switch","firewall","appliance"],
};

function isSafeFreeText(v, min=2, max=40) {
  const s = String(v||"").trim().replace(/\s+/g," ");
  if (s.length < min || s.length > max) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

function qsToObj() {
  const q = new URLSearchParams(window.location.search);
  return {
    platform: q.get("platform") || "",
    cli: q.get("cli") || "",
    out: q.get("out") || "",
    v: q.get("v") || "",
    adv: q.get("adv") || "",
    swap: q.get("swap") || "",
    lang: q.get("lang") || "",
  };
}
function setQS(p) {
  const q = new URLSearchParams(window.location.search);
  Object.entries(p).forEach(([k,v]) => {
    if (v === "" || v == null) q.delete(k);
    else q.set(k, String(v));
  });
  const url = `${window.location.pathname}?${q.toString()}`;
  window.history.replaceState({}, "", url);
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm opacity-90">{label}</span>
      {tip ? (
        <span className="relative group">
          <button
            type="button"
            className="w-5 h-5 rounded-full border text-xs opacity-70 hover:opacity-100 dark:border-white/10"
            aria-label={`${label} help`}
          >
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-80 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  // CCG_USELANG_TOP_V1
  const { lang, setLang, t } = useLanguage();

  const { lang, setLang } = useLanguage();
  const isRTL = (lang === "fa");

  const t = useMemo(() => {
    const fa = {
      platform: "Ù¾Ù„ØªÙØ±Ù…",
      outputType: "Ù†ÙˆØ¹ Ø®Ø±ÙˆØ¬ÛŒ",
      cli: "Ø´Ù„ / CLI",
      verbosity: "Ø³Ø·Ø­ ØªÙˆØ¶ÛŒØ­",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "ØªÙˆØ²ÛŒØ¹ / Ù†ÙˆØ¹",
      version: "Version (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª",
      gen: "Generate",
      explain: "Explain command",
      swap: "Ø¬Ø§Ø¨Ø¬Ø§",
      errFix: "Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯:",
      tip_platform: "Ù¾Ù„ØªÙØ±Ù… Ù‡Ø¯ÙÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¢Ù† ØªÙˆÙ„ÛŒØ¯ Ø´ÙˆØ¯.",
      tip_output: "Tool: Ø®Ø±ÙˆØ¬ÛŒ Ú©Ø§Ù…Ù„. Command: ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ± + Ù‡Ø´Ø¯Ø§Ø± + Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§. Python: ÙÙ‚Ø· Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ†.",
      tip_cli: "Ø´Ù„/CLI Ù‡Ø¯Ù (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Ø®Ù„Ø§ØµÙ‡: Ú©ÙˆØªØ§Ù‡. Ù†Ø±Ù…Ø§Ù„: ØªÙˆØ¶ÛŒØ­ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯. Ø¬Ø²Ø¦ÛŒ: ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ + Ù…Ø«Ø§Ù„.",
      tip_advanced: "Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§ØªÙ Ù‡Ù…Ø§Ù† Ù¾Ù„ØªÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (Ù…Ø«Ù„Ø§Ù‹ distro Ù„ÛŒÙ†ÙˆÚ©Ø³ ÛŒØ§ Ù†ÙˆØ¹ Windows).",
      tip_custom: "Ø§Ú¯Ø± Ø³ÛŒØ³ØªÙ…/Ø´Ù„ Ø®Ø§Øµ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø³ÙØ§Ø±Ø´ÛŒ Ú©Ù†ÛŒØ¯. ÙÙ‚Ø· Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      placeholder: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø¶Ø­ Ø¨Ù†ÙˆÛŒØ³ (Ù‡Ø¯Ù + Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§). Ù…Ø«Ø§Ù„: Â«Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø³ÛŒØ³ØªÙ… Ø±Ùˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ù†Ù…Â»",
    };
    const en = {
      platform: "Platform",
      outputType: "Output type",
      cli: "Shell / CLI",
      verbosity: "Verbosity",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "Distro / Flavor",
      version: "Version (optional)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Request",
      gen: "Generate",
      explain: "Explain command",
      swap: "Swap",
      errFix: "Fix this first:",
      tip_platform: "Target platform to generate commands for.",
      tip_output: "Tool: full output. Command: command + warnings + alternatives (no explanation). Python: python code only.",
      tip_cli: "Target shell/CLI (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Brief: short. Normal: standard. Detailed: full explanation + examples.",
      tip_advanced: "Advanced fields for the selected platform only.",
      tip_custom: "Use for custom OS/Shell. Invalid values will be blocked before sending.",
      placeholder: "Write a clear request (goal + constraints). Example: â€œRestart my systemâ€",
    };
    return isRTL ? fa : en;
  }, [isRTL]);

  // Defaults
  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");
  const [advanced, setAdvanced] = useState(false);
  const [swap, setSwap] = useState(false);

  // advanced per-platform
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [windowsFlavor, setWindowsFlavor] = useState("Windows 11");
  const [macFlavor, setMacFlavor] = useState("macOS");
  const [osVersion, setOsVersion] = useState("");

  // network
  const [vendor, setVendor] = useState("Cisco");
  const [deviceType, setDeviceType] = useState("router");

  // custom
  const [customOn, setCustomOn] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [output, setOutput] = useState("");
  const [tool, setTool] = useState(null);

  // Load persisted state
  useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      const q = qsToObj();

      const p = q.platform || saved.platform || "linux";
      const c = q.cli || saved.cli || (SHELL_BY_PLATFORM[p]?.[0] || "bash");
      const out = q.out || saved.outputType || "tool";
      const v = q.v || saved.verbosity || "normal";
      const adv = (q.adv ? q.adv === "1" : !!saved.advanced);
      const sw = (q.swap ? q.swap === "1" : !!saved.swap);

      if (q.lang) setLang(q.lang);

      setPlatform(p);
      setCli(c);
      setOutputType(out);
      setVerbosity(v);
      setAdvanced(adv);
      setSwap(sw);

      setLinuxDistro(saved.linuxDistro || "Ubuntu");
      setWindowsFlavor(saved.windowsFlavor || "Windows 11");
      setMacFlavor(saved.macFlavor || "macOS");
      setOsVersion(saved.osVersion || "");

      setVendor(saved.vendor || "Cisco");
      setDeviceType(saved.deviceType || "router");

      setCustomOn(!!saved.customOn);
      setCustomOS(saved.customOS || "");
      setCustomShell(saved.customShell || "");

      setInput(saved.input || "");
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Keep cli valid per platform
  useEffect(() => {
    const allowed = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!allowed.includes(cli)) setCli(allowed[0]);
    // If leaving network, reset vendor/deviceType
    if (platform !== "network") {
      setVendor("Cisco");
      setDeviceType("router");
    }
    // Custom only relevant on "other"
    if (platform !== "other") setCustomOn(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [platform]);

  // persist state + URL
  useEffect(() => {
    const st = {
      platform, cli, outputType, verbosity, advanced, swap,
      linuxDistro, windowsFlavor, macFlavor, osVersion,
      vendor, deviceType,
      customOn, customOS, customShell,
      input
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
    setQS({
      platform,
      cli,
      out: outputType,
      v: verbosity,
      adv: advanced ? "1" : "",
      swap: swap ? "1" : "",
      lang,
    });
  }, [platform, cli, outputType, verbosity, advanced, swap, linuxDistro, windowsFlavor, macFlavor, osVersion, vendor, deviceType, customOn, customOS, customShell, input, lang]);

  function validateBeforeSend() {
    const errs = [];

    if (!input.trim()) errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª." : "Request is empty.");

    // outputType strict
    if (!["tool","command","python"].includes(outputType)) errs.push("Invalid output type.");

    // platform strict
    if (!["linux","windows","mac","network","other"].includes(platform)) errs.push("Invalid platform.");

    // Custom validation (block before API)
    if (platform === "other" && customOn) {
      if (!isSafeFreeText(customOS, 2, 40)) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom OS.");
      if (!isSafeFreeText(customShell, 2, 20)) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom Shell/CLI.");
    }

    // Advanced validation: only for selected platform
    if (advanced && platform === "linux") {
      if (linuxDistro && !LINUX_DISTROS.includes(linuxDistro)) errs.push(isRTL ? "Distro Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid distro.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }
    if (advanced && platform === "windows") {
      if (windowsFlavor && !WINDOWS_FLAVORS.includes(windowsFlavor)) errs.push(isRTL ? "Windows Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Windows flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version/Build Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version/build (optional).");
    }
    if (advanced && platform === "mac") {
      if (macFlavor && !MAC_FLAVORS.includes(macFlavor)) errs.push(isRTL ? "macOS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid macOS flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    // Network validation always available in normal mode (not hidden)
    if (platform === "network") {
      if (!NETWORK_VENDORS.includes(vendor)) errs.push(isRTL ? "Vendor Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid vendor.");
      const dt = DEVICE_TYPES_BY_VENDOR[vendor] || [];
      if (!dt.includes(deviceType)) errs.push(isRTL ? "Device type Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid device type.");
    }

    return errs;
  }

  function computeOS() {
    // version optional, but don't force users to fill it
    if (platform === "linux") return advanced ? (osVersion ? `${linuxDistro} ${osVersion}` : linuxDistro) : "linux";
    if (platform === "windows") return advanced ? (osVersion ? `${windowsFlavor} ${osVersion}` : windowsFlavor) : "windows";
    if (platform === "mac") return advanced ? (osVersion ? `${macFlavor} ${osVersion}` : macFlavor) : "mac";
    if (platform === "network") return "network";
    if (platform === "other") return customOn ? customOS.trim() : "other";
    return platform;
  }

  function payloadFor(mode="generate", targetCommand="") {
    const base = {
      mode,
      lang,
      user_request: input.trim(),
      outputType,
      verbosity,
    };

    // custom ON => send ONLY custom fields (no extra)
    if (platform === "other" && customOn) {
      return {
        ...base,
        platform: "other",
        os: customOS.trim(),
        cli: customShell.trim(),
        vendor: "",
        deviceType: "general",
        ...(mode === "explain" ? { targetCommand } : {}),
      };
    }

    // normal platforms
    const pl = platform;
    const os = computeOS();
    const c = cli;

    return {
      ...base,
      platform: pl,
      os,
      cli: c,
      vendor: pl === "network" ? vendor : "",
      deviceType: pl === "network" ? deviceType : "general",
      ...(mode === "explain" ? { targetCommand } : {}),
    };
  }

  async function runGenerate() {
    const errs = validateBeforeSend();
    if (errs.length) { setErr(`${t.errFix} ${errs[0]}`); return; }

    setErr("");
    setLoading(true);
    setOutput("");
    setTool(null);

    try {
      const res = await callCCG(payloadFor("generate"));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  async function runExplain() {
    // explain should use last produced tool.primary.command if possible
    const cmd = tool?.primary?.command ? String(tool.primary.command) : "";
    if (!cmd.trim()) { setErr(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø¯Ø³ØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯." : "Generate a command first."); return; }

    setErr("");
    setLoading(true);
    try {
      const res = await callCCG(payloadFor("explain", cmd.trim()));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  const cliOptions = SHELL_BY_PLATFORM[platform] || ["bash"];

  const leftPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-2" : "order-1") : (isRTL ? "order-1" : "order-2"))}`;
  const rightPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-1" : "order-2") : (isRTL ? "order-2" : "order-1"))}`;

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4 justify-between">

            <div className="flex flex-wrap items-center gap-3 sm:gap-4">
              <FieldLabel label={t.platform} tip={t.tip_platform} />
              <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
                {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>

              <FieldLabel label={t.cli} tip={t.tip_cli} />
              <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm">
                {cliOptions.map(v => <option key={v} value={v}>{v}</option>)}
              </select>

              <FieldLabel label={t.outputType} tip={t.tip_output} />
              <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
                {OUTPUT_TYPES.map(o => (
                  <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>
                ))}
              </select>

              <FieldLabel label={t.verbosity} tip={t.tip_verbosity} />
              <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
                {VERBOSITY.map(o => <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>)}
              </select>

              <div className="flex items-center gap-2">
                <input id="ccg-adv" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
                <label htmlFor="ccg-adv" className="text-sm opacity-90">{t.advanced}</label>
              </div>

              <button type="button" className="ccg-btn text-sm" onClick={()=>setSwap(s=>!s)}>
                {t.swap}
              </button>
            </div>

            <div className="flex items-center gap-2">
              <button type="button" className="ccg-btn text-sm" onClick={()=>setLang(isRTL ? "en" : "fa")}>
                {isRTL ? "EN" : "FA"}
              </button>
            </div>

          </div>

          {/* Advanced row (platform-specific only) */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] p-4">
              <div className="flex flex-wrap items-center gap-4 justify-between">
                <div className="text-sm opacity-80">{t.tip_advanced}</div>

                {platform === "other" ? (
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customOn} onChange={(e)=>setCustomOn(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">{t.custom}</label>
                  </div>
                ) : null}
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                {platform === "linux" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select w-full">
                        {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                    </div>
                  </>
                ) : null}

                {platform === "windows" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={windowsFlavor} onChange={(e)=>setWindowsFlavor(e.target.value)} className="ccg-select w-full">
                        {WINDOWS_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "mac" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={macFlavor} onChange={(e)=>setMacFlavor(e.target.value)} className="ccg-select w-full">
                        {MAC_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "network" ? (
                  <>
                    <div>
                      <FieldLabel label={t.vendor} />
                      <select value={vendor} onChange={(e)=>{ setVendor(e.target.value); setDeviceType((DEVICE_TYPES_BY_VENDOR[e.target.value]||["router"])[0]); }} className="ccg-select w-full">
                        {NETWORK_VENDORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.deviceType} />
                      <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select w-full">
                        {(DEVICE_TYPES_BY_VENDOR[vendor] || []).map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                  </>
                ) : null}

                {platform === "other" && customOn ? (
                  <>
                    <div>
                      <FieldLabel label="Custom OS" tip={t.tip_custom} />
                      <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                    </div>
                    <div>
                      <FieldLabel label="Custom Shell/CLI" tip={t.tip_custom} />
                      <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ tcsh" : "e.g. tcsh"} />
                    </div>
                  </>
                ) : null}
              </div>
            </div>
          ) : null}

        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          {/* Request */}
          <div className={rightPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{t.request}</h2>
            <textarea
              className="ccg-textarea w-full min-h-[200px]"
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              placeholder={t.placeholder}
            />
            {err ? (
              <div className="ccg-error mt-3">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{err}</div>
              </div>
            ) : null}

            <div className="mt-4 flex items-center gap-3 justify-end">
              <button className="ccg-btn" type="button" disabled={loading} onClick={runExplain}>
                {t.explain}
              </button>
              <button className="ccg-btn primary" type="button" disabled={loading} onClick={runGenerate}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§..." : "Running...") : t.gen}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={leftPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>
            {outputType === "tool" && tool ? (
              <ToolResult tool={tool} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_genpage_dup_brace_20260107_075220/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";



// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

// ---- Advanced: validation allowlists (client-side) ----
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES",
  "Amazon Linux","Oracle Linux","Kali","Gentoo","Alpine",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = [
  "bash","zsh","sh","fish",
  "cmd","powershell","pwsh",
  "ksh","tcsh"
];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 0, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{1,40}$/.test(s);
}


const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  
  const [customOSName, setCustomOSName] = useState("Ubuntu");
  const [customOSVersion, setCustomOSVersion] = useState("");
  const [customShell, setCustomShell] = useState("bash");
const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  
  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    const isOther = platform === "other";

    // Defaults (even when Advanced is closed)
    const safeMode = modeStyle || "operational";
    const safeLevel = knowledgeLevel || "intermediate";

    // Base OS/CLI mapping
    let osValue = isNetwork ? "network" : (platform || "linux");
    let cliValue = isNetwork ? "network-cli" : (shell || "bash");

    // If Other: use custom fields (validated)
    if (isOther) {
      const name = cleanToken(customOSName);
      const ver  = cleanToken(customOSVersion);
      const sh   = cleanToken(customShell).toLowerCase();

      const nameOk = !!name && (OS_ALLOWLIST.includes(name) || isSafeFreeText(name, 2, 40));
      const verOk  = ver ? isSafeFreeText(ver, 1, 20) : true;
      const shOk   = !!sh && SHELL_ALLOWLIST.includes(sh);

      const finalName = nameOk ? name : "Ubuntu";
      const finalVer  = (verOk ? ver : "");
      const finalShell= shOk ? sh : "bash";

      osValue = finalVer ? `${finalName} ${finalVer}` : finalName;
      cliValue = finalShell;
    }

    return {
      mode: "generate",
      lang: lang || "fa",
      user_request: input.trim(),

      outputType: outputType,
      modeStyle: safeMode,
      knowledgeLevel: safeLevel,

      platform: isNetwork ? "network" : (platform || "linux"),
      os: osValue,
      cli: cliValue,

      vendor: isNetwork ? (vendor || "") : "",
      deviceType: isNetwork ? (deviceType || "general") : "general",
    };
  };

  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/generator_toolstyle_final/20260102_131017/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-style output for Generator (NOT chatty):
// - Always make sure the FIRST thing is a single fenced code block for command/script.
// - Preserve the rest of the assistant output (explanation/warnings/alternatives).
function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

export function formatOutput({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase();
  const t = String(text ?? "").trim();

  // only normalize tool-ish types
  if (!["command", "script"].includes(ot)) return t;

  const lang = fenceLangFromCli(cli);

  // if AI already provided a code fence, keep its code as the "first fence" and preserve remaining text
  const { code, rest } = splitFirstCodeBlock(t);

  // If no code fence exists, try to extract a sensible command/script
  let finalCode = code;
  let finalRest = rest;

  if (!finalCode) {
    const lines = t.split(/\r?\n/).map(l => l.trimEnd());
    const nonEmpty = lines.filter(l => l.trim() !== "");
    // command: best effort = first non-empty line
    // script: best effort = all non-empty lines
    finalCode = (ot === "command") ? (nonEmpty[0] || "") : nonEmpty.join("\n");
    finalRest = ""; // we don't know which lines are "rest" in this case
  }

  const fenced = "```" + lang + "\n" + finalCode.trim() + "\n```";
  return finalRest ? (fenced + "\n\n" + finalRest) : fenced;
}

export default formatOutput;

================================================================================
FILE: .ccg_backups/generator_toolstyle_final/20260102_131044/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-style output for Generator (NOT chatty):
// - Ensure FIRST thing is ONE fenced code block for command/script.
// - Preserve the rest of the assistant output (Explanation/Warn/Alternatives).

function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  if (!t) return { code: "", rest: "" };
  // take first non-empty line as "command" if it looks like a shell line
  const lines = t.split(/\r?\n/).map(l => l.trimEnd());
  const first = lines.find(l => l.trim());
  if (!first) return { code: "", rest: t };
  // heuristic: if first line contains spaces/flags or starts with sudo/./ or common commands
  const looksCmd =
    /^(sudo|systemctl|service|journalctl|ps|top|htop|df|du|free|ip|ifconfig|ss|netstat|lsof|cat|grep|awk|sed|curl|wget|apt|dnf|yum|pacman|docker|kubectl|git|npm|node|pm2|nginx|ufw)\b/i.test(first) ||
    first.startsWith("./") || first.startsWith("chmod ") || first.startsWith("cd ");
  if (!looksCmd) return { code: "", rest: t };
  const rest = lines.slice(lines.indexOf(first) + 1).join("\n").trim();
  return { code: first.trim(), rest };
}

export function formatOutput({ outputType, text, cli = "bash" } = {}) {
  const ot = String(outputType ?? "").toLowerCase();
  const original = String(text ?? "").trim();
  if (!original) return "";

  // For command/script/python: force first fence, but keep rest.
  if (!["command", "script", "python", "markdown"].includes(ot)) {
    return original;
  }

  let { code, rest } = splitFirstCodeBlock(original);
  if (!code) {
    const g = guessCommandFromText(original);
    code = g.code;
    rest = g.rest;
  }

  // If still no code, just return original (don't destroy content).
  if (!code) return original;

  const lang = ot === "python" ? "python" : fenceLangFromCli(cli);
  const fenced = `\`\`\`${lang}\n${code}\n\`\`\``;

  // IMPORTANT: preserve rest (explanation/warnings/alternatives)
  return rest ? `${fenced}\n\n${rest}` : fenced;
}

================================================================================
FILE: .ccg_backups/final_stable_contract/20260106_082556/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/final_stable_contract/20260106_082556/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract (Generator)
// Ù‡Ø¯Ù: Ø®Ø±ÙˆØ¬ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±ØŒ ØºÛŒØ±Ú†ØªÛŒØŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´/Ú©Ù¾ÛŒ Ø¨Ø§Ø´Ø¯.
//
// Contract (tool):
// {
//   primary: { command: string, lang: string },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command: string, note: string }, ...] // exactly 3
// }
//
// Also provides markdown in the same order:
// 1) Primary command (ONE fenced block) - only command lines
// 2) ## ØªÙˆØ¶ÛŒØ­
// 3) ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
// 4) ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (3 items, each: note + its own fenced block)
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // Basic "starts with command" heuristic
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean);

  const cmds = [];
  for (const l of lines) {
    // drop obvious prose inside code block
    if (!looksLikeCommand(l)) continue;
    cmds.push(l);
  }
  return cmds.join("\n").trim();
}

function isWindowsCtx(os, cli) {
  const o = String(os || "").toLowerCase();
  const c = String(cli || "").toLowerCase();
  return o.includes("win") || c === "cmd" || c.includes("powershell");
}

function isLinuxCtx(os) {
  const o = String(os || "").toLowerCase();
  return o.includes("linux") || o.includes("ubuntu") || o.includes("debian") || o.includes("centos") || o.includes("rhel");
}

function defaultByCtx({ os, cli, userRequest }) {
  const ur = String(userRequest || "").toLowerCase();
  const win = isWindowsCtx(os, cli);
  const lin = isLinuxCtx(os);

  // Minimal deterministic defaults if model output is messy
  if (win) {
    if (ur.includes("Ø®Ø§Ù…ÙˆØ´") || ur.includes("shutdown")) {
      return {
        primary: "shutdown /s /t 60",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† ÙˆÛŒÙ†Ø¯ÙˆØ² Ø§Ø² Ø·Ø±ÛŒÙ‚ CMD Ø¨Ø§ ØªØ§Ø®ÛŒØ± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
          "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø² Ø¯Ø³ØªÙˆØ± shutdown /a Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³/Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³ØªØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ/Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
          { command: "shutdown /s /t 300", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±" },
          { command: "shutdown /s /f /t 60", note: "Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ Ø¨Ø³ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" },
        ],
      };
    }
    if (ur.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || ur.includes("restart") || ur.includes("reboot")) {
      return {
        primary: "shutdown /r /t 0",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ø±Ø¯Ù† ÙˆÛŒÙ†Ø¯ÙˆØ² Ø§Ø² Ø·Ø±ÛŒÙ‚ CMD Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø§Ø³ØªØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø±Ø´ Ù‚Ø·Ø¹ Ø´ÙˆØ¯.",
          "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ shutdown /a Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯."
        ],
        alternatives: [
          { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ±" },
          { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª/Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
          { command: "shutdown /r /f /t 0", note: "Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ Ø¨Ø³ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" },
        ],
      };
    }
  }

  if (lin) {
    if (ur.includes("Ø®Ø§Ù…ÙˆØ´") || ur.includes("shutdown") || ur.includes("poweroff")) {
      return {
        primary: "sudo shutdown -h +1",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ± Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
          "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
          { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" },
          { command: "sudo systemctl poweroff", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± systemd" },
        ],
      };
    }
    if (ur.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || ur.includes("restart") || ur.includes("reboot")) {
      return {
        primary: "sudo reboot",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
          "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± systemd" },
          { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
          { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±" },
        ],
      };
    }
  }

  return null;
}

function ensure3Alternatives(alts, ctxDefaults) {
  const safe = Array.isArray(alts) ? alts.filter(a => a && a.command) : [];
  const out = safe.slice(0, 3).map(a => ({
    command: String(a.command).trim(),
    note: String(a.note || "").trim() || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†",
  }));

  while (out.length < 3) {
    if (ctxDefaults?.alternatives?.[out.length]) out.push(ctxDefaults.alternatives[out.length]);
    else out.push({ command: "", note: "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });
  }
  return out;
}

function knowledgeAdjust(text, level) {
  const k = String(level || "").toLowerCase();
  if (k.includes("Ø­Ø±ÙÙ‡") || k.includes("expert") || k.includes("pro")) {
    // concise
    return String(text || "").trim().split("\n").slice(0, 4).join("\n").trim();
  }
  if (k.includes("Ù…ØªÙˆØ³Ø·") || k.includes("inter")) {
    return String(text || "").trim();
  }
  // beginner: slightly more explicit (but still not chatty)
  return String(text || "").trim();
}

function toMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const primary = String(tool?.primary?.command || "").trim();

  const exp = String(tool?.explanation || "").trim() || "â€”";
  const warns = Array.isArray(tool?.warnings) && tool.warnings.length ? tool.warnings : ["Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… backup Ø¨Ú¯ÛŒØ±ÛŒØ¯."];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives.slice(0, 3) : [];

  let md = "";
  md += "```" + lang + "\n" + primary + "\n```\n\n";
  md += "## ØªÙˆØ¶ÛŒØ­\n" + exp + "\n\n";
  md += "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n" + warns.map(w => "- " + String(w).trim()).join("\n") + "\n\n";
  md += "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n";
  for (const a of alts) {
    const note = String(a.note || "").trim() || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = String(a.command || "").trim();
    md += "- " + note + "\n\n```" + lang + "\n" + cmd + "\n```\n\n";
  }
  return md.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType } = {}) {
  const ur = String(userRequest || "").trim();
  if (!ur || ur.length < 4) {
    const msg = "Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ§Ø¶Ø­ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨ÛŒØ§Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø­Ø§Ù„Øª Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ (Chat Mode) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.";
    return { tool: null, markdown: msg, error: "NEED_MORE_DETAILS" };
  }

  const lang = fenceLangFromCli(cli, outputType);
  const { codeRaw, rest } = splitFirstCodeBlock(rawText || "");
  const codeCmds = normalizeCodeToCommands(codeRaw);

  const ctxDefaults = defaultByCtx({ os, cli, userRequest: ur });

  // Primary: prefer extracted command, else ctx default
  let primaryCmd = codeCmds || (ctxDefaults?.primary || "");
  // Hard OS lock
  const win = isWindowsCtx(os, cli);
  const lin = isLinuxCtx(os);

  if (win && /(sudo|systemctl|apt|yum|dnf)\b/i.test(primaryCmd)) primaryCmd = (ctxDefaults?.primary || "shutdown /r /t 0");
  if (lin && /(shutdown\s+\/(s|r)|net\s+user)\b/i.test(primaryCmd)) primaryCmd = (ctxDefaults?.primary || "sudo reboot");

  // Explanation: from rest if exists, else ctx default
  let explanation = (String(rest || "").trim() || ctxDefaults?.explanation || "").trim();
  explanation = knowledgeAdjust(explanation, knowledgeLevel) || "â€”";

  // Warnings: if model didn't provide, use ctx default warnings
  let warnings = (ctxDefaults?.warnings || [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…ÙˆØ§Ø±Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
    "Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    "Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
  ]).slice(0, 3);

  // Alternatives: prefer ctx defaults (stable) unless model produced same-OS commands (we don't parse from rest here on purpose)
  let alternatives = ensure3Alternatives(ctxDefaults?.alternatives || [], ctxDefaults);

  const tool = {
    primary: { command: primaryCmd.trim(), lang },
    explanation,
    warnings,
    alternatives,
  };

  const markdown = toMarkdown(tool);

  // outputType=command/script should return ONLY primary code fence (copy-ready)
  const ot = String(outputType || "").toLowerCase();
  if (ot === "command" || ot === "script") {
    const only = "```" + lang + "\n" + tool.primary.command + "\n```";
    return { tool, markdown: only };
  }

  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/tool_contract_v1/20260103_055028/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/tool_contract_v1/20260103_055028/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// CCG Generator Tool-Style Post-Processor (STRICT)
//
// Contract for outputType: "tool" or "markdown":
// 1) FIRST thing: exactly ONE fenced code block (bash/powershell/..)
// 2) Code fence contains ONLY command-like lines (no prose).
// 3) Always includes sections in this order:
//    - ## ØªÙˆØ¶ÛŒØ­
//    - ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
//    - ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (exactly 3 lines, in ONE code block)
// Backward-compatible exports:
// - formatOutput
// - formatToolResponse (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function hasFaChars(s) {
  return /[\u0600-\u06FF]/.test(String(s || ""));
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (hasFaChars(s)) return false;                 // prose in Persian is not a command
  if (/^[â€œ"'`]/.test(s)) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // accept comments only if ascii and starts with #
  if (/^\s*#/.test(s)) return false;

  // common prompt prefixes
  const cleaned = s.replace(/^\s*(\$|#)\s+/, "");

  // starts with a token + optional args
  if (/^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(cleaned)) return true;
  return false;
}

function normalizeCodeToCommands(codeRaw, { maxLines = 40 } = {}) {
  const lines = String(codeRaw || "")
    .replace(/\r\n/g, "\n")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .map((l) => l.replace(/^\s*(\$|#)\s+/, "")) // remove shell prompts
    .filter((l) => l !== "```" && !l.startsWith("```"));

  const cmds = [];
  for (const l of lines) {
    if (looksLikeCommand(l)) cmds.push(l);
    if (cmds.length >= maxLines) break;
  }
  return cmds;
}

function guessPrimaryCommandFromText(text) {
  const t = String(text || "").replace(/\r\n/g, "\n");
  // try to find a standalone command-like line
  const lines = t.split("\n").map((x) => x.trim()).filter(Boolean);
  for (const line of lines) {
    if (looksLikeCommand(line)) return line.replace(/^\s*(\$|#)\s+/, "");
  }
  return "";
}

function pickFirstSentence(text, { maxLen = 180 } = {}) {
  const t = String(text || "").trim();
  if (!t) return "";
  const cleaned = t
    .replace(/```[\s\S]*?```/g, " ")
    .replace(/\s+/g, " ")
    .trim();
  if (!cleaned) return "";
  const stop = cleaned.search(/[.!?ØŸ]\s/);
  const out = stop > 30 ? cleaned.slice(0, stop + 1) : cleaned;
  return out.length > maxLen ? out.slice(0, maxLen).trim() + "â€¦" : out;
}

function ensureBullets(items, fallbackFa) {
  const arr = Array.isArray(items) ? items.filter(Boolean).map(String) : [];
  const final = arr.length ? arr : fallbackFa;
  return final.map((x) => `- ${String(x).trim()}`).join("\n");
}

function ensure3Alternatives(alts) {
  const arr = (Array.isArray(alts) ? alts : [])
    .map((x) => String(x || "").trim())
    .filter(Boolean)
    .filter((x) => !hasFaChars(x))  // alternatives must be commands
    .slice(0, 3);

  while (arr.length < 3) arr.push(arr[arr.length - 1] || "");
  // final sanitize
  return arr.filter(Boolean).slice(0, 3);
}

function intentFromRequest(userRequest, primaryCmd) {
  const r = String(userRequest || "").toLowerCase();
  const c = String(primaryCmd || "").toLowerCase();

  const has = (re) => re.test(r) || re.test(c);

  if (has(/reboot|restart|Ø±ÛŒØ³ØªØ§Ø±Øª|Ø±Ø§Ù‡\s*Ø§Ù†Ø¯Ø§Ø²ÛŒ\s*Ù…Ø¬Ø¯Ø¯/)) return "reboot";
  if (has(/shutdown|poweroff|Ø®Ø§Ù…ÙˆØ´/)) return "shutdown";
  if (has(/nginx/)) return "nginx";
  if (has(/disk|storage|df\b|du\b|ÙØ¶Ø§ÛŒ\s*Ø¯ÛŒØ³Ú©|Ø­Ø§ÙØ¸Ù‡\s*Ø¯ÛŒØ³Ú©/)) return "disk";
  if (has(/memory|ram|free\b|Ø±Ù…|Ø­Ø§ÙØ¸Ù‡/)) return "memory";
  if (has(/process|ps\b|top\b|Ù¾Ø±ÙˆØ³Ø³|Ù¾Ø±Ø¯Ø§Ø²Ø´/)) return "process";
  if (has(/docker/)) return "docker";
  if (has(/kubectl|k8s|kubernetes/)) return "k8s";
  return "generic";
}

function alternativesFor(intent, primaryCmd) {
  const c = String(primaryCmd || "").trim();

  // service patterns
  const m1 = c.match(/^(sudo\s+)?systemctl\s+(status|restart|start|stop)\s+([a-zA-Z0-9._@-]+)/);
  if (m1) {
    const svc = m1[3];
    const action = m1[2];
    if (action === "status") {
      return [
        `systemctl is-active ${svc}`,
        `service ${svc} status`,
        `journalctl -u ${svc} -n 50 --no-pager`,
      ];
    }
    return [
      `sudo systemctl ${action} ${svc}`,
      `sudo service ${svc} ${action === "restart" ? "restart" : action}`,
      `journalctl -u ${svc} -n 50 --no-pager`,
    ];
  }

  if (intent === "reboot") {
    return [
      "sudo systemctl reboot",
      "sudo shutdown -r now",
      "sudo shutdown -r +1",
    ];
  }

  if (intent === "shutdown") {
    return [
      "sudo systemctl poweroff",
      "sudo shutdown -h now",
      "sudo poweroff",
    ];
  }

  if (intent === "nginx") {
    return [
      "systemctl status nginx",
      "nginx -t",
      "journalctl -u nginx -n 50 --no-pager",
    ];
  }

  if (intent === "disk") {
    return [
      "df -h",
      "lsblk",
      "du -sh ./* | sort -h",
    ];
  }

  if (intent === "memory") {
    return [
      "free -h",
      "vmstat 1 5",
      "top",
    ];
  }

  if (intent === "process") {
    return [
      "ps aux | less",
      "top",
      "htop",
    ];
  }

  if (intent === "docker") {
    return [
      "docker ps",
      "docker logs --tail 200 <container>",
      "docker inspect <container>",
    ];
  }

  if (intent === "k8s") {
    return [
      "kubectl get pods -A",
      "kubectl describe pod <pod> -n <ns>",
      "kubectl logs -n <ns> <pod> --tail=200",
    ];
  }

  // generic: at least useful + command-adjacent
  const cmdName = c.split(/\s+/)[0] || "command";
  return [
    `${cmdName} --help`,
    `man ${cmdName}`,
    `tldr ${cmdName}`,
  ];
}

function warningsFor(intent) {
  if (intent === "reboot") {
    return [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±ØªØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§/Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø±ÛŒØ¯.",
      "Ø¯Ø± Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù¾Ø±ÙˆØ¯Ø§Ú©Ø´Ù†ØŒ Ø²Ù…Ø§Ù† Ø±ÛŒØ³ØªØ§Ø±Øª Ø±Ø§ Ø¨Ø§ ØªÛŒÙ… Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯.",
    ];
  }
  if (intent === "shutdown") {
    return [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù†ØŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
      "Ø±ÙˆÛŒ SSHØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ø±ÛŒØ³Ú© Ø§Ø² Ø¯Ø³Øª Ø¯Ø§Ø¯Ù† Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±ÛŒØ¯.",
      "Ø¯Ø± Ù¾Ø±ÙˆØ¯Ø§Ú©Ø´Ù†ØŒ Ø­ØªÙ…Ø§Ù‹ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ/Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.",
    ];
  }
  if (intent === "nginx") {
    return [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª/Ø±ÛŒÙ„ÙˆØ¯ nginxØŒ Ø¨Ø§ `nginx -t` Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ø§ ØªØ³Øª Ú©Ù†ÛŒØ¯.",
      "Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆØ¯Ø§Ú©Ø´Ù†ØŒ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¯Ø± Ø²Ù…Ø§Ù† Ú©Ù…â€ŒØªØ±Ø§ÙÛŒÚ© Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      "Ø§Ú¯Ø± reverse proxy Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø±ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø«Ø± Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ø¯â€”Ø±ÛŒØ³Ú© downtime Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±ÛŒØ¯.",
    ];
  }
  return [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ø¯Ø³ØªÙˆØ± Ø±Ø§ ÛŒÚ© Ø¨Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ù†Ø§Ø³Ø¨ Ø³ÛŒØ³ØªÙ… Ø´Ù…Ø§ Ø¨Ø§Ø´Ø¯.",
    "Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ± Ù†ÛŒØ§Ø² Ø¨Ù‡ sudo Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ Ùˆ Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯.",
    "Ø¯Ø± Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆØ¯Ø§Ú©Ø´Ù†ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± staging/VM ØªØ³Øª Ú©Ù†ÛŒØ¯.",
  ];
}

function explanationFor(intent, primaryCmd, userRequest, isFa) {
  const c = String(primaryCmd || "").trim();
  const ur = String(userRequest || "").trim();

  if (!isFa) {
    if (intent === "reboot") return "Reboots the system immediately from the terminal.";
    if (intent === "shutdown") return "Powers off the system immediately from the terminal.";
    if (intent === "nginx") return "Checks or manages nginx service state/logs.";
    return `Runs a command related to: ${ur || c}`;
  }

  if (intent === "reboot") return "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ø§ ÙÙˆØ±Ø§Ù‹ Ø±ÛŒØ³ØªØ§Ø±Øª (Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯) Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
  if (intent === "shutdown") return "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ø§ ÙÙˆØ±Ø§Ù‹ Ø®Ø§Ù…ÙˆØ´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
  if (intent === "nginx") return "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ/Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª nginx Ùˆ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.";
  if (c) return `Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯: Â«${ur || "Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆØ±Ø¯Ù†Ø¸Ø±"}Â».`;
  return `Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§: Â«${ur || "Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆØ±Ø¯Ù†Ø¸Ø±"}Â».`;
}

function buildToolMarkdown({ fenceLang, codeLines, explanation, warnings, alternatives, isFa }) {
  const hExplain = isFa ? "ØªÙˆØ¶ÛŒØ­" : "Explanation";
  const hWarn = isFa ? "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "Warnings";
  const hAlt = isFa ? "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" : "Alternatives";

  const codeBlock = `\`\`\`${fenceLang}\n${codeLines.join("\n")}\n\`\`\``;
  const altBlock = `\`\`\`${fenceLang}\n${alternatives.join("\n")}\n\`\`\``;

  return [
    codeBlock,
    "",
    `## ${hExplain}`,
    explanation.trim(),
    "",
    `## ${hWarn}`,
    warnings.trim(),
    "",
    `## ${hAlt}`,
    altBlock,
  ].join("\n");
}

export function formatToolResponse({
  outputType = "tool",
  text = "",
  cli = "bash",
  os = "linux",
  lang = "fa",
  userRequest = "",
} = {}) {
  const isFa = String(lang || "").toLowerCase().startsWith("fa") || hasFaChars(text) || hasFaChars(userRequest);

  const { codeRaw, rest } = splitFirstCodeBlock(text);
  let codeLines = normalizeCodeToCommands(codeRaw, { maxLines: 40 });

  if (!codeLines.length) {
    const guessed = guessPrimaryCommandFromText(text);
    if (guessed) codeLines = [guessed];
  }

  // For tool output: keep FIRST command only (fast + strict)
  const primary = codeLines.find(Boolean) ? [codeLines.find(Boolean)] : [""];

  const intent = intentFromRequest(userRequest, primary[0]);
  const explanation = pickFirstSentence(rest) || explanationFor(intent, primary[0], userRequest, isFa);
  const warnings = ensureBullets([], warningsFor(intent));
  const alternatives = ensure3Alternatives(alternativesFor(intent, primary[0]));

  const fenceLang = fenceLangFromCli(cli, "command");
  return buildToolMarkdown({
    fenceLang,
    codeLines: primary,
    explanation,
    warnings,
    alternatives,
    isFa,
  }).trim();
}

export function formatOutput({ outputType = "markdown", text = "", cli = "bash", os = "linux", lang = "fa", userRequest = "" } = {}) {
  const ot = String(outputType || "").toLowerCase();

  // Tool-like strict format (web generator)
  if (ot === "tool" || ot === "markdown") {
    return formatToolResponse({ outputType: ot, text, cli, os, lang, userRequest });
  }

  // Minimal (CLI/legacy)
  if (ot === "command") {
    const fenceLang = fenceLangFromCli(cli, "command");
    const { codeRaw } = splitFirstCodeBlock(text);
    let cmds = normalizeCodeToCommands(codeRaw);
    if (!cmds.length) {
      const guessed = guessPrimaryCommandFromText(text);
      if (guessed) cmds = [guessed];
    }
    const first = cmds.find(Boolean) || "";
    return `\`\`\`${fenceLang}\n${first}\n\`\`\``.trim();
  }

  // Default: pass through
  return String(text || "").trim();
}

================================================================================
FILE: .ccg_backups/fix_js_not_in_20260108_053111/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useRef, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";

const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const VERBOSITY = [
  { value: "brief", label: "brief" },
  { value: "normal", label: "normal" },
  { value: "detailed", label: "detailed" },
];

const OUTPUT_TYPES = [
  { value: "tool", label: "Tool (UI)" },
  { value: "markdown", label: "Markdown" },
  { value: "command", label: "Command" },
  { value: "python", label: "Python" },
];

// Platform-specific Advanced options
const LINUX_DISTROS = ["Ubuntu", "Debian", "RHEL", "Rocky", "AlmaLinux", "CentOS", "Fedora", "Arch", "Manjaro", "openSUSE", "Alpine", "Kali"];
const WINDOWS_EDITIONS = ["Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022"];
const MACOS_VERSIONS = ["macOS (generic)", "Sonoma (14)", "Ventura (13)", "Monterey (12)"];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh", "fish"],
  mac: ["zsh", "bash"],
  windows: ["powershell", "cmd"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "fish", "powershell", "cmd", "pwsh", "ksh", "tcsh"],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "mikrotik", label: "MikroTik" },
  { value: "fortinet", label: "Fortinet" },
  { value: "juniper", label: "Juniper" },
  { value: "huawei", label: "Huawei" },
  { value: "generic", label: "Generic" },
];

const NETWORK_DEVICE_TYPES = {
  cisco: ["router", "switch", "firewall"],
  mikrotik: ["router", "switch"],
  fortinet: ["firewall", "router"],
  juniper: ["router", "switch", "firewall"],
  huawei: ["router", "switch", "firewall"],
  generic: ["router", "switch", "firewall", "ap", "loadbalancer", "general"],
};

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}
function isSafeFreeText(v, minLen = 2, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}
function readUrlState() {
  try {
    const u = new URL(window.location.href);
    const q = u.searchParams;
    const obj = {
      platform: q.get("platform") || "",
      cli: q.get("cli") || "",
      out: q.get("out") || "",
      v: q.get("v") || "",
      advanced: q.get("adv") || "",
      swap: q.get("swap") || "",
      distro: q.get("distro") || "",
      osver: q.get("osver") || "",
      win: q.get("win") || "",
      mac: q.get("mac") || "",
      vendor: q.get("vendor") || "",
      dtype: q.get("dtype") || "",
      custom: q.get("custom") || "",
      cos: q.get("cos") || "",
      csh: q.get("csh") || "",
    };
    return obj;
  } catch {
    return {};
  }
}
function writeUrlState(patch) {
  try {
    const u = new URL(window.location.href);
    const q = u.searchParams;
    Object.entries(patch).forEach(([k, v]) => {
      if (v === undefined || v === null || v === "" || v === false) q.delete(k);
      else q.set(k, String(v));
    });
    window.history.replaceState({}, "", u.toString());
  } catch {}
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active ? "bg-blue-600 text-white" : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}
function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      {tip ? (
        <span className="relative group">
          <button type="button" className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10" aria-label={`${label} help`}>
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  const { lang, t } = useLanguage();
  const isRTL = lang === "fa";

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");
  const [valErr, setValErr] = useState("");
  const [output, setOutput] = useState("");
  const [toolResult, setToolResult] = useState(null);

  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");

  const [advanced, setAdvanced] = useState(false);
  const [swapLayout, setSwapLayout] = useState(false);

  // Advanced fields (platform-specific)
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [osVersion, setOsVersion] = useState("");
  const [windowsEdition, setWindowsEdition] = useState("Windows 11");
  const [macosVersion, setMacosVersion] = useState("macOS (generic)");

  // Network fields (always visible when platform=network)
  const [vendor, setVendor] = useState("cisco");
  const [deviceType, setDeviceType] = useState("router");

  // Other/custom
  const [customEnabled, setCustomEnabled] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  // Restore state from URL/localStorage
  const didInit = useRef(false);
  useEffect(() => {
    if (didInit.current) return;
    didInit.current = true;

    const url = readUrlState();
    let ls = {};
    try { ls = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch {}

    const src = { ...ls, ...url };

    if (src.platform) setPlatform(src.platform);
    if (src.cli) setCli(src.cli);
    if (src.out) setOutputType(src.out);
    if (src.v) setVerbosity(src.v);

    if (src.adv !== "") setAdvanced(src.adv === "1" || src.adv === "true");
    if (src.swap !== "") setSwapLayout(src.swap === "1" || src.swap === "true");

    if (src.distro) setLinuxDistro(src.distro);
    if (src.osver) setOsVersion(src.osver);

    if (src.win) setWindowsEdition(src.win);
    if (src.mac) setMacosVersion(src.mac);

    if (src.vendor) setVendor(src.vendor);
    if (src.dtype) setDeviceType(src.dtype);

    if (src.custom !== "") setCustomEnabled(src.custom === "1" || src.custom === "true");
    if (src.cos) setCustomOS(src.cos);
    if (src.csh) setCustomShell(src.csh);
  }, []);

  // Keep cli list synced with platform
  const cliOptions = useMemo(() => {
    const list = SHELL_BY_PLATFORM[platform] || ["bash"];
    return list;
  }, [platform]);

  useEffect(() => {
    // If current cli not valid for platform, reset to first
    const list = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!list.includes(cli)) setCli(list[0]);
  }, [platform]); // eslint-disable-line

  useEffect(() => {
    // keep deviceType synced with vendor
    const d = NETWORK_DEVICE_TYPES[vendor] || NETWORK_DEVICE_TYPES.generic;
    if (!d.includes(deviceType)) setDeviceType(d[0]);
  }, [vendor]); // eslint-disable-line

  // Persist state to localStorage + URL (safe, lightweight)
  useEffect(() => {
    const snap = {
      platform, cli, out: outputType, v: verbosity,
      adv: advanced, swap: swapLayout,
      distro: linuxDistro, osver: osVersion,
      win: windowsEdition, mac: macosVersion,
      vendor, dtype: deviceType,
      custom: customEnabled, cos: customOS, csh: customShell,
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(snap)); } catch {}
    writeUrlState({
      platform, cli, out: outputType, v: verbosity,
      adv: advanced ? "1" : "",
      swap: swapLayout ? "1" : "",
      distro: platform === "linux" ? linuxDistro : "",
      osver: advanced ? osVersion : "",
      win: platform === "windows" ? windowsEdition : "",
      mac: platform === "mac" ? macosVersion : "",
      vendor: platform === "network" ? vendor : "",
      dtype: platform === "network" ? deviceType : "",
      custom: (platform === "other" && advanced && customEnabled) ? "1" : "",
      cos: (platform === "other" && advanced && customEnabled) ? customOS : "",
      csh: (platform === "other" && advanced && customEnabled) ? customShell : "",
    });
  }, [platform, cli, outputType, verbosity, advanced, swapLayout, linuxDistro, osVersion, windowsEdition, macosVersion, vendor, deviceType, customEnabled, customOS, customShell]);

  function buildOsCli() {
    if (platform === "linux") {
      const name = linuxDistro || "Linux";
      const ver = advanced ? cleanToken(osVersion) : "";
      return { os: ver ? `${name} ${ver}` : name, cli };
    }
    if (platform === "windows") {
      const name = windowsEdition || "Windows";
      const ver = advanced ? cleanToken(osVersion) : "";
      // Allow "11 23H2" style in version, optional
      return { os: ver ? `${name} ${ver}` : name, cli };
    }
    if (platform === "mac") {
      const name = macosVersion || "macOS";
      const ver = advanced ? cleanToken(osVersion) : "";
      return { os: ver ? `${name} ${ver}` : name, cli };
    }
    if (platform === "network") {
      return { os: "network", cli: "cli" };
    }
    // other
    return { os: cleanToken(customOS), cli: cleanToken(customShell || cli) };
  }

  function validateBeforeSend({ mode }) {
    const errs = [];

    if (!input.trim() && mode === "generate") errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯." : "Enter your request.");
    if (mode === "explain" && !toolResult?.primary?.command) errs.push(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ú¯ÛŒØ± ØªØ§ Command Ø¨Ø±Ø§ÛŒ ØªÙˆØ¶ÛŒØ­ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯." : "Generate first to have a command to explain.");

    if (platform === "other") {
      if (!advanced) errs.push(isRTL ? "Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² OtherØŒ Advanced Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯." : "Enable Advanced for Other.");
      if (!customEnabled) errs.push(isRTL ? "Ø¨Ø±Ø§ÛŒ Other Ø¨Ø§ÛŒØ¯ Custom OS/Shell Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯." : "Enable Custom OS/Shell for Other.");
      const osOk = isSafeFreeText(customOS, 2, 40);
      const shOk = isSafeFreeText(customShell, 2, 20);
      if (!osOk) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. ÙÙ‚Ø· Ø­Ø±ÙˆÙ/Ø¹Ø¯Ø¯/ÙØ§ØµÙ„Ù‡ Ùˆ . _ + - / (Û² ØªØ§ Û´Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)." : "Invalid Custom OS.");
      if (!shOk) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Û² ØªØ§ Û²Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)." : "Invalid Custom Shell/CLI.");
    }

    if (platform === "linux" && advanced) {
      if (linuxDistro && linuxDistro not in []) {} // noop
      if (osVersion && !isSafeFreeText(osVersion, 0, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    if (platform === "network") {
      if (!vendor) errs.push(isRTL ? "Vendor Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯." : "Pick a vendor.");
      if (!deviceType) errs.push(isRTL ? "Device type Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯." : "Pick a device type.");
    }

    return errs;
  }

  function buildPayload(mode) {
    const base = {
      mode,
      lang,
      outputType,
      verbosity,
      user_request: mode === "generate" ? input.trim() : (input.trim() || "Explain this command"),
    };

    // If custom enabled (Other), ONLY send minimal required fields (no noise)
    if (platform === "other" && advanced && customEnabled) {
      return {
        ...base,
        platform: "other",
        os: cleanToken(customOS),
        cli: cleanToken(customShell),
      };
    }

    if (platform === "network") {
      return {
        ...base,
        platform: "network",
        os: "network",
        cli: "cli",
        vendor,
        deviceType,
      };
    }

    const { os, cli: c } = buildOsCli();
    return {
      ...base,
      platform,
      os,
      cli: c,
    };
  }

  async function generate() {
    setApiErr("");
    setValErr("");
    setToolResult(null);
    setOutput("");

    const errs = validateBeforeSend({ mode: "generate" });
    if (errs.length) { setValErr(errs.join("\n")); return; }

    setLoading(true);
    try {
      const payload = buildPayload("generate");
      const res = await callCCG(payload);
      const md = res?.markdown || res?.output || "";
      const tool = res?.tool || null;

      setToolResult(tool);
      // render preference:
      if (outputType === "tool" && tool) setOutput(md || "");
      else setOutput(md || "");
    } catch (e) {
      setApiErr(String(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error")));
    } finally {
      setLoading(false);
    }
  }

  async function explainLast() {
    setApiErr("");
    setValErr("");

    const errs = validateBeforeSend({ mode: "explain" });
    if (errs.length) { setValErr(errs.join("\n")); return; }

    setLoading(true);
    try {
      const target = toolResult?.primary?.command || "";
      const payload = {
        ...buildPayload("explain"),
        targetCommand: target,
        user_request: input.trim() || (isRTL ? "Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø´Ø®ØµÛŒ" : "Personal system"),
      };
      const res = await callCCG(payload);
      setToolResult(res?.tool || null);
      setOutput(res?.markdown || res?.output || "");
    } catch (e) {
      setApiErr(String(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error")));
    } finally {
      setLoading(false);
    }
  }

  const requestOrder = useMemo(() => {
    if (swapLayout) return "order-1";
    return isRTL ? "order-2" : "order-1";
  }, [swapLayout, isRTL]);

  const outputOrder = useMemo(() => {
    if (swapLayout) return "order-2";
    return isRTL ? "order-1" : "order-2";
  }, [swapLayout, isRTL]);

  const networkDeviceOptions = useMemo(() => (NETWORK_DEVICE_TYPES[vendor] || NETWORK_DEVICE_TYPES.generic), [vendor]);

  const requestPlaceholder = isRTL
    ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø¶Ø­ Ø¨Ù†ÙˆÛŒØ³ (Ù‡Ø¯Ù + Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§). Ù…Ø«Ø§Ù„: Â«Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… ÙØ¶Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø¯ÛŒØ³Ú© Ø±Ùˆ Ø¨Ø¨ÛŒÙ†Ù…Â»"
    : "Write your request clearly (goal + constraints). e.g. â€œCheck disk free spaceâ€";

  return (
    <div dir={isRTL ? "rtl" : "ltr"} className="space-y-8">
      {/* Context / Controls */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            <FieldLabel label={isRTL ? "Ù¾Ù„ØªÙØ±Ù…" : "Platform"} tip={isRTL ? "Ø³ÛŒØ³ØªÙ…/Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù‡Ø¯Ù Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†." : "Select target system/device."} />
            <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
              {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <FieldLabel label={isRTL ? "CLI / Ø´ÙÙ„" : "CLI/Shell"} tip={isRTL ? "Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± (bash/cmd/pwsh...)" : "Execution shell/CLI."} />
            <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm" disabled={platform==="network"}>
              {cliOptions.map(x => <option key={x} value={x}>{x}</option>)}
            </select>

            <FieldLabel label={isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"} tip={isRTL ? "Tool Ø¨Ø±Ø§ÛŒ UI Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡ØŒ Markdown Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ú©Ø§Ù…Ù„ØŒ Command ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±." : "Tool UI / Markdown / Command only."} />
            <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
              {OUTPUT_TYPES.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <FieldLabel label="Verbosity" tip={isRTL ? "Ø³Ø·Ø­ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆØ¶ÛŒØ­ (Ø±ÙˆÛŒ Explain Ø§Ø«Ø± Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø±Ø¯)." : "Explanation detail level (affects Explain)."} />
            <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
              {VERBOSITY.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <div className="flex items-center gap-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm opacity-80">{isRTL ? "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨ÛŒØ´ØªØ±" : "Advanced"}</label>
            </div>

            <div className="flex items-center gap-2">
              <input id="ccg-swap" type="checkbox" checked={swapLayout} onChange={(e)=>setSwapLayout(e.target.checked)} />
              <label htmlFor="ccg-swap" className="text-sm opacity-80">{isRTL ? "Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§" : "Swap columns"}</label>
            </div>
          </div>

          {/* Advanced panel */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] bg-white/5 p-4">
              {platform === "linux" ? (
                <div className="flex flex-wrap gap-4 items-center">
                  <FieldLabel label={isRTL ? "ØªÙˆØ²ÛŒØ¹" : "Distro"} tip={isRTL ? "ØªÙˆØ²ÛŒØ¹ Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ ÙˆÙ„ÛŒ Ù…ÙÛŒØ¯)." : "Linux distribution (optional but helpful)."} />
                  <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select text-sm">
                    {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                  </select>

                  <FieldLabel label={isRTL ? "ÙˆØ±Ú˜Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "Version (optional)"} tip={isRTL ? "Ø§Ú¯Ø± Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÛŒ Ø®Ø§Ù„ÛŒ Ø¨Ø°Ø§Ø±." : "Leave empty if unsure."} />
                  <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input text-sm" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                </div>
              ) : null}

              {platform === "windows" ? (
                <div className="flex flex-wrap gap-4 items-center">
                  <FieldLabel label={isRTL ? "Ù†Ø³Ø®Ù‡ ÙˆÛŒÙ†Ø¯ÙˆØ²" : "Windows edition"} tip={isRTL ? "Windows 10/11 ÛŒØ§ Server..." : "Pick Windows edition."} />
                  <select value={windowsEdition} onChange={(e)=>setWindowsEdition(e.target.value)} className="ccg-select text-sm">
                    {WINDOWS_EDITIONS.map(x => <option key={x} value={x}>{x}</option>)}
                  </select>

                  <FieldLabel label={isRTL ? "ÙˆØ±Ú˜Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "Version (optional)"} tip={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 23H2 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "e.g. 23H2 (optional)"} />
                  <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input text-sm" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 23H2" : "e.g. 23H2"} />
                </div>
              ) : null}

              {platform === "mac" ? (
                <div className="flex flex-wrap gap-4 items-center">
                  <FieldLabel label={isRTL ? "Ù†Ø³Ø®Ù‡ macOS" : "macOS version"} tip={isRTL ? "Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ¯ÙˆÙ†ÛŒ generic Ø¨Ø²Ù†." : "Use generic if unsure."} />
                  <select value={macosVersion} onChange={(e)=>setMacosVersion(e.target.value)} className="ccg-select text-sm">
                    {MACOS_VERSIONS.map(x => <option key={x} value={x}>{x}</option>)}
                  </select>

                  <FieldLabel label={isRTL ? "ÙˆØ±Ú˜Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" : "Version (optional)"} tip={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "Optional"} />
                  <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input text-sm" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                </div>
              ) : null}

              {platform === "other" ? (
                <div className="space-y-3">
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customEnabled} onChange={(e)=>setCustomEnabled(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">
                      {isRTL ? "Custom OS/Shell" : "Custom OS/Shell"}
                    </label>
                  </div>

                  {customEnabled ? (
                    <div className="flex flex-wrap gap-4 items-center">
                      <div className="min-w-[240px]">
                        <FieldLabel label={isRTL ? "Ù†Ø§Ù… Ø³ÛŒØ³ØªÙ…â€ŒØ¹Ø§Ù…Ù„" : "Custom OS"} tip={isRTL ? "ÙÙ‚Ø· Ø­Ø±ÙˆÙ/Ø¹Ø¯Ø¯/ÙØ§ØµÙ„Ù‡ Ùˆ . _ + - /" : "Letters/numbers/space and . _ + - / only"} />
                        <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input text-sm w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                      </div>
                      <div className="min-w-[200px]">
                        <FieldLabel label={isRTL ? "Ø´ÙÙ„/CLI" : "Custom Shell/CLI"} tip={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ bash ÛŒØ§ cmd ÛŒØ§ pwsh" : "e.g. bash/cmd/pwsh"} />
                        <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input text-sm w-full" placeholder="bash" />
                      </div>
                    </div>
                  ) : null}
                </div>
              ) : null}
            </div>
          ) : null}

          {/* Network (always visible for network) */}
          {platform === "network" ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] bg-white/5 p-4">
              <div className="flex flex-wrap gap-4 items-center">
                <FieldLabel label={isRTL ? "Vendor" : "Vendor"} tip={isRTL ? "Ø¨Ø±Ù†Ø¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ø¨Ú©Ù‡" : "Network vendor"} />
                <select value={vendor} onChange={(e)=>setVendor(e.target.value)} className="ccg-select text-sm">
                  {NETWORK_VENDORS.map(v => <option key={v.value} value={v.value}>{v.label}</option>)}
                </select>

                <FieldLabel label={isRTL ? "Device type" : "Device type"} tip={isRTL ? "Ù†ÙˆØ¹ Ø¯Ø³ØªÚ¯Ø§Ù‡ (router/switch/firewall...)" : "router/switch/firewall..."} />
                <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select text-sm">
                  {networkDeviceOptions.map(x => <option key={x} value={x}>{x}</option>)}
                </select>
              </div>
            </div>
          ) : null}
        </div>
      </div>

      {/* Main grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Request */}
          <div className={`ccg-card p-5 sm:p-7 ${requestOrder}`}>
            <h2 className="text-lg font-semibold mb-4">{isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª" : "Request"}</h2>

            <textarea
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              className="ccg-textarea"
              placeholder={requestPlaceholder}
              rows={8}
            />

            {valErr ? (
              <div className="ccg-error mt-3 whitespace-pre-wrap">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ" : "Input error"}</div>
                <div className="text-sm">{valErr}</div>
              </div>
            ) : null}

            {apiErr ? (
              <div className="ccg-error mt-3 whitespace-pre-wrap">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§ÛŒ API" : "API error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            <div className="mt-4 flex gap-3 justify-end">
              <button className="ccg-btn" type="button" onClick={explainLast} disabled={loading || !toolResult?.primary?.command}>
                {isRTL ? "ØªÙˆØ¶ÛŒØ­ Ø¯Ø³ØªÙˆØ±" : "Explain command"}
              </button>
              <button className="ccg-btn-primary" type="button" onClick={generate} disabled={loading}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯..." : "Generating...") : (isRTL ? "ØªÙˆÙ„ÛŒØ¯" : "Generate")}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={`ccg-card p-5 sm:p-7 ${outputOrder}`}>
            <h2 className="text-lg font-semibold mb-4">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>

            {outputType === "tool" && toolResult ? (
              <ToolResult tool={toolResult} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/generator_toolfix_v1/20260102_111613/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Ù‡Ø¯Ù: Ø§Ú¯Ø± outputType=command ÛŒØ§ script Ø¨ÙˆØ¯ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ù‡ ÛŒÚ© code fence Ù‚Ø§Ø¨Ù„ Ú©Ù¾ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†Ø¯
// Ùˆ Ø¯Ø± Ø­Ø§Ù„Øª command ØªØ§ Ø­Ø¯ Ù…Ù…Ú©Ù† ÙÙ‚Ø· "Ø®ÙˆØ¯ ÙØ±Ù…Ø§Ù†" Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±Ø¯.
export function formatOutput({ outputType, text, preferredLang = "bash" }) {
  const t = String(text ?? "").trim();
  const ot = String(outputType ?? "").toLowerCase();
  if (!["script", "command"].includes(ot)) return t;

  // 1) if a fenced code block exists, use its content
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```/);
  let code = (m ? m[1] : "").trim();

  // 2) otherwise try to pick first command-like line
  if (!code) {
    const lines = t
      .split("\n")
      .map((l) => l.trim())
      .filter(Boolean);

    const cmdRe =
      /^(sudo\s+)?(systemctl|service|journalctl|nginx|docker|kubectl|apt|apt-get|yum|dnf|pacman|brew|git|npm|pnpm|yarn|node|python3?|pip3?|curl|wget|ss|netstat|lsof|ps|top|htop|df|du|free|ip|ifconfig|ping|traceroute|ufw|firewall-cmd|chmod|chown|tar|zip|unzip|ls|cd|cat|grep|awk|sed|find|rm|cp|mv|mkdir|touch)\b/i;

    const firstCmd = lines.find((l) => cmdRe.test(l));
    code = (firstCmd || lines[0] || "").trim();
  }

  if (!code) return `\`\`\`${preferredLang}\n\n\`\`\``;

  // if command => keep only first non-empty line
  if (ot === "command") {
    const firstLine = code
      .split("\n")
      .map((l) => l.trim())
      .filter(Boolean)[0];
    if (firstLine) code = firstLine;
  }

  return `\`\`\`${preferredLang}\n${code}\n\`\`\``;
}

================================================================================
FILE: .ccg_backups/fix_outputFormatter_tool_markdown_20260107_141708/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract Normalizer (Generator + Explain)
// Guarantees:
// - output: string (markdown)
// - tool: object (primary/explanation/warnings/alternatives)
// - In Explain mode, primary.command MUST NOT change (forcedCommand)
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // basic shell/cmd/pwsh command-like token
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map((l) => l.replace(/\r/g, "").trim())
    .filter(Boolean);

  const cmdLines = [];
  for (const l of lines) {
    if (looksLikeCommand(l)) cmdLines.push(l);
  }
  return cmdLines.join("\n").trim();
}

function ensureArray(x) {
  if (Array.isArray(x)) return x.filter(Boolean).map(String);
  if (!x) return [];
  return [String(x)];
}

function toMarkdownTemplate({ langTag, primaryCmd, explanation, warnings, alternatives }) {
  const warnLines = warnings.length ? warnings : [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ùˆ Ø§Ø«Ø± ÙØ±Ù…Ø§Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
    "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ùˆ Ø¨Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    "Ø§Ú¯Ø± Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÛŒØ¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯."
  ];

  const alts = (alternatives && alternatives.length ? alternatives : []).slice(0, 3);
  while (alts.length < 3) {
    alts.push({ command: "", note: "â€”" });
  }

  const altMd = alts.map((a) => {
    const note = a?.note ? `- ${String(a.note).trim()}` : "- â€”";
    const cmd = String(a?.command || "").trim();
    const block = cmd ? `\n\n\`\`\`${langTag}\n${cmd}\n\`\`\`\n` : `\n\n\`\`\`${langTag}\n# (no alternative)\n\`\`\`\n`;
    return `${note}${block}`;
  }).join("\n");

  return [
    `\`\`\`${langTag}\n${primaryCmd}\n\`\`\``,
    ``,
    `## ØªÙˆØ¶ÛŒØ­`,
    explanation || "â€”",
    ``,
    `## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§`,
    warnLines.map((w) => `- ${w}`).join("\n"),
    ``,
    `## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§`,
    altMd.trim()
  ].join("\n");
}

// Main: parse raw model text OR accept already-structured tool object.
export function formatToolResponse({
  text,
  cli = "bash",
  outputType = "tool",
  forcedCommand = "",
  lang = "fa"
} = {}) {
  const langTag = fenceLangFromCli(cli, outputType);

  // If model returned JSON-like object in text, we won't parse JSON here (avoid brittle).
  // We normalize from markdown style output.
  const raw = String(text ?? "").trim();
  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  const cleanedInsideFence = normalizeCodeToCommands(codeRaw);

  // Primary command rule:
  // - If forcedCommand provided (Explain mode), use it no matter what.
  // - Else, use cleanedInsideFence, else try to find first command line from rest.
  let primaryCmd = String(forcedCommand || "").trim();
  if (!primaryCmd) {
    primaryCmd = cleanedInsideFence;
  }
  if (!primaryCmd) {
    const firstCmd = String(rest || "")
      .split("\n")
      .map((x) => x.trim())
      .find((x) => looksLikeCommand(x));
    primaryCmd = (firstCmd || "echo \"No command produced\"").trim();
  }

  // Extract sections from rest if present (best-effort), otherwise keep short.
  const explanation = (() => {
    // take first paragraph-ish after removing headings
    const r = String(rest || "").trim();
    if (!r) return "";
    // strip headings and bullets to keep concise explanation
    const cleaned = r
      .replace(/^#{1,6}\s+.*$/gm, "")
      .replace(/^\s*-\s+/gm, "")
      .trim();
    // limit length
    return cleaned.slice(0, 600).trim();
  })();

  // Safety: warnings must exist. We'll also add command-specific warnings.
  const baseWarnings = [
    lang === "fa" ? "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯." : "Save unsaved work before running.",
  ];

  const cmdLower = primaryCmd.toLowerCase();
  const extraWarnings = [];
  if (cmdLower.includes("reboot") || cmdLower.includes("shutdown")) {
    extraWarnings.push(lang === "fa" ? "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "SSH sessions will disconnect.");
    extraWarnings.push(lang === "fa" ? "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯." : "In production, schedule/notify first.");
  }
  if (/\brm\b/.test(cmdLower) || cmdLower.includes("mkfs") || cmdLower.includes("dd ")) {
    extraWarnings.push(lang === "fa" ? "Ø§ÛŒÙ† ÙØ±Ù…Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†Ø¯Ø› Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯." : "This can delete data; double-check before running.");
  }

  const warnings = Array.from(new Set([...baseWarnings, ...extraWarnings]));

  // Alternatives: best-effort. If we detect known intents, produce 3 stable alts.
  const alternatives = (() => {
    // simple known patterns:
    if (cmdLower.includes("systemctl status nginx")) {
      return [
        { command: "sudo systemctl status nginx", note: lang==="fa" ? "Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨ÛŒØ´ØªØ±" : "With sudo" },
        { command: "sudo service nginx status", note: lang==="fa" ? "Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±" : "Legacy method" },
        { command: "ps aux | grep nginx", note: lang==="fa" ? "Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÛŒ Ù¾Ø±ÙˆØ³Ø³â€ŒÙ‡Ø§" : "Check processes" },
      ];
    }
    if (cmdLower.startsWith("shutdown") && (cmdLower.includes("/s") || cmdLower.includes("-s"))) {
      // Windows shutdown
      return [
        { command: "shutdown /a", note: lang==="fa" ? "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" : "Abort scheduled shutdown" },
        { command: "shutdown /s /t 0", note: lang==="fa" ? "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" : "Shutdown now" },
        { command: "shutdown /r /t 60", note: lang==="fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ÛŒ" : "Restart instead" },
      ];
    }
    if (cmdLower.includes("reboot") || cmdLower.includes("shutdown -r") || cmdLower.includes("systemctl reboot")) {
      return [
        { command: "sudo systemctl reboot", note: lang==="fa" ? "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ systemd" : "systemd standard" },
        { command: "sudo shutdown -r now", note: lang==="fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" : "Immediate reboot" },
        { command: "sudo shutdown -r +1", note: lang==="fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ ØªØ£Ø®ÛŒØ± Û± Ø¯Ù‚ÛŒÙ‚Ù‡" : "Reboot in 1 minute" },
      ];
    }
    // fallback: show safe placeholders but never empty
    return [
      { command: primaryCmd, note: lang==="fa" ? "ØªÚ©Ø±Ø§Ø± ÙØ±Ù…Ø§Ù† Ø§ØµÙ„ÛŒ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)" : "Repeat primary command" },
      { command: primaryCmd, note: lang==="fa" ? "Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯" : "Run in staging first" },
      { command: primaryCmd, note: lang==="fa" ? "Ø¨Ø§ sudo/Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯" : "Run with proper privileges" },
    ];
  })();

  const tool = {
    primary: { command: primaryCmd, lang: langTag },
    explanation: explanation || (lang==="fa" ? "â€”" : "â€”"),
    warnings,
    alternatives: alternatives.slice(0, 3),
  };

  const markdown = toMarkdownTemplate({
    langTag,
    primaryCmd: tool.primary.command,
    explanation: tool.explanation,
    warnings: tool.warnings,
    alternatives: tool.alternatives
  });

  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/final_tool_layout/20260103_053551/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/final_tool_layout/20260103_053551/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// CCG Tool-Style Post-Processor (Generator)
//
// Guarantees:
// 1) Output starts with exactly ONE fenced code block (command/script).
// 2) Code fence contains ONLY command-like lines (no prose inside).
// 3) Always includes sections: ØªÙˆØ¶ÛŒØ­ / Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (filled if missing).
//
// Backward-compatible exports:
// - formatOutput
// - formatToolResponse (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function hasFaChars(s) {
  return /[\u0600-\u06FF]/.test(String(s || ""));
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;

  // reject obvious prose/punctuation-ending lines
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;

  // allow comments/shebang in scripts
  if (s.startsWith("#!") || s.startsWith("#")) return true;

  // simple "command-ish" start (sudo + token)
  if (/^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s)) return true;

  return false;
}

function normalizeCodeToCommands(codeRaw) {
  const raw = String(codeRaw || "").replace(/\r\n/g, "\n");
  const lines = raw.split("\n").map(l => l.trim()).filter(Boolean);

  const cmdLines = [];
  for (const l of lines) {
    // drop "explanations" that accidentally got into code block
    if (!looksLikeCommand(l)) continue;

    // also drop pure prose Farsi lines
    if (hasFaChars(l) && !/^(sudo\s+)?[a-zA-Z0-9._-]+/.test(l)) continue;

    cmdLines.push(l);
  }

  // If nothing survived, try best-effort: first non-empty line
  if (!cmdLines.length && lines.length) cmdLines.push(lines[0]);

  // Deduplicate consecutive identical lines
  const out = [];
  for (const l of cmdLines) {
    if (!out.length || out[out.length - 1] !== l) out.push(l);
  }
  return out;
}

function pickSection(md, titles) {
  const raw = String(md || "").replace(/\r\n/g, "\n");
  for (const title of titles) {
    const re = new RegExp(`^##\\s+${title}\\s*\\n([\\s\\S]*?)(?=^##\\s+|\\Z)`, "m");
    const m = raw.match(re);
    if (m) return String(m[1] || "").trim();
  }
  return "";
}

function toBullets(text) {
  const t = String(text || "").trim();
  if (!t) return [];
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);
  const cleaned = lines.map(l => l.replace(/^[-*]\s+/, "").replace(/^\d+\.\s+/, "").trim()).filter(Boolean);
  return cleaned;
}

function ensureBullets(items, fallbackItems) {
  const a = Array.isArray(items) ? items.filter(Boolean) : [];
  if (a.length) return a;
  return fallbackItems.filter(Boolean);
}

function classifyCommand(firstCmd) {
  const s = String(firstCmd || "").toLowerCase();

  const isReboot = /\b(reboot|shutdown\s+-r|systemctl\s+reboot)\b/.test(s);
  const isShutdown = /\b(poweroff|halt|shutdown\s+-h|systemctl\s+poweroff)\b/.test(s);
  const isServiceRestart = /\b(systemctl\s+restart|service\s+\S+\s+restart)\b/.test(s);
  const isFirewall = /\b(ufw|firewall-cmd)\b/.test(s);
  const isDangerRm = /\brm\b/.test(s) && (/\s-\w*rf\w*/.test(s) || /\s--no-preserve-root\b/.test(s));
  const isPkg = /\b(apt|dnf|yum|pacman)\b/.test(s);

  return { isReboot, isShutdown, isServiceRestart, isFirewall, isDangerRm, isPkg };
}

function enrichFa({ cmdLines, firstCmd }) {
  const c = classifyCommand(firstCmd);

  // Explanation (short)
  let explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø± Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.";
  if (c.isReboot) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª (Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯) Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
  else if (c.isShutdown) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
  else if (c.isServiceRestart) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ù‚Ø·Ø¹ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´ÙˆØ¯).";
  else if (c.isFirewall) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ ÙØ§ÛŒØ±ÙˆØ§Ù„ Ø§Ø³Øª Ùˆ Ø±ÙˆÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ø¨Ú©Ù‡ Ø§Ø«Ø± Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø±Ø¯.";
  else if (c.isDangerRm) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙØ§ÛŒÙ„/Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„Øª ÙØ¹Ù„ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØºÛŒØ±Ù‚Ø§Ø¨Ù„â€ŒØ¨Ø§Ø²Ú¯Ø´Øª Ø¨Ø§Ø´Ø¯.";
  else if (c.isPkg) explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§/Ù†ØµØ¨ Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.";

  // Warnings
  const warnings = [];
  if (cmdLines.some(l => l.trim().startsWith("sudo "))) {
    warnings.push("Ø¨Ø§ sudo Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…Ø§Ù† Ú†ÛŒØ²ÛŒ Ø§Ø³Øª Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯.");
  }
  if (c.isReboot) {
    warnings.push("Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±ØªØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
    warnings.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
  }
  if (c.isShutdown) {
    warnings.push("Ù‚Ø¨Ù„ Ø§Ø² Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù†ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
    warnings.push("Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø± Ù‡Ø³ØªÙ†Ø¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ shutdown Ø§ØµÙˆÙ„ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.");
  }
  if (c.isServiceRestart) {
    warnings.push("Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø¹Ø« Ù‚Ø·Ø¹ÛŒ Ù…ÙˆÙ‚Øª Ø´ÙˆØ¯Ø› Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·.");
    warnings.push("Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯ Ø§Ø² Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³ Ùˆ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
  }
  if (c.isFirewall) {
    warnings.push("ØªØºÛŒÛŒØ±Ø§Øª ÙØ§ÛŒØ±ÙˆØ§Ù„ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ù‚ÙÙ„ Ú©Ù†Ø¯ (Ø®ØµÙˆØµØ§Ù‹ Ø±ÙˆÛŒ SSH).");
    warnings.push("Ø§Ú¯Ø± Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø­ØªÙ…Ø§Ù‹ ÛŒÚ© Ø±Ø§Ù‡ Ø¨Ø±Ú¯Ø´Øª (console/ILO) Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.");
  }
  if (c.isDangerRm) {
    warnings.push("rm -rf Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ØºÛŒØ±Ù‚Ø§Ø¨Ù„â€ŒØ¨Ø§Ø²Ú¯Ø´Øª Ø­Ø°Ù Ú©Ù†Ø¯Ø› Ù…Ø³ÛŒØ± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú†Ú© Ú©Ù†ÛŒØ¯.");
    warnings.push("Ø±ÙˆÛŒ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø­Ø³Ø§Ø³ Ù…Ø«Ù„ / ÛŒØ§ /home Ø¨Ø³ÛŒØ§Ø± Ø®Ø·Ø±Ù†Ø§Ú© Ø§Ø³Øª.");
  }
  if (!warnings.length) {
    warnings.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ ÛŒÚ© Ø¨Ø§Ø± Ù…Ø±ÙˆØ± Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ø§ --dry-run ÛŒØ§ Ø¯Ø³ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.");
  }

  // Alternatives
  const alternatives = [];
  if (c.isReboot) {
    alternatives.push("sudo systemctl reboot");
    alternatives.push("sudo shutdown -r now");
    alternatives.push("sudo shutdown -r +1  # Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±");
  } else if (c.isShutdown) {
    alternatives.push("sudo systemctl poweroff");
    alternatives.push("sudo shutdown -h now");
    alternatives.push("sudo shutdown -h +1  # Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø¨Ø§ ØªØ£Ø®ÛŒØ±");
  } else if (c.isServiceRestart) {
    alternatives.push("sudo systemctl reload <service>  # Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ Ø§Ø² reload Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ù†Ø¯");
    alternatives.push("sudo systemctl status <service>");
    alternatives.push("sudo journalctl -u <service> -n 100 --no-pager");
  } else if (c.isFirewall) {
    alternatives.push("sudo ufw status verbose");
    alternatives.push("sudo ufw allow 22/tcp  # Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø²Ø±Ú¯ØŒ SSH Ø±Ø§ Ø¨Ø§Ø² Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯");
  } else if (c.isDangerRm) {
    alternatives.push("rm -i <path>  # Ø­Ø°Ù Ø¨Ø§ ØªØ§ÛŒÛŒØ¯");
    alternatives.push("ls -la <path>  # Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°ÙØŒ Ù…Ø­ØªÙˆØ§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯");
  } else {
    alternatives.push("Ø§Ú¯Ø± Ù†ØªÛŒØ¬Ù‡ Ù†Ú¯Ø±ÙØªÛŒØ¯ØŒ ÙˆØ¶Ø¹ÛŒØª/Ù„Ø§Ú¯ Ù…Ø±ØªØ¨Ø· Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ systemctl status / journalctl).");
    alternatives.push("Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø¨Ø§ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„ --help).");
  }

  return { explanation, warnings, alternatives };
}

function normalizeSectionsFa({ rest, cmdLines }) {
  const fa = hasFaChars(rest) || true;

  // If model already wrote some sections, keep them; otherwise fill.
  const explanationRaw =
    pickSection(rest, ["ØªÙˆØ¶ÛŒØ­", "Explanation"]) ||
    (fa ? "" : "");
  const warningsRaw =
    pickSection(rest, ["Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Warnings"]) ||
    "";
  const alternativesRaw =
    pickSection(rest, ["Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "Alternatives"]) ||
    "";

  const extracted = {
    explanation: explanationRaw.trim(),
    warnings: toBullets(warningsRaw),
    alternatives: toBullets(alternativesRaw),
  };

  const enriched = enrichFa({ cmdLines, firstCmd: cmdLines[0] || "" });

  const explanation = extracted.explanation || enriched.explanation;

  const warnings = ensureBullets(extracted.warnings, enriched.warnings);
  const alternatives = ensureBullets(extracted.alternatives, enriched.alternatives);

  return { explanation, warnings, alternatives };
}

function buildMarkdownFa({ fenceLang, cmdLines, sections }) {
  const code = cmdLines.join("\n").trim();
  const warnLines = sections.warnings.map(w => `- ${w}`).join("\n");
  const altLines = sections.alternatives.map(a => `- ${a}`).join("\n");

  return [
    `\`\`\`${fenceLang}`,
    code || "",
    `\`\`\``,
    ``,
    `## ØªÙˆØ¶ÛŒØ­`,
    sections.explanation || "â€”",
    ``,
    `## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§`,
    warnLines || "- â€”",
    ``,
    `## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§`,
    altLines || "- â€”",
  ].join("\n").trim() + "\n";
}

function formatToolStyle({ outputType, text, cli = "bash" }) {
  const original = String(text ?? "").trim();
  const ot = String(outputType ?? "").toLowerCase();

  // We apply tool-style for these, because UI expects structured guidance:
  // command / script / markdown / tool
  const apply = ["command", "script", "markdown", "tool", "python"].includes(ot) || !ot;

  if (!apply) return original;

  const { codeRaw, rest } = splitFirstCodeBlock(original);

  const fenceLang = fenceLangFromCli(cli, ot);
  const cmdLines = normalizeCodeToCommands(codeRaw || rest);
  const sections = normalizeSectionsFa({ rest, cmdLines });

  return buildMarkdownFa({ fenceLang, cmdLines, sections });
}

// Newer name
export function formatOutput({ outputType, text, cli = "bash" }) {
  return formatToolStyle({ outputType, text, cli });
}

// Older name (compat)
export function formatToolResponse({ outputType, text, cli = "bash" }) {
  return formatToolStyle({ outputType, text, cli });
}

================================================================================
FILE: .ccg_backups/fix_generatorpage_structure/20260107_085409/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";



// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

// ---- Advanced: validation allowlists (client-side) ----
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES",
  "Amazon Linux","Oracle Linux","Kali","Gentoo","Alpine",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = [
  "bash","zsh","sh","fish",
  "cmd","powershell","pwsh",
  "ksh","tcsh"
];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 0, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{1,40}$/.test(s);
}


const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  
  const [customOSName, setCustomOSName] = useState("Ubuntu");
  const [customOSVersion, setCustomOSVersion] = useState("");
  const [customShell, setCustomShell] = useState("bash");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  
  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    const isOther = platform === "other";

    // Defaults (even when Advanced is closed)
    const safeMode = modeStyle || "operational";
    const safeLevel = knowledgeLevel || "intermediate";

    // Base OS/CLI mapping
    let osValue = isNetwork ? "network" : (platform || "linux");
    let cliValue = isNetwork ? "network-cli" : (shell || "bash");

    // If Other: use custom fields (validated)
    if (isOther) {
      const name = cleanToken(customOSName);
      const ver  = cleanToken(customOSVersion);
      const sh   = cleanToken(customShell).toLowerCase();

      const nameOk = !!name && (OS_ALLOWLIST.includes(name) || isSafeFreeText(name, 2, 40));
      const verOk  = ver ? isSafeFreeText(ver, 1, 20) : true;
      const shOk   = !!sh && SHELL_ALLOWLIST.includes(sh);

      const finalName = nameOk ? name : "Ubuntu";
      const finalVer  = (verOk ? ver : "");
      const finalShell= shOk ? sh : "bash";

      osValue = finalVer ? `${finalName} ${finalVer}` : finalName;
      cliValue = finalShell;
    }

    return {
      mode: "generate",
      lang: lang || "fa",
      user_request: input.trim(),

      outputType: outputType,
      modeStyle: safeMode,
      knowledgeLevel: safeLevel,

      platform: isNetwork ? "network" : (platform || "linux"),
      os: osValue,
      cli: cliValue,

      vendor: isNetwork ? (vendor || "") : "",
      deviceType: isNetwork ? (deviceType || "general") : "general",
    };
  };

  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_tdz_markdownbox_20260108_085219/MarkdownBox.jsx
================================================================================

import React, { useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";

export default function MarkdownBox({
  value = "",
  title = "",
  className = "",
  lang: langOverride,
}) {
  const { lang, t: tr } = useLanguage();
  const effectiveLang = (langOverride || lang || "en").toLowerCase();

  const labels = useMemo(() => {
    const isFa = effectiveLang === "fa";
    return {
      copy: tr?.("copy") || (isFa ? "Ú©Ù¾ÛŒ" : "Copy"),
      copied: isFa ? "Ú©Ù¾ÛŒ Ø´Ø¯" : "Copied",
      empty: isFa ? "Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª." : "Nothing to display.",
    };
  }, [effectiveLang, tr]);

  const [copied, setCopied] = useState(false);

  async function onCopy() {
    try {
      await navigator.clipboard.writeText(String(value || ""));
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {
      // ignore
    }
  }

  return (
    <div className={`ccg-card p-4 ${className}`}>
      <div className="flex items-center justify-between gap-3 mb-3">
        <div className="text-sm font-semibold text-slate-700 dark:text-slate-200">
          {title || ""}
        </div>
        <button
          type="button"
          className="ccg-btn text-xs px-3 py-2"
          onClick={onCopy}
          disabled={!String(value || "").trim()}
        >
          {copied ? labels.copied : labels.copy}
        </button>
      </div>

      {String(value || "").trim() ? (
        <pre className="whitespace-pre-wrap text-sm leading-6 text-slate-800 dark:text-slate-100">
{String(value || "").trim()}
        </pre>
      ) : (
        <div className="text-sm text-slate-500 dark:text-slate-300/70">
          {labels.empty}
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: .ccg_backups/toolstyle_fix/20260102_131717/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-style output for Generator (NOT chatty):
// - Ensure FIRST thing is ONE fenced code block for command/script.
// - Preserve the rest of the assistant output (Explanation/Warn/Alternatives).

function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  if (!t) return { code: "", rest: "" };
  // take first non-empty line as "command" if it looks like a shell line
  const lines = t.split(/\r?\n/).map(l => l.trimEnd());
  const first = lines.find(l => l.trim());
  if (!first) return { code: "", rest: t };
  // heuristic: if first line contains spaces/flags or starts with sudo/./ or common commands
  const looksCmd =
    /^(sudo|systemctl|service|journalctl|ps|top|htop|df|du|free|ip|ifconfig|ss|netstat|lsof|cat|grep|awk|sed|curl|wget|apt|dnf|yum|pacman|docker|kubectl|git|npm|node|pm2|nginx|ufw)\b/i.test(first) ||
    first.startsWith("./") || first.startsWith("chmod ") || first.startsWith("cd ");
  if (!looksCmd) return { code: "", rest: t };
  const rest = lines.slice(lines.indexOf(first) + 1).join("\n").trim();
  return { code: first.trim(), rest };
}

export function formatOutput({ outputType, text, cli = "bash" } = {}) {
  const ot = String(outputType ?? "").toLowerCase();
  const original = String(text ?? "").trim();
  if (!original) return "";

  // For command/script/python: force first fence, but keep rest.
  if (!["command", "script", "python", "markdown"].includes(ot)) {
    return original;
  }

  let { code, rest } = splitFirstCodeBlock(original);
  if (!code) {
    const g = guessCommandFromText(original);
    code = g.code;
    rest = g.rest;
  }

  // If still no code, just return original (don't destroy content).
  if (!code) return original;

  const lang = ot === "python" ? "python" : fenceLangFromCli(cli);
  const fenced = `\`\`\`${lang}\n${code}\n\`\`\``;

  // IMPORTANT: preserve rest (explanation/warnings/alternatives)
  return rest ? `${fenced}\n\n${rest}` : fenced;
}

================================================================================
FILE: .ccg_backups/20260108_102252/client/src/components/ui/MarkdownBox.jsx
================================================================================

import { useMemo, useState } from "react";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import { useLanguage } from "../../context/LanguageContext";

function CopyMini({ value, labelCopy, labelCopied }) {
  const [copied, setCopied] = useState(false);

  async function onCopy() {
    try {
      if (navigator?.clipboard?.writeText) {
        await navigator.clipboard.writeText(value || "");
        setCopied(true);
        setTimeout(() => setCopied(false), 900);
      }
    } catch (e) {
      // ignore clipboard errors (never crash UI)
      console.error("Clipboard copy failed:", e);
    }
  }

  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn ccg-btn-ghost ccg-btn-xs"
      title={labelCopy}
      disabled={!value}
    >
      {copied ? labelCopied : labelCopy}
    </button>
  );
}

export default function MarkdownBox({ markdown, content, lang: langProp }) {
  const md = String(content ?? markdown ?? "");
  const ctx = (() => { try { return useLanguage(); } catch { return null; } })();
  const lang = (langProp || ctx?.lang || "fa");

  // âœ… TDZ-safe: labels computed BEFORE components object uses them
  const labels = useMemo(() => {
    const fa = { copy: "Ú©Ù¾ÛŒ", copied: "Ú©Ù¾ÛŒ Ø´Ø¯" };
    const en = { copy: "Copy", copied: "Copied" };
    return lang === "fa" ? fa : en;
  }, [lang]);

  return (
    <div className={`ccg-markdown ${lang === "fa" ? "rtl" : "ltr"}`}>
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        components={{
          code({ inline, className, children }) {
            const raw = String(children ?? "");
            const value = raw.replace(/\n$/, "");
            const isBlock = !inline;

            if (!isBlock) return <code className="ccg-inline-code">{children}</code>;

            return (
              <div className="ccg-codeblock">
                <div className="ccg-codeblock-head">
                  <div className="ccg-codeblock-title">
                    {(className || "").replace("language-", "") || "CODE"}
                  </div>
                  <CopyMini value={value} labelCopy={labels.copy} labelCopied={labels.copied} />
                </div>
                <pre className="ccg-pre">
                  <code dir="ltr">{value}</code>
                </pre>
              </div>
            );
          },
        }}
      >
        {md}
      </ReactMarkdown>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/20260108_102252/client/src/components/ui/MarkdownRenderer.jsx
================================================================================

import ReactMarkdown from "react-markdown";

export default function MarkdownRenderer({ content }) {
  return (
    <div className="prose prose-invert max-w-none">
      <ReactMarkdown>{content}</ReactMarkdown>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/20260108_102252/client/src/components/ui/MarkdownView.jsx
================================================================================

import ReactMarkdown from "react-markdown";

export default function MarkdownView({ content }) {
  if (!content) return null;

  return (
    <div className="prose prose-invert max-w-none prose-pre:bg-slate-950 prose-pre:border prose-pre:border-slate-800">
      <ReactMarkdown>{content}</ReactMarkdown>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/20260108_102252/client/src/components/ui/SectionedMarkdown.jsx
================================================================================

import { useMemo } from "react";
import MarkdownBox from "./MarkdownBox";

function splitByHeadings(md) {
  const raw = String(md || "").replace(/\r\n/g, "\n");
  const lines = raw.split("\n");

  const sections = [];
  let current = { title: null, body: [] };

  const pushCurrent = () => {
    const body = current.body.join("\n").trim();
    if (!current.title && !body) return;
    sections.push({ title: current.title, body });
  };

  for (const line of lines) {
    const m = line.match(/^(#{2,6})\s+(.+)\s*$/);
    if (m) {
      if (current.title !== null || current.body.length) pushCurrent();
      current = { title: m[2].trim(), body: [] };
      continue;
    }
    current.body.push(line);
  }

  pushCurrent();

  if (!sections.length && raw.trim()) return [{ title: null, body: raw.trim() }];

  return sections.filter((s) => (s.title || s.body).toString().trim().length > 0);
}

export default function SectionedMarkdown({ markdown, content, lang = "fa", defaultTitle }) {
  const md = content ?? markdown ?? "";
  const sections = useMemo(() => splitByHeadings(md), [md]);

  if (!md || !String(md).trim()) return <MarkdownBox markdown={""} lang={lang} />;

  if (sections.length === 1 && !sections[0].title) {
    return <MarkdownBox markdown={sections[0].body} lang={lang} />;
  }

  return (
    <div className="ccg-section-grid">
      {sections.map((sec, idx) => {
        const title = sec.title || defaultTitle || (lang === "fa" ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Result");
        
        const isWarnTitle = /^(Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§|Ù‡Ø´Ø¯Ø§Ø±|warnings?|warning)$/i.test(String(title || "").trim());
        const cardClass = isWarnTitle ? "ccg-section-card ccg-warn" : "ccg-section-card";
return (
          <div key={`${title}-${idx}`} className={cardClass}>
            <div className="ccg-section-title">{title}</div>
            <div className="ccg-section-body">
              <MarkdownBox markdown={sec.body} lang={lang} />
            </div>
          </div>
        );
      })}
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/20260108_102252/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo, useState } from "react";



// CCG_TOOLRESULT_JSON_GUARD_V1
function tryParseToolJsonString(maybe) {
  const t = String(maybe || "").trim();
  if (!t) return null;
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try {
    const obj = JSON.parse(t);
    const tool = (obj && typeof obj.tool === "object") ? obj.tool : obj;
    if (!tool || typeof tool !== "object") return null;
    if (!fixedTool.primary || typeof fixedTool.primary !== "object") return null;
    if (typeof fixedTool.primary.command !== "string") return null;
    return tool;
  } catch {
    return null;
  }
}


function CopyBtn({ text }) {
  const [ok, setOk] = useState(false);

  const copy = async () => {
    try {
      await navigator.clipboard.writeText(text || "");
      setOk(true);
      setTimeout(() => setOk(false), 900);
    } catch {}
  };

  return (
    <button className="ccg-btn text-xs px-3 py-1" type="button" onClick={copy}>
      {ok ? "Copied" : "Copy"}
    </button>
  );
}

function CodeBlock({ lang, code }) {
  return (
    <div className="rounded-xl border border-[var(--border)] overflow-hidden">
      <div className="flex items-center justify-between px-3 py-2 text-xs bg-white/5">
        <span className="opacity-80">lang: {lang || "bash"}</span>
        <CopyBtn text={code} />
      </div>
      <pre className="p-3 text-sm overflow-auto"><code>{code}</code></pre>
    </div>
  );
}

export default function ToolResult({ tool }) {
  
  const fixedTool = (() => {
    const parsed = tryParseToolJsonString(fixedTool?.explanation);
    return parsed ? { ...tool, ...parsed } : tool;
  })();
const safe = useMemo(() => {
    const t = (tool && typeof tool === "object") ? tool : {};
    const primary = (t.primary && typeof t.primary === "object") ? t.primary : {};
    return {
      primary: { command: String(primary.command || ""), lang: String(primary.lang || "bash") },
      explanation: typeof t.explanation === "string" ? t.explanation : "",
      warnings: Array.isArray(t.warnings) ? t.warnings : [],
      alternatives: Array.isArray(t.alternatives) ? t.alternatives : []
    };
  }, [tool]);

  const cmd = safe.primary.command.trim();

  return (
    <div className="space-y-6">
      <div>
        <div className="text-sm font-semibold mb-2">Command</div>
        <CodeBlock lang={safe.primary.lang} code={cmd || 'echo "No command produced"'} />
      </div>

      {safe.explanation?.trim() ? (
        <div>
          <div className="text-sm font-semibold mb-2">Explanation</div>
          <div className="text-sm leading-7 opacity-90 whitespace-pre-wrap">{safe.explanation}</div>
        </div>
      ) : null}

      {safe.warnings?.length ? (
        <div>
          <div className="text-sm font-semibold mb-2">Warnings</div>
          <ul className="list-disc pl-5 text-sm leading-7 opacity-90">
            {safe.warnings.map((w, i) => <li key={i}>{w}</li>)}
          </ul>
        </div>
      ) : null}

      {safe.alternatives?.length ? (
        <div>
          <div className="text-sm font-semibold mb-2">Alternatives</div>
          <div className="space-y-4">
            {safe.alternatives.slice(0,3).map((a, i) => (
              <div key={i} className="space-y-2">
                {a?.note ? <div className="text-xs opacity-75">- {a.note}</div> : null}
                <CodeBlock lang={safe.primary.lang} code={String(a.command || "").trim()} />
              </div>
            ))}
          </div>
        </div>
      ) : null}
    </div>
  );
}

================================================================================
FILE: .ccg_backups/tool_contract_stable/20260103_090201/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/tool_contract_stable/20260103_090201/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo, useState } from "react";

function CopyBtn({ text }) {
  const [copied, setCopied] = useState(false);
  return (
    <button
      type="button"
      onClick={async () => {
        try {
          await navigator.clipboard.writeText(text || "");
          setCopied(true);
          setTimeout(() => setCopied(false), 900);
        } catch {}
      }}
      className="px-3 py-1 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-white/80 text-sm"
    >
      {copied ? "Ú©Ù¾ÛŒ Ø´Ø¯" : "Ú©Ù¾ÛŒ"}
    </button>
  );
}

function CodeCard({ title, code, lang = "bash" }) {
  return (
    <div className="rounded-2xl border border-white/10 bg-white/5 overflow-hidden">
      <div className="flex items-center justify-between px-4 py-2 border-b border-white/10">
        <div className="text-white/80 text-sm">{title}</div>
        <CopyBtn text={code} />
      </div>
      <pre className="px-4 py-3 overflow-auto text-white text-sm leading-6">
        <code>{code}</code>
      </pre>
      <div className="px-4 pb-3 text-white/40 text-xs">{lang}</div>
    </div>
  );
}

export default function ToolResult({ tool, fallback = "" }) {
  const safe = useMemo(() => {
    if (!tool) return null;
    const primary = tool.primary || {};
    return {
      lang: primary.lang || "bash",
      command: primary.command || "",
      explanation: tool.explanation || "",
      warnings: Array.isArray(tool.warnings) ? tool.warnings : [],
      alternatives: Array.isArray(tool.alternatives) ? tool.alternatives : [],
    };
  }, [tool]);

  if (!safe) {
    return (
      <div className="rounded-2xl border border-white/10 bg-white/5 p-4 text-white/80 whitespace-pre-wrap">
        {fallback}
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <CodeCard title="Ú©Ø§Ù…Ù†Ø¯ Ø§ØµÙ„ÛŒ" code={safe.command} lang={safe.lang} />

      <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
        <div className="text-white/80 text-sm mb-2">ØªÙˆØ¶ÛŒØ­</div>
        <div className="text-white/80 whitespace-pre-wrap leading-7">
          {safe.explanation || "â€”"}
        </div>
      </div>

      <div className="rounded-2xl border border-red-500/30 bg-red-500/10 p-4">
        <div className="text-red-200 text-sm mb-2">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
        <ul className="list-disc pr-5 space-y-1 text-red-100/90 leading-7">
          {(safe.warnings.length ? safe.warnings : ["â€”"]).map((w, i) => (
            <li key={i}>{w}</li>
          ))}
        </ul>
      </div>

      <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
        <div className="text-white/80 text-sm mb-3">Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§</div>
        <div className="space-y-3">
          {(safe.alternatives || []).slice(0, 3).map((a, i) => (
            <div key={i} className="space-y-2">
              <div className="text-white/60 text-sm">{a.note || `Ú¯Ø²ÛŒÙ†Ù‡ ${i + 1}`}</div>
              <CodeCard title={`Ú¯Ø²ÛŒÙ†Ù‡ ${i + 1}`} code={a.command || ""} lang={safe.lang} />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/tool_contract_stable/20260103_090201/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Stable Tool-Style Output Normalizer (Generator)
// Always returns a fixed template for outputType: markdown/tool
// 1) Primary command in ONE fenced code block (ONLY command lines)
// 2) ## ØªÙˆØ¶ÛŒØ­
// 3) ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ (always non-empty, no placeholders)
// 4) ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (always 3 alternatives, each: short note + its own fenced block)
//
// Backward-compatible exports:
// - formatToolResponse
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line, cli = "bash") {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;

  const c = String(cli || "").toLowerCase();

  if (c.includes("powershell") || c === "pwsh") {
    // allow PS prompts / variables / cmdlets
    if (/^\s*(\$|PS>)/.test(s)) return true;
    if (/^[A-Za-z]+-[A-Za-z]+(\s|$)/.test(s)) return true;
    if (/^(sudo\s+)?[A-Za-z0-9._-]+(\s|$)/.test(s)) return true;
    return false;
  }

  if (c.includes("cmd")) {
    // allow common cmd syntax: pipes, redirects, &&, etc.
    if (/^(?:@?echo|set|cd|dir|type|find|findstr|more|net|wmic|sc|tasklist|shutdown|whoami|ipconfig)(\s|$)/i.test(s)) return true;
    if (/^[A-Za-z0-9._-]+(\s|$)/.test(s)) return true;
    return false;
  }

  // bash/zsh/sh default
  if (/^(sudo\s+)?[A-Za-z0-9._\/-]+(\s|$)/.test(s)) return true;
  return false;
}

function normalizeCodeToCommands(codeRaw, cli) {
  const lines = String(codeRaw || "").replace(/\r\n/g, "\n").split("\n");
  const kept = [];
  for (const ln of lines) {
    const s = String(ln || "").trim();
    if (!s) continue;
    // strip common prompts
    const stripped = s.replace(/^(?:\w+@[\w.-]+:.*?\$)\s+/, "");
    if (looksLikeCommand(stripped, cli)) kept.push(stripped);
  }
  return kept.join("\n").trim();
}

function firstCommandFromText(text, cli) {
  const t = String(text || "").replace(/\r\n/g, "\n");
  for (const ln of t.split("\n")) {
    const s = ln.trim();
    if (looksLikeCommand(s, cli)) return s;
  }
  return "";
}

function extractSection(md, names) {
  const t = String(md || "").replace(/\r\n/g, "\n");
  const nameAlt = names.map(n => n.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")).join("|");
  const re = new RegExp(`^##\\s*(${nameAlt})\\s*$([\\s\\S]*?)(?=^##\\s|\\Z)`, "gmi");
  const m = re.exec(t);
  if (!m) return "";
  return String(m[2] || "").trim();
}

function stripAllHeadings(md) {
  return String(md || "")
    .replace(/\r\n/g, "\n")
    .split("\n")
    .filter(line => !/^##\s+/.test(line))
    .join("\n")
    .trim();
}

function autoWarnings(primary, cli, lang = "fa") {
  const p = String(primary || "");
  const c = String(cli || "").toLowerCase();

  const baseFa = [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ (Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ú¯Ø´Øª Ù†ÛŒØ³Øª).",
    "Ø§Ú¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±/Ø³ÛŒØ³ØªÙ… Ø±ÛŒÙ…ÙˆØª Ù…ÛŒâ€ŒØ²Ù†ÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø´ÙˆØ¯."
  ];
  const baseEn = [
    "Before running, make sure this is exactly what you want (some actions are irreversible).",
    "On remote systems, this command may interrupt your connection."
  ];

  let extraFa = [];
  let extraEn = [];

  if (/(^|\s)(reboot|shutdown)\b/i.test(p) || (c.includes("cmd") && /\bshutdown\b/i.test(p))) {
    extraFa = [
      "Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯Ø› Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§Ø¹Ø« Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ sudo/AdministratorØŒ Ø¨Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯."
    ];
    extraEn = [
      "Save any unsaved work; a reboot will close apps/services.",
      "Run with sudo/Administrator if required."
    ];
  }

  if (/\brm\s+-rf\b/i.test(p)) {
    extraFa = [
      "Ù…Ø³ÛŒØ± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú†Ú© Ú©Ù†ÛŒØ¯Ø› rm -rf Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ù„ Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†Ø¯.",
      "Ø§ÙˆÙ„ Ø¨Ø§ ls/echo Ù…Ø³ÛŒØ± Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯."
    ];
    extraEn = [
      "Double-check the path; rm -rf can delete critical files.",
      "Validate the target with ls/echo first."
    ];
  }

  const out = (lang === "fa" ? [...baseFa, ...extraFa] : [...baseEn, ...extraEn]);
  // de-dup
  return Array.from(new Set(out)).slice(0, 4);
}

function inferAlternatives(primary, cli, lang = "fa") {
  const p = String(primary || "").trim();
  const c = String(cli || "").toLowerCase();

  // Linux reboot
  if (/(^|\s)reboot(\s|$)/i.test(p) && !c.includes("cmd") && !c.includes("powershell")) {
    return [
      { note: lang === "fa" ? "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ systemd" : "systemd standard", cmd: "sudo systemctl reboot" },
      { note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø¨Ø§ shutdown" : "Immediate reboot via shutdown", cmd: "sudo shutdown -r now" },
      { note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" : "Reboot with 1-minute delay", cmd: "sudo shutdown -r +1" },
    ];
  }

  // Windows: net user goal
  if (c.includes("cmd") && /^\s*net\s+user\b/i.test(p)) {
    return [
      { note: lang === "fa" ? "Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ÛŒÚ© Ú©Ø§Ø±Ø¨Ø±" : "Show details of one user", cmd: "net user <username>" },
      { note: lang === "fa" ? "Ø´Ù…Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (ØªÙ‚Ø±ÛŒØ¨ÛŒ)" : "Count users (approx)", cmd: 'net user | find /c /v ""' },
      { note: lang === "fa" ? "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù‚Ø¯ÛŒÙ…ÛŒ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± Ø¨Ø¹Ø¶ÛŒ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)" : "Legacy alternative (may be missing)", cmd: "wmic useraccount get name" },
    ];
  }

  // Windows reboot
  if (c.includes("cmd") && /^\s*shutdown\b/i.test(p) && /\/r/i.test(p)) {
    return [
      { note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" : "Immediate restart", cmd: "shutdown /r /t 0" },
      { note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ ØªØ£Ø®ÛŒØ±" : "Restart in 60s", cmd: "shutdown /r /t 60" },
      { note: lang === "fa" ? "Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª shutdown/restart" : "Abort shutdown/restart", cmd: "shutdown /a" },
    ];
  }

  // Generic fallback (still copyable, but honest)
  const tool = p.split(/\s+/)[0] || (c.includes("cmd") ? "command" : "tool");
  if (lang === "fa") {
    return [
      { note: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ±", cmd: `${tool} --help` },
      { note: "Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯)", cmd: `man ${tool}` },
      { note: "Ø¯ÛŒØ¯Ù† Ù†Ø³Ø®Ù‡/Ø§Ø·Ù„Ø§Ø¹Ø§Øª", cmd: `${tool} --version` },
    ];
  }
  return [
    { note: "Command help", cmd: `${tool} --help` },
    { note: "Manual page (if available)", cmd: `man ${tool}` },
    { note: "Version/info", cmd: `${tool} --version` },
  ];
}

function ensureShortText(s, maxLen = 520) {
  const t = String(s || "").trim();
  if (!t) return "";
  if (t.length <= maxLen) return t;
  return t.slice(0, maxLen).trim() + "â€¦";
}

export function formatToolResponse({ outputType, text, cli = "bash", lang = "fa" } = {}) {
  const ot = String(outputType || "").toLowerCase();
  const fenceLang = fenceLangFromCli(cli, ot);

  const raw = String(text ?? "").trim();
  const { codeRaw, rest } = splitFirstCodeBlock(raw);

  let primary = normalizeCodeToCommands(codeRaw, cli);
  if (!primary) primary = firstCommandFromText(raw, cli);
  primary = String(primary || "").trim();

  // If still empty, keep it safe:
  if (!primary) {
    primary = fenceLang === "cmd" ? "echo ERROR: command not found" : "echo 'ERROR: command not found'";
  }

  // Try to read sections from assistant output if present, otherwise treat leftover as explanation
  let explanation =
    extractSection(raw, ["ØªÙˆØ¶ÛŒØ­", "Explanation"]) ||
    extractSection(rest, ["ØªÙˆØ¶ÛŒØ­", "Explanation"]) ||
    stripAllHeadings(rest);

  explanation = ensureShortText(explanation, 700);
  if (!explanation) {
    explanation = (lang === "fa")
      ? "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù‡Ù…ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. ÙÙ‚Ø· Ú©Ø§ÙÛŒ Ø§Ø³Øª Ø¢Ù† Ø±Ø§ Ø¯Ø± ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯."
      : "This command performs the requested action. Run it in your terminal.";
  }

  // Warnings: always real (no placeholder)
  let warningsText =
    extractSection(raw, ["Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Ù‡Ø´Ø¯Ø§Ø±", "Warnings", "Warning"]) ||
    extractSection(rest, ["Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Ù‡Ø´Ø¯Ø§Ø±", "Warnings", "Warning"]);

  let warnings = [];
  if (warningsText) {
    warnings = warningsText
      .split("\n")
      .map(x => x.replace(/^\s*[-*]\s*/,"").trim())
      .filter(Boolean)
      .slice(0, 4);
  }
  if (!warnings.length) warnings = autoWarnings(primary, cli, lang);

  // Alternatives: always 3
  let alternatives = inferAlternatives(primary, cli, lang).slice(0, 3);

  // Build markdown in the exact stable order
  const warnList = warnings.map(w => `- ${w}`).join("\n");
  const altBlocks = alternatives.map((a, idx) => {
    const noteLine = lang === "fa" ? `**${idx+1}) ${a.note}**` : `**${idx+1}) ${a.note}**`;
    return `${noteLine}\n\`\`\`${fenceLang}\n${a.cmd}\n\`\`\``;
  }).join("\n\n");

  const output_md =
`\`\`\`${fenceLang}
${primary}
\`\`\`

## ØªÙˆØ¶ÛŒØ­
${explanation}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${warnList}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
${altBlocks}
`.trim();

  // For command/script outputs, some UIs want only the primary code block
  if (ot === "command" || ot === "script") {
    return { output_md: `\`\`\`${fenceLang}\n${primary}\n\`\`\``, tool: { primary, fenceLang, explanation, warnings, alternatives } };
  }

  return { output_md, tool: { primary, fenceLang, explanation, warnings, alternatives } };
}

// Alias for older code
export function formatOutput(args = {}) {
  return formatToolResponse(args);
}

================================================================================
FILE: .ccg_backups/fix_top_level_return_20260107_080401/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";



// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

// ---- Advanced: validation allowlists (client-side) ----
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES",
  "Amazon Linux","Oracle Linux","Kali","Gentoo","Alpine",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = [
  "bash","zsh","sh","fish",
  "cmd","powershell","pwsh",
  "ksh","tcsh"
];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 0, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{1,40}$/.test(s);
}


const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  
  const [customOSName, setCustomOSName] = useState("Ubuntu");
  const [customOSVersion, setCustomOSVersion] = useState("");
  const [customShell, setCustomShell] = useState("bash");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  
  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    const isOther = platform === "other";

    // Defaults (even when Advanced is closed)
    const safeMode = modeStyle || "operational";
    const safeLevel = knowledgeLevel || "intermediate";

    // Base OS/CLI mapping
    let osValue = isNetwork ? "network" : (platform || "linux");
    let cliValue = isNetwork ? "network-cli" : (shell || "bash");

    // If Other: use custom fields (validated)
    if (isOther) {
      const name = cleanToken(customOSName);
      const ver  = cleanToken(customOSVersion);
      const sh   = cleanToken(customShell).toLowerCase();

      const nameOk = !!name && (OS_ALLOWLIST.includes(name) || isSafeFreeText(name, 2, 40));
      const verOk  = ver ? isSafeFreeText(ver, 1, 20) : true;
      const shOk   = !!sh && SHELL_ALLOWLIST.includes(sh);

      const finalName = nameOk ? name : "Ubuntu";
      const finalVer  = (verOk ? ver : "");
      const finalShell= shOk ? sh : "bash";

      osValue = finalVer ? `${finalName} ${finalVer}` : finalName;
      cliValue = finalShell;
    }

    return {
      mode: "generate",
      lang: lang || "fa",
      user_request: input.trim(),

      outputType: outputType,
      modeStyle: safeMode,
      knowledgeLevel: safeLevel,

      platform: isNetwork ? "network" : (platform || "linux"),
      os: osValue,
      cli: cliValue,

      vendor: isNetwork ? (vendor || "") : "",
      deviceType: isNetwork ? (deviceType || "general") : "general",
    };
  };

  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/fix_formatter_export/20260102_132809/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-style output for Generator (NOT chatty):
// - Ensure FIRST thing is exactly ONE fenced code block for command/script.
// - Preserve the rest of assistant output (explanation/warnings/alternatives).

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

// Best-effort: Ø§Ú¯Ø± Ù…Ø¯Ù„ Ú©Ø¯Ø¨Ù„Ø§Ú© Ù†Ø¯Ø§Ø¯ØŒ Ø§Ø² Ø®Ø·ÙˆØ· Ù…Ø­ØªÙ…Ù„Ù Ú©Ø§Ù…Ù†Ø¯ Ø­Ø¯Ø³ Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ…
function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  const lines = t.split("\n").map(x => x.trim()).filter(Boolean);

  // Ø­Ø°Ù Ø³Ù„Ø§Ù…/Ù…Ù‚Ø¯Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ
  const cleaned = lines.filter(l => !/^(Ø³Ù„Ø§Ù…|Ø¯Ø±ÙˆØ¯|hi|hello)\b/i.test(l));

  // Ø®Ø·ÛŒ Ú©Ù‡ Ø´Ø¨ÛŒÙ‡ command Ù‡Ø³Øª
  for (const l of cleaned) {
    if (/^(sudo\s+)?[a-z0-9_\-]+(\s+[-\/\w\.\=\:]+)*$/i.test(l)) return l;
    if (/^(sudo\s+)?(systemctl|service|journalctl|nginx|ufw|iptables|docker|kubectl|pm2|ps|top|htop|df|du|free|ss|netstat|lsof)\b/i.test(l)) return l;
  }
  return "";
}

function hasSections(rest) {
  return /(^|\n)\s*#{1,3}\s*(ØªÙˆØ¶ÛŒØ­|Ù‡Ø´Ø¯Ø§Ø±|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†|Explanation|Warnings|Alternatives)\b/i.test(rest);
}

export function formatOutput({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase();
  const raw = String(text ?? "").trim();
  if (!raw) return raw;

  const fenceLang = fenceLangFromCli(cli, ot);
  const { code, rest } = splitFirstCodeBlock(raw);

  let cmd = code || "";
  let tail = rest || "";

  if (!cmd && (ot === "command" || ot === "script")) {
    cmd = guessCommandFromText(raw);
    tail = raw.replace(cmd, "").trim();
  }

  // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² command Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ù‡Ù…Ø§Ù† raw Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
  if (!cmd) return raw;

  const fenced = `\`\`\`${fenceLang}\n${cmd}\n\`\`\``;

  // Ø¨Ø±Ø§ÛŒ command/script Ù‡Ù… ØªÙˆØ¶ÛŒØ­/Ù‡Ø´Ø¯Ø§Ø±/Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
  if (!tail) return fenced;

  if (hasSections(tail)) {
    return `${fenced}\n\n${tail}`;
  }

  // Ø§Ú¯Ø± Ø³Ú©Ø´Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© "ØªÙˆØ¶ÛŒØ­" Ø¨Ø³Ø§Ø²
  return `${fenced}\n\n## ØªÙˆØ¶ÛŒØ­\n${tail}`;
}

================================================================================
FILE: .ccg_backups/outputFormatter_enrich/20260103_042936/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Generator output must feel like a DevOps tool (not chatty).
// - Always start with ONE fenced code block (command/script).
// - Preserve/structure the rest as: Explanation / Warnings / Alternatives.
// - Keep compatible exports: formatOutput + formatToolResponse

function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  // reject obvious prose
  if (s.length > 160) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // starts with common shells/tools or sudo
  if (/^(sudo\s+)?([a-zA-Z0-9._-]+)(\s+|$)/.test(s)) return true;
  return false;
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  if (!t) return "";
  const lines = t.split("\n").map(x => x.trim()).filter(Boolean);

  // prefer first "command-like" line
  for (const ln of lines) {
    if (looksLikeCommand(ln)) return ln;
  }

  // common hard fallbacks
  // (minimal + safe, doesn't execute anything)
  const low = t.toLowerCase();
  if (low.includes("restart") && (low.includes("linux") || /[\u0600-\u06FF]/.test(t))) return "sudo reboot";
  return "";
}

function pickHeadings(lang = "fa") {
  const fa = String(lang || "").toLowerCase().startsWith("fa");
  return fa
    ? { exp: "## ØªÙˆØ¶ÛŒØ­", warn: "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", alt: "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" }
    : { exp: "## Explanation", warn: "## Warnings", alt: "## Alternatives" };
}

function extractSections(rest, lang) {
  const { exp, warn, alt } = pickHeadings(lang);
  const t = String(rest || "").trim();
  if (!t) return { explanation: "", warnings: "", alternatives: "" };

  // If model already produced headings, keep them as-is (just return raw rest).
  // We'll avoid double-formatting.
  const hasAnyHeading =
    t.includes("## Explanation") || t.includes("## Warnings") || t.includes("## Alternatives") ||
    t.includes("## ØªÙˆØ¶ÛŒØ­") || t.includes("## Ù‡Ø´Ø¯Ø§Ø±") || t.includes("## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†");
  if (hasAnyHeading) return { raw: t };

  // Otherwise treat rest as explanation
  return { explanation: t, warnings: "", alternatives: "" };
}

function buildMarkdown({ outputType, code, rest, cli, lang }) {
  const ot = String(outputType || "").toLowerCase();
  const fence = fenceLangFromCli(cli);

  // command-only: keep first command-like line
  if (ot === "command") {
    const firstLine = (code || "").split("\n").map(x => x.trim()).filter(Boolean)[0] || guessCommandFromText(rest) || "";
    return `\`\`\`${fence}\n${firstLine}\n\`\`\``.trim();
  }

  // script: keep full code (but still fenced)
  // markdown: code + sections
  const fixedCode = (code || "").trim() || guessCommandFromText(rest) || "";
  const { exp, warn, alt } = pickHeadings(lang);
  const sec = extractSections(rest, lang);

  let out = `\`\`\`${fence}\n${fixedCode}\n\`\`\``.trim();

  if (sec.raw) {
    out += `\n\n${sec.raw}`;
    return out.trim();
  }

  if (sec.explanation) out += `\n\n${exp}\n${sec.explanation}`;
  if (sec.warnings) out += `\n\n${warn}\n${sec.warnings}`;
  if (sec.alternatives) out += `\n\n${alt}\n${sec.alternatives}`;

  return out.trim();
}

export function formatToolResponse({ outputType, text, cli = "bash", lang = "fa" }) {
  const t = String(text ?? "").trim();
  const { code, rest } = splitFirstCodeBlock(t);

  // If model mistakenly put explanation inside the code fence, rest will be empty.
  // In that case, try to split by first blank line as a fallback.
  let codeFixed = code;
  let restFixed = rest;

  if (codeFixed && !restFixed) {
    const parts = codeFixed.split(/\n\s*\n/);
    if (parts.length >= 2) {
      const maybeCmd = parts[0].trim();
      const maybeRest = parts.slice(1).join("\n\n").trim();
      // only if first part looks command-ish
      if (looksLikeCommand(maybeCmd)) {
        codeFixed = maybeCmd;
        restFixed = maybeRest;
      }
    }
  }

  return buildMarkdown({ outputType, code: codeFixed, rest: restFixed, cli, lang });
}

// Backward compatible alias
export function formatOutput(opts) {
  return formatToolResponse(opts);
}

================================================================================
FILE: .ccg_backups/lock_generate_contract/20260106_074819/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/lock_generate_contract/20260106_074819/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Locked Tool Contract normalizer for Generator
// Guarantees (for outputType: markdown/tool):
// 1) Primary command FIRST as ONE fenced block (ONLY command-like lines)
// 2) Then: ## ØªÙˆØ¶ÛŒØ­ / ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (always present, always meaningful)
// 3) Alternatives: always 3, OS/CLI-consistent
//
// Backward-compatible exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function norm(s) { return String(s ?? "").trim(); }

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = norm(text);
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = norm(m[1] ?? "");
  const rest = norm(t.replace(m[0], ""));
  return { codeRaw, rest };
}

function looksLikeCommandLine(line) {
  const s = norm(line);
  if (!s) return false;
  if (s.length > 220) return false;
  // reject prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // allow typical command patterns
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s) || /^shutdown(\s+|$)/i.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "").split(/\r?\n/);
  const cmds = [];
  for (const ln of lines) {
    const s = norm(ln);
    if (!s) continue;
    if (looksLikeCommandLine(s)) cmds.push(s);
  }
  // keep unique, preserve order
  const seen = new Set();
  const out = [];
  for (const c of cmds) {
    const k = c.toLowerCase();
    if (!seen.has(k)) { seen.add(k); out.push(c); }
  }
  return out.join("\n").trim();
}

function detectIntentFa(userRequest) {
  const u = norm(userRequest);
  if (!u) return "";
  if (u.includes("Ø®Ø§Ù…ÙˆØ´") || u.includes("shutdown") || u.includes("turn off")) return "shutdown";
  if (u.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || u.includes("reboot") || u.includes("restart")) return "restart";
  return "";
}

function windowsTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "shutdown /s /t 60",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¯Ø± CMD Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ Ø­Ø³Ø§Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª (Ø¢Ù¾Ø¯ÛŒØª/Ø¨Ú©Ø§Ù¾)ØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø±Ø§ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù†ÛŒØ¯.",
        "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø­ØªÙ…Ø§Ù‹ Ø¯Ø³ØªÙˆØ± Ù„ØºÙˆ Ø±Ø§ Ø¨Ø¯Ø§Ù†ÛŒØ¯."
      ],
      alternatives: [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "shutdown /s /t 300", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
      ],
    };
  }
  // restart
  return {
    primary: "shutdown /r /t 0",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¯Ø± CMDØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³/ProductionØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯."
    ],
    alternatives: [
      { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
      { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      { command: "shutdown /r /f /t 0", note: "Ø±ÛŒØ³ØªØ§Ø±Øª + Ø¨Ø³ØªÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" }
    ],
  };
}

function linuxTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "sudo shutdown -h +1",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
        "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "sudo shutdown -h now", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }
      ],
    };
  }
  return {
    primary: "sudo reboot",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ÛŒØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
    ],
    alternatives: [
      { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ systemd" },
      { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
      { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
    ],
  };
}

function buildMarkdown(tool) {
  const p = tool?.primary?.command ? tool.primary.command : "";
  const lang = tool?.primary?.lang || "bash";

  const fence = p ? "```" + lang + "\n" + p + "\n```\n" : "";

  const exp = norm(tool?.explanation) || "â€”";
  const warns = Array.isArray(tool?.warnings) && tool.warnings.length ? tool.warnings : ["Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ù†ÛŒØ§Ø² Ø´Ù…Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø§Ø³Øª."];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives.slice(0,3) : [];

  const warnMd = warns.map(w => `- ${norm(w)}`).join("\n");
  const altMd = alts.map(a => {
    const note = norm(a?.note) || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = norm(a?.command);
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `${fence}
## ØªÙˆØ¶ÛŒØ­
${exp}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${warnMd}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
${altMd}
`.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType }) {
  const OT = String(outputType || "markdown").toLowerCase();
  const CLI = String(cli || "bash");
  const OS = String(os || "linux").toLowerCase();
  const lang = fenceLangFromCli(CLI, OT);

  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const primaryFromBlock = normalizeCodeToCommands(codeRaw);

  // intent + template fallback
  const intent = detectIntentFa(userRequest);

  let tpl = null;
  if (OS.includes("win") || lang === "cmd" || String(CLI).toLowerCase().includes("cmd")) {
    tpl = windowsTemplates(intent || "restart");
  } else {
    tpl = linuxTemplates(intent || "restart");
  }

  // choose primary: prefer extracted command if it looks valid and OS-consistent
  let primary = primaryFromBlock || tpl.primary;

  // very basic OS consistency guard for alternatives:
  const isWin = (OS.includes("win") || lang === "cmd");
  if (isWin) {
    // if extracted command contains sudo/systemctl, it's wrong for cmd -> use template
    if (/sudo|systemctl|shutdown\s+-/i.test(primary)) primary = tpl.primary;
  } else {
    // linux: if extracted contains windows-style /s /t, it's wrong -> use template
    if (/shutdown\s+\/[srat]\b/i.test(primary) || /\bnet\s+user\b/i.test(primary)) primary = tpl.primary;
  }

  // explanation: keep model text if it exists, otherwise template. Keep beginner a bit more instructive.
  let explanation = norm(rest);
  if (!explanation) explanation = tpl.explanation;

  if (String(knowledgeLevel || "").toLowerCase().includes("begin")) {
    // add minimal steps, but keep short
    if (isWin) explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: CMD Ø±Ø§ Ø¨Ø§ Win+R â†’ cmd Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
    else explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
  } else {
    // keep concise for intermediate/pro
    explanation = explanation.split("\n").slice(0, 6).join("\n").trim() || tpl.explanation;
  }

  const tool = {
    primary: { command: primary, lang },
    explanation,
    warnings: tpl.warnings,
    alternatives: tpl.alternatives.map(a => ({ command: a.command, note: a.note })),
  };

  const markdown = buildMarkdown(tool);

  // For pure command/script output types, return only copy-ready primary fence (but still attach tool)
  const onlyFence = "```" + lang + "\n" + primary + "\n```" + "\n";

  return {
    tool,
    markdown: (OT === "command" || OT === "script") ? onlyFence : markdown,
  };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/20260108_161207/client/src/components/ui/MarkdownBox.jsx
================================================================================

import { useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";

// Minimal + TDZ-safe MarkdownBox:
// - NO local `const t = ...`
// - Use `t()` only from LanguageContext
export default function MarkdownBox({ value = "", title = "" }) {
  const { lang, t } = useLanguage();
  const isRTL = lang === "fa";
  const [copied, setCopied] = useState(false);

  const text = useMemo(() => String(value || ""), [value]);

  async function copyAll() {
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {
      // ignore
    }
  }

  // Very lightweight sectioning: keep raw markdown, let parent renderer handle if needed.
  return (
    <div className="ccg-card p-4 sm:p-5">
      <div className="flex items-center justify-between gap-3 mb-3">
        <div className="text-sm font-semibold text-slate-700 dark:text-slate-200/80">
          {title || (isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output")}
        </div>
        <button type="button" onClick={copyAll} className="ccg-btn text-sm">
          {copied ? (t("copied") || (isRTL ? "Ú©Ù¾ÛŒ Ø´Ø¯" : "Copied")) : (t("copy") || (isRTL ? "Ú©Ù¾ÛŒ" : "Copy"))}
        </button>
      </div>

      <pre className="whitespace-pre-wrap text-sm leading-6 text-slate-800 dark:text-slate-100/90">
{text}
      </pre>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_tdz_markdownbox_20260108_091035/MarkdownBox.jsx
================================================================================

import { useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";

// Minimal + TDZ-safe MarkdownBox:
// - NO local `const t = ...`
// - Use `t()` only from LanguageContext
export default function MarkdownBox({ value = "", title = "" }) {
  const { lang, t } = useLanguage();
  const isRTL = lang === "fa";
  const [copied, setCopied] = useState(false);

  const text = useMemo(() => String(value || ""), [value]);

  async function copyAll() {
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {
      // ignore
    }
  }

  // Very lightweight sectioning: keep raw markdown, let parent renderer handle if needed.
  return (
    <div className="ccg-card p-4 sm:p-5">
      <div className="flex items-center justify-between gap-3 mb-3">
        <div className="text-sm font-semibold text-slate-700 dark:text-slate-200/80">
          {title || (isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output")}
        </div>
        <button type="button" onClick={copyAll} className="ccg-btn text-sm">
          {copied ? (t("copied") || (isRTL ? "Ú©Ù¾ÛŒ Ø´Ø¯" : "Copied")) : (t("copy") || (isRTL ? "Ú©Ù¾ÛŒ" : "Copy"))}
        </button>
      </div>

      <pre className="whitespace-pre-wrap text-sm leading-6 text-slate-800 dark:text-slate-100/90">
{text}
      </pre>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/server_up_fix/20260103_075133/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool-Style Output normalizer (Generator)
//
// Contract (for outputType: "markdown" or "tool"):
// 1) FIRST: one fenced code block containing ONLY command lines
// 2) Then: ## ØªÙˆØ¶ÛŒØ­
// 3) Then: ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§   (bullet list)
// 4) Then: ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (3 items, each: short note + its own fenced code block)
//
// For outputType: "command" / "script": ONLY the first fenced code block (copy-ready)
//
// Backward-compatible exports:
// - formatToolResponse
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 200) return false;
  // reject prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // reject very-persian/prose-like lines
  if (/[Ø§Ø¢Ø¨Ù¾ØªØ«Ø¬Ú†Ø­Ø®Ø¯Ø°Ø±Ø²Ú˜Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚Ú©Ú¯Ù„Ù…Ù†ÙˆÙ‡ÛŒ]/.test(s) && s.split(/\s+/).length > 4) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizeCommandsFromCode(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean);

  const cmds = lines.filter(looksLikeCommand);
  return cmds.join("\n").trim();
}

function guessPrimaryCommandFromText(text) {
  const t = String(text || "");
  const lines = t.split("\n").map((l) => l.trim()).filter(Boolean);
  const cmd = lines.find(looksLikeCommand);
  return cmd ? cmd.trim() : "";
}

function pickSection(markdown, titles) {
  const t = String(markdown || "");
  for (const title of titles) {
    const re = new RegExp(`^##\\s+${title}\\s*\\n([\\s\\S]*?)(?=^##\\s+|\\Z)`, "mi");
    const m = t.match(re);
    if (m && m[1]) return String(m[1]).trim();
  }
  return "";
}

function linesToBullets(text) {
  const lines = String(text || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .map((l) => l.replace(/^[-*]\s+/, "").replace(/^\d+\.\s+/, "").trim())
    .filter(Boolean);
  return lines;
}

function defaultPackForCommand(cmd, lang = "fa") {
  const c = String(cmd || "").toLowerCase();

  // defaults
  let warnings = [
    lang === "fa"
      ? "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª/ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒ."
      : "Save any unsaved work before running.",
    lang === "fa"
      ? "Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†ØŒ Ø¨Ø§ÛŒØ¯ sudo Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ."
      : "You may need admin privileges (sudo).",
  ];

  let alternatives = [
    {
      note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø¨Ø§ shutdown" : "Immediate reboot via shutdown",
      command: "sudo shutdown -r now",
    },
    {
      note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ systemd" : "Reboot via systemd",
      command: "sudo systemctl reboot",
    },
    {
      note: lang === "fa" ? "Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒ (legacy)" : "Legacy method",
      command: "sudo init 6",
    },
  ];

  if (/(sudo\s+)?reboot\b|shutdown\s+-r|systemctl\s+reboot|init\s+6/.test(c)) {
    warnings = [
      lang === "fa"
        ? "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø§ØªØµØ§Ù„ SSH/Remote Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯."
        : "This will reboot the machine and disconnect SSH/remote sessions.",
      lang === "fa"
        ? "Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³/Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†."
        : "Check running critical services/tasks before rebooting.",
    ];
    alternatives = [
      { note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¯Ø± 1 Ø¯Ù‚ÛŒÙ‚Ù‡ (Ù‚Ø§Ø¨Ù„ Ù„ØºÙˆ)" : "Reboot in 1 minute (cancelable)", command: "sudo shutdown -r +1" },
      { note: lang === "fa" ? "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø¨Ø§ systemd" : "Immediate reboot via systemd", command: "sudo systemctl reboot" },
      { note: lang === "fa" ? "Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§ at" : "Schedule via at", command: "echo 'sudo reboot' | at now + 5 minutes" },
    ];
  } else if (/nginx/.test(c) && /status|is-active|service/.test(c)) {
    warnings = [
      lang === "fa" ? "Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ù…Ù„ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ù‡ sudo Ù†ÛŒØ§Ø² Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ." : "You may need sudo to see full status/logs.",
      lang === "fa" ? "Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ down Ø¨ÙˆØ¯ØŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ journalctl Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†." : "If it's down, check logs via journalctl.",
    ];
    alternatives = [
      { note: lang === "fa" ? "Ú†Ú© Ø³Ø±ÛŒØ¹ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø³Ø±ÙˆÛŒØ³" : "Quick active check", command: "systemctl is-active --quiet nginx && echo OK || echo DOWN" },
      { note: lang === "fa" ? "Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒ service" : "Legacy service command", command: "sudo service nginx status" },
      { note: lang === "fa" ? "Ø¢Ø®Ø±ÛŒÙ† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ nginx" : "Latest nginx logs", command: "sudo journalctl -u nginx -n 50 --no-pager" },
    ];
  } else {
    // generic alternatives
    alternatives = [
      { note: lang === "fa" ? "Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø¨Ø²Ø§Ø±" : "Show command help", command: "COMMAND --help" },
      { note: lang === "fa" ? "ØµÙØ­Ù‡ man" : "Man page", command: "man COMMAND" },
      { note: lang === "fa" ? "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ (tldr)" : "Examples (tldr)", command: "tldr COMMAND" },
    ];
  }

  return { warnings, alternatives };
}

function ensureThreeAlternatives(alts) {
  const a = Array.isArray(alts) ? alts.filter(Boolean) : [];
  const out = a.slice(0, 3).map((x) => ({
    note: String(x?.note || "").trim(),
    command: String(x?.command || "").trim(),
  })).filter((x) => x.command);

  while (out.length < 3) {
    out.push({ note: "â€”", command: "" });
  }
  return out;
}

export function formatToolResponse({ outputType, text, cli = "bash", os = "", lang = "fa", userRequest = "" } = {}) {
  const ot = String(outputType || "").toLowerCase().trim();
  const raw = String(text ?? "").trim();
  const fenceLang = fenceLangFromCli(cli, ot);

  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  let primary = normalizeCommandsFromCode(codeRaw);
  if (!primary) primary = guessPrimaryCommandFromText(raw);

  // Hard fallback if nothing found
  if (!primary) primary = (lang === "fa" ? "echo \"No command generated\"" : "echo \"No command generated\"");

  // If command/script: ONLY code fence
  if (ot === "command" || ot === "script") {
    return `\`\`\`${fenceLang}\n${primary}\n\`\`\``;
  }

  // markdown/tool: enforce sections
  const explanationRaw =
    pickSection(raw, ["ØªÙˆØ¶ÛŒØ­", "Explanation"]) ||
    (rest ? rest.split("\n").slice(0, 6).join("\n").trim() : "");

  const warningsRaw = pickSection(raw, ["Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Warnings"]);
  const alternativesRaw = pickSection(raw, ["Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "Alternatives"]);

  let warnings = linesToBullets(warningsRaw);
  let alternatives = [];

  // Try to parse alternatives section as "- note: cmd" (loose)
  if (alternativesRaw) {
    const lines = alternativesRaw.split("\n").map((l) => l.trim()).filter(Boolean);
    // collect command-like lines as alternatives (with minimal notes)
    const cmds = lines.filter(looksLikeCommand);
    alternatives = cmds.slice(0, 3).map((c, i) => ({ note: `Ú¯Ø²ÛŒÙ†Ù‡ ${i + 1}`, command: c }));
  }

  const pack = defaultPackForCommand(primary, lang);

  if (!warnings.length) warnings = pack.warnings;
  alternatives = ensureThreeAlternatives(alternatives.length ? alternatives : pack.alternatives);

  const safeExplanation = explanationRaw
    ? String(explanationRaw).trim()
    : (lang === "fa"
        ? `Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ (Â«${String(userRequest || "").slice(0, 80)}Â»)ØŒ Ø¯Ø³ØªÙˆØ± Ø§ØµÙ„ÛŒ Ø¨Ø§Ù„Ø§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.`
        : `Based on your request ("${String(userRequest || "").slice(0, 80)}"), the primary command above is recommended.`);

  const md =
`\`\`\`${fenceLang}
${primary}
\`\`\`

## ØªÙˆØ¶ÛŒØ­
${safeExplanation}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${warnings.map((w) => `- ${w}`).join("\n")}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
### 1) ${alternatives[0].note || "Ú¯Ø²ÛŒÙ†Ù‡ 1"}
\`\`\`${fenceLang}
${alternatives[0].command}
\`\`\`

### 2) ${alternatives[1].note || "Ú¯Ø²ÛŒÙ†Ù‡ 2"}
\`\`\`${fenceLang}
${alternatives[1].command}
\`\`\`

### 3) ${alternatives[2].note || "Ú¯Ø²ÛŒÙ†Ù‡ 3"}
\`\`\`${fenceLang}
${alternatives[2].command}
\`\`\`
`.trim();

  return md;
}

export function formatOutput(opts = {}) {
  return formatToolResponse(opts);
}

================================================================================
FILE: .ccg_backups/day2_adv_other_payload_20260107_094226/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/mainpage_finish_v1/20260102_125019/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-style output for Generator (not chat):
// - First: ONE fenced code block (command/script)
// - Then: ## Explanation / ## Warnings / ## Alternatives (short, structured)

import { formatAIResponse } from "./formatter.js";

function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function listToMarkdown(items) {
  const arr = Array.isArray(items) ? items.filter(Boolean) : [];
  if (!arr.length) return "";
  return arr.map((x) => `- ${String(x).trim()}`).join("\n");
}

export function formatGeneratorTool({ output, outputType = "markdown", cli = "bash" } = {}) {
  const ot = String(outputType || "").toLowerCase().trim();
  const raw = String(output || "").trim();

  // If not command/script, just return raw (but still trimmed)
  if (!["command", "script"].includes(ot)) {
    return { output: raw, command: "", meta: {} };
  }

  // Parse sections if present
  const parsed = formatAIResponse(raw, "");
  const lang = parsed?.code?.lang?.trim() || fenceLangFromCli(cli);
  const code = String(parsed?.code?.code || "").trim();

  // Always show a single code fence first.
  const fence = code
    ? `\`\`\`${lang}\n${code}\n\`\`\``
    : `\`\`\`${lang}\n${raw}\n\`\`\``;

  const explanation = String(parsed?.explanation || "").trim();
  const warningsMd = listToMarkdown(parsed?.warnings || []);
  const alternativesMd = listToMarkdown(parsed?.alternatives || []);

  let md = fence;

  if (explanation) md += `\n\n## Explanation\n${explanation}`;
  if (warningsMd) md += `\n\n## Warnings\n${warningsMd}`;
  if (alternativesMd) md += `\n\n## Alternatives\n${alternativesMd}`;

  const meta = {
    explanation,
    warnings: Array.isArray(parsed?.warnings) ? parsed.warnings : [],
    alternatives: Array.isArray(parsed?.alternatives) ? parsed.alternatives : [],
    lang,
  };

  return { output: md.trim(), command: code || "", meta };
}

================================================================================
FILE: .ccg_backups/mainpage_finish_v2/20260102_134820/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/mainpage_finish_v2/20260102_134820/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Ù‡Ø¯Ù: Ø®Ø±ÙˆØ¬ÛŒ Generator Ø§Ø¨Ø²Ø§Ø±Ú¯ÙˆÙ†Ù‡ Ø¨Ø§Ø´Ø¯ (Ù†Ù‡ Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ):
// - Ø§Ú¯Ø± outputType=command ÛŒØ§ script Ø¨ÙˆØ¯ØŒ Ø§ÙˆÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ù‡ ÛŒÚ© code fence Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
// - Ø¨Ù‚ÛŒÙ‡ Ù…ØªÙ† (ØªÙˆØ¶ÛŒØ­/Ù‡Ø´Ø¯Ø§Ø±/Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§) Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆØ¯
// - IMPORTANT: Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ export Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:
//   - formatOutput
//   - formatToolResponse (Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ import Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();

  // Ø§Ú¯Ø± Ø®Ø±ÙˆØ¬ÛŒ ÙÙ‚Ø· ÛŒÚ© Ø®Ø· Ø´Ø¨ÛŒÙ‡ Ø¯Ø³ØªÙˆØ± Ø¨ÙˆØ¯
  const firstLine = t.split("\n").map(s => s.trim()).find(Boolean) || "";
  if (firstLine && !firstLine.includes(" ") ? false : true) {
    // no-op (we still allow single-line commands)
  }

  // Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø§ÛŒØ¬: sudo/systemctl/journalctl/apt/ufw/docker/kubectl ...
  const looksCmd = /^(sudo\s+)?(systemctl|service|journalctl|apt|apt-get|dnf|yum|pacman|ufw|iptables|docker|kubectl|helm|git|npm|pnpm|yarn|node|python|pip|curl|wget|ssh|scp|rsync|ps|top|htop|df|du|free|ls|cd|cat|grep|awk|sed)\b/i;
  if (looksCmd.test(firstLine)) return firstLine;

  // Ø§Ú¯Ø± Ú©Ù„ Ù…ØªÙ† Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ùˆ ØªÚ© Ø®Ø· Ø¨ÙˆØ¯
  if (t.length <= 120 && !t.includes("\n")) return t;

  return "";
}

export function formatOutput({ outputType, text, cli = "bash" } = {}) {
  const ot = String(outputType ?? "").toLowerCase();
  const raw = String(text ?? "").trim();

  // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ command/script Ø³ÙØªâ€ŒÙˆØ³Ø®Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  if (!["command", "script"].includes(ot)) return raw;

  const lang = fenceLangFromCli(cli, ot);
  const { code, rest } = splitFirstCodeBlock(raw);

  // Ø§Ú¯Ø± Ù…Ø¯Ù„ Ø®ÙˆØ¯Ø´ Ú©Ø¯ Ø¨Ù„Ø§Ú© Ø¯Ø§Ø¯Ù‡ØŒ Ù‡Ù…ÙˆÙ†Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  if (code) {
    const fenced = `\`\`\`${lang}\n${code}\n\`\`\``;
    return rest ? `${fenced}\n\n${rest}` : fenced;
  }

  // Ø§Ú¯Ø± Ú©Ø¯Ø¨Ù„Ø§Ú© Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ù…ØªÙ† ÛŒÚ© Ø¯Ø³ØªÙˆØ± Ø­Ø¯Ø³ Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ…
  const guessed = guessCommandFromText(raw);
  const cmd = (guessed || raw).trim();

  const fenced = `\`\`\`${lang}\n${cmd}\n\`\`\``;

  // Ø§Ú¯Ø± Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨ÙˆØ¯Ù‡ØŒ Ø¨Ø§Ù‚ÛŒ Ø±Ùˆ Ø¨Ø¹Ù†ÙˆØ§Ù† ØªÙˆØ¶ÛŒØ­ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…
  // ÙˆÙ„ÛŒ Ú†ÙˆÙ† codeblock Ù†Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ø¨Ø±Ø§ÛŒ command Ø¨Ù‡ØªØ±Ù‡ ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ± + (Ø§Ú¯Ø± Ø²ÛŒØ§Ø¯ Ø¨ÙˆØ¯) Ø§Ø¯Ø§Ù…Ù‡ Ø±Ùˆ Ù¾Ø§ÛŒÛŒÙ†Ø´ Ø¨ÛŒØ§Ø±ÛŒÙ…
  const rest2 = (guessed && raw !== guessed) ? raw.replace(guessed, "").trim() : "";
  return rest2 ? `${fenced}\n\n${rest2}` : fenced;
}

// Backward compatibility: some routes import formatToolResponse
export function formatToolResponse(args) {
  return formatOutput(args);
}

================================================================================
FILE: .ccg_backups/day2_adv_other_payload_20260107_094322/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";

/* CCG_ADV_OTHER_V1 */

// CCG_OS_ALLOWLIST_V1
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES","Alpine","Kali",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = ["bash","zsh","sh","fish","cmd","powershell","pwsh","ksh","tcsh"];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 2, maxLen = 40) {
  const x = cleanToken(v);
  if (x.length < minLen || x.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(x);
}

function normalizeShell(v) {
  const x = cleanToken(v).toLowerCase();
  if (!x) return "";
  if (x === "powershell") return "powershell";
  if (x === "pwsh") return "pwsh";
  if (x === "cmd" || x === "cmd.exe") return "cmd";
  return x;
}

import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);

  // Advanced (target) fields
  const [targetOSName, setTargetOSName] = useState("");
  const [targetOSCustom, setTargetOSCustom] = useState("");
  const [targetOSVersion, setTargetOSVersion] = useState("");
  const [targetShell, setTargetShell] = useState("");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    
    // CCG_ADV_PAYLOAD_V1
    const advOn = !!advanced;

    // defaults
    let osValue = platform === "network" ? "network" : (platform || "linux");
    let cliValue = typeof shell === "string" && shell ? shell : (platform === "windows" ? "powershell" : "bash");

    if (advOn) {
      const name = cleanToken(targetOSName);
      const custom = cleanToken(targetOSCustom);
      const ver = cleanToken(targetOSVersion);

      let finalName = name;
      if (finalName === "Custom") finalName = custom;

      const okName = (OS_ALLOWLIST.includes(finalName) || isSafeFreeText(finalName));
      if (okName && finalName) {
        osValue = ver ? `${finalName} ${ver}` : finalName;
      }

      const sh = normalizeShell(targetShell) || normalizeShell(cliValue);
      const okShell = SHELL_ALLOWLIST.includes(sh) || isSafeFreeText(sh, 2, 20);
      if (sh && okShell) cliValue = sh;
    }
const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

              {/* CCG_ADV_UI_V1 */}
              <div className="flex items-center gap-2 mt-2">
                <input
                  id="ccg-advanced"
                  type="checkbox"
                  checked={advanced}
                  onChange={(e) => setAdvanced(e.target.checked)}
                />
                <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">
                  {t("advanced")}
                </label>
              </div>

              {advanced ? (
                <div className="mt-3 w-full grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <FieldLabel label={t("targetOSName")} tip={t("tip_targetOSName")} />
                    <select
                      className="ccg-select text-sm w-full"
                      value={targetOSName}
                      onChange={(e) => setTargetOSName(e.target.value)}
                    >
                      <option value="">{lang === "fa" ? "Ø§Ù†ØªØ®Ø§Ø¨..." : "Select..."}</option>
                      {OS_ALLOWLIST.map((x) => (
                        <option key={x} value={x}>{x}</option>
                      ))}
                      <option value="Custom">Custom</option>
                    </select>

                    {targetOSName === "Custom" ? (
                      <input
                        className="ccg-input mt-2 w-full text-sm"
                        value={targetOSCustom}
                        onChange={(e) => setTargetOSCustom(e.target.value)}
                        placeholder={t("customHint")}
                      />
                    ) : null}
                  </div>

                  <div>
                    <FieldLabel label={t("targetOSVersion")} tip={t("tip_targetOSVersion")} />
                    <input
                      className="ccg-input w-full text-sm"
                      value={targetOSVersion}
                      onChange={(e) => setTargetOSVersion(e.target.value)}
                      placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 22.04 / 2019 / 13.2" : "e.g., 22.04 / 2019 / 13.2"}
                    />
                  </div>

                  <div>
                    <FieldLabel label={t("targetShell")} tip={t("tip_targetShell")} />
                    <select
                      className="ccg-select text-sm w-full"
                      value={targetShell}
                      onChange={(e) => setTargetShell(e.target.value)}
                    >
                      <option value="">{lang === "fa" ? "Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø² Ø´Ù„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ" : "Default (selected shell)"}</option>
                      {SHELL_ALLOWLIST.map((x) => (
                        <option key={x} value={x}>{x}</option>
                      ))}
                    </select>
                  </div>
                </div>
              ) : null}


            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/outputFormatter_toolstyle/20260103_051430/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// CCG Tool-Style Post-Processor (Generator)
// Guarantees (for outputType: "markdown" or "tool"):
// 1) FIRST thing is exactly ONE fenced code block.
// 2) Code fence contains ONLY command-like lines (no prose).
// 3) Always has sections: ØªÙˆØ¶ÛŒØ­ / Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (filled if missing).
// Backward-compatible exports:
// - formatOutput
// - formatToolResponse (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function hasFaChars(s) {
  return /[\u0600-\u06FF]/.test(String(s || ""));
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;

  // very long lines are often prose
  if (s.length > 220) return false;

  // reject common prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;

  // reject lines that contain Persian prose (usually explanation), but allow paths with fa rarely
  if (hasFaChars(s) && !/[\/._-]/.test(s)) return false;

  // allow comments
  if (s.startsWith("#") || s.startsWith("::")) return true;

  // starts with sudo or common tools/commands
  if (/^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s)) return true;

  return false;
}

// keep only command-like lines from code block
function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map((l) => l.replace(/\r/g, "").trim())
    .filter(Boolean);

  const kept = [];
  for (const l of lines) {
    if (looksLikeCommand(l)) kept.push(l);
  }
  return kept.join("\n").trim();
}

// if there is no code block, try to pick first command-ish lines from full text
function guessCommandsFromText(fullText) {
  const lines = String(fullText || "")
    .split("\n")
    .map((l) => l.replace(/\r/g, "").trim())
    .filter(Boolean);

  const kept = [];
  for (const l of lines) {
    // stop early if we already found a command and then prose begins
    if (kept.length && (!looksLikeCommand(l) || hasFaChars(l))) break;
    if (looksLikeCommand(l)) kept.push(l);
    if (kept.length >= 4) break;
  }
  return kept.join("\n").trim();
}

function parseSections(rest) {
  // supports both fa + en headings
  const t = String(rest || "").trim();
  if (!t) return { exp: "", warn: "", alt: "" };

  const lines = t.split("\n");
  const out = { exp: "", warn: "", alt: "", other: "" };
  let cur = "other";

  function keyOfHeading(h) {
    const hh = h.trim().toLowerCase();
    if (/^#+\s*(ØªÙˆØ¶ÛŒØ­|Ø´Ø±Ø­|explanation)\s*$/.test(hh)) return "exp";
    if (/^#+\s*(Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§|Ù‡Ø´Ø¯Ø§Ø±|warnings?)\s*$/.test(hh)) return "warn";
    if (/^#+\s*(Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù‡Ø§|alternatives?)\s*$/.test(hh)) return "alt";
    return "";
  }

  for (const line of lines) {
    const k = keyOfHeading(line);
    if (k) {
      cur = k;
      continue;
    }
    out[cur] += (out[cur] ? "\n" : "") + line;
  }

  return {
    exp: out.exp.trim() || out.other.trim(), // if explanation missing, use other as exp
    warn: out.warn.trim(),
    alt: out.alt.trim(),
  };
}

function ensureBullets(text, lang = "fa") {
  const t = String(text || "").trim();
  if (!t) return "";
  // if already has bullets/numbering, keep
  if (/^\s*([-*]|\d+\.)\s+/m.test(t)) return t;
  // otherwise make single bullet list line-by-line
  const lines = t.split("\n").map((l) => l.trim()).filter(Boolean);
  if (!lines.length) return "";
  return lines.map((l) => `- ${l}`).join("\n");
}

function autoHintsFromCommand(cmd, lang = "fa") {
  const c = String(cmd || "").toLowerCase();
  const fa = String(lang || "fa").toLowerCase().startsWith("fa");

  const hints = { warn: [], alt: [] };

  // reboot/shutdown
  if (/\b(reboot|shutdown)\b/.test(c) || /\bsystemctl\s+reboot\b/.test(c)) {
    if (fa) {
      hints.warn.push("Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±ØªØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.");
      hints.warn.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ø±ÛŒÙ…ÙˆØª Ù‡Ø³ØªÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ SSH Ù‚Ø·Ø¹ Ø´ÙˆØ¯.");
      hints.alt.push("shutdown -r now");
      hints.alt.push("systemctl reboot");
    } else {
      hints.warn.push("Save any unsaved work before rebooting.");
      hints.warn.push("On remote servers, your SSH session will disconnect.");
      hints.alt.push("shutdown -r now");
      hints.alt.push("systemctl reboot");
    }
  }

  // rm -rf
  if (/\brm\s+-rf\b/.test(c) || /\brm\s+-r(f)?\b/.test(c)) {
    if (fa) {
      hints.warn.push("rm -rf Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÛŒØ± Ø§Ø³ØªØ› Ù‚Ø¨Ù„Ø´ Ù…Ø³ÛŒØ± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø± Ú†Ú© Ú©Ù†ÛŒØ¯.");
      hints.alt.push("Ø§ÙˆÙ„ Ø¨Ø§ ls / echo Ù…Ø³ÛŒØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ rm Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
    } else {
      hints.warn.push("rm -rf is destructive; double-check the path first.");
      hints.alt.push("Inspect with ls/echo first, then run rm.");
    }
  }

  // ufw
  if (/\bufw\b/.test(c)) {
    if (fa) {
      hints.warn.push("ØªØºÛŒÛŒØ±Ø§Øª ÙØ§ÛŒØ±ÙˆØ§Ù„ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ SSH Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†Ø¯Ø› rule Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ SSH Ø±Ø§ Ù‚Ø¨Ù„Ø´ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯.");
      hints.alt.push("ufw status verbose");
    } else {
      hints.warn.push("Firewall changes may cut off SSH; ensure SSH rules first.");
      hints.alt.push("ufw status verbose");
    }
  }

  return hints;
}

export function formatOutput({ outputType = "markdown", text = "", cli = "bash", lang = "fa" } = {}) {
  const ot = String(outputType || "markdown").toLowerCase();

  // "tool" acts like markdown but enforced structure
  const isTool = ot === "tool" || ot === "markdown";
  const fenceLang = fenceLangFromCli(cli, ot);

  const { codeRaw, rest } = splitFirstCodeBlock(text);
  let code = normalizeCodeToCommands(codeRaw);
  if (!code) code = guessCommandsFromText(text);

  const fenced = `\`\`\`${fenceLang}\n${code || ""}\n\`\`\``.trim();

  // command/script/python => return only code fence (CLI-friendly)
  if (!isTool) return fenced;

  const sections = parseSections(rest);
  const cmdForHints = code.split("\n").find(Boolean) || "";
  const hints = autoHintsFromCommand(cmdForHints, lang);

  const fa = String(lang || "fa").toLowerCase().startsWith("fa");
  const H_EXP = fa ? "## ØªÙˆØ¶ÛŒØ­" : "## Explanation";
  const H_WARN = fa ? "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" : "## Warnings";
  const H_ALT = fa ? "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" : "## Alternatives";

  const exp = sections.exp || (fa ? "â€”" : "â€”");
  const warn = ensureBullets(sections.warn || hints.warn.join("\n"), lang) || (fa ? "- Ù†Ø¯Ø§Ø±Ø¯" : "- none");
  const alt = ensureBullets(sections.alt || hints.alt.join("\n"), lang) || (fa ? "- Ù†Ø¯Ø§Ø±Ø¯" : "- none");

  const body =
`${H_EXP}
${exp}

${H_WARN}
${warn}

${H_ALT}
${alt}`.trim();

  return `${fenced}\n\n${body}`.trim();
}

// backward compat
export const formatToolResponse = formatOutput;

================================================================================
FILE: .ccg_backups/mainpage_stabilize/20260102_135643/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Tool-style output normalizer for Generator.
// - Ensures FIRST thing is ONE fenced code block (command/script)
// - Preserves the rest (explanation/warnings/alternatives)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  // try: first non-empty line that looks like a command
  const lines = t.split(/\r?\n/).map((x) => x.trim()).filter(Boolean);
  for (const line of lines) {
    if (
      /^([a-zA-Z0-9_\-]+)(\s|$)/.test(line) &&
      !/^#{1,6}\s/.test(line) &&
      !/^[-*]\s/.test(line)
    ) return line;
  }
  return "";
}

export function formatToolResponse({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase();
  const raw = String(text ?? "").trim();
  if (!raw) return "";

  // If outputType is not command/script/markdown, return as-is.
  if (!["command", "script", "markdown"].includes(ot)) return raw;

  const { code, rest } = splitFirstCodeBlock(raw);
  const lang = fenceLangFromCli(cli, ot);

  const finalCode = (code || guessCommandFromText(raw)).trim();
  if (!finalCode) return raw; // nothing to normalize

  const fenced = `\`\`\`${lang}\n${finalCode}\n\`\`\``;

  // Preserve rest if exists
  if (rest) return `${fenced}\n\n${rest}`.trim();
  return fenced;
}

// Backward-compatible export name (some routes may import formatOutput)
export function formatOutput(args) {
  return formatToolResponse(args);
}

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_ui_fix/20260106_115045/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_ui_fix/20260106_115045/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Stable tool contract handling for "generate".
// - Extract JSON object from model output
// - Validate OS/CLI consistency (basic guardrails)
// - Always return { tool, markdown }

function safeJsonParse(s) { try { return JSON.parse(s); } catch { return null; } }

function extractFirstJsonObject(raw) {
  const t = String(raw ?? "").trim();
  // Find first '{' ... matching '}' (simple stack)
  const start = t.indexOf("{");
  if (start < 0) return null;
  let depth = 0;
  for (let i = start; i < t.length; i++) {
    const ch = t[i];
    if (ch === "{") depth++;
    else if (ch === "}") {
      depth--;
      if (depth === 0) {
        const slice = t.slice(start, i + 1);
        const obj = safeJsonParse(slice);
        if (obj) return obj;
      }
    }
  }
  return null;
}

function fenceLangFromCli(cli = "bash", outputType = "markdown") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function normalizeTool(tool, { os, cli, undefined } = {}) {
  const lang = fenceLangFromCli(cli, "markdown");
  const t = tool && typeof tool === "object" ? tool : {};

  const primaryCmd = String(t?.primary?.command ?? "").trim();
  const explanation = String(t?.explanation ?? "").trim();
  const warnings = Array.isArray(t?.warnings) ? t.warnings.map(x => String(x).trim()).filter(Boolean) : [];
  const alternatives = Array.isArray(t?.alternatives) ? t.alternatives : [];

  // Ensure arrays length
  while (warnings.length < 3) warnings.push("Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Backup Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
  warnings.length = 3;

  const alts = alternatives
    .map(a => ({
      command: String(a?.command ?? "").trim(),
      note: String(a?.note ?? "").trim(),
    }))
    .filter(a => a.command);

  // Ensure exactly 3 alternatives (fill safe minimal related)
  while (alts.length < 3) alts.push({ command: "", note: "" });
  alts.length = 3;

  // Basic OS/CLI guard: if windows selected, reject obvious linux commands and vice versa
  const osL = String(os || "").toLowerCase();
  const cliL = String(cli || "").toLowerCase();
  const looksLinux = (s) => /\b(sudo|systemctl|journalctl|apt|yum|dnf|shutdown\s+-)/i.test(s);
  const looksWindows = (s) => /\b(shutdown\s+\/|net\s+user|ipconfig|powershell|Get-)/i.test(s);

  const mismatch =
    (osL.includes("win") && looksLinux(primaryCmd)) ||
    ((osL.includes("linux") || osL.includes("mac")) && looksWindows(primaryCmd));

  if (mismatch || !primaryCmd) {
    return {
      primary: { command: "", lang },
      explanation: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¨Ù‡Ù…/Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ Ø¨Ø§ OS/CLI Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø­Ø§Ù„Øª Chat Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…Ø·Ù…Ø¦Ù† Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.",
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø³ÛŒØ³ØªÙ…ÛŒØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡/Backup Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ø§ÛŒÙ† Ú©Ø§Ø± Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±/Production Ø§Ø³ØªØŒ Ø­ØªÙ…Ø§Ù‹ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      ],
      alternatives: [
        { command: "", note: "Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´ÙˆØ¯." },
        { command: "", note: "Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Chat Ù…Ø³ÛŒØ± Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ TroubleShoot Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯." },
        { command: "", note: "OS/CLI ØµØ­ÛŒØ­ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Generate Ø¨Ø²Ù†ÛŒØ¯." },
      ],
    };
  }

  // KnowledgeLevel shaping (only affects explanation a bit if model is vague)
  let exp = explanation;
  if (!exp) {
    if (String(undefined).toLowerCase() === "beginner") exp = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¢Ù† Ø±Ø§ Ø¯Ø± ØªØ±Ù…ÛŒÙ†Ø§Ù„/Ø®Ø· ÙØ±Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.";
    else if (String(undefined).toLowerCase() === "intermediate") exp = "Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø§Ø³Øª.";
    else exp = "Ø¯Ø³ØªÙˆØ± Ù…Ø³ØªÙ‚ÛŒÙ….";
  }

  // Ensure alt notes are short
  for (const a of alts) {
    if (!a.note) a.note = "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø±ØªØ¨Ø·";
    if (a.note.length > 90) a.note = a.note.slice(0, 87) + "...";
  }

  return {
    primary: { command: primaryCmd, lang },
    explanation: exp,
    warnings,
    alternatives: alts,
  };
}

function toolToMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const cmd = tool?.primary?.command ? tool.primary.command.trim() : "";
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];
  const warn = Array.isArray(tool?.warnings) ? tool.warnings : [];

  const fence = cmd ? "```" + lang + "\n" + cmd + "\n```" : "```" + lang + "\n" + "\n```";

  const lines = [];
  lines.push(fence);
  lines.push("");
  lines.push("## ØªÙˆØ¶ÛŒØ­");
  lines.push(tool?.explanation || "");
  lines.push("");
  lines.push("## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§");
  for (const w of warn) lines.push("- " + w);
  lines.push("");
  lines.push("## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§");
  for (const a of alts) {
    const note = a?.note ? String(a.note) : "";
    const c = a?.command ? String(a.command).trim() : "";
    lines.push("- " + note);
    lines.push("");
    lines.push("```" + lang + "\n" + c + "\n```");
    lines.push("");
  }
  return lines.join("\n").trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, outputType }) {
  const extracted = extractFirstJsonObject(rawText);
  const tool = normalizeTool(extracted, { os, cli, undefined });

  const markdown = toolToMarkdown(tool);

  // For outputType command/script: only show primary copy block (as you wanted)
  const ot = String(outputType || "markdown").toLowerCase();
  if (ot === "command" || ot === "script") {
    const lang = tool?.primary?.lang || fenceLangFromCli(cli, "markdown");
    const cmd = tool?.primary?.command || "";
    return { tool, markdown: "```" + lang + "\n" + cmd + "\n```" };
  }

  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/generator_toolstyle_v3/20260102_130322/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Ù‡Ø¯Ù: Ø®Ø±ÙˆØ¬ÛŒ Generator Ø´Ø¨ÛŒÙ‡ Ø§Ø¨Ø²Ø§Ø± DevOps Ø¨Ø§Ø´Ø¯:
// - Ù‡Ù…ÛŒØ´Ù‡ Ø§ÙˆÙ„ ÛŒÚ© fenced code block Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (command/script)
// - Ø¨Ù‚ÛŒÙ‡ Ù…ØªÙ† (ØªÙˆØ¶ÛŒØ­/Ù‡Ø´Ø¯Ø§Ø±/Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§) Ø­ÙØ¸ Ø´ÙˆØ¯ Ùˆ Ø­Ø°Ù Ù†Ø´ÙˆØ¯.

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const re = /```([^\n]*)\n([\s\S]*?)```/m;
  const m = t.match(re);
  if (!m) return { has: false, code: "", tail: t };

  const full = m[0];
  const code = String(m[2] ?? "").trim();
  const idx = t.indexOf(full);
  const tail = (idx >= 0 ? t.slice(idx + full.length) : "").trim();
  return { has: true, code, tail };
}

function guessCodeFromText(text, outputType) {
  const t = String(text ?? "").trim();
  if (!t) return "";
  const lines = t.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  if (!lines.length) return "";

  if (String(outputType || "").toLowerCase() === "command") {
    // Ø¨Ø±Ø§ÛŒ command ÙÙ‚Ø· ÛŒÚ© Ø®Ø·/Ú©Ø§Ù…Ù†Ø¯ Ø§ØµÙ„ÛŒ
    // (Ø§Ú¯Ø± Ú†Ù†Ø¯ Ø®Ø· Ù„Ø§Ø²Ù… Ø¨ÙˆØ¯ØŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ outputType=script Ø¨Ø²Ù†Ø¯)
    return lines[0];
  }
  // Ø¨Ø±Ø§ÛŒ script Ú†Ù†Ø¯ Ø®Ø· Ø§ÙˆÙ„ ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ø§ÛŒØ¬
  // (Ø§Ú¯Ø± Ù‡Ø¯Ø±Ù‡Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ†Ø¯ØŒ ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ù‡Ø¯Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…)
  const stopIdx = lines.findIndex(l => /^#{1,6}\s+/.test(l) || /^- /.test(l) || /^ØªÙˆØ¶ÛŒØ­\b|^Ù‡Ø´Ø¯Ø§Ø±\b|^Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†\b/i.test(l));
  if (stopIdx > 0) return lines.slice(0, stopIdx).join("\n");
  return lines.join("\n");
}

export function formatOutput({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase();
  if (!["command", "script"].includes(ot)) return String(text ?? "").trim();

  const lang = fenceLangFromCli(cli, ot);
  const { has, code, tail } = splitFirstCodeBlock(text);

  const finalCode = (has ? code : guessCodeFromText(text, ot)).trim();
  const fenced = finalCode ? `\`\`\`${lang}\n${finalCode}\n\`\`\`` : `\`\`\`${lang}\n\n\`\`\``;

  // Ù…Ù‡Ù…: tail Ø±Ø§ Ø­Ø°Ù Ù†Ú©Ù†! (ØªÙˆØ¶ÛŒØ­/Ù‡Ø´Ø¯Ø§Ø±/Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ§ÛŒØ¯)
  return tail ? `${fenced}\n\n${tail}` : fenced;
}

// Ø¨Ø±Ø§ÛŒ Ù‡Ø±Ù†ÙˆØ¹ import (default ÛŒØ§ named) Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§Ø´Ù‡
export default formatOutput;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/lock_tool_contract_20260103_093401/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/fix_object_object_ui/20260103_100241/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/ui_contract_stabilize/20260103_103042/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/lock_generate_json_contract/20260106_090951/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/lock_generate_json_contract/20260106_090951/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Stable Tool Contract Normalizer for GENERATOR
//
// Contract (tool):
// {
//   primary: { command: string, lang: string },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command: string, note: string }, ...] // exactly 3
// }
//
// Markdown order (always):
// 1) Primary command (ONE fenced block)
// 2) ## ØªÙˆØ¶ÛŒØ­
// 3) ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§  (rendered in UI as red card if supported)
// 4) ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (3 items, each: note + its own fenced block)
//
// Notes:
// - This file should NOT invent Linux alternatives for Windows (OS-aware).
// - If request is ambiguous: return a short ask-for-details + suggest chat mode.

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  // network-cli or unknown -> keep bash-like fence (UI will still copy)
  if (c.includes("network")) return "text";
  return "bash";
}

function stripFences(s) {
  const t = String(s || "").trim();
  // remove a single surrounding fence if it's pure fenced content
  const m = t.match(/^```[^\n]*\n([\s\S]*?)\n```$/);
  return m ? String(m[1] || "").trim() : t;
}

function tryParseToolJSON(rawText) {
  const t = stripFences(rawText);
  // Find first JSON object in text (robust to leading prose)
  const start = t.indexOf("{");
  const end = t.lastIndexOf("}");
  if (start < 0 || end <= start) return null;
  const candidate = t.slice(start, end + 1);
  try {
    const obj = JSON.parse(candidate);
    // accept either direct contract or {tool:{...}}
    const tool = obj?.tool && typeof obj.tool === "object" ? obj.tool : obj;
    if (tool?.primary?.command && tool?.alternatives) return tool;
    return null;
  } catch {
    return null;
  }
}

function isAmbiguous(userRequest) {
  const u = String(userRequest || "").trim();
  if (!u) return true;
  // too short / generic
  if (u.length < 8) return true;
  // generic words without action/context
  const weak = ["Ú©Ù…Ú©", "help", "Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ù…", "Ù†Ù…ÛŒØ§Ø¯", "Ú©Ø§Ø± Ù†Ù…ÛŒÚ©Ù†Ù‡", "ÛŒÙ‡ Ú†ÛŒØ²ÛŒ Ø¨Ú¯Ùˆ"];
  if (weak.some(w => u.includes(w))) return true;
  return false;
}

function ensure3(arr, fillFn) {
  const a = Array.isArray(arr) ? arr.filter(Boolean) : [];
  while (a.length < 3) a.push(fillFn(a.length));
  return a.slice(0, 3);
}

function osKey(os) {
  const o = String(os || "").toLowerCase();
  if (o.includes("win")) return "windows";
  if (o.includes("mac") || o.includes("darwin")) return "mac";
  if (o.includes("network")) return "network";
  return "linux";
}

function defaultWarnings({ os, cli, outputType }) {
  const o = osKey(os);
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();

  // Python automation warnings (generic)
  if (ot === "python") {
    return [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø³ÛŒØ±Ù‡Ø§/Ø§Ø¹ØªØ¨Ø§Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (credentials) Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
      "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø§Ø¨ØªØ¯Ø§ Dry-run/Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      "Ø®Ø±ÙˆØ¬ÛŒ/Ù„Ø§Ú¯ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ù‚Ø§Ø¨Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¨Ø§Ø´Ø¯.",
    ];
  }

  if (o === "windows") {
    const isPs = c.includes("powershell") || c === "pwsh";
    return [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ± Ù†ÛŒØ§Ø² Ø¨Ù‡ Admin Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ Run as Administrator Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      isPs ? "Ø¯Ø± PowerShellØŒ Policy/ExecutionPolicy Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø±ÙˆÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ Ø§Ø«Ø± Ø¨Ú¯Ø°Ø§Ø±Ø¯." : "Ø¯Ø± CMDØŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø±Ø§ Ø¯Ù‚ÛŒÙ‚ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯.",
    ];
  }

  if (o === "network") {
    return [
      "Ø±ÙˆÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø´Ø¨Ú©Ù‡ØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² Ú©Ø§Ù†ÙÛŒÚ¯ Backup Ø¨Ú¯ÛŒØ±ÛŒØ¯.",
      "Ø¯Ø± ØµÙˆØ±Øª Ø§Ù…Ú©Ø§Ù† ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø¯Ø± Maintenance window Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ø¹Ø« Ù‚Ø·Ø¹ Ø§Ø±ØªØ¨Ø§Ø· Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø¯Ø³ØªØ±Ø³ÛŒ Out-of-band Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.",
    ];
  }

  // linux/mac default
  return [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
    "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø´ÙˆØ¯.",
    "Ø¯Ø± Ù…Ø­ÛŒØ· ProductionØŒ Ø§Ø¨ØªØ¯Ø§ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
  ];
}

function pickOSAwareAlternatives({ userRequest, os, cli }) {
  const o = osKey(os);
  const u = String(userRequest || "").toLowerCase();

  // Shutdown / reboot family
  const wantsShutdown = u.includes("Ø®Ø§Ù…ÙˆØ´") || u.includes("shutdown") || u.includes("power off");
  const wantsReboot = u.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || u.includes("restart") || u.includes("reboot");
  const hasDelay = u.includes("Ø¯Ù‚ÛŒÙ‚Ù‡") || u.includes("minute") || u.match(/\b\d+\b/);

  if (o === "windows") {
    // CMD/PowerShell both can use shutdown.exe
    if (wantsShutdown) {
      return [
        { command: "shutdown /s /t 60", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø¨Ø§ ØªØ£Ø®ÛŒØ± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ (Ù†Ù…ÙˆÙ†Ù‡ Ø±Ø§ÛŒØ¬)" },
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù†/Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† ÙÙˆØ±ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÛŒØ±)" },
      ];
    }
    if (wantsReboot) {
      return [
        { command: "shutdown /r /t 0", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
        { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ ØªØ£Ø®ÛŒØ± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡" },
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      ];
    }
    // generic windows
    return [
      { command: "where <command>", note: "Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ÛŒØ± Ø§Ø¬Ø±Ø§ÛŒ ÛŒÚ© Ø¯Ø³ØªÙˆØ± (CMD)" },
      { command: "whoami", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ" },
      { command: "systeminfo", note: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…" },
    ];
  }

  if (o === "linux" || o === "mac") {
    if (wantsShutdown) {
      return [
        { command: "sudo shutdown -h +1", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† ÙÙˆØ±ÛŒ" },
      ];
    }
    if (wantsReboot) {
      return [
        { command: "sudo reboot", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      ];
    }
    return [
      { command: "uname -a", note: "Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø±Ù†Ù„/Ø³ÛŒØ³ØªÙ…" },
      { command: "whoami", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ" },
      { command: "id", note: "Ù†Ù…Ø§ÛŒØ´ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ Ùˆ UID/GID" },
    ];
  }

  // network fallback (vendor-aware could be expanded later)
  return [
    { command: "show version", note: "Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø³Ø®Ù‡/Ø³ÛŒØ³ØªÙ… (Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Vendor)" },
    { command: "show running-config", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù†ÙÛŒÚ¯ ÙØ¹Ù„ÛŒ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø§Ø´Ø¯)" },
    { command: "show interfaces", note: "Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø§ÛŒÙ†ØªØ±ÙÛŒØ³â€ŒÙ‡Ø§" },
  ];
}

function renderMarkdown(tool) {
  const primary = tool?.primary?.command || "";
  const lang = tool?.primary?.lang || "bash";
  const explanation = String(tool?.explanation || "").trim();
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alternatives = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warnings.filter(Boolean).map(w => `- ${String(w).trim()}`).join("\n") || "- (Ù†Ø¯Ø§Ø±Ø¯)";
  const altBlocks = alternatives.map(a => {
    const note = String(a?.note || "").trim() || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = String(a?.command || "").trim();
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `\`\`\`${lang}\n${primary}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${explanation || "(Ù†Ø¯Ø§Ø±Ø¯)"}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks || "(Ù†Ø¯Ø§Ø±Ø¯)"}`.trim();
}

export function formatToolResponse({
  rawText,
  userRequest,
  os,
  cli,
  knowledgeLevel,
  outputType,
}) {
  const langTag = fenceLangFromCli(cli, outputType);

  // Ambiguity handling
  if (isAmbiguous(userRequest)) {
    const tool = {
      primary: { command: "", lang: langTag },
      explanation: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ù…Ø¨Ù‡Ù… Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø³Ø±ÙˆÛŒØ³/ÙØ§ÛŒÙ„/Ø¢ÛŒâ€ŒÙ¾ÛŒ/Ù†Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡/Ø®Ø±ÙˆØ¬ÛŒ Ø®Ø·Ø§). ÛŒØ§ Ø§Ø² Ø­Ø§Ù„Øª Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ (Chat) Ø¨Ø±Ø§ÛŒ Troubleshooting Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
      warnings: defaultWarnings({ os, cli, outputType }),
      alternatives: ensure3([], (i) => ({ command: "", note: "â€”" })),
    };
    return { tool, markdown: renderMarkdown(tool) };
  }

  // Prefer model-provided JSON contract if present
  const parsed = tryParseToolJSON(rawText);
  if (parsed) {
    const tool = {
      primary: {
        command: String(parsed?.primary?.command || "").trim(),
        lang: String(parsed?.primary?.lang || langTag).trim() || langTag,
      },
      explanation: String(parsed?.explanation || "").trim(),
      warnings: ensure3(parsed?.warnings, (i)=> defaultWarnings({os,cli,outputType})[i] || "Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯."),
      alternatives: ensure3(parsed?.alternatives, (i)=> pickOSAwareAlternatives({userRequest,os,cli})[i]),
    };
    // Force exactly 3 alternatives
    tool.alternatives = tool.alternatives.slice(0, 3);
    return { tool, markdown: renderMarkdown(tool) };
  }

  // If no JSON: do OS-aware minimal synthesis (NOT cross-OS)
  const alts = pickOSAwareAlternatives({ userRequest, os, cli });
  // Primary: choose the first alternative as best default if model didn't give a clean primary command
  const primaryCmd = String(alts?.[0]?.command || "").trim();

  const tool = {
    primary: { command: primaryCmd, lang: langTag },
    explanation: "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ (OS/CLI/Ø³Ø·Ø­ Ø¯Ø§Ù†Ø´) ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Chat Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
    warnings: defaultWarnings({ os, cli, outputType }),
    alternatives: ensure3(alts, (i)=> alts[i] || { command: primaryCmd, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" }),
  };

  return { tool, markdown: renderMarkdown(tool) };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/fix_contract_20260106_062417/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/fix_contract_20260106_062417/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool Contract (LOCKED)
// Produces:
//   tool: { primary{command,lang}, explanation, warnings[], alternatives[{command,note}*3] }
//   markdown: string (stable template)
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 200) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizePrimaryCommand(rawText) {
  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const fromFence = (codeRaw || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromFence.length) return { command: fromFence.join("\n"), rest };

  const fromText = String(rawText || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromText.length) return { command: fromText[0], rest };
  return { command: "", rest };
}

function ensure3Alts(alts, fallbackCmd, os, cli) {
  const out = Array.isArray(alts) ? alts.filter(Boolean) : [];
  while (out.length < 3) {
    out.push({ command: fallbackCmd || "", note: "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });
  }
  return out.slice(0, 3);
}

function defaultWarnings(os, cli, userRequest) {
  const o = String(os || "").toLowerCase();
  const c = String(cli || "").toLowerCase();
  const req = String(userRequest || "").toLowerCase();
  const w = [];
  w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…ÙˆØ§Ø±Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
  if (req.includes("shutdown") || req.includes("Ø®Ø§Ù…ÙˆØ´") || req.includes("reboot") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª")) {
    w.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH/Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.");
    w.push("Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.");
  } else {
    w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ ProductionØŒ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
    w.push("Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Admin/sudo Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.");
  }
  if (o === "network" || req.includes("cisco") || req.includes("mikrotik") || req.includes("forti")) {
    w.unshift("Ø±ÙˆÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø´Ø¨Ú©Ù‡ØŒ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² config Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯ Ùˆ Ø²Ù…Ø§Ù† maintenance Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.");
  }
  if (c.includes("cmd")) {
    // ÙˆÛŒÙ†Ø¯ÙˆØ² Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ sudo Ù†Ø¯Ø§Ø±Ø¯
    // keep generic warning
  }
  return w.slice(0, 3);
}

// Try parse JSON tool payload if model returned it
function tryParseJsonTool(text) {
  const t = String(text || "").trim();
  if (!t.startsWith("{")) return null;
  try {
    const obj = JSON.parse(t);
    return obj && typeof obj === "object" ? obj : null;
  } catch {
    return null;
  }
}

function renderMarkdown(tool) {
  const p = tool?.primary || {};
  const primaryFence = `\`\`\`${p.lang || "bash"}\n${p.command || ""}\n\`\`\``;

  const expl = tool?.explanation ? String(tool.explanation).trim() : "";
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warnings.length ? warnings.map((x) => `- ${x}`).join("\n") : "- (Ù†Ø¯Ø§Ø±Ø¯)";
  const altBlocks = alts
    .slice(0, 3)
    .map((a) => {
      const note = String(a?.note || "").trim() || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
      const cmd = String(a?.command || "").trim();
      return `- ${note}\n\n\`\`\`${p.lang || "bash"}\n${cmd}\n\`\`\``;
    })
    .join("\n\n");

  return `${primaryFence}\n\n## ØªÙˆØ¶ÛŒØ­\n${expl || "(ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª)"}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks || "- (Ù†Ø¯Ø§Ø±Ø¯)"}`;
}

export function formatToolResponse({
  text,
  cli = "bash",
  os = "linux",
  userRequest = "",
  outputType = "command", // command|python
  lang = "fa",
  knowledgeLevel = "beginner",
} = {}) {
  const cliLang = fenceLangFromCli(cli, outputType);

  // (A) If model returned strict JSON, trust it (but normalize)
  const parsed = tryParseJsonTool(text);
  if (parsed?.primary?.command) {
    const tool = {
      primary: { command: String(parsed.primary.command).trim(), lang: parsed.primary.lang || cliLang },
      explanation: String(parsed.explanation || "").trim(),
      warnings: Array.isArray(parsed.warnings) ? parsed.warnings.map(String) : [],
      alternatives: Array.isArray(parsed.alternatives) ? parsed.alternatives : [],
    };
    tool.warnings = tool.warnings.filter(Boolean).slice(0, 5);
    tool.alternatives = ensure3Alts(tool.alternatives, tool.primary.command, os, cli);
    const markdown = renderMarkdown(tool);
    return { tool, markdown };
  }

  // (B) Otherwise parse from markdown-ish text
  const { command, rest } = normalizePrimaryCommand(text);
  const warnings = defaultWarnings(os, cli, userRequest);

  // Simple explanation extraction: first non-empty prose chunk from rest
  const expl = String(rest || "").split("\n").map((x) => x.trim()).filter(Boolean).slice(0, 6).join("\n");
  const tool = {
    primary: { command: command || "", lang: cliLang },
    explanation: expl || (lang === "fa" ? "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯." : "This command performs the primary action for your request."),
    warnings,
    alternatives: ensure3Alts([], command, os, cli),
  };

  // If no primary command, keep template but empty command
  const markdown = renderMarkdown(tool);
  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/lock_generate_contract_v2/20260106_080311/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/lock_generate_contract_v2/20260106_080311/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Locked Tool Contract normalizer for Generator
// Guarantees (for outputType: markdown/tool):
// 1) Primary command FIRST as ONE fenced block (ONLY command-like lines)
// 2) Then: ## ØªÙˆØ¶ÛŒØ­ / ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (always present, always meaningful)
// 3) Alternatives: always 3, OS/CLI-consistent
//
// Backward-compatible exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function norm(s) { return String(s ?? "").trim(); }

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = norm(text);
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = norm(m[1] ?? "");
  const rest = norm(t.replace(m[0], ""));
  return { codeRaw, rest };
}

function looksLikeCommandLine(line) {
  const s = norm(line);
  if (!s) return false;
  if (s.length > 220) return false;
  // reject prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // allow typical command patterns
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s) || /^shutdown(\s+|$)/i.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "").split(/\r?\n/);
  const cmds = [];
  for (const ln of lines) {
    const s = norm(ln);
    if (!s) continue;
    if (looksLikeCommandLine(s)) cmds.push(s);
  }
  // keep unique, preserve order
  const seen = new Set();
  const out = [];
  for (const c of cmds) {
    const k = c.toLowerCase();
    if (!seen.has(k)) { seen.add(k); out.push(c); }
  }
  return out.join("\n").trim();
}

function detectIntentFa(userRequest) {
  const u = norm(userRequest);
  if (!u) return "";
  if (u.includes("Ø®Ø§Ù…ÙˆØ´") || u.includes("shutdown") || u.includes("turn off")) return "shutdown";
  if (u.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || u.includes("reboot") || u.includes("restart")) return "restart";
  return "";
}

function windowsTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "shutdown /s /t 60",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¯Ø± CMD Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ Ø­Ø³Ø§Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª (Ø¢Ù¾Ø¯ÛŒØª/Ø¨Ú©Ø§Ù¾)ØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø±Ø§ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù†ÛŒØ¯.",
        "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø­ØªÙ…Ø§Ù‹ Ø¯Ø³ØªÙˆØ± Ù„ØºÙˆ Ø±Ø§ Ø¨Ø¯Ø§Ù†ÛŒØ¯."
      ],
      alternatives: [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "shutdown /s /t 300", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
      ],
    };
  }
  // restart
  return {
    primary: "shutdown /r /t 0",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¯Ø± CMDØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³/ProductionØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯."
    ],
    alternatives: [
      { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
      { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      { command: "shutdown /r /f /t 0", note: "Ø±ÛŒØ³ØªØ§Ø±Øª + Ø¨Ø³ØªÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" }
    ],
  };
}

function linuxTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "sudo shutdown -h +1",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
        "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "sudo shutdown -h now", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }
      ],
    };
  }
  return {
    primary: "sudo reboot",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ÛŒØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
    ],
    alternatives: [
      { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ systemd" },
      { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
      { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
    ],
  };
}

function buildMarkdown(tool) {
  const p = tool?.primary?.command ? tool.primary.command : "";
  const lang = tool?.primary?.lang || "bash";

  const fence = p ? "```" + lang + "\n" + p + "\n```\n" : "";

  const exp = norm(tool?.explanation) || "â€”";
  const warns = Array.isArray(tool?.warnings) && tool.warnings.length ? tool.warnings : ["Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ù†ÛŒØ§Ø² Ø´Ù…Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø§Ø³Øª."];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives.slice(0,3) : [];

  const warnMd = warns.map(w => `- ${norm(w)}`).join("\n");
  const altMd = alts.map(a => {
    const note = norm(a?.note) || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = norm(a?.command);
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `${fence}
## ØªÙˆØ¶ÛŒØ­
${exp}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${warnMd}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
${altMd}
`.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType }) {
  const OT = String(outputType || "markdown").toLowerCase();
  const CLI = String(cli || "bash");
  const OS = String(os || "linux").toLowerCase();
  const lang = fenceLangFromCli(CLI, OT);

  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const primaryFromBlock = normalizeCodeToCommands(codeRaw);

  // intent + template fallback
  const intent = detectIntentFa(userRequest);

  let tpl = null;
  if (OS.includes("win") || lang === "cmd" || String(CLI).toLowerCase().includes("cmd")) {
    tpl = windowsTemplates(intent || "restart");
  } else {
    tpl = linuxTemplates(intent || "restart");
  }

  // choose primary: prefer extracted command if it looks valid and OS-consistent
  let primary = primaryFromBlock || tpl.primary;

  // very basic OS consistency guard for alternatives:
  const isWin = (OS.includes("win") || lang === "cmd");
  if (isWin) {
    // if extracted command contains sudo/systemctl, it's wrong for cmd -> use template
    if (/sudo|systemctl|shutdown\s+-/i.test(primary)) primary = tpl.primary;
  } else {
    // linux: if extracted contains windows-style /s /t, it's wrong -> use template
    if (/shutdown\s+\/[srat]\b/i.test(primary) || /\bnet\s+user\b/i.test(primary)) primary = tpl.primary;
  }

  // explanation: keep model text if it exists, otherwise template. Keep beginner a bit more instructive.
  let explanation = norm(rest);
  if (!explanation) explanation = tpl.explanation;

  if (String(knowledgeLevel || "").toLowerCase().includes("begin")) {
    // add minimal steps, but keep short
    if (isWin) explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: CMD Ø±Ø§ Ø¨Ø§ Win+R â†’ cmd Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
    else explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
  } else {
    // keep concise for intermediate/pro
    explanation = explanation.split("\n").slice(0, 6).join("\n").trim() || tpl.explanation;
  }

  const tool = {
    primary: { command: primary, lang },
    explanation,
    warnings: tpl.warnings,
    alternatives: tpl.alternatives.map(a => ({ command: a.command, note: a.note })),
  };

  const markdown = buildMarkdown(tool);

  // For pure command/script output types, return only copy-ready primary fence (but still attach tool)
  const onlyFence = "```" + lang + "\n" + primary + "\n```" + "\n";

  return {
    tool,
    markdown: (OT === "command" || OT === "script") ? onlyFence : markdown,
  };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/fix_backend_frontend_20260103_091446/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/mainpage_chat_hybrid_v1/20260102_095356/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/final_stable_contract/20260106_082556/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/final_stable_contract/20260106_082556/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract (Generator)
// Ù‡Ø¯Ù: Ø®Ø±ÙˆØ¬ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±ØŒ ØºÛŒØ±Ú†ØªÛŒØŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´/Ú©Ù¾ÛŒ Ø¨Ø§Ø´Ø¯.
//
// Contract (tool):
// {
//   primary: { command: string, lang: string },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command: string, note: string }, ...] // exactly 3
// }
//
// Also provides markdown in the same order:
// 1) Primary command (ONE fenced block) - only command lines
// 2) ## ØªÙˆØ¶ÛŒØ­
// 3) ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
// 4) ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (3 items, each: note + its own fenced block)
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // Basic "starts with command" heuristic
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean);

  const cmds = [];
  for (const l of lines) {
    // drop obvious prose inside code block
    if (!looksLikeCommand(l)) continue;
    cmds.push(l);
  }
  return cmds.join("\n").trim();
}

function isWindowsCtx(os, cli) {
  const o = String(os || "").toLowerCase();
  const c = String(cli || "").toLowerCase();
  return o.includes("win") || c === "cmd" || c.includes("powershell");
}

function isLinuxCtx(os) {
  const o = String(os || "").toLowerCase();
  return o.includes("linux") || o.includes("ubuntu") || o.includes("debian") || o.includes("centos") || o.includes("rhel");
}

function defaultByCtx({ os, cli, userRequest }) {
  const ur = String(userRequest || "").toLowerCase();
  const win = isWindowsCtx(os, cli);
  const lin = isLinuxCtx(os);

  // Minimal deterministic defaults if model output is messy
  if (win) {
    if (ur.includes("Ø®Ø§Ù…ÙˆØ´") || ur.includes("shutdown")) {
      return {
        primary: "shutdown /s /t 60",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† ÙˆÛŒÙ†Ø¯ÙˆØ² Ø§Ø² Ø·Ø±ÛŒÙ‚ CMD Ø¨Ø§ ØªØ§Ø®ÛŒØ± Û¶Û° Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
          "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø² Ø¯Ø³ØªÙˆØ± shutdown /a Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³/Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³ØªØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ/Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
          { command: "shutdown /s /t 300", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±" },
          { command: "shutdown /s /f /t 60", note: "Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ Ø¨Ø³ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" },
        ],
      };
    }
    if (ur.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || ur.includes("restart") || ur.includes("reboot")) {
      return {
        primary: "shutdown /r /t 0",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ø±Ø¯Ù† ÙˆÛŒÙ†Ø¯ÙˆØ² Ø§Ø² Ø·Ø±ÛŒÙ‚ CMD Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø§Ø³ØªØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø±Ø´ Ù‚Ø·Ø¹ Ø´ÙˆØ¯.",
          "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ shutdown /a Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯."
        ],
        alternatives: [
          { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ±" },
          { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª/Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
          { command: "shutdown /r /f /t 0", note: "Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ Ø¨Ø³ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" },
        ],
      };
    }
  }

  if (lin) {
    if (ur.includes("Ø®Ø§Ù…ÙˆØ´") || ur.includes("shutdown") || ur.includes("poweroff")) {
      return {
        primary: "sudo shutdown -h +1",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ± Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
          "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
          { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" },
          { command: "sudo systemctl poweroff", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± systemd" },
        ],
      };
    }
    if (ur.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || ur.includes("restart") || ur.includes("reboot")) {
      return {
        primary: "sudo reboot",
        explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",
          "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± systemd" },
          { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
          { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±" },
        ],
      };
    }
  }

  return null;
}

function ensure3Alternatives(alts, ctxDefaults) {
  const safe = Array.isArray(alts) ? alts.filter(a => a && a.command) : [];
  const out = safe.slice(0, 3).map(a => ({
    command: String(a.command).trim(),
    note: String(a.note || "").trim() || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†",
  }));

  while (out.length < 3) {
    if (ctxDefaults?.alternatives?.[out.length]) out.push(ctxDefaults.alternatives[out.length]);
    else out.push({ command: "", note: "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });
  }
  return out;
}

function knowledgeAdjust(text, level) {
  const k = String(level || "").toLowerCase();
  if (k.includes("Ø­Ø±ÙÙ‡") || k.includes("expert") || k.includes("pro")) {
    // concise
    return String(text || "").trim().split("\n").slice(0, 4).join("\n").trim();
  }
  if (k.includes("Ù…ØªÙˆØ³Ø·") || k.includes("inter")) {
    return String(text || "").trim();
  }
  // beginner: slightly more explicit (but still not chatty)
  return String(text || "").trim();
}

function toMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const primary = String(tool?.primary?.command || "").trim();

  const exp = String(tool?.explanation || "").trim() || "â€”";
  const warns = Array.isArray(tool?.warnings) && tool.warnings.length ? tool.warnings : ["Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… backup Ø¨Ú¯ÛŒØ±ÛŒØ¯."];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives.slice(0, 3) : [];

  let md = "";
  md += "```" + lang + "\n" + primary + "\n```\n\n";
  md += "## ØªÙˆØ¶ÛŒØ­\n" + exp + "\n\n";
  md += "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n" + warns.map(w => "- " + String(w).trim()).join("\n") + "\n\n";
  md += "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n";
  for (const a of alts) {
    const note = String(a.note || "").trim() || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = String(a.command || "").trim();
    md += "- " + note + "\n\n```" + lang + "\n" + cmd + "\n```\n\n";
  }
  return md.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType } = {}) {
  const ur = String(userRequest || "").trim();
  if (!ur || ur.length < 4) {
    const msg = "Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ§Ø¶Ø­ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨ÛŒØ§Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø­Ø§Ù„Øª Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ (Chat Mode) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.";
    return { tool: null, markdown: msg, error: "NEED_MORE_DETAILS" };
  }

  const lang = fenceLangFromCli(cli, outputType);
  const { codeRaw, rest } = splitFirstCodeBlock(rawText || "");
  const codeCmds = normalizeCodeToCommands(codeRaw);

  const ctxDefaults = defaultByCtx({ os, cli, userRequest: ur });

  // Primary: prefer extracted command, else ctx default
  let primaryCmd = codeCmds || (ctxDefaults?.primary || "");
  // Hard OS lock
  const win = isWindowsCtx(os, cli);
  const lin = isLinuxCtx(os);

  if (win && /(sudo|systemctl|apt|yum|dnf)\b/i.test(primaryCmd)) primaryCmd = (ctxDefaults?.primary || "shutdown /r /t 0");
  if (lin && /(shutdown\s+\/(s|r)|net\s+user)\b/i.test(primaryCmd)) primaryCmd = (ctxDefaults?.primary || "sudo reboot");

  // Explanation: from rest if exists, else ctx default
  let explanation = (String(rest || "").trim() || ctxDefaults?.explanation || "").trim();
  explanation = knowledgeAdjust(explanation, knowledgeLevel) || "â€”";

  // Warnings: if model didn't provide, use ctx default warnings
  let warnings = (ctxDefaults?.warnings || [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…ÙˆØ§Ø±Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
    "Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    "Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
  ]).slice(0, 3);

  // Alternatives: prefer ctx defaults (stable) unless model produced same-OS commands (we don't parse from rest here on purpose)
  let alternatives = ensure3Alternatives(ctxDefaults?.alternatives || [], ctxDefaults);

  const tool = {
    primary: { command: primaryCmd.trim(), lang },
    explanation,
    warnings,
    alternatives,
  };

  const markdown = toMarkdown(tool);

  // outputType=command/script should return ONLY primary code fence (copy-ready)
  const ot = String(outputType || "").toLowerCase();
  if (ot === "command" || ot === "script") {
    const only = "```" + lang + "\n" + tool.primary.command + "\n```";
    return { tool, markdown: only };
  }

  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/tool_contract_v1/20260103_055028/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/final_tool_layout/20260103_053551/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/tool_contract_stable/20260103_090201/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/lock_generate_contract/20260106_074819/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/lock_generate_contract/20260106_074819/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Locked Tool Contract normalizer for Generator
// Guarantees (for outputType: markdown/tool):
// 1) Primary command FIRST as ONE fenced block (ONLY command-like lines)
// 2) Then: ## ØªÙˆØ¶ÛŒØ­ / ## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / ## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (always present, always meaningful)
// 3) Alternatives: always 3, OS/CLI-consistent
//
// Backward-compatible exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function norm(s) { return String(s ?? "").trim(); }

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = norm(text);
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = norm(m[1] ?? "");
  const rest = norm(t.replace(m[0], ""));
  return { codeRaw, rest };
}

function looksLikeCommandLine(line) {
  const s = norm(line);
  if (!s) return false;
  if (s.length > 220) return false;
  // reject prose endings
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // allow typical command patterns
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s) || /^shutdown(\s+|$)/i.test(s);
}

function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "").split(/\r?\n/);
  const cmds = [];
  for (const ln of lines) {
    const s = norm(ln);
    if (!s) continue;
    if (looksLikeCommandLine(s)) cmds.push(s);
  }
  // keep unique, preserve order
  const seen = new Set();
  const out = [];
  for (const c of cmds) {
    const k = c.toLowerCase();
    if (!seen.has(k)) { seen.add(k); out.push(c); }
  }
  return out.join("\n").trim();
}

function detectIntentFa(userRequest) {
  const u = norm(userRequest);
  if (!u) return "";
  if (u.includes("Ø®Ø§Ù…ÙˆØ´") || u.includes("shutdown") || u.includes("turn off")) return "shutdown";
  if (u.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || u.includes("reboot") || u.includes("restart")) return "restart";
  return "";
}

function windowsTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "shutdown /s /t 60",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø¯Ø± CMD Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ Ø­Ø³Ø§Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª (Ø¢Ù¾Ø¯ÛŒØª/Ø¨Ú©Ø§Ù¾)ØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø±Ø§ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù†ÛŒØ¯.",
        "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø­ØªÙ…Ø§Ù‹ Ø¯Ø³ØªÙˆØ± Ù„ØºÙˆ Ø±Ø§ Ø¨Ø¯Ø§Ù†ÛŒØ¯."
      ],
      alternatives: [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "shutdown /s /t 300", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
      ],
    };
  }
  // restart
  return {
    primary: "shutdown /r /t 0",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ… ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¯Ø± CMDØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³/ProductionØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯."
    ],
    alternatives: [
      { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
      { command: "shutdown /a", note: "Ù„ØºÙˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
      { command: "shutdown /r /f /t 0", note: "Ø±ÛŒØ³ØªØ§Ø±Øª + Ø¨Ø³ØªÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)" }
    ],
  };
}

function linuxTemplates(intent) {
  if (intent === "shutdown") {
    return {
      primary: "sudo shutdown -h +1",
      explanation: "Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±ØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
        "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "sudo shutdown -h now", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ" },
        { command: "sudo shutdown -c", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡" },
        { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }
      ],
    };
  }
  return {
    primary: "sudo reboot",
    explanation: "Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ÛŒØŒ Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.",
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
    ],
    alternatives: [
      { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ systemd" },
      { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
      { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" }
    ],
  };
}

function buildMarkdown(tool) {
  const p = tool?.primary?.command ? tool.primary.command : "";
  const lang = tool?.primary?.lang || "bash";

  const fence = p ? "```" + lang + "\n" + p + "\n```\n" : "";

  const exp = norm(tool?.explanation) || "â€”";
  const warns = Array.isArray(tool?.warnings) && tool.warnings.length ? tool.warnings : ["Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ù†ÛŒØ§Ø² Ø´Ù…Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø§Ø³Øª."];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives.slice(0,3) : [];

  const warnMd = warns.map(w => `- ${norm(w)}`).join("\n");
  const altMd = alts.map(a => {
    const note = norm(a?.note) || "Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
    const cmd = norm(a?.command);
    return `- ${note}\n\n\`\`\`${lang}\n${cmd}\n\`\`\``;
  }).join("\n\n");

  return `${fence}
## ØªÙˆØ¶ÛŒØ­
${exp}

## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
${warnMd}

## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§
${altMd}
`.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType }) {
  const OT = String(outputType || "markdown").toLowerCase();
  const CLI = String(cli || "bash");
  const OS = String(os || "linux").toLowerCase();
  const lang = fenceLangFromCli(CLI, OT);

  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const primaryFromBlock = normalizeCodeToCommands(codeRaw);

  // intent + template fallback
  const intent = detectIntentFa(userRequest);

  let tpl = null;
  if (OS.includes("win") || lang === "cmd" || String(CLI).toLowerCase().includes("cmd")) {
    tpl = windowsTemplates(intent || "restart");
  } else {
    tpl = linuxTemplates(intent || "restart");
  }

  // choose primary: prefer extracted command if it looks valid and OS-consistent
  let primary = primaryFromBlock || tpl.primary;

  // very basic OS consistency guard for alternatives:
  const isWin = (OS.includes("win") || lang === "cmd");
  if (isWin) {
    // if extracted command contains sudo/systemctl, it's wrong for cmd -> use template
    if (/sudo|systemctl|shutdown\s+-/i.test(primary)) primary = tpl.primary;
  } else {
    // linux: if extracted contains windows-style /s /t, it's wrong -> use template
    if (/shutdown\s+\/[srat]\b/i.test(primary) || /\bnet\s+user\b/i.test(primary)) primary = tpl.primary;
  }

  // explanation: keep model text if it exists, otherwise template. Keep beginner a bit more instructive.
  let explanation = norm(rest);
  if (!explanation) explanation = tpl.explanation;

  if (String(knowledgeLevel || "").toLowerCase().includes("begin")) {
    // add minimal steps, but keep short
    if (isWin) explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: CMD Ø±Ø§ Ø¨Ø§ Win+R â†’ cmd Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
    else explanation += "\n\n(Ø±Ø§Ù‡Ù†Ù…Ø§: ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.)";
  } else {
    // keep concise for intermediate/pro
    explanation = explanation.split("\n").slice(0, 6).join("\n").trim() || tpl.explanation;
  }

  const tool = {
    primary: { command: primary, lang },
    explanation,
    warnings: tpl.warnings,
    alternatives: tpl.alternatives.map(a => ({ command: a.command, note: a.note })),
  };

  const markdown = buildMarkdown(tool);

  // For pure command/script output types, return only copy-ready primary fence (but still attach tool)
  const onlyFence = "```" + lang + "\n" + primary + "\n```" + "\n";

  return {
    tool,
    markdown: (OT === "command" || OT === "script") ? onlyFence : markdown,
  };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/mainpage_finish_v2/20260102_134820/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); // restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/day1_freeze_generator_20260106_072441/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/day1_freeze_generator_20260106_072441/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool Contract (LOCKED)
//
// Generator must ALWAYS end in a stable template:
// 1) Primary command -> ONE fenced block (ONLY command lines)
// 2) Explanation      -> short, correct, level-aware
// 3) Warnings         -> real, relevant
// 4) Alternatives     -> exactly 3, OS/CLI-aware, unique
//
// API returns:
// tool: {
//   primary: { command, lang },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command, note, lang? }, ...]
// }
// markdown: string (rendered from tool)
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function lc(x) { return String(x ?? "").toLowerCase().trim(); }

function fenceLangFromCli(cli = "bash", os = "") {
  const c = lc(cli);
  const o = lc(os);
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  if (o.includes("windows")) return (c.includes("power") ? "powershell" : "cmd");
  return "bash";
}

function stripCodeFences(s) {
  return String(s ?? "")
    .replace(/```[\s\S]*?```/g, " ")
    .replace(/`+/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[\u0600-\u06FF]/.test(s)) return false;          // reject Persian inside command
  if (/[.ØŒØ›!?]$/.test(s)) return false;                 // reject prose endings
  if (/^(note|hint|warning|explanation)\b/i.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._/-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw, { os, cli }) {
  const o = lc(os);
  const c = lc(cli);

  const lines = String(codeRaw || "")
    .split("\n")
    .map(x => x.trim())
    .filter(Boolean);

  const cmdLines = lines.filter(looksLikeCommand);

  // If no code fence or it was messy, try best-effort pick from full text
  let primary = cmdLines[0] || "";

  // Windows shutdown normalization (avoid -s -t style)
  if (o.includes("windows") && (c.includes("cmd") || c.includes("power"))) {
    primary = primary
      .replace(/\bshutdown\s+-s\b/i, "shutdown /s")
      .replace(/\bshutdown\s+-r\b/i, "shutdown /r")
      .replace(/\s+-t\s+/i, " /t ");
    // if uses "/t" missing slash
    primary = primary.replace(/\bshutdown\s+\/s\s+\/t\s+(\d+)/i, "shutdown /s /t $1");
  }

  // Keep only the first command line as primary (single-line)
  primary = primary.split(/\s*&&\s*|\s*;\s*/)[0].trim();

  return { primary, all: cmdLines };
}

function classifyIntent({ userRequest, primaryCommand, os }) {
  const ur = lc(userRequest);
  const pc = lc(primaryCommand);
  const o  = lc(os);

  if (o.includes("windows") || ur.includes("ÙˆÛŒÙ†Ø¯ÙˆØ²")) {
    if (pc.includes("shutdown") && (pc.includes("/s") || pc.includes("-s") || ur.includes("Ø®Ø§Ù…ÙˆØ´"))) return "shutdown";
    if (pc.includes("shutdown") && (pc.includes("/r") || pc.includes("-r") || ur.includes("Ø±ÛŒØ³ØªØ§Ø±Øª"))) return "reboot";
  }

  if (pc.includes("reboot") || pc.includes("systemctl reboot") || pc.includes("shutdown -r")) return "reboot";
  if (pc.includes("shutdown") && (pc.includes("-h") || pc.includes("poweroff") || ur.includes("Ø®Ø§Ù…ÙˆØ´"))) return "shutdown";

  if (ur.includes("Ú©Ø§Ø±Ø¨Ø±") && (ur.includes("Ú†Ù†Ø¯") || ur.includes("Ù„ÛŒØ³Øª")) ) return "list_users";

  return "generic";
}

function levelMode(knowledgeLevel) {
  const k = lc(knowledgeLevel);
  if (k.includes("Ù…Ø¨ØªØ¯ÛŒ") || k.includes("begin")) return "beginner";
  if (k.includes("Ù…ØªÙˆØ³Ø·") || k.includes("inter")) return "intermediate";
  if (k.includes("Ø­Ø±ÙÙ‡") || k.includes("expert") || k.includes("pro")) return "expert";
  return "intermediate";
}

// Curated safe templates for high-impact intents
function templateFor({ intent, os, cli, userRequest }) {
  const o = lc(os);
  const c = lc(cli);

  const isWin = o.includes("windows") || c.includes("cmd") || c.includes("powershell");
  const isCmd = c.includes("cmd");
  const isPs  = c.includes("powershell") || c === "pwsh";

  if (intent === "shutdown" && isWin) {
    // try to detect delay in seconds from request (Persian digits too)
    let sec = 60;
    const m = String(userRequest||"").match(/(\d+)\s*Ø¯Ù‚ÛŒÙ‚Ù‡/);
    if (m) sec = Math.max(5, parseInt(m[1],10) * 60);
    const cmd = `shutdown /s /t ${sec}`;
    return {
      primary: cmd,
      explanation_beginner: `Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙˆÛŒÙ†Ø¯ÙˆØ² Ø±Ø§ Ø¨Ø¹Ø¯ Ø§Ø² ${sec} Ø«Ø§Ù†ÛŒÙ‡ Ø®Ø§Ù…ÙˆØ´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.`,
      explanation_intermediate: `Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø³ÛŒØ³ØªÙ… Ø¨Ø§ ØªØ§Ø®ÛŒØ± ${sec}s.`,
      explanation_expert: `Shutdown with delay (${sec}s).`,
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø±/Ø³Ø±ÙˆÛŒØ³ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø± Ø§Ø³ØªØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø¹Ø« Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ø¯ÛŒØªØ§ Ø´ÙˆØ¯.",
        "Ø¨Ø±Ø§ÛŒ Ú©Ù†Ø³Ù„ Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒØŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ù„ØºÙˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."
      ],
      alternatives: [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡", lang: "cmd" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ", lang: "cmd" },
        { command: "shutdown /s /f /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ + Ø¨Ø³ØªÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§", lang: "cmd" },
      ],
      lang: isCmd ? "cmd" : (isPs ? "powershell" : "cmd"),
    };
  }

  if (intent === "reboot" && isWin) {
    const cmd = "shutdown /r /t 0";
    return {
      primary: cmd,
      explanation_beginner: "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙˆÛŒÙ†Ø¯ÙˆØ² Ø±Ø§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.",
      explanation_intermediate: "Restart ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ… Ø¨Ø§ shutdown.exe.",
      explanation_expert: "Immediate reboot.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø§Ø³ØªØŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ session Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†Ø¯.",
        "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ±", lang: "cmd" },
        { command: "shutdown /g /t 0", note: "Restart + restart registered apps (Windows)", lang: "cmd" },
        { command: "powershell -Command \"Restart-Computer -Force\"", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ø² Ø·Ø±ÛŒÙ‚ PowerShell", lang: "cmd" },
      ],
      lang: isCmd ? "cmd" : (isPs ? "powershell" : "cmd"),
    };
  }

  if ((intent === "shutdown" || intent === "reboot") && !isWin) {
    if (intent === "shutdown") {
      return {
        primary: "sudo shutdown -h now",
        explanation_beginner: "Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.",
        explanation_intermediate: "Shutdown ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ….",
        explanation_expert: "Immediate shutdown.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
          "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª maintenance window Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯."
        ],
        alternatives: [
          { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ", lang: "bash" },
          { command: "sudo shutdown -h +1", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±", lang: "bash" },
          { command: "sudo systemctl poweroff", note: "Ø±ÙˆØ´ systemd", lang: "bash" },
        ],
        lang: "bash",
      };
    } else {
      return {
        primary: "sudo reboot",
        explanation_beginner: "Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.",
        explanation_intermediate: "Reboot ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ….",
        explanation_expert: "Immediate reboot.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
          "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± systemd", lang: "bash" },
          { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ", lang: "bash" },
          { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±", lang: "bash" },
        ],
        lang: "bash",
      };
    }
  }

  if (intent === "list_users" && isWin) {
    return {
      primary: "net user",
      explanation_beginner: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Local Ø±ÙˆÛŒ ÙˆÛŒÙ†Ø¯ÙˆØ² Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.",
      explanation_intermediate: "Ù†Ù…Ø§ÛŒØ´ Local users Ø¨Ø§ net.exe.",
      explanation_expert: "List local users.",
      warnings: [
        "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Local Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ (Ù†Ù‡ Ù„Ø²ÙˆÙ…Ø§Ù‹ Domain).",
        "Ø§Ú¯Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Domain Ù‡Ø³ØªÛŒØ¯ØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø§Ø² Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ AD Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        "Ø®Ø±ÙˆØ¬ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø³ØªÙ‡ Ø¨Ù‡ policy Ø³Ø§Ø²Ù…Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯ Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "wmic useraccount get name,sid", note: "Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… + SID", lang: "cmd" },
        { command: "powershell -Command \"Get-LocalUser | Select Name,Enabled\"", note: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ PowerShell", lang: "cmd" },
        { command: "net localgroup administrators", note: "Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¶Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ Administrators", lang: "cmd" },
      ],
      lang: "cmd",
    };
  }

  return null;
}

function uniqAlternatives(alts) {
  const seen = new Set();
  const out = [];
  for (const a of alts || []) {
    const key = lc(a?.command);
    if (!key || seen.has(key)) continue;
    seen.add(key);
    out.push(a);
  }
  return out;
}

function renderMarkdown(tool) {
  const p = tool.primary;
  const warn = (tool.warnings || []).filter(Boolean);
  const alts = (tool.alternatives || []).filter(Boolean);

  let md = "";
  md += "```" + (p.lang || "bash") + "\n" + p.command.trim() + "\n```\n\n";
  md += "## ØªÙˆØ¶ÛŒØ­\n" + (tool.explanation || "â€”") + "\n\n";

  md += "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n";
  if (warn.length === 0) md += "- Ø§Ø­ØªÛŒØ§Ø· Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.\n\n";
  else md += warn.map(x => `- ${x}`).join("\n") + "\n\n";

  md += "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n";
  if (alts.length === 0) {
    md += "- â€”\n";
    return md.trim() + "\n";
  }

  for (const a of alts.slice(0,3)) {
    md += `- ${a.note || "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†"}\n\n`;
    md += "```" + (a.lang || p.lang || "bash") + "\n" + String(a.command||"").trim() + "\n```\n\n";
  }
  return md.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType } = {}) {
  const ot = lc(outputType || "markdown");

  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const { primary } = normalizeCodeToCommands(codeRaw || "", { os, cli });

  const intent = classifyIntent({ userRequest, primaryCommand: primary, os });
  const lvl = levelMode(knowledgeLevel);

  const lang = fenceLangFromCli(cli, os);

  // Use curated template for known intents (shutdown/reboot/list_users)
  let tpl = templateFor({ intent, os, cli, userRequest });

  // If template exists but primary from model differs, trust template (safety + correctness)
  if (tpl) {
    const explanation =
      (lvl === "beginner" ? tpl.explanation_beginner :
       lvl === "expert"   ? tpl.explanation_expert :
                            tpl.explanation_intermediate);

    const tool = {
      primary: { command: tpl.primary, lang: tpl.lang || lang },
      explanation,
      warnings: (tpl.warnings || []).slice(0, 5),
      alternatives: uniqAlternatives(tpl.alternatives || []).slice(0,3),
    };

    const markdown = renderMarkdown(tool);

    if (ot === "command" || ot === "script") {
      return { tool, markdown: "```" + (tool.primary.lang||"bash") + "\n" + tool.primary.command + "\n```" };
    }
    return { tool, markdown };
  }

  // Generic fallback: keep primary if exists, fill rest minimally and safely
  const safePrimary = primary || "";
  const explanationRaw = stripCodeFences(rest);
  const explanation = explanationRaw
    ? explanationRaw.slice(0, 420)
    : "Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯. Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø±ÙˆÛŒ Ú†Ù‡ Ù…Ø­ÛŒØ·ÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.";

  const tool = {
    primary: { command: safePrimary || "(command not detected)", lang },
    explanation,
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ú¯Ø± Production Ø§Ø³Øª Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      "Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Admin/sudo Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø§ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§ Ø¯Ø§Ø±ÛŒØ¯.",
    ],
    alternatives: uniqAlternatives([
      { command: safePrimary, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒâ€ŒØ´Ø¯Ù‡)", lang },
      { command: safePrimary, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (fallback)", lang },
      { command: safePrimary, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (fallback)", lang },
    ]).slice(0,3),
  };

  const markdown = renderMarkdown(tool);

  if (ot === "command" || ot === "script") {
    return { tool, markdown: "```" + (lang||"bash") + "\n" + tool.primary.command + "\n```" };
  }
  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/HARD_LOCK_CONTRACT_20260106_064240/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/HARD_LOCK_CONTRACT_20260106_064240/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool Contract (LOCKED)
// Produces:
//   tool: { primary{command,lang}, explanation, warnings[], alternatives[{command,note}*3] }
//   markdown: string (stable template)
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 200) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizePrimaryCommand(rawText) {
  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const fromFence = (codeRaw || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromFence.length) return { command: fromFence.join("\n"), rest };

  const fromText = String(rawText || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromText.length) return { command: fromText[0], rest };
  return { command: "", rest };
}

function ensure3Alts(alts, fallbackCmd, os, cli) {
  const out = Array.isArray(alts) ? alts.filter(Boolean) : [];
  while (out.length < 3) {
    out.push({ command: fallbackCmd || "", note: "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });
  }
  return out.slice(0, 3);
}

function defaultWarnings(os, cli, userRequest) {
  const o = String(os || "").toLowerCase();
  const c = String(cli || "").toLowerCase();
  const req = String(userRequest || "").toLowerCase();
  const w = [];
  w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…ÙˆØ§Ø±Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
  if (req.includes("shutdown") || req.includes("Ø®Ø§Ù…ÙˆØ´") || req.includes("reboot") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª")) {
    w.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH/Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.");
    w.push("Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.");
  } else {
    w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ ProductionØŒ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
    w.push("Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Admin/sudo Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.");
  }
  if (o === "network" || req.includes("cisco") || req.includes("mikrotik") || req.includes("forti")) {
    w.unshift("Ø±ÙˆÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø´Ø¨Ú©Ù‡ØŒ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² config Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯ Ùˆ Ø²Ù…Ø§Ù† maintenance Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.");
  }
  if (c.includes("cmd")) {
    // ÙˆÛŒÙ†Ø¯ÙˆØ² Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ sudo Ù†Ø¯Ø§Ø±Ø¯
    // keep generic warning
  }
  return w.slice(0, 3);
}

// Try parse JSON tool payload if model returned it
function tryParseJsonTool(text) {
  const t = String(text || "").trim();
  if (!t.startsWith("{")) return null;
  try {
    const obj = JSON.parse(t);
    return obj && typeof obj === "object" ? obj : null;
  } catch {
    return null;
  }
}

function renderMarkdown(tool) {
  const p = tool?.primary || {};
  const primaryFence = `\`\`\`${p.lang || "bash"}\n${p.command || ""}\n\`\`\``;

  const expl = tool?.explanation ? String(tool.explanation).trim() : "";
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warnings.length ? warnings.map((x) => `- ${x}`).join("\n") : "- (Ù†Ø¯Ø§Ø±Ø¯)";
  const altBlocks = alts
    .slice(0, 3)
    .map((a) => {
      const note = String(a?.note || "").trim() || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
      const cmd = String(a?.command || "").trim();
      return `- ${note}\n\n\`\`\`${p.lang || "bash"}\n${cmd}\n\`\`\``;
    })
    .join("\n\n");

  return `${primaryFence}\n\n## ØªÙˆØ¶ÛŒØ­\n${expl || "(ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª)"}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks || "- (Ù†Ø¯Ø§Ø±Ø¯)"}`;
}

export function formatToolResponse({
  text,
  cli = "bash",
  os = "linux",
  userRequest = "",
  outputType = "command", // command|python
  lang = "fa",
  knowledgeLevel = "beginner",
} = {}) {
  const cliLang = fenceLangFromCli(cli, outputType);

  // (A) If model returned strict JSON, trust it (but normalize)
  const parsed = tryParseJsonTool(text);
  if (parsed?.primary?.command) {
    const tool = {
      primary: { command: String(parsed.primary.command).trim(), lang: parsed.primary.lang || cliLang },
      explanation: String(parsed.explanation || "").trim(),
      warnings: Array.isArray(parsed.warnings) ? parsed.warnings.map(String) : [],
      alternatives: Array.isArray(parsed.alternatives) ? parsed.alternatives : [],
    };
    tool.warnings = tool.warnings.filter(Boolean).slice(0, 5);
    tool.alternatives = ensure3Alts(tool.alternatives, tool.primary.command, os, cli);
    const markdown = renderMarkdown(tool);
    return { tool, markdown };
  }

  // (B) Otherwise parse from markdown-ish text
  const { command, rest } = normalizePrimaryCommand(text);
  const warnings = defaultWarnings(os, cli, userRequest);

  // Simple explanation extraction: first non-empty prose chunk from rest
  const expl = String(rest || "").split("\n").map((x) => x.trim()).filter(Boolean).slice(0, 6).join("\n");
  const tool = {
    primary: { command: command || "", lang: cliLang },
    explanation: expl || (lang === "fa" ? "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯." : "This command performs the primary action for your request."),
    warnings,
    alternatives: ensure3Alts([], command, os, cli),
  };

  // If no primary command, keep template but empty command
  const markdown = renderMarkdown(tool);
  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/.ccg_backups/day1_contract_lock/20260106_061449/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/remove_knowledgeLevel_v2/20260106_101318/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Stable tool contract handling for "generate".
// - Extract JSON object from model output
// - Validate OS/CLI consistency (basic guardrails)
// - Always return { tool, markdown }

function safeJsonParse(s) { try { return JSON.parse(s); } catch { return null; } }

function extractFirstJsonObject(raw) {
  const t = String(raw ?? "").trim();
  // Find first '{' ... matching '}' (simple stack)
  const start = t.indexOf("{");
  if (start < 0) return null;
  let depth = 0;
  for (let i = start; i < t.length; i++) {
    const ch = t[i];
    if (ch === "{") depth++;
    else if (ch === "}") {
      depth--;
      if (depth === 0) {
        const slice = t.slice(start, i + 1);
        const obj = safeJsonParse(slice);
        if (obj) return obj;
      }
    }
  }
  return null;
}

function fenceLangFromCli(cli = "bash", outputType = "markdown") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function normalizeTool(tool, { os, cli, undefined } = {}) {
  const lang = fenceLangFromCli(cli, "markdown");
  const t = tool && typeof tool === "object" ? tool : {};

  const primaryCmd = String(t?.primary?.command ?? "").trim();
  const explanation = String(t?.explanation ?? "").trim();
  const warnings = Array.isArray(t?.warnings) ? t.warnings.map(x => String(x).trim()).filter(Boolean) : [];
  const alternatives = Array.isArray(t?.alternatives) ? t.alternatives : [];

  // Ensure arrays length
  while (warnings.length < 3) warnings.push("Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Backup Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
  warnings.length = 3;

  const alts = alternatives
    .map(a => ({
      command: String(a?.command ?? "").trim(),
      note: String(a?.note ?? "").trim(),
    }))
    .filter(a => a.command);

  // Ensure exactly 3 alternatives (fill safe minimal related)
  while (alts.length < 3) alts.push({ command: "", note: "" });
  alts.length = 3;

  // Basic OS/CLI guard: if windows selected, reject obvious linux commands and vice versa
  const osL = String(os || "").toLowerCase();
  const cliL = String(cli || "").toLowerCase();
  const looksLinux = (s) => /\b(sudo|systemctl|journalctl|apt|yum|dnf|shutdown\s+-)/i.test(s);
  const looksWindows = (s) => /\b(shutdown\s+\/|net\s+user|ipconfig|powershell|Get-)/i.test(s);

  const mismatch =
    (osL.includes("win") && looksLinux(primaryCmd)) ||
    ((osL.includes("linux") || osL.includes("mac")) && looksWindows(primaryCmd));

  if (mismatch || !primaryCmd) {
    return {
      primary: { command: "", lang },
      explanation: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¨Ù‡Ù…/Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ Ø¨Ø§ OS/CLI Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø­Ø§Ù„Øª Chat Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
      warnings: [
        "Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…Ø·Ù…Ø¦Ù† Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.",
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø³ÛŒØ³ØªÙ…ÛŒØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡/Backup Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ø§ÛŒÙ† Ú©Ø§Ø± Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±/Production Ø§Ø³ØªØŒ Ø­ØªÙ…Ø§Ù‹ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      ],
      alternatives: [
        { command: "", note: "Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´ÙˆØ¯." },
        { command: "", note: "Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Chat Ù…Ø³ÛŒØ± Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ TroubleShoot Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯." },
        { command: "", note: "OS/CLI ØµØ­ÛŒØ­ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Generate Ø¨Ø²Ù†ÛŒØ¯." },
      ],
    };
  }

  // KnowledgeLevel shaping (only affects explanation a bit if model is vague)
  let exp = explanation;
  if (!exp) {
    if (String(undefined).toLowerCase() === "beginner") exp = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¢Ù† Ø±Ø§ Ø¯Ø± ØªØ±Ù…ÛŒÙ†Ø§Ù„/Ø®Ø· ÙØ±Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.";
    else if (String(undefined).toLowerCase() === "intermediate") exp = "Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø§Ø³Øª.";
    else exp = "Ø¯Ø³ØªÙˆØ± Ù…Ø³ØªÙ‚ÛŒÙ….";
  }

  // Ensure alt notes are short
  for (const a of alts) {
    if (!a.note) a.note = "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø±ØªØ¨Ø·";
    if (a.note.length > 90) a.note = a.note.slice(0, 87) + "...";
  }

  return {
    primary: { command: primaryCmd, lang },
    explanation: exp,
    warnings,
    alternatives: alts,
  };
}

function toolToMarkdown(tool) {
  const lang = tool?.primary?.lang || "bash";
  const cmd = tool?.primary?.command ? tool.primary.command.trim() : "";
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];
  const warn = Array.isArray(tool?.warnings) ? tool.warnings : [];

  const fence = cmd ? "```" + lang + "\n" + cmd + "\n```" : "```" + lang + "\n" + "\n```";

  const lines = [];
  lines.push(fence);
  lines.push("");
  lines.push("## ØªÙˆØ¶ÛŒØ­");
  lines.push(tool?.explanation || "");
  lines.push("");
  lines.push("## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§");
  for (const w of warn) lines.push("- " + w);
  lines.push("");
  lines.push("## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§");
  for (const a of alts) {
    const note = a?.note ? String(a.note) : "";
    const c = a?.command ? String(a.command).trim() : "";
    lines.push("- " + note);
    lines.push("");
    lines.push("```" + lang + "\n" + c + "\n```");
    lines.push("");
  }
  return lines.join("\n").trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, outputType }) {
  const extracted = extractFirstJsonObject(rawText);
  const tool = normalizeTool(extracted, { os, cli, undefined });

  const markdown = toolToMarkdown(tool);

  // For outputType command/script: only show primary copy block (as you wanted)
  const ot = String(outputType || "markdown").toLowerCase();
  if (ot === "command" || ot === "script") {
    const lang = tool?.primary?.lang || fenceLangFromCli(cli, "markdown");
    const cmd = tool?.primary?.command || "";
    return { tool, markdown: "```" + lang + "\n" + cmd + "\n```" };
  }

  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/fix_generator_network_advanced_20260107_170115/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";

const LS_KEY = "ccg_generator_state_v2";
const LS_PRESETS = "ccg_custom_presets_v1";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom)" },
];

const VERBOSITY_OPTIONS = [
  { value: "brief", labelFa: "Ø®Ù„Ø§ØµÙ‡", labelEn: "Brief" },
  { value: "normal", labelFa: "Ù†Ø±Ù…Ø§Ù„", labelEn: "Normal" },
  { value: "detailed", labelFa: "Ø¬Ø²Ø¦ÛŒ", labelEn: "Detailed" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  mac: ["zsh", "bash"],
  windows: ["powershell", "cmd"],
};

const ADV_OS_NAMES = {
  linux: ["Ubuntu", "Debian", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE", "Alpine", "Kali", "Amazon Linux", "Oracle Linux"],
  windows: ["Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022"],
  mac: ["macOS"],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "mikrotik", label: "MikroTik" },
  { value: "fortigate", label: "FortiGate" },
  { value: "juniper", label: "Juniper" },
  { value: "generic", label: "Generic" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: ["ios", "ios-xe", "nx-os"],
  mikrotik: ["routeros"],
  fortigate: ["fortios"],
  juniper: ["junos"],
  generic: ["general"],
};

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}
function isSafeFreeText(v, minLen = 2, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}
function toQS(obj) {
  const p = new URLSearchParams();
  Object.entries(obj).forEach(([k, v]) => {
    if (v === undefined || v === null) return;
    const s = String(v);
    if (!s) return;
    p.set(k, s);
  });
  return p.toString();
}
function fromQS() {
  const p = new URLSearchParams(window.location.search);
  const out = {};
  for (const [k, v] of p.entries()) out[k] = v;
  return out;
}

export default function GeneratorPage() {
  const { lang, t } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [shell, setShell] = useState("bash");
  const [outputType, setOutputType] = useState("tool"); // tool recommended
  const [verbosity, setVerbosity] = useState("normal");

  const [advanced, setAdvanced] = useState(false);

  // contextual advanced OS
  const [advOsName, setAdvOsName] = useState("");
  const [advOsVersion, setAdvOsVersion] = useState("");

  // network
  const [vendor, setVendor] = useState("cisco");
  const [deviceType, setDeviceType] = useState("ios");

  // custom
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("bash");
  const [presetName, setPresetName] = useState("");
  const [presets, setPresets] = useState([]);

  // main
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);

  const [validationErr, setValidationErr] = useState("");
  const [apiErr, setApiErr] = useState("");

  const [markdown, setMarkdown] = useState("");
  const [tool, setTool] = useState(null);

  const isNetwork = platform === "network";
  const isOther = platform === "other";

  const shellOptions = useMemo(() => {
    if (isNetwork) return [];
    if (isOther) return ["bash","zsh","sh","fish","cmd","powershell","pwsh","ksh","tcsh"];
    return SHELL_BY_PLATFORM[platform] || ["bash"];
  }, [platform, isNetwork, isOther]);

  const advOsOptions = useMemo(() => {
    if (!advanced) return [];
    if (platform === "linux") return ADV_OS_NAMES.linux;
    if (platform === "windows") return ADV_OS_NAMES.windows;
    if (platform === "mac") return ADV_OS_NAMES.mac;
    return [];
  }, [advanced, platform]);

  const deviceTypeOptions = useMemo(() => {
    return DEVICE_TYPES_BY_VENDOR[vendor] || ["general"];
  }, [vendor]);

  // Load presets
  useEffect(() => {
    try {
      const arr = JSON.parse(localStorage.getItem(LS_PRESETS) || "[]");
      if (Array.isArray(arr)) setPresets(arr);
    } catch {}
  }, []);

  // Restore state from URL + localStorage
  useEffect(() => {
    const qs = fromQS();
    let st = {};
    try {
      st = JSON.parse(localStorage.getItem(LS_KEY) || "{}") || {};
    } catch {}

    const merged = { ...st, ...qs };

    if (merged.platform) setPlatform(merged.platform);
    if (merged.shell) setShell(merged.shell);
    if (merged.outputType) setOutputType(merged.outputType);
    if (merged.verbosity) setVerbosity(merged.verbosity);

    if (merged.advanced === "1" || merged.advanced === true) setAdvanced(true);

    if (merged.advOsName) setAdvOsName(merged.advOsName);
    if (merged.advOsVersion) setAdvOsVersion(merged.advOsVersion);

    if (merged.vendor) setVendor(merged.vendor);
    if (merged.deviceType) setDeviceType(merged.deviceType);

    if (merged.customOS) setCustomOS(merged.customOS);
    if (merged.customShell) setCustomShell(merged.customShell);

    if (merged.input) setInput(merged.input);
    if (merged.markdown) setMarkdown(merged.markdown);

    if (merged.tool) {
      try { setTool(typeof merged.tool === "string" ? JSON.parse(merged.tool) : merged.tool); } catch {}
    }
  }, []);

  // Keep deviceType valid for vendor
  useEffect(() => {
    const opts = DEVICE_TYPES_BY_VENDOR[vendor] || ["general"];
    if (!opts.includes(deviceType)) setDeviceType(opts[0]);
  }, [vendor]); // eslint-disable-line react-hooks/exhaustive-deps

  // Persist state (URL + localStorage)
  useEffect(() => {
    const st = {
      platform,
      shell,
      outputType,
      verbosity,
      advanced: advanced ? "1" : "",
      advOsName,
      advOsVersion,
      vendor,
      deviceType,
      customOS,
      customShell,
      input,
      markdown,
      tool: tool ? JSON.stringify(tool) : "",
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(st)); } catch {}
    const qs = toQS(st);
    const url = qs ? `${window.location.pathname}?${qs}` : window.location.pathname;
    window.history.replaceState(null, "", url);
  }, [platform, shell, outputType, verbosity, advanced, advOsName, advOsVersion, vendor, deviceType, customOS, customShell, input, markdown, tool]);

  // Reset contextual advanced values when platform changes
  useEffect(() => {
    setValidationErr("");
    setApiErr("");
    if (platform === "linux") {
      if (shellOptions.length && !shellOptions.includes(shell)) setShell("bash");
    } else if (platform === "windows") {
      if (shellOptions.length && !shellOptions.includes(shell)) setShell("powershell");
    } else if (platform === "mac") {
      if (shellOptions.length && !shellOptions.includes(shell)) setShell("zsh");
    } else if (platform === "network") {
      // keep vendor/deviceType visible by default
    } else if (platform === "other") {
      // custom defaults
      if (!customShell) setCustomShell("bash");
    }

    // Advanced must be contextual: clear name/version if platform not supported
    if (platform === "network" || platform === "other") {
      setAdvOsName("");
      setAdvOsVersion("");
    } else {
      // keep but validate list
      const allowed = ADV_OS_NAMES[platform] || [];
      if (advOsName && allowed.length && !allowed.includes(advOsName)) setAdvOsName("");
    }
  }, [platform]); // eslint-disable-line react-hooks/exhaustive-deps

  function validateBeforeSend() {
    setValidationErr("");

    if (!input.trim()) {
      setValidationErr(lang === "fa" ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª." : "Request is empty.");
      return false;
    }

    if (isNetwork) {
      if (!vendor) {
        setValidationErr(lang === "fa" ? "Vendor Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯." : "Select vendor.");
        return false;
      }
      const opts = DEVICE_TYPES_BY_VENDOR[vendor] || [];
      if (!deviceType || (opts.length && !opts.includes(deviceType))) {
        setValidationErr(lang === "fa" ? "Device Type Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid device type.");
        return false;
      }
      return true;
    }

    if (isOther) {
      const osOk = isSafeFreeText(customOS, 2, 40);
      const shOk = isSafeFreeText(customShell, 2, 20);
      if (!osOk) {
        setValidationErr(lang === "fa"
          ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. ÙÙ‚Ø· Ø­Ø±ÙˆÙ/Ø¹Ø¯Ø¯/ÙØ§ØµÙ„Ù‡ Ùˆ . _ + - / Ù…Ø¬Ø§Ø² Ø§Ø³Øª (Û² ØªØ§ Û´Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)."
          : "Invalid Custom OS. Allowed: letters/numbers/space and . _ + - / (2..40)."
        );
        return false;
      }
      if (!shOk) {
        setValidationErr(lang === "fa"
          ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Û² ØªØ§ Û²Û° Ú©Ø§Ø±Ø§Ú©ØªØ±)."
          : "Invalid Custom Shell/CLI (2..20)."
        );
        return false;
      }
      return true;
    }

    // Standard OS families
    if (advanced) {
      const allowed = ADV_OS_NAMES[platform] || [];
      if (advOsName && allowed.length && !allowed.includes(advOsName)) {
        setValidationErr(lang === "fa" ? "Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„ Ø¨Ø§ Ù¾Ù„ØªÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ù‡Ù…Ø®ÙˆØ§Ù†ÛŒ Ù†Ø¯Ø§Ø±Ø¯." : "OS details mismatch.");
        return false;
      }
      if (advOsVersion && !isSafeFreeText(advOsVersion, 1, 20)) {
        setValidationErr(lang === "fa" ? "ÙˆØ±Ú˜Ù†/Ø¨ÛŒÙ„Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid version/build.");
        return false;
      }
    }

    // shell must be valid for platform
    if (shellOptions.length && !shellOptions.includes(shell)) {
      setValidationErr(lang === "fa" ? "Shell/CLI Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù¾Ù„ØªÙØ±Ù… Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª." : "Invalid shell for platform.");
      return false;
    }

    return true;
  }

  function buildPayload(mode = "generate", targetCommand = "") {
    // Custom mode: minimal payload (no extra fields)
    if (isOther) {
      return {
        mode,
        targetCommand: mode === "explain" ? targetCommand : undefined,
        lang,
        outputType,
        verbosity,
        platform: "other",
        os: cleanToken(customOS),
        cli: cleanToken(customShell),
        user_request: input.trim(),
      };
    }

    if (isNetwork) {
      return {
        mode,
        targetCommand: mode === "explain" ? targetCommand : undefined,
        lang,
        outputType,
        verbosity,
        platform: "network",
        os: "network",
        cli: "network",
        vendor,
        deviceType,
        user_request: input.trim(),
      };
    }

    // Standard OS
    let os = platform;
    if (advanced && advOsName) {
      os = advOsVersion ? `${advOsName} ${advOsVersion}` : advOsName;
    }

    return {
      mode,
      targetCommand: mode === "explain" ? targetCommand : undefined,
      lang,
      outputType,
      verbosity,
      platform,
      os,
      cli: shell,
      user_request: input.trim(),
    };
  }

  async function onGenerate() {
    setApiErr("");
    setTool(null);
    setMarkdown("");

    if (!validateBeforeSend()) return;

    setLoading(true);
    try {
      const res = await callCCG(buildPayload("generate"));
      if (!res?.ok) {
        setApiErr(res?.message || res?.error || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± AI" : "AI error"));
        return;
      }
      setTool(res.tool || null);
      setMarkdown(res.markdown || res.output || "");
    } catch (e) {
      setApiErr(String(e?.message || e || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± API" : "API error")));
    } finally {
      setLoading(false);
    }
  }

  async function onExplain() {
    setApiErr("");
    if (!validateBeforeSend()) return;

    const cmd = tool?.primary?.command || "";
    if (!cmd) {
      setApiErr(lang === "fa" ? "Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø±ÙˆØ¬ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù† ØªÙˆØ¶ÛŒØ­ Ø¯Ø§Ø¯." : "Generate first to explain.");
      return;
    }

    setLoading(true);
    try {
      const res = await callCCG(buildPayload("explain", cmd));
      if (!res?.ok) {
        setApiErr(res?.message || res?.error || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± AI" : "AI error"));
        return;
      }
      setTool(res.tool || null);
      setMarkdown(res.markdown || res.output || "");
    } catch (e) {
      setApiErr(String(e?.message || e || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± API" : "API error")));
    } finally {
      setLoading(false);
    }
  }

  function savePreset() {
    setValidationErr("");
    if (!isOther) return;

    if (!isSafeFreeText(presetName, 2, 30)) {
      setValidationErr(lang === "fa" ? "Ù†Ø§Ù… preset Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Û² ØªØ§ Û³Û°)." : "Invalid preset name (2..30).");
      return;
    }
    if (!isSafeFreeText(customOS, 2, 40) || !isSafeFreeText(customShell, 2, 20)) {
      setValidationErr(lang === "fa" ? "Custom OS/Shell Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid custom OS/Shell.");
      return;
    }

    const next = [
      { name: cleanToken(presetName), os: cleanToken(customOS), shell: cleanToken(customShell) },
      ...presets.filter(p => p.name !== cleanToken(presetName)),
    ].slice(0, 20);

    setPresets(next);
    try { localStorage.setItem(LS_PRESETS, JSON.stringify(next)); } catch {}
    setPresetName("");
  }

  function loadPreset(name) {
    const p = presets.find(x => x.name === name);
    if (!p) return;
    setCustomOS(p.os || "");
    setCustomShell(p.shell || "bash");
  }

  const requestHintFa =
"Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ø¨ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ØŒ Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯: Ù‡Ø¯Ù + Ù…Ø­ÛŒØ· + Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§.\nÙ…Ø«Ø§Ù„: Â«Ø±ÙˆÛŒ Ubuntu 22.04 Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… ÙˆØ¶Ø¹ÛŒØª nginx Ø±Ùˆ Ú†Ú© Ú©Ù†Ù…Ø› Ø®Ø±ÙˆØ¬ÛŒ Ø§Ù…Ù† Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±Â».";
  const requestHintEn =
"Write: goal + environment + constraints.\nExample: \"Ubuntu 22.04: check nginx status; safe/read-only output\".";

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">

            <FieldLabel label={t ? t("platform") : "Platform"} tip={t ? t("tip_platform") : ""} />
            <select value={platform} onChange={(e) => setPlatform(e.target.value)} className="ccg-select text-sm">
              {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>

            <div className="flex items-center gap-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">
                Advanced
              </label>
            </div>

            <FieldLabel label={t ? t("outputType") : "Output"} tip={t ? t("tip_outputType") : ""} />
            <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
              <option value="tool">Tool (recommended)</option>
              <option value="markdown">Markdown</option>
              <option value="python">Python</option>
            </select>

            <FieldLabel label="Verbosity" tip="brief/normal/detailed affects explanation depth (Explain mode too)" />
            <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
              {VERBOSITY_OPTIONS.map(v => (
                <option key={v.value} value={v.value}>{lang === "fa" ? v.labelFa : v.labelEn}</option>
              ))}
            </select>

            {/* Network: always show vendor/deviceType */}
            {isNetwork ? (
              <>
                <FieldLabel label="Vendor" tip="Select device vendor family" />
                <select value={vendor} onChange={(e)=>setVendor(e.target.value)} className="ccg-select text-sm">
                  {NETWORK_VENDORS.map(v => <option key={v.value} value={v.value}>{v.label}</option>)}
                </select>

                <FieldLabel label="Device Type" tip="OS/firmware family" />
                <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select text-sm">
                  {deviceTypeOptions.map(d => <option key={d} value={d}>{d}</option>)}
                </select>
              </>
            ) : null}

            {/* Shell selector for non-network, non-custom */}
            {!isNetwork && !isOther ? (
              <>
                <FieldLabel label="Shell/CLI" tip="Target shell / CLI" />
                <select value={shell} onChange={(e)=>setShell(e.target.value)} className="ccg-select text-sm">
                  {shellOptions.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </>
            ) : null}
          </div>

          {/* Advanced panel: contextual */}
          {advanced && !isNetwork && !isOther ? (
            <div className="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div className="sm:col-span-2">
                <FieldLabel label="OS Detail" tip="Only for selected platform (no cross-OS mismatch)" />
                <select value={advOsName} onChange={(e)=>setAdvOsName(e.target.value)} className="ccg-select text-sm w-full">
                  <option value="">(default)</option>
                  {advOsOptions.map(n => <option key={n} value={n}>{n}</option>)}
                </select>
              </div>
              <div>
                <FieldLabel label="Version/Build" tip="Optional (e.g. 22.04 / 11 / 2022 / 13.6)" />
                <input value={advOsVersion} onChange={(e)=>setAdvOsVersion(e.target.value)} className="ccg-input text-sm w-full" placeholder="optional" />
              </div>
            </div>
          ) : null}

          {/* Custom panel */}
          {isOther ? (
            <div className="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div className="sm:col-span-2">
                <FieldLabel label="Custom OS" tip="Allowed: letters/numbers/space and . _ + - / (2..40)" />
                <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input text-sm w-full" placeholder='e.g. "FreeBSD 14" or "OpenWrt"' />
              </div>
              <div>
                <FieldLabel label="Custom Shell/CLI" tip='e.g. bash / zsh / cmd / powershell / "router-cli"' />
                <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input text-sm w-full" placeholder="bash" />
              </div>

              <div className="sm:col-span-2">
                <FieldLabel label="Saved Presets" tip="Load previously saved custom OS/shell" />
                <select className="ccg-select text-sm w-full" defaultValue="" onChange={(e)=>loadPreset(e.target.value)}>
                  <option value="">(select preset)</option>
                  {presets.map(p => <option key={p.name} value={p.name}>{p.name} â€” {p.os} / {p.shell}</option>)}
                </select>
              </div>
              <div className="flex gap-2 items-end">
                <div className="flex-1">
                  <FieldLabel label="Preset name" tip="2..30 safe chars" />
                  <input value={presetName} onChange={(e)=>setPresetName(e.target.value)} className="ccg-input text-sm w-full" placeholder="MyLaptop" />
                </div>
                <button className="ccg-btn" type="button" onClick={savePreset}>Save</button>
              </div>
            </div>
          ) : null}
        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Input */}
          <div className="ccg-card p-5 sm:p-8">
            <h2 className="text-lg font-semibold mb-4">{t ? t("request") : "Request"}</h2>

            <textarea
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              className="ccg-textarea text-sm w-full"
              rows={8}
              placeholder={lang === "fa" ? requestHintFa : requestHintEn}
            />

            {validationErr ? (
              <div className="ccg-error mt-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ" : "Validation error"}</div>
                <div className="text-sm">{validationErr}</div>
              </div>
            ) : null}

            {apiErr ? (
              <div className="ccg-error mt-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            <div className="mt-5 flex flex-col sm:flex-row gap-3">
              <button className="ccg-btn w-full sm:w-auto" type="button" onClick={onGenerate} disabled={loading}>
                {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : (lang === "fa" ? "Generate" : "Generate")}
              </button>

              <button className="ccg-btn w-full sm:w-auto" type="button" onClick={onExplain} disabled={loading || !(tool?.primary?.command)}>
                {lang === "fa" ? "ØªÙˆØ¶ÛŒØ­ Ù‡Ù…ÛŒÙ† Ú©Ø§Ù…Ù†Ø¯" : "Explain this command"}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className="ccg-card p-5 sm:p-8">
            <h2 className="text-lg font-semibold mb-4">{t ? t("output") : "Output"}</h2>

            {tool ? (
              <ToolResult tool={tool} />
            ) : markdown ? (
              <SectionedMarkdown markdown={markdown} lang={lang} />
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t ? t("outputPlaceholder") : "Output will appear here."}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      {tip ? (
        <span className="relative group">
          <button
            type="button"
            className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
            aria-label={`${label} help`}
          >
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_generator_network_advanced_20260107_170115/client/src/components/ui/ToolResult.jsx
================================================================================

import React from "react";

function CopyBtn({ text }) {
  const [copied, setCopied] = React.useState(false);

  const onCopy = async () => {
    try {
      await navigator.clipboard.writeText(String(text || ""));
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {
      // ignore
    }
  };

  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn px-3 py-2 text-xs"
      title="Copy"
    >
      {copied ? "Copied" : "Copy"}
    </button>
  );
}

export default function ToolResult({ tool }) {
  if (!tool) return null;

  const primary = tool.primary || {};
  const alternatives = Array.isArray(tool.alternatives) ? tool.alternatives : [];
  const warnings = Array.isArray(tool.warnings) ? tool.warnings : [];

  return (
    <div className="space-y-5">
      {/* Primary */}
      <div className="ccg-section-card">
        <div className="flex items-center justify-between gap-3">
          <div className="font-semibold">Command</div>
          <CopyBtn text={primary.command || ""} />
        </div>

        <pre className="mt-3 overflow-auto rounded-xl border border-[var(--border)] p-3 text-sm">
          <code>{primary.command || ""}</code>
        </pre>
      </div>

      {/* Explanation */}
      <div className="ccg-section-card">
        <div className="font-semibold mb-2">ØªÙˆØ¶ÛŒØ­</div>
        <div className="text-sm whitespace-pre-wrap">{tool.explanation || ""}</div>
      </div>

      {/* Warnings */}
      <div className="ccg-section-card ccg-warn">
        <div className="font-semibold mb-2">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
        {warnings.length ? (
          <ul className="list-disc pr-5 text-sm space-y-1">
            {warnings.map((w, i) => (
              <li key={i}>{w}</li>
            ))}
          </ul>
        ) : (
          <div className="text-sm">- Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„Ø´ ØªØºÛŒÛŒØ±Ø§Øª/Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¨Ø§Ø² Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.</div>
        )}
      </div>

      {/* Alternatives */}
      <div className="ccg-section-card">
        <div className="font-semibold mb-2">Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§</div>
        <div className="space-y-4">
          {alternatives.slice(0, 3).map((a, i) => (
            <div key={i} className="rounded-xl border border-[var(--border)] p-3">
              <div className="flex items-center justify-between gap-3">
                <div className="text-sm font-medium">{a.note || `Ú¯Ø²ÛŒÙ†Ù‡ ${i + 1}`}</div>
                <CopyBtn text={a.command || ""} />
              </div>
              <pre className="mt-2 overflow-auto rounded-lg bg-black/5 dark:bg-white/5 p-3 text-sm">
                <code>{a.command || ""}</code>
              </pre>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_generator_network_advanced_20260107_170115/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Stable Tool Contract Normalizer (Generator + Explain)
//
// Always returns an object:
// {
//   tool: { primary:{command,lang}, explanation:string, warnings:string[], alternatives:[{command,note} x3] },
//   markdown: string,
//   output: string (alias of markdown)
// }
//
// If rawText is JSON like { tool, markdown } or { primary, explanation, ... } => unwrap and render.
// If forcedCommand is provided (Explain mode), primary.command MUST stay exactly that.

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh" || c === "powershell") return "powershell";
  if (c.includes("cmd") || c === "cmd") return "cmd";
  return "bash";
}

function tryParseJSONMaybe(text) {
  const t = String(text || "").trim();
  if (!t) return null;
  // quick guard
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try { return JSON.parse(t); } catch { return null; }
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // reject obvious prose starters
  if (/^(Ø¨Ø±Ø§ÛŒ|Ø§ÛŒÙ†|Ù†Ú©ØªÙ‡|ØªÙˆØ¶ÛŒØ­|Ù‡Ø´Ø¯Ø§Ø±|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†|Ù…Ø«Ø§Ù„)\b/.test(s)) return false;
  // starts with common tool token (or sudo)
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizeCommandsFromRaw(codeRaw) {
  const lines = String(codeRaw || "").split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const cmdLines = lines.filter(looksLikeCommand);
  // If none look like command, keep first 1-2 lines (best effort)
  const out = (cmdLines.length ? cmdLines : lines.slice(0, 2)).join("\n").trim();
  return out;
}

function ensure3Alternatives(alts, primaryCmd) {
  const a = Array.isArray(alts) ? alts.filter(x => x && typeof x === "object") : [];
  const out = a.slice(0, 3).map(x => ({
    command: String(x.command || "").trim(),
    note: String(x.note || "").trim()
  })).filter(x => x.command);

  // Fill missing
  while (out.length < 3) {
    out.push({ command: primaryCmd || "", note: out.length === 0 ? "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± Ø§ØµÙ„ÛŒ" : "Ú¯Ø²ÛŒÙ†Ù‡ Ù…Ø´Ø§Ø¨Ù‡" });
  }
  return out.slice(0, 3);
}

function ensureWarnings(ws) {
  const w = Array.isArray(ws) ? ws.map(x => String(x || "").trim()).filter(Boolean) : [];
  if (w.length) return w.slice(0, 6);
  return [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§/ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
    "Ø§Ú¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Administrator / sudo Ø¨Ø§Ø´Ø¯.",
    "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø§Ø«Ø±Ø§Øª Ø¬Ø§Ù†Ø¨ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
  ];
}

function toolToMarkdown(tool) {
  const primary = tool?.primary?.command ? String(tool.primary.command).trim() : "";
  const lang = tool?.primary?.lang ? String(tool.primary.lang).trim() : "bash";
  const explanation = String(tool?.explanation || "").trim() || "ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.";
  const warnings = ensureWarnings(tool?.warnings);
  const alts = ensure3Alternatives(tool?.alternatives, primary);

  const parts = [];
  parts.push("```" + lang + "\n" + (primary || "echo \"No command produced\"") + "\n```");
  parts.push("\n## ØªÙˆØ¶ÛŒØ­\n" + explanation);
  parts.push("\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n" + warnings.map(x => `- ${x}`).join("\n"));
  parts.push("\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n" +
    alts.map(a =>
      `- ${a.note || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†"}\n\n\`\`\`${lang}\n${a.command}\n\`\`\``
    ).join("\n\n")
  );
  return parts.join("\n\n").trim() + "\n";
}

function coerceToolFromJson(obj, cli, forcedCommand) {
  // Supports:
  //  - { tool, markdown }
  //  - { primary, explanation, warnings, alternatives }
  const inner = obj?.tool && typeof obj.tool === "object" ? obj.tool : obj;
  const lang = fenceLangFromCli(cli, "tool");
  const primaryCmd = forcedCommand ? String(forcedCommand).trim() : String(inner?.primary?.command || inner?.command || "").trim();

  const tool = {
    primary: { command: primaryCmd, lang },
    explanation: String(inner?.explanation || "").trim(),
    warnings: ensureWarnings(inner?.warnings),
    alternatives: ensure3Alternatives(inner?.alternatives, primaryCmd)
  };
  return tool;
}

export function formatToolResponse({
  rawText = "",
  text = "",
  cli = "bash",
  outputType = "tool",
  forcedCommand = "",
} = {}) {
  const lang = fenceLangFromCli(cli, outputType);
  const input = String(rawText || text || "").trim();

  // 1) If AI returned JSON, unwrap it
  const parsed = tryParseJSONMaybe(input);
  if (parsed) {
    const tool = coerceToolFromJson(parsed, cli, forcedCommand);
    const md = typeof parsed?.markdown === "string" && parsed.markdown.trim()
      ? parsed.markdown.trim()
      : toolToMarkdown(tool);
    return { tool, markdown: md, output: md };
  }

  // 2) Else extract first code block as primary command
  const { codeRaw, rest } = splitFirstCodeBlock(input);
  let primaryCmd = normalizeCommandsFromRaw(codeRaw);
  if (forcedCommand) primaryCmd = String(forcedCommand).trim();

  const tool = {
    primary: { command: primaryCmd || "", lang },
    explanation: "",
    warnings: [],
    alternatives: []
  };

  // Very simple section extraction from markdown-ish content
  // explanation = rest without headings
  let explanation = rest;
  explanation = explanation.replace(/##\s*Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§[\s\S]*$/m, "").trim();
  explanation = explanation.replace(/##\s*Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§[\s\S]*$/m, "").trim();
  tool.explanation = explanation || "ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.";

  // warnings: try parse from a "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§" section if exists
  const wMatch = String(rest).match(/##\s*Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\s*([\s\S]*?)(?:##\s*Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§|$)/m);
  if (wMatch) {
    const ws = wMatch[1].split(/\r?\n/).map(l => l.replace(/^\s*-\s*/, "").trim()).filter(Boolean);
    tool.warnings = ensureWarnings(ws);
  } else {
    tool.warnings = ensureWarnings([]);
  }

  // alternatives: try parse code blocks under "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§"
  const aMatch = String(rest).match(/##\s*Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\s*([\s\S]*?)$/m);
  if (aMatch) {
    const block = aMatch[1];
    const codeBlocks = [...block.matchAll(/```[^\n]*\n([\s\S]*?)```/g)].map(m => String(m[1]||"").trim());
    const notes = block.split(/```[\s\S]*?```/).map(s=>s.trim()).filter(Boolean);
    const alts = [];
    for (let i=0;i<codeBlocks.length && alts.length<3;i++){
      const cmd = normalizeCommandsFromRaw(codeBlocks[i]);
      const note = notes[i] ? notes[i].replace(/^-+\s*/,"").split(/\r?\n/)[0].trim() : "";
      if (cmd) alts.push({ command: cmd, note });
    }
    tool.alternatives = ensure3Alternatives(alts, primaryCmd);
  } else {
    tool.alternatives = ensure3Alternatives([], primaryCmd);
  }

  const md = toolToMarkdown(tool);
  return { tool, markdown: md, output: md };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/day1_freeze_generator_20260106_072441/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/day1_freeze_generator_20260106_072441/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool Contract (LOCKED)
//
// Generator must ALWAYS end in a stable template:
// 1) Primary command -> ONE fenced block (ONLY command lines)
// 2) Explanation      -> short, correct, level-aware
// 3) Warnings         -> real, relevant
// 4) Alternatives     -> exactly 3, OS/CLI-aware, unique
//
// API returns:
// tool: {
//   primary: { command, lang },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command, note, lang? }, ...]
// }
// markdown: string (rendered from tool)
//
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function lc(x) { return String(x ?? "").toLowerCase().trim(); }

function fenceLangFromCli(cli = "bash", os = "") {
  const c = lc(cli);
  const o = lc(os);
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  if (o.includes("windows")) return (c.includes("power") ? "powershell" : "cmd");
  return "bash";
}

function stripCodeFences(s) {
  return String(s ?? "")
    .replace(/```[\s\S]*?```/g, " ")
    .replace(/`+/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[\u0600-\u06FF]/.test(s)) return false;          // reject Persian inside command
  if (/[.ØŒØ›!?]$/.test(s)) return false;                 // reject prose endings
  if (/^(note|hint|warning|explanation)\b/i.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._/-]+(\s+|$)/.test(s);
}

function normalizeCodeToCommands(codeRaw, { os, cli }) {
  const o = lc(os);
  const c = lc(cli);

  const lines = String(codeRaw || "")
    .split("\n")
    .map(x => x.trim())
    .filter(Boolean);

  const cmdLines = lines.filter(looksLikeCommand);

  // If no code fence or it was messy, try best-effort pick from full text
  let primary = cmdLines[0] || "";

  // Windows shutdown normalization (avoid -s -t style)
  if (o.includes("windows") && (c.includes("cmd") || c.includes("power"))) {
    primary = primary
      .replace(/\bshutdown\s+-s\b/i, "shutdown /s")
      .replace(/\bshutdown\s+-r\b/i, "shutdown /r")
      .replace(/\s+-t\s+/i, " /t ");
    // if uses "/t" missing slash
    primary = primary.replace(/\bshutdown\s+\/s\s+\/t\s+(\d+)/i, "shutdown /s /t $1");
  }

  // Keep only the first command line as primary (single-line)
  primary = primary.split(/\s*&&\s*|\s*;\s*/)[0].trim();

  return { primary, all: cmdLines };
}

function classifyIntent({ userRequest, primaryCommand, os }) {
  const ur = lc(userRequest);
  const pc = lc(primaryCommand);
  const o  = lc(os);

  if (o.includes("windows") || ur.includes("ÙˆÛŒÙ†Ø¯ÙˆØ²")) {
    if (pc.includes("shutdown") && (pc.includes("/s") || pc.includes("-s") || ur.includes("Ø®Ø§Ù…ÙˆØ´"))) return "shutdown";
    if (pc.includes("shutdown") && (pc.includes("/r") || pc.includes("-r") || ur.includes("Ø±ÛŒØ³ØªØ§Ø±Øª"))) return "reboot";
  }

  if (pc.includes("reboot") || pc.includes("systemctl reboot") || pc.includes("shutdown -r")) return "reboot";
  if (pc.includes("shutdown") && (pc.includes("-h") || pc.includes("poweroff") || ur.includes("Ø®Ø§Ù…ÙˆØ´"))) return "shutdown";

  if (ur.includes("Ú©Ø§Ø±Ø¨Ø±") && (ur.includes("Ú†Ù†Ø¯") || ur.includes("Ù„ÛŒØ³Øª")) ) return "list_users";

  return "generic";
}

function levelMode(knowledgeLevel) {
  const k = lc(knowledgeLevel);
  if (k.includes("Ù…Ø¨ØªØ¯ÛŒ") || k.includes("begin")) return "beginner";
  if (k.includes("Ù…ØªÙˆØ³Ø·") || k.includes("inter")) return "intermediate";
  if (k.includes("Ø­Ø±ÙÙ‡") || k.includes("expert") || k.includes("pro")) return "expert";
  return "intermediate";
}

// Curated safe templates for high-impact intents
function templateFor({ intent, os, cli, userRequest }) {
  const o = lc(os);
  const c = lc(cli);

  const isWin = o.includes("windows") || c.includes("cmd") || c.includes("powershell");
  const isCmd = c.includes("cmd");
  const isPs  = c.includes("powershell") || c === "pwsh";

  if (intent === "shutdown" && isWin) {
    // try to detect delay in seconds from request (Persian digits too)
    let sec = 60;
    const m = String(userRequest||"").match(/(\d+)\s*Ø¯Ù‚ÛŒÙ‚Ù‡/);
    if (m) sec = Math.max(5, parseInt(m[1],10) * 60);
    const cmd = `shutdown /s /t ${sec}`;
    return {
      primary: cmd,
      explanation_beginner: `Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙˆÛŒÙ†Ø¯ÙˆØ² Ø±Ø§ Ø¨Ø¹Ø¯ Ø§Ø² ${sec} Ø«Ø§Ù†ÛŒÙ‡ Ø®Ø§Ù…ÙˆØ´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.`,
      explanation_intermediate: `Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø³ÛŒØ³ØªÙ… Ø¨Ø§ ØªØ§Ø®ÛŒØ± ${sec}s.`,
      explanation_expert: `Shutdown with delay (${sec}s).`,
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø±/Ø³Ø±ÙˆÛŒØ³ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø± Ø§Ø³ØªØŒ Ø®Ø§Ù…ÙˆØ´ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø¹Ø« Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ø¯ÛŒØªØ§ Ø´ÙˆØ¯.",
        "Ø¨Ø±Ø§ÛŒ Ú©Ù†Ø³Ù„ Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒØŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ù„ØºÙˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."
      ],
      alternatives: [
        { command: "shutdown /a", note: "Ù„ØºÙˆ Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯Ù† Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡", lang: "cmd" },
        { command: "shutdown /s /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ", lang: "cmd" },
        { command: "shutdown /s /f /t 0", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ + Ø¨Ø³ØªÙ† Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§", lang: "cmd" },
      ],
      lang: isCmd ? "cmd" : (isPs ? "powershell" : "cmd"),
    };
  }

  if (intent === "reboot" && isWin) {
    const cmd = "shutdown /r /t 0";
    return {
      primary: cmd,
      explanation_beginner: "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙˆÛŒÙ†Ø¯ÙˆØ² Ø±Ø§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.",
      explanation_intermediate: "Restart ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ… Ø¨Ø§ shutdown.exe.",
      explanation_expert: "Immediate reboot.",
      warnings: [
        "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.",
        "Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø§Ø³ØªØŒ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ session Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†Ø¯.",
        "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "shutdown /r /t 60", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û¶Û° Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ±", lang: "cmd" },
        { command: "shutdown /g /t 0", note: "Restart + restart registered apps (Windows)", lang: "cmd" },
        { command: "powershell -Command \"Restart-Computer -Force\"", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ø² Ø·Ø±ÛŒÙ‚ PowerShell", lang: "cmd" },
      ],
      lang: isCmd ? "cmd" : (isPs ? "powershell" : "cmd"),
    };
  }

  if ((intent === "shutdown" || intent === "reboot") && !isWin) {
    if (intent === "shutdown") {
      return {
        primary: "sudo shutdown -h now",
        explanation_beginner: "Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.",
        explanation_intermediate: "Shutdown ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ….",
        explanation_expert: "Immediate shutdown.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
          "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª maintenance window Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯."
        ],
        alternatives: [
          { command: "sudo poweroff", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ ÙÙˆØ±ÛŒ", lang: "bash" },
          { command: "sudo shutdown -h +1", note: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±", lang: "bash" },
          { command: "sudo systemctl poweroff", note: "Ø±ÙˆØ´ systemd", lang: "bash" },
        ],
        lang: "bash",
      };
    } else {
      return {
        primary: "sudo reboot",
        explanation_beginner: "Ø³ÛŒØ³ØªÙ… Ù„ÛŒÙ†ÙˆÚ©Ø³ Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.",
        explanation_intermediate: "Reboot ÙÙˆØ±ÛŒ Ø³ÛŒØ³ØªÙ….",
        explanation_expert: "Immediate reboot.",
        warnings: [
          "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
          "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
          "Ø¯Ø± Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
        ],
        alternatives: [
          { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± systemd", lang: "bash" },
          { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ", lang: "bash" },
          { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§Ø®ÛŒØ±", lang: "bash" },
        ],
        lang: "bash",
      };
    }
  }

  if (intent === "list_users" && isWin) {
    return {
      primary: "net user",
      explanation_beginner: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Local Ø±ÙˆÛŒ ÙˆÛŒÙ†Ø¯ÙˆØ² Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.",
      explanation_intermediate: "Ù†Ù…Ø§ÛŒØ´ Local users Ø¨Ø§ net.exe.",
      explanation_expert: "List local users.",
      warnings: [
        "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Local Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ (Ù†Ù‡ Ù„Ø²ÙˆÙ…Ø§Ù‹ Domain).",
        "Ø§Ú¯Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Domain Ù‡Ø³ØªÛŒØ¯ØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø§Ø² Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ AD Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        "Ø®Ø±ÙˆØ¬ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø³ØªÙ‡ Ø¨Ù‡ policy Ø³Ø§Ø²Ù…Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯ Ø´ÙˆØ¯."
      ],
      alternatives: [
        { command: "wmic useraccount get name,sid", note: "Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… + SID", lang: "cmd" },
        { command: "powershell -Command \"Get-LocalUser | Select Name,Enabled\"", note: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ PowerShell", lang: "cmd" },
        { command: "net localgroup administrators", note: "Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¶Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ Administrators", lang: "cmd" },
      ],
      lang: "cmd",
    };
  }

  return null;
}

function uniqAlternatives(alts) {
  const seen = new Set();
  const out = [];
  for (const a of alts || []) {
    const key = lc(a?.command);
    if (!key || seen.has(key)) continue;
    seen.add(key);
    out.push(a);
  }
  return out;
}

function renderMarkdown(tool) {
  const p = tool.primary;
  const warn = (tool.warnings || []).filter(Boolean);
  const alts = (tool.alternatives || []).filter(Boolean);

  let md = "";
  md += "```" + (p.lang || "bash") + "\n" + p.command.trim() + "\n```\n\n";
  md += "## ØªÙˆØ¶ÛŒØ­\n" + (tool.explanation || "â€”") + "\n\n";

  md += "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n";
  if (warn.length === 0) md += "- Ø§Ø­ØªÛŒØ§Ø· Ú©Ù†ÛŒØ¯ Ùˆ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.\n\n";
  else md += warn.map(x => `- ${x}`).join("\n") + "\n\n";

  md += "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n";
  if (alts.length === 0) {
    md += "- â€”\n";
    return md.trim() + "\n";
  }

  for (const a of alts.slice(0,3)) {
    md += `- ${a.note || "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†"}\n\n`;
    md += "```" + (a.lang || p.lang || "bash") + "\n" + String(a.command||"").trim() + "\n```\n\n";
  }
  return md.trim() + "\n";
}

export function formatToolResponse({ rawText, userRequest, os, cli, knowledgeLevel, outputType } = {}) {
  const ot = lc(outputType || "markdown");

  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const { primary } = normalizeCodeToCommands(codeRaw || "", { os, cli });

  const intent = classifyIntent({ userRequest, primaryCommand: primary, os });
  const lvl = levelMode(knowledgeLevel);

  const lang = fenceLangFromCli(cli, os);

  // Use curated template for known intents (shutdown/reboot/list_users)
  let tpl = templateFor({ intent, os, cli, userRequest });

  // If template exists but primary from model differs, trust template (safety + correctness)
  if (tpl) {
    const explanation =
      (lvl === "beginner" ? tpl.explanation_beginner :
       lvl === "expert"   ? tpl.explanation_expert :
                            tpl.explanation_intermediate);

    const tool = {
      primary: { command: tpl.primary, lang: tpl.lang || lang },
      explanation,
      warnings: (tpl.warnings || []).slice(0, 5),
      alternatives: uniqAlternatives(tpl.alternatives || []).slice(0,3),
    };

    const markdown = renderMarkdown(tool);

    if (ot === "command" || ot === "script") {
      return { tool, markdown: "```" + (tool.primary.lang||"bash") + "\n" + tool.primary.command + "\n```" };
    }
    return { tool, markdown };
  }

  // Generic fallback: keep primary if exists, fill rest minimally and safely
  const safePrimary = primary || "";
  const explanationRaw = stripCodeFences(rest);
  const explanation = explanationRaw
    ? explanationRaw.slice(0, 420)
    : "Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯. Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø±ÙˆÛŒ Ú†Ù‡ Ù…Ø­ÛŒØ·ÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.";

  const tool = {
    primary: { command: safePrimary || "(command not detected)", lang },
    explanation,
    warnings: [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ú¯Ø± Production Ø§Ø³Øª Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.",
      "Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Admin/sudo Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø§ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§ Ø¯Ø§Ø±ÛŒØ¯.",
    ],
    alternatives: uniqAlternatives([
      { command: safePrimary, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒâ€ŒØ´Ø¯Ù‡)", lang },
      { command: safePrimary, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (fallback)", lang },
      { command: safePrimary, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (fallback)", lang },
    ]).slice(0,3),
  };

  const markdown = renderMarkdown(tool);

  if (ot === "command" || ot === "script") {
    return { tool, markdown: "```" + (lang||"bash") + "\n" + tool.primary.command + "\n```" };
  }
  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/20260108_101607/client/src/components/ui/MarkdownBox.jsx
================================================================================

// CCG_PATCH_TDZ_001
// TDZ fix: remove usage-before-init bug by replacing MarkdownBox with a safe version.

import { useMemo, useState } from "react";

export default function MarkdownBox({ markdown, content, lang = "fa" }) {
  const md = (content ?? markdown ?? "") || "";

  const labels = useMemo(() => {
    const fa = { copy: "Ú©Ù¾ÛŒ", copied: "Ú©Ù¾ÛŒ Ø´Ø¯" };
    const en = { copy: "Copy", copied: "Copied" };
    return lang === "fa" ? fa : en;
  }, [lang]);

  const [copied, setCopied] = useState(false);

  async function copyAll() {
    try {
      if (!md) return;
      if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(md);
        setCopied(true);
        window.setTimeout(() => setCopied(false), 1200);
      }
    } catch (e) {
      console.error("Clipboard copy failed:", e);
    }
  }

  return (
    <div className="w-full">
      <div className="flex items-center justify-end gap-2 mb-2">
        <button
          type="button"
          onClick={copyAll}
          disabled={!md}
          className="px-3 py-1 rounded border text-sm disabled:opacity-50"
        >
          {copied ? labels.copied : labels.copy}
        </button>
      </div>

      <pre className="w-full whitespace-pre-wrap break-words p-3 rounded border text-sm overflow-auto">
        {md}
      </pre>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/20260124_045626/client/src/components/ui/ToolResult.jsx
================================================================================

// CCG_PATCH_TOOLRESULT_MD_002
import { useMemo, useState } from "react";
import MarkdownBox from "./MarkdownBox";

function tryParseToolJsonString(maybe) {
  try {
    if (typeof maybe !== "string") return null;
    const s = maybe.trim();
    if (!s) return null;
    if (!(s.startsWith("{") && s.endsWith("}"))) return null;
    const obj = JSON.parse(s);
    if (!obj || typeof obj !== "object") return null;
    return obj;
  } catch {
    return null;
  }
}

function CopyBtn({ value, lang }) {
  const [copied, setCopied] = useState(false);
  const labelCopy = lang === "fa" ? "Ú©Ù¾ÛŒ" : "Copy";
  const labelCopied = lang === "fa" ? "Ú©Ù¾ÛŒ Ø´Ø¯" : "Copied";

  async function copy() {
    try {
      const v = String(value || "");
      if (!v) return;
      if (navigator?.clipboard?.writeText) {
        await navigator.clipboard.writeText(v);
        setCopied(true);
        window.setTimeout(() => setCopied(false), 900);
      }
    } catch (e) {
      console.error("Clipboard copy failed:", e);
    }
  }

  return (
    <button
      type="button"
      className="ccg-btn ccg-btn-ghost ccg-btn-xs"
      onClick={copy}
      disabled={!value}
      title={labelCopy}
    >
      {copied ? labelCopied : labelCopy}
    </button>
  );
}

function CodeBlock({ title, value, lang }) {
  const v = String(value || "");
  return (
    <div className="ccg-codeblock">
      <div className="ccg-codeblock-head">
        <div className="ccg-codeblock-title">{title || "CODE"}</div>
        <CopyBtn value={v} lang={lang} />
      </div>
      <pre className="ccg-pre">
        <code dir="ltr">{v}</code>
      </pre>
    </div>
  );
}

function toMarkdown(toolObj, lang) {
  if (!toolObj || typeof toolObj !== "object") return "";

  const explanation = toolObj.explanation ? String(toolObj.explanation) : "";
  const warnings = Array.isArray(toolObj.warnings) ? toolObj.warnings.map(String).filter(Boolean) : [];
  const alternatives = Array.isArray(toolObj.alternatives) ? toolObj.alternatives : [];

  let md = "";

  if (explanation) {
    md += (lang === "fa" ? "### ØªÙˆØ¶ÛŒØ­\n\n" : "### Explanation\n\n");
    md += explanation.trim() + "\n\n";
  }

  if (warnings.length) {
    md += (lang === "fa" ? "### Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n\n" : "### Warnings\n\n");
    for (const w of warnings) md += `- ${w}\n`;
    md += "\n";
  }

  if (alternatives.length) {
    md += (lang === "fa" ? "### Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n\n" : "### Alternatives\n\n");
    // table for clean layout
    md += (lang === "fa"
      ? "| Ø¯Ø³ØªÙˆØ± | ØªÙˆØ¶ÛŒØ­ |\n|---|---|\n"
      : "| Command | Note |\n|---|---|\n");
    for (const a of alternatives) {
      const cmd = a?.command ? String(a.command).replace(/\n/g, " ") : "";
      const note = a?.note ? String(a.note).replace(/\n/g, " ") : "";
      if (cmd || note) md += `| ${cmd} | ${note} |\n`;
    }
    md += "\n";
  }

  return md.trim();
}

/**
 * ToolResult renderer:
 * - For outputType=tool => show: primary.command/python as codeblocks + explanation/warnings/alternatives as Markdown
 * - Raw JSON in <details> (collapsible)
 */
export default function ToolResult({ tool, lang = "fa" }) {
  const normalized = useMemo(() => {
    const parsed = tryParseToolJsonString(tool);
    if (parsed) return parsed;
    if (tool && typeof tool === "object") return tool;
    return null;
  }, [tool]);

  if (!normalized) return null;

  const primary = normalized.primary || normalized.tool || normalized;

  const command =
    primary?.command ||
    primary?.cmd ||
    normalized?.command ||
    normalized?.cmd ||
    "";

  const python =
    primary?.python ||
    normalized?.python ||
    "";

  const md = useMemo(() => toMarkdown(normalized, lang), [normalized, lang]);

  const rawJson = (() => {
    try {
      return JSON.stringify(normalized, null, 2);
    } catch {
      return String(normalized);
    }
  })();

  const detailsLabel = lang === "fa" ? "Ù†Ù…Ø§ÛŒØ´ JSON Ø®Ø§Ù…" : "Show raw JSON";

  return (
    <div className="space-y-3">
      {command ? <CodeBlock title="command" value={command} lang={lang} /> : null}
      {python ? <CodeBlock title="python" value={python} lang={lang} /> : null}

      {md ? (
        <div className="ccg-card p-4 sm:p-5">
          <MarkdownBox markdown={md} lang={lang} />
        </div>
      ) : null}

      <details className="ccg-card p-4 sm:p-5">
        <summary className="cursor-pointer select-none font-semibold">
          {detailsLabel}
        </summary>
        <div className="mt-3">
          <CodeBlock title="ToolResult" value={rawJson} lang={lang} />
        </div>
      </details>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_eof_simple/20260107_090723/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_ADVANCED_V1
const ADV_OS_FAMILIES = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network" },
  { value: "other", label: "Other" },
];

const ADV_OS_NAMES = [
  // Linux
  "Ubuntu", "Debian", "CentOS", "RHEL", "Rocky", "AlmaLinux", "Fedora", "Arch", "openSUSE",
  "Kali", "Linux Mint", "Manjaro",
  // BSD
  "FreeBSD", "OpenBSD", "NetBSD",
  // Windows
  "Windows 10", "Windows 11", "Windows Server 2019", "Windows Server 2022",
  // macOS
  "macOS",
  // Network (examples)
  "Cisco IOS", "Cisco IOS-XE", "MikroTik RouterOS", "FortiOS"
];

const ADV_SHELLS = [
  { value: "bash", label: "bash" },
  { value: "sh", label: "sh" },
  { value: "zsh", label: "zsh" },
  { value: "fish", label: "fish" },
  { value: "pwsh", label: "PowerShell (pwsh)" },
  { value: "cmd", label: "CMD (cmd.exe)" },
];

// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "other", label: "Other (Custom OS)" },
  { value: "network", label: "Network Device" },
];

// ---- Advanced: validation allowlists (client-side) ----
const OS_ALLOWLIST = [
  "Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","SLES",
  "Amazon Linux","Oracle Linux","Kali","Gentoo","Alpine",
  "FreeBSD","OpenBSD","NetBSD",
  "Windows 10","Windows 11","Windows Server 2019","Windows Server 2022",
  "macOS",
  "AIX","HP-UX","Solaris","Illumos"
];

const SHELL_ALLOWLIST = [
  "bash","zsh","sh","fish",
  "cmd","powershell","pwsh",
  "ksh","tcsh"
];

function cleanToken(v) {
  return String(v || "").trim().replace(/\s+/g, " ");
}

function isSafeFreeText(v, minLen = 0, maxLen = 40) {
  const s = cleanToken(v);
  if (s.length < minLen) return false;
  if (s.length > maxLen) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{1,40}$/.test(s);
}


const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  
  function normalizeOSName(x) {
    return String(x || "").trim();
  }

  function validateAdvanced() {
    if (!advanced) return { ok: true };
    const osName = normalizeOSName(advOSName);
    const ver = String(advOSVersion || "").trim();

    const allowedOS = new Set(ADV_OS_NAMES);
    const allowedShell = new Set(ADV_SHELLS.map(x => x.value));

    // OS name must be in list OR start with "Other:" and be clean
    const isOther = /^other\s*:/i.test(osName);
    const otherValue = osName.split(/:/, 2)[1] ? osName.split(/:/, 2)[1].trim() : "";

    const cleanOther = otherValue && /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(otherValue);
    const cleanVer = !ver || /^[0-9A-Za-z._+\-]{1,20}$/.test(ver);

    const okOS = allowedOS.has(osName) || (isOther && cleanOther);
    const okShell = allowedShell.has(String(advShell || "").trim());

    // family must be one of allowed
    const okFam = new Set(ADV_OS_FAMILIES.map(x => x.value)).has(String(advOSFamily||""));

    if (!okFam) return { ok: false };
    if (!okOS) return { ok: false };
    if (!cleanVer) return { ok: false };
    if (!okShell) return { ok: false };
    return { ok: true };
  }

const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  
  const [advanced, setAdvanced] = useState(false);
  const [advOSFamily, setAdvOSFamily] = useState("linux");
  const [advOSName, setAdvOSName] = useState("");
  const [advOSVersion, setAdvOSVersion] = useState("");
  const [advShell, setAdvShell] = useState("bash");
const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  
  
  const [customOSName, setCustomOSName] = useState("Ubuntu");
  const [customOSVersion, setCustomOSVersion] = useState("");
  const [customShell, setCustomShell] = useState("bash");
const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  
  const advValid = validateAdvanced();
const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  
  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    const isOther = platform === "other";

    // Defaults (even when Advanced is closed)
    const safeMode = modeStyle || "operational";
    const safeLevel = knowledgeLevel || "intermediate";

    // Base OS/CLI mapping
    let osValue = isNetwork ? "network" : (platform || "linux");
    let cliValue = isNetwork ? "network-cli" : (shell || "bash");

    // If Other: use custom fields (validated)
    if (isOther) {
      const name = cleanToken(customOSName);
      const ver  = cleanToken(customOSVersion);
      const sh   = cleanToken(customShell).toLowerCase();

      const nameOk = !!name && (OS_ALLOWLIST.includes(name) || isSafeFreeText(name, 2, 40));
      const verOk  = ver ? isSafeFreeText(ver, 1, 20) : true;
      const shOk   = !!sh && SHELL_ALLOWLIST.includes(sh);

      const finalName = nameOk ? name : "Ubuntu";
      const finalVer  = (verOk ? ver : "");
      const finalShell= shOk ? sh : "bash";

      osValue = finalVer ? `${finalName} ${finalVer}` : finalName;
      cliValue = finalShell;
    }

    return {
      mode: "generate",
      lang: lang || "fa",
      user_request: input.trim(),

      outputType: outputType,
      modeStyle: safeMode,
      knowledgeLevel: safeLevel,

      platform: isNetwork ? "network" : (platform || "linux"),
      os: osValue,
      cli: cliValue,

      vendor: isNetwork ? (vendor || "") : "",
      deviceType: isNetwork ? (deviceType || "general") : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }

  useEffect(() => {
    document.body.classList.add("night-mode");
    document.body.classList.add("day-mode");
  }, []);


  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            
            <div className="flex items-center gap-2 mt-2">
              <input id="ccg-advanced" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
              <label htmlFor="ccg-advanced" className="text-sm text-slate-600 dark:text-slate-300">{t("advanced")}</label>
            </div>
<select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        

        {advanced ? (
          <>
            <div>
              <FieldLabel label={t("targetOS")} />
              <select value={advOSFamily} onChange={(e)=>setAdvOSFamily(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_OS_FAMILIES.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            <div>
              <FieldLabel label={t("osName")} tip={lang === "fa" ? "Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³: Other:MyOS" : "Pick from list or type: Other:MyOS"} />
              <input
                value={advOSName}
                onChange={(e)=>setAdvOSName(e.target.value)}
                list="ccg-osnames"
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: Ubuntu ÛŒØ§ Windows Server 2022 ÛŒØ§ Other:MyOS" : "e.g. Ubuntu / Windows Server 2022 / Other:MyOS"}
              />
              <datalist id="ccg-osnames">
                {ADV_OS_NAMES.map(x => <option key={x} value={x} />)}
              </datalist>
            </div>

            <div>
              <FieldLabel label={t("osVersion")} tip={lang === "fa" ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ù…Ø«Ù„ 24.04 ÛŒØ§ 2022" : "Optional; e.g. 24.04 or 2022"} />
              <input
                value={advOSVersion}
                onChange={(e)=>setAdvOSVersion(e.target.value)}
                className="ccg-select text-sm w-full"
                placeholder={lang === "fa" ? "Ù…Ø«Ø§Ù„: 24.04" : "e.g. 24.04"}
              />
            </div>

            <div>
              <FieldLabel label={t("targetShell")} />
              <select value={advShell} onChange={(e)=>setAdvShell(e.target.value)} className="ccg-select text-sm w-full">
                {ADV_SHELLS.map(o => (
                  <option key={o.value} value={o.value}>{o.label}</option>
                ))}
              </select>
            </div>

            {!advValid.ok ? (
              <div className="text-xs text-red-600 dark:text-red-400 mt-2">{t("invalidAdvanced")}</div>
            ) : null}
          </>
        ) : null}
</div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={(!input.trim() || loading || (advanced && !advValid.ok))}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
                toolResult ? <ToolResult tool={toolResult} /> : <SectionedMarkdown markdown={output} lang={lang} />
              ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}


================================================================================
FILE: .ccg_backups/generator_toolstyle_lock/20260102_140932/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Ù‡Ø¯Ù: Ø®Ø±ÙˆØ¬ÛŒ Generator Ø­Ø§Ù„Øª Tool/DevOps Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:
// - Ø§ÙˆÙ„: ÙÙ‚Ø· ÛŒÚ© code fence Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø±Ø§ÛŒ command/script
// - Ø¨Ø¹Ø¯: Ø¨Ø§Ù‚ÛŒ Ù…ØªÙ† (ØªÙˆØ¶ÛŒØ­/Ù‡Ø´Ø¯Ø§Ø±/Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§) Ø­ÙØ¸ Ø´ÙˆØ¯
// Ù†Ú©ØªÙ‡: export Ù‡Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ ØªØ§ importÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ù†Ø´Ú©Ù†Ø¯.

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function hasFaChars(s) {
  return /[\u0600-\u06FF]/.test(String(s || ""));
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (hasFaChars(s)) return false;
  if (s.startsWith("#")) return true;
  // common shells / admin tools / package managers / infra tools
  return /^(sudo|systemctl|service|journalctl|reboot|shutdown|apt|dnf|yum|pacman|snap|docker|kubectl|helm|git|npm|pnpm|yarn|node|python|pip|curl|wget|ssh|scp|rsync|ps|top|htop|df|du|free|ip|ifconfig|ss|netstat|lsof)\b/i.test(s);
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  const lines = t.split("\n").map(l => l.trim()).filter(Boolean);
  const picked = [];
  for (const l of lines.slice(0, 12)) {
    if (looksLikeCommand(l)) picked.push(l);
    if (picked.length >= 6) break;
  }
  return picked.join("\n").trim();
}

export function formatOutput({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase();
  const t = String(text ?? "").trim();
  if (!t) return t;

  // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ command/script/markdown Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒÙ… (markdown Ù‡Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ tool-style Ø¨Ø§Ø´Ø¯)
  if (!["command", "script", "markdown"].includes(ot)) return t;

  const lang = fenceLangFromCli(cli, ot);
  let { code, rest } = splitFirstCodeBlock(t);

  // Ø§Ú¯Ø± code block Ø¯Ø§Ø´Øª ÙˆÙ„ÛŒ Ø¯Ø§Ø®Ù„Ø´ ØªÙˆØ¶ÛŒØ­ Ù‡Ù… Ù‚Ø§Ø·ÛŒ Ø´Ø¯Ù‡ØŒ Ø®Ø·ÙˆØ· ØºÛŒØ± command Ø±Ø§ Ø­Ø°Ù Ú©Ù†
  if (code) {
    const clean = code
      .split("\n")
      .map(x => x.trimRight())
      .filter(Boolean)
      .filter(l => looksLikeCommand(l) || l.startsWith("#"));
    code = clean.join("\n").trim();
  }

  // Ø§Ú¯Ø± code Ø®Ø§Ù„ÛŒ Ø´Ø¯ ÛŒØ§ Ø§ØµÙ„Ø§Ù‹ code block Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ù…ØªÙ† Ø­Ø¯Ø³ Ø¨Ø²Ù†
  if (!code) {
    code = guessCommandFromText(t);
    if (!rest) {
      // Ø§Ú¯Ø± code Ø±Ø§ Ø§Ø² Ù…ØªÙ† Ø­Ø¯Ø³ Ø²Ø¯ÛŒÙ…ØŒ rest Ø±Ø§ Ú©Ù„ Ù…ØªÙ† Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ… (Ø¨Ù‡ØªØ± Ø§Ø² Ø­Ø°Ù Ù…Ø­ØªÙˆØ§)
      rest = t;
    }
    // Ø§Ú¯Ø± rest Ø´Ø§Ù…Ù„ Ù‡Ù…Ø§Ù† command Ø¨ÙˆØ¯ØŒ ØªÙ„Ø§Ø´ Ú©Ù† Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒ ØªØ§ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø´ÙˆØ¯
    if (code && rest) {
      const escaped = code.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      rest = rest.replace(new RegExp("^" + escaped + "\\s*", "m"), "").trim();
    }
  }

  // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² command Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¯Ø³Øª Ù†Ø²Ù†
  if (!code) return t;

  // Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ: Ø§ÙˆÙ„ code fenceØŒ Ø¨Ø¹Ø¯ Ø¨Ø§Ù‚ÛŒ Ù…ØªÙ†
  const fenced = `\`\`\`${lang}\n${code}\n\`\`\``;
  return rest ? `${fenced}\n\n${rest}` : fenced;
}

// Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ importÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
export const formatToolResponse = formatOutput;

================================================================================
FILE: .ccg_backups/generator_toolstyle_lock/20260103_042523/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// Generator output must feel like a DevOps tool (not chatty).
// - Always start with ONE fenced code block (command/script).
// - Preserve/structure the rest as: Explanation / Warnings / Alternatives.
// - Keep compatible exports: formatOutput + formatToolResponse

function fenceLangFromCli(cli = "bash") {
  const c = String(cli || "").toLowerCase();
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { code: "", rest: t };
  const code = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { code, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  // reject obvious prose
  if (s.length > 160) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  // starts with common shells/tools or sudo
  if (/^(sudo\s+)?([a-zA-Z0-9._-]+)(\s+|$)/.test(s)) return true;
  return false;
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  if (!t) return "";
  const lines = t.split("\n").map(x => x.trim()).filter(Boolean);

  // prefer first "command-like" line
  for (const ln of lines) {
    if (looksLikeCommand(ln)) return ln;
  }

  // common hard fallbacks
  // (minimal + safe, doesn't execute anything)
  const low = t.toLowerCase();
  if (low.includes("restart") && (low.includes("linux") || /[\u0600-\u06FF]/.test(t))) return "sudo reboot";
  return "";
}

function pickHeadings(lang = "fa") {
  const fa = String(lang || "").toLowerCase().startsWith("fa");
  return fa
    ? { exp: "## ØªÙˆØ¶ÛŒØ­", warn: "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", alt: "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§" }
    : { exp: "## Explanation", warn: "## Warnings", alt: "## Alternatives" };
}

function extractSections(rest, lang) {
  const { exp, warn, alt } = pickHeadings(lang);
  const t = String(rest || "").trim();
  if (!t) return { explanation: "", warnings: "", alternatives: "" };

  // If model already produced headings, keep them as-is (just return raw rest).
  // We'll avoid double-formatting.
  const hasAnyHeading =
    t.includes("## Explanation") || t.includes("## Warnings") || t.includes("## Alternatives") ||
    t.includes("## ØªÙˆØ¶ÛŒØ­") || t.includes("## Ù‡Ø´Ø¯Ø§Ø±") || t.includes("## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†");
  if (hasAnyHeading) return { raw: t };

  // Otherwise treat rest as explanation
  return { explanation: t, warnings: "", alternatives: "" };
}

function buildMarkdown({ outputType, code, rest, cli, lang }) {
  const ot = String(outputType || "").toLowerCase();
  const fence = fenceLangFromCli(cli);

  // command-only: keep first command-like line
  if (ot === "command") {
    const firstLine = (code || "").split("\n").map(x => x.trim()).filter(Boolean)[0] || guessCommandFromText(rest) || "";
    return `\`\`\`${fence}\n${firstLine}\n\`\`\``.trim();
  }

  // script: keep full code (but still fenced)
  // markdown: code + sections
  const fixedCode = (code || "").trim() || guessCommandFromText(rest) || "";
  const { exp, warn, alt } = pickHeadings(lang);
  const sec = extractSections(rest, lang);

  let out = `\`\`\`${fence}\n${fixedCode}\n\`\`\``.trim();

  if (sec.raw) {
    out += `\n\n${sec.raw}`;
    return out.trim();
  }

  if (sec.explanation) out += `\n\n${exp}\n${sec.explanation}`;
  if (sec.warnings) out += `\n\n${warn}\n${sec.warnings}`;
  if (sec.alternatives) out += `\n\n${alt}\n${sec.alternatives}`;

  return out.trim();
}

export function formatToolResponse({ outputType, text, cli = "bash", lang = "fa" }) {
  const t = String(text ?? "").trim();
  const { code, rest } = splitFirstCodeBlock(t);

  // If model mistakenly put explanation inside the code fence, rest will be empty.
  // In that case, try to split by first blank line as a fallback.
  let codeFixed = code;
  let restFixed = rest;

  if (codeFixed && !restFixed) {
    const parts = codeFixed.split(/\n\s*\n/);
    if (parts.length >= 2) {
      const maybeCmd = parts[0].trim();
      const maybeRest = parts.slice(1).join("\n\n").trim();
      // only if first part looks command-ish
      if (looksLikeCommand(maybeCmd)) {
        codeFixed = maybeCmd;
        restFixed = maybeRest;
      }
    }
  }

  return buildMarkdown({ outputType, code: codeFixed, rest: restFixed, cli, lang });
}

// Backward compatible alias
export function formatOutput(opts) {
  return formatToolResponse(opts);
}

================================================================================
FILE: .ccg_backups/HARD_LOCK_CONTRACT_20260106_064240/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/HARD_LOCK_CONTRACT_20260106_064240/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo, useState } from "react";

function CopyBtn({ text }) {
  const [ok, setOk] = useState(false);
  async function copy() {
    try {
      await navigator.clipboard.writeText(String(text || ""));
      setOk(true);
      setTimeout(() => setOk(false), 900);
    } catch {
      setOk(false);
    }
  }
  return (
    <button onClick={copy} className="ccg-btn px-3 py-1 text-xs" type="button">
      {ok ? "Ú©Ù¾ÛŒ Ø´Ø¯" : "Ú©Ù¾ÛŒ"}
    </button>
  );
}

function CodeBlock({ lang = "bash", code = "" }) {
  const c = String(code || "").trim();
  return (
    <div className="ccg-card p-4">
      <div className="flex items-center justify-between mb-2">
        <div className="text-xs text-slate-500 dark:text-slate-300/70">{lang}</div>
        <CopyBtn text={c} />
      </div>
      <pre className="prose max-w-none overflow-auto text-sm">
        <code>{c}</code>
      </pre>
    </div>
  );
}

export default function ToolResult({ tool }) {
  const t = tool || {};
  const primary = t.primary || {};
  const warnings = Array.isArray(t.warnings) ? t.warnings : [];
  const alternatives = Array.isArray(t.alternatives) ? t.alternatives.slice(0, 3) : [];

  const lang = primary.lang || "bash";
  const primaryCmd = String(primary.command || "").trim();

  const expl = String(t.explanation || "").trim();

  const warnText = useMemo(() => {
    if (!warnings.length) return [];
    return warnings.map((x) => String(x).trim()).filter(Boolean);
  }, [warnings]);

  return (
    <div className="space-y-5">
      {/* Primary */}
      <div>
        <div className="text-sm font-semibold mb-2">Ø®Ø±ÙˆØ¬ÛŒ</div>
        <CodeBlock lang={lang} code={primaryCmd} />
      </div>

      {/* Explanation */}
      <div>
        <div className="text-sm font-semibold mb-2">ØªÙˆØ¶ÛŒØ­</div>
        <div className="ccg-card p-4 text-sm leading-7">
          {expl || "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."}
        </div>
      </div>

      {/* Warnings */}
      <div>
        <div className="text-sm font-semibold mb-2">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
        <div className="ccg-card p-4 text-sm leading-7 border border-red-500/40 bg-red-500/5">
          {warnText.length ? (
            <ul className="list-disc pr-5 space-y-1">
              {warnText.map((w, i) => (
                <li key={i}>{w}</li>
              ))}
            </ul>
          ) : (
            <div>Ù‡Ø´Ø¯Ø§Ø± Ø®Ø§ØµÛŒ Ú¯Ø²Ø§Ø±Ø´ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
          )}
        </div>
      </div>

      {/* Alternatives */}
      <div>
        <div className="text-sm font-semibold mb-2">Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§</div>
        <div className="space-y-3">
          {alternatives.map((a, i) => (
            <div key={i} className="space-y-2">
              <div className="text-xs text-slate-500 dark:text-slate-300/70">
                {String(a?.note || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†").trim()}
              </div>
              <CodeBlock lang={lang} code={String(a?.command || "").trim()} />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/HARD_LOCK_CONTRACT_20260106_064240/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… CCG Tool Contract (LOCKED)
// Produces:
//   tool: { primary{command,lang}, explanation, warnings[], alternatives[{command,note}*3] }
//   markdown: string (stable template)
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 200) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  return /^(sudo\s+)?[a-zA-Z0-9._:-]+(\s+|$)/.test(s);
}

function normalizePrimaryCommand(rawText) {
  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  const fromFence = (codeRaw || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromFence.length) return { command: fromFence.join("\n"), rest };

  const fromText = String(rawText || "")
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .filter(looksLikeCommand);

  if (fromText.length) return { command: fromText[0], rest };
  return { command: "", rest };
}

function ensure3Alts(alts, fallbackCmd, os, cli) {
  const out = Array.isArray(alts) ? alts.filter(Boolean) : [];
  while (out.length < 3) {
    out.push({ command: fallbackCmd || "", note: "Ú¯Ø²ÛŒÙ†Ù‡â€ŒÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });
  }
  return out.slice(0, 3);
}

function defaultWarnings(os, cli, userRequest) {
  const o = String(os || "").toLowerCase();
  const c = String(cli || "").toLowerCase();
  const req = String(userRequest || "").toLowerCase();
  const w = [];
  w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…ÙˆØ§Ø±Ø¯ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Save Ú©Ù†ÛŒØ¯.");
  if (req.includes("shutdown") || req.includes("Ø®Ø§Ù…ÙˆØ´") || req.includes("reboot") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª")) {
    w.push("Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH/Remote Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.");
    w.push("Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.");
  } else {
    w.push("Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ ProductionØŒ Ø±ÙˆÛŒ Ù…Ø­ÛŒØ· ØªØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.");
    w.push("Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Admin/sudo Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø· Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.");
  }
  if (o === "network" || req.includes("cisco") || req.includes("mikrotik") || req.includes("forti")) {
    w.unshift("Ø±ÙˆÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø´Ø¨Ú©Ù‡ØŒ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² config Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯ Ùˆ Ø²Ù…Ø§Ù† maintenance Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.");
  }
  if (c.includes("cmd")) {
    // ÙˆÛŒÙ†Ø¯ÙˆØ² Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ sudo Ù†Ø¯Ø§Ø±Ø¯
    // keep generic warning
  }
  return w.slice(0, 3);
}

// Try parse JSON tool payload if model returned it
function tryParseJsonTool(text) {
  const t = String(text || "").trim();
  if (!t.startsWith("{")) return null;
  try {
    const obj = JSON.parse(t);
    return obj && typeof obj === "object" ? obj : null;
  } catch {
    return null;
  }
}

function renderMarkdown(tool) {
  const p = tool?.primary || {};
  const primaryFence = `\`\`\`${p.lang || "bash"}\n${p.command || ""}\n\`\`\``;

  const expl = tool?.explanation ? String(tool.explanation).trim() : "";
  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];

  const warnLines = warnings.length ? warnings.map((x) => `- ${x}`).join("\n") : "- (Ù†Ø¯Ø§Ø±Ø¯)";
  const altBlocks = alts
    .slice(0, 3)
    .map((a) => {
      const note = String(a?.note || "").trim() || "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†";
      const cmd = String(a?.command || "").trim();
      return `- ${note}\n\n\`\`\`${p.lang || "bash"}\n${cmd}\n\`\`\``;
    })
    .join("\n\n");

  return `${primaryFence}\n\n## ØªÙˆØ¶ÛŒØ­\n${expl || "(ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª)"}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altBlocks || "- (Ù†Ø¯Ø§Ø±Ø¯)"}`;
}

export function formatToolResponse({
  text,
  cli = "bash",
  os = "linux",
  userRequest = "",
  outputType = "command", // command|python
  lang = "fa",
  knowledgeLevel = "beginner",
} = {}) {
  const cliLang = fenceLangFromCli(cli, outputType);

  // (A) If model returned strict JSON, trust it (but normalize)
  const parsed = tryParseJsonTool(text);
  if (parsed?.primary?.command) {
    const tool = {
      primary: { command: String(parsed.primary.command).trim(), lang: parsed.primary.lang || cliLang },
      explanation: String(parsed.explanation || "").trim(),
      warnings: Array.isArray(parsed.warnings) ? parsed.warnings.map(String) : [],
      alternatives: Array.isArray(parsed.alternatives) ? parsed.alternatives : [],
    };
    tool.warnings = tool.warnings.filter(Boolean).slice(0, 5);
    tool.alternatives = ensure3Alts(tool.alternatives, tool.primary.command, os, cli);
    const markdown = renderMarkdown(tool);
    return { tool, markdown };
  }

  // (B) Otherwise parse from markdown-ish text
  const { command, rest } = normalizePrimaryCommand(text);
  const warnings = defaultWarnings(os, cli, userRequest);

  // Simple explanation extraction: first non-empty prose chunk from rest
  const expl = String(rest || "").split("\n").map((x) => x.trim()).filter(Boolean).slice(0, 6).join("\n");
  const tool = {
    primary: { command: command || "", lang: cliLang },
    explanation: expl || (lang === "fa" ? "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯." : "This command performs the primary action for your request."),
    warnings,
    alternatives: ensure3Alts([], command, os, cli),
  };

  // If no primary command, keep template but empty command
  const markdown = renderMarkdown(tool);
  return { tool, markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/outputFormatter_rescue/20260103_043745/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// CCG Tool-Style Post-Processor (Generator)
// Guarantees:
// 1) FIRST thing is exactly ONE fenced code block for command/script.
// 2) Code fence contains ONLY commands (no prose inside).
// 3) Always includes sections: ØªÙˆØ¶ÛŒØ­ / Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ / Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§ (if missing -> filled).
// 4) Adds safe, standard warnings/alternatives for sensitive commands (reboot/shutdown/ufw/rm -rf/...).
//
// Keep backward-compatible exports:
// - formatOutput (newer)
// - formatToolResponse (older imports)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "bat";
  return "bash";
}

function hasFaChars(s) {
  return /[\u0600-\u06FF]/.test(String(s || ""));
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

// Extract ONLY command lines from inside a messy code block
function normalizeCodeToCommands(codeRaw) {
  const lines = String(codeRaw || "")
    .split("\n")
    .map((x) => x.replace(/\r/g, "").trimEnd());

  const out = [];
  for (let i = 0; i < lines.length; i++) {
    const line = (lines[i] || "").trim();
    if (!line) {
      // allow blank line only if we already started collecting commands and previous ends with "\"
      continue;
    }
    // stop if we hit Persian / obvious prose inside the fence
    if (hasFaChars(line)) break;
    if (/[.ØŒØ›!?]$/.test(line)) break;
    if (/^(Ø¨Ø±Ø§ÛŒ|ØªÙˆØ¶ÛŒØ­|Ù‡Ø´Ø¯Ø§Ø±|Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†)/.test(line)) break;

    // accept command-like lines
    out.push(line);

    // stop after a few lines (avoid dragging explanations)
    if (out.length >= 6) break;

    // if line ends with "\" or "&&" or "|" we allow next line, otherwise for single command we can stop early
    const cont = /\\\s*$/.test(line) || /\&\&\s*$/.test(line) || /\|\s*$/.test(line);
    if (!cont && out.length >= 1) {
      // most of your generator cases are single command; keep it tight
      break;
    }
  }
  return out.join("\n").trim();
}

function guessCommandFromText(text) {
  const t = String(text ?? "").trim();
  if (!t) return "";
  // first non-empty line
  const lines = t.split("\n").map((x) => x.trim()).filter(Boolean);
  if (!lines.length) return "";
  // pick first line that looks like command
  for (const line of lines) {
    if (line.length > 160) continue;
    if (hasFaChars(line)) continue;
    if (/[.ØŒØ›!?]$/.test(line)) continue;
    if (/^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(line)) return line;
  }
  return "";
}

function ensureSection(md, titleFa, titleEn) {
  const has =
    new RegExp(`(^|\\n)\\s*##\\s*${escapeRegExp(titleFa)}\\s*(\\n|$)`, "i").test(md) ||
    (titleEn ? new RegExp(`(^|\\n)\\s*##\\s*${escapeRegExp(titleEn)}\\s*(\\n|$)`, "i").test(md) : false);

  if (has) return md;
  // append missing section with placeholder
  return (md ? md + "\n\n" : "") + `## ${titleFa}\n- Ù†Ø¯Ø§Ø±Ø¯`;
}

function escapeRegExp(s) {
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function enrichByHeuristics({ cmd, md }) {
  const c = String(cmd || "").trim();
  let out = String(md || "").trim();

  // Add smart defaults for sensitive ops
  if (/\b(reboot|shutdown)\b/i.test(c) || /\bsystemctl\s+reboot\b/i.test(c)) {
    // ensure warnings section exists
    out = ensureSection(out, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Warnings");
    // append reboot-specific warnings if not already mentioned
    if (!/SSH|Ø±ÛŒÙ…ÙˆØª|remote/i.test(out)) {
      out = out.replace(/## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§[\s\S]*?(?=\n## |\s*$)/, (block) => {
        // if placeholder only, replace; else append
        let b = block.trim();
        const hasPlaceholder = /- Ù†Ø¯Ø§Ø±Ø¯\s*$/.test(b);
        const add = [
          "- Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±ØªØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†.",
          "- Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH/Ø±ÛŒÙ…ÙˆØª Ù‡Ø³ØªÛŒØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ø±ØªØ¨Ø§Ø· Ù‚Ø·Ø¹ Ø´ÙˆØ¯Ø› Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø±ÛŒ.",
          "- Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù‚Ø·Ø¹ Ø´ÙˆÙ†Ø¯Ø› Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·."
        ].join("\n");
        if (hasPlaceholder) return "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n" + add + "\n";
        return b + "\n" + add + "\n";
      });
    }

    // ensure alternatives section exists and add standard alternatives
    out = ensureSection(out, "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "Alternatives");
    if (!/shutdown\s+-r|systemctl\s+reboot|\breboot\b/i.test(out)) {
      out = out.replace(/## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§[\s\S]*?(?=\n## |\s*$)/, (block) => {
        let b = block.trim();
        const hasPlaceholder = /- Ù†Ø¯Ø§Ø±Ø¯\s*$/.test(b);
        const add = [
          "- `sudo shutdown -r now` (Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ)",
          "- `sudo systemctl reboot` (Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ systemd)",
          "- `sudo reboot` (Ø³Ø§Ø¯Ù‡ Ùˆ Ø±Ø§ÛŒØ¬)"
        ].join("\n");
        if (hasPlaceholder) return "## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n" + add + "\n";
        return b + "\n" + add + "\n";
      });
    }
  }

  if (/\bufw\s+(enable|disable)\b/i.test(c)) {
    out = ensureSection(out, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Warnings");
    if (!/SSH|Ù¾ÙˆØ±Øª 22|remote/i.test(out)) {
      out = out.replace(/## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§[\s\S]*?(?=\n## |\s*$)/, (block) => {
        let b = block.trim();
        const hasPlaceholder = /- Ù†Ø¯Ø§Ø±Ø¯\s*$/.test(b);
        const add = [
          "- Ø§Ú¯Ø± Ø§Ø² Ø·Ø±ÛŒÙ‚ SSH ÙˆØµÙ„ Ù‡Ø³ØªÛŒØŒ Ù‚Ø¨Ù„ Ø§Ø² ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ UFW Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ù¾ÙˆØ±Øª SSH (Ù…Ø«Ù„Ø§Ù‹ 22) allow Ø´Ø¯Ù‡ ØªØ§ Ù‚ÙÙ„ Ù†Ø´ÛŒ."
        ].join("\n");
        if (hasPlaceholder) return "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n" + add + "\n";
        return b + "\n" + add + "\n";
      });
    }
  }

  if (/\brm\s+-rf\b/i.test(c)) {
    out = ensureSection(out, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Warnings");
    if (!/ØºÛŒØ±Ù‚Ø§Ø¨Ù„|Ø¨Ø§Ø²Ú¯Ø´Øª|irreversible/i.test(out)) {
      out = out.replace(/## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§[\s\S]*?(?=\n## |\s*$)/, (block) => {
        let b = block.trim();
        const hasPlaceholder = /- Ù†Ø¯Ø§Ø±Ø¯\s*$/.test(b);
        const add = [
          "- `rm -rf` ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³ØªØ› Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ù…Ø³ÛŒØ± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø± Ú†Ú© Ú©Ù†."
        ].join("\n");
        if (hasPlaceholder) return "## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n" + add + "\n";
        return b + "\n" + add + "\n";
      });
    }
  }

  return out.trim();
}

export function formatOutput({ outputType, text, cli = "bash" }) {
  const ot = String(outputType ?? "").toLowerCase().trim();
  const raw = String(text ?? "").trim();

  if (!raw) return raw;

  // For command/script output types: we want ONLY the fenced command block.
  const wantOnlyCommand = (ot === "command" || ot === "script");

  const { codeRaw, rest } = splitFirstCodeBlock(raw);
  let cmd = "";

  if (codeRaw) {
    cmd = normalizeCodeToCommands(codeRaw);
  }
  if (!cmd) {
    // maybe AI didn't fence; guess from text
    cmd = guessCommandFromText(raw);
  }

  const lang = fenceLangFromCli(cli, ot);

  // Build base output
  const fence = cmd ? `\`\`\`${lang}\n${cmd}\n\`\`\`` : "";

  if (wantOnlyCommand) {
    return fence || raw; // fallback to raw if no command extracted
  }

  // For markdown: keep the rest, but ensure required sections exist
  let body = String(rest || "").trim();

  // If rest is empty, try to keep any prose that was inside the code fence (but outside command lines)
  // (we don't have it separately; keep minimal)
  if (!body) body = "";

  // Ensure sections
  body = ensureSection(body, "ØªÙˆØ¶ÛŒØ­", "Explanation");
  body = ensureSection(body, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Warnings");
  body = ensureSection(body, "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "Alternatives");

  // Light enrichment for sensitive commands
  body = enrichByHeuristics({ cmd, md: body });

  // Final
  if (!fence) return body || raw;
  return `${fence}\n\n${body}`.trim();
}

// Backward compatible alias (some routes import this name)
export function formatToolResponse(args) {
  return formatOutput(args);
}

================================================================================
FILE: .ccg_backups/fix_t_before_init_20260108_062808/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";

// local storage keys
const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom OS)" },
];

const OUTPUT_TYPES = [
  { value: "tool", labelFa: "Tool (Ú©Ø§Ù…Ù„)", labelEn: "Tool (Full)" },
  { value: "command", labelFa: "Command (ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±)", labelEn: "Command (Commands only)" },
  { value: "python", labelFa: "Python", labelEn: "Python" },
];

const VERBOSITY = [
  { value: "brief", labelFa: "Ø®Ù„Ø§ØµÙ‡", labelEn: "Brief" },
  { value: "normal", labelFa: "Ù†Ø±Ù…Ø§Ù„", labelEn: "Normal" },
  { value: "detailed", labelFa: "Ø¬Ø²Ø¦ÛŒ", labelEn: "Detailed" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  windows: ["powershell", "cmd"],
  mac: ["zsh", "bash"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "powershell", "cmd"],
};

const LINUX_DISTROS = ["Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","Alpine","Kali"];
const WINDOWS_FLAVORS = ["Windows 10","Windows 11","Windows Server 2019","Windows Server 2022"];
const MAC_FLAVORS = ["macOS"];

const NETWORK_VENDORS = ["Cisco","MikroTik","FortiGate","Juniper","Aruba","Huawei","Generic"];
const DEVICE_TYPES_BY_VENDOR = {
  Cisco: ["switch","router","firewall"],
  MikroTik: ["router","switch"],
  FortiGate: ["firewall"],
  Juniper: ["switch","router","firewall"],
  Aruba: ["switch","controller"],
  Huawei: ["switch","router","firewall"],
  Generic: ["router","switch","firewall","appliance"],
};

function isSafeFreeText(v, min=2, max=40) {
  const s = String(v||"").trim().replace(/\s+/g," ");
  if (s.length < min || s.length > max) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

function qsToObj() {
  const q = new URLSearchParams(window.location.search);
  return {
    platform: q.get("platform") || "",
    cli: q.get("cli") || "",
    out: q.get("out") || "",
    v: q.get("v") || "",
    adv: q.get("adv") || "",
    swap: q.get("swap") || "",
    lang: q.get("lang") || "",
  };
}
function setQS(p) {
  const q = new URLSearchParams(window.location.search);
  Object.entries(p).forEach(([k,v]) => {
    if (v === "" || v == null) q.delete(k);
    else q.set(k, String(v));
  });
  const url = `${window.location.pathname}?${q.toString()}`;
  window.history.replaceState({}, "", url);
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm opacity-90">{label}</span>
      {tip ? (
        <span className="relative group">
          <button
            type="button"
            className="w-5 h-5 rounded-full border text-xs opacity-70 hover:opacity-100 dark:border-white/10"
            aria-label={`${label} help`}
          >
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-80 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  const { lang, setLang } = useLanguage();
  const isRTL = (lang === "fa");

  const t = useMemo(() => {
    const fa = {
      platform: "Ù¾Ù„ØªÙØ±Ù…",
      outputType: "Ù†ÙˆØ¹ Ø®Ø±ÙˆØ¬ÛŒ",
      cli: "Ø´Ù„ / CLI",
      verbosity: "Ø³Ø·Ø­ ØªÙˆØ¶ÛŒØ­",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "ØªÙˆØ²ÛŒØ¹ / Ù†ÙˆØ¹",
      version: "Version (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª",
      gen: "Generate",
      explain: "Explain command",
      swap: "Ø¬Ø§Ø¨Ø¬Ø§",
      errFix: "Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯:",
      tip_platform: "Ù¾Ù„ØªÙØ±Ù… Ù‡Ø¯ÙÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¢Ù† ØªÙˆÙ„ÛŒØ¯ Ø´ÙˆØ¯.",
      tip_output: "Tool: Ø®Ø±ÙˆØ¬ÛŒ Ú©Ø§Ù…Ù„. Command: ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ± + Ù‡Ø´Ø¯Ø§Ø± + Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§. Python: ÙÙ‚Ø· Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ†.",
      tip_cli: "Ø´Ù„/CLI Ù‡Ø¯Ù (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Ø®Ù„Ø§ØµÙ‡: Ú©ÙˆØªØ§Ù‡. Ù†Ø±Ù…Ø§Ù„: ØªÙˆØ¶ÛŒØ­ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯. Ø¬Ø²Ø¦ÛŒ: ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ + Ù…Ø«Ø§Ù„.",
      tip_advanced: "Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§ØªÙ Ù‡Ù…Ø§Ù† Ù¾Ù„ØªÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (Ù…Ø«Ù„Ø§Ù‹ distro Ù„ÛŒÙ†ÙˆÚ©Ø³ ÛŒØ§ Ù†ÙˆØ¹ Windows).",
      tip_custom: "Ø§Ú¯Ø± Ø³ÛŒØ³ØªÙ…/Ø´Ù„ Ø®Ø§Øµ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø³ÙØ§Ø±Ø´ÛŒ Ú©Ù†ÛŒØ¯. ÙÙ‚Ø· Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      placeholder: "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ÙˆØ§Ø¶Ø­ Ø¨Ù†ÙˆÛŒØ³ (Ù‡Ø¯Ù + Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§). Ù…Ø«Ø§Ù„: Â«Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø³ÛŒØ³ØªÙ… Ø±Ùˆ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ù†Ù…Â»",
    };
    const en = {
      platform: "Platform",
      outputType: "Output type",
      cli: "Shell / CLI",
      verbosity: "Verbosity",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "Distro / Flavor",
      version: "Version (optional)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Request",
      gen: "Generate",
      explain: "Explain command",
      swap: "Swap",
      errFix: "Fix this first:",
      tip_platform: "Target platform to generate commands for.",
      tip_output: "Tool: full output. Command: command + warnings + alternatives (no explanation). Python: python code only.",
      tip_cli: "Target shell/CLI (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Brief: short. Normal: standard. Detailed: full explanation + examples.",
      tip_advanced: "Advanced fields for the selected platform only.",
      tip_custom: "Use for custom OS/Shell. Invalid values will be blocked before sending.",
      placeholder: "Write a clear request (goal + constraints). Example: â€œRestart my systemâ€",
    };
    return isRTL ? fa : en;
  }, [isRTL]);

  // Defaults
  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");
  const [advanced, setAdvanced] = useState(false);
  const [swap, setSwap] = useState(false);

  // advanced per-platform
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [windowsFlavor, setWindowsFlavor] = useState("Windows 11");
  const [macFlavor, setMacFlavor] = useState("macOS");
  const [osVersion, setOsVersion] = useState("");

  // network
  const [vendor, setVendor] = useState("Cisco");
  const [deviceType, setDeviceType] = useState("router");

  // custom
  const [customOn, setCustomOn] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [output, setOutput] = useState("");
  const [tool, setTool] = useState(null);

  // Load persisted state
  useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      const q = qsToObj();

      const p = q.platform || saved.platform || "linux";
      const c = q.cli || saved.cli || (SHELL_BY_PLATFORM[p]?.[0] || "bash");
      const out = q.out || saved.outputType || "tool";
      const v = q.v || saved.verbosity || "normal";
      const adv = (q.adv ? q.adv === "1" : !!saved.advanced);
      const sw = (q.swap ? q.swap === "1" : !!saved.swap);

      if (q.lang) setLang(q.lang);

      setPlatform(p);
      setCli(c);
      setOutputType(out);
      setVerbosity(v);
      setAdvanced(adv);
      setSwap(sw);

      setLinuxDistro(saved.linuxDistro || "Ubuntu");
      setWindowsFlavor(saved.windowsFlavor || "Windows 11");
      setMacFlavor(saved.macFlavor || "macOS");
      setOsVersion(saved.osVersion || "");

      setVendor(saved.vendor || "Cisco");
      setDeviceType(saved.deviceType || "router");

      setCustomOn(!!saved.customOn);
      setCustomOS(saved.customOS || "");
      setCustomShell(saved.customShell || "");

      setInput(saved.input || "");
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Keep cli valid per platform
  useEffect(() => {
    const allowed = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!allowed.includes(cli)) setCli(allowed[0]);
    // If leaving network, reset vendor/deviceType
    if (platform !== "network") {
      setVendor("Cisco");
      setDeviceType("router");
    }
    // Custom only relevant on "other"
    if (platform !== "other") setCustomOn(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [platform]);

  // persist state + URL
  useEffect(() => {
    const st = {
      platform, cli, outputType, verbosity, advanced, swap,
      linuxDistro, windowsFlavor, macFlavor, osVersion,
      vendor, deviceType,
      customOn, customOS, customShell,
      input
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
    setQS({
      platform,
      cli,
      out: outputType,
      v: verbosity,
      adv: advanced ? "1" : "",
      swap: swap ? "1" : "",
      lang,
    });
  }, [platform, cli, outputType, verbosity, advanced, swap, linuxDistro, windowsFlavor, macFlavor, osVersion, vendor, deviceType, customOn, customOS, customShell, input, lang]);

  function validateBeforeSend() {
    const errs = [];

    if (!input.trim()) errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª." : "Request is empty.");

    // outputType strict
    if (!["tool","command","python"].includes(outputType)) errs.push("Invalid output type.");

    // platform strict
    if (!["linux","windows","mac","network","other"].includes(platform)) errs.push("Invalid platform.");

    // Custom validation (block before API)
    if (platform === "other" && customOn) {
      if (!isSafeFreeText(customOS, 2, 40)) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom OS.");
      if (!isSafeFreeText(customShell, 2, 20)) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom Shell/CLI.");
    }

    // Advanced validation: only for selected platform
    if (advanced && platform === "linux") {
      if (linuxDistro && !LINUX_DISTROS.includes(linuxDistro)) errs.push(isRTL ? "Distro Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid distro.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }
    if (advanced && platform === "windows") {
      if (windowsFlavor && !WINDOWS_FLAVORS.includes(windowsFlavor)) errs.push(isRTL ? "Windows Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Windows flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version/Build Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version/build (optional).");
    }
    if (advanced && platform === "mac") {
      if (macFlavor && !MAC_FLAVORS.includes(macFlavor)) errs.push(isRTL ? "macOS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid macOS flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    // Network validation always available in normal mode (not hidden)
    if (platform === "network") {
      if (!NETWORK_VENDORS.includes(vendor)) errs.push(isRTL ? "Vendor Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid vendor.");
      const dt = DEVICE_TYPES_BY_VENDOR[vendor] || [];
      if (!dt.includes(deviceType)) errs.push(isRTL ? "Device type Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid device type.");
    }

    return errs;
  }

  function computeOS() {
    // version optional, but don't force users to fill it
    if (platform === "linux") return advanced ? (osVersion ? `${linuxDistro} ${osVersion}` : linuxDistro) : "linux";
    if (platform === "windows") return advanced ? (osVersion ? `${windowsFlavor} ${osVersion}` : windowsFlavor) : "windows";
    if (platform === "mac") return advanced ? (osVersion ? `${macFlavor} ${osVersion}` : macFlavor) : "mac";
    if (platform === "network") return "network";
    if (platform === "other") return customOn ? customOS.trim() : "other";
    return platform;
  }

  function payloadFor(mode="generate", targetCommand="") {
    const base = {
      mode,
      lang,
      user_request: input.trim(),
      outputType,
      verbosity,
    };

    // custom ON => send ONLY custom fields (no extra)
    if (platform === "other" && customOn) {
      return {
        ...base,
        platform: "other",
        os: customOS.trim(),
        cli: customShell.trim(),
        vendor: "",
        deviceType: "general",
        ...(mode === "explain" ? { targetCommand } : {}),
      };
    }

    // normal platforms
    const pl = platform;
    const os = computeOS();
    const c = cli;

    return {
      ...base,
      platform: pl,
      os,
      cli: c,
      vendor: pl === "network" ? vendor : "",
      deviceType: pl === "network" ? deviceType : "general",
      ...(mode === "explain" ? { targetCommand } : {}),
    };
  }

  async function runGenerate() {
    const errs = validateBeforeSend();
    if (errs.length) { setErr(`${t.errFix} ${errs[0]}`); return; }

    setErr("");
    setLoading(true);
    setOutput("");
    setTool(null);

    try {
      const res = await callCCG(payloadFor("generate"));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  async function runExplain() {
    // explain should use last produced tool.primary.command if possible
    const cmd = tool?.primary?.command ? String(tool.primary.command) : "";
    if (!cmd.trim()) { setErr(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø¯Ø³ØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯." : "Generate a command first."); return; }

    setErr("");
    setLoading(true);
    try {
      const res = await callCCG(payloadFor("explain", cmd.trim()));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  const cliOptions = SHELL_BY_PLATFORM[platform] || ["bash"];

  const leftPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-2" : "order-1") : (isRTL ? "order-1" : "order-2"))}`;
  const rightPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-1" : "order-2") : (isRTL ? "order-2" : "order-1"))}`;

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4 justify-between">

            <div className="flex flex-wrap items-center gap-3 sm:gap-4">
              <FieldLabel label={t.platform} tip={t.tip_platform} />
              <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
                {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>

              <FieldLabel label={t.cli} tip={t.tip_cli} />
              <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm">
                {cliOptions.map(v => <option key={v} value={v}>{v}</option>)}
              </select>

              <FieldLabel label={t.outputType} tip={t.tip_output} />
              <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
                {OUTPUT_TYPES.map(o => (
                  <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>
                ))}
              </select>

              <FieldLabel label={t.verbosity} tip={t.tip_verbosity} />
              <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
                {VERBOSITY.map(o => <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>)}
              </select>

              <div className="flex items-center gap-2">
                <input id="ccg-adv" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
                <label htmlFor="ccg-adv" className="text-sm opacity-90">{t.advanced}</label>
              </div>

              <button type="button" className="ccg-btn text-sm" onClick={()=>setSwap(s=>!s)}>
                {t.swap}
              </button>
            </div>

            <div className="flex items-center gap-2">
              <button type="button" className="ccg-btn text-sm" onClick={()=>setLang(isRTL ? "en" : "fa")}>
                {isRTL ? "EN" : "FA"}
              </button>
            </div>

          </div>

          {/* Advanced row (platform-specific only) */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] p-4">
              <div className="flex flex-wrap items-center gap-4 justify-between">
                <div className="text-sm opacity-80">{t.tip_advanced}</div>

                {platform === "other" ? (
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customOn} onChange={(e)=>setCustomOn(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">{t.custom}</label>
                  </div>
                ) : null}
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                {platform === "linux" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select w-full">
                        {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                    </div>
                  </>
                ) : null}

                {platform === "windows" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={windowsFlavor} onChange={(e)=>setWindowsFlavor(e.target.value)} className="ccg-select w-full">
                        {WINDOWS_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "mac" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={macFlavor} onChange={(e)=>setMacFlavor(e.target.value)} className="ccg-select w-full">
                        {MAC_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "network" ? (
                  <>
                    <div>
                      <FieldLabel label={t.vendor} />
                      <select value={vendor} onChange={(e)=>{ setVendor(e.target.value); setDeviceType((DEVICE_TYPES_BY_VENDOR[e.target.value]||["router"])[0]); }} className="ccg-select w-full">
                        {NETWORK_VENDORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.deviceType} />
                      <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select w-full">
                        {(DEVICE_TYPES_BY_VENDOR[vendor] || []).map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                  </>
                ) : null}

                {platform === "other" && customOn ? (
                  <>
                    <div>
                      <FieldLabel label="Custom OS" tip={t.tip_custom} />
                      <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                    </div>
                    <div>
                      <FieldLabel label="Custom Shell/CLI" tip={t.tip_custom} />
                      <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ tcsh" : "e.g. tcsh"} />
                    </div>
                  </>
                ) : null}
              </div>
            </div>
          ) : null}

        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          {/* Request */}
          <div className={rightPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{t.request}</h2>
            <textarea
              className="ccg-textarea w-full min-h-[200px]"
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              placeholder={t.placeholder}
            />
            {err ? (
              <div className="ccg-error mt-3">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{err}</div>
              </div>
            ) : null}

            <div className="mt-4 flex items-center gap-3 justify-end">
              <button className="ccg-btn" type="button" disabled={loading} onClick={runExplain}>
                {t.explain}
              </button>
              <button className="ccg-btn primary" type="button" disabled={loading} onClick={runGenerate}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§..." : "Running...") : t.gen}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={leftPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>
            {outputType === "tool" && tool ? (
              <ToolResult tool={tool} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_tool_json_backend_first_20260108_062117/client/src/components/ui/ToolResult.jsx
================================================================================

import { useMemo, useState } from "react";

function CopyBtn({ text }) {
  const [ok, setOk] = useState(false);

  const copy = async () => {
    try {
      await navigator.clipboard.writeText(text || "");
      setOk(true);
      setTimeout(() => setOk(false), 900);
    } catch {}
  };

  return (
    <button className="ccg-btn text-xs px-3 py-1" type="button" onClick={copy}>
      {ok ? "Copied" : "Copy"}
    </button>
  );
}

function CodeBlock({ lang, code }) {
  return (
    <div className="rounded-xl border border-[var(--border)] overflow-hidden">
      <div className="flex items-center justify-between px-3 py-2 text-xs bg-white/5">
        <span className="opacity-80">lang: {lang || "bash"}</span>
        <CopyBtn text={code} />
      </div>
      <pre className="p-3 text-sm overflow-auto"><code>{code}</code></pre>
    </div>
  );
}

export default function ToolResult({ tool }) {
  const safe = useMemo(() => {
    const t = (tool && typeof tool === "object") ? tool : {};
    const primary = (t.primary && typeof t.primary === "object") ? t.primary : {};
    return {
      primary: { command: String(primary.command || ""), lang: String(primary.lang || "bash") },
      explanation: typeof t.explanation === "string" ? t.explanation : "",
      warnings: Array.isArray(t.warnings) ? t.warnings : [],
      alternatives: Array.isArray(t.alternatives) ? t.alternatives : []
    };
  }, [tool]);

  const cmd = safe.primary.command.trim();

  return (
    <div className="space-y-6">
      <div>
        <div className="text-sm font-semibold mb-2">Command</div>
        <CodeBlock lang={safe.primary.lang} code={cmd || 'echo "No command produced"'} />
      </div>

      {safe.explanation?.trim() ? (
        <div>
          <div className="text-sm font-semibold mb-2">Explanation</div>
          <div className="text-sm leading-7 opacity-90 whitespace-pre-wrap">{safe.explanation}</div>
        </div>
      ) : null}

      {safe.warnings?.length ? (
        <div>
          <div className="text-sm font-semibold mb-2">Warnings</div>
          <ul className="list-disc pl-5 text-sm leading-7 opacity-90">
            {safe.warnings.map((w, i) => <li key={i}>{w}</li>)}
          </ul>
        </div>
      ) : null}

      {safe.alternatives?.length ? (
        <div>
          <div className="text-sm font-semibold mb-2">Alternatives</div>
          <div className="space-y-4">
            {safe.alternatives.slice(0,3).map((a, i) => (
              <div key={i} className="space-y-2">
                {a?.note ? <div className="text-xs opacity-75">- {a.note}</div> : null}
                <CodeBlock lang={safe.primary.lang} code={String(a.command || "").trim()} />
              </div>
            ))}
          </div>
        </div>
      ) : null}
    </div>
  );
}

================================================================================
FILE: .ccg_backups/fix_tool_json_backend_first_20260108_062117/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Stable formatter for CCG
// outputType:
//  - tool: command + explanation + warnings + alternatives
//  - command: command + warnings + alternatives (NO explanation)
//  - python: python code only
//
// Returns: { tool, markdown, output }  (output == markdown)

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh" || c === "powershell") return "powershell";
  if (c.includes("cmd") || c === "cmd") return "cmd";
  return "bash";
}

function tryParseJSONMaybe(text) {
  const t = String(text || "").trim();
  if (!t) return null;
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try { return JSON.parse(t); } catch { return null; }
}

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function firstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  return m ? String(m[1] ?? "").trim() : "";
}

function pickSection(text, titleFa, titleEn) {
  const t = String(text ?? "");
  const re = new RegExp(
    String.raw`##\s*(?:${titleFa}|${titleEn})\s*\n([\s\S]*?)(?=\n##\s|\s*$)`,
    "m"
  );
  const m = t.match(re);
  return m ? String(m[1] ?? "").trim() : "";
}

function parseBullets(block) {
  if (!block) return [];
  return block
    .split("\n")
    .map(l => l.trim())
    .filter(l => l.startsWith("- "))
    .map(l => l.replace(/^- /, "").trim())
    .filter(Boolean);
}

function parseAlternatives(block) {
  // Expect pattern:
  // - note
  // ```bash
  // cmd
  // ```
  if (!block) return [];
  const out = [];
  const lines = block.split("\n");
  let i = 0;
  while (i < lines.length) {
    const line = lines[i].trim();
    let note = "";
    if (line.startsWith("- ")) {
      note = line.replace(/^- /, "").trim();
      i++;
    }
    // find code fence
    while (i < lines.length && !lines[i].trim().startsWith("```")) i++;
    if (i >= lines.length) break;
    // open fence
    i++;
    const cmdLines = [];
    while (i < lines.length && !lines[i].trim().startsWith("```")) {
      cmdLines.push(lines[i]);
      i++;
    }
    // close fence
    while (i < lines.length && !lines[i].trim().startsWith("```")) i++;
    if (i < lines.length && lines[i].trim().startsWith("```")) i++;
    const command = cmdLines.join("\n").trim();
    if (command) out.push({ command, note });
  }
  return out.slice(0, 5);
}

function toToolObject({ rawText, cli, forcedCommand }) {
  const t = String(rawText ?? "").trim();

  // If AI returned JSON of tool/markdown, unwrap
  const maybe = tryParseJSONMaybe(t);
  if (maybe && typeof maybe === "object") {
    if (maybe.tool && typeof maybe.tool === "object") {
      const tool = maybe.tool;
      if (forcedCommand) tool.primary = { ...(tool.primary || {}), command: forcedCommand };
      return tool;
    }
  }

  // Otherwise parse markdown-ish sections
  const lang = fenceLangFromCli(cli, "tool");
  const code = firstCodeBlock(t);
  const primaryCommand = forcedCommand || (code ? stripOuterFences("```x\n"+code+"\n```") : "");

  const explanation = pickSection(t, "ØªÙˆØ¶ÛŒØ­", "Explanation");
  const warningsBlock = pickSection(t, "Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", "Warnings");
  const altsBlock = pickSection(t, "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§", "Alternatives");

  const warnings = parseBullets(warningsBlock);
  const alternatives = parseAlternatives(altsBlock);

  return {
    primary: { command: primaryCommand || "", lang },
    explanation: explanation || "",
    warnings: warnings || [],
    alternatives: alternatives || []
  };
}

function buildMarkdown({ tool, cli, outputType }) {
  const ot = String(outputType || "tool").toLowerCase();
  const lang = fenceLangFromCli(cli, ot);

  if (ot === "python") {
    const code = tool?.primary?.command ? stripOuterFences(tool.primary.command) : "";
    return `\`\`\`python\n${code || "print('No code produced')"}\n\`\`\``;
  }

  const cmd = String(tool?.primary?.command || "").trim();
  const cmdBlock = `\`\`\`${lang}\n${cmd || `echo "No command produced"`}\n\`\`\``;

  const warnLines = (tool?.warnings || []).map(w => `- ${w}`).join("\n");
  const warningsMd = warnLines ? `\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnLines}\n` : "";

  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];
  const altsMd = alts.length
    ? "\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n" + alts.slice(0,3).map(a => {
        const note = a?.note ? `- ${a.note}\n\n` : "";
        const c = String(a?.command || "").trim();
        return `${note}\`\`\`${lang}\n${c}\n\`\`\``;
      }).join("\n\n")
    : "";

  if (ot === "command") {
    // NO explanation
    return `${cmdBlock}${warningsMd}${altsMd}`.trim() + "\n";
  }

  // tool mode: include explanation
  const exp = String(tool?.explanation || "").trim();
  const expMd = exp ? `\n\n## ØªÙˆØ¶ÛŒØ­\n${exp}\n` : "\n\n## ØªÙˆØ¶ÛŒØ­\n-\n";
  return `${cmdBlock}${expMd}${warningsMd}${altsMd}`.trim() + "\n";
}

// Main
export function formatToolResponse({ rawText="", cli="bash", outputType="tool", forcedCommand="" } = {}) {
  const tool = toToolObject({ rawText, cli, forcedCommand });
  // force command in explain mode if provided
  if (forcedCommand) tool.primary = { ...(tool.primary || {}), command: forcedCommand };

  // If command/python and tool.primary.command is still empty, try salvage from rawText plain line
  if (!tool?.primary?.command) {
    const firstLine = String(rawText || "").split("\n").map(l=>l.trim()).filter(Boolean)[0] || "";
    tool.primary = { ...(tool.primary||{}), command: firstLine, lang: fenceLangFromCli(cli, outputType) };
  }

  // For python mode: treat primary.command as code body
  const markdown = buildMarkdown({ tool, cli, outputType });
  return { tool: outputType === "python" ? null : tool, markdown, output: markdown };
}

export const formatOutput = formatToolResponse;

================================================================================
FILE: .ccg_backups/day1_contract_lock/20260106_061449/client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";


// CCG_GENERATOR_OPTION1_FIX_V1
const CCG_GEN_LS_KEY = "ccg_generator_state_v1";

function stripOuterFences(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```(?:[\w-]+)?\n([\s\S]*?)```\s*$/);
  return (m ? m[1] : t).trim();
}

function toFencedBlock(text, lang) {
  const code = stripOuterFences(text);
  if (!code) return "";
  const l = (lang || "bash").toLowerCase();
  return `\`\`\`${l}\n${code}\n\`\`\``;
}

function normalizeGeneratorOutput(raw, outputType, shell) {
  const t = String(raw ?? "").trim();
  if (!t) return "";
  const ot = String(outputType ?? "").toLowerCase();
  if (ot === "command") {
    // prefer selected shell language tag, but keep it simple: bash/powershell/cmd/zsh/sh
    const lang = (shell || "bash").toLowerCase();
    return toFencedBlock(t, lang);
  }
  if (ot === "python") {
    return toFencedBlock(t, "python");
  }
  // fallback: render as-is (markdown)
  return t;
}

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
];

const SHELL_BY_PLATFORM = {
  linux: [
    { value: "bash", label: "bash" },
    { value: "zsh", label: "zsh" },
    { value: "sh", label: "sh" },
  ],
  mac: [
    { value: "zsh", label: "zsh (default)" },
    { value: "bash", label: "bash" },
  ],
  windows: [
    { value: "powershell", label: "PowerShell" },
    { value: "cmd", label: "CMD" },
  ],
};

const NETWORK_VENDORS = [
  { value: "cisco", label: "Cisco" },
  { value: "fortinet_fortigate", label: "Fortinet FortiGate" },
  { value: "mikrotik", label: "MikroTik" },
];

const DEVICE_TYPES_BY_VENDOR = {
  cisco: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
  fortinet_fortigate: [
    { value: "firewall", label: "Firewall" },
    { value: "utm", label: "UTM" },
  ],
  mikrotik: [
    { value: "router", label: "Router" },
    { value: "switch", label: "Switch" },
    { value: "firewall", label: "Firewall" },
  ],
};

export default function GeneratorPage() {
  const { t, lang } = useLanguage();

  const [platform, setPlatform] = useState("linux");
  const [outputType, setOutputType] = useState("command"); // command | python
  const [mode, setMode] = useState("learn"); // learn | operational
  const [level, setLevel] = useState("beginner"); // beginner | intermediate | expert

  const [shell, setShell] = useState("bash");
  const [vendor, setVendor] = useState(NETWORK_VENDORS[0].value);
  const [deviceType, setDeviceType] = useState(DEVICE_TYPES_BY_VENDOR[NETWORK_VENDORS[0].value][0].value);

  
  // Shared profile (Generator + Chat)
  useEffect(() => {
    try {
      const raw = localStorage.getItem("ccg_profile_v1");
      if (!raw) return;
      const p = JSON.parse(raw);
      if (p.platform) setPlatform(p.platform);
      if (p.outputType) setOutputType(p.outputType);
      if (p.mode) setMode(p.mode);
      if (p.level) setLevel(p.level);
      if (p.shell) setShell(p.shell);
      if (p.vendor) setVendor(p.vendor);
      if (p.deviceType) setDeviceType(p.deviceType);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      const p = { platform, outputType, mode, level, shell, vendor, deviceType };
      localStorage.setItem("ccg_profile_v1", JSON.stringify(p));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType]);
const [input, setInput] = useState("");
  const [output, setOutput] = useState("");

const [tool, setTool] = useState(null);
const [toolResult, setToolResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiErr, setApiErr] = useState("");

  const [swapLayout, setSwapLayout] = useState(false);

  
  // restore saved generator state (best-effort)
  useEffect(() => {
    try {
      const raw = localStorage.getItem(CCG_GEN_LS_KEY);
      if (!raw) return;
      const st = JSON.parse(raw);
      if (st?.platform) setPlatform(st.platform);
      if (st?.outputType) setOutputType(st.outputType);
      if (st?.mode) setMode(st.mode);
      if (st?.level) setLevel(st.level);
      if (st?.shell) setShell(st.shell);
      if (st?.vendor) setVendor(st.vendor);
      if (st?.deviceType) setDeviceType(st.deviceType);
      if (typeof st?.input === "string") setInput(st.input);
      if (typeof st?.swapLayout === "boolean") setSwapLayout(st.swapLayout);
      if (typeof st?.output === "string") setOutput(st.output); 
      setTool(data?.tool || null);
// restore last output too
    } catch {}
  }, []);

  // persist generator state (best-effort)
  useEffect(() => {
    try {
      const st = {
        platform,
        outputType,
        mode,
        level,
        shell,
        vendor,
        deviceType,
        input,
        swapLayout,
        output,
      };
      localStorage.setItem(CCG_GEN_LS_KEY, JSON.stringify(st));
    } catch {}
  }, [platform, outputType, mode, level, shell, vendor, deviceType, input, swapLayout, output]);
const shellOptions = useMemo(
    () => (platform === "network" ? [] : SHELL_BY_PLATFORM[platform] || []),
    [platform]
  );

  const deviceTypeOptions = useMemo(() => DEVICE_TYPES_BY_VENDOR[vendor] || [], [vendor]);

  useEffect(() => {
    if (platform === "network") return;
    const ok = shellOptions.some((o) => o.value === shell);
    if (!ok) setShell(shellOptions[0]?.value || "");
  }, [platform, shellOptions, shell]);

  useEffect(() => {
    if (platform !== "network") return;
    const ok = deviceTypeOptions.some((o) => o.value === deviceType);
    if (!ok) setDeviceType(deviceTypeOptions[0]?.value || "");
  }, [platform, vendor, deviceTypeOptions, deviceType]);

  const openErrorAnalyzer = () => {
    window.dispatchEvent(
      new CustomEvent("open-error-analyzer", {
        detail: { command: input || "", context: "" },
      })
    );
  };

  const payloadForGenerator = () => {
    const isNetwork = platform === "network";
    return {
      lang: lang || "fa",

      // important for backend
      user_request: input.trim(),

      // generator params
      outputType: outputType === "command" ? "tool" : outputType, // "command" or "python"
      knowledgeLevel: level,

      platform: isNetwork ? "network" : platform,
      os: isNetwork ? "network" : platform,
      cli: isNetwork ? "network-cli" : shell,
      vendor: isNetwork ? vendor : "",
      deviceType: isNetwork ? deviceType : "general",
    };
  };

  const generate = async () => {
    if (!input.trim() || loading) return;
    setLoading(true);
    setApiErr("");
    setOutput("");

      setTool(null);
    try {
      const res = await callCCG(payloadForGenerator());
      const md = res?.markdown || res?.result || res?.output || "";
      setOutput(normalizeGeneratorOutput(md, outputType, shell));
    } catch (e) {
      setApiErr(e?.message || (lang === "fa" ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-8">
      {/* Context Bar */}
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4">
            {/* Platform */}
            <FieldLabel label={t("platform")} tip={t("tip_platform")} />
            <select
              value={platform}
              onChange={(e) => setPlatform(e.target.value)}
              className="ccg-select text-sm"
            >
              {PLATFORM_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            {/* Output Type */}
            <FieldLabel label={t("outputType")} tip={t("tip_outputType")} />
            <div className="flex rounded-xl border border-[var(--border)] p-1">
              <Toggle active={outputType === "command"} onClick={() => setOutputType("command")}>
                {t("commandShell")}
              </Toggle>
              <Toggle active={outputType === "python"} onClick={() => setOutputType("python")}>
                {t("pythonAutomation")}
              </Toggle>
            </div>

            {/* Shell / Network vendor */}
            {platform === "network" ? (
              <>
                <FieldLabel label={t("vendor")} tip={t("tip_vendor")} />
                <select
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {NETWORK_VENDORS.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>

                <FieldLabel label={t("deviceType")} tip={t("tip_deviceType")} />
                <select
                  value={deviceType}
                  onChange={(e) => setDeviceType(e.target.value)}
                  className="ccg-select text-sm"
                >
                  {deviceTypeOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            ) : (
              <>
                <FieldLabel label={t("cliShell")} tip={t("tip_cliShell")} />
                <select
                  value={shell}
                  onChange={(e) => setShell(e.target.value)}
                  className="ccg-select text-sm"
                  disabled={outputType !== "command"}
                  title={outputType !== "command" ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„Øª Ù¾Ø§ÛŒØªÙˆÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª" : "Disabled on python output") : ""}
                >
                  {shellOptions.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
              </>
            )}

            {/* Knowledge */}

            <FieldLabel label={t("knowledge")} tip={t("tip_knowledge")} />
            <select value={level} onChange={(e) => setLevel(e.target.value)} className="ccg-select text-sm">
              <option value="beginner">{t("beginner")}</option>
              <option value="intermediate">{t("intermediate")}</option>
              <option value="expert">{t("expert")}</option>
            </select>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-10">
          {/* Input Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-2" : "order-1"}`}
          >
            <div className="mb-4 flex items-center justify-between gap-3">
              <h2 className="text-lg font-semibold">{t("inputs")}</h2>
              <button
                onClick={() => setSwapLayout((v) => !v)}
                className="ccg-btn"
                type="button"
              >
                â†” {t("swapIO")}
              </button>
            </div>

            <div className="mb-2">
              <FieldLabel label={t("request")} tip={t("tip_request")} />
            </div>

            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={t("placeholderReq")}
              className="ccg-textarea w-full h-52 sm:h-64 resize-none p-4 text-sm"
            />

            <button
              className="mt-5 sm:mt-6 w-full ccg-btn-primary py-3"
              disabled={!input.trim() || loading}
              onClick={generate}
              type="button"
            >
              {loading ? (lang === "fa" ? "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª..." : "Generating...") : t("generate")}
            </button>
          </div>

          {/* Output Card */}
          <div
            className={`ccg-card p-5 sm:p-8 ${swapLayout ? "order-1" : "order-2"}`}
          >
            <h2 className="text-lg font-semibold mb-4">{t("output")}</h2>

            {apiErr ? (
              <div className="ccg-error mb-4">
                <div className="font-semibold mb-1">{lang === "fa" ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{apiErr}</div>
              </div>
            ) : null}

            {output ? (
              tool ? <ToolResult tool={tool} /> : {tool ? <ToolResult tool={tool} /> : <SectionedMarkdown markdown={output} lang={lang} />}
            ) : (
              <div className="text-sm text-slate-500 dark:text-slate-300/70">
                {t("outputPlaceholder")}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Error Shortcut */}
      <div className="ccg-container">
        <div className="ccg-card p-5 sm:p-6 text-sm">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <span>âš ï¸ {t("errorShortcutText")}</span>
            <button
              className="ccg-btn w-full sm:w-auto"
              type="button"
              onClick={openErrorAnalyzer}
            >
              {t("openErrorAnalyzer")}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function Toggle({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      type="button"
      className={`px-4 py-2 text-sm rounded-lg transition ${
        active
          ? "bg-blue-600 text-white"
          : "text-slate-600 hover:bg-slate-100 dark:text-slate-200/80 dark:hover:bg-white/10"
      }`}
    >
      {children}
    </button>
  );
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm text-slate-700 dark:text-slate-200/80">{label}</span>
      <span className="relative group">
        <button
          type="button"
          className="w-5 h-5 rounded-full border text-xs text-slate-500 hover:bg-slate-50 dark:hover:bg-white/10 dark:border-white/10"
          aria-label={`${label} help`}
        >
          ?
        </button>
        <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-72 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
          {tip}
        </span>
      </span>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: .ccg_backups/day1_contract_lock/20260106_061449/client/src/components/ui/ToolResult.jsx
================================================================================

import React from "react";

function CopyBtn({ text }) {
  const onCopy = async () => {
    try { await navigator.clipboard.writeText(text || ""); } catch {}
  };
  return (
    <button
      onClick={onCopy}
      className="px-2 py-1 text-xs rounded-md border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800"
      type="button"
    >
      Ú©Ù¾ÛŒ
    </button>
  );
}

function CodeCard({ title, lang = "bash", code }) {
  return (
    <div className="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-3">
      <div className="flex items-center justify-between mb-2">
        <div className="text-xs font-semibold text-slate-600 dark:text-slate-300">{title}</div>
        <CopyBtn text={code} />
      </div>
      <pre className="text-sm overflow-auto rounded-lg bg-slate-50 dark:bg-slate-900 p-3">
        <code>{code}</code>
      </pre>
      <div className="mt-1 text-[11px] text-slate-500 dark:text-slate-400">{lang}</div>
    </div>
  );
}

export default function ToolResult({ tool }) {
  const t = tool || {};
  const lang = t?.primary?.lang || "bash";
  const primary = t?.primary?.command || "";
  const explanation = t?.explanation || "";
  const warnings = Array.isArray(t?.warnings) ? t.warnings : [];
  const alternatives = Array.isArray(t?.alternatives) ? t.alternatives.slice(0, 3) : [];

  return (
    <div className="space-y-3">
      <CodeCard title="Ú©Ø§Ù…Ù†Ø¯ Ø§ØµÙ„ÛŒ" lang={lang} code={primary} />

      <div className="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-3">
        <div className="text-sm font-bold mb-2">ØªÙˆØ¶ÛŒØ­</div>
        <div className="text-sm leading-7 whitespace-pre-wrap text-slate-700 dark:text-slate-200">
          {explanation || "-"}
        </div>
      </div>

      <div className="rounded-xl border border-red-200 dark:border-red-900 bg-red-50/70 dark:bg-red-950/30 p-3">
        <div className="text-sm font-bold mb-2 text-red-700 dark:text-red-300">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
        <ul className="text-sm leading-7 text-red-800 dark:text-red-200 list-disc pr-5">
          {(warnings.length ? warnings : ["-"]).map((w, i) => (
            <li key={i} className="whitespace-pre-wrap">{w}</li>
          ))}
        </ul>
      </div>

      <div className="space-y-3">
        <div className="text-sm font-bold">Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§</div>
        {alternatives.length ? alternatives.map((a, i) => (
          <div key={i} className="space-y-2">
            <div className="text-xs text-slate-600 dark:text-slate-300">{a?.note || ""}</div>
            <CodeCard title={`Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† ${i + 1}`} lang={lang} code={a?.command || ""} />
          </div>
        )) : (
          <div className="text-sm text-slate-500">-</div>
        )}
      </div>
    </div>
  );
}

================================================================================
FILE: .ccg_backups/day1_contract_lock/20260106_061449/server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Tool Contract for Generator (stable, non-chatty UI)
// Output (tool):
// {
//   primary: { command, lang },
//   explanation: string,
//   warnings: string[],
//   alternatives: [{ command, note }, ...] (always 3)
// }
// Also returns markdown (same template) as fallback.
// Back-compat exports:
// - formatToolResponse (main)
// - formatOutput (alias)

function fenceLangFromCli(cli = "bash", outputType = "command") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh") return "powershell";
  if (c.includes("cmd")) return "cmd";
  return "bash";
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  const codeRaw = String(m[1] ?? "").trim();
  const rest = t.replace(m[0], "").trim();
  return { codeRaw, rest };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 220) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false; // prose ending
  // starts with sudo/tool-ish token
  return /^(sudo\s+)?[a-zA-Z0-9._-]+(\s+|$)/.test(s);
}

function normalizePrimaryCommand(rawText, cliLang) {
  const { codeRaw, rest } = splitFirstCodeBlock(rawText);
  let cmd = "";

  if (codeRaw) {
    const lines = codeRaw.split("\n").map((x) => x.trim()).filter(Boolean);
    const cmdLines = lines.filter(looksLikeCommand);
    cmd = (cmdLines.length ? cmdLines : lines.slice(0, 1)).join("\n").trim();
  }

  if (!cmd) {
    // fallback: first command-like line from whole text
    const lines = String(rawText || "").split("\n").map((x) => x.trim());
    const first = lines.find(looksLikeCommand);
    if (first) cmd = first;
  }

  // last fallback
  if (!cmd) cmd = cliLang === "powershell" ? "Get-Help <command>" : "man <command>";

  return { cmd, restText: rest || "" };
}

function pickDefaultsByHeuristic(cmd, cliLang, os, userRequest) {
  const c = String(cmd || "").toLowerCase();
  const req = String(userRequest || "").toLowerCase();

  // defaults
  let explanation = "";
  let warnings = [];
  let alternatives = [];

  const isWindowsCmd = cliLang === "cmd";
  const isPowershell = cliLang === "powershell";

  // --- Reboot / shutdown
  if (c.includes("reboot") || c.includes("shutdown") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª") || req.includes("reboot")) {
    explanation = "Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
    warnings = [
      "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.",
      "Ø§Ú¯Ø± Ø±ÙˆÛŒ SSH Ù‡Ø³ØªÛŒØ¯ØŒ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.",
      "Ø¯Ø± Ù…Ø­ÛŒØ· Production Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯."
    ];
    alternatives = [
      { command: "sudo systemctl reboot", note: "Ø±ÙˆØ´ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ systemd" },
      { command: "sudo shutdown -r now", note: "Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙˆØ±ÛŒ" },
      { command: "sudo shutdown -r +1", note: "Ø±ÛŒØ³ØªØ§Ø±Øª Ø¨Ø§ Û± Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ£Ø®ÛŒØ±" },
    ];
    return { explanation, warnings, alternatives };
  }

  // --- Linux service restart
  if (c.startsWith("systemctl") && (c.includes("restart") || req.includes("Ø±ÛŒØ³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³"))) {
    explanation = "Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ§ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯ ÛŒØ§ Ù…Ø´Ú©Ù„ Ù…ÙˆÙ‚Øª Ø¨Ø±Ø·Ø±Ù Ø´ÙˆØ¯.";
    warnings = [
      "Ø±ÛŒØ³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§Ø¹Ø« Ù‚Ø·Ø¹ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø´ÙˆØ¯.",
      "Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ stateful Ø§Ø³ØªØŒ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÛŒØ³ØªØ§Ø±Øª ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
    ];
    alternatives = [
      { command: cmd.replace(/\brestart\b/i, "status"), note: "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ù‚Ø¯Ø§Ù…ØŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³" },
      { command: cmd.replace(/\brestart\b/i, "reload"), note: "Ø§Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´ÙˆØ¯ØŒ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹ Ú©Ø§Ù…Ù„" },
      { command: cmd.replace(/\brestart\b/i, "try-restart"), note: "ÙÙ‚Ø· Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø§Ø´Ø¯" },
    ];
    return { explanation, warnings, alternatives };
  }

  // --- Windows local users
  if ((req.includes("ÛŒÙˆØ²Ø±") || req.includes("Ú©Ø§Ø±Ø¨Ø±") || req.includes("user")) && (c.startsWith("net user") || c === "net user")) {
    explanation = "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø­Ù„ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.";
    warnings = [
      "Ø¯Ø± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ DomainØŒ Ø®Ø±ÙˆØ¬ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø§Ù…Ù†Ù‡ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯.",
      "Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø®ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Administrator Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯."
    ];
    alternatives = [
      { command: "net user | find /c /v \"\"", note: "ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø´Ù…Ø§Ø±Ø´ Ø®Ø·ÙˆØ· Ø®Ø±ÙˆØ¬ÛŒ)" },
      { command: "powershell -Command \"Get-LocalUser | Select -Expand Name\"", note: "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ PowerShell" },
      { command: "whoami", note: "Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ù†ÛŒØ³ØªØŒ Ø§Ù…Ø§ Ø±Ø§ÛŒØ¬)" },
    ];
    return { explanation, warnings, alternatives };
  }

  // --- Fallback generic
  explanation = "Ø¯Ø³ØªÙˆØ± Ø¨Ø§Ù„Ø§ Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.";
  warnings = [
    "Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø±ÙˆÛŒ Ø³ÛŒØ³ØªÙ…/Ù…Ø­ÛŒØ· Ø¯Ø±Ø³Øª Ù‡Ø³ØªÛŒØ¯.",
    "Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø§Ù„Ø§ØŒ Ø§Ø² sudo/Administrator Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."
  ];
  alternatives = [
    { command: cmd, note: "Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± (Ø§ØµÙ„ÛŒ)" },
    { command: isWindowsCmd ? "help" : "--help", note: "Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø¨Ø²Ø§Ø±" },
    { command: isWindowsCmd ? "where <command>" : "which <command>", note: "Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ÛŒØ±/ÙˆØ¬ÙˆØ¯ Ø¯Ø³ØªÙˆØ±" },
  ];
  return { explanation, warnings, alternatives };
}

function renderMarkdown(primary, explanation, warnings, alternatives, langTag) {
  const altMd = alternatives.map((a, i) =>
    `- ${a.note}\n\n\`\`\`${langTag}\n${a.command}\n\`\`\``
  ).join("\n\n");

  const warnMd = warnings.map((w) => `- ${w}`).join("\n");

  return `\`\`\`${langTag}\n${primary}\n\`\`\`\n\n## ØªÙˆØ¶ÛŒØ­\n${explanation}\n\n## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnMd}\n\n## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${altMd}\n`;
}

export function formatToolResponse({ text, cli = "bash", outputType = "markdown", os = "linux", lang = "fa", userRequest = "" }) {
  const langTag = fenceLangFromCli(cli, outputType);
  const raw = String(text ?? "").trim();

  // Primary command extraction
  const { cmd, restText } = normalizePrimaryCommand(raw, langTag);

  // Try to reuse some explanation from model if it exists (short), else heuristic
  const heuristic = pickDefaultsByHeuristic(cmd, langTag, os, userRequest);

  let explanation = heuristic.explanation;
  if (restText && restText.length >= 10 && restText.length <= 420) {
    // use short remainder as explanation if it looks like prose
    explanation = restText.replace(/^#+\s*/g, "").trim() || explanation;
  }

  // ensure always 3 alternatives
  const alternatives = (heuristic.alternatives || []).slice(0, 3);
  while (alternatives.length < 3) alternatives.push({ command: cmd, note: "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†" });

  const tool = {
    primary: { command: cmd, lang: langTag },
    explanation,
    warnings: (heuristic.warnings || []).length ? heuristic.warnings : ["Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."],
    alternatives
  };

  const markdown = renderMarkdown(
    tool.primary.command,
    tool.explanation,
    tool.warnings,
    tool.alternatives,
    tool.primary.lang
  );

  return { tool, markdown };
}

// Back-compat alias
export const formatOutput = formatToolResponse;

================================================================================
FILE: client/node_modules/monaco-editor/dev/vs/markdown-BXo7NBdp.js
================================================================================

define("vs/markdown-BXo7NBdp", ["exports"], (function(exports) {
  "use strict";
  const conf = {
    comments: {
      blockComment: ["<!--", "-->"]
    },
    brackets: [
      ["{", "}"],
      ["[", "]"],
      ["(", ")"]
    ],
    autoClosingPairs: [
      { open: "{", close: "}" },
      { open: "[", close: "]" },
      { open: "(", close: ")" },
      { open: "<", close: ">", notIn: ["string"] }
    ],
    surroundingPairs: [
      { open: "(", close: ")" },
      { open: "[", close: "]" },
      { open: "`", close: "`" }
    ],
    folding: {
      markers: {
        start: new RegExp("^\\s*<!--\\s*#?region\\b.*-->"),
        end: new RegExp("^\\s*<!--\\s*#?endregion\\b.*-->")
      }
    }
  };
  const language = {
    defaultToken: "",
    tokenPostfix: ".md",
    // escape codes
    control: /[\\`*_\[\]{}()#+\-\.!]/,
    noncontrol: /[^\\`*_\[\]{}()#+\-\.!]/,
    escapes: /\\(?:@control)/,
    // escape codes for javascript/CSS strings
    jsescapes: /\\(?:[btnfr\\"']|[0-7][0-7]?|[0-3][0-7]{2})/,
    // non matched elements
    empty: [
      "area",
      "base",
      "basefont",
      "br",
      "col",
      "frame",
      "hr",
      "img",
      "input",
      "isindex",
      "link",
      "meta",
      "param"
    ],
    tokenizer: {
      root: [
        // markdown tables
        [/^\s*\|/, "@rematch", "@table_header"],
        // headers (with #)
        [/^(\s{0,3})(#+)((?:[^\\#]|@escapes)+)((?:#+)?)/, ["white", "keyword", "keyword", "keyword"]],
        // headers (with =)
        [/^\s*(=+|\-+)\s*$/, "keyword"],
        // headers (with ***)
        [/^\s*((\*[ ]?)+)\s*$/, "meta.separator"],
        // quote
        [/^\s*>+/, "comment"],
        // list (starting with * or number)
        [/^\s*([\*\-+:]|\d+\.)\s/, "keyword"],
        // code block (4 spaces indent)
        [/^(\t|[ ]{4})[^ ].*$/, "string"],
        // code block (3 tilde)
        [/^\s*~~~\s*((?:\w|[\/\-#])+)?\s*$/, { token: "string", next: "@codeblock" }],
        // github style code blocks (with backticks and language)
        [
          /^\s*```\s*((?:\w|[\/\-#])+).*$/,
          { token: "string", next: "@codeblockgh", nextEmbedded: "$1" }
        ],
        // github style code blocks (with backticks but no language)
        [/^\s*```\s*$/, { token: "string", next: "@codeblock" }],
        // markup within lines
        { include: "@linecontent" }
      ],
      table_header: [
        { include: "@table_common" },
        [/[^\|]+/, "keyword.table.header"]
        // table header
      ],
      table_body: [{ include: "@table_common" }, { include: "@linecontent" }],
      table_common: [
        [/\s*[\-:]+\s*/, { token: "keyword", switchTo: "table_body" }],
        // header-divider
        [/^\s*\|/, "keyword.table.left"],
        // opening |
        [/^\s*[^\|]/, "@rematch", "@pop"],
        // exiting
        [/^\s*$/, "@rematch", "@pop"],
        // exiting
        [
          /\|/,
          {
            cases: {
              "@eos": "keyword.table.right",
              // closing |
              "@default": "keyword.table.middle"
              // inner |
            }
          }
        ]
      ],
      codeblock: [
        [/^\s*~~~\s*$/, { token: "string", next: "@pop" }],
        [/^\s*```\s*$/, { token: "string", next: "@pop" }],
        [/.*$/, "variable.source"]
      ],
      // github style code blocks
      codeblockgh: [
        [/```\s*$/, { token: "string", next: "@pop", nextEmbedded: "@pop" }],
        [/[^`]+/, "variable.source"]
      ],
      linecontent: [
        // escapes
        [/&\w+;/, "string.escape"],
        [/@escapes/, "escape"],
        // various markup
        [/\b__([^\\_]|@escapes|_(?!_))+__\b/, "strong"],
        [/\*\*([^\\*]|@escapes|\*(?!\*))+\*\*/, "strong"],
        [/\b_[^_]+_\b/, "emphasis"],
        [/\*([^\\*]|@escapes)+\*/, "emphasis"],
        [/`([^\\`]|@escapes)+`/, "variable"],
        // links
        [/\{+[^}]+\}+/, "string.target"],
        [/(!?\[)((?:[^\]\\]|@escapes)*)(\]\([^\)]+\))/, ["string.link", "", "string.link"]],
        [/(!?\[)((?:[^\]\\]|@escapes)*)(\])/, "string.link"],
        // or html
        { include: "html" }
      ],
      // Note: it is tempting to rather switch to the real HTML mode instead of building our own here
      // but currently there is a limitation in Monarch that prevents us from doing it: The opening
      // '<' would start the HTML mode, however there is no way to jump 1 character back to let the
      // HTML mode also tokenize the opening angle bracket. Thus, even though we could jump to HTML,
      // we cannot correctly tokenize it in that mode yet.
      html: [
        // html tags
        [/<(\w+)\/>/, "tag"],
        [
          /<(\w+)(\-|\w)*/,
          {
            cases: {
              "@empty": { token: "tag", next: "@tag.$1" },
              "@default": { token: "tag", next: "@tag.$1" }
            }
          }
        ],
        [/<\/(\w+)(\-|\w)*\s*>/, { token: "tag" }],
        [/<!--/, "comment", "@comment"]
      ],
      comment: [
        [/[^<\-]+/, "comment.content"],
        [/-->/, "comment", "@pop"],
        [/<!--/, "comment.content.invalid"],
        [/[<\-]/, "comment.content"]
      ],
      // Almost full HTML tag matching, complete with embedded scripts & styles
      tag: [
        [/[ \t\r\n]+/, "white"],
        [
          /(type)(\s*=\s*)(")([^"]+)(")/,
          [
            "attribute.name.html",
            "delimiter.html",
            "string.html",
            { token: "string.html", switchTo: "@tag.$S2.$4" },
            "string.html"
          ]
        ],
        [
          /(type)(\s*=\s*)(')([^']+)(')/,
          [
            "attribute.name.html",
            "delimiter.html",
            "string.html",
            { token: "string.html", switchTo: "@tag.$S2.$4" },
            "string.html"
          ]
        ],
        [/(\w+)(\s*=\s*)("[^"]*"|'[^']*')/, ["attribute.name.html", "delimiter.html", "string.html"]],
        [/\w+/, "attribute.name.html"],
        [/\/>/, "tag", "@pop"],
        [
          />/,
          {
            cases: {
              "$S2==style": {
                token: "tag",
                switchTo: "embeddedStyle",
                nextEmbedded: "text/css"
              },
              "$S2==script": {
                cases: {
                  $S3: {
                    token: "tag",
                    switchTo: "embeddedScript",
                    nextEmbedded: "$S3"
                  },
                  "@default": {
                    token: "tag",
                    switchTo: "embeddedScript",
                    nextEmbedded: "text/javascript"
                  }
                }
              },
              "@default": { token: "tag", next: "@pop" }
            }
          }
        ]
      ],
      embeddedStyle: [
        [/[^<]+/, ""],
        [/<\/style\s*>/, { token: "@rematch", next: "@pop", nextEmbedded: "@pop" }],
        [/</, ""]
      ],
      embeddedScript: [
        [/[^<]+/, ""],
        [/<\/script\s*>/, { token: "@rematch", next: "@pop", nextEmbedded: "@pop" }],
        [/</, ""]
      ]
    }
  };
  exports.conf = conf;
  exports.language = language;
  Object.defineProperty(exports, Symbol.toStringTag, { value: "Module" });
}));

================================================================================
FILE: client/node_modules/monaco-editor/min/vs/markdown-C_rD0bIw.js
================================================================================

define("vs/markdown-C_rD0bIw",["exports"],(function(e){"use strict";const t={comments:{blockComment:["<!--","-->"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:"<",close:">",notIn:["string"]}],surroundingPairs:[{open:"(",close:")"},{open:"[",close:"]"},{open:"`",close:"`"}],folding:{markers:{start:new RegExp("^\\s*<!--\\s*#?region\\b.*-->"),end:new RegExp("^\\s*<!--\\s*#?endregion\\b.*-->")}}},n={defaultToken:"",tokenPostfix:".md",control:/[\\`*_\[\]{}()#+\-\.!]/,noncontrol:/[^\\`*_\[\]{}()#+\-\.!]/,escapes:/\\(?:@control)/,jsescapes:/\\(?:[btnfr\\"']|[0-7][0-7]?|[0-3][0-7]{2})/,empty:["area","base","basefont","br","col","frame","hr","img","input","isindex","link","meta","param"],tokenizer:{root:[[/^\s*\|/,"@rematch","@table_header"],[/^(\s{0,3})(#+)((?:[^\\#]|@escapes)+)((?:#+)?)/,["white","keyword","keyword","keyword"]],[/^\s*(=+|\-+)\s*$/,"keyword"],[/^\s*((\*[ ]?)+)\s*$/,"meta.separator"],[/^\s*>+/,"comment"],[/^\s*([\*\-+:]|\d+\.)\s/,"keyword"],[/^(\t|[ ]{4})[^ ].*$/,"string"],[/^\s*~~~\s*((?:\w|[\/\-#])+)?\s*$/,{token:"string",next:"@codeblock"}],[/^\s*```\s*((?:\w|[\/\-#])+).*$/,{token:"string",next:"@codeblockgh",nextEmbedded:"$1"}],[/^\s*```\s*$/,{token:"string",next:"@codeblock"}],{include:"@linecontent"}],table_header:[{include:"@table_common"},[/[^\|]+/,"keyword.table.header"]],table_body:[{include:"@table_common"},{include:"@linecontent"}],table_common:[[/\s*[\-:]+\s*/,{token:"keyword",switchTo:"table_body"}],[/^\s*\|/,"keyword.table.left"],[/^\s*[^\|]/,"@rematch","@pop"],[/^\s*$/,"@rematch","@pop"],[/\|/,{cases:{"@eos":"keyword.table.right","@default":"keyword.table.middle"}}]],codeblock:[[/^\s*~~~\s*$/,{token:"string",next:"@pop"}],[/^\s*```\s*$/,{token:"string",next:"@pop"}],[/.*$/,"variable.source"]],codeblockgh:[[/```\s*$/,{token:"string",next:"@pop",nextEmbedded:"@pop"}],[/[^`]+/,"variable.source"]],linecontent:[[/&\w+;/,"string.escape"],[/@escapes/,"escape"],[/\b__([^\\_]|@escapes|_(?!_))+__\b/,"strong"],[/\*\*([^\\*]|@escapes|\*(?!\*))+\*\*/,"strong"],[/\b_[^_]+_\b/,"emphasis"],[/\*([^\\*]|@escapes)+\*/,"emphasis"],[/`([^\\`]|@escapes)+`/,"variable"],[/\{+[^}]+\}+/,"string.target"],[/(!?\[)((?:[^\]\\]|@escapes)*)(\]\([^\)]+\))/,["string.link","","string.link"]],[/(!?\[)((?:[^\]\\]|@escapes)*)(\])/,"string.link"],{include:"html"}],html:[[/<(\w+)\/>/,"tag"],[/<(\w+)(\-|\w)*/,{cases:{"@empty":{token:"tag",next:"@tag.$1"},"@default":{token:"tag",next:"@tag.$1"}}}],[/<\/(\w+)(\-|\w)*\s*>/,{token:"tag"}],[/<!--/,"comment","@comment"]],comment:[[/[^<\-]+/,"comment.content"],[/-->/,"comment","@pop"],[/<!--/,"comment.content.invalid"],[/[<\-]/,"comment.content"]],tag:[[/[ \t\r\n]+/,"white"],[/(type)(\s*=\s*)(")([^"]+)(")/,["attribute.name.html","delimiter.html","string.html",{token:"string.html",switchTo:"@tag.$S2.$4"},"string.html"]],[/(type)(\s*=\s*)(')([^']+)(')/,["attribute.name.html","delimiter.html","string.html",{token:"string.html",switchTo:"@tag.$S2.$4"},"string.html"]],[/(\w+)(\s*=\s*)("[^"]*"|'[^']*')/,["attribute.name.html","delimiter.html","string.html"]],[/\w+/,"attribute.name.html"],[/\/>/,"tag","@pop"],[/>/,{cases:{"$S2==style":{token:"tag",switchTo:"embeddedStyle",nextEmbedded:"text/css"},"$S2==script":{cases:{$S3:{token:"tag",switchTo:"embeddedScript",nextEmbedded:"$S3"},"@default":{token:"tag",switchTo:"embeddedScript",nextEmbedded:"text/javascript"}}},"@default":{token:"tag",next:"@pop"}}}]],embeddedStyle:[[/[^<]+/,""],[/<\/style\s*>/,{token:"@rematch",next:"@pop",nextEmbedded:"@pop"}],[/</,""]],embeddedScript:[[/[^<]+/,""],[/<\/script\s*>/,{token:"@rematch",next:"@pop",nextEmbedded:"@pop"}],[/</,""]]}};e.conf=t,e.language=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/platform/markdown/browser/markdownRenderer.js
================================================================================

import { renderMarkdown } from '../../../base/browser/markdownRenderer.js';
import { onUnexpectedError } from '../../../base/common/errors.js';
import { registerSingleton } from '../../instantiation/common/extensions.js';
import { createDecorator } from '../../instantiation/common/instantiation.js';
import { IOpenerService } from '../../opener/common/opener.js';

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
const IMarkdownRendererService = createDecorator('markdownRendererService');
let MarkdownRendererService = class MarkdownRendererService {
    constructor(_openerService) {
        this._openerService = _openerService;
    }
    render(markdown, options, outElement) {
        const resolvedOptions = { ...options };
        if (!resolvedOptions.actionHandler) {
            resolvedOptions.actionHandler = (link, mdStr) => {
                return openLinkFromMarkdown(this._openerService, link, mdStr.isTrusted);
            };
        }
        if (!resolvedOptions.codeBlockRenderer) {
            resolvedOptions.codeBlockRenderer = (alias, value) => {
                return this._defaultCodeBlockRenderer?.renderCodeBlock(alias, value, resolvedOptions ?? {}) ?? Promise.resolve(document.createElement('span'));
            };
        }
        const rendered = renderMarkdown(markdown, resolvedOptions, outElement);
        rendered.element.classList.add('rendered-markdown');
        return rendered;
    }
    setDefaultCodeBlockRenderer(renderer) {
        this._defaultCodeBlockRenderer = renderer;
    }
};
MarkdownRendererService = __decorate([
    __param(0, IOpenerService)
], MarkdownRendererService);
async function openLinkFromMarkdown(openerService, link, isTrusted, skipValidation) {
    try {
        return await openerService.open(link, {
            fromUserGesture: true,
            allowContributedOpeners: true,
            allowCommands: toAllowCommandsOption(isTrusted),
            skipValidation
        });
    }
    catch (e) {
        onUnexpectedError(e);
        return false;
    }
}
function toAllowCommandsOption(isTrusted) {
    if (isTrusted === true) {
        return true; // Allow all commands
    }
    if (isTrusted && Array.isArray(isTrusted.enabledCommands)) {
        return isTrusted.enabledCommands; // Allow subset of commands
    }
    return false; // Block commands
}
registerSingleton(IMarkdownRendererService, MarkdownRendererService, 1 /* InstantiationType.Delayed */);

export { IMarkdownRendererService, MarkdownRendererService, openLinkFromMarkdown };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/platform/actions/browser/toolbar.js
================================================================================

import { addDisposableListener, getWindow } from '../../../base/browser/dom.js';
import { StandardMouseEvent } from '../../../base/browser/mouseEvent.js';
import { ToolBar, ToggleMenuAction } from '../../../base/browser/ui/toolbar/toolbar.js';
import { Separator, toAction } from '../../../base/common/actions.js';
import { coalesceInPlace } from '../../../base/common/arrays.js';
import { intersection } from '../../../base/common/collections.js';
import { BugIndicatingError } from '../../../base/common/errors.js';
import { Emitter } from '../../../base/common/event.js';
import { Iterable } from '../../../base/common/iterator.js';
import { DisposableStore } from '../../../base/common/lifecycle.js';
import { localize } from '../../../nls.js';
import { createActionViewItem, getActionBarActions } from './menuEntryActionViewItem.js';
import { IMenuService, MenuItemAction, SubmenuItemAction } from '../common/actions.js';
import { createConfigureKeybindingAction } from '../common/menuService.js';
import { ICommandService } from '../../commands/common/commands.js';
import { IContextKeyService } from '../../contextkey/common/contextkey.js';
import { IContextMenuService } from '../../contextview/browser/contextView.js';
import { IKeybindingService } from '../../keybinding/common/keybinding.js';
import { ITelemetryService } from '../../telemetry/common/telemetry.js';
import { IActionViewItemService } from './actionViewItemService.js';
import { IInstantiationService } from '../../instantiation/common/instantiation.js';

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
/**
 * The `WorkbenchToolBar` does
 * - support hiding of menu items
 * - lookup keybindings for each actions automatically
 * - send `workbenchActionExecuted`-events for each action
 *
 * See {@link MenuWorkbenchToolBar} for a toolbar that is backed by a menu.
 */
let WorkbenchToolBar = class WorkbenchToolBar extends ToolBar {
    constructor(container, _options, _menuService, _contextKeyService, _contextMenuService, _keybindingService, _commandService, telemetryService) {
        super(container, _contextMenuService, {
            // defaults
            getKeyBinding: (action) => _keybindingService.lookupKeybinding(action.id) ?? undefined,
            // options (override defaults)
            ..._options,
            // mandatory (overide options)
            allowContextMenu: true,
            skipTelemetry: typeof _options?.telemetrySource === 'string',
        });
        this._options = _options;
        this._menuService = _menuService;
        this._contextKeyService = _contextKeyService;
        this._contextMenuService = _contextMenuService;
        this._keybindingService = _keybindingService;
        this._commandService = _commandService;
        this._sessionDisposables = this._store.add(new DisposableStore());
        // telemetry logic
        const telemetrySource = _options?.telemetrySource;
        if (telemetrySource) {
            this._store.add(this.actionBar.onDidRun(e => telemetryService.publicLog2('workbenchActionExecuted', { id: e.action.id, from: telemetrySource })));
        }
    }
    setActions(_primary, _secondary = [], menuIds) {
        this._sessionDisposables.clear();
        const primary = _primary.slice(); // for hiding and overflow we set some items to undefined
        const secondary = _secondary.slice();
        const toggleActions = [];
        let toggleActionsCheckedCount = 0;
        const extraSecondary = [];
        let someAreHidden = false;
        // unless disabled, move all hidden items to secondary group or ignore them
        if (this._options?.hiddenItemStrategy !== -1 /* HiddenItemStrategy.NoHide */) {
            for (let i = 0; i < primary.length; i++) {
                const action = primary[i];
                if (!(action instanceof MenuItemAction) && !(action instanceof SubmenuItemAction)) {
                    // console.warn(`Action ${action.id}/${action.label} is not a MenuItemAction`);
                    continue;
                }
                if (!action.hideActions) {
                    continue;
                }
                // collect all toggle actions
                toggleActions.push(action.hideActions.toggle);
                if (action.hideActions.toggle.checked) {
                    toggleActionsCheckedCount++;
                }
                // hidden items move into overflow or ignore
                if (action.hideActions.isHidden) {
                    someAreHidden = true;
                    primary[i] = undefined;
                    if (this._options?.hiddenItemStrategy !== 0 /* HiddenItemStrategy.Ignore */) {
                        extraSecondary[i] = action;
                    }
                }
            }
        }
        // count for max
        if (this._options?.overflowBehavior !== undefined) {
            const exemptedIds = intersection(new Set(this._options.overflowBehavior.exempted), Iterable.map(primary, a => a?.id));
            const maxItems = this._options.overflowBehavior.maxItems - exemptedIds.size;
            let count = 0;
            for (let i = 0; i < primary.length; i++) {
                const action = primary[i];
                if (!action) {
                    continue;
                }
                count++;
                if (exemptedIds.has(action.id)) {
                    continue;
                }
                if (count >= maxItems) {
                    primary[i] = undefined;
                    extraSecondary[i] = action;
                }
            }
        }
        // coalesce turns Array<IAction|undefined> into IAction[]
        coalesceInPlace(primary);
        coalesceInPlace(extraSecondary);
        super.setActions(primary, Separator.join(extraSecondary, secondary));
        // add context menu for toggle and configure keybinding actions
        if (toggleActions.length > 0 || primary.length > 0) {
            this._sessionDisposables.add(addDisposableListener(this.getElement(), 'contextmenu', e => {
                const event = new StandardMouseEvent(getWindow(this.getElement()), e);
                const action = this.getItemAction(event.target);
                if (!(action)) {
                    return;
                }
                event.preventDefault();
                event.stopPropagation();
                const primaryActions = [];
                // -- Configure Keybinding Action --
                if (action instanceof MenuItemAction && action.menuKeybinding) {
                    primaryActions.push(action.menuKeybinding);
                }
                else if (!(action instanceof SubmenuItemAction || action instanceof ToggleMenuAction)) {
                    // only enable the configure keybinding action for actions that support keybindings
                    const supportsKeybindings = !!this._keybindingService.lookupKeybinding(action.id);
                    primaryActions.push(createConfigureKeybindingAction(this._commandService, this._keybindingService, action.id, undefined, supportsKeybindings));
                }
                // -- Hide Actions --
                if (toggleActions.length > 0) {
                    let noHide = false;
                    // last item cannot be hidden when using ignore strategy
                    if (toggleActionsCheckedCount === 1 && this._options?.hiddenItemStrategy === 0 /* HiddenItemStrategy.Ignore */) {
                        noHide = true;
                        for (let i = 0; i < toggleActions.length; i++) {
                            if (toggleActions[i].checked) {
                                toggleActions[i] = toAction({
                                    id: action.id,
                                    label: action.label,
                                    checked: true,
                                    enabled: false,
                                    run() { }
                                });
                                break; // there is only one
                            }
                        }
                    }
                    // add "hide foo" actions
                    if (!noHide && (action instanceof MenuItemAction || action instanceof SubmenuItemAction)) {
                        if (!action.hideActions) {
                            // no context menu for MenuItemAction instances that support no hiding
                            // those are fake actions and need to be cleaned up
                            return;
                        }
                        primaryActions.push(action.hideActions.hide);
                    }
                    else {
                        primaryActions.push(toAction({
                            id: 'label',
                            label: localize(1649, "Hide"),
                            enabled: false,
                            run() { }
                        }));
                    }
                }
                const actions = Separator.join(primaryActions, toggleActions);
                // add "Reset Menu" action
                if (this._options?.resetMenu && !menuIds) {
                    menuIds = [this._options.resetMenu];
                }
                if (someAreHidden && menuIds) {
                    actions.push(new Separator());
                    actions.push(toAction({
                        id: 'resetThisMenu',
                        label: localize(1650, "Reset Menu"),
                        run: () => this._menuService.resetHiddenStates(menuIds)
                    }));
                }
                if (actions.length === 0) {
                    return;
                }
                this._contextMenuService.showContextMenu({
                    getAnchor: () => event,
                    getActions: () => actions,
                    // add context menu actions (iff appicable)
                    menuId: this._options?.contextMenu,
                    menuActionOptions: { renderShortTitle: true, ...this._options?.menuOptions },
                    skipTelemetry: typeof this._options?.telemetrySource === 'string',
                    contextKeyService: this._contextKeyService,
                });
            }));
        }
    }
};
WorkbenchToolBar = __decorate([
    __param(2, IMenuService),
    __param(3, IContextKeyService),
    __param(4, IContextMenuService),
    __param(5, IKeybindingService),
    __param(6, ICommandService),
    __param(7, ITelemetryService)
], WorkbenchToolBar);
/**
 * A {@link WorkbenchToolBar workbench toolbar} that is purely driven from a {@link MenuId menu}-identifier.
 *
 * *Note* that Manual updates via `setActions` are NOT supported.
 */
let MenuWorkbenchToolBar = class MenuWorkbenchToolBar extends WorkbenchToolBar {
    get onDidChangeMenuItems() { return this._onDidChangeMenuItems.event; }
    constructor(container, menuId, options, menuService, contextKeyService, contextMenuService, keybindingService, commandService, telemetryService, actionViewService, instantiationService) {
        super(container, {
            resetMenu: menuId,
            ...options,
            actionViewItemProvider: (action, opts) => {
                let provider = actionViewService.lookUp(menuId, action instanceof SubmenuItemAction ? action.item.submenu.id : action.id);
                if (!provider) {
                    provider = options?.actionViewItemProvider;
                }
                const viewItem = provider?.(action, opts, instantiationService, getWindow(container).vscodeWindowId);
                if (viewItem) {
                    return viewItem;
                }
                return createActionViewItem(instantiationService, action, opts);
            }
        }, menuService, contextKeyService, contextMenuService, keybindingService, commandService, telemetryService);
        this._onDidChangeMenuItems = this._store.add(new Emitter());
        // update logic
        const menu = this._store.add(menuService.createMenu(menuId, contextKeyService, { emitEventsForSubmenuChanges: true, eventDebounceDelay: options?.eventDebounceDelay }));
        const updateToolbar = () => {
            const { primary, secondary } = getActionBarActions(menu.getActions(options?.menuOptions), options?.toolbarOptions?.primaryGroup, options?.toolbarOptions?.shouldInlineSubmenu, options?.toolbarOptions?.useSeparatorsInPrimaryActions);
            container.classList.toggle('has-no-actions', primary.length === 0 && secondary.length === 0);
            super.setActions(primary, secondary);
        };
        this._store.add(menu.onDidChange(() => {
            updateToolbar();
            this._onDidChangeMenuItems.fire(this);
        }));
        this._store.add(actionViewService.onDidChange(e => {
            if (e === menuId) {
                updateToolbar();
            }
        }));
        updateToolbar();
    }
    /**
     * @deprecated The WorkbenchToolBar does not support this method because it works with menus.
     */
    setActions() {
        throw new BugIndicatingError('This toolbar is populated from a menu.');
    }
};
MenuWorkbenchToolBar = __decorate([
    __param(3, IMenuService),
    __param(4, IContextKeyService),
    __param(5, IContextMenuService),
    __param(6, IKeybindingService),
    __param(7, ICommandService),
    __param(8, ITelemetryService),
    __param(9, IActionViewItemService),
    __param(10, IInstantiationService)
], MenuWorkbenchToolBar);

export { MenuWorkbenchToolBar, WorkbenchToolBar };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/base/common/idGenerator.js
================================================================================

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
class IdGenerator {
    constructor(prefix) {
        this._prefix = prefix;
        this._lastId = 0;
    }
    nextId() {
        return this._prefix + (++this._lastId);
    }
}
const defaultGenerator = new IdGenerator('id#');

export { IdGenerator, defaultGenerator };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/base/common/observableInternal/logging/debugger/devToolsLogger.js
================================================================================

import { AutorunObserver } from '../../reactions/autorunImpl.js';
import { formatValue } from '../consoleObservableLogger.js';
import { registerDebugChannel } from './debuggerRpc.js';
import { Throttler, deepAssignDeleteNulls, deepAssign } from './utils.js';
import { isDefined } from '../../../types.js';
import { FromEventObservable } from '../../observables/observableFromEvent.js';
import { onUnexpectedError, BugIndicatingError } from '../../../errors.js';
import { Derived } from '../../observables/derivedImpl.js';
import { ObservableValue } from '../../observables/observableValue.js';
import { DebugLocation } from '../../debugLocation.js';

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
class DevToolsLogger {
    static { this._instance = undefined; }
    static getInstance() {
        if (DevToolsLogger._instance === undefined) {
            DevToolsLogger._instance = new DevToolsLogger();
        }
        return DevToolsLogger._instance;
    }
    getTransactionState() {
        const affected = [];
        const txs = [...this._activeTransactions];
        if (txs.length === 0) {
            return undefined;
        }
        const observerQueue = txs.flatMap(t => t.debugGetUpdatingObservers() ?? []).map(o => o.observer);
        const processedObservers = new Set();
        while (observerQueue.length > 0) {
            const observer = observerQueue.shift();
            if (processedObservers.has(observer)) {
                continue;
            }
            processedObservers.add(observer);
            const state = this._getInfo(observer, d => {
                if (!processedObservers.has(d)) {
                    observerQueue.push(d);
                }
            });
            if (state) {
                affected.push(state);
            }
        }
        return { names: txs.map(t => t.getDebugName() ?? 'tx'), affected };
    }
    _getObservableInfo(observable) {
        const info = this._instanceInfos.get(observable);
        if (!info) {
            onUnexpectedError(new BugIndicatingError('No info found'));
            return undefined;
        }
        return info;
    }
    _getAutorunInfo(autorun) {
        const info = this._instanceInfos.get(autorun);
        if (!info) {
            onUnexpectedError(new BugIndicatingError('No info found'));
            return undefined;
        }
        return info;
    }
    _getInfo(observer, queue) {
        if (observer instanceof Derived) {
            const observersToUpdate = [...observer.debugGetObservers()];
            for (const o of observersToUpdate) {
                queue(o);
            }
            const info = this._getObservableInfo(observer);
            if (!info) {
                return;
            }
            const observerState = observer.debugGetState();
            const base = { name: observer.debugName, instanceId: info.instanceId, updateCount: observerState.updateCount };
            const changedDependencies = [...info.changedObservables].map(o => this._instanceInfos.get(o)?.instanceId).filter(isDefined);
            if (observerState.isComputing) {
                return { ...base, type: 'observable/derived', state: 'updating', changedDependencies, initialComputation: false };
            }
            switch (observerState.state) {
                case 0 /* DerivedState.initial */:
                    return { ...base, type: 'observable/derived', state: 'noValue' };
                case 3 /* DerivedState.upToDate */:
                    return { ...base, type: 'observable/derived', state: 'upToDate' };
                case 2 /* DerivedState.stale */:
                    return { ...base, type: 'observable/derived', state: 'stale', changedDependencies };
                case 1 /* DerivedState.dependenciesMightHaveChanged */:
                    return { ...base, type: 'observable/derived', state: 'possiblyStale' };
            }
        }
        else if (observer instanceof AutorunObserver) {
            const info = this._getAutorunInfo(observer);
            if (!info) {
                return undefined;
            }
            const base = { name: observer.debugName, instanceId: info.instanceId, updateCount: info.updateCount };
            const changedDependencies = [...info.changedObservables].map(o => this._instanceInfos.get(o).instanceId);
            if (observer.debugGetState().isRunning) {
                return { ...base, type: 'autorun', state: 'updating', changedDependencies };
            }
            switch (observer.debugGetState().state) {
                case 3 /* AutorunState.upToDate */:
                    return { ...base, type: 'autorun', state: 'upToDate' };
                case 2 /* AutorunState.stale */:
                    return { ...base, type: 'autorun', state: 'stale', changedDependencies };
                case 1 /* AutorunState.dependenciesMightHaveChanged */:
                    return { ...base, type: 'autorun', state: 'possiblyStale' };
            }
        }
        return undefined;
    }
    _formatObservable(obs) {
        const info = this._getObservableInfo(obs);
        if (!info) {
            return undefined;
        }
        return { name: obs.debugName, instanceId: info.instanceId };
    }
    _formatObserver(obs) {
        if (obs instanceof Derived) {
            return { name: obs.toString(), instanceId: this._getObservableInfo(obs)?.instanceId };
        }
        const autorunInfo = this._getAutorunInfo(obs);
        if (autorunInfo) {
            return { name: obs.toString(), instanceId: autorunInfo.instanceId };
        }
        return undefined;
    }
    constructor() {
        this._declarationId = 0;
        this._instanceId = 0;
        this._declarations = new Map();
        this._instanceInfos = new WeakMap();
        this._aliveInstances = new Map();
        this._activeTransactions = new Set();
        this._channel = registerDebugChannel('observableDevTools', () => {
            return {
                notifications: {
                    setDeclarationIdFilter: declarationIds => {
                    },
                    logObservableValue: (observableId) => {
                        console.log('logObservableValue', observableId);
                    },
                    flushUpdates: () => {
                        this._flushUpdates();
                    },
                    resetUpdates: () => {
                        this._pendingChanges = null;
                        this._channel.api.notifications.handleChange(this._fullState, true);
                    },
                },
                requests: {
                    getDeclarations: () => {
                        const result = {};
                        for (const decl of this._declarations.values()) {
                            result[decl.id] = decl;
                        }
                        return { decls: result };
                    },
                    getSummarizedInstances: () => {
                        return null;
                    },
                    getObservableValueInfo: instanceId => {
                        const obs = this._aliveInstances.get(instanceId);
                        return {
                            observers: [...obs.debugGetObservers()].map(d => this._formatObserver(d)).filter(isDefined),
                        };
                    },
                    getDerivedInfo: instanceId => {
                        const d = this._aliveInstances.get(instanceId);
                        return {
                            dependencies: [...d.debugGetState().dependencies].map(d => this._formatObservable(d)).filter(isDefined),
                            observers: [...d.debugGetObservers()].map(d => this._formatObserver(d)).filter(isDefined),
                        };
                    },
                    getAutorunInfo: instanceId => {
                        const obs = this._aliveInstances.get(instanceId);
                        return {
                            dependencies: [...obs.debugGetState().dependencies].map(d => this._formatObservable(d)).filter(isDefined),
                        };
                    },
                    getTransactionState: () => {
                        return this.getTransactionState();
                    },
                    setValue: (instanceId, jsonValue) => {
                        const obs = this._aliveInstances.get(instanceId);
                        if (obs instanceof Derived) {
                            obs.debugSetValue(jsonValue);
                        }
                        else if (obs instanceof ObservableValue) {
                            obs.debugSetValue(jsonValue);
                        }
                        else if (obs instanceof FromEventObservable) {
                            obs.debugSetValue(jsonValue);
                        }
                        else {
                            throw new BugIndicatingError('Observable is not supported');
                        }
                        const observers = [...obs.debugGetObservers()];
                        for (const d of observers) {
                            d.beginUpdate(obs);
                        }
                        for (const d of observers) {
                            d.handleChange(obs, undefined);
                        }
                        for (const d of observers) {
                            d.endUpdate(obs);
                        }
                    },
                    getValue: instanceId => {
                        const obs = this._aliveInstances.get(instanceId);
                        if (obs instanceof Derived) {
                            return formatValue(obs.debugGetState().value, 200);
                        }
                        else if (obs instanceof ObservableValue) {
                            return formatValue(obs.debugGetState().value, 200);
                        }
                        return undefined;
                    },
                    logValue: (instanceId) => {
                        const obs = this._aliveInstances.get(instanceId);
                        if (obs && 'get' in obs) {
                            console.log('Logged Value:', obs.get());
                        }
                        else {
                            throw new BugIndicatingError('Observable is not supported');
                        }
                    },
                    rerun: (instanceId) => {
                        const obs = this._aliveInstances.get(instanceId);
                        if (obs instanceof Derived) {
                            obs.debugRecompute();
                        }
                        else if (obs instanceof AutorunObserver) {
                            obs.debugRerun();
                        }
                        else {
                            throw new BugIndicatingError('Observable is not supported');
                        }
                    },
                }
            };
        });
        this._pendingChanges = null;
        this._changeThrottler = new Throttler();
        this._fullState = {};
        this._flushUpdates = () => {
            if (this._pendingChanges !== null) {
                this._channel.api.notifications.handleChange(this._pendingChanges, false);
                this._pendingChanges = null;
            }
        };
        DebugLocation.enable();
    }
    _handleChange(update) {
        deepAssignDeleteNulls(this._fullState, update);
        if (this._pendingChanges === null) {
            this._pendingChanges = update;
        }
        else {
            deepAssign(this._pendingChanges, update);
        }
        this._changeThrottler.throttle(this._flushUpdates, 10);
    }
    _getDeclarationId(type, location) {
        if (!location) {
            return -1;
        }
        let decInfo = this._declarations.get(location.id);
        if (decInfo === undefined) {
            decInfo = {
                id: this._declarationId++,
                type,
                url: location.fileName,
                line: location.line,
                column: location.column,
            };
            this._declarations.set(location.id, decInfo);
            this._handleChange({ decls: { [decInfo.id]: decInfo } });
        }
        return decInfo.id;
    }
    handleObservableCreated(observable, location) {
        const declarationId = this._getDeclarationId('observable/value', location);
        const info = {
            declarationId,
            instanceId: this._instanceId++,
            listenerCount: 0,
            lastValue: undefined,
            updateCount: 0,
            changedObservables: new Set(),
        };
        this._instanceInfos.set(observable, info);
    }
    handleOnListenerCountChanged(observable, newCount) {
        const info = this._getObservableInfo(observable);
        if (!info) {
            return;
        }
        if (info.listenerCount === 0 && newCount > 0) {
            const type = observable instanceof Derived ? 'observable/derived' : 'observable/value';
            this._aliveInstances.set(info.instanceId, observable);
            this._handleChange({
                instances: {
                    [info.instanceId]: {
                        instanceId: info.instanceId,
                        declarationId: info.declarationId,
                        formattedValue: info.lastValue,
                        type,
                        name: observable.debugName,
                    }
                }
            });
        }
        else if (info.listenerCount > 0 && newCount === 0) {
            this._handleChange({
                instances: { [info.instanceId]: null }
            });
            this._aliveInstances.delete(info.instanceId);
        }
        info.listenerCount = newCount;
    }
    handleObservableUpdated(observable, changeInfo) {
        if (observable instanceof Derived) {
            this._handleDerivedRecomputed(observable, changeInfo);
            return;
        }
        const info = this._getObservableInfo(observable);
        if (info) {
            if (changeInfo.didChange) {
                info.lastValue = formatValue(changeInfo.newValue, 30);
                if (info.listenerCount > 0) {
                    this._handleChange({
                        instances: { [info.instanceId]: { formattedValue: info.lastValue } }
                    });
                }
            }
        }
    }
    handleAutorunCreated(autorun, location) {
        const declarationId = this._getDeclarationId('autorun', location);
        const info = {
            declarationId,
            instanceId: this._instanceId++,
            updateCount: 0,
            changedObservables: new Set(),
        };
        this._instanceInfos.set(autorun, info);
        this._aliveInstances.set(info.instanceId, autorun);
        if (info) {
            this._handleChange({
                instances: {
                    [info.instanceId]: {
                        instanceId: info.instanceId,
                        declarationId: info.declarationId,
                        runCount: 0,
                        type: 'autorun',
                        name: autorun.debugName,
                    }
                }
            });
        }
    }
    handleAutorunDisposed(autorun) {
        const info = this._getAutorunInfo(autorun);
        if (!info) {
            return;
        }
        this._handleChange({
            instances: { [info.instanceId]: null }
        });
        this._instanceInfos.delete(autorun);
        this._aliveInstances.delete(info.instanceId);
    }
    handleAutorunDependencyChanged(autorun, observable, change) {
        const info = this._getAutorunInfo(autorun);
        if (!info) {
            return;
        }
        info.changedObservables.add(observable);
    }
    handleAutorunStarted(autorun) {
    }
    handleAutorunFinished(autorun) {
        const info = this._getAutorunInfo(autorun);
        if (!info) {
            return;
        }
        info.changedObservables.clear();
        info.updateCount++;
        this._handleChange({
            instances: { [info.instanceId]: { runCount: info.updateCount } }
        });
    }
    handleDerivedDependencyChanged(derived, observable, change) {
        const info = this._getObservableInfo(derived);
        if (info) {
            info.changedObservables.add(observable);
        }
    }
    _handleDerivedRecomputed(observable, changeInfo) {
        const info = this._getObservableInfo(observable);
        if (!info) {
            return;
        }
        const formattedValue = formatValue(changeInfo.newValue, 30);
        info.updateCount++;
        info.changedObservables.clear();
        info.lastValue = formattedValue;
        if (info.listenerCount > 0) {
            this._handleChange({
                instances: { [info.instanceId]: { formattedValue: formattedValue, recomputationCount: info.updateCount } }
            });
        }
    }
    handleDerivedCleared(observable) {
        const info = this._getObservableInfo(observable);
        if (!info) {
            return;
        }
        info.lastValue = undefined;
        info.changedObservables.clear();
        if (info.listenerCount > 0) {
            this._handleChange({
                instances: {
                    [info.instanceId]: {
                        formattedValue: undefined,
                    }
                }
            });
        }
    }
    handleBeginTransaction(transaction) {
        this._activeTransactions.add(transaction);
    }
    handleEndTransaction(transaction) {
        this._activeTransactions.delete(transaction);
    }
}

export { DevToolsLogger };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/base/browser/markdownRenderer.js
================================================================================

import { onUnexpectedError } from '../common/errors.js';
import { removeMarkdownEscapes, escapeDoubleQuotes, parseHrefAndDimensions } from '../common/htmlContent.js';
import { markdownEscapeEscapedIcons } from '../common/iconLabels.js';
import { defaultGenerator } from '../common/idGenerator.js';
import { Lazy } from '../common/lazy.js';
import { DisposableStore } from '../common/lifecycle.js';
import { Renderer as _Renderer, Marked, lexer, parse as parse$1 } from '../common/marked/marked.js';
import { parse } from '../common/marshalling.js';
import { Schemas, FileAccess } from '../common/network.js';
import { cloneAndChange } from '../common/objects.js';
import { resolvePath, dirname } from '../common/resources.js';
import { escape } from '../common/strings.js';
import { URI } from '../common/uri.js';
import { reset, addDisposableListener, $, getWindow, isHTMLElement } from './dom.js';
import { basicMarkupHtmlTags, safeSetInnerHtml, convertTagToPlaintext, sanitizeHtml } from './domSanitize.js';
import { StandardKeyboardEvent } from './keyboardEvent.js';
import { StandardMouseEvent } from './mouseEvent.js';
import { renderLabelWithIcons, renderIcon } from './ui/iconLabel/iconLabels.js';

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
const defaultMarkedRenderers = Object.freeze({
    image: ({ href, title, text }) => {
        let dimensions = [];
        let attributes = [];
        if (href) {
            ({ href, dimensions } = parseHrefAndDimensions(href));
            attributes.push(`src="${escapeDoubleQuotes(href)}"`);
        }
        if (text) {
            attributes.push(`alt="${escapeDoubleQuotes(text)}"`);
        }
        if (title) {
            attributes.push(`title="${escapeDoubleQuotes(title)}"`);
        }
        if (dimensions.length) {
            attributes = attributes.concat(dimensions);
        }
        return '<img ' + attributes.join(' ') + '>';
    },
    paragraph({ tokens }) {
        return `<p>${this.parser.parseInline(tokens)}</p>`;
    },
    link({ href, title, tokens }) {
        let text = this.parser.parseInline(tokens);
        if (typeof href !== 'string') {
            return '';
        }
        // Remove markdown escapes. Workaround for https://github.com/chjj/marked/issues/829
        if (href === text) { // raw link case
            text = removeMarkdownEscapes(text);
        }
        title = typeof title === 'string' ? escapeDoubleQuotes(removeMarkdownEscapes(title)) : '';
        href = removeMarkdownEscapes(href);
        // HTML Encode href
        href = href.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        return `<a href="${href}" title="${title || href}" draggable="false">${text}</a>`;
    },
});
/**
 * Blockquote renderer that processes GitHub-style alert syntax.
 * Transforms blockquotes like "> [!NOTE]" into structured alert markup with icons.
 *
 * Based on GitHub's alert syntax: https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax#alerts
 */
function createAlertBlockquoteRenderer(fallbackRenderer) {
    return function (token) {
        const { tokens } = token;
        // Check if this blockquote starts with alert syntax [!TYPE]
        const firstToken = tokens[0];
        if (firstToken?.type !== 'paragraph') {
            return fallbackRenderer.call(this, token);
        }
        const paragraphTokens = firstToken.tokens;
        if (!paragraphTokens || paragraphTokens.length === 0) {
            return fallbackRenderer.call(this, token);
        }
        const firstTextToken = paragraphTokens[0];
        if (firstTextToken?.type !== 'text') {
            return fallbackRenderer.call(this, token);
        }
        const pattern = /^\s*\[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]\s*?\n*/i;
        const match = firstTextToken.raw.match(pattern);
        if (!match) {
            return fallbackRenderer.call(this, token);
        }
        // Remove the alert marker from the token
        firstTextToken.raw = firstTextToken.raw.replace(pattern, '');
        firstTextToken.text = firstTextToken.text.replace(pattern, '');
        const alertIcons = {
            'note': 'info',
            'tip': 'light-bulb',
            'important': 'comment',
            'warning': 'alert',
            'caution': 'stop'
        };
        const type = match[1];
        const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
        const severity = type.toLowerCase();
        const iconHtml = renderIcon({ id: alertIcons[severity] }).outerHTML;
        // Render the remaining content
        const content = this.parser.parse(tokens);
        // Return alert markup with icon and severity (skipping the first 3 characters: `<p>`)
        return `<blockquote data-severity="${severity}"><p><span>${iconHtml}${typeCapitalized}</span>${content.substring(3)}</blockquote>\n`;
    };
}
/**
 * Low-level way create a html element from a markdown string.
 *
 * **Note** that for most cases you should be using {@link import('../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js').MarkdownRenderer MarkdownRenderer}
 * which comes with support for pretty code block rendering and which uses the default way of handling links.
 */
function renderMarkdown(markdown, options = {}, target) {
    const disposables = new DisposableStore();
    let isDisposed = false;
    const markedInstance = new Marked(...(options.markedExtensions ?? []));
    const { renderer, codeBlocks, syncCodeBlocks } = createMarkdownRenderer(markedInstance, options, markdown);
    const value = preprocessMarkdownString(markdown);
    let renderedMarkdown;
    if (options.fillInIncompleteTokens) {
        // The defaults are applied by parse but not lexer()/parser(), and they need to be present
        const opts = {
            ...markedInstance.defaults,
            ...options.markedOptions,
            renderer
        };
        const tokens = markedInstance.lexer(value, opts);
        const newTokens = fillInIncompleteTokens(tokens);
        renderedMarkdown = markedInstance.parser(newTokens, opts);
    }
    else {
        renderedMarkdown = markedInstance.parse(value, { ...options?.markedOptions, renderer, async: false });
    }
    // Rewrite theme icons
    if (markdown.supportThemeIcons) {
        const elements = renderLabelWithIcons(renderedMarkdown);
        renderedMarkdown = elements.map(e => typeof e === 'string' ? e : e.outerHTML).join('');
    }
    const renderedContent = document.createElement('div');
    const sanitizerConfig = getDomSanitizerConfig(markdown, options.sanitizerConfig ?? {});
    safeSetInnerHtml(renderedContent, renderedMarkdown, sanitizerConfig);
    // Rewrite links and images before potentially inserting them into the real dom
    rewriteRenderedLinks(markdown, options, renderedContent);
    let outElement;
    if (target) {
        outElement = target;
        reset(target, ...renderedContent.children);
    }
    else {
        outElement = renderedContent;
    }
    if (codeBlocks.length > 0) {
        Promise.all(codeBlocks).then((tuples) => {
            if (isDisposed) {
                return;
            }
            const renderedElements = new Map(tuples);
            // eslint-disable-next-line no-restricted-syntax
            const placeholderElements = outElement.querySelectorAll(`div[data-code]`);
            for (const placeholderElement of placeholderElements) {
                const renderedElement = renderedElements.get(placeholderElement.dataset['code'] ?? '');
                if (renderedElement) {
                    reset(placeholderElement, renderedElement);
                }
            }
            options.asyncRenderCallback?.();
        });
    }
    else if (syncCodeBlocks.length > 0) {
        const renderedElements = new Map(syncCodeBlocks);
        // eslint-disable-next-line no-restricted-syntax
        const placeholderElements = outElement.querySelectorAll(`div[data-code]`);
        for (const placeholderElement of placeholderElements) {
            const renderedElement = renderedElements.get(placeholderElement.dataset['code'] ?? '');
            if (renderedElement) {
                reset(placeholderElement, renderedElement);
            }
        }
    }
    // Signal size changes for image tags
    if (options.asyncRenderCallback) {
        // eslint-disable-next-line no-restricted-syntax
        for (const img of outElement.getElementsByTagName('img')) {
            const listener = disposables.add(addDisposableListener(img, 'load', () => {
                listener.dispose();
                options.asyncRenderCallback();
            }));
        }
    }
    // Add event listeners for links
    if (options.actionHandler) {
        const clickCb = (e) => {
            const mouseEvent = new StandardMouseEvent(getWindow(outElement), e);
            if (!mouseEvent.leftButton && !mouseEvent.middleButton) {
                return;
            }
            activateLink(markdown, options, mouseEvent);
        };
        disposables.add(addDisposableListener(outElement, 'click', clickCb));
        disposables.add(addDisposableListener(outElement, 'auxclick', clickCb));
        disposables.add(addDisposableListener(outElement, 'keydown', (e) => {
            const keyboardEvent = new StandardKeyboardEvent(e);
            if (!keyboardEvent.equals(10 /* KeyCode.Space */) && !keyboardEvent.equals(3 /* KeyCode.Enter */)) {
                return;
            }
            activateLink(markdown, options, keyboardEvent);
        }));
    }
    // Remove/disable inputs
    // eslint-disable-next-line no-restricted-syntax
    for (const input of [...outElement.getElementsByTagName('input')]) {
        if (input.attributes.getNamedItem('type')?.value === 'checkbox') {
            input.setAttribute('disabled', '');
        }
        else {
            if (options.sanitizerConfig?.replaceWithPlaintext) {
                const replacement = convertTagToPlaintext(input);
                if (replacement) {
                    input.parentElement?.replaceChild(replacement, input);
                }
                else {
                    input.remove();
                }
            }
            else {
                input.remove();
            }
        }
    }
    return {
        element: outElement,
        dispose: () => {
            isDisposed = true;
            disposables.dispose();
        }
    };
}
function rewriteRenderedLinks(markdown, options, root) {
    // eslint-disable-next-line no-restricted-syntax
    for (const el of root.querySelectorAll('img, audio, video, source')) {
        const src = el.getAttribute('src'); // Get the raw 'src' attribute value as text, not the resolved 'src'
        if (src) {
            let href = src;
            try {
                if (markdown.baseUri) { // absolute or relative local path, or file: uri
                    href = resolveWithBaseUri(URI.from(markdown.baseUri), href);
                }
            }
            catch (err) { }
            el.setAttribute('src', massageHref(markdown, href, true));
            if (options.sanitizerConfig?.remoteImageIsAllowed) {
                const uri = URI.parse(href);
                if (uri.scheme !== Schemas.file && uri.scheme !== Schemas.data && !options.sanitizerConfig.remoteImageIsAllowed(uri)) {
                    el.replaceWith($('', undefined, el.outerHTML));
                }
            }
        }
    }
    // eslint-disable-next-line no-restricted-syntax
    for (const el of root.querySelectorAll('a')) {
        const href = el.getAttribute('href'); // Get the raw 'href' attribute value as text, not the resolved 'href'
        el.setAttribute('href', ''); // Clear out href. We use the `data-href` for handling clicks instead
        if (!href
            || /^data:|javascript:/i.test(href)
            || (/^command:/i.test(href) && !markdown.isTrusted)
            || /^command:(\/\/\/)?_workbench\.downloadResource/i.test(href)) {
            // drop the link
            el.replaceWith(...el.childNodes);
        }
        else {
            let resolvedHref = massageHref(markdown, href, false);
            if (markdown.baseUri) {
                resolvedHref = resolveWithBaseUri(URI.from(markdown.baseUri), href);
            }
            el.dataset.href = resolvedHref;
        }
    }
}
function createMarkdownRenderer(marked, options, markdown) {
    const renderer = new marked.Renderer(options.markedOptions);
    renderer.image = defaultMarkedRenderers.image;
    renderer.link = defaultMarkedRenderers.link;
    renderer.paragraph = defaultMarkedRenderers.paragraph;
    if (markdown.supportAlertSyntax) {
        renderer.blockquote = createAlertBlockquoteRenderer(renderer.blockquote);
    }
    // Will collect [id, renderedElement] tuples
    const codeBlocks = [];
    const syncCodeBlocks = [];
    if (options.codeBlockRendererSync) {
        renderer.code = ({ text, lang, raw }) => {
            const id = defaultGenerator.nextId();
            const value = options.codeBlockRendererSync(postProcessCodeBlockLanguageId(lang), text, raw);
            syncCodeBlocks.push([id, value]);
            return `<div class="code" data-code="${id}">${escape(text)}</div>`;
        };
    }
    else if (options.codeBlockRenderer) {
        renderer.code = ({ text, lang }) => {
            const id = defaultGenerator.nextId();
            const value = options.codeBlockRenderer(postProcessCodeBlockLanguageId(lang), text);
            codeBlocks.push(value.then(element => [id, element]));
            return `<div class="code" data-code="${id}">${escape(text)}</div>`;
        };
    }
    if (!markdown.supportHtml) {
        // Note: we always pass the output through dompurify after this so that we don't rely on
        // marked for real sanitization.
        renderer.html = ({ text }) => {
            if (options.sanitizerConfig?.replaceWithPlaintext) {
                return escape(text);
            }
            const match = markdown.isTrusted ? text.match(/^(<span[^>]+>)|(<\/\s*span>)$/) : undefined;
            return match ? text : '';
        };
    }
    return { renderer, codeBlocks, syncCodeBlocks };
}
function preprocessMarkdownString(markdown) {
    let value = markdown.value;
    // values that are too long will freeze the UI
    if (value.length > 100_000) {
        value = `${value.substr(0, 100_000)}â€¦`;
    }
    // escape theme icons
    if (markdown.supportThemeIcons) {
        value = markdownEscapeEscapedIcons(value);
    }
    return value;
}
function activateLink(mdStr, options, event) {
    const target = event.target.closest('a[data-href]');
    if (!isHTMLElement(target)) {
        return;
    }
    try {
        let href = target.dataset['href'];
        if (href) {
            if (mdStr.baseUri) {
                href = resolveWithBaseUri(URI.from(mdStr.baseUri), href);
            }
            options.actionHandler?.(href, mdStr);
        }
    }
    catch (err) {
        onUnexpectedError(err);
    }
    finally {
        event.preventDefault();
    }
}
function uriMassage(markdown, part) {
    let data;
    try {
        data = parse(decodeURIComponent(part));
    }
    catch (e) {
        // ignore
    }
    if (!data) {
        return part;
    }
    data = cloneAndChange(data, value => {
        if (markdown.uris && markdown.uris[value]) {
            return URI.revive(markdown.uris[value]);
        }
        else {
            return undefined;
        }
    });
    return encodeURIComponent(JSON.stringify(data));
}
function massageHref(markdown, href, isDomUri) {
    const data = markdown.uris && markdown.uris[href];
    let uri = URI.revive(data);
    if (isDomUri) {
        if (href.startsWith(Schemas.data + ':')) {
            return href;
        }
        if (!uri) {
            uri = URI.parse(href);
        }
        // this URI will end up as "src"-attribute of a dom node
        // and because of that special rewriting needs to be done
        // so that the URI uses a protocol that's understood by
        // browsers (like http or https)
        return FileAccess.uriToBrowserUri(uri).toString(true);
    }
    if (!uri) {
        return href;
    }
    if (URI.parse(href).toString() === uri.toString()) {
        return href; // no transformation performed
    }
    if (uri.query) {
        uri = uri.with({ query: uriMassage(markdown, uri.query) });
    }
    return uri.toString();
}
function postProcessCodeBlockLanguageId(lang) {
    if (!lang) {
        return '';
    }
    const parts = lang.split(/[\s+|:|,|\{|\?]/, 1);
    if (parts.length) {
        return parts[0];
    }
    return lang;
}
function resolveWithBaseUri(baseUri, href) {
    const hasScheme = /^\w[\w\d+.-]*:/.test(href);
    if (hasScheme) {
        return href;
    }
    if (baseUri.path.endsWith('/')) {
        return resolvePath(baseUri, href).toString();
    }
    else {
        return resolvePath(dirname(baseUri), href).toString();
    }
}
function sanitizeRenderedMarkdown(renderedMarkdown, originalMdStrConfig, options = {}) {
    const sanitizerConfig = getDomSanitizerConfig(originalMdStrConfig, options);
    return sanitizeHtml(renderedMarkdown, sanitizerConfig);
}
const allowedMarkdownHtmlTags = Object.freeze([
    ...basicMarkupHtmlTags,
    'input', // Allow inputs for rendering checkboxes. Other types of inputs are removed and the inputs are always disabled
]);
const allowedMarkdownHtmlAttributes = Object.freeze([
    'align',
    'autoplay',
    'alt',
    'colspan',
    'controls',
    'draggable',
    'height',
    'href',
    'loop',
    'muted',
    'playsinline',
    'poster',
    'rowspan',
    'src',
    'target',
    'title',
    'type',
    'width',
    'start',
    // Input (For disabled inputs)
    'checked',
    'disabled',
    'value',
    // Custom markdown attributes
    'data-code',
    'data-href',
    'data-severity',
    // Only allow very specific styles
    {
        attributeName: 'style',
        shouldKeep: (element, data) => {
            if (element.tagName === 'SPAN') {
                if (data.attrName === 'style') {
                    return /^(color\:(#[0-9a-fA-F]+|var\(--vscode(-[a-zA-Z0-9]+)+\));)?(background-color\:(#[0-9a-fA-F]+|var\(--vscode(-[a-zA-Z0-9]+)+\));)?(border-radius:[0-9]+px;)?$/.test(data.attrValue);
                }
            }
            return false;
        }
    },
    // Only allow codicons for classes
    {
        attributeName: 'class',
        shouldKeep: (element, data) => {
            if (element.tagName === 'SPAN') {
                if (data.attrName === 'class') {
                    return /^codicon codicon-[a-z\-]+( codicon-modifier-[a-z\-]+)?$/.test(data.attrValue);
                }
            }
            return false;
        },
    },
]);
function getDomSanitizerConfig(mdStrConfig, options) {
    const isTrusted = mdStrConfig.isTrusted ?? false;
    const allowedLinkSchemes = [
        Schemas.http,
        Schemas.https,
        Schemas.mailto,
        Schemas.file,
        Schemas.vscodeFileResource,
        Schemas.vscodeRemote,
        Schemas.vscodeRemoteResource,
        Schemas.vscodeNotebookCell
    ];
    if (isTrusted) {
        allowedLinkSchemes.push(Schemas.command);
    }
    if (options.allowedLinkSchemes?.augment) {
        allowedLinkSchemes.push(...options.allowedLinkSchemes.augment);
    }
    return {
        // allowedTags should included everything that markdown renders to.
        // Since we have our own sanitize function for marked, it's possible we missed some tag so let dompurify make sure.
        // HTML tags that can result from markdown are from reading https://spec.commonmark.org/0.29/
        // HTML table tags that can result from markdown are from https://github.github.com/gfm/#tables-extension-
        allowedTags: {
            override: options.allowedTags?.override ?? allowedMarkdownHtmlTags
        },
        allowedAttributes: {
            override: options.allowedAttributes?.override ?? allowedMarkdownHtmlAttributes,
        },
        allowedLinkProtocols: {
            override: allowedLinkSchemes,
        },
        allowRelativeLinkPaths: !!mdStrConfig.baseUri,
        allowedMediaProtocols: {
            override: [
                Schemas.http,
                Schemas.https,
                Schemas.data,
                Schemas.file,
                Schemas.vscodeFileResource,
                Schemas.vscodeRemote,
                Schemas.vscodeRemoteResource,
            ]
        },
        allowRelativeMediaPaths: !!mdStrConfig.baseUri,
        replaceWithPlaintext: options.replaceWithPlaintext,
    };
}
/**
 * Renders `str` as plaintext, stripping out Markdown syntax if it's a {@link IMarkdownString}.
 *
 * For example `# Header` would be output as `Header`.
 */
function renderAsPlaintext(str, options) {
    if (typeof str === 'string') {
        return str;
    }
    // values that are too long will freeze the UI
    let value = str.value ?? '';
    if (value.length > 100_000) {
        value = `${value.substr(0, 100_000)}â€¦`;
    }
    const html = parse$1(value, { async: false, renderer: plainTextRenderer.value });
    return sanitizeRenderedMarkdown(html, { isTrusted: false }, {})
        .toString()
        .replace(/&(#\d+|[a-zA-Z]+);/g, m => unescapeInfo.get(m) ?? m)
        .trim();
}
const unescapeInfo = new Map([
    ['&quot;', '"'],
    ['&nbsp;', ' '],
    ['&amp;', '&'],
    ['&#39;', '\''],
    ['&lt;', '<'],
    ['&gt;', '>'],
]);
function createPlainTextRenderer() {
    const renderer = new _Renderer();
    renderer.code = ({ text }) => {
        return escape(text);
    };
    renderer.blockquote = ({ text }) => {
        return text + '\n';
    };
    renderer.html = (_) => {
        return '';
    };
    renderer.heading = function ({ tokens }) {
        return this.parser.parseInline(tokens) + '\n';
    };
    renderer.hr = () => {
        return '';
    };
    renderer.list = function ({ items }) {
        return items.map(x => this.listitem(x)).join('\n') + '\n';
    };
    renderer.listitem = ({ text }) => {
        return text + '\n';
    };
    renderer.paragraph = function ({ tokens }) {
        return this.parser.parseInline(tokens) + '\n';
    };
    renderer.table = function ({ header, rows }) {
        return header.map(cell => this.tablecell(cell)).join(' ') + '\n' + rows.map(cells => cells.map(cell => this.tablecell(cell)).join(' ')).join('\n') + '\n';
    };
    renderer.tablerow = ({ text }) => {
        return text;
    };
    renderer.tablecell = function ({ tokens }) {
        return this.parser.parseInline(tokens);
    };
    renderer.strong = ({ text }) => {
        return text;
    };
    renderer.em = ({ text }) => {
        return text;
    };
    renderer.codespan = ({ text }) => {
        return escape(text);
    };
    renderer.br = (_) => {
        return '\n';
    };
    renderer.del = ({ text }) => {
        return text;
    };
    renderer.image = (_) => {
        return '';
    };
    renderer.text = ({ text }) => {
        return text;
    };
    renderer.link = ({ text }) => {
        return text;
    };
    return renderer;
}
const plainTextRenderer = new Lazy(createPlainTextRenderer);
new Lazy(() => {
    const renderer = createPlainTextRenderer();
    renderer.code = ({ text }) => {
        return `\n\`\`\`\n${escape(text)}\n\`\`\`\n`;
    };
    return renderer;
});
function mergeRawTokenText(tokens) {
    let mergedTokenText = '';
    tokens.forEach(token => {
        mergedTokenText += token.raw;
    });
    return mergedTokenText;
}
function completeSingleLinePattern(token) {
    if (!token.tokens) {
        return undefined;
    }
    for (let i = token.tokens.length - 1; i >= 0; i--) {
        const subtoken = token.tokens[i];
        if (subtoken.type === 'text') {
            const lines = subtoken.raw.split('\n');
            const lastLine = lines[lines.length - 1];
            if (lastLine.includes('`')) {
                return completeCodespan(token);
            }
            else if (lastLine.includes('**')) {
                return completeDoublestar(token);
            }
            else if (lastLine.match(/\*\w/)) {
                return completeStar(token);
            }
            else if (lastLine.match(/(^|\s)__\w/)) {
                return completeDoubleUnderscore(token);
            }
            else if (lastLine.match(/(^|\s)_\w/)) {
                return completeUnderscore(token);
            }
            else if (
            // Text with start of link target
            hasLinkTextAndStartOfLinkTarget(lastLine) ||
                // This token doesn't have the link text, eg if it contains other markdown constructs that are in other subtokens.
                // But some preceding token does have an unbalanced [ at least
                hasStartOfLinkTargetAndNoLinkText(lastLine) && token.tokens.slice(0, i).some(t => t.type === 'text' && t.raw.match(/\[[^\]]*$/))) {
                const nextTwoSubTokens = token.tokens.slice(i + 1);
                // A markdown link can look like
                // [link text](https://microsoft.com "more text")
                // Where "more text" is a title for the link or an argument to a vscode command link
                if (
                // If the link was parsed as a link, then look for a link token and a text token with a quote
                nextTwoSubTokens[0]?.type === 'link' && nextTwoSubTokens[1]?.type === 'text' && nextTwoSubTokens[1].raw.match(/^ *"[^"]*$/) ||
                    // And if the link was not parsed as a link (eg command link), just look for a single quote in this token
                    lastLine.match(/^[^"]* +"[^"]*$/)) {
                    return completeLinkTargetArg(token);
                }
                return completeLinkTarget(token);
            }
            // Contains the start of link text, and no following tokens contain the link target
            else if (lastLine.match(/(^|\s)\[\w*[^\]]*$/)) {
                return completeLinkText(token);
            }
        }
    }
    return undefined;
}
function hasLinkTextAndStartOfLinkTarget(str) {
    return !!str.match(/(^|\s)\[.*\]\(\w*/);
}
function hasStartOfLinkTargetAndNoLinkText(str) {
    return !!str.match(/^[^\[]*\]\([^\)]*$/);
}
function completeListItemPattern(list) {
    // Patch up this one list item
    const lastListItem = list.items[list.items.length - 1];
    const lastListSubToken = lastListItem.tokens ? lastListItem.tokens[lastListItem.tokens.length - 1] : undefined;
    /*
    Example list token structures:

    list
        list_item
            text
                text
                codespan
                link
        list_item
            text
            code // Complete indented codeblock
        list_item
            text
            space
            text
                text // Incomplete indented codeblock
        list_item
            text
            list // Nested list
                list_item
                    text
                        text

    Contrast with paragraph:
    paragraph
        text
        codespan
    */
    const listEndsInHeading = (list) => {
        // A list item can be rendered as a heading for some reason when it has a subitem where we haven't rendered the text yet like this:
        // 1. list item
        //    -
        const lastItem = list.items.at(-1);
        const lastToken = lastItem?.tokens.at(-1);
        return lastToken?.type === 'heading' || lastToken?.type === 'list' && listEndsInHeading(lastToken);
    };
    let newToken;
    if (lastListSubToken?.type === 'text' && !('inRawBlock' in lastListItem)) { // Why does Tag have a type of 'text'
        newToken = completeSingleLinePattern(lastListSubToken);
    }
    else if (listEndsInHeading(list)) {
        const newList = lexer(list.raw.trim() + ' &nbsp;')[0];
        if (newList.type !== 'list') {
            // Something went wrong
            return;
        }
        return newList;
    }
    if (!newToken || newToken.type !== 'paragraph') { // 'text' item inside the list item turns into paragraph
        // Nothing to fix, or not a pattern we were expecting
        return;
    }
    const previousListItemsText = mergeRawTokenText(list.items.slice(0, -1));
    // Grabbing the `- ` or `1. ` or `* ` off the list item because I can't find a better way to do this
    const lastListItemLead = lastListItem.raw.match(/^(\s*(-|\d+\.|\*) +)/)?.[0];
    if (!lastListItemLead) {
        // Is badly formatted
        return;
    }
    const newListItemText = lastListItemLead +
        mergeRawTokenText(lastListItem.tokens.slice(0, -1)) +
        newToken.raw;
    const newList = lexer(previousListItemsText + newListItemText)[0];
    if (newList.type !== 'list') {
        // Something went wrong
        return;
    }
    return newList;
}
function completeHeading(token, fullRawText) {
    if (token.raw.match(/-\s*$/)) {
        return lexer(fullRawText + ' &nbsp;');
    }
}
const maxIncompleteTokensFixRounds = 3;
function fillInIncompleteTokens(tokens) {
    for (let i = 0; i < maxIncompleteTokensFixRounds; i++) {
        const newTokens = fillInIncompleteTokensOnce(tokens);
        if (newTokens) {
            tokens = newTokens;
        }
        else {
            break;
        }
    }
    return tokens;
}
function fillInIncompleteTokensOnce(tokens) {
    let i;
    let newTokens;
    for (i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        if (token.type === 'paragraph' && token.raw.match(/(\n|^)\|/)) {
            newTokens = completeTable(tokens.slice(i));
            break;
        }
    }
    const lastToken = tokens.at(-1);
    if (!newTokens && lastToken?.type === 'list') {
        const newListToken = completeListItemPattern(lastToken);
        if (newListToken) {
            newTokens = [newListToken];
            i = tokens.length - 1;
        }
    }
    if (!newTokens && lastToken?.type === 'paragraph') {
        // Only operates on a single token, because any newline that follows this should break these patterns
        const newToken = completeSingleLinePattern(lastToken);
        if (newToken) {
            newTokens = [newToken];
            i = tokens.length - 1;
        }
    }
    if (newTokens) {
        const newTokensList = [
            ...tokens.slice(0, i),
            ...newTokens
        ];
        newTokensList.links = tokens.links;
        return newTokensList;
    }
    if (lastToken?.type === 'heading') {
        const completeTokens = completeHeading(lastToken, mergeRawTokenText(tokens));
        if (completeTokens) {
            return completeTokens;
        }
    }
    return null;
}
function completeCodespan(token) {
    return completeWithString(token, '`');
}
function completeStar(tokens) {
    return completeWithString(tokens, '*');
}
function completeUnderscore(tokens) {
    return completeWithString(tokens, '_');
}
function completeLinkTarget(tokens) {
    return completeWithString(tokens, ')', false);
}
function completeLinkTargetArg(tokens) {
    return completeWithString(tokens, '")', false);
}
function completeLinkText(tokens) {
    return completeWithString(tokens, '](https://microsoft.com)', false);
}
function completeDoublestar(tokens) {
    return completeWithString(tokens, '**');
}
function completeDoubleUnderscore(tokens) {
    return completeWithString(tokens, '__');
}
function completeWithString(tokens, closingString, shouldTrim = true) {
    const mergedRawText = mergeRawTokenText(Array.isArray(tokens) ? tokens : [tokens]);
    // If it was completed correctly, this should be a single token.
    // Expecting either a Paragraph or a List
    const trimmedRawText = shouldTrim ? mergedRawText.trimEnd() : mergedRawText;
    return lexer(trimmedRawText + closingString)[0];
}
function completeTable(tokens) {
    const mergedRawText = mergeRawTokenText(tokens);
    const lines = mergedRawText.split('\n');
    let numCols; // The number of line1 col headers
    let hasSeparatorRow = false;
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (typeof numCols === 'undefined' && line.match(/^\s*\|/)) {
            const line1Matches = line.match(/(\|[^\|]+)(?=\||$)/g);
            if (line1Matches) {
                numCols = line1Matches.length;
            }
        }
        else if (typeof numCols === 'number') {
            if (line.match(/^\s*\|/)) {
                if (i !== lines.length - 1) {
                    // We got the line1 header row, and the line2 separator row, but there are more lines, and it wasn't parsed as a table!
                    // That's strange and means that the table is probably malformed in the source, so I won't try to patch it up.
                    return undefined;
                }
                // Got a line2 separator row- partial or complete, doesn't matter, we'll replace it with a correct one
                hasSeparatorRow = true;
            }
            else {
                // The line after the header row isn't a valid separator row, so the table is malformed, don't fix it up
                return undefined;
            }
        }
    }
    if (typeof numCols === 'number' && numCols > 0) {
        const prefixText = hasSeparatorRow ? lines.slice(0, -1).join('\n') : mergedRawText;
        const line1EndsInPipe = !!prefixText.match(/\|\s*$/);
        const newRawText = prefixText + (line1EndsInPipe ? '' : '|') + `\n|${' --- |'.repeat(numCols)}`;
        return lexer(newRawText);
    }
    return undefined;
}

export { allowedMarkdownHtmlAttributes, allowedMarkdownHtmlTags, fillInIncompleteTokens, renderAsPlaintext, renderMarkdown };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/base/browser/ui/toolbar/toolbar.js
================================================================================

import { ActionBar } from '../actionbar/actionbar.js';
import { DropdownMenuActionViewItem } from '../dropdown/dropdownActionViewItem.js';
import { Action, SubmenuAction, Separator } from '../../../common/actions.js';
import { Codicon } from '../../../common/codicons.js';
import { ThemeIcon } from '../../../common/themables.js';
import { EventMultiplexer } from '../../../common/event.js';
import { Disposable, DisposableStore, toDisposable } from '../../../common/lifecycle.js';
import './toolbar.css';
import { localize } from '../../../../nls.js';
import { createInstantHoverDelegate } from '../hover/hoverDelegateFactory.js';

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
const ACTION_MIN_WIDTH = 24; /* 20px codicon + 4px left padding*/
/**
 * A widget that combines an action bar for primary actions and a dropdown for secondary actions.
 */
class ToolBar extends Disposable {
    get onDidChangeDropdownVisibility() { return this._onDidChangeDropdownVisibility.event; }
    constructor(container, contextMenuProvider, options = { orientation: 0 /* ActionsOrientation.HORIZONTAL */ }) {
        super();
        this.submenuActionViewItems = [];
        this.hasSecondaryActions = false;
        this._onDidChangeDropdownVisibility = this._register(new EventMultiplexer());
        this.originalPrimaryActions = [];
        this.originalSecondaryActions = [];
        this.hiddenActions = [];
        this.disposables = this._register(new DisposableStore());
        options.hoverDelegate = options.hoverDelegate ?? this._register(createInstantHoverDelegate());
        this.options = options;
        this.toggleMenuAction = this._register(new ToggleMenuAction(() => this.toggleMenuActionViewItem?.show(), options.toggleMenuTitle));
        this.element = document.createElement('div');
        this.element.className = 'monaco-toolbar';
        container.appendChild(this.element);
        this.actionBar = this._register(new ActionBar(this.element, {
            orientation: options.orientation,
            ariaLabel: options.ariaLabel,
            actionRunner: options.actionRunner,
            allowContextMenu: options.allowContextMenu,
            highlightToggledItems: options.highlightToggledItems,
            hoverDelegate: options.hoverDelegate,
            actionViewItemProvider: (action, viewItemOptions) => {
                if (action.id === ToggleMenuAction.ID) {
                    this.toggleMenuActionViewItem = new DropdownMenuActionViewItem(action, { getActions: () => this.toggleMenuAction.menuActions }, contextMenuProvider, {
                        actionViewItemProvider: this.options.actionViewItemProvider,
                        actionRunner: this.actionRunner,
                        keybindingProvider: this.options.getKeyBinding,
                        classNames: ThemeIcon.asClassNameArray(options.moreIcon ?? Codicon.toolBarMore),
                        anchorAlignmentProvider: this.options.anchorAlignmentProvider,
                        menuAsChild: !!this.options.renderDropdownAsChildElement,
                        skipTelemetry: this.options.skipTelemetry,
                        isMenu: true,
                        hoverDelegate: this.options.hoverDelegate
                    });
                    this.toggleMenuActionViewItem.setActionContext(this.actionBar.context);
                    this.disposables.add(this._onDidChangeDropdownVisibility.add(this.toggleMenuActionViewItem.onDidChangeVisibility));
                    return this.toggleMenuActionViewItem;
                }
                if (options.actionViewItemProvider) {
                    const result = options.actionViewItemProvider(action, viewItemOptions);
                    if (result) {
                        return result;
                    }
                }
                if (action instanceof SubmenuAction) {
                    const result = new DropdownMenuActionViewItem(action, action.actions, contextMenuProvider, {
                        actionViewItemProvider: this.options.actionViewItemProvider,
                        actionRunner: this.actionRunner,
                        keybindingProvider: this.options.getKeyBinding,
                        classNames: action.class,
                        anchorAlignmentProvider: this.options.anchorAlignmentProvider,
                        menuAsChild: !!this.options.renderDropdownAsChildElement,
                        skipTelemetry: this.options.skipTelemetry,
                        hoverDelegate: this.options.hoverDelegate
                    });
                    result.setActionContext(this.actionBar.context);
                    this.submenuActionViewItems.push(result);
                    this.disposables.add(this._onDidChangeDropdownVisibility.add(result.onDidChangeVisibility));
                    return result;
                }
                return undefined;
            }
        }));
        // Responsive support
        if (this.options.responsive) {
            this.element.classList.add('responsive');
            const observer = new ResizeObserver(() => {
                this.setToolbarMaxWidth(this.element.getBoundingClientRect().width);
            });
            observer.observe(this.element);
            this._store.add(toDisposable(() => observer.disconnect()));
        }
    }
    set actionRunner(actionRunner) {
        this.actionBar.actionRunner = actionRunner;
    }
    get actionRunner() {
        return this.actionBar.actionRunner;
    }
    set context(context) {
        this.actionBar.context = context;
        this.toggleMenuActionViewItem?.setActionContext(context);
        for (const actionViewItem of this.submenuActionViewItems) {
            actionViewItem.setActionContext(context);
        }
    }
    getElement() {
        return this.element;
    }
    getItemAction(indexOrElement) {
        return this.actionBar.getAction(indexOrElement);
    }
    getItemWidth(index) {
        return this.actionBar.getWidth(index);
    }
    setActions(primaryActions, secondaryActions) {
        this.clear();
        // Store primary and secondary actions as rendered initially
        this.originalPrimaryActions = primaryActions ? primaryActions.slice(0) : [];
        this.originalSecondaryActions = secondaryActions ? secondaryActions.slice(0) : [];
        const primaryActionsToSet = primaryActions ? primaryActions.slice(0) : [];
        // Inject additional action to open secondary actions if present
        this.hasSecondaryActions = !!(secondaryActions && secondaryActions.length > 0);
        if (this.hasSecondaryActions && secondaryActions) {
            this.toggleMenuAction.menuActions = secondaryActions.slice(0);
            primaryActionsToSet.push(this.toggleMenuAction);
        }
        if (primaryActionsToSet.length > 0 && this.options.trailingSeparator) {
            primaryActionsToSet.push(new Separator());
        }
        primaryActionsToSet.forEach(action => {
            this.actionBar.push(action, { icon: this.options.icon ?? true, label: this.options.label ?? false, keybinding: this.getKeybindingLabel(action) });
        });
        if (this.options.responsive) {
            // Reset hidden actions
            this.hiddenActions.length = 0;
            // Update toolbar to fit with container width
            this.setToolbarMaxWidth(this.element.getBoundingClientRect().width);
        }
    }
    getKeybindingLabel(action) {
        const key = this.options.getKeyBinding?.(action);
        return key?.getLabel() ?? undefined;
    }
    getItemsWidthResponsive() {
        // Each action is assumed to have a minimum width so that actions with a label
        // can shrink to the action's minimum width. We do this so that action visibility
        // takes precedence over the action label.
        return this.actionBar.length() * ACTION_MIN_WIDTH;
    }
    setToolbarMaxWidth(maxWidth) {
        if (this.actionBar.isEmpty() ||
            (this.getItemsWidthResponsive() <= maxWidth && this.hiddenActions.length === 0)) {
            return;
        }
        if (this.getItemsWidthResponsive() > maxWidth) {
            // Hide actions from the right
            while (this.getItemsWidthResponsive() > maxWidth && this.actionBar.length() > 0) {
                const index = this.originalPrimaryActions.length - this.hiddenActions.length - 1;
                if (index < 0) {
                    break;
                }
                // Store the action and its size
                const size = Math.min(ACTION_MIN_WIDTH, this.getItemWidth(index));
                const action = this.originalPrimaryActions[index];
                this.hiddenActions.unshift({ action, size });
                // Remove the action
                this.actionBar.pull(index);
                // There are no secondary actions, but we have actions that we need to hide so we
                // create the overflow menu. This will ensure that another primary action will be
                // removed making space for the overflow menu.
                if (this.originalSecondaryActions.length === 0 && this.hiddenActions.length === 1) {
                    this.actionBar.push(this.toggleMenuAction, {
                        icon: this.options.icon ?? true,
                        label: this.options.label ?? false,
                        keybinding: this.getKeybindingLabel(this.toggleMenuAction),
                    });
                }
            }
        }
        else {
            // Show actions from the top of the toggle menu
            while (this.hiddenActions.length > 0) {
                const entry = this.hiddenActions.shift();
                if (this.getItemsWidthResponsive() + entry.size > maxWidth) {
                    // Not enough space to show the action
                    this.hiddenActions.unshift(entry);
                    break;
                }
                // Add the action
                this.actionBar.push(entry.action, {
                    icon: this.options.icon ?? true,
                    label: this.options.label ?? false,
                    keybinding: this.getKeybindingLabel(entry.action),
                    index: this.originalPrimaryActions.length - this.hiddenActions.length - 1
                });
                // There are no secondary actions, and there is only one hidden item left so we
                // remove the overflow menu making space for the last hidden action to be shown.
                if (this.originalSecondaryActions.length === 0 && this.hiddenActions.length === 1) {
                    this.toggleMenuAction.menuActions = [];
                    this.actionBar.pull(this.actionBar.length() - 1);
                }
            }
        }
        // Update overflow menu
        const hiddenActions = this.hiddenActions.map(entry => entry.action);
        if (this.originalSecondaryActions.length > 0 || hiddenActions.length > 0) {
            const secondaryActions = this.originalSecondaryActions.slice(0);
            this.toggleMenuAction.menuActions = Separator.join(hiddenActions, secondaryActions);
        }
    }
    clear() {
        this.submenuActionViewItems = [];
        this.disposables.clear();
        this.actionBar.clear();
    }
    dispose() {
        this.clear();
        this.disposables.dispose();
        super.dispose();
    }
}
class ToggleMenuAction extends Action {
    static { this.ID = 'toolbar.toggle.more'; }
    constructor(toggleDropdownMenu, title) {
        title = title || localize(17, "More Actions...");
        super(ToggleMenuAction.ID, title, undefined, true);
        this._menuActions = [];
        this.toggleDropdownMenu = toggleDropdownMenu;
    }
    async run() {
        this.toggleDropdownMenu();
    }
    get menuActions() {
        return this._menuActions;
    }
    set menuActions(actions) {
        this._menuActions = actions;
    }
}

export { ToggleMenuAction, ToolBar };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/basic-languages/markdown/markdown.js
================================================================================

const conf = {
  comments: {
    blockComment: ["<!--", "-->"]
  },
  brackets: [
    ["{", "}"],
    ["[", "]"],
    ["(", ")"]
  ],
  autoClosingPairs: [
    { open: "{", close: "}" },
    { open: "[", close: "]" },
    { open: "(", close: ")" },
    { open: "<", close: ">", notIn: ["string"] }
  ],
  surroundingPairs: [
    { open: "(", close: ")" },
    { open: "[", close: "]" },
    { open: "`", close: "`" }
  ],
  folding: {
    markers: {
      start: new RegExp("^\\s*<!--\\s*#?region\\b.*-->"),
      end: new RegExp("^\\s*<!--\\s*#?endregion\\b.*-->")
    }
  }
};
const language = {
  defaultToken: "",
  tokenPostfix: ".md",
  // escape codes
  control: /[\\`*_\[\]{}()#+\-\.!]/,
  noncontrol: /[^\\`*_\[\]{}()#+\-\.!]/,
  escapes: /\\(?:@control)/,
  // escape codes for javascript/CSS strings
  jsescapes: /\\(?:[btnfr\\"']|[0-7][0-7]?|[0-3][0-7]{2})/,
  // non matched elements
  empty: [
    "area",
    "base",
    "basefont",
    "br",
    "col",
    "frame",
    "hr",
    "img",
    "input",
    "isindex",
    "link",
    "meta",
    "param"
  ],
  tokenizer: {
    root: [
      // markdown tables
      [/^\s*\|/, "@rematch", "@table_header"],
      // headers (with #)
      [/^(\s{0,3})(#+)((?:[^\\#]|@escapes)+)((?:#+)?)/, ["white", "keyword", "keyword", "keyword"]],
      // headers (with =)
      [/^\s*(=+|\-+)\s*$/, "keyword"],
      // headers (with ***)
      [/^\s*((\*[ ]?)+)\s*$/, "meta.separator"],
      // quote
      [/^\s*>+/, "comment"],
      // list (starting with * or number)
      [/^\s*([\*\-+:]|\d+\.)\s/, "keyword"],
      // code block (4 spaces indent)
      [/^(\t|[ ]{4})[^ ].*$/, "string"],
      // code block (3 tilde)
      [/^\s*~~~\s*((?:\w|[\/\-#])+)?\s*$/, { token: "string", next: "@codeblock" }],
      // github style code blocks (with backticks and language)
      [
        /^\s*```\s*((?:\w|[\/\-#])+).*$/,
        { token: "string", next: "@codeblockgh", nextEmbedded: "$1" }
      ],
      // github style code blocks (with backticks but no language)
      [/^\s*```\s*$/, { token: "string", next: "@codeblock" }],
      // markup within lines
      { include: "@linecontent" }
    ],
    table_header: [
      { include: "@table_common" },
      [/[^\|]+/, "keyword.table.header"]
      // table header
    ],
    table_body: [{ include: "@table_common" }, { include: "@linecontent" }],
    table_common: [
      [/\s*[\-:]+\s*/, { token: "keyword", switchTo: "table_body" }],
      // header-divider
      [/^\s*\|/, "keyword.table.left"],
      // opening |
      [/^\s*[^\|]/, "@rematch", "@pop"],
      // exiting
      [/^\s*$/, "@rematch", "@pop"],
      // exiting
      [
        /\|/,
        {
          cases: {
            "@eos": "keyword.table.right",
            // closing |
            "@default": "keyword.table.middle"
            // inner |
          }
        }
      ]
    ],
    codeblock: [
      [/^\s*~~~\s*$/, { token: "string", next: "@pop" }],
      [/^\s*```\s*$/, { token: "string", next: "@pop" }],
      [/.*$/, "variable.source"]
    ],
    // github style code blocks
    codeblockgh: [
      [/```\s*$/, { token: "string", next: "@pop", nextEmbedded: "@pop" }],
      [/[^`]+/, "variable.source"]
    ],
    linecontent: [
      // escapes
      [/&\w+;/, "string.escape"],
      [/@escapes/, "escape"],
      // various markup
      [/\b__([^\\_]|@escapes|_(?!_))+__\b/, "strong"],
      [/\*\*([^\\*]|@escapes|\*(?!\*))+\*\*/, "strong"],
      [/\b_[^_]+_\b/, "emphasis"],
      [/\*([^\\*]|@escapes)+\*/, "emphasis"],
      [/`([^\\`]|@escapes)+`/, "variable"],
      // links
      [/\{+[^}]+\}+/, "string.target"],
      [/(!?\[)((?:[^\]\\]|@escapes)*)(\]\([^\)]+\))/, ["string.link", "", "string.link"]],
      [/(!?\[)((?:[^\]\\]|@escapes)*)(\])/, "string.link"],
      // or html
      { include: "html" }
    ],
    // Note: it is tempting to rather switch to the real HTML mode instead of building our own here
    // but currently there is a limitation in Monarch that prevents us from doing it: The opening
    // '<' would start the HTML mode, however there is no way to jump 1 character back to let the
    // HTML mode also tokenize the opening angle bracket. Thus, even though we could jump to HTML,
    // we cannot correctly tokenize it in that mode yet.
    html: [
      // html tags
      [/<(\w+)\/>/, "tag"],
      [
        /<(\w+)(\-|\w)*/,
        {
          cases: {
            "@empty": { token: "tag", next: "@tag.$1" },
            "@default": { token: "tag", next: "@tag.$1" }
          }
        }
      ],
      [/<\/(\w+)(\-|\w)*\s*>/, { token: "tag" }],
      [/<!--/, "comment", "@comment"]
    ],
    comment: [
      [/[^<\-]+/, "comment.content"],
      [/-->/, "comment", "@pop"],
      [/<!--/, "comment.content.invalid"],
      [/[<\-]/, "comment.content"]
    ],
    // Almost full HTML tag matching, complete with embedded scripts & styles
    tag: [
      [/[ \t\r\n]+/, "white"],
      [
        /(type)(\s*=\s*)(")([^"]+)(")/,
        [
          "attribute.name.html",
          "delimiter.html",
          "string.html",
          { token: "string.html", switchTo: "@tag.$S2.$4" },
          "string.html"
        ]
      ],
      [
        /(type)(\s*=\s*)(')([^']+)(')/,
        [
          "attribute.name.html",
          "delimiter.html",
          "string.html",
          { token: "string.html", switchTo: "@tag.$S2.$4" },
          "string.html"
        ]
      ],
      [/(\w+)(\s*=\s*)("[^"]*"|'[^']*')/, ["attribute.name.html", "delimiter.html", "string.html"]],
      [/\w+/, "attribute.name.html"],
      [/\/>/, "tag", "@pop"],
      [
        />/,
        {
          cases: {
            "$S2==style": {
              token: "tag",
              switchTo: "embeddedStyle",
              nextEmbedded: "text/css"
            },
            "$S2==script": {
              cases: {
                $S3: {
                  token: "tag",
                  switchTo: "embeddedScript",
                  nextEmbedded: "$S3"
                },
                "@default": {
                  token: "tag",
                  switchTo: "embeddedScript",
                  nextEmbedded: "text/javascript"
                }
              }
            },
            "@default": { token: "tag", next: "@pop" }
          }
        }
      ]
    ],
    embeddedStyle: [
      [/[^<]+/, ""],
      [/<\/style\s*>/, { token: "@rematch", next: "@pop", nextEmbedded: "@pop" }],
      [/</, ""]
    ],
    embeddedScript: [
      [/[^<]+/, ""],
      [/<\/script\s*>/, { token: "@rematch", next: "@pop", nextEmbedded: "@pop" }],
      [/</, ""]
    ]
  }
};

export { conf, language };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/basic-languages/markdown/markdown.contribution.d.ts
================================================================================

export {}

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/basic-languages/markdown/markdown.contribution.js
================================================================================

import { registerLanguage } from '../_.contribution.js';

registerLanguage({
  id: "markdown",
  extensions: [".md", ".markdown", ".mdown", ".mkdn", ".mkd", ".mdwn", ".mdtxt", ".mdtext"],
  aliases: ["Markdown", "markdown"],
  loader: () => import('./markdown.js')
});

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/editor/contrib/hover/browser/markdownHoverParticipant.js
================================================================================

import { $ as $$1, append } from '../../../../base/browser/dom.js';
import { asArray, compareBy, numberComparator } from '../../../../base/common/arrays.js';
import { CancellationTokenSource } from '../../../../base/common/cancellation.js';
import { MarkdownString, isEmptyMarkdownString } from '../../../../base/common/htmlContent.js';
import { DisposableStore, toDisposable } from '../../../../base/common/lifecycle.js';
import { IMarkdownRendererService } from '../../../../platform/markdown/browser/markdownRenderer.js';
import { INCREASE_HOVER_VERBOSITY_ACTION_ID, DECREASE_HOVER_VERBOSITY_ACTION_ID } from './hoverActionIds.js';
import { Range } from '../../../common/core/range.js';
import { RenderedHoverParts } from './hoverTypes.js';
import { localize } from '../../../../nls.js';
import { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';
import { ILanguageFeaturesService } from '../../../common/services/languageFeatures.js';
import { HoverVerbosityAction } from '../../../common/languages.js';
import { registerIcon } from '../../../../platform/theme/common/iconRegistry.js';
import { Codicon } from '../../../../base/common/codicons.js';
import { ThemeIcon } from '../../../../base/common/themables.js';
import { onUnexpectedExternalError } from '../../../../base/common/errors.js';
import { IKeybindingService } from '../../../../platform/keybinding/common/keybinding.js';
import { ClickAction, KeyDownAction } from '../../../../base/browser/ui/hover/hoverWidget.js';
import { IHoverService, WorkbenchHoverDelegate } from '../../../../platform/hover/browser/hover.js';
import { AsyncIterableProducer } from '../../../../base/common/async.js';
import { getHoverProviderResultsAsAsyncIterable } from './getHover.js';
import { ICommandService } from '../../../../platform/commands/common/commands.js';

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
const $ = $$1;
const increaseHoverVerbosityIcon = registerIcon('hover-increase-verbosity', Codicon.add, localize(1130, 'Icon for increaseing hover verbosity.'));
const decreaseHoverVerbosityIcon = registerIcon('hover-decrease-verbosity', Codicon.remove, localize(1131, 'Icon for decreasing hover verbosity.'));
class MarkdownHover {
    constructor(owner, range, contents, isBeforeContent, ordinal, source = undefined) {
        this.owner = owner;
        this.range = range;
        this.contents = contents;
        this.isBeforeContent = isBeforeContent;
        this.ordinal = ordinal;
        this.source = source;
    }
    isValidForHoverAnchor(anchor) {
        return (anchor.type === 1 /* HoverAnchorType.Range */
            && this.range.startColumn <= anchor.range.startColumn
            && this.range.endColumn >= anchor.range.endColumn);
    }
}
class HoverSource {
    constructor(hover, hoverProvider, hoverPosition) {
        this.hover = hover;
        this.hoverProvider = hoverProvider;
        this.hoverPosition = hoverPosition;
    }
    supportsVerbosityAction(hoverVerbosityAction) {
        switch (hoverVerbosityAction) {
            case HoverVerbosityAction.Increase:
                return this.hover.canIncreaseVerbosity ?? false;
            case HoverVerbosityAction.Decrease:
                return this.hover.canDecreaseVerbosity ?? false;
        }
    }
}
let MarkdownHoverParticipant = class MarkdownHoverParticipant {
    constructor(_editor, _markdownRendererService, _configurationService, _languageFeaturesService, _keybindingService, _hoverService, _commandService) {
        this._editor = _editor;
        this._markdownRendererService = _markdownRendererService;
        this._configurationService = _configurationService;
        this._languageFeaturesService = _languageFeaturesService;
        this._keybindingService = _keybindingService;
        this._hoverService = _hoverService;
        this._commandService = _commandService;
        this.hoverOrdinal = 3;
    }
    createLoadingMessage(anchor) {
        return new MarkdownHover(this, anchor.range, [new MarkdownString().appendText(localize(1132, "Loading..."))], false, 2000);
    }
    computeSync(anchor, lineDecorations) {
        if (!this._editor.hasModel() || anchor.type !== 1 /* HoverAnchorType.Range */) {
            return [];
        }
        const model = this._editor.getModel();
        const lineNumber = anchor.range.startLineNumber;
        const maxColumn = model.getLineMaxColumn(lineNumber);
        const result = [];
        let index = 1000;
        const lineLength = model.getLineLength(lineNumber);
        const languageId = model.getLanguageIdAtPosition(anchor.range.startLineNumber, anchor.range.startColumn);
        const stopRenderingLineAfter = this._editor.getOption(133 /* EditorOption.stopRenderingLineAfter */);
        const maxTokenizationLineLength = this._configurationService.getValue('editor.maxTokenizationLineLength', {
            overrideIdentifier: languageId
        });
        let stopRenderingMessage = false;
        if (stopRenderingLineAfter >= 0 && lineLength > stopRenderingLineAfter && anchor.range.startColumn >= stopRenderingLineAfter) {
            stopRenderingMessage = true;
            result.push(new MarkdownHover(this, anchor.range, [{
                    value: localize(1133, "Rendering paused for long line for performance reasons. This can be configured via `editor.stopRenderingLineAfter`.")
                }], false, index++));
        }
        if (!stopRenderingMessage && typeof maxTokenizationLineLength === 'number' && lineLength >= maxTokenizationLineLength) {
            result.push(new MarkdownHover(this, anchor.range, [{
                    value: localize(1134, "Tokenization is skipped for long lines for performance reasons. This can be configured via `editor.maxTokenizationLineLength`.")
                }], false, index++));
        }
        let isBeforeContent = false;
        for (const d of lineDecorations) {
            const startColumn = (d.range.startLineNumber === lineNumber) ? d.range.startColumn : 1;
            const endColumn = (d.range.endLineNumber === lineNumber) ? d.range.endColumn : maxColumn;
            const hoverMessage = d.options.hoverMessage;
            if (!hoverMessage || isEmptyMarkdownString(hoverMessage)) {
                continue;
            }
            if (d.options.beforeContentClassName) {
                isBeforeContent = true;
            }
            const range = new Range(anchor.range.startLineNumber, startColumn, anchor.range.startLineNumber, endColumn);
            result.push(new MarkdownHover(this, range, asArray(hoverMessage), isBeforeContent, index++));
        }
        return result;
    }
    computeAsync(anchor, lineDecorations, source, token) {
        if (!this._editor.hasModel() || anchor.type !== 1 /* HoverAnchorType.Range */) {
            return AsyncIterableProducer.EMPTY;
        }
        const model = this._editor.getModel();
        const hoverProviderRegistry = this._languageFeaturesService.hoverProvider;
        if (!hoverProviderRegistry.has(model)) {
            return AsyncIterableProducer.EMPTY;
        }
        return this._getMarkdownHovers(hoverProviderRegistry, model, anchor, token);
    }
    async *_getMarkdownHovers(hoverProviderRegistry, model, anchor, token) {
        const position = anchor.range.getStartPosition();
        const hoverProviderResults = getHoverProviderResultsAsAsyncIterable(hoverProviderRegistry, model, position, token);
        for await (const item of hoverProviderResults) {
            if (!isEmptyMarkdownString(item.hover.contents)) {
                const range = item.hover.range ? Range.lift(item.hover.range) : anchor.range;
                const hoverSource = new HoverSource(item.hover, item.provider, position);
                yield new MarkdownHover(this, range, item.hover.contents, false, item.ordinal, hoverSource);
            }
        }
    }
    renderHoverParts(context, hoverParts) {
        this._renderedHoverParts = new MarkdownRenderedHoverParts(hoverParts, context.fragment, this, this._editor, this._commandService, this._keybindingService, this._hoverService, this._configurationService, this._markdownRendererService, context.onContentsChanged);
        return this._renderedHoverParts;
    }
    handleScroll(e) {
        this._renderedHoverParts?.handleScroll(e);
    }
    getAccessibleContent(hoverPart) {
        return this._renderedHoverParts?.getAccessibleContent(hoverPart) ?? '';
    }
    updateMarkdownHoverVerbosityLevel(action, index) {
        return Promise.resolve(this._renderedHoverParts?.updateMarkdownHoverPartVerbosityLevel(action, index));
    }
};
MarkdownHoverParticipant = __decorate([
    __param(1, IMarkdownRendererService),
    __param(2, IConfigurationService),
    __param(3, ILanguageFeaturesService),
    __param(4, IKeybindingService),
    __param(5, IHoverService),
    __param(6, ICommandService)
], MarkdownHoverParticipant);
class RenderedMarkdownHoverPart {
    constructor(hoverPart, hoverElement, disposables, actionsContainer) {
        this.hoverPart = hoverPart;
        this.hoverElement = hoverElement;
        this.disposables = disposables;
        this.actionsContainer = actionsContainer;
    }
    dispose() {
        this.disposables.dispose();
    }
}
class MarkdownRenderedHoverParts {
    constructor(hoverParts, hoverPartsContainer, _hoverParticipant, _editor, _commandService, _keybindingService, _hoverService, _configurationService, _markdownRendererService, _onFinishedRendering) {
        this._hoverParticipant = _hoverParticipant;
        this._editor = _editor;
        this._commandService = _commandService;
        this._keybindingService = _keybindingService;
        this._hoverService = _hoverService;
        this._configurationService = _configurationService;
        this._markdownRendererService = _markdownRendererService;
        this._onFinishedRendering = _onFinishedRendering;
        this._ongoingHoverOperations = new Map();
        this._disposables = new DisposableStore();
        this.renderedHoverParts = this._renderHoverParts(hoverParts, hoverPartsContainer, this._onFinishedRendering);
        this._disposables.add(toDisposable(() => {
            this.renderedHoverParts.forEach(renderedHoverPart => {
                renderedHoverPart.dispose();
            });
            this._ongoingHoverOperations.forEach(operation => {
                operation.tokenSource.dispose(true);
            });
        }));
    }
    _renderHoverParts(hoverParts, hoverPartsContainer, onFinishedRendering) {
        hoverParts.sort(compareBy(hover => hover.ordinal, numberComparator));
        return hoverParts.map(hoverPart => {
            const renderedHoverPart = this._renderHoverPart(hoverPart, onFinishedRendering);
            hoverPartsContainer.appendChild(renderedHoverPart.hoverElement);
            return renderedHoverPart;
        });
    }
    _renderHoverPart(hoverPart, onFinishedRendering) {
        const renderedMarkdownPart = this._renderMarkdownHover(hoverPart, onFinishedRendering);
        const renderedMarkdownElement = renderedMarkdownPart.hoverElement;
        const hoverSource = hoverPart.source;
        const disposables = new DisposableStore();
        disposables.add(renderedMarkdownPart);
        if (!hoverSource) {
            return new RenderedMarkdownHoverPart(hoverPart, renderedMarkdownElement, disposables);
        }
        const canIncreaseVerbosity = hoverSource.supportsVerbosityAction(HoverVerbosityAction.Increase);
        const canDecreaseVerbosity = hoverSource.supportsVerbosityAction(HoverVerbosityAction.Decrease);
        if (!canIncreaseVerbosity && !canDecreaseVerbosity) {
            return new RenderedMarkdownHoverPart(hoverPart, renderedMarkdownElement, disposables);
        }
        const actionsContainer = $('div.verbosity-actions');
        renderedMarkdownElement.prepend(actionsContainer);
        const actionsContainerInner = $('div.verbosity-actions-inner');
        actionsContainer.append(actionsContainerInner);
        disposables.add(this._renderHoverExpansionAction(actionsContainerInner, HoverVerbosityAction.Increase, canIncreaseVerbosity));
        disposables.add(this._renderHoverExpansionAction(actionsContainerInner, HoverVerbosityAction.Decrease, canDecreaseVerbosity));
        return new RenderedMarkdownHoverPart(hoverPart, renderedMarkdownElement, disposables, actionsContainerInner);
    }
    _renderMarkdownHover(markdownHover, onFinishedRendering) {
        const renderedMarkdownHover = renderMarkdown(this._editor, markdownHover, this._markdownRendererService, onFinishedRendering);
        return renderedMarkdownHover;
    }
    _renderHoverExpansionAction(container, action, actionEnabled) {
        const store = new DisposableStore();
        const isActionIncrease = action === HoverVerbosityAction.Increase;
        const actionElement = append(container, $(ThemeIcon.asCSSSelector(isActionIncrease ? increaseHoverVerbosityIcon : decreaseHoverVerbosityIcon)));
        actionElement.tabIndex = 0;
        const hoverDelegate = new WorkbenchHoverDelegate('mouse', undefined, { target: container, position: { hoverPosition: 0 /* HoverPosition.LEFT */ } }, this._configurationService, this._hoverService);
        store.add(this._hoverService.setupManagedHover(hoverDelegate, actionElement, labelForHoverVerbosityAction(this._keybindingService, action)));
        if (!actionEnabled) {
            actionElement.classList.add('disabled');
            return store;
        }
        actionElement.classList.add('enabled');
        const actionFunction = () => this._commandService.executeCommand(action === HoverVerbosityAction.Increase ? INCREASE_HOVER_VERBOSITY_ACTION_ID : DECREASE_HOVER_VERBOSITY_ACTION_ID, { focus: true });
        store.add(new ClickAction(actionElement, actionFunction));
        store.add(new KeyDownAction(actionElement, actionFunction, [3 /* KeyCode.Enter */, 10 /* KeyCode.Space */]));
        return store;
    }
    handleScroll(e) {
        this.renderedHoverParts.forEach(renderedHoverPart => {
            const actionsContainerInner = renderedHoverPart.actionsContainer;
            if (!actionsContainerInner) {
                return;
            }
            const hoverElement = renderedHoverPart.hoverElement;
            const topOfHoverScrollPosition = e.scrollTop;
            const bottomOfHoverScrollPosition = topOfHoverScrollPosition + e.height;
            const topOfRenderedPart = hoverElement.offsetTop;
            const hoverElementHeight = hoverElement.clientHeight;
            const bottomOfRenderedPart = topOfRenderedPart + hoverElementHeight;
            const iconsHeight = 22;
            let top;
            if (bottomOfRenderedPart <= bottomOfHoverScrollPosition || topOfRenderedPart >= bottomOfHoverScrollPosition) {
                top = hoverElementHeight - iconsHeight;
            }
            else {
                top = bottomOfHoverScrollPosition - topOfRenderedPart - iconsHeight;
            }
            actionsContainerInner.style.top = `${top}px`;
        });
    }
    async updateMarkdownHoverPartVerbosityLevel(action, index) {
        const model = this._editor.getModel();
        if (!model) {
            return undefined;
        }
        const hoverRenderedPart = this._getRenderedHoverPartAtIndex(index);
        const hoverSource = hoverRenderedPart?.hoverPart.source;
        if (!hoverRenderedPart || !hoverSource?.supportsVerbosityAction(action)) {
            return undefined;
        }
        const newHover = await this._fetchHover(hoverSource, model, action);
        if (!newHover) {
            return undefined;
        }
        const newHoverSource = new HoverSource(newHover, hoverSource.hoverProvider, hoverSource.hoverPosition);
        const initialHoverPart = hoverRenderedPart.hoverPart;
        const newHoverPart = new MarkdownHover(this._hoverParticipant, initialHoverPart.range, newHover.contents, initialHoverPart.isBeforeContent, initialHoverPart.ordinal, newHoverSource);
        const newHoverRenderedPart = this._updateRenderedHoverPart(index, newHoverPart);
        if (!newHoverRenderedPart) {
            return undefined;
        }
        return {
            hoverPart: newHoverPart,
            hoverElement: newHoverRenderedPart.hoverElement
        };
    }
    getAccessibleContent(hoverPart) {
        const renderedHoverPartIndex = this.renderedHoverParts.findIndex(renderedHoverPart => renderedHoverPart.hoverPart === hoverPart);
        if (renderedHoverPartIndex === -1) {
            return undefined;
        }
        const renderedHoverPart = this._getRenderedHoverPartAtIndex(renderedHoverPartIndex);
        if (!renderedHoverPart) {
            return undefined;
        }
        const hoverElementInnerText = renderedHoverPart.hoverElement.innerText;
        const accessibleContent = hoverElementInnerText.replace(/[^\S\n\r]+/gu, ' ');
        return accessibleContent;
    }
    async _fetchHover(hoverSource, model, action) {
        let verbosityDelta = action === HoverVerbosityAction.Increase ? 1 : -1;
        const provider = hoverSource.hoverProvider;
        const ongoingHoverOperation = this._ongoingHoverOperations.get(provider);
        if (ongoingHoverOperation) {
            ongoingHoverOperation.tokenSource.cancel();
            verbosityDelta += ongoingHoverOperation.verbosityDelta;
        }
        const tokenSource = new CancellationTokenSource();
        this._ongoingHoverOperations.set(provider, { verbosityDelta, tokenSource });
        const context = { verbosityRequest: { verbosityDelta, previousHover: hoverSource.hover } };
        let hover;
        try {
            hover = await Promise.resolve(provider.provideHover(model, hoverSource.hoverPosition, tokenSource.token, context));
        }
        catch (e) {
            onUnexpectedExternalError(e);
        }
        tokenSource.dispose();
        this._ongoingHoverOperations.delete(provider);
        return hover;
    }
    _updateRenderedHoverPart(index, hoverPart) {
        if (index >= this.renderedHoverParts.length || index < 0) {
            return undefined;
        }
        const renderedHoverPart = this._renderHoverPart(hoverPart, this._onFinishedRendering);
        const currentRenderedHoverPart = this.renderedHoverParts[index];
        const currentRenderedMarkdown = currentRenderedHoverPart.hoverElement;
        const renderedMarkdown = renderedHoverPart.hoverElement;
        const renderedChildrenElements = Array.from(renderedMarkdown.children);
        currentRenderedMarkdown.replaceChildren(...renderedChildrenElements);
        const newRenderedHoverPart = new RenderedMarkdownHoverPart(hoverPart, currentRenderedMarkdown, renderedHoverPart.disposables, renderedHoverPart.actionsContainer);
        currentRenderedHoverPart.dispose();
        this.renderedHoverParts[index] = newRenderedHoverPart;
        return newRenderedHoverPart;
    }
    _getRenderedHoverPartAtIndex(index) {
        return this.renderedHoverParts[index];
    }
    dispose() {
        this._disposables.dispose();
    }
}
function renderMarkdownHovers(context, markdownHovers, editor, markdownRendererService) {
    // Sort hover parts to keep them stable since they might come in async, out-of-order
    markdownHovers.sort(compareBy(hover => hover.ordinal, numberComparator));
    const renderedHoverParts = [];
    for (const markdownHover of markdownHovers) {
        const renderedHoverPart = renderMarkdown(editor, markdownHover, markdownRendererService, context.onContentsChanged);
        context.fragment.appendChild(renderedHoverPart.hoverElement);
        renderedHoverParts.push(renderedHoverPart);
    }
    return new RenderedHoverParts(renderedHoverParts);
}
function renderMarkdown(editor, markdownHover, markdownRendererService, onFinishedRendering) {
    const disposables = new DisposableStore();
    const renderedMarkdown = $('div.hover-row');
    const renderedMarkdownContents = $('div.hover-row-contents');
    renderedMarkdown.appendChild(renderedMarkdownContents);
    const markdownStrings = markdownHover.contents;
    for (const markdownString of markdownStrings) {
        if (isEmptyMarkdownString(markdownString)) {
            continue;
        }
        const markdownHoverElement = $('div.markdown-hover');
        const hoverContentsElement = append(markdownHoverElement, $('div.hover-contents'));
        const renderedContents = disposables.add(markdownRendererService.render(markdownString, {
            context: editor,
            asyncRenderCallback: () => {
                hoverContentsElement.className = 'hover-contents code-hover-contents';
                onFinishedRendering();
            }
        }));
        hoverContentsElement.appendChild(renderedContents.element);
        renderedMarkdownContents.appendChild(markdownHoverElement);
    }
    const renderedHoverPart = {
        hoverPart: markdownHover,
        hoverElement: renderedMarkdown,
        dispose() { disposables.dispose(); }
    };
    return renderedHoverPart;
}
function labelForHoverVerbosityAction(keybindingService, action) {
    switch (action) {
        case HoverVerbosityAction.Increase: {
            const kb = keybindingService.lookupKeybinding(INCREASE_HOVER_VERBOSITY_ACTION_ID);
            return kb ?
                localize(1135, "Increase Hover Verbosity ({0})", kb.getLabel()) :
                localize(1136, "Increase Hover Verbosity");
        }
        case HoverVerbosityAction.Decrease: {
            const kb = keybindingService.lookupKeybinding(DECREASE_HOVER_VERBOSITY_ACTION_ID);
            return kb ?
                localize(1137, "Decrease Hover Verbosity ({0})", kb.getLabel()) :
                localize(1138, "Decrease Hover Verbosity");
        }
    }
}

export { MarkdownHover, MarkdownHoverParticipant, labelForHoverVerbosityAction, renderMarkdownHovers };

================================================================================
FILE: client/node_modules/monaco-editor/esm/vs/editor/browser/widget/markdownRenderer/browser/editorMarkdownCodeBlockRenderer.js
================================================================================

import { isHTMLElement } from '../../../../../base/browser/dom.js';
import { createTrustedTypesPolicy } from '../../../../../base/browser/trustedTypes.js';
import { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';
import { createBareFontInfoFromRawSettings } from '../../../../common/config/fontInfoFromSettings.js';
import { ILanguageService } from '../../../../common/languages/language.js';
import { PLAINTEXT_LANGUAGE_ID } from '../../../../common/languages/modesRegistry.js';
import { tokenizeToString } from '../../../../common/languages/textToHtmlTokenizer.js';
import { applyFontInfo } from '../../../config/domFontInfo.js';
import { isCodeEditor } from '../../../editorBrowser.js';
import './renderedMarkdown.css';

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var EditorMarkdownCodeBlockRenderer_1;
/**
 * Renders markdown code blocks using the editor's tokenization and font settings.
 */
let EditorMarkdownCodeBlockRenderer = class EditorMarkdownCodeBlockRenderer {
    static { EditorMarkdownCodeBlockRenderer_1 = this; }
    static { this._ttpTokenizer = createTrustedTypesPolicy('tokenizeToString', {
        createHTML(html) {
            return html;
        }
    }); }
    constructor(_configurationService, _languageService) {
        this._configurationService = _configurationService;
        this._languageService = _languageService;
    }
    async renderCodeBlock(languageAlias, value, options) {
        const editor = isCodeEditor(options.context) ? options.context : undefined;
        // In markdown, it is possible that we stumble upon language aliases (e.g.js instead of javascript).
        // it is possible no alias is given in which case we fall back to the current editor lang
        let languageId;
        if (languageAlias) {
            languageId = this._languageService.getLanguageIdByLanguageName(languageAlias);
        }
        else if (editor) {
            languageId = editor.getModel()?.getLanguageId();
        }
        if (!languageId) {
            languageId = PLAINTEXT_LANGUAGE_ID;
        }
        const html = await tokenizeToString(this._languageService, value, languageId);
        const content = EditorMarkdownCodeBlockRenderer_1._ttpTokenizer ? EditorMarkdownCodeBlockRenderer_1._ttpTokenizer.createHTML(html) ?? html : html;
        const root = document.createElement('span');
        root.innerHTML = content;
        // eslint-disable-next-line no-restricted-syntax
        const codeElement = root.querySelector('.monaco-tokenized-source');
        if (!isHTMLElement(codeElement)) {
            return document.createElement('span');
        }
        applyFontInfo(codeElement, this.getFontInfo(editor));
        return root;
    }
    getFontInfo(editor) {
        // Use editor's font if we have one
        if (editor) {
            return editor.getOption(59 /* EditorOption.fontInfo */);
        }
        else {
            // Otherwise use the global font settings.
            // Pass in fake pixel ratio of 1 since we only need the font info to apply font family
            return createBareFontInfoFromRawSettings({
                fontFamily: this._configurationService.getValue('editor').fontFamily
            }, 1);
        }
    }
};
EditorMarkdownCodeBlockRenderer = EditorMarkdownCodeBlockRenderer_1 = __decorate([
    __param(0, IConfigurationService),
    __param(1, ILanguageService)
], EditorMarkdownCodeBlockRenderer);

export { EditorMarkdownCodeBlockRenderer };

================================================================================
FILE: client/node_modules/terser/lib/output.js
================================================================================

/***********************************************************************

  A JavaScript tokenizer / parser / beautifier / compressor.
  https://github.com/mishoo/UglifyJS2

  -------------------------------- (C) ---------------------------------

                           Author: Mihai Bazon
                         <mihai.bazon@gmail.com>
                       http://mihai.bazon.net/blog

  Distributed under the BSD license:

    Copyright 2012 (c) Mihai Bazon <mihai.bazon@gmail.com>

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions
    are met:

        * Redistributions of source code must retain the above
          copyright notice, this list of conditions and the following
          disclaimer.

        * Redistributions in binary form must reproduce the above
          copyright notice, this list of conditions and the following
          disclaimer in the documentation and/or other materials
          provided with the distribution.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER â€œAS ISâ€ AND ANY
    EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
    PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE
    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
    OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
    PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
    PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
    THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
    SUCH DAMAGE.

 ***********************************************************************/

"use strict";

import {
    defaults,
    makePredicate,
    noop,
    regexp_source_fix,
    sort_regexp_flags,
    return_false,
    return_true,
} from "./utils/index.js";
import { first_in_statement, left_is_object } from "./utils/first_in_statement.js";
import {
    AST_Array,
    AST_Arrow,
    AST_Assign,
    AST_Await,
    AST_BigInt,
    AST_Binary,
    AST_BlockStatement,
    AST_Break,
    AST_Call,
    AST_Case,
    AST_Catch,
    AST_Chain,
    AST_Class,
    AST_ClassExpression,
    AST_ClassPrivateProperty,
    AST_ClassProperty,
    AST_ClassStaticBlock,
    AST_ConciseMethod,
    AST_PrivateGetter,
    AST_PrivateMethod,
    AST_SymbolPrivateProperty,
    AST_PrivateSetter,
    AST_PrivateIn,
    AST_Conditional,
    AST_Const,
    AST_Constant,
    AST_Continue,
    AST_Debugger,
    AST_Default,
    AST_DefaultAssign,
    AST_Definitions,
    AST_DefinitionsLike,
    AST_Defun,
    AST_Destructuring,
    AST_Directive,
    AST_Do,
    AST_Dot,
    AST_DotHash,
    AST_EmptyStatement,
    AST_Exit,
    AST_Expansion,
    AST_Export,
    AST_Finally,
    AST_For,
    AST_ForIn,
    AST_ForOf,
    AST_Function,
    AST_Hole,
    AST_If,
    AST_Import,
    AST_ImportMeta,
    AST_Jump,
    AST_LabeledStatement,
    AST_Lambda,
    AST_Let,
    AST_LoopControl,
    AST_NameMapping,
    AST_New,
    AST_NewTarget,
    AST_Node,
    AST_Number,
    AST_Object,
    AST_ObjectGetter,
    AST_ObjectKeyVal,
    AST_ObjectProperty,
    AST_ObjectSetter,
    AST_PrefixedTemplateString,
    AST_PropAccess,
    AST_RegExp,
    AST_Return,
    AST_Scope,
    AST_Sequence,
    AST_SimpleStatement,
    AST_Statement,
    AST_StatementWithBody,
    AST_String,
    AST_Sub,
    AST_Super,
    AST_Switch,
    AST_SwitchBranch,
    AST_Symbol,
    AST_SymbolClassProperty,
    AST_SymbolMethod,
    AST_SymbolRef,
    AST_TemplateSegment,
    AST_TemplateString,
    AST_This,
    AST_Throw,
    AST_Toplevel,
    AST_Try,
    AST_TryBlock,
    AST_Unary,
    AST_UnaryPostfix,
    AST_UnaryPrefix,
    AST_Using,
    AST_Var,
    AST_VarDefLike,
    AST_While,
    AST_With,
    AST_Yield,
    TreeWalker,
    walk,
    walk_abort
} from "./ast.js";
import {
    get_full_char_code,
    get_full_char,
    is_identifier_char,
    is_basic_identifier_string,
    is_identifier_string,
    PRECEDENCE,
    ALL_RESERVED_WORDS,
} from "./parse.js";

const CODE_LINE_BREAK = 10;
const CODE_SPACE = 32;

const r_annotation = /[@#]__(PURE|INLINE|NOINLINE)__/;

function is_some_comments(comment) {
    // multiline comment
    return (
        (comment.type === "comment2" || comment.type === "comment1")
        && /@preserve|@copyright|@lic|@cc_on|^\**!/i.test(comment.value)
    );
}

const ROPE_COMMIT_WHEN = 8 * 1000;
class Rope {
    constructor() {
        this.committed = "";
        this.current = "";
    }

    append(str) {
        /** When `this.current` is too long, commit it. */
        if (this.current.length > ROPE_COMMIT_WHEN) {
            this.committed += this.current + str;
            this.current = "";
        } else {
            this.current += str;
        }
    }

    insertAt(char, index) {
        const { committed, current } = this;
        if (index < committed.length) {
            this.committed = committed.slice(0, index) + char + committed.slice(index);
        } else if (index === committed.length) {
            this.committed += char;
        } else {
            index -= committed.length;
            this.committed += current.slice(0, index) + char;
            this.current = current.slice(index);
        }
    }

    charAt(index) {
        const { committed } = this;
        if (index < committed.length) return committed[index];
        return this.current[index - committed.length];
    }

    charCodeAt(index) {
        const { committed } = this;
        if (index < committed.length) return committed.charCodeAt(index);
        return this.current.charCodeAt(index - committed.length);
    }

    length() {
        return this.committed.length + this.current.length;
    }

    expectDirective() {
        // /^$|[;{][\s\n]*$/

        let ch, n = this.length();

        if (n <= 0) return true;

        // Skip N whitespace from the end
        while (
            (ch = this.charCodeAt(--n))
            && (ch == CODE_SPACE || ch == CODE_LINE_BREAK)
        );

        // either ";", or "{", or the string ended
        return !ch || ch === 59 || ch === 123;
    }

    hasNLB() {
        let n = this.length() - 1;
        while (n >= 0) {
            const code = this.charCodeAt(n--);

            if (code === CODE_LINE_BREAK) return true;
            if (code !== CODE_SPACE) return false;
        }
        return true;
    }


    toString() {
        return this.committed + this.current;
    }
}

function OutputStream(options) {

    var readonly = !options;
    options = defaults(options, {
        ascii_only           : false,
        beautify             : false,
        braces               : false,
        comments             : "some",
        ecma                 : 5,
        ie8                  : false,
        indent_level         : 4,
        indent_start         : 0,
        inline_script        : true,
        keep_numbers         : false,
        keep_quoted_props    : false,
        max_line_len         : false,
        preamble             : null,
        preserve_annotations : false,
        quote_keys           : false,
        quote_style          : 0,
        safari10             : false,
        semicolons           : true,
        shebang              : true,
        shorthand            : undefined,
        source_map           : null,
        webkit               : false,
        width                : 80,
        wrap_iife            : false,
        wrap_func_args       : false,

        _destroy_ast         : false
    }, true);

    if (options.shorthand === undefined)
        options.shorthand = options.ecma > 5;

    // Convert comment option to RegExp if necessary and set up comments filter
    var comment_filter = return_false; // Default case, throw all comments away
    if (options.comments) {
        let comments = options.comments;
        if (typeof options.comments === "string" && /^\/.*\/[a-zA-Z]*$/.test(options.comments)) {
            var regex_pos = options.comments.lastIndexOf("/");
            comments = new RegExp(
                options.comments.substr(1, regex_pos - 1),
                options.comments.substr(regex_pos + 1)
            );
        }
        if (comments instanceof RegExp) {
            comment_filter = function(comment) {
                return comment.type != "comment5" && comments.test(comment.value);
            };
        } else if (typeof comments === "function") {
            comment_filter = function(comment) {
                return comment.type != "comment5" && comments(this, comment);
            };
        } else if (comments === "some") {
            comment_filter = is_some_comments;
        } else { // NOTE includes "all" option
            comment_filter = return_true;
        }
    }

    if (options.preserve_annotations) {
        let prev_comment_filter = comment_filter;
        comment_filter = function (comment) {
            return r_annotation.test(comment.value) || prev_comment_filter.apply(this, arguments);
        };
    }

    var indentation = 0;
    var current_col = 0;
    var current_line = 1;
    var current_pos = 0;
    var OUTPUT = new Rope();
    let printed_comments = new Set();

    var to_utf8 = options.ascii_only ? function(str, identifier = false, regexp = false) {
        if (options.ecma >= 2015 && !options.safari10 && !regexp) {
            str = str.replace(/[\ud800-\udbff][\udc00-\udfff]/g, function(ch) {
                var code = get_full_char_code(ch, 0).toString(16);
                return "\\u{" + code + "}";
            });
        }
        return str.replace(/[\u0000-\u001f\u007f-\uffff]/g, function(ch) {
            var code = ch.charCodeAt(0).toString(16);
            if (code.length <= 2 && !identifier) {
                while (code.length < 2) code = "0" + code;
                return "\\x" + code;
            } else {
                while (code.length < 4) code = "0" + code;
                return "\\u" + code;
            }
        });
    } : function(str) {
        return str.replace(/[\ud800-\udbff][\udc00-\udfff]|([\ud800-\udbff]|[\udc00-\udfff])/g, function(match, lone) {
            if (lone) {
                return "\\u" + lone.charCodeAt(0).toString(16);
            }
            return match;
        });
    };

    function make_string(str, quote) {
        var dq = 0, sq = 0;
        str = str.replace(/[\\\b\f\n\r\v\t\x22\x27\u2028\u2029\0\ufeff]/g,
          function(s, i) {
            switch (s) {
              case '"': ++dq; return '"';
              case "'": ++sq; return "'";
              case "\\": return "\\\\";
              case "\n": return "\\n";
              case "\r": return "\\r";
              case "\t": return "\\t";
              case "\b": return "\\b";
              case "\f": return "\\f";
              case "\x0B": return options.ie8 ? "\\x0B" : "\\v";
              case "\u2028": return "\\u2028";
              case "\u2029": return "\\u2029";
              case "\ufeff": return "\\ufeff";
              case "\0":
                  return /[0-9]/.test(get_full_char(str, i+1)) ? "\\x00" : "\\0";
            }
            return s;
        });
        function quote_single() {
            return "'" + str.replace(/\x27/g, "\\'") + "'";
        }
        function quote_double() {
            return '"' + str.replace(/\x22/g, '\\"') + '"';
        }
        function quote_template() {
            return "`" + str.replace(/`/g, "\\`") + "`";
        }
        str = to_utf8(str);
        if (quote === "`") return quote_template();
        switch (options.quote_style) {
          case 1:
            return quote_single();
          case 2:
            return quote_double();
          case 3:
            return quote == "'" ? quote_single() : quote_double();
          default:
            return dq > sq ? quote_single() : quote_double();
        }
    }

    function encode_string(str, quote) {
        var ret = make_string(str, quote);
        if (options.inline_script) {
            ret = ret.replace(/<\x2f(script)([>\/\t\n\f\r ])/gi, "<\\/$1$2");
            ret = ret.replace(/\x3c!--/g, "\\x3c!--");
            ret = ret.replace(/--\x3e/g, "--\\x3e");
        }
        return ret;
    }

    function make_name(name) {
        name = name.toString();
        name = to_utf8(name, true);
        return name;
    }

    function make_indent(back) {
        return " ".repeat(options.indent_start + indentation - back * options.indent_level);
    }

    /* -----[ beautification/minification ]----- */

    var has_parens = false;
    var might_need_space = false;
    var might_need_semicolon = false;
    var might_add_newline = 0;
    var need_newline_indented = false;
    var need_space = false;
    var newline_insert = -1;
    var last = "";
    var mapping_token, mapping_name, mappings = options.source_map && [];

    var do_add_mapping = mappings ? function() {
        mappings.forEach(function(mapping) {
            try {
                let { name, token } = mapping;
                if (name !== false) {
                    if (token.type == "name" || token.type === "privatename") {
                        name = token.value;
                    } else if (name instanceof AST_Symbol) {
                        name = token.type === "string" ? token.value : name.name;
                    }
                }
                options.source_map.add(
                    mapping.token.file,
                    mapping.line, mapping.col,
                    mapping.token.line, mapping.token.col,
                    is_basic_identifier_string(name) ? name : undefined
                );
            } catch(ex) {
                // Ignore bad mapping
            }
        });
        mappings = [];
    } : noop;

    var ensure_line_len = options.max_line_len ? function() {
        if (current_col > options.max_line_len) {
            if (might_add_newline) {
                OUTPUT.insertAt("\n", might_add_newline);
                const len_after_newline = OUTPUT.length() - might_add_newline - 1;
                if (mappings) {
                    var delta = len_after_newline - current_col;
                    mappings.forEach(function(mapping) {
                        mapping.line++;
                        mapping.col += delta;
                    });
                }
                current_line++;
                current_pos++;
                current_col = len_after_newline;
            }
        }
        if (might_add_newline) {
            might_add_newline = 0;
            do_add_mapping();
        }
    } : noop;

    var requireSemicolonChars = makePredicate("( [ + * / - , . `");

    function print(str) {
        str = String(str);
        var ch = get_full_char(str, 0);
        if (need_newline_indented && ch) {
            need_newline_indented = false;
            if (ch !== "\n") {
                print("\n");
                indent();
            }
        }
        if (need_space && ch) {
            need_space = false;
            if (!/[\s;})]/.test(ch)) {
                space();
            }
        }
        newline_insert = -1;
        var prev = last.charAt(last.length - 1);
        if (might_need_semicolon) {
            might_need_semicolon = false;

            if (prev === ":" && ch === "}" || (!ch || !";}".includes(ch)) && prev !== ";") {
                if (options.semicolons || requireSemicolonChars.has(ch)) {
                    OUTPUT.append(";");
                    current_col++;
                    current_pos++;
                } else {
                    ensure_line_len();
                    if (current_col > 0) {
                        OUTPUT.append("\n");
                        current_pos++;
                        current_line++;
                        current_col = 0;
                    }

                    if (/^\s+$/.test(str)) {
                        // reset the semicolon flag, since we didn't print one
                        // now and might still have to later
                        might_need_semicolon = true;
                    }
                }

                if (!options.beautify)
                    might_need_space = false;
            }
        }

        if (might_need_space) {
            if ((is_identifier_char(prev)
                    && (is_identifier_char(ch) || ch == "\\"))
                || (ch == "/" && ch == prev)
                || ((ch == "+" || ch == "-") && ch == last)
            ) {
                OUTPUT.append(" ");
                current_col++;
                current_pos++;
            }
            might_need_space = false;
        }

        if (mapping_token) {
            mappings.push({
                token: mapping_token,
                name: mapping_name,
                line: current_line,
                col: current_col
            });
            mapping_token = false;
            if (!might_add_newline) do_add_mapping();
        }

        OUTPUT.append(str);
        has_parens = str[str.length - 1] == "(";
        current_pos += str.length;
        var a = str.split(/\r?\n/), n = a.length - 1;
        current_line += n;
        current_col += a[0].length;
        if (n > 0) {
            ensure_line_len();
            current_col = a[n].length;
        }
        last = str;
    }

    var star = function() {
        print("*");
    };

    var space = options.beautify ? function() {
        print(" ");
    } : function() {
        might_need_space = true;
    };

    var indent = options.beautify ? function(half) {
        if (options.beautify) {
            print(make_indent(half ? 0.5 : 0));
        }
    } : noop;

    var with_indent = options.beautify ? function(col, cont) {
        if (col === true) col = next_indent();
        var save_indentation = indentation;
        indentation = col;
        var ret = cont();
        indentation = save_indentation;
        return ret;
    } : function(col, cont) { return cont(); };

    var newline = options.beautify ? function() {
        if (newline_insert < 0) return print("\n");
        if (OUTPUT.charAt(newline_insert) != "\n") {
            OUTPUT.insertAt("\n", newline_insert);
            current_pos++;
            current_line++;
        }
        newline_insert++;
    } : options.max_line_len ? function() {
        ensure_line_len();
        might_add_newline = OUTPUT.length();
    } : noop;

    var semicolon = options.beautify ? function() {
        print(";");
    } : function() {
        might_need_semicolon = true;
    };

    function force_semicolon() {
        might_need_semicolon = false;
        print(";");
    }

    function next_indent() {
        return indentation + options.indent_level;
    }

    function with_block(cont) {
        var ret;
        print("{");
        newline();
        with_indent(next_indent(), function() {
            ret = cont();
        });
        indent();
        print("}");
        return ret;
    }

    function with_parens(cont) {
        print("(");
        //XXX: still nice to have that for argument lists
        //var ret = with_indent(current_col, cont);
        var ret = cont();
        print(")");
        return ret;
    }

    function with_square(cont) {
        print("[");
        //var ret = with_indent(current_col, cont);
        var ret = cont();
        print("]");
        return ret;
    }

    function comma() {
        print(",");
        space();
    }

    function colon() {
        print(":");
        space();
    }

    var add_mapping = mappings ? function(token, name) {
        mapping_token = token;
        mapping_name = name;
    } : noop;

    function get() {
        if (might_add_newline) {
            ensure_line_len();
        }
        return OUTPUT.toString();
    }

    function filter_comment(comment) {
        if (!options.preserve_annotations) {
            comment = comment.replace(r_annotation, " ");
        }
        if (/^\s*$/.test(comment)) {
            return "";
        }
        return comment.replace(/(<\s*\/\s*)(script)/i, "<\\/$2");
    }

    function prepend_comments(node) {
        var self = this;
        var start = node.start;
        if (!start) return;
        var printed_comments = self.printed_comments;

        // There cannot be a newline between return/yield and its value.
        const keyword_with_value = 
            node instanceof AST_Exit && node.value
            || (node instanceof AST_Await || node instanceof AST_Yield)
                && node.expression;

        if (
            start.comments_before
            && printed_comments.has(start.comments_before)
        ) {
            if (keyword_with_value) {
                start.comments_before = [];
            } else {
                return;
            }
        }

        var comments = start.comments_before;
        if (!comments) {
            comments = start.comments_before = [];
        }
        printed_comments.add(comments);

        if (keyword_with_value) {
            var tw = new TreeWalker(function(node) {
                var parent = tw.parent();
                if (parent instanceof AST_Exit
                    || parent instanceof AST_Await
                    || parent instanceof AST_Yield
                    || parent instanceof AST_Binary && parent.left === node
                    || parent.TYPE == "Call" && parent.expression === node
                    || parent instanceof AST_Conditional && parent.condition === node
                    || parent instanceof AST_Dot && parent.expression === node
                    || parent instanceof AST_Sequence && parent.expressions[0] === node
                    || parent instanceof AST_Sub && parent.expression === node
                    || parent instanceof AST_UnaryPostfix) {
                    if (!node.start) return;
                    var text = node.start.comments_before;
                    if (text && !printed_comments.has(text)) {
                        printed_comments.add(text);
                        comments = comments.concat(text);
                    }
                } else {
                    return true;
                }
            });
            tw.push(node);
            keyword_with_value.walk(tw);
        }

        if (current_pos == 0) {
            if (comments.length > 0 && options.shebang && comments[0].type === "comment5"
                && !printed_comments.has(comments[0])) {
                print("#!" + comments.shift().value + "\n");
                indent();
            }
            var preamble = options.preamble;
            if (preamble) {
                print(preamble.replace(/\r\n?|[\n\u2028\u2029]|\s*$/g, "\n"));
            }
        }

        comments = comments.filter(comment_filter, node).filter(c => !printed_comments.has(c));
        if (comments.length == 0) return;
        var last_nlb = OUTPUT.hasNLB();
        comments.forEach(function(c, i) {
            printed_comments.add(c);
            if (!last_nlb) {
                if (c.nlb) {
                    print("\n");
                    indent();
                    last_nlb = true;
                } else if (i > 0) {
                    space();
                }
            }

            if (/comment[134]/.test(c.type)) {
                var value = filter_comment(c.value);
                if (value) {
                    print("//" + value + "\n");
                    indent();
                }
                last_nlb = true;
            } else if (c.type == "comment2") {
                var value = filter_comment(c.value);
                if (value) {
                    print("/*" + value + "*/");
                }
                last_nlb = false;
            }
        });
        if (!last_nlb) {
            if (start.nlb) {
                print("\n");
                indent();
            } else {
                space();
            }
        }
    }

    function append_comments(node, tail) {
        var self = this;
        var token = node.end;
        if (!token) return;
        var printed_comments = self.printed_comments;
        var comments = token[tail ? "comments_before" : "comments_after"];
        if (!comments || printed_comments.has(comments)) return;
        if (!(node instanceof AST_Statement || comments.every((c) =>
            !/comment[134]/.test(c.type)
        ))) return;
        printed_comments.add(comments);
        var insert = OUTPUT.length();
        comments.filter(comment_filter, node).forEach(function(c, i) {
            if (printed_comments.has(c)) return;
            printed_comments.add(c);
            need_space = false;
            if (need_newline_indented) {
                print("\n");
                indent();
                need_newline_indented = false;
            } else if (c.nlb && (i > 0 || !OUTPUT.hasNLB())) {
                print("\n");
                indent();
            } else if (i > 0 || !tail) {
                space();
            }
            if (/comment[134]/.test(c.type)) {
                const value = filter_comment(c.value);
                if (value) {
                    print("//" + value);
                }
                need_newline_indented = true;
            } else if (c.type == "comment2") {
                const value = filter_comment(c.value);
                if (value) {
                    print("/*" + value + "*/");
                }
                need_space = true;
            }
        });
        if (OUTPUT.length() > insert) newline_insert = insert;
    }

    /**
     * When output.option("_destroy_ast") is enabled, destroy the function.
     * Call this after printing it.
     */
    const gc_scope =
      options["_destroy_ast"]
        ? function gc_scope(scope) {
            scope.body.length = 0;
            scope.argnames.length = 0;
        }
        : noop;

    var stack = [];
    return {
        get             : get,
        toString        : get,
        indent          : indent,
        in_directive    : false,
        use_asm         : null,
        active_scope    : null,
        indentation     : function() { return indentation; },
        current_width   : function() { return current_col - indentation; },
        should_break    : function() { return options.width && this.current_width() >= options.width; },
        has_parens      : function() { return has_parens; },
        newline         : newline,
        print           : print,
        star            : star,
        space           : space,
        comma           : comma,
        colon           : colon,
        last            : function() { return last; },
        semicolon       : semicolon,
        force_semicolon : force_semicolon,
        to_utf8         : to_utf8,
        print_name      : function(name) { print(make_name(name)); },
        print_string    : function(str, quote, escape_directive) {
            var encoded = encode_string(str, quote);
            if (escape_directive === true && !encoded.includes("\\")) {
                // Insert semicolons to break directive prologue
                if (!OUTPUT.expectDirective()) {
                    force_semicolon();
                }
                force_semicolon();
            }
            print(encoded);
        },
        print_template_string_chars: function(str) {
            var encoded = encode_string(str, "`").replace(/\${/g, "\\${");
            return print(encoded.substr(1, encoded.length - 2));
        },
        encode_string   : encode_string,
        next_indent     : next_indent,
        with_indent     : with_indent,
        with_block      : with_block,
        with_parens     : with_parens,
        with_square     : with_square,
        add_mapping     : add_mapping,
        option          : function(opt) { return options[opt]; },
        gc_scope,
        printed_comments: printed_comments,
        prepend_comments: readonly ? noop : prepend_comments,
        append_comments : readonly || comment_filter === return_false ? noop : append_comments,
        line            : function() { return current_line; },
        col             : function() { return current_col; },
        pos             : function() { return current_pos; },
        push_node       : function(node) { stack.push(node); },
        pop_node        : function() { return stack.pop(); },
        parent          : function(n) {
            return stack[stack.length - 2 - (n || 0)];
        }
    };

}

/* -----[ code generators ]----- */

(function() {

    /* -----[ utils ]----- */

    function DEFPRINT(nodetype, generator) {
        nodetype.DEFMETHOD("_codegen", generator);
    }

    AST_Node.DEFMETHOD("print", function(output, force_parens) {
        var self = this, generator = self._codegen;
        if (self instanceof AST_Scope) {
            output.active_scope = self;
        } else if (!output.use_asm && self instanceof AST_Directive && self.value == "use asm") {
            output.use_asm = output.active_scope;
        }
        function doit() {
            output.prepend_comments(self);
            self.add_source_map(output);
            generator(self, output);
            output.append_comments(self);
        }
        output.push_node(self);
        if (force_parens || self.needs_parens(output)) {
            output.with_parens(doit);
        } else {
            doit();
        }
        output.pop_node();
        if (self === output.use_asm) {
            output.use_asm = null;
        }
    });
    AST_Node.DEFMETHOD("_print", AST_Node.prototype.print);

    AST_Node.DEFMETHOD("print_to_string", function(options) {
        var output = OutputStream(options);
        this.print(output);
        return output.get();
    });

    /* -----[ PARENTHESES ]----- */

    function PARENS(nodetype, func) {
        if (Array.isArray(nodetype)) {
            nodetype.forEach(function(nodetype) {
                PARENS(nodetype, func);
            });
        } else {
            nodetype.DEFMETHOD("needs_parens", func);
        }
    }

    PARENS(AST_Node, return_false);

    // a function expression needs parens around it when it's provably
    // the first token to appear in a statement.
    PARENS(AST_Function, function(output) {
        if (!output.has_parens() && first_in_statement(output)) {
            return true;
        }

        if (output.option("webkit")) {
            var p = output.parent();
            if (p instanceof AST_PropAccess && p.expression === this) {
                return true;
            }
        }

        if (output.option("wrap_iife")) {
            var p = output.parent();
            if (p instanceof AST_Call && p.expression === this) {
                return true;
            }
        }

        if (output.option("wrap_func_args")) {
            var p = output.parent();
            if (p instanceof AST_Call && p.args.includes(this)) {
                return true;
            }
        }

        return false;
    });

    PARENS(AST_Arrow, function(output) {
        var p = output.parent();

        if (
            output.option("wrap_func_args")
            && p instanceof AST_Call
            && p.args.includes(this)
        ) {
            return true;
        }
        return p instanceof AST_PropAccess && p.expression === this
            || p instanceof AST_Conditional && p.condition === this;
    });

    // same goes for an object literal (as in AST_Function), because
    // otherwise {...} would be interpreted as a block of code.
    PARENS(AST_Object, function(output) {
        return !output.has_parens() && first_in_statement(output);
    });

    PARENS(AST_ClassExpression, first_in_statement);

    PARENS(AST_Unary, function(output) {
        var p = output.parent();
        return p instanceof AST_PropAccess && p.expression === this
            || p instanceof AST_Call && p.expression === this
            || p instanceof AST_Binary
                && p.operator === "**"
                && this instanceof AST_UnaryPrefix
                && p.left === this
                && this.operator !== "++"
                && this.operator !== "--";
    });

    PARENS(AST_Await, function(output) {
        var p = output.parent();
        return p instanceof AST_PropAccess && p.expression === this
            || p instanceof AST_Call && p.expression === this
            || p instanceof AST_Binary && p.operator === "**" && p.left === this
            || output.option("safari10") && p instanceof AST_UnaryPrefix;
    });

    PARENS(AST_Sequence, function(output) {
        var p = output.parent();
        return p instanceof AST_Call                          // (foo, bar)() or foo(1, (2, 3), 4)
            || p instanceof AST_Unary                         // !(foo, bar, baz)
            || p instanceof AST_Binary                        // 1 + (2, 3) + 4 ==> 8
            || p instanceof AST_VarDefLike                    // var a = (1, 2), b = a + a; ==> b == 4
            || p instanceof AST_PropAccess                    // (1, {foo:2}).foo or (1, {foo:2})["foo"] ==> 2
            || p instanceof AST_Array                         // [ 1, (2, 3), 4 ] ==> [ 1, 3, 4 ]
            || p instanceof AST_ObjectProperty                // { foo: (1, 2) }.foo ==> 2
            || p instanceof AST_Conditional                   /* (false, true) ? (a = 10, b = 20) : (c = 30)
                                                               * ==> 20 (side effect, set a := 10 and b := 20) */
            || p instanceof AST_Arrow                         // x => (x, x)
            || p instanceof AST_DefaultAssign                 // x => (x = (0, function(){}))
            || p instanceof AST_Expansion                     // [...(a, b)]
            || p instanceof AST_ForOf && this === p.object    // for (e of (foo, bar)) {}
            || p instanceof AST_Yield                         // yield (foo, bar)
            || p instanceof AST_Export                        // export default (foo, bar)
        ;
    });

    PARENS(AST_Binary, function(output) {
        var p = output.parent();
        // (foo && bar)()
        if (p instanceof AST_Call && p.expression === this)
            return true;
        // typeof (foo && bar)
        if (p instanceof AST_Unary)
            return true;
        // (foo && bar)["prop"], (foo && bar).prop
        if (p instanceof AST_PropAccess && p.expression === this)
            return true;
        // this deals with precedence: 3 * (2 + 1)
        if (p instanceof AST_Binary) {
            const parent_op = p.operator;
            const op = this.operator;

            // It is forbidden for ?? to be used with || or && without parens.
            if (op === "??" && (parent_op === "||" || parent_op === "&&")) {
                return true;
            }
            if (parent_op === "??" && (op === "||" || op === "&&")) {
                return true;
            }

            const pp = PRECEDENCE[parent_op];
            const sp = PRECEDENCE[op];
            if (pp > sp
                || (pp == sp
                    && (this === p.right || parent_op == "**"))) {
                return true;
            }
        }
        if (p instanceof AST_PrivateIn) {
            const op = this.operator;

            const pp = PRECEDENCE["in"];
            const sp = PRECEDENCE[op];
            if (pp > sp || (pp == sp && this === p.value)) {
                return true;
            }
        }
    });

    PARENS(AST_PrivateIn, function(output) {
        var p = output.parent();
        // (#x in this)()
        if (p instanceof AST_Call && p.expression === this) {
            return true;
        }
        // typeof (#x in this)
        if (p instanceof AST_Unary) {
            return true;
        }
        // (#x in this)["prop"], (#x in this).prop
        if (p instanceof AST_PropAccess && p.expression === this) {
            return true;
        }
        // same precedence as regular in operator
        if (p instanceof AST_Binary) {
            const parent_op = p.operator;

            const pp = PRECEDENCE[parent_op];
            const sp = PRECEDENCE["in"];
            if (pp > sp
                || (pp == sp
                    && (this === p.right || parent_op == "**"))) {
                return true;
            }
        }
        // rules are the same as binary in, but the class differs
        if (p instanceof AST_PrivateIn && this === p.value) {
            return true;
        }
    });

    PARENS(AST_Yield, function(output) {
        var p = output.parent();
        // (yield 1) + (yield 2)
        // a = yield 3
        if (p instanceof AST_Binary && p.operator !== "=")
            return true;
        // (yield 1)()
        // new (yield 1)()
        if (p instanceof AST_Call && p.expression === this)
            return true;
        // (yield 1) ? yield 2 : yield 3
        if (p instanceof AST_Conditional && p.condition === this)
            return true;
        // -(yield 4)
        if (p instanceof AST_Unary)
            return true;
        // (yield x).foo
        // (yield x)['foo']
        if (p instanceof AST_PropAccess && p.expression === this)
            return true;
    });

    PARENS(AST_Chain, function(output) {
        var p = output.parent();
        if (!(p instanceof AST_Call || p instanceof AST_PropAccess)) return false;
        return p.expression === this;
    });

    PARENS(AST_PropAccess, function(output) {
        var p = output.parent();
        if (p instanceof AST_New && p.expression === this) {
            // i.e. new (foo.bar().baz)
            //
            // if there's one call into this subtree, then we need
            // parens around it too, otherwise the call will be
            // interpreted as passing the arguments to the upper New
            // expression.
            return walk(this, node => {
                if (node instanceof AST_Scope) return true;
                if (node instanceof AST_Call) {
                    return walk_abort;  // makes walk() return true.
                }
            });
        }
    });

    PARENS(AST_Call, function(output) {
        var p = output.parent(), p1;
        if (p instanceof AST_New && p.expression === this
            || p instanceof AST_Export && p.is_default && this.expression instanceof AST_Function)
            return true;

        // workaround for Safari bug.
        // https://bugs.webkit.org/show_bug.cgi?id=123506
        return this.expression instanceof AST_Function
            && p instanceof AST_PropAccess
            && p.expression === this
            && (p1 = output.parent(1)) instanceof AST_Assign
            && p1.left === p;
    });

    PARENS(AST_New, function(output) {
        var p = output.parent();
        if (this.args.length === 0
            && (p instanceof AST_PropAccess // (new Date).getTime(), (new Date)["getTime"]()
                || p instanceof AST_Call && p.expression === this
                || p instanceof AST_PrefixedTemplateString && p.prefix === this)) // (new foo)(bar)
            return true;
    });

    PARENS(AST_Number, function(output) {
        var p = output.parent();
        if (p instanceof AST_PropAccess && p.expression === this) {
            var value = this.getValue();
            if (value < 0 || /^0/.test(make_num(value))) {
                return true;
            }
        }
    });

    PARENS(AST_BigInt, function(output) {
        var p = output.parent();
        if (p instanceof AST_PropAccess && p.expression === this) {
            var value = this.getValue();
            if (value.startsWith("-")) {
                return true;
            }
        }
    });

    PARENS([ AST_Assign, AST_Conditional ], function(output) {
        var p = output.parent();
        // !(a = false) â†’ true
        if (p instanceof AST_Unary)
            return true;
        // 1 + (a = 2) + 3 â†’ 6, side effect setting a = 2
        if (p instanceof AST_Binary && !(p instanceof AST_Assign))
            return true;
        // (a = func)() â€”orâ€” new (a = Object)()
        if (p instanceof AST_Call && p.expression === this)
            return true;
        // (a = foo) ? bar : baz
        if (p instanceof AST_Conditional && p.condition === this)
            return true;
        // (a = foo)["prop"] â€”orâ€” (a = foo).prop
        if (p instanceof AST_PropAccess && p.expression === this)
            return true;
        // ({a, b} = {a: 1, b: 2}), a destructuring assignment
        if (this instanceof AST_Assign && this.left instanceof AST_Destructuring && this.left.is_array === false)
            return true;
    });

    /* -----[ PRINTERS ]----- */

    DEFPRINT(AST_Directive, function(self, output) {
        output.print_string(self.value, self.quote);
        output.semicolon();
    });

    DEFPRINT(AST_Expansion, function (self, output) {
        output.print("...");
        self.expression.print(output);
    });

    DEFPRINT(AST_Destructuring, function (self, output) {
        output.print(self.is_array ? "[" : "{");
        var len = self.names.length;
        self.names.forEach(function (name, i) {
            if (i > 0) output.comma();
            name.print(output);
            // If the final element is a hole, we need to make sure it
            // doesn't look like a trailing comma, by inserting an actual
            // trailing comma.
            if (i == len - 1 && name instanceof AST_Hole) output.comma();
        });
        output.print(self.is_array ? "]" : "}");
    });

    DEFPRINT(AST_Debugger, function(self, output) {
        output.print("debugger");
        output.semicolon();
    });

    /* -----[ statements ]----- */

    function display_body(body, is_toplevel, output, allow_directives) {
        var last = body.length - 1;
        output.in_directive = allow_directives;
        body.forEach(function(stmt, i) {
            if (output.in_directive === true && !(stmt instanceof AST_Directive ||
                stmt instanceof AST_EmptyStatement ||
                (stmt instanceof AST_SimpleStatement && stmt.body instanceof AST_String)
            )) {
                output.in_directive = false;
            }
            if (!(stmt instanceof AST_EmptyStatement)) {
                output.indent();
                stmt.print(output);
                if (!(i == last && is_toplevel)) {
                    output.newline();
                    if (is_toplevel) output.newline();
                }
            }
            if (output.in_directive === true &&
                stmt instanceof AST_SimpleStatement &&
                stmt.body instanceof AST_String
            ) {
                output.in_directive = false;
            }
        });
        output.in_directive = false;
    }

    AST_StatementWithBody.DEFMETHOD("_do_print_body", function(output) {
        print_maybe_braced_body(this.body, output);
    });

    DEFPRINT(AST_Statement, function(self, output) {
        self.body.print(output);
        output.semicolon();
    });
    DEFPRINT(AST_Toplevel, function(self, output) {
        display_body(self.body, true, output, true);
        output.print("");
    });
    DEFPRINT(AST_LabeledStatement, function(self, output) {
        self.label.print(output);
        output.colon();
        self.body.print(output);
    });
    DEFPRINT(AST_SimpleStatement, function(self, output) {
        self.body.print(output);
        output.semicolon();
    });
    function print_braced_empty(self, output) {
        output.print("{");
        output.with_indent(output.next_indent(), function() {
            output.append_comments(self, true);
        });
        output.add_mapping(self.end);
        output.print("}");
    }
    function print_braced(self, output, allow_directives) {
        if (self.body.length > 0) {
            output.with_block(function() {
                display_body(self.body, false, output, allow_directives);
                output.add_mapping(self.end);
            });
        } else print_braced_empty(self, output);
    }
    DEFPRINT(AST_BlockStatement, function(self, output) {
        print_braced(self, output);
    });
    DEFPRINT(AST_EmptyStatement, function(self, output) {
        output.semicolon();
    });
    DEFPRINT(AST_Do, function(self, output) {
        output.print("do");
        output.space();
        make_block(self.body, output);
        output.space();
        output.print("while");
        output.space();
        output.with_parens(function() {
            self.condition.print(output);
        });
        output.semicolon();
    });
    DEFPRINT(AST_While, function(self, output) {
        output.print("while");
        output.space();
        output.with_parens(function() {
            self.condition.print(output);
        });
        output.space();
        self._do_print_body(output);
    });
    DEFPRINT(AST_For, function(self, output) {
        output.print("for");
        output.space();
        output.with_parens(function() {
            if (self.init) {
                if (self.init instanceof AST_DefinitionsLike) {
                    self.init.print(output);
                } else {
                    parenthesize_for_noin(self.init, output, true);
                }
                output.print(";");
                output.space();
            } else {
                output.print(";");
            }
            if (self.condition) {
                self.condition.print(output);
                output.print(";");
                output.space();
            } else {
                output.print(";");
            }
            if (self.step) {
                self.step.print(output);
            }
        });
        output.space();
        self._do_print_body(output);
    });
    DEFPRINT(AST_ForIn, function(self, output) {
        output.print("for");
        if (self.await) {
            output.space();
            output.print("await");
        }
        output.space();
        output.with_parens(function() {
            self.init.print(output);
            output.space();
            output.print(self instanceof AST_ForOf ? "of" : "in");
            output.space();
            self.object.print(output);
        });
        output.space();
        self._do_print_body(output);
    });
    DEFPRINT(AST_With, function(self, output) {
        output.print("with");
        output.space();
        output.with_parens(function() {
            self.expression.print(output);
        });
        output.space();
        self._do_print_body(output);
    });

    /* -----[ functions ]----- */
    AST_Lambda.DEFMETHOD("_do_print", function(output, nokeyword) {
        var self = this;
        if (!nokeyword) {
            if (self.async) {
                output.print("async");
                output.space();
            }
            output.print("function");
            if (self.is_generator) {
                output.star();
            }
            if (self.name) {
                output.space();
            }
        }
        if (self.name instanceof AST_Symbol) {
            self.name.print(output);
        } else if (nokeyword && self.name instanceof AST_Node) {
            output.with_square(function() {
                self.name.print(output); // Computed method name
            });
        }
        output.with_parens(function() {
            self.argnames.forEach(function(arg, i) {
                if (i) output.comma();
                arg.print(output);
            });
        });
        output.space();
        print_braced(self, output, true);
    });
    DEFPRINT(AST_Lambda, function(self, output) {
        self._do_print(output);
        output.gc_scope(self);
    });

    DEFPRINT(AST_PrefixedTemplateString, function(self, output) {
        var tag = self.prefix;
        var parenthesize_tag = tag instanceof AST_Lambda
            || tag instanceof AST_Binary
            || tag instanceof AST_Conditional
            || tag instanceof AST_Sequence
            || tag instanceof AST_Unary
            || tag instanceof AST_Dot && tag.expression instanceof AST_Object;
        if (parenthesize_tag) output.print("(");
        self.prefix.print(output);
        if (parenthesize_tag) output.print(")");
        self.template_string.print(output);
    });
    DEFPRINT(AST_TemplateString, function(self, output) {
        var is_tagged = output.parent() instanceof AST_PrefixedTemplateString;

        output.print("`");
        for (var i = 0; i < self.segments.length; i++) {
            if (!(self.segments[i] instanceof AST_TemplateSegment)) {
                output.print("${");
                self.segments[i].print(output);
                output.print("}");
            } else if (is_tagged) {
                output.print(self.segments[i].raw);
            } else {
                output.print_template_string_chars(self.segments[i].value);
            }
        }
        output.print("`");
    });
    DEFPRINT(AST_TemplateSegment, function(self, output) {
        output.print_template_string_chars(self.value);
    });

    AST_Arrow.DEFMETHOD("_do_print", function(output) {
        var self = this;
        var parent = output.parent();
        var needs_parens = (parent instanceof AST_Binary &&
                !(parent instanceof AST_Assign) &&
                !(parent instanceof AST_DefaultAssign)) ||
            parent instanceof AST_Unary ||
            (parent instanceof AST_Call && self === parent.expression);
        if (needs_parens) { output.print("("); }
        if (self.async) {
            output.print("async");
            output.space();
        }
        if (self.argnames.length === 1 && self.argnames[0] instanceof AST_Symbol) {
            self.argnames[0].print(output);
        } else {
            output.with_parens(function() {
                self.argnames.forEach(function(arg, i) {
                    if (i) output.comma();
                    arg.print(output);
                });
            });
        }
        output.space();
        output.print("=>");
        output.space();
        const first_statement = self.body[0];
        if (
            self.body.length === 1
            && first_statement instanceof AST_Return
        ) {
            const returned = first_statement.value;
            if (!returned) {
                output.print("{}");
            } else if (left_is_object(returned)) {
                output.print("(");
                returned.print(output);
                output.print(")");
            } else {
                returned.print(output);
            }
        } else {
            print_braced(self, output);
        }
        if (needs_parens) { output.print(")"); }
        output.gc_scope(self);
    });

    /* -----[ exits ]----- */
    AST_Exit.DEFMETHOD("_do_print", function(output, kind) {
        output.print(kind);
        if (this.value) {
            output.space();
            const comments = this.value.start.comments_before;
            if (comments && comments.length && !output.printed_comments.has(comments)) {
                output.print("(");
                this.value.print(output);
                output.print(")");
            } else {
                this.value.print(output);
            }
        }
        output.semicolon();
    });
    DEFPRINT(AST_Return, function(self, output) {
        self._do_print(output, "return");
    });
    DEFPRINT(AST_Throw, function(self, output) {
        self._do_print(output, "throw");
    });

    /* -----[ yield ]----- */

    DEFPRINT(AST_Yield, function(self, output) {
        var star = self.is_star ? "*" : "";
        output.print("yield" + star);
        if (self.expression) {
            output.space();
            self.expression.print(output);
        }
    });

    DEFPRINT(AST_Await, function(self, output) {
        output.print("await");
        output.space();
        var e = self.expression;
        var parens = !(
               e instanceof AST_Call
            || e instanceof AST_SymbolRef
            || e instanceof AST_PropAccess
            || e instanceof AST_Unary
            || e instanceof AST_Constant
            || e instanceof AST_Await
            || e instanceof AST_Object
        );
        if (parens) output.print("(");
        self.expression.print(output);
        if (parens) output.print(")");
    });

    /* -----[ loop control ]----- */
    AST_LoopControl.DEFMETHOD("_do_print", function(output, kind) {
        output.print(kind);
        if (this.label) {
            output.space();
            this.label.print(output);
        }
        output.semicolon();
    });
    DEFPRINT(AST_Break, function(self, output) {
        self._do_print(output, "break");
    });
    DEFPRINT(AST_Continue, function(self, output) {
        self._do_print(output, "continue");
    });

    /* -----[ if ]----- */
    function make_then(self, output) {
        var b = self.body;
        if (output.option("braces")
            || output.option("ie8") && b instanceof AST_Do)
            return make_block(b, output);
        // The squeezer replaces "block"-s that contain only a single
        // statement with the statement itself; technically, the AST
        // is correct, but this can create problems when we output an
        // IF having an ELSE clause where the THEN clause ends in an
        // IF *without* an ELSE block (then the outer ELSE would refer
        // to the inner IF).  This function checks for this case and
        // adds the block braces if needed.
        if (!b) return output.force_semicolon();
        while (true) {
            if (b instanceof AST_If) {
                if (!b.alternative) {
                    make_block(self.body, output);
                    return;
                }
                b = b.alternative;
            } else if (b instanceof AST_StatementWithBody) {
                b = b.body;
            } else break;
        }
        print_maybe_braced_body(self.body, output);
    }
    DEFPRINT(AST_If, function(self, output) {
        output.print("if");
        output.space();
        output.with_parens(function() {
            self.condition.print(output);
        });
        output.space();
        if (self.alternative) {
            make_then(self, output);
            output.space();
            output.print("else");
            output.space();
            if (self.alternative instanceof AST_If)
                self.alternative.print(output);
            else
                print_maybe_braced_body(self.alternative, output);
        } else {
            self._do_print_body(output);
        }
    });

    /* -----[ switch ]----- */
    DEFPRINT(AST_Switch, function(self, output) {
        output.print("switch");
        output.space();
        output.with_parens(function() {
            self.expression.print(output);
        });
        output.space();
        var last = self.body.length - 1;
        if (last < 0) print_braced_empty(self, output);
        else output.with_block(function() {
            self.body.forEach(function(branch, i) {
                output.indent(true);
                branch.print(output);
                if (i < last && branch.body.length > 0)
                    output.newline();
            });
        });
    });
    AST_SwitchBranch.DEFMETHOD("_do_print_body", function(output) {
        output.newline();
        this.body.forEach(function(stmt) {
            output.indent();
            stmt.print(output);
            output.newline();
        });
    });
    DEFPRINT(AST_Default, function(self, output) {
        output.print("default:");
        self._do_print_body(output);
    });
    DEFPRINT(AST_Case, function(self, output) {
        output.print("case");
        output.space();
        self.expression.print(output);
        output.print(":");
        self._do_print_body(output);
    });

    /* -----[ exceptions ]----- */
    DEFPRINT(AST_Try, function(self, output) {
        output.print("try");
        output.space();
        self.body.print(output);
        if (self.bcatch) {
            output.space();
            self.bcatch.print(output);
        }
        if (self.bfinally) {
            output.space();
            self.bfinally.print(output);
        }
    });
    DEFPRINT(AST_TryBlock, function(self, output) {
        print_braced(self, output);
    });
    DEFPRINT(AST_Catch, function(self, output) {
        output.print("catch");
        if (self.argname) {
            output.space();
            output.with_parens(function() {
                self.argname.print(output);
            });
        }
        output.space();
        print_braced(self, output);
    });
    DEFPRINT(AST_Finally, function(self, output) {
        output.print("finally");
        output.space();
        print_braced(self, output);
    });

    /* -----[ var/const ]----- */
    AST_DefinitionsLike.DEFMETHOD("_do_print", function(output, kind) {
        output.print(kind);
        output.space();
        this.definitions.forEach(function(def, i) {
            if (i) output.comma();
            def.print(output);
        });
        var p = output.parent();
        var in_for = p instanceof AST_For || p instanceof AST_ForIn;
        var output_semicolon = !in_for || p && p.init !== this;
        if (output_semicolon)
            output.semicolon();
    });
    DEFPRINT(AST_Let, function(self, output) {
        self._do_print(output, "let");
    });
    DEFPRINT(AST_Var, function(self, output) {
        self._do_print(output, "var");
    });
    DEFPRINT(AST_Const, function(self, output) {
        self._do_print(output, "const");
    });
    DEFPRINT(AST_Using, function(self, output) {
        self._do_print(output, self.await ? "await using" : "using");
    });
    DEFPRINT(AST_Import, function(self, output) {
        output.print("import");
        output.space();
        if (self.imported_name) {
            self.imported_name.print(output);
        }
        if (self.imported_name && self.imported_names) {
            output.print(",");
            output.space();
        }
        if (self.imported_names) {
            if (self.imported_names.length === 1 &&
                self.imported_names[0].foreign_name.name === "*" &&
                !self.imported_names[0].foreign_name.quote) {
                self.imported_names[0].print(output);
            } else {
                output.print("{");
                self.imported_names.forEach(function (name_import, i) {
                    output.space();
                    name_import.print(output);
                    if (i < self.imported_names.length - 1) {
                        output.print(",");
                    }
                });
                output.space();
                output.print("}");
            }
        }
        if (self.imported_name || self.imported_names) {
            output.space();
            output.print("from");
            output.space();
        }
        self.module_name.print(output);
        if (self.attributes) {
            output.print("with");
            self.attributes.print(output);
        }
        output.semicolon();
    });
    DEFPRINT(AST_ImportMeta, function(self, output) {
        output.print("import.meta");
    });

    DEFPRINT(AST_NameMapping, function(self, output) {
        var is_import = output.parent() instanceof AST_Import;
        var definition = self.name.definition();
        var foreign_name = self.foreign_name;
        var names_are_different =
            (definition && definition.mangled_name || self.name.name) !==
            foreign_name.name;
        if (!names_are_different &&
            foreign_name.name === "*" &&
            !!foreign_name.quote != !!self.name.quote) {
                // export * as "*"
            names_are_different = true;
        }
        var foreign_name_is_name = !foreign_name.quote;
        if (names_are_different) {
            if (is_import) {
                if (foreign_name_is_name) {
                    output.print(foreign_name.name);
                } else {
                    output.print_string(foreign_name.name, foreign_name.quote);
                }
            } else {
                if (!self.name.quote) {
                    self.name.print(output);
                } else {
                    output.print_string(self.name.name, self.name.quote);
                }
                
            }
            output.space();
            output.print("as");
            output.space();
            if (is_import) {
                self.name.print(output);
            } else {
                if (foreign_name_is_name) {
                    output.print(foreign_name.name);
                } else {
                    output.print_string(foreign_name.name, foreign_name.quote);
                }
            }
        } else {
            if (!self.name.quote) {
                self.name.print(output);
            } else {
                output.print_string(self.name.name, self.name.quote);
            }
        }
    });

    DEFPRINT(AST_Export, function(self, output) {
        output.print("export");
        output.space();
        if (self.is_default) {
            output.print("default");
            output.space();
        }
        if (self.exported_names) {
            if (self.exported_names.length === 1 &&
                self.exported_names[0].name.name === "*" &&
                !self.exported_names[0].name.quote) {
                    self.exported_names[0].print(output);
            } else {
                output.print("{");
                self.exported_names.forEach(function(name_export, i) {
                    output.space();
                    name_export.print(output);
                    if (i < self.exported_names.length - 1) {
                        output.print(",");
                    }
                });
                output.space();
                output.print("}");
            }
        } else if (self.exported_value) {
            self.exported_value.print(output);
        } else if (self.exported_definition) {
            self.exported_definition.print(output);
            if (self.exported_definition instanceof AST_Definitions) return;
        }
        if (self.module_name) {
            output.space();
            output.print("from");
            output.space();
            self.module_name.print(output);
        }
        if (self.attributes) {
            output.print("with");
            self.attributes.print(output);
        }
        if (self.exported_value
                && !(self.exported_value instanceof AST_Defun ||
                    self.exported_value instanceof AST_Function ||
                    self.exported_value instanceof AST_Class)
            || self.module_name
            || self.exported_names
        ) {
            output.semicolon();
        }
    });

    function parenthesize_for_noin(node, output, noin) {
        var parens = false;
        // need to take some precautions here:
        //    https://github.com/mishoo/UglifyJS2/issues/60
        if (noin) {
            parens = walk(node, node => {
                // Don't go into scopes -- except arrow functions:
                // https://github.com/terser/terser/issues/1019#issuecomment-877642607
                if (node instanceof AST_Scope && !(node instanceof AST_Arrow)) {
                    return true;
                }
                if (
                    node instanceof AST_Binary && node.operator == "in"
                    || node instanceof AST_PrivateIn
                ) {
                    return walk_abort;  // makes walk() return true
                }
            });
        }
        node.print(output, parens);
    }

    DEFPRINT(AST_VarDefLike, function(self, output) {
        self.name.print(output);
        if (self.value) {
            output.space();
            output.print("=");
            output.space();
            var p = output.parent(1);
            var noin = p instanceof AST_For || p instanceof AST_ForIn;
            parenthesize_for_noin(self.value, output, noin);
        }
    });

    /* -----[ other expressions ]----- */
    DEFPRINT(AST_Call, function(self, output) {
        self.expression.print(output);
        if (self instanceof AST_New && self.args.length === 0)
            return;
        if (self.expression instanceof AST_Call || self.expression instanceof AST_Lambda) {
            output.add_mapping(self.start);
        }
        if (self.optional) output.print("?.");
        output.with_parens(function() {
            self.args.forEach(function(expr, i) {
                if (i) output.comma();
                expr.print(output);
            });
        });
    });
    DEFPRINT(AST_New, function(self, output) {
        output.print("new");
        output.space();
        AST_Call.prototype._codegen(self, output);
    });

    AST_Sequence.DEFMETHOD("_do_print", function(output) {
        this.expressions.forEach(function(node, index) {
            if (index > 0) {
                output.comma();
                if (output.should_break()) {
                    output.newline();
                    output.indent();
                }
            }
            node.print(output);
        });
    });
    DEFPRINT(AST_Sequence, function(self, output) {
        self._do_print(output);
        // var p = output.parent();
        // if (p instanceof AST_Statement) {
        //     output.with_indent(output.next_indent(), function(){
        //         self._do_print(output);
        //     });
        // } else {
        //     self._do_print(output);
        // }
    });
    DEFPRINT(AST_Dot, function(self, output) {
        var expr = self.expression;
        expr.print(output);
        var prop = self.property;
        var print_computed = ALL_RESERVED_WORDS.has(prop)
            ? output.option("ie8")
            : !is_identifier_string(
                prop,
                output.option("ecma") >= 2015 && !output.option("safari10")
            );

        if (self.optional) output.print("?.");

        if (print_computed) {
            output.print("[");
            output.add_mapping(self.end);
            output.print_string(prop);
            output.print("]");
        } else {
            if (expr instanceof AST_Number && expr.getValue() >= 0) {
                if (!/[xa-f.)]/i.test(output.last())) {
                    output.print(".");
                }
            }
            if (!self.optional) output.print(".");
            // the name after dot would be mapped about here.
            output.add_mapping(self.end);
            output.print_name(prop);
        }
    });
    DEFPRINT(AST_DotHash, function(self, output) {
        var expr = self.expression;
        expr.print(output);
        var prop = self.property;

        if (self.optional) output.print("?");
        output.print(".#");
        output.add_mapping(self.end);
        output.print_name(prop);
    });
    DEFPRINT(AST_Sub, function(self, output) {
        self.expression.print(output);
        if (self.optional) output.print("?.");
        output.print("[");
        self.property.print(output);
        output.print("]");
    });
    DEFPRINT(AST_Chain, function(self, output) {
        self.expression.print(output);
    });
    DEFPRINT(AST_UnaryPrefix, function(self, output) {
        var op = self.operator;
        if (op === "--" && output.last().endsWith("!")) {
            // avoid printing "<!--"
            output.print(" ");
        }
        output.print(op);
        if (/^[a-z]/i.test(op)
            || (/[+-]$/.test(op)
                && self.expression instanceof AST_UnaryPrefix
                && /^[+-]/.test(self.expression.operator))) {
            output.space();
        }
        self.expression.print(output);
    });
    DEFPRINT(AST_UnaryPostfix, function(self, output) {
        self.expression.print(output);
        output.print(self.operator);
    });
    DEFPRINT(AST_Binary, function(self, output) {
        var op = self.operator;
        self.left.print(output);
        if (op[0] == ">" /* ">>" ">>>" ">" ">=" */
            && output.last().endsWith("--")) {
            // space is mandatory to avoid outputting -->
            output.print(" ");
        } else {
            // the space is optional depending on "beautify"
            output.space();
        }
        output.print(op);
        output.space();
        self.right.print(output);
    });
    DEFPRINT(AST_Conditional, function(self, output) {
        self.condition.print(output);
        output.space();
        output.print("?");
        output.space();
        self.consequent.print(output);
        output.space();
        output.colon();
        self.alternative.print(output);
    });

    /* -----[ literals ]----- */
    DEFPRINT(AST_Array, function(self, output) {
        output.with_square(function() {
            var a = self.elements, len = a.length;
            if (len > 0) output.space();
            a.forEach(function(exp, i) {
                if (i) output.comma();
                exp.print(output);
                // If the final element is a hole, we need to make sure it
                // doesn't look like a trailing comma, by inserting an actual
                // trailing comma.
                if (i === len - 1 && exp instanceof AST_Hole)
                  output.comma();
            });
            if (len > 0) output.space();
        });
    });
    DEFPRINT(AST_Object, function(self, output) {
        if (self.properties.length > 0) output.with_block(function() {
            self.properties.forEach(function(prop, i) {
                if (i) {
                    output.print(",");
                    output.newline();
                }
                output.indent();
                prop.print(output);
            });
            output.newline();
        });
        else print_braced_empty(self, output);
    });
    DEFPRINT(AST_Class, function(self, output) {
        output.print("class");
        output.space();
        if (self.name) {
            self.name.print(output);
            output.space();
        }
        if (self.extends) {
            var parens = (
                   !(self.extends instanceof AST_SymbolRef)
                && !(self.extends instanceof AST_PropAccess)
                && !(self.extends instanceof AST_ClassExpression)
                && !(self.extends instanceof AST_Function)
            );
            output.print("extends");
            if (parens) {
                output.print("(");
            } else {
                output.space();
            }
            self.extends.print(output);
            if (parens) {
                output.print(")");
            } else {
                output.space();
            }
        }
        if (self.properties.length > 0) output.with_block(function() {
            self.properties.forEach(function(prop, i) {
                if (i) {
                    output.newline();
                }
                output.indent();
                prop.print(output);
            });
            output.newline();
        });
        else output.print("{}");
    });
    DEFPRINT(AST_NewTarget, function(self, output) {
        output.print("new.target");
    });

    /** Prints a prop name. Returns whether it can be used as a shorthand. */
    function print_property_name(key, quote, output) {
        if (output.option("quote_keys")) {
            output.print_string(key);
            return false;
        }
        if ("" + +key == key && key >= 0) {
            if (output.option("keep_numbers")) {
                output.print(key);
                return false;
            }
            output.print(make_num(key));
            return false;
        }
        var print_string = ALL_RESERVED_WORDS.has(key)
            ? output.option("ie8")
            : (
                output.option("ecma") < 2015 || output.option("safari10")
                    ? !is_basic_identifier_string(key)
                    : !is_identifier_string(key, true)
            );
        if (print_string || (quote && output.option("keep_quoted_props"))) {
            output.print_string(key, quote);
            return false;
        }
        output.print_name(key);
        return true;
    }

    DEFPRINT(AST_ObjectKeyVal, function(self, output) {
        function get_name(self) {
            var def = self.definition();
            return def ? def.mangled_name || def.name : self.name;
        }

        const try_shorthand = output.option("shorthand") && !(self.key instanceof AST_Node);
        if (
            try_shorthand
            && self.value instanceof AST_Symbol
            && get_name(self.value) === self.key
            && !ALL_RESERVED_WORDS.has(self.key)
        ) {
            const was_shorthand = print_property_name(self.key, self.quote, output);
            if (!was_shorthand) {
                output.colon();
                self.value.print(output);
            }
        } else if (
            try_shorthand
            && self.value instanceof AST_DefaultAssign
            && self.value.left instanceof AST_Symbol
            && get_name(self.value.left) === self.key
        ) {
            const was_shorthand = print_property_name(self.key, self.quote, output);
            if (!was_shorthand) {
                output.colon();
                self.value.left.print(output);
            }
            output.space();
            output.print("=");
            output.space();
            self.value.right.print(output);
        } else {
            if (!(self.key instanceof AST_Node)) {
                print_property_name(self.key, self.quote, output);
            } else {
                output.with_square(function() {
                    self.key.print(output);
                });
            }
            output.colon();
            self.value.print(output);
        }
    });
    DEFPRINT(AST_ClassPrivateProperty, (self, output) => {
        if (self.static) {
            output.print("static");
            output.space();
        }

        output.print("#");
        
        print_property_name(self.key.name, undefined, output);

        if (self.value) {
            output.print("=");
            self.value.print(output);
        }

        output.semicolon();
    });
    DEFPRINT(AST_ClassProperty, (self, output) => {
        if (self.static) {
            output.print("static");
            output.space();
        }

        if (self.key instanceof AST_SymbolClassProperty) {
            print_property_name(self.key.name, self.quote, output);
        } else {
            output.print("[");
            self.key.print(output);
            output.print("]");
        }

        if (self.value) {
            output.print("=");
            self.value.print(output);
        }

        output.semicolon();
    });
    AST_ObjectProperty.DEFMETHOD("_print_getter_setter", function(type, is_private, output) {
        var self = this;
        if (self.static) {
            output.print("static");
            output.space();
        }
        if (type) {
            output.print(type);
            output.space();
        }
        if (self.key instanceof AST_SymbolMethod) {
            if (is_private) output.print("#");
            print_property_name(self.key.name, self.quote, output);
            self.key.add_source_map(output);
        } else {
            output.with_square(function() {
                self.key.print(output);
            });
        }
        self.value._do_print(output, true);
    });
    DEFPRINT(AST_ObjectSetter, function(self, output) {
        self._print_getter_setter("set", false, output);
    });
    DEFPRINT(AST_ObjectGetter, function(self, output) {
        self._print_getter_setter("get", false, output);
    });
    DEFPRINT(AST_PrivateSetter, function(self, output) {
        self._print_getter_setter("set", true, output);
    });
    DEFPRINT(AST_PrivateGetter, function(self, output) {
        self._print_getter_setter("get", true, output);
    });
    DEFPRINT(AST_ConciseMethod, function(self, output) {
        var type;
        if (self.value.is_generator && self.value.async) {
            type = "async*";
        } else if (self.value.is_generator) {
            type = "*";
        } else if (self.value.async) {
            type = "async";
        }
        self._print_getter_setter(type, false, output);
    });
    DEFPRINT(AST_PrivateMethod, function(self, output) {
        var type;
        if (self.value.is_generator && self.value.async) {
            type = "async*";
        } else if (self.value.is_generator) {
            type = "*";
        } else if (self.value.async) {
            type = "async";
        }
        self._print_getter_setter(type, true, output);
    });
    DEFPRINT(AST_PrivateIn, function(self, output) {
        self.key.print(output);
        output.space();
        output.print("in");
        output.space();
        self.value.print(output);
    });
    DEFPRINT(AST_SymbolPrivateProperty, function(self, output) {
        output.print("#" + self.name);
    });
    DEFPRINT(AST_ClassStaticBlock, function (self, output) {
        output.print("static");
        output.space();
        print_braced(self, output);
    });
    AST_Symbol.DEFMETHOD("_do_print", function(output) {
        var def = this.definition();
        output.print_name(def ? def.mangled_name || def.name : this.name);
    });
    DEFPRINT(AST_Symbol, function (self, output) {
        self._do_print(output);
    });
    DEFPRINT(AST_Hole, noop);
    DEFPRINT(AST_This, function(self, output) {
        output.print("this");
    });
    DEFPRINT(AST_Super, function(self, output) {
        output.print("super");
    });
    DEFPRINT(AST_Constant, function(self, output) {
        output.print(self.getValue());
    });
    DEFPRINT(AST_String, function(self, output) {
        output.print_string(self.getValue(), self.quote, output.in_directive);
    });
    DEFPRINT(AST_Number, function(self, output) {
        if ((output.option("keep_numbers") || output.use_asm) && self.raw) {
            output.print(self.raw);
        } else {
            output.print(make_num(self.getValue()));
        }
    });
    DEFPRINT(AST_BigInt, function(self, output) {
        if (output.option("keep_numbers") && self.raw) {
            output.print(self.raw);
        } else {
            output.print(self.getValue() + "n");
        }
    });

    const r_slash_script = /(<\s*\/\s*script)/i;
    const r_starts_with_script = /^\s*script/i;
    const slash_script_replace = (_, $1) => $1.replace("/", "\\/");
    DEFPRINT(AST_RegExp, function(self, output) {
        let { source, flags } = self.getValue();
        source = regexp_source_fix(source);
        flags = flags ? sort_regexp_flags(flags) : "";

        // Avoid outputting end of script tag
        source = source.replace(r_slash_script, slash_script_replace);
        if (r_starts_with_script.test(source) && output.last().endsWith("<")) {
            output.print(" ");
        }

        output.print(output.to_utf8(`/${source}/${flags}`, false, true));

        const parent = output.parent();
        if (
            parent instanceof AST_Binary
            && /^\w/.test(parent.operator)
            && parent.left === self
        ) {
            output.print(" ");
        }
    });

    /** if, for, while, may or may not have braces surrounding its body */
    function print_maybe_braced_body(stat, output) {
        if (output.option("braces")) {
            make_block(stat, output);
        } else {
            if (!stat || stat instanceof AST_EmptyStatement)
                output.force_semicolon();
            else if ((stat instanceof AST_DefinitionsLike && !(stat instanceof AST_Var)) || stat instanceof AST_Class)
                make_block(stat, output);
            else
                stat.print(output);
        }
    }

    function best_of(a) {
        var best = a[0], len = best.length;
        for (var i = 1; i < a.length; ++i) {
            if (a[i].length < len) {
                best = a[i];
                len = best.length;
            }
        }
        return best;
    }

    function make_num(num) {
        var str = num.toString(10).replace(/^0\./, ".").replace("e+", "e");
        var candidates = [ str ];
        if (Math.floor(num) === num) {
            if (num < 0) {
                candidates.push("-0x" + (-num).toString(16).toLowerCase());
            } else {
                candidates.push("0x" + num.toString(16).toLowerCase());
            }
        }
        var match, len, digits;
        if (match = /^\.0+/.exec(str)) {
            len = match[0].length;
            digits = str.slice(len);
            candidates.push(digits + "e-" + (digits.length + len - 1));
        } else if (match = /0+$/.exec(str)) {
            len = match[0].length;
            candidates.push(str.slice(0, -len) + "e" + len);
        } else if (match = /^(\d)\.(\d+)e(-?\d+)$/.exec(str)) {
            candidates.push(match[1] + match[2] + "e" + (match[3] - match[2].length));
        }
        return best_of(candidates);
    }

    function make_block(stmt, output) {
        if (!stmt || stmt instanceof AST_EmptyStatement)
            output.print("{}");
        else if (stmt instanceof AST_BlockStatement)
            stmt.print(output);
        else output.with_block(function() {
            output.indent();
            stmt.print(output);
            output.newline();
        });
    }

    /* -----[ source map generators ]----- */

    function DEFMAP(nodetype, generator) {
        nodetype.forEach(function(nodetype) {
            nodetype.DEFMETHOD("add_source_map", generator);
        });
    }

    DEFMAP([
        // We could easily add info for ALL nodes, but it seems to me that
        // would be quite wasteful, hence this noop in the base class.
        AST_Node,
        // since the label symbol will mark it
        AST_LabeledStatement,
        AST_Toplevel,
    ], noop);

    // XXX: I'm not exactly sure if we need it for all of these nodes,
    // or if we should add even more.
    DEFMAP([
        AST_Array,
        AST_BlockStatement,
        AST_Catch,
        AST_Class,
        AST_Constant,
        AST_Debugger,
        AST_DefinitionsLike,
        AST_Directive,
        AST_Finally,
        AST_Jump,
        AST_Lambda,
        AST_New,
        AST_Object,
        AST_StatementWithBody,
        AST_Symbol,
        AST_Switch,
        AST_SwitchBranch,
        AST_TemplateString,
        AST_TemplateSegment,
        AST_Try,
    ], function(output) {
        output.add_mapping(this.start);
    });

    DEFMAP([
        AST_ObjectGetter,
        AST_ObjectSetter,
        AST_PrivateGetter,
        AST_PrivateSetter,
        AST_ConciseMethod,
        AST_PrivateMethod,
    ], function(output) {
        output.add_mapping(this.start, false /*name handled below*/);
    });

    DEFMAP([
        AST_SymbolMethod,
        AST_SymbolPrivateProperty
    ], function(output) {
        const tok_type = this.end && this.end.type;
        if (tok_type === "name" || tok_type === "privatename") {
            output.add_mapping(this.end, this.name);
        } else {
            output.add_mapping(this.end);
        }
    });

    DEFMAP([ AST_ObjectProperty ], function(output) {
        output.add_mapping(this.start, this.key);
    });
})();

export {
    OutputStream,
};

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regeneratorValues.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _regeneratorValues;
function _regeneratorValues(iterable) {
  if (iterable != null) {
    var iteratorMethod = iterable[typeof Symbol === "function" && Symbol.iterator || "@@iterator"],
      i = 0;
    if (iteratorMethod) {
      return iteratorMethod.call(iterable);
    }
    if (typeof iterable.next === "function") {
      return iterable;
    }
    if (!isNaN(iterable.length)) {
      return {
        next: function () {
          if (iterable && i >= iterable.length) iterable = undefined;
          return {
            value: iterable && iterable[i++],
            done: !iterable
          };
        }
      };
    }
  }
  throw new TypeError(typeof iterable + " is not iterable");
}

//# sourceMappingURL=regeneratorValues.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regeneratorRuntime.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _regeneratorRuntime;
var _OverloadYield = require("./OverloadYield.js");
var _regenerator = require("./regenerator.js");
var _regeneratorAsync = require("./regeneratorAsync.js");
var _regeneratorAsyncGen = require("./regeneratorAsyncGen.js");
var _regeneratorAsyncIterator = require("./regeneratorAsyncIterator.js");
var _regeneratorKeys = require("./regeneratorKeys.js");
var _regeneratorValues = require("./regeneratorValues.js");
function _regeneratorRuntime() {
  "use strict";

  var r = (0, _regenerator.default)();
  var gen = r.m(_regeneratorRuntime);
  var GeneratorFunctionPrototype = Object.getPrototypeOf ? Object.getPrototypeOf(gen) : gen.__proto__;
  var GeneratorFunction = GeneratorFunctionPrototype.constructor;
  function isGeneratorFunction(genFun) {
    var ctor = typeof genFun === "function" && genFun.constructor;
    return ctor ? ctor === GeneratorFunction || (ctor.displayName || ctor.name) === "GeneratorFunction" : false;
  }
  var abruptMap = {
    throw: 1,
    return: 2,
    break: 3,
    continue: 3
  };
  function wrapInnerFn(innerFn) {
    var compatContext;
    var callSyncState;
    return function (context) {
      if (!compatContext) {
        compatContext = {
          stop: function () {
            return callSyncState(context.a, 2);
          },
          catch: function () {
            return context.v;
          },
          abrupt: function (type, arg) {
            return callSyncState(context.a, abruptMap[type], arg);
          },
          delegateYield: function (iterable, resultName, nextLoc) {
            compatContext.resultName = resultName;
            return callSyncState(context.d, (0, _regeneratorValues.default)(iterable), nextLoc);
          },
          finish: function (finallyLoc) {
            return callSyncState(context.f, finallyLoc);
          }
        };
        callSyncState = function (fn, a1, a2) {
          context.p = compatContext.prev;
          context.n = compatContext.next;
          try {
            return fn(a1, a2);
          } finally {
            compatContext.next = context.n;
          }
        };
      }
      if (compatContext.resultName) {
        compatContext[compatContext.resultName] = context.v;
        compatContext.resultName = undefined;
      }
      compatContext.sent = context.v;
      compatContext.next = context.n;
      try {
        return innerFn.call(this, compatContext);
      } finally {
        context.p = compatContext.prev;
        context.n = compatContext.next;
      }
    };
  }
  return (exports.default = _regeneratorRuntime = function () {
    return {
      wrap: function (innerFn, outerFn, self, tryLocsList) {
        return r.w(wrapInnerFn(innerFn), outerFn, self, tryLocsList && tryLocsList.reverse());
      },
      isGeneratorFunction: isGeneratorFunction,
      mark: r.m,
      awrap: function (value, kind) {
        return new _OverloadYield.default(value, kind);
      },
      AsyncIterator: _regeneratorAsyncIterator.default,
      async: function (innerFn, outerFn, self, tryLocsList, PromiseImpl) {
        return (isGeneratorFunction(outerFn) ? _regeneratorAsyncGen.default : _regeneratorAsync.default)(wrapInnerFn(innerFn), outerFn, self, tryLocsList, PromiseImpl);
      },
      keys: _regeneratorKeys.default,
      values: _regeneratorValues.default
    };
  })();
}

//# sourceMappingURL=regeneratorRuntime.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regenerator.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _regenerator;
var _regeneratorDefine = require("./regeneratorDefine.js");
function _regenerator() {
  var undefined;
  var $Symbol = typeof Symbol === "function" ? Symbol : {};
  var iteratorSymbol = $Symbol.iterator || "@@iterator";
  var toStringTagSymbol = $Symbol.toStringTag || "@@toStringTag";
  var _;
  function wrap(innerFn, outerFn, self, tryLocsList) {
    var protoGenerator = outerFn && outerFn.prototype instanceof Generator ? outerFn : Generator;
    var generator = Object.create(protoGenerator.prototype);
    (0, _regeneratorDefine.default)(generator, "_invoke", makeInvokeMethod(innerFn, self, tryLocsList), true);
    return generator;
  }
  var ContinueSentinel = {};
  function Generator() {}
  function GeneratorFunction() {}
  function GeneratorFunctionPrototype() {}
  _ = Object.getPrototypeOf;
  var IteratorPrototype = [][iteratorSymbol] ? _(_([][iteratorSymbol]())) : ((0, _regeneratorDefine.default)(_ = {}, iteratorSymbol, function () {
    return this;
  }), _);
  var Gp = GeneratorFunctionPrototype.prototype = Generator.prototype = Object.create(IteratorPrototype);
  GeneratorFunction.prototype = GeneratorFunctionPrototype;
  (0, _regeneratorDefine.default)(Gp, "constructor", GeneratorFunctionPrototype);
  (0, _regeneratorDefine.default)(GeneratorFunctionPrototype, "constructor", GeneratorFunction);
  GeneratorFunction.displayName = "GeneratorFunction";
  (0, _regeneratorDefine.default)(GeneratorFunctionPrototype, toStringTagSymbol, "GeneratorFunction");
  (0, _regeneratorDefine.default)(Gp);
  (0, _regeneratorDefine.default)(Gp, toStringTagSymbol, "Generator");
  (0, _regeneratorDefine.default)(Gp, iteratorSymbol, function () {
    return this;
  });
  (0, _regeneratorDefine.default)(Gp, "toString", function () {
    return "[object Generator]";
  });
  function mark(genFun) {
    if (Object.setPrototypeOf) {
      Object.setPrototypeOf(genFun, GeneratorFunctionPrototype);
    } else {
      genFun.__proto__ = GeneratorFunctionPrototype;
      (0, _regeneratorDefine.default)(genFun, toStringTagSymbol, "GeneratorFunction");
    }
    genFun.prototype = Object.create(Gp);
    return genFun;
  }
  function makeInvokeMethod(innerFn, self, tryLocsList) {
    var state = 0;
    function invoke(_methodName, _method, _arg) {
      if (state > 1) {
        throw TypeError("Generator is already running");
      } else if (done) {
        if (_method === 1) {
          Context_dispatchExceptionOrFinishOrAbrupt(_method, _arg);
        }
      }
      method = _method;
      arg = _arg;
      while ((_ = method < 2 ? undefined : arg) || !done) {
        if (!delegateIterator) {
          if (!method) {
            ctx.v = arg;
          } else if (method < 3) {
            if (method > 1) ctx.n = -1;
            Context_dispatchExceptionOrFinishOrAbrupt(method, arg);
          } else {
            ctx.n = arg;
          }
        }
        try {
          state = 2;
          if (delegateIterator) {
            if (!method) _methodName = "next";
            if (_ = delegateIterator[_methodName]) {
              if (!(_ = _.call(delegateIterator, arg))) {
                throw TypeError("iterator result is not an object");
              }
              if (!_.done) {
                return _;
              }
              arg = _.value;
              if (method < 2) {
                method = 0;
              }
            } else {
              if (method === 1 && (_ = delegateIterator["return"])) {
                _.call(delegateIterator);
              }
              if (method < 2) {
                arg = TypeError("The iterator does not provide a '" + _methodName + "' method");
                method = 1;
              }
            }
            delegateIterator = undefined;
          } else {
            if (done = ctx.n < 0) {
              _ = arg;
            } else {
              _ = innerFn.call(self, ctx);
            }
            if (_ !== ContinueSentinel) {
              break;
            }
          }
        } catch (e) {
          delegateIterator = undefined;
          method = 1;
          arg = e;
        } finally {
          state = 1;
        }
      }
      return {
        value: _,
        done: done
      };
    }
    var tryEntries = tryLocsList || [];
    var done = false;
    var delegateIterator;
    var method;
    var arg;
    var ctx = {
      p: 0,
      n: 0,
      v: undefined,
      a: Context_dispatchExceptionOrFinishOrAbrupt,
      f: Context_dispatchExceptionOrFinishOrAbrupt.bind(undefined, 4),
      d: function (iterable, nextLoc) {
        delegateIterator = iterable;
        method = 0;
        arg = undefined;
        ctx.n = nextLoc;
        return ContinueSentinel;
      }
    };
    function Context_dispatchExceptionOrFinishOrAbrupt(_type, _arg) {
      method = _type;
      arg = _arg;
      for (_ = 0; !done && state && !shouldReturn && _ < tryEntries.length; _++) {
        var entry = tryEntries[_];
        var prev = ctx.p;
        var finallyLoc = entry[2];
        var shouldReturn;
        if (_type > 3) {
          if (shouldReturn = finallyLoc === _arg) {
            arg = entry[(method = entry[4]) ? 5 : (method = 3, 3)];
            entry[4] = entry[5] = undefined;
          }
        } else {
          if (entry[0] <= prev) {
            if (shouldReturn = _type < 2 && prev < entry[1]) {
              method = 0;
              ctx.v = _arg;
              ctx.n = entry[1];
            } else if (prev < finallyLoc) {
              if (shouldReturn = _type < 3 || entry[0] > _arg || _arg > finallyLoc) {
                entry[4] = _type;
                entry[5] = _arg;
                ctx.n = finallyLoc;
                method = 0;
              }
            }
          }
        }
      }
      if (shouldReturn || _type > 1) {
        return ContinueSentinel;
      }
      done = true;
      throw _arg;
    }
    return invoke;
  }
  return (exports.default = _regenerator = function () {
    return {
      w: wrap,
      m: mark
    };
  })();
}

//# sourceMappingURL=regenerator.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regeneratorDefine.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = regeneratorDefine;
function regeneratorDefine(obj, key, value, noFlags) {
  var define = Object.defineProperty;
  try {
    define({}, "", {});
  } catch (_) {
    define = 0;
  }
  exports.default = regeneratorDefine = function (obj, key, value, noFlags) {
    function defineIteratorMethod(method, i) {
      regeneratorDefine(obj, method, function (arg) {
        return this._invoke(method, i, arg);
      });
    }
    if (!key) {
      defineIteratorMethod("next", 0);
      defineIteratorMethod("throw", 1);
      defineIteratorMethod("return", 2);
    } else {
      if (define) {
        define(obj, key, {
          value: value,
          enumerable: !noFlags,
          configurable: !noFlags,
          writable: !noFlags
        });
      } else {
        obj[key] = value;
      }
    }
  };
  regeneratorDefine(obj, key, value, noFlags);
}

//# sourceMappingURL=regeneratorDefine.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regeneratorAsyncGen.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _regeneratorAsyncGen;
var _regenerator = require("./regenerator.js");
var _regeneratorAsyncIterator = require("./regeneratorAsyncIterator.js");
function _regeneratorAsyncGen(innerFn, outerFn, self, tryLocsList, PromiseImpl) {
  return new _regeneratorAsyncIterator.default((0, _regenerator.default)().w(innerFn, outerFn, self, tryLocsList), PromiseImpl || Promise);
}

//# sourceMappingURL=regeneratorAsyncGen.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/wrapAsyncGenerator.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _wrapAsyncGenerator;
var _OverloadYield = require("./OverloadYield.js");
function _wrapAsyncGenerator(fn) {
  return function () {
    return new AsyncGenerator(fn.apply(this, arguments));
  };
}
function AsyncGenerator(gen) {
  var front, back;
  function send(key, arg) {
    return new Promise(function (resolve, reject) {
      var request = {
        key: key,
        arg: arg,
        resolve: resolve,
        reject: reject,
        next: null
      };
      if (back) {
        back = back.next = request;
      } else {
        front = back = request;
        resume(key, arg);
      }
    });
  }
  function resume(key, arg) {
    try {
      var result = gen[key](arg);
      var value = result.value;
      var overloaded = value instanceof _OverloadYield.default;
      Promise.resolve(overloaded ? value.v : value).then(function (arg) {
        if (overloaded) {
          var nextKey = key === "return" ? "return" : "next";
          if (!value.k || arg.done) {
            return resume(nextKey, arg);
          } else {
            arg = gen[nextKey](arg).value;
          }
        }
        settle(result.done ? "return" : "normal", arg);
      }, function (err) {
        resume("throw", err);
      });
    } catch (err) {
      settle("throw", err);
    }
  }
  function settle(type, value) {
    switch (type) {
      case "return":
        front.resolve({
          value: value,
          done: true
        });
        break;
      case "throw":
        front.reject(value);
        break;
      default:
        front.resolve({
          value: value,
          done: false
        });
        break;
    }
    front = front.next;
    if (front) {
      resume(front.key, front.arg);
    } else {
      back = null;
    }
  }
  this._invoke = send;
  if (typeof gen["return"] !== "function") {
    this["return"] = undefined;
  }
}
AsyncGenerator.prototype[typeof Symbol === "function" && Symbol.asyncIterator || "@@asyncIterator"] = function () {
  return this;
};
AsyncGenerator.prototype.next = function (arg) {
  return this._invoke("next", arg);
};
AsyncGenerator.prototype["throw"] = function (arg) {
  return this._invoke("throw", arg);
};
AsyncGenerator.prototype["return"] = function (arg) {
  return this._invoke("return", arg);
};

//# sourceMappingURL=wrapAsyncGenerator.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/asyncToGenerator.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _asyncToGenerator;
function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  try {
    var info = gen[key](arg);
    var value = info.value;
  } catch (error) {
    reject(error);
    return;
  }
  if (info.done) {
    resolve(value);
  } else {
    Promise.resolve(value).then(_next, _throw);
  }
}
function _asyncToGenerator(fn) {
  return function () {
    var self = this,
      args = arguments;
    return new Promise(function (resolve, reject) {
      var gen = fn.apply(self, args);
      function _next(value) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);
      }
      function _throw(err) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);
      }
      _next(undefined);
    });
  };
}

//# sourceMappingURL=asyncToGenerator.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/asyncGeneratorDelegate.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _asyncGeneratorDelegate;
var _OverloadYield = require("./OverloadYield.js");
function _asyncGeneratorDelegate(inner) {
  var iter = {},
    waiting = false;
  function pump(key, value) {
    waiting = true;
    value = new Promise(function (resolve) {
      resolve(inner[key](value));
    });
    return {
      done: false,
      value: new _OverloadYield.default(value, 1)
    };
  }
  iter[typeof Symbol !== "undefined" && Symbol.iterator || "@@iterator"] = function () {
    return this;
  };
  iter.next = function (value) {
    if (waiting) {
      waiting = false;
      return value;
    }
    return pump("next", value);
  };
  if (typeof inner["throw"] === "function") {
    iter["throw"] = function (value) {
      if (waiting) {
        waiting = false;
        throw value;
      }
      return pump("throw", value);
    };
  }
  if (typeof inner["return"] === "function") {
    iter["return"] = function (value) {
      if (waiting) {
        waiting = false;
        return value;
      }
      return pump("return", value);
    };
  }
  return iter;
}

//# sourceMappingURL=asyncGeneratorDelegate.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/awaitAsyncGenerator.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _awaitAsyncGenerator;
var _OverloadYield = require("./OverloadYield.js");
function _awaitAsyncGenerator(value) {
  return new _OverloadYield.default(value, 0);
}

//# sourceMappingURL=awaitAsyncGenerator.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regeneratorAsync.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _regeneratorAsync;
var _regeneratorAsyncGen = require("./regeneratorAsyncGen.js");
function _regeneratorAsync(innerFn, outerFn, self, tryLocsList, PromiseImpl) {
  var iter = (0, _regeneratorAsyncGen.default)(innerFn, outerFn, self, tryLocsList, PromiseImpl);
  return iter.next().then(function (result) {
    return result.done ? result.value : iter.next();
  });
}

//# sourceMappingURL=regeneratorAsync.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regeneratorKeys.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _regeneratorKeys;
function _regeneratorKeys(val) {
  var object = Object(val);
  var keys = [];
  var key;
  for (var key in object) {
    keys.unshift(key);
  }
  return function next() {
    while (keys.length) {
      key = keys.pop();
      if (key in object) {
        next.value = key;
        next.done = false;
        return next;
      }
    }
    next.done = true;
    return next;
  };
}

//# sourceMappingURL=regeneratorKeys.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/regeneratorAsyncIterator.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = AsyncIterator;
var _OverloadYield = require("./OverloadYield.js");
var _regeneratorDefine = require("./regeneratorDefine.js");
function AsyncIterator(generator, PromiseImpl) {
  if (!this.next) {
    (0, _regeneratorDefine.default)(AsyncIterator.prototype);
    (0, _regeneratorDefine.default)(AsyncIterator.prototype, typeof Symbol === "function" && Symbol.asyncIterator || "@asyncIterator", function () {
      return this;
    });
  }
  function invoke(method, arg, resolve, reject) {
    try {
      var result = generator[method](arg);
      var value = result.value;
      if (value instanceof _OverloadYield.default) {
        return PromiseImpl.resolve(value.v).then(function (value) {
          invoke("next", value, resolve, reject);
        }, function (err) {
          invoke("throw", err, resolve, reject);
        });
      }
      return PromiseImpl.resolve(value).then(function (unwrapped) {
        result.value = unwrapped;
        resolve(result);
      }, function (error) {
        return invoke("throw", error, resolve, reject);
      });
    } catch (error) {
      reject(error);
    }
  }
  var previousPromise;
  function enqueue(method, i, arg) {
    function callInvokeWithMethodAndArg() {
      return new PromiseImpl(function (resolve, reject) {
        invoke(method, arg, resolve, reject);
      });
    }
    return previousPromise = previousPromise ? previousPromise.then(callInvokeWithMethodAndArg, callInvokeWithMethodAndArg) : callInvokeWithMethodAndArg();
  }
  (0, _regeneratorDefine.default)(this, "_invoke", enqueue, true);
}

//# sourceMappingURL=regeneratorAsyncIterator.js.map

================================================================================
FILE: client/node_modules/@babel/helpers/lib/helpers/skipFirstGeneratorNext.js
================================================================================

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _skipFirstGeneratorNext;
function _skipFirstGeneratorNext(fn) {
  return function () {
    var it = fn.apply(this, arguments);
    it.next();
    return it;
  };
}

//# sourceMappingURL=skipFirstGeneratorNext.js.map

================================================================================
FILE: client/node_modules/lucide-react/dist/esm/icons/file-output.js
================================================================================

/**
 * @license lucide-react v0.378.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */

import createLucideIcon from '../createLucideIcon.js';

const FileOutput = createLucideIcon("FileOutput", [
  ["path", { d: "M14 2v4a2 2 0 0 0 2 2h4", key: "tnqrlb" }],
  ["path", { d: "M4 7V4a2 2 0 0 1 2-2 2 2 0 0 0-2 2", key: "1vk7w2" }],
  ["path", { d: "M4.063 20.999a2 2 0 0 0 2 1L18 22a2 2 0 0 0 2-2V7l-5-5H6", key: "1jink5" }],
  ["path", { d: "m5 11-3 3", key: "1dgrs4" }],
  ["path", { d: "m5 17-3-3h10", key: "1mvvaf" }]
]);

export { FileOutput as default };
//# sourceMappingURL=file-output.js.map

================================================================================
FILE: client/node_modules/lucide-react/dist/esm/icons/pen-tool.js
================================================================================

/**
 * @license lucide-react v0.378.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */

import createLucideIcon from '../createLucideIcon.js';

const PenTool = createLucideIcon("PenTool", [
  [
    "path",
    {
      d: "M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",
      key: "nt11vn"
    }
  ],
  [
    "path",
    {
      d: "m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",
      key: "15qc1e"
    }
  ],
  ["path", { d: "m2.3 2.3 7.286 7.286", key: "1wuzzi" }],
  ["circle", { cx: "11", cy: "11", r: "2", key: "xmgehs" }]
]);

export { PenTool as default };
//# sourceMappingURL=pen-tool.js.map

================================================================================
FILE: client/node_modules/lucide-react/dist/esm/icons/folder-output.js
================================================================================

/**
 * @license lucide-react v0.378.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */

import createLucideIcon from '../createLucideIcon.js';

const FolderOutput = createLucideIcon("FolderOutput", [
  [
    "path",
    {
      d: "M2 7.5V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-1.5",
      key: "1yk7aj"
    }
  ],
  ["path", { d: "M2 13h10", key: "pgb2dq" }],
  ["path", { d: "m5 10-3 3 3 3", key: "1r8ie0" }]
]);

export { FolderOutput as default };
//# sourceMappingURL=folder-output.js.map

================================================================================
FILE: client/node_modules/postcss-js/process-result.js
================================================================================

let objectify = require('./objectifier')

module.exports = function processResult(result) {
  if (console && console.warn) {
    result.warnings().forEach(warn => {
      let source = warn.plugin || 'PostCSS'
      console.warn(source + ': ' + warn.text)
    })
  }
  return objectify(result.root)
}

================================================================================
FILE: client/node_modules/caniuse-lite/data/features/es6-generators.js
================================================================================

module.exports={A:{A:{"2":"K D E F A B yC"},B:{"1":"0 1 2 3 4 5 6 7 8 L M G N O P Q H R S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z JB KB LB MB NB OB PB QB RB SB TB UB VB WB XB YB ZB I","2":"C"},C:{"1":"0 1 2 3 4 5 6 7 8 FB GB HB IB cB dB eB fB gB hB iB jB kB lB mB nB oB pB qB rB sB tB uB vB wB xB yB zB 0B 1B 2B 3B 4B VC 5B WC 6B 7B 8B 9B AC BC CC DC EC FC GC HC IC JC KC LC MC Q H R XC S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z JB KB LB MB NB OB PB QB RB SB TB UB VB WB XB YB ZB I YC ZC NC 0C 1C 2C","2":"9 zC UC J aB K D E F A B C L M G N O P bB AB BB CB DB EB 3C 4C"},D:{"1":"0 1 2 3 4 5 6 7 8 lB mB nB oB pB qB rB sB tB uB vB wB xB yB zB 0B 1B 2B 3B 4B VC 5B WC 6B 7B 8B 9B AC BC CC DC EC FC GC HC IC JC KC LC MC Q H R S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z JB KB LB MB NB OB PB QB RB SB TB UB VB WB XB YB ZB I YC ZC NC","2":"9 J aB K D E F A B C L M G N O P bB AB BB CB DB EB FB GB HB IB cB dB eB fB gB hB iB jB kB"},E:{"1":"A B C L M G bC OC PC AD BD CD cC dC QC DD RC eC fC gC hC iC ED SC jC kC lC mC nC FD TC oC pC qC rC GD sC tC uC vC HD","2":"J aB K D E F 5C aC 6C 7C 8C 9C"},F:{"1":"0 1 2 3 4 5 6 7 8 FB GB HB IB cB dB eB fB gB hB iB jB kB lB mB nB oB pB qB rB sB tB uB vB wB xB yB zB 0B 1B 2B 3B 4B 5B 6B 7B 8B 9B AC BC CC DC EC FC GC HC IC JC KC LC MC Q H R XC S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z","2":"9 F B C G N O P bB AB BB CB DB EB ID JD KD LD OC wC MD PC"},G:{"1":"UD VD WD XD YD ZD aD bD cD dD eD fD gD cC dC QC hD RC eC fC gC hC iC iD SC jC kC lC mC nC jD TC oC pC qC rC kD sC tC uC vC","2":"E aC ND xC OD PD QD RD SD TD"},H:{"2":"lD"},I:{"1":"I","2":"UC J mD nD oD pD xC qD rD"},J:{"2":"D A"},K:{"1":"H","2":"A B C OC wC PC"},L:{"1":"I"},M:{"1":"NC"},N:{"2":"A B"},O:{"1":"QC"},P:{"1":"9 J AB BB CB DB EB FB GB HB IB sD tD uD vD wD bC xD yD zD 0D 1D RC SC TC 2D"},Q:{"1":"3D"},R:{"1":"4D"},S:{"1":"5D 6D"}},B:6,C:"ES6 Generators",D:true};

================================================================================
FILE: client/node_modules/source-map-js/lib/source-map-generator.js
================================================================================

/* -*- Mode: js; js-indent-level: 2; -*- */
/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */

var base64VLQ = require('./base64-vlq');
var util = require('./util');
var ArraySet = require('./array-set').ArraySet;
var MappingList = require('./mapping-list').MappingList;

/**
 * An instance of the SourceMapGenerator represents a source map which is
 * being built incrementally. You may pass an object with the following
 * properties:
 *
 *   - file: The filename of the generated source.
 *   - sourceRoot: A root for all relative URLs in this source map.
 */
function SourceMapGenerator(aArgs) {
  if (!aArgs) {
    aArgs = {};
  }
  this._file = util.getArg(aArgs, 'file', null);
  this._sourceRoot = util.getArg(aArgs, 'sourceRoot', null);
  this._skipValidation = util.getArg(aArgs, 'skipValidation', false);
  this._ignoreInvalidMapping = util.getArg(aArgs, 'ignoreInvalidMapping', false);
  this._sources = new ArraySet();
  this._names = new ArraySet();
  this._mappings = new MappingList();
  this._sourcesContents = null;
}

SourceMapGenerator.prototype._version = 3;

/**
 * Creates a new SourceMapGenerator based on a SourceMapConsumer
 *
 * @param aSourceMapConsumer The SourceMap.
 */
SourceMapGenerator.fromSourceMap =
  function SourceMapGenerator_fromSourceMap(aSourceMapConsumer, generatorOps) {
    var sourceRoot = aSourceMapConsumer.sourceRoot;
    var generator = new SourceMapGenerator(Object.assign(generatorOps || {}, {
      file: aSourceMapConsumer.file,
      sourceRoot: sourceRoot
    }));
    aSourceMapConsumer.eachMapping(function (mapping) {
      var newMapping = {
        generated: {
          line: mapping.generatedLine,
          column: mapping.generatedColumn
        }
      };

      if (mapping.source != null) {
        newMapping.source = mapping.source;
        if (sourceRoot != null) {
          newMapping.source = util.relative(sourceRoot, newMapping.source);
        }

        newMapping.original = {
          line: mapping.originalLine,
          column: mapping.originalColumn
        };

        if (mapping.name != null) {
          newMapping.name = mapping.name;
        }
      }

      generator.addMapping(newMapping);
    });
    aSourceMapConsumer.sources.forEach(function (sourceFile) {
      var sourceRelative = sourceFile;
      if (sourceRoot !== null) {
        sourceRelative = util.relative(sourceRoot, sourceFile);
      }

      if (!generator._sources.has(sourceRelative)) {
        generator._sources.add(sourceRelative);
      }

      var content = aSourceMapConsumer.sourceContentFor(sourceFile);
      if (content != null) {
        generator.setSourceContent(sourceFile, content);
      }
    });
    return generator;
  };

/**
 * Add a single mapping from original source line and column to the generated
 * source's line and column for this source map being created. The mapping
 * object should have the following properties:
 *
 *   - generated: An object with the generated line and column positions.
 *   - original: An object with the original line and column positions.
 *   - source: The original source file (relative to the sourceRoot).
 *   - name: An optional original token name for this mapping.
 */
SourceMapGenerator.prototype.addMapping =
  function SourceMapGenerator_addMapping(aArgs) {
    var generated = util.getArg(aArgs, 'generated');
    var original = util.getArg(aArgs, 'original', null);
    var source = util.getArg(aArgs, 'source', null);
    var name = util.getArg(aArgs, 'name', null);

    if (!this._skipValidation) {
      if (this._validateMapping(generated, original, source, name) === false) {
        return;
      }
    }

    if (source != null) {
      source = String(source);
      if (!this._sources.has(source)) {
        this._sources.add(source);
      }
    }

    if (name != null) {
      name = String(name);
      if (!this._names.has(name)) {
        this._names.add(name);
      }
    }

    this._mappings.add({
      generatedLine: generated.line,
      generatedColumn: generated.column,
      originalLine: original != null && original.line,
      originalColumn: original != null && original.column,
      source: source,
      name: name
    });
  };

/**
 * Set the source content for a source file.
 */
SourceMapGenerator.prototype.setSourceContent =
  function SourceMapGenerator_setSourceContent(aSourceFile, aSourceContent) {
    var source = aSourceFile;
    if (this._sourceRoot != null) {
      source = util.relative(this._sourceRoot, source);
    }

    if (aSourceContent != null) {
      // Add the source content to the _sourcesContents map.
      // Create a new _sourcesContents map if the property is null.
      if (!this._sourcesContents) {
        this._sourcesContents = Object.create(null);
      }
      this._sourcesContents[util.toSetString(source)] = aSourceContent;
    } else if (this._sourcesContents) {
      // Remove the source file from the _sourcesContents map.
      // If the _sourcesContents map is empty, set the property to null.
      delete this._sourcesContents[util.toSetString(source)];
      if (Object.keys(this._sourcesContents).length === 0) {
        this._sourcesContents = null;
      }
    }
  };

/**
 * Applies the mappings of a sub-source-map for a specific source file to the
 * source map being generated. Each mapping to the supplied source file is
 * rewritten using the supplied source map. Note: The resolution for the
 * resulting mappings is the minimium of this map and the supplied map.
 *
 * @param aSourceMapConsumer The source map to be applied.
 * @param aSourceFile Optional. The filename of the source file.
 *        If omitted, SourceMapConsumer's file property will be used.
 * @param aSourceMapPath Optional. The dirname of the path to the source map
 *        to be applied. If relative, it is relative to the SourceMapConsumer.
 *        This parameter is needed when the two source maps aren't in the same
 *        directory, and the source map to be applied contains relative source
 *        paths. If so, those relative source paths need to be rewritten
 *        relative to the SourceMapGenerator.
 */
SourceMapGenerator.prototype.applySourceMap =
  function SourceMapGenerator_applySourceMap(aSourceMapConsumer, aSourceFile, aSourceMapPath) {
    var sourceFile = aSourceFile;
    // If aSourceFile is omitted, we will use the file property of the SourceMap
    if (aSourceFile == null) {
      if (aSourceMapConsumer.file == null) {
        throw new Error(
          'SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, ' +
          'or the source map\'s "file" property. Both were omitted.'
        );
      }
      sourceFile = aSourceMapConsumer.file;
    }
    var sourceRoot = this._sourceRoot;
    // Make "sourceFile" relative if an absolute Url is passed.
    if (sourceRoot != null) {
      sourceFile = util.relative(sourceRoot, sourceFile);
    }
    // Applying the SourceMap can add and remove items from the sources and
    // the names array.
    var newSources = new ArraySet();
    var newNames = new ArraySet();

    // Find mappings for the "sourceFile"
    this._mappings.unsortedForEach(function (mapping) {
      if (mapping.source === sourceFile && mapping.originalLine != null) {
        // Check if it can be mapped by the source map, then update the mapping.
        var original = aSourceMapConsumer.originalPositionFor({
          line: mapping.originalLine,
          column: mapping.originalColumn
        });
        if (original.source != null) {
          // Copy mapping
          mapping.source = original.source;
          if (aSourceMapPath != null) {
            mapping.source = util.join(aSourceMapPath, mapping.source)
          }
          if (sourceRoot != null) {
            mapping.source = util.relative(sourceRoot, mapping.source);
          }
          mapping.originalLine = original.line;
          mapping.originalColumn = original.column;
          if (original.name != null) {
            mapping.name = original.name;
          }
        }
      }

      var source = mapping.source;
      if (source != null && !newSources.has(source)) {
        newSources.add(source);
      }

      var name = mapping.name;
      if (name != null && !newNames.has(name)) {
        newNames.add(name);
      }

    }, this);
    this._sources = newSources;
    this._names = newNames;

    // Copy sourcesContents of applied map.
    aSourceMapConsumer.sources.forEach(function (sourceFile) {
      var content = aSourceMapConsumer.sourceContentFor(sourceFile);
      if (content != null) {
        if (aSourceMapPath != null) {
          sourceFile = util.join(aSourceMapPath, sourceFile);
        }
        if (sourceRoot != null) {
          sourceFile = util.relative(sourceRoot, sourceFile);
        }
        this.setSourceContent(sourceFile, content);
      }
    }, this);
  };

/**
 * A mapping can have one of the three levels of data:
 *
 *   1. Just the generated position.
 *   2. The Generated position, original position, and original source.
 *   3. Generated and original position, original source, as well as a name
 *      token.
 *
 * To maintain consistency, we validate that any new mapping being added falls
 * in to one of these categories.
 */
SourceMapGenerator.prototype._validateMapping =
  function SourceMapGenerator_validateMapping(aGenerated, aOriginal, aSource,
                                              aName) {
    // When aOriginal is truthy but has empty values for .line and .column,
    // it is most likely a programmer error. In this case we throw a very
    // specific error message to try to guide them the right way.
    // For example: https://github.com/Polymer/polymer-bundler/pull/519
    if (aOriginal && typeof aOriginal.line !== 'number' && typeof aOriginal.column !== 'number') {
      var message = 'original.line and original.column are not numbers -- you probably meant to omit ' +
      'the original mapping entirely and only map the generated position. If so, pass ' +
      'null for the original mapping instead of an object with empty or null values.'

      if (this._ignoreInvalidMapping) {
        if (typeof console !== 'undefined' && console.warn) {
          console.warn(message);
        }
        return false;
      } else {
        throw new Error(message);
      }
    }

    if (aGenerated && 'line' in aGenerated && 'column' in aGenerated
        && aGenerated.line > 0 && aGenerated.column >= 0
        && !aOriginal && !aSource && !aName) {
      // Case 1.
      return;
    }
    else if (aGenerated && 'line' in aGenerated && 'column' in aGenerated
             && aOriginal && 'line' in aOriginal && 'column' in aOriginal
             && aGenerated.line > 0 && aGenerated.column >= 0
             && aOriginal.line > 0 && aOriginal.column >= 0
             && aSource) {
      // Cases 2 and 3.
      return;
    }
    else {
      var message = 'Invalid mapping: ' + JSON.stringify({
        generated: aGenerated,
        source: aSource,
        original: aOriginal,
        name: aName
      });

      if (this._ignoreInvalidMapping) {
        if (typeof console !== 'undefined' && console.warn) {
          console.warn(message);
        }
        return false;
      } else {
        throw new Error(message)
      }
    }
  };

/**
 * Serialize the accumulated mappings in to the stream of base 64 VLQs
 * specified by the source map format.
 */
SourceMapGenerator.prototype._serializeMappings =
  function SourceMapGenerator_serializeMappings() {
    var previousGeneratedColumn = 0;
    var previousGeneratedLine = 1;
    var previousOriginalColumn = 0;
    var previousOriginalLine = 0;
    var previousName = 0;
    var previousSource = 0;
    var result = '';
    var next;
    var mapping;
    var nameIdx;
    var sourceIdx;

    var mappings = this._mappings.toArray();
    for (var i = 0, len = mappings.length; i < len; i++) {
      mapping = mappings[i];
      next = ''

      if (mapping.generatedLine !== previousGeneratedLine) {
        previousGeneratedColumn = 0;
        while (mapping.generatedLine !== previousGeneratedLine) {
          next += ';';
          previousGeneratedLine++;
        }
      }
      else {
        if (i > 0) {
          if (!util.compareByGeneratedPositionsInflated(mapping, mappings[i - 1])) {
            continue;
          }
          next += ',';
        }
      }

      next += base64VLQ.encode(mapping.generatedColumn
                                 - previousGeneratedColumn);
      previousGeneratedColumn = mapping.generatedColumn;

      if (mapping.source != null) {
        sourceIdx = this._sources.indexOf(mapping.source);
        next += base64VLQ.encode(sourceIdx - previousSource);
        previousSource = sourceIdx;

        // lines are stored 0-based in SourceMap spec version 3
        next += base64VLQ.encode(mapping.originalLine - 1
                                   - previousOriginalLine);
        previousOriginalLine = mapping.originalLine - 1;

        next += base64VLQ.encode(mapping.originalColumn
                                   - previousOriginalColumn);
        previousOriginalColumn = mapping.originalColumn;

        if (mapping.name != null) {
          nameIdx = this._names.indexOf(mapping.name);
          next += base64VLQ.encode(nameIdx - previousName);
          previousName = nameIdx;
        }
      }

      result += next;
    }

    return result;
  };

SourceMapGenerator.prototype._generateSourcesContent =
  function SourceMapGenerator_generateSourcesContent(aSources, aSourceRoot) {
    return aSources.map(function (source) {
      if (!this._sourcesContents) {
        return null;
      }
      if (aSourceRoot != null) {
        source = util.relative(aSourceRoot, source);
      }
      var key = util.toSetString(source);
      return Object.prototype.hasOwnProperty.call(this._sourcesContents, key)
        ? this._sourcesContents[key]
        : null;
    }, this);
  };

/**
 * Externalize the source map.
 */
SourceMapGenerator.prototype.toJSON =
  function SourceMapGenerator_toJSON() {
    var map = {
      version: this._version,
      sources: this._sources.toArray(),
      names: this._names.toArray(),
      mappings: this._serializeMappings()
    };
    if (this._file != null) {
      map.file = this._file;
    }
    if (this._sourceRoot != null) {
      map.sourceRoot = this._sourceRoot;
    }
    if (this._sourcesContents) {
      map.sourcesContent = this._generateSourcesContent(map.sources, map.sourceRoot);
    }

    return map;
  };

/**
 * Render the source map being generated to a string.
 */
SourceMapGenerator.prototype.toString =
  function SourceMapGenerator_toString() {
    return JSON.stringify(this.toJSON());
  };

exports.SourceMapGenerator = SourceMapGenerator;

================================================================================
FILE: client/node_modules/source-map-js/lib/source-map-generator.d.ts
================================================================================

export { SourceMapGenerator } from '..';

================================================================================
FILE: client/node_modules/postcss/lib/no-work-result.d.ts
================================================================================

import LazyResult from './lazy-result.js'
import { SourceMap } from './postcss.js'
import Processor from './processor.js'
import Result, { Message, ResultOptions } from './result.js'
import Root from './root.js'
import Warning from './warning.js'

declare namespace NoWorkResult {
  // eslint-disable-next-line @typescript-eslint/no-use-before-define
  export { NoWorkResult_ as default }
}

/**
 * A Promise proxy for the result of PostCSS transformations.
 * This lazy result instance doesn't parse css unless `NoWorkResult#root` or `Result#root`
 * are accessed. See the example below for details.
 * A `NoWork` instance is returned by `Processor#process` ONLY when no plugins defined.
 *
 * ```js
 * const noWorkResult = postcss().process(css) // No plugins are defined.
 *                                             // CSS is not parsed
 * let root = noWorkResult.root // now css is parsed because we accessed the root
 * ```
 */
declare class NoWorkResult_ implements LazyResult<Root> {
  catch: Promise<Result<Root>>['catch']
  finally: Promise<Result<Root>>['finally']
  then: Promise<Result<Root>>['then']
  get content(): string
  get css(): string
  get map(): SourceMap
  get messages(): Message[]
  get opts(): ResultOptions
  get processor(): Processor
  get root(): Root
  get [Symbol.toStringTag](): string
  constructor(processor: Processor, css: string, opts: ResultOptions)
  async(): Promise<Result<Root>>
  sync(): Result<Root>
  toString(): string
  warnings(): Warning[]
}

declare class NoWorkResult extends NoWorkResult_ {}

export = NoWorkResult

================================================================================
FILE: client/node_modules/postcss/lib/result.d.ts
================================================================================

import {
  Document,
  Node,
  Plugin,
  ProcessOptions,
  Root,
  SourceMap,
  TransformCallback,
  Warning,
  WarningOptions
} from './postcss.js'
import Processor from './processor.js'

declare namespace Result {
  export interface Message {
    [others: string]: any

    /**
     * Source PostCSS plugin name.
     */
    plugin?: string

    /**
     * Message type.
     */
    type: string
  }

  export interface ResultOptions extends ProcessOptions {
    /**
     * The CSS node that was the source of the warning.
     */
    node?: Node

    /**
     * Name of plugin that created this warning. `Result#warn` will fill it
     * automatically with `Plugin#postcssPlugin` value.
     */
    plugin?: string
  }

  // eslint-disable-next-line @typescript-eslint/no-use-before-define
  export { Result_ as default }
}

/**
 * Provides the result of the PostCSS transformations.
 *
 * A Result instance is returned by `LazyResult#then`
 * or `Root#toResult` methods.
 *
 * ```js
 * postcss([autoprefixer]).process(css).then(result => {
 *  console.log(result.css)
 * })
 * ```
 *
 * ```js
 * const result2 = postcss.parse(css).toResult()
 * ```
 */
declare class Result_<RootNode = Document | Root> {
  /**
   * A CSS string representing of `Result#root`.
   *
   * ```js
   * postcss.parse('a{}').toResult().css //=> "a{}"
   * ```
   */
  css: string

  /**
   * Last runned PostCSS plugin.
   */
  lastPlugin: Plugin | TransformCallback

  /**
   * An instance of `SourceMapGenerator` class from the `source-map` library,
   * representing changes to the `Result#root` instance.
   *
   * ```js
   * result.map.toJSON() //=> { version: 3, file: 'a.css', â€¦ }
   * ```
   *
   * ```js
   * if (result.map) {
   *   fs.writeFileSync(result.opts.to + '.map', result.map.toString())
   * }
   * ```
   */
  map: SourceMap

  /**
   * Contains messages from plugins (e.g., warnings or custom messages).
   * Each message should have type and plugin properties.
   *
   * ```js
   * AtRule: {
   *   import: (atRule, { result }) {
   *     const importedFile = parseImport(atRule)
   *     result.messages.push({
   *       type: 'dependency',
   *       plugin: 'postcss-import',
   *       file: importedFile,
   *       parent: result.opts.from
   *     })
   *   }
   * }
   * ```
   */
  messages: Result.Message[]

  /**
   * Options from the `Processor#process` or `Root#toResult` call
   * that produced this Result instance.]
   *
   * ```js
   * root.toResult(opts).opts === opts
   * ```
   */
  opts: Result.ResultOptions

  /**
   * The Processor instance used for this transformation.
   *
   * ```js
   * for (const plugin of result.processor.plugins) {
   *   if (plugin.postcssPlugin === 'postcss-bad') {
   *     throw 'postcss-good is incompatible with postcss-bad'
   *   }
   * })
   * ```
   */
  processor: Processor

  /**
   * Root node after all transformations.
   *
   * ```js
   * root.toResult().root === root
   * ```
   */
  root: RootNode

  /**
   * An alias for the `Result#css` property.
   * Use it with syntaxes that generate non-CSS output.
   *
   * ```js
   * result.css === result.content
   * ```
   */
  get content(): string

  /**
   * @param processor Processor used for this transformation.
   * @param root      Root node after all transformations.
   * @param opts      Options from the `Processor#process` or `Root#toResult`.
   */
  constructor(processor: Processor, root: RootNode, opts: Result.ResultOptions)

  /**
   * Returns for `Result#css` content.
   *
   * ```js
   * result + '' === result.css
   * ```
   *
   * @return String representing of `Result#root`.
   */
  toString(): string

  /**
   * Creates an instance of `Warning` and adds it to `Result#messages`.
   *
   * ```js
   * if (decl.important) {
   *   result.warn('Avoid !important', { node: decl, word: '!important' })
   * }
   * ```
   *
   * @param text Warning message.
   * @param opts Warning options.
   * @return Created warning.
   */
  warn(message: string, options?: WarningOptions): Warning

  /**
   * Returns warnings from plugins. Filters `Warning` instances
   * from `Result#messages`.
   *
   * ```js
   * result.warnings().forEach(warn => {
   *   console.warn(warn.toString())
   * })
   * ```
   *
   * @return Warnings from plugins.
   */
  warnings(): Warning[]
}

declare class Result<RootNode = Document | Root> extends Result_<RootNode> {}

export = Result

================================================================================
FILE: client/node_modules/postcss/lib/lazy-result.js
================================================================================

'use strict'

let Container = require('./container')
let Document = require('./document')
let MapGenerator = require('./map-generator')
let parse = require('./parse')
let Result = require('./result')
let Root = require('./root')
let stringify = require('./stringify')
let { isClean, my } = require('./symbols')
let warnOnce = require('./warn-once')

const TYPE_TO_CLASS_NAME = {
  atrule: 'AtRule',
  comment: 'Comment',
  decl: 'Declaration',
  document: 'Document',
  root: 'Root',
  rule: 'Rule'
}

const PLUGIN_PROPS = {
  AtRule: true,
  AtRuleExit: true,
  Comment: true,
  CommentExit: true,
  Declaration: true,
  DeclarationExit: true,
  Document: true,
  DocumentExit: true,
  Once: true,
  OnceExit: true,
  postcssPlugin: true,
  prepare: true,
  Root: true,
  RootExit: true,
  Rule: true,
  RuleExit: true
}

const NOT_VISITORS = {
  Once: true,
  postcssPlugin: true,
  prepare: true
}

const CHILDREN = 0

function isPromise(obj) {
  return typeof obj === 'object' && typeof obj.then === 'function'
}

function getEvents(node) {
  let key = false
  let type = TYPE_TO_CLASS_NAME[node.type]
  if (node.type === 'decl') {
    key = node.prop.toLowerCase()
  } else if (node.type === 'atrule') {
    key = node.name.toLowerCase()
  }

  if (key && node.append) {
    return [
      type,
      type + '-' + key,
      CHILDREN,
      type + 'Exit',
      type + 'Exit-' + key
    ]
  } else if (key) {
    return [type, type + '-' + key, type + 'Exit', type + 'Exit-' + key]
  } else if (node.append) {
    return [type, CHILDREN, type + 'Exit']
  } else {
    return [type, type + 'Exit']
  }
}

function toStack(node) {
  let events
  if (node.type === 'document') {
    events = ['Document', CHILDREN, 'DocumentExit']
  } else if (node.type === 'root') {
    events = ['Root', CHILDREN, 'RootExit']
  } else {
    events = getEvents(node)
  }

  return {
    eventIndex: 0,
    events,
    iterator: 0,
    node,
    visitorIndex: 0,
    visitors: []
  }
}

function cleanMarks(node) {
  node[isClean] = false
  if (node.nodes) node.nodes.forEach(i => cleanMarks(i))
  return node
}

let postcss = {}

class LazyResult {
  get content() {
    return this.stringify().content
  }

  get css() {
    return this.stringify().css
  }

  get map() {
    return this.stringify().map
  }

  get messages() {
    return this.sync().messages
  }

  get opts() {
    return this.result.opts
  }

  get processor() {
    return this.result.processor
  }

  get root() {
    return this.sync().root
  }

  get [Symbol.toStringTag]() {
    return 'LazyResult'
  }

  constructor(processor, css, opts) {
    this.stringified = false
    this.processed = false

    let root
    if (
      typeof css === 'object' &&
      css !== null &&
      (css.type === 'root' || css.type === 'document')
    ) {
      root = cleanMarks(css)
    } else if (css instanceof LazyResult || css instanceof Result) {
      root = cleanMarks(css.root)
      if (css.map) {
        if (typeof opts.map === 'undefined') opts.map = {}
        if (!opts.map.inline) opts.map.inline = false
        opts.map.prev = css.map
      }
    } else {
      let parser = parse
      if (opts.syntax) parser = opts.syntax.parse
      if (opts.parser) parser = opts.parser
      if (parser.parse) parser = parser.parse

      try {
        root = parser(css, opts)
      } catch (error) {
        this.processed = true
        this.error = error
      }

      if (root && !root[my]) {
        /* c8 ignore next 2 */
        Container.rebuild(root)
      }
    }

    this.result = new Result(processor, root, opts)
    this.helpers = { ...postcss, postcss, result: this.result }
    this.plugins = this.processor.plugins.map(plugin => {
      if (typeof plugin === 'object' && plugin.prepare) {
        return { ...plugin, ...plugin.prepare(this.result) }
      } else {
        return plugin
      }
    })
  }

  async() {
    if (this.error) return Promise.reject(this.error)
    if (this.processed) return Promise.resolve(this.result)
    if (!this.processing) {
      this.processing = this.runAsync()
    }
    return this.processing
  }

  catch(onRejected) {
    return this.async().catch(onRejected)
  }

  finally(onFinally) {
    return this.async().then(onFinally, onFinally)
  }

  getAsyncError() {
    throw new Error('Use process(css).then(cb) to work with async plugins')
  }

  handleError(error, node) {
    let plugin = this.result.lastPlugin
    try {
      if (node) node.addToError(error)
      this.error = error
      if (error.name === 'CssSyntaxError' && !error.plugin) {
        error.plugin = plugin.postcssPlugin
        error.setMessage()
      } else if (plugin.postcssVersion) {
        if (process.env.NODE_ENV !== 'production') {
          let pluginName = plugin.postcssPlugin
          let pluginVer = plugin.postcssVersion
          let runtimeVer = this.result.processor.version
          let a = pluginVer.split('.')
          let b = runtimeVer.split('.')

          if (a[0] !== b[0] || parseInt(a[1]) > parseInt(b[1])) {
            // eslint-disable-next-line no-console
            console.error(
              'Unknown error from PostCSS plugin. Your current PostCSS ' +
                'version is ' +
                runtimeVer +
                ', but ' +
                pluginName +
                ' uses ' +
                pluginVer +
                '. Perhaps this is the source of the error below.'
            )
          }
        }
      }
    } catch (err) {
      /* c8 ignore next 3 */
      // eslint-disable-next-line no-console
      if (console && console.error) console.error(err)
    }
    return error
  }

  prepareVisitors() {
    this.listeners = {}
    let add = (plugin, type, cb) => {
      if (!this.listeners[type]) this.listeners[type] = []
      this.listeners[type].push([plugin, cb])
    }
    for (let plugin of this.plugins) {
      if (typeof plugin === 'object') {
        for (let event in plugin) {
          if (!PLUGIN_PROPS[event] && /^[A-Z]/.test(event)) {
            throw new Error(
              `Unknown event ${event} in ${plugin.postcssPlugin}. ` +
                `Try to update PostCSS (${this.processor.version} now).`
            )
          }
          if (!NOT_VISITORS[event]) {
            if (typeof plugin[event] === 'object') {
              for (let filter in plugin[event]) {
                if (filter === '*') {
                  add(plugin, event, plugin[event][filter])
                } else {
                  add(
                    plugin,
                    event + '-' + filter.toLowerCase(),
                    plugin[event][filter]
                  )
                }
              }
            } else if (typeof plugin[event] === 'function') {
              add(plugin, event, plugin[event])
            }
          }
        }
      }
    }
    this.hasListener = Object.keys(this.listeners).length > 0
  }

  async runAsync() {
    this.plugin = 0
    for (let i = 0; i < this.plugins.length; i++) {
      let plugin = this.plugins[i]
      let promise = this.runOnRoot(plugin)
      if (isPromise(promise)) {
        try {
          await promise
        } catch (error) {
          throw this.handleError(error)
        }
      }
    }

    this.prepareVisitors()
    if (this.hasListener) {
      let root = this.result.root
      while (!root[isClean]) {
        root[isClean] = true
        let stack = [toStack(root)]
        while (stack.length > 0) {
          let promise = this.visitTick(stack)
          if (isPromise(promise)) {
            try {
              await promise
            } catch (e) {
              let node = stack[stack.length - 1].node
              throw this.handleError(e, node)
            }
          }
        }
      }

      if (this.listeners.OnceExit) {
        for (let [plugin, visitor] of this.listeners.OnceExit) {
          this.result.lastPlugin = plugin
          try {
            if (root.type === 'document') {
              let roots = root.nodes.map(subRoot =>
                visitor(subRoot, this.helpers)
              )

              await Promise.all(roots)
            } else {
              await visitor(root, this.helpers)
            }
          } catch (e) {
            throw this.handleError(e)
          }
        }
      }
    }

    this.processed = true
    return this.stringify()
  }

  runOnRoot(plugin) {
    this.result.lastPlugin = plugin
    try {
      if (typeof plugin === 'object' && plugin.Once) {
        if (this.result.root.type === 'document') {
          let roots = this.result.root.nodes.map(root =>
            plugin.Once(root, this.helpers)
          )

          if (isPromise(roots[0])) {
            return Promise.all(roots)
          }

          return roots
        }

        return plugin.Once(this.result.root, this.helpers)
      } else if (typeof plugin === 'function') {
        return plugin(this.result.root, this.result)
      }
    } catch (error) {
      throw this.handleError(error)
    }
  }

  stringify() {
    if (this.error) throw this.error
    if (this.stringified) return this.result
    this.stringified = true

    this.sync()

    let opts = this.result.opts
    let str = stringify
    if (opts.syntax) str = opts.syntax.stringify
    if (opts.stringifier) str = opts.stringifier
    if (str.stringify) str = str.stringify

    let map = new MapGenerator(str, this.result.root, this.result.opts)
    let data = map.generate()
    this.result.css = data[0]
    this.result.map = data[1]

    return this.result
  }

  sync() {
    if (this.error) throw this.error
    if (this.processed) return this.result
    this.processed = true

    if (this.processing) {
      throw this.getAsyncError()
    }

    for (let plugin of this.plugins) {
      let promise = this.runOnRoot(plugin)
      if (isPromise(promise)) {
        throw this.getAsyncError()
      }
    }

    this.prepareVisitors()
    if (this.hasListener) {
      let root = this.result.root
      while (!root[isClean]) {
        root[isClean] = true
        this.walkSync(root)
      }
      if (this.listeners.OnceExit) {
        if (root.type === 'document') {
          for (let subRoot of root.nodes) {
            this.visitSync(this.listeners.OnceExit, subRoot)
          }
        } else {
          this.visitSync(this.listeners.OnceExit, root)
        }
      }
    }

    return this.result
  }

  then(onFulfilled, onRejected) {
    if (process.env.NODE_ENV !== 'production') {
      if (!('from' in this.opts)) {
        warnOnce(
          'Without `from` option PostCSS could generate wrong source map ' +
            'and will not find Browserslist config. Set it to CSS file path ' +
            'or to `undefined` to prevent this warning.'
        )
      }
    }
    return this.async().then(onFulfilled, onRejected)
  }

  toString() {
    return this.css
  }

  visitSync(visitors, node) {
    for (let [plugin, visitor] of visitors) {
      this.result.lastPlugin = plugin
      let promise
      try {
        promise = visitor(node, this.helpers)
      } catch (e) {
        throw this.handleError(e, node.proxyOf)
      }
      if (node.type !== 'root' && node.type !== 'document' && !node.parent) {
        return true
      }
      if (isPromise(promise)) {
        throw this.getAsyncError()
      }
    }
  }

  visitTick(stack) {
    let visit = stack[stack.length - 1]
    let { node, visitors } = visit

    if (node.type !== 'root' && node.type !== 'document' && !node.parent) {
      stack.pop()
      return
    }

    if (visitors.length > 0 && visit.visitorIndex < visitors.length) {
      let [plugin, visitor] = visitors[visit.visitorIndex]
      visit.visitorIndex += 1
      if (visit.visitorIndex === visitors.length) {
        visit.visitors = []
        visit.visitorIndex = 0
      }
      this.result.lastPlugin = plugin
      try {
        return visitor(node.toProxy(), this.helpers)
      } catch (e) {
        throw this.handleError(e, node)
      }
    }

    if (visit.iterator !== 0) {
      let iterator = visit.iterator
      let child
      while ((child = node.nodes[node.indexes[iterator]])) {
        node.indexes[iterator] += 1
        if (!child[isClean]) {
          child[isClean] = true
          stack.push(toStack(child))
          return
        }
      }
      visit.iterator = 0
      delete node.indexes[iterator]
    }

    let events = visit.events
    while (visit.eventIndex < events.length) {
      let event = events[visit.eventIndex]
      visit.eventIndex += 1
      if (event === CHILDREN) {
        if (node.nodes && node.nodes.length) {
          node[isClean] = true
          visit.iterator = node.getIterator()
        }
        return
      } else if (this.listeners[event]) {
        visit.visitors = this.listeners[event]
        return
      }
    }
    stack.pop()
  }

  walkSync(node) {
    node[isClean] = true
    let events = getEvents(node)
    for (let event of events) {
      if (event === CHILDREN) {
        if (node.nodes) {
          node.each(child => {
            if (!child[isClean]) this.walkSync(child)
          })
        }
      } else {
        let visitors = this.listeners[event]
        if (visitors) {
          if (this.visitSync(visitors, node.toProxy())) return
        }
      }
    }
  }

  warnings() {
    return this.sync().warnings()
  }
}

LazyResult.registerPostcss = dependant => {
  postcss = dependant
}

module.exports = LazyResult
LazyResult.default = LazyResult

Root.registerLazyResult(LazyResult)
Document.registerLazyResult(LazyResult)

================================================================================
FILE: client/node_modules/postcss/lib/result.js
================================================================================

'use strict'

let Warning = require('./warning')

class Result {
  get content() {
    return this.css
  }

  constructor(processor, root, opts) {
    this.processor = processor
    this.messages = []
    this.root = root
    this.opts = opts
    this.css = ''
    this.map = undefined
  }

  toString() {
    return this.css
  }

  warn(text, opts = {}) {
    if (!opts.plugin) {
      if (this.lastPlugin && this.lastPlugin.postcssPlugin) {
        opts.plugin = this.lastPlugin.postcssPlugin
      }
    }

    let warning = new Warning(text, opts)
    this.messages.push(warning)

    return warning
  }

  warnings() {
    return this.messages.filter(i => i.type === 'warning')
  }
}

module.exports = Result
Result.default = Result

================================================================================
FILE: client/node_modules/postcss/lib/no-work-result.js
================================================================================

'use strict'

let MapGenerator = require('./map-generator')
let parse = require('./parse')
const Result = require('./result')
let stringify = require('./stringify')
let warnOnce = require('./warn-once')

class NoWorkResult {
  get content() {
    return this.result.css
  }

  get css() {
    return this.result.css
  }

  get map() {
    return this.result.map
  }

  get messages() {
    return []
  }

  get opts() {
    return this.result.opts
  }

  get processor() {
    return this.result.processor
  }

  get root() {
    if (this._root) {
      return this._root
    }

    let root
    let parser = parse

    try {
      root = parser(this._css, this._opts)
    } catch (error) {
      this.error = error
    }

    if (this.error) {
      throw this.error
    } else {
      this._root = root
      return root
    }
  }

  get [Symbol.toStringTag]() {
    return 'NoWorkResult'
  }

  constructor(processor, css, opts) {
    css = css.toString()
    this.stringified = false

    this._processor = processor
    this._css = css
    this._opts = opts
    this._map = undefined
    let root

    let str = stringify
    this.result = new Result(this._processor, root, this._opts)
    this.result.css = css

    let self = this
    Object.defineProperty(this.result, 'root', {
      get() {
        return self.root
      }
    })

    let map = new MapGenerator(str, root, this._opts, css)
    if (map.isMap()) {
      let [generatedCSS, generatedMap] = map.generate()
      if (generatedCSS) {
        this.result.css = generatedCSS
      }
      if (generatedMap) {
        this.result.map = generatedMap
      }
    } else {
      map.clearAnnotation()
      this.result.css = map.css
    }
  }

  async() {
    if (this.error) return Promise.reject(this.error)
    return Promise.resolve(this.result)
  }

  catch(onRejected) {
    return this.async().catch(onRejected)
  }

  finally(onFinally) {
    return this.async().then(onFinally, onFinally)
  }

  sync() {
    if (this.error) throw this.error
    return this.result
  }

  then(onFulfilled, onRejected) {
    if (process.env.NODE_ENV !== 'production') {
      if (!('from' in this._opts)) {
        warnOnce(
          'Without `from` option PostCSS could generate wrong source map ' +
            'and will not find Browserslist config. Set it to CSS file path ' +
            'or to `undefined` to prevent this warning.'
        )
      }
    }

    return this.async().then(onFulfilled, onRejected)
  }

  toString() {
    return this._css
  }

  warnings() {
    return []
  }
}

module.exports = NoWorkResult
NoWorkResult.default = NoWorkResult

================================================================================
FILE: client/node_modules/postcss/lib/lazy-result.d.ts
================================================================================

import Document from './document.js'
import { SourceMap } from './postcss.js'
import Processor from './processor.js'
import Result, { Message, ResultOptions } from './result.js'
import Root from './root.js'
import Warning from './warning.js'

declare namespace LazyResult {
  // eslint-disable-next-line @typescript-eslint/no-use-before-define
  export { LazyResult_ as default }
}

/**
 * A Promise proxy for the result of PostCSS transformations.
 *
 * A `LazyResult` instance is returned by `Processor#process`.
 *
 * ```js
 * const lazy = postcss([autoprefixer]).process(css)
 * ```
 */
declare class LazyResult_<RootNode = Document | Root>
  implements PromiseLike<Result<RootNode>>
{
  /**
   * Processes input CSS through synchronous and asynchronous plugins
   * and calls onRejected for each error thrown in any plugin.
   *
   * It implements standard Promise API.
   *
   * ```js
   * postcss([autoprefixer]).process(css).then(result => {
   *   console.log(result.css)
   * }).catch(error => {
   *   console.error(error)
   * })
   * ```
   */
  catch: Promise<Result<RootNode>>['catch']

  /**
   * Processes input CSS through synchronous and asynchronous plugins
   * and calls onFinally on any error or when all plugins will finish work.
   *
   * It implements standard Promise API.
   *
   * ```js
   * postcss([autoprefixer]).process(css).finally(() => {
   *   console.log('processing ended')
   * })
   * ```
   */
  finally: Promise<Result<RootNode>>['finally']

  /**
   * Processes input CSS through synchronous and asynchronous plugins
   * and calls `onFulfilled` with a Result instance. If a plugin throws
   * an error, the `onRejected` callback will be executed.
   *
   * It implements standard Promise API.
   *
   * ```js
   * postcss([autoprefixer]).process(css, { from: cssPath }).then(result => {
   *   console.log(result.css)
   * })
   * ```
   */
  then: Promise<Result<RootNode>>['then']

  /**
   * An alias for the `css` property. Use it with syntaxes
   * that generate non-CSS output.
   *
   * This property will only work with synchronous plugins.
   * If the processor contains any asynchronous plugins
   * it will throw an error.
   *
   * PostCSS runners should always use `LazyResult#then`.
   */
  get content(): string

  /**
   * Processes input CSS through synchronous plugins, converts `Root`
   * to a CSS string and returns `Result#css`.
   *
   * This property will only work with synchronous plugins.
   * If the processor contains any asynchronous plugins
   * it will throw an error.
   *
   * PostCSS runners should always use `LazyResult#then`.
   */
  get css(): string

  /**
   * Processes input CSS through synchronous plugins
   * and returns `Result#map`.
   *
   * This property will only work with synchronous plugins.
   * If the processor contains any asynchronous plugins
   * it will throw an error.
   *
   * PostCSS runners should always use `LazyResult#then`.
   */
  get map(): SourceMap

  /**
   * Processes input CSS through synchronous plugins
   * and returns `Result#messages`.
   *
   * This property will only work with synchronous plugins. If the processor
   * contains any asynchronous plugins it will throw an error.
   *
   * PostCSS runners should always use `LazyResult#then`.
   */
  get messages(): Message[]

  /**
   * Options from the `Processor#process` call.
   */
  get opts(): ResultOptions

  /**
   * Returns a `Processor` instance, which will be used
   * for CSS transformations.
   */
  get processor(): Processor

  /**
   * Processes input CSS through synchronous plugins
   * and returns `Result#root`.
   *
   * This property will only work with synchronous plugins. If the processor
   * contains any asynchronous plugins it will throw an error.
   *
   * PostCSS runners should always use `LazyResult#then`.
   */
  get root(): RootNode

  /**
   * Returns the default string description of an object.
   * Required to implement the Promise interface.
   */
  get [Symbol.toStringTag](): string

  /**
   * @param processor Processor used for this transformation.
   * @param css       CSS to parse and transform.
   * @param opts      Options from the `Processor#process` or `Root#toResult`.
   */
  constructor(processor: Processor, css: string, opts: ResultOptions)

  /**
   * Run plugin in async way and return `Result`.
   *
   * @return Result with output content.
   */
  async(): Promise<Result<RootNode>>

  /**
   * Run plugin in sync way and return `Result`.
   *
   * @return Result with output content.
   */
  sync(): Result<RootNode>

  /**
   * Alias for the `LazyResult#css` property.
   *
   * ```js
   * lazy + '' === lazy.css
   * ```
   *
   * @return Output CSS.
   */
  toString(): string

  /**
   * Processes input CSS through synchronous plugins
   * and calls `Result#warnings`.
   *
   * @return Warnings from plugins.
   */
  warnings(): Warning[]
}

declare class LazyResult<
  RootNode = Document | Root
> extends LazyResult_<RootNode> {}

export = LazyResult

================================================================================
FILE: client/node_modules/postcss/lib/map-generator.js
================================================================================

'use strict'

let { dirname, relative, resolve, sep } = require('path')
let { SourceMapConsumer, SourceMapGenerator } = require('source-map-js')
let { pathToFileURL } = require('url')

let Input = require('./input')

let sourceMapAvailable = Boolean(SourceMapConsumer && SourceMapGenerator)
let pathAvailable = Boolean(dirname && resolve && relative && sep)

class MapGenerator {
  constructor(stringify, root, opts, cssString) {
    this.stringify = stringify
    this.mapOpts = opts.map || {}
    this.root = root
    this.opts = opts
    this.css = cssString
    this.originalCSS = cssString
    this.usesFileUrls = !this.mapOpts.from && this.mapOpts.absolute

    this.memoizedFileURLs = new Map()
    this.memoizedPaths = new Map()
    this.memoizedURLs = new Map()
  }

  addAnnotation() {
    let content

    if (this.isInline()) {
      content =
        'data:application/json;base64,' + this.toBase64(this.map.toString())
    } else if (typeof this.mapOpts.annotation === 'string') {
      content = this.mapOpts.annotation
    } else if (typeof this.mapOpts.annotation === 'function') {
      content = this.mapOpts.annotation(this.opts.to, this.root)
    } else {
      content = this.outputFile() + '.map'
    }
    let eol = '\n'
    if (this.css.includes('\r\n')) eol = '\r\n'

    this.css += eol + '/*# sourceMappingURL=' + content + ' */'
  }

  applyPrevMaps() {
    for (let prev of this.previous()) {
      let from = this.toUrl(this.path(prev.file))
      let root = prev.root || dirname(prev.file)
      let map

      if (this.mapOpts.sourcesContent === false) {
        map = new SourceMapConsumer(prev.text)
        if (map.sourcesContent) {
          map.sourcesContent = null
        }
      } else {
        map = prev.consumer()
      }

      this.map.applySourceMap(map, from, this.toUrl(this.path(root)))
    }
  }

  clearAnnotation() {
    if (this.mapOpts.annotation === false) return

    if (this.root) {
      let node
      for (let i = this.root.nodes.length - 1; i >= 0; i--) {
        node = this.root.nodes[i]
        if (node.type !== 'comment') continue
        if (node.text.startsWith('# sourceMappingURL=')) {
          this.root.removeChild(i)
        }
      }
    } else if (this.css) {
      this.css = this.css.replace(/\n*\/\*#[\S\s]*?\*\/$/gm, '')
    }
  }

  generate() {
    this.clearAnnotation()
    if (pathAvailable && sourceMapAvailable && this.isMap()) {
      return this.generateMap()
    } else {
      let result = ''
      this.stringify(this.root, i => {
        result += i
      })
      return [result]
    }
  }

  generateMap() {
    if (this.root) {
      this.generateString()
    } else if (this.previous().length === 1) {
      let prev = this.previous()[0].consumer()
      prev.file = this.outputFile()
      this.map = SourceMapGenerator.fromSourceMap(prev, {
        ignoreInvalidMapping: true
      })
    } else {
      this.map = new SourceMapGenerator({
        file: this.outputFile(),
        ignoreInvalidMapping: true
      })
      this.map.addMapping({
        generated: { column: 0, line: 1 },
        original: { column: 0, line: 1 },
        source: this.opts.from
          ? this.toUrl(this.path(this.opts.from))
          : '<no source>'
      })
    }

    if (this.isSourcesContent()) this.setSourcesContent()
    if (this.root && this.previous().length > 0) this.applyPrevMaps()
    if (this.isAnnotation()) this.addAnnotation()

    if (this.isInline()) {
      return [this.css]
    } else {
      return [this.css, this.map]
    }
  }

  generateString() {
    this.css = ''
    this.map = new SourceMapGenerator({
      file: this.outputFile(),
      ignoreInvalidMapping: true
    })

    let line = 1
    let column = 1

    let noSource = '<no source>'
    let mapping = {
      generated: { column: 0, line: 0 },
      original: { column: 0, line: 0 },
      source: ''
    }

    let last, lines
    this.stringify(this.root, (str, node, type) => {
      this.css += str

      if (node && type !== 'end') {
        mapping.generated.line = line
        mapping.generated.column = column - 1
        if (node.source && node.source.start) {
          mapping.source = this.sourcePath(node)
          mapping.original.line = node.source.start.line
          mapping.original.column = node.source.start.column - 1
          this.map.addMapping(mapping)
        } else {
          mapping.source = noSource
          mapping.original.line = 1
          mapping.original.column = 0
          this.map.addMapping(mapping)
        }
      }

      lines = str.match(/\n/g)
      if (lines) {
        line += lines.length
        last = str.lastIndexOf('\n')
        column = str.length - last
      } else {
        column += str.length
      }

      if (node && type !== 'start') {
        let p = node.parent || { raws: {} }
        let childless =
          node.type === 'decl' || (node.type === 'atrule' && !node.nodes)
        if (!childless || node !== p.last || p.raws.semicolon) {
          if (node.source && node.source.end) {
            mapping.source = this.sourcePath(node)
            mapping.original.line = node.source.end.line
            mapping.original.column = node.source.end.column - 1
            mapping.generated.line = line
            mapping.generated.column = column - 2
            this.map.addMapping(mapping)
          } else {
            mapping.source = noSource
            mapping.original.line = 1
            mapping.original.column = 0
            mapping.generated.line = line
            mapping.generated.column = column - 1
            this.map.addMapping(mapping)
          }
        }
      }
    })
  }

  isAnnotation() {
    if (this.isInline()) {
      return true
    }
    if (typeof this.mapOpts.annotation !== 'undefined') {
      return this.mapOpts.annotation
    }
    if (this.previous().length) {
      return this.previous().some(i => i.annotation)
    }
    return true
  }

  isInline() {
    if (typeof this.mapOpts.inline !== 'undefined') {
      return this.mapOpts.inline
    }

    let annotation = this.mapOpts.annotation
    if (typeof annotation !== 'undefined' && annotation !== true) {
      return false
    }

    if (this.previous().length) {
      return this.previous().some(i => i.inline)
    }
    return true
  }

  isMap() {
    if (typeof this.opts.map !== 'undefined') {
      return !!this.opts.map
    }
    return this.previous().length > 0
  }

  isSourcesContent() {
    if (typeof this.mapOpts.sourcesContent !== 'undefined') {
      return this.mapOpts.sourcesContent
    }
    if (this.previous().length) {
      return this.previous().some(i => i.withContent())
    }
    return true
  }

  outputFile() {
    if (this.opts.to) {
      return this.path(this.opts.to)
    } else if (this.opts.from) {
      return this.path(this.opts.from)
    } else {
      return 'to.css'
    }
  }

  path(file) {
    if (this.mapOpts.absolute) return file
    if (file.charCodeAt(0) === 60 /* `<` */) return file
    if (/^\w+:\/\//.test(file)) return file
    let cached = this.memoizedPaths.get(file)
    if (cached) return cached

    let from = this.opts.to ? dirname(this.opts.to) : '.'

    if (typeof this.mapOpts.annotation === 'string') {
      from = dirname(resolve(from, this.mapOpts.annotation))
    }

    let path = relative(from, file)
    this.memoizedPaths.set(file, path)

    return path
  }

  previous() {
    if (!this.previousMaps) {
      this.previousMaps = []
      if (this.root) {
        this.root.walk(node => {
          if (node.source && node.source.input.map) {
            let map = node.source.input.map
            if (!this.previousMaps.includes(map)) {
              this.previousMaps.push(map)
            }
          }
        })
      } else {
        let input = new Input(this.originalCSS, this.opts)
        if (input.map) this.previousMaps.push(input.map)
      }
    }

    return this.previousMaps
  }

  setSourcesContent() {
    let already = {}
    if (this.root) {
      this.root.walk(node => {
        if (node.source) {
          let from = node.source.input.from
          if (from && !already[from]) {
            already[from] = true
            let fromUrl = this.usesFileUrls
              ? this.toFileUrl(from)
              : this.toUrl(this.path(from))
            this.map.setSourceContent(fromUrl, node.source.input.css)
          }
        }
      })
    } else if (this.css) {
      let from = this.opts.from
        ? this.toUrl(this.path(this.opts.from))
        : '<no source>'
      this.map.setSourceContent(from, this.css)
    }
  }

  sourcePath(node) {
    if (this.mapOpts.from) {
      return this.toUrl(this.mapOpts.from)
    } else if (this.usesFileUrls) {
      return this.toFileUrl(node.source.input.from)
    } else {
      return this.toUrl(this.path(node.source.input.from))
    }
  }

  toBase64(str) {
    if (Buffer) {
      return Buffer.from(str).toString('base64')
    } else {
      return window.btoa(unescape(encodeURIComponent(str)))
    }
  }

  toFileUrl(path) {
    let cached = this.memoizedFileURLs.get(path)
    if (cached) return cached

    if (pathToFileURL) {
      let fileURL = pathToFileURL(path).toString()
      this.memoizedFileURLs.set(path, fileURL)

      return fileURL
    } else {
      throw new Error(
        '`map.absolute` option is not available in this PostCSS build'
      )
    }
  }

  toUrl(path) {
    let cached = this.memoizedURLs.get(path)
    if (cached) return cached

    if (sep === '\\') {
      path = path.replace(/\\/g, '/')
    }

    let url = encodeURI(path).replace(/[#?]/g, encodeURIComponent)
    this.memoizedURLs.set(path, url)

    return url
  }
}

module.exports = MapGenerator

================================================================================
FILE: client/node_modules/source-map-support/node_modules/source-map/lib/source-map-generator.js
================================================================================

/* -*- Mode: js; js-indent-level: 2; -*- */
/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */

var base64VLQ = require('./base64-vlq');
var util = require('./util');
var ArraySet = require('./array-set').ArraySet;
var MappingList = require('./mapping-list').MappingList;

/**
 * An instance of the SourceMapGenerator represents a source map which is
 * being built incrementally. You may pass an object with the following
 * properties:
 *
 *   - file: The filename of the generated source.
 *   - sourceRoot: A root for all relative URLs in this source map.
 */
function SourceMapGenerator(aArgs) {
  if (!aArgs) {
    aArgs = {};
  }
  this._file = util.getArg(aArgs, 'file', null);
  this._sourceRoot = util.getArg(aArgs, 'sourceRoot', null);
  this._skipValidation = util.getArg(aArgs, 'skipValidation', false);
  this._sources = new ArraySet();
  this._names = new ArraySet();
  this._mappings = new MappingList();
  this._sourcesContents = null;
}

SourceMapGenerator.prototype._version = 3;

/**
 * Creates a new SourceMapGenerator based on a SourceMapConsumer
 *
 * @param aSourceMapConsumer The SourceMap.
 */
SourceMapGenerator.fromSourceMap =
  function SourceMapGenerator_fromSourceMap(aSourceMapConsumer) {
    var sourceRoot = aSourceMapConsumer.sourceRoot;
    var generator = new SourceMapGenerator({
      file: aSourceMapConsumer.file,
      sourceRoot: sourceRoot
    });
    aSourceMapConsumer.eachMapping(function (mapping) {
      var newMapping = {
        generated: {
          line: mapping.generatedLine,
          column: mapping.generatedColumn
        }
      };

      if (mapping.source != null) {
        newMapping.source = mapping.source;
        if (sourceRoot != null) {
          newMapping.source = util.relative(sourceRoot, newMapping.source);
        }

        newMapping.original = {
          line: mapping.originalLine,
          column: mapping.originalColumn
        };

        if (mapping.name != null) {
          newMapping.name = mapping.name;
        }
      }

      generator.addMapping(newMapping);
    });
    aSourceMapConsumer.sources.forEach(function (sourceFile) {
      var sourceRelative = sourceFile;
      if (sourceRoot !== null) {
        sourceRelative = util.relative(sourceRoot, sourceFile);
      }

      if (!generator._sources.has(sourceRelative)) {
        generator._sources.add(sourceRelative);
      }

      var content = aSourceMapConsumer.sourceContentFor(sourceFile);
      if (content != null) {
        generator.setSourceContent(sourceFile, content);
      }
    });
    return generator;
  };

/**
 * Add a single mapping from original source line and column to the generated
 * source's line and column for this source map being created. The mapping
 * object should have the following properties:
 *
 *   - generated: An object with the generated line and column positions.
 *   - original: An object with the original line and column positions.
 *   - source: The original source file (relative to the sourceRoot).
 *   - name: An optional original token name for this mapping.
 */
SourceMapGenerator.prototype.addMapping =
  function SourceMapGenerator_addMapping(aArgs) {
    var generated = util.getArg(aArgs, 'generated');
    var original = util.getArg(aArgs, 'original', null);
    var source = util.getArg(aArgs, 'source', null);
    var name = util.getArg(aArgs, 'name', null);

    if (!this._skipValidation) {
      this._validateMapping(generated, original, source, name);
    }

    if (source != null) {
      source = String(source);
      if (!this._sources.has(source)) {
        this._sources.add(source);
      }
    }

    if (name != null) {
      name = String(name);
      if (!this._names.has(name)) {
        this._names.add(name);
      }
    }

    this._mappings.add({
      generatedLine: generated.line,
      generatedColumn: generated.column,
      originalLine: original != null && original.line,
      originalColumn: original != null && original.column,
      source: source,
      name: name
    });
  };

/**
 * Set the source content for a source file.
 */
SourceMapGenerator.prototype.setSourceContent =
  function SourceMapGenerator_setSourceContent(aSourceFile, aSourceContent) {
    var source = aSourceFile;
    if (this._sourceRoot != null) {
      source = util.relative(this._sourceRoot, source);
    }

    if (aSourceContent != null) {
      // Add the source content to the _sourcesContents map.
      // Create a new _sourcesContents map if the property is null.
      if (!this._sourcesContents) {
        this._sourcesContents = Object.create(null);
      }
      this._sourcesContents[util.toSetString(source)] = aSourceContent;
    } else if (this._sourcesContents) {
      // Remove the source file from the _sourcesContents map.
      // If the _sourcesContents map is empty, set the property to null.
      delete this._sourcesContents[util.toSetString(source)];
      if (Object.keys(this._sourcesContents).length === 0) {
        this._sourcesContents = null;
      }
    }
  };

/**
 * Applies the mappings of a sub-source-map for a specific source file to the
 * source map being generated. Each mapping to the supplied source file is
 * rewritten using the supplied source map. Note: The resolution for the
 * resulting mappings is the minimium of this map and the supplied map.
 *
 * @param aSourceMapConsumer The source map to be applied.
 * @param aSourceFile Optional. The filename of the source file.
 *        If omitted, SourceMapConsumer's file property will be used.
 * @param aSourceMapPath Optional. The dirname of the path to the source map
 *        to be applied. If relative, it is relative to the SourceMapConsumer.
 *        This parameter is needed when the two source maps aren't in the same
 *        directory, and the source map to be applied contains relative source
 *        paths. If so, those relative source paths need to be rewritten
 *        relative to the SourceMapGenerator.
 */
SourceMapGenerator.prototype.applySourceMap =
  function SourceMapGenerator_applySourceMap(aSourceMapConsumer, aSourceFile, aSourceMapPath) {
    var sourceFile = aSourceFile;
    // If aSourceFile is omitted, we will use the file property of the SourceMap
    if (aSourceFile == null) {
      if (aSourceMapConsumer.file == null) {
        throw new Error(
          'SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, ' +
          'or the source map\'s "file" property. Both were omitted.'
        );
      }
      sourceFile = aSourceMapConsumer.file;
    }
    var sourceRoot = this._sourceRoot;
    // Make "sourceFile" relative if an absolute Url is passed.
    if (sourceRoot != null) {
      sourceFile = util.relative(sourceRoot, sourceFile);
    }
    // Applying the SourceMap can add and remove items from the sources and
    // the names array.
    var newSources = new ArraySet();
    var newNames = new ArraySet();

    // Find mappings for the "sourceFile"
    this._mappings.unsortedForEach(function (mapping) {
      if (mapping.source === sourceFile && mapping.originalLine != null) {
        // Check if it can be mapped by the source map, then update the mapping.
        var original = aSourceMapConsumer.originalPositionFor({
          line: mapping.originalLine,
          column: mapping.originalColumn
        });
        if (original.source != null) {
          // Copy mapping
          mapping.source = original.source;
          if (aSourceMapPath != null) {
            mapping.source = util.join(aSourceMapPath, mapping.source)
          }
          if (sourceRoot != null) {
            mapping.source = util.relative(sourceRoot, mapping.source);
          }
          mapping.originalLine = original.line;
          mapping.originalColumn = original.column;
          if (original.name != null) {
            mapping.name = original.name;
          }
        }
      }

      var source = mapping.source;
      if (source != null && !newSources.has(source)) {
        newSources.add(source);
      }

      var name = mapping.name;
      if (name != null && !newNames.has(name)) {
        newNames.add(name);
      }

    }, this);
    this._sources = newSources;
    this._names = newNames;

    // Copy sourcesContents of applied map.
    aSourceMapConsumer.sources.forEach(function (sourceFile) {
      var content = aSourceMapConsumer.sourceContentFor(sourceFile);
      if (content != null) {
        if (aSourceMapPath != null) {
          sourceFile = util.join(aSourceMapPath, sourceFile);
        }
        if (sourceRoot != null) {
          sourceFile = util.relative(sourceRoot, sourceFile);
        }
        this.setSourceContent(sourceFile, content);
      }
    }, this);
  };

/**
 * A mapping can have one of the three levels of data:
 *
 *   1. Just the generated position.
 *   2. The Generated position, original position, and original source.
 *   3. Generated and original position, original source, as well as a name
 *      token.
 *
 * To maintain consistency, we validate that any new mapping being added falls
 * in to one of these categories.
 */
SourceMapGenerator.prototype._validateMapping =
  function SourceMapGenerator_validateMapping(aGenerated, aOriginal, aSource,
                                              aName) {
    // When aOriginal is truthy but has empty values for .line and .column,
    // it is most likely a programmer error. In this case we throw a very
    // specific error message to try to guide them the right way.
    // For example: https://github.com/Polymer/polymer-bundler/pull/519
    if (aOriginal && typeof aOriginal.line !== 'number' && typeof aOriginal.column !== 'number') {
        throw new Error(
            'original.line and original.column are not numbers -- you probably meant to omit ' +
            'the original mapping entirely and only map the generated position. If so, pass ' +
            'null for the original mapping instead of an object with empty or null values.'
        );
    }

    if (aGenerated && 'line' in aGenerated && 'column' in aGenerated
        && aGenerated.line > 0 && aGenerated.column >= 0
        && !aOriginal && !aSource && !aName) {
      // Case 1.
      return;
    }
    else if (aGenerated && 'line' in aGenerated && 'column' in aGenerated
             && aOriginal && 'line' in aOriginal && 'column' in aOriginal
             && aGenerated.line > 0 && aGenerated.column >= 0
             && aOriginal.line > 0 && aOriginal.column >= 0
             && aSource) {
      // Cases 2 and 3.
      return;
    }
    else {
      throw new Error('Invalid mapping: ' + JSON.stringify({
        generated: aGenerated,
        source: aSource,
        original: aOriginal,
        name: aName
      }));
    }
  };

/**
 * Serialize the accumulated mappings in to the stream of base 64 VLQs
 * specified by the source map format.
 */
SourceMapGenerator.prototype._serializeMappings =
  function SourceMapGenerator_serializeMappings() {
    var previousGeneratedColumn = 0;
    var previousGeneratedLine = 1;
    var previousOriginalColumn = 0;
    var previousOriginalLine = 0;
    var previousName = 0;
    var previousSource = 0;
    var result = '';
    var next;
    var mapping;
    var nameIdx;
    var sourceIdx;

    var mappings = this._mappings.toArray();
    for (var i = 0, len = mappings.length; i < len; i++) {
      mapping = mappings[i];
      next = ''

      if (mapping.generatedLine !== previousGeneratedLine) {
        previousGeneratedColumn = 0;
        while (mapping.generatedLine !== previousGeneratedLine) {
          next += ';';
          previousGeneratedLine++;
        }
      }
      else {
        if (i > 0) {
          if (!util.compareByGeneratedPositionsInflated(mapping, mappings[i - 1])) {
            continue;
          }
          next += ',';
        }
      }

      next += base64VLQ.encode(mapping.generatedColumn
                                 - previousGeneratedColumn);
      previousGeneratedColumn = mapping.generatedColumn;

      if (mapping.source != null) {
        sourceIdx = this._sources.indexOf(mapping.source);
        next += base64VLQ.encode(sourceIdx - previousSource);
        previousSource = sourceIdx;

        // lines are stored 0-based in SourceMap spec version 3
        next += base64VLQ.encode(mapping.originalLine - 1
                                   - previousOriginalLine);
        previousOriginalLine = mapping.originalLine - 1;

        next += base64VLQ.encode(mapping.originalColumn
                                   - previousOriginalColumn);
        previousOriginalColumn = mapping.originalColumn;

        if (mapping.name != null) {
          nameIdx = this._names.indexOf(mapping.name);
          next += base64VLQ.encode(nameIdx - previousName);
          previousName = nameIdx;
        }
      }

      result += next;
    }

    return result;
  };

SourceMapGenerator.prototype._generateSourcesContent =
  function SourceMapGenerator_generateSourcesContent(aSources, aSourceRoot) {
    return aSources.map(function (source) {
      if (!this._sourcesContents) {
        return null;
      }
      if (aSourceRoot != null) {
        source = util.relative(aSourceRoot, source);
      }
      var key = util.toSetString(source);
      return Object.prototype.hasOwnProperty.call(this._sourcesContents, key)
        ? this._sourcesContents[key]
        : null;
    }, this);
  };

/**
 * Externalize the source map.
 */
SourceMapGenerator.prototype.toJSON =
  function SourceMapGenerator_toJSON() {
    var map = {
      version: this._version,
      sources: this._sources.toArray(),
      names: this._names.toArray(),
      mappings: this._serializeMappings()
    };
    if (this._file != null) {
      map.file = this._file;
    }
    if (this._sourceRoot != null) {
      map.sourceRoot = this._sourceRoot;
    }
    if (this._sourcesContents) {
      map.sourcesContent = this._generateSourcesContent(map.sources, map.sourceRoot);
    }

    return map;
  };

/**
 * Render the source map being generated to a string.
 */
SourceMapGenerator.prototype.toString =
  function SourceMapGenerator_toString() {
    return JSON.stringify(this.toJSON());
  };

exports.SourceMapGenerator = SourceMapGenerator;

================================================================================
FILE: client/src/pages/generator/GeneratorPage.jsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import ToolResult from "../../components/ui/ToolResult";
import SectionedMarkdown from "../../components/ui/SectionedMarkdown";
import { useLanguage } from "../../context/LanguageContext";
import { callCCG } from "../../services/aiService";

// local storage keys
const LS_KEY = "ccg_generator_state_v2";

const PLATFORM_OPTIONS = [
  { value: "linux", label: "Linux" },
  { value: "windows", label: "Windows" },
  { value: "mac", label: "macOS" },
  { value: "network", label: "Network Device" },
  { value: "other", label: "Other (Custom OS)" },
];

const OUTPUT_TYPES = [
  { value: "tool", labelFa: "Tool (Ú©Ø§Ù…Ù„)", labelEn: "Tool (Full)" },
  { value: "command", labelFa: "Command (ÙÙ‚Ø· Ø¯Ø³ØªÙˆØ±)", labelEn: "Command (Commands only)" },
  { value: "python", labelFa: "Python", labelEn: "Python" },
];

const VERBOSITY = [
  { value: "brief", labelFa: "Ø®Ù„Ø§ØµÙ‡", labelEn: "Brief" },
  { value: "normal", labelFa: "Ù†Ø±Ù…Ø§Ù„", labelEn: "Normal" },
  { value: "detailed", labelFa: "Ø¬Ø²Ø¦ÛŒ", labelEn: "Detailed" },
];

const SHELL_BY_PLATFORM = {
  linux: ["bash", "zsh", "sh"],
  windows: ["powershell", "cmd"],
  mac: ["zsh", "bash"],
  network: ["cli"],
  other: ["bash", "zsh", "sh", "powershell", "cmd"],
};

const LINUX_DISTROS = ["Ubuntu","Debian","RHEL","Rocky","AlmaLinux","CentOS","Fedora","Arch","Manjaro","openSUSE","Alpine","Kali"];
const WINDOWS_FLAVORS = ["Windows 10","Windows 11","Windows Server 2019","Windows Server 2022"];
const MAC_FLAVORS = ["macOS"];

const NETWORK_VENDORS = ["Cisco","MikroTik","FortiGate","Juniper","Aruba","Huawei","Generic"];
const DEVICE_TYPES_BY_VENDOR = {
  Cisco: ["switch","router","firewall"],
  MikroTik: ["router","switch"],
  FortiGate: ["firewall"],
  Juniper: ["switch","router","firewall"],
  Aruba: ["switch","controller"],
  Huawei: ["switch","router","firewall"],
  Generic: ["router","switch","firewall","appliance"],
};

function isSafeFreeText(v, min=2, max=40) {
  const s = String(v||"").trim().replace(/\s+/g," ");
  if (s.length < min || s.length > max) return false;
  return /^[a-zA-Z0-9 ._+\-\/]{2,40}$/.test(s);
}

function qsToObj() {
  const q = new URLSearchParams(window.location.search);
  return {
    platform: q.get("platform") || "",
    cli: q.get("cli") || "",
    out: q.get("out") || "",
    v: q.get("v") || "",
    adv: q.get("adv") || "",
    swap: q.get("swap") || "",
    lang: q.get("lang") || "",
  };
}
function setQS(p) {
  const q = new URLSearchParams(window.location.search);
  Object.entries(p).forEach(([k,v]) => {
    if (v === "" || v == null) q.delete(k);
    else q.set(k, String(v));
  });
  const url = `${window.location.pathname}?${q.toString()}`;
  window.history.replaceState({}, "", url);
}

function FieldLabel({ label, tip }) {
  return (
    <div className="flex items-center gap-2">
      <span className="text-sm opacity-90">{label}</span>
      {tip ? (
        <span className="relative group">
          <button
            type="button"
            className="w-5 h-5 rounded-full border text-xs opacity-70 hover:opacity-100 dark:border-white/10"
            aria-label={`${label} help`}
          >
            ?
          </button>
          <span className="pointer-events-none absolute z-50 hidden group-hover:block top-7 left-1/2 -translate-x-1/2 w-80 rounded-lg border bg-white p-2 text-xs text-slate-700 shadow dark:bg-slate-950 dark:text-slate-100 dark:border-white/10">
            {tip}
          </span>
        </span>
      ) : null}
    </div>
  );
}

export default function GeneratorPage() {
  const { lang, setLang, t } = useLanguage();
  const isRTL = (lang === "fa");

    const en = {
      platform: "Platform",
      outputType: "Output type",
      cli: "Shell / CLI",
      verbosity: "Verbosity",
      advanced: "Advanced",
      custom: "Custom OS/Shell",
      distro: "Distro / Flavor",
      version: "Version (optional)",
      vendor: "Vendor",
      deviceType: "Device type",
      request: "Request",
      gen: "Generate",
      explain: "Explain command",
      swap: "Swap",
      errFix: "Fix this first:",
      tip_platform: "Target platform to generate commands for.",
      tip_output: "Tool: full output. Command: command + warnings + alternatives (no explanation). Python: python code only.",
      tip_cli: "Target shell/CLI (bash, PowerShell, cmd, ...).",
      tip_verbosity: "Brief: short. Normal: standard. Detailed: full explanation + examples.",
      tip_advanced: "Advanced fields for the selected platform only.",
      tip_custom: "Use for custom OS/Shell. Invalid values will be blocked before sending.",
      placeholder: "Write a clear request (goal + constraints). Example: â€œRestart my systemâ€",
    };

  // Defaults
  const [platform, setPlatform] = useState("linux");
  const [cli, setCli] = useState("bash");
  const [outputType, setOutputType] = useState("tool");
  const [verbosity, setVerbosity] = useState("normal");
  const [advanced, setAdvanced] = useState(false);
  const [swap, setSwap] = useState(false);

  // advanced per-platform
  const [linuxDistro, setLinuxDistro] = useState("Ubuntu");
  const [windowsFlavor, setWindowsFlavor] = useState("Windows 11");
  const [macFlavor, setMacFlavor] = useState("macOS");
  const [osVersion, setOsVersion] = useState("");

  // network
  const [vendor, setVendor] = useState("Cisco");
  const [deviceType, setDeviceType] = useState("router");

  // custom
  const [customOn, setCustomOn] = useState(false);
  const [customOS, setCustomOS] = useState("");
  const [customShell, setCustomShell] = useState("");

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [output, setOutput] = useState("");
  const [tool, setTool] = useState(null);

  // Load persisted state
  useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      const q = qsToObj();

      const p = q.platform || saved.platform || "linux";
      const c = q.cli || saved.cli || (SHELL_BY_PLATFORM[p]?.[0] || "bash");
      const out = q.out || saved.outputType || "tool";
      const v = q.v || saved.verbosity || "normal";
      const adv = (q.adv ? q.adv === "1" : !!saved.advanced);
      const sw = (q.swap ? q.swap === "1" : !!saved.swap);

      if (q.lang) setLang(q.lang);

      setPlatform(p);
      setCli(c);
      setOutputType(out);
      setVerbosity(v);
      setAdvanced(adv);
      setSwap(sw);

      setLinuxDistro(saved.linuxDistro || "Ubuntu");
      setWindowsFlavor(saved.windowsFlavor || "Windows 11");
      setMacFlavor(saved.macFlavor || "macOS");
      setOsVersion(saved.osVersion || "");

      setVendor(saved.vendor || "Cisco");
      setDeviceType(saved.deviceType || "router");

      setCustomOn(!!saved.customOn);
      setCustomOS(saved.customOS || "");
      setCustomShell(saved.customShell || "");

      setInput(saved.input || "");
    } catch {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Keep cli valid per platform
  useEffect(() => {
    const allowed = SHELL_BY_PLATFORM[platform] || ["bash"];
    if (!allowed.includes(cli)) setCli(allowed[0]);
    // If leaving network, reset vendor/deviceType
    if (platform !== "network") {
      setVendor("Cisco");
      setDeviceType("router");
    }
    // Custom only relevant on "other"
    if (platform !== "other") setCustomOn(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [platform]);

  // persist state + URL
  useEffect(() => {
    const st = {
      platform, cli, outputType, verbosity, advanced, swap,
      linuxDistro, windowsFlavor, macFlavor, osVersion,
      vendor, deviceType,
      customOn, customOS, customShell,
      input
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
    setQS({
      platform,
      cli,
      out: outputType,
      v: verbosity,
      adv: advanced ? "1" : "",
      swap: swap ? "1" : "",
      lang,
    });
  }, [platform, cli, outputType, verbosity, advanced, swap, linuxDistro, windowsFlavor, macFlavor, osVersion, vendor, deviceType, customOn, customOS, customShell, input, lang]);

  function validateBeforeSend() {
    const errs = [];

    if (!input.trim()) errs.push(isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª." : "Request is empty.");

    // outputType strict
    if (!["tool","command","python"].includes(outputType)) errs.push("Invalid output type.");

    // platform strict
    if (!["linux","windows","mac","network","other"].includes(platform)) errs.push("Invalid platform.");

    // Custom validation (block before API)
    if (platform === "other" && customOn) {
      if (!isSafeFreeText(customOS, 2, 40)) errs.push(isRTL ? "Custom OS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom OS.");
      if (!isSafeFreeText(customShell, 2, 20)) errs.push(isRTL ? "Custom Shell/CLI Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Custom Shell/CLI.");
    }

    // Advanced validation: only for selected platform
    if (advanced && platform === "linux") {
      if (linuxDistro && !LINUX_DISTROS.includes(linuxDistro)) errs.push(isRTL ? "Distro Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid distro.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }
    if (advanced && platform === "windows") {
      if (windowsFlavor && !WINDOWS_FLAVORS.includes(windowsFlavor)) errs.push(isRTL ? "Windows Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid Windows flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version/Build Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version/build (optional).");
    }
    if (advanced && platform === "mac") {
      if (macFlavor && !MAC_FLAVORS.includes(macFlavor)) errs.push(isRTL ? "macOS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid macOS flavor.");
      if (osVersion && !isSafeFreeText(osVersion, 1, 20)) errs.push(isRTL ? "Version Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)." : "Invalid version (optional).");
    }

    // Network validation always available in normal mode (not hidden)
    if (platform === "network") {
      if (!NETWORK_VENDORS.includes(vendor)) errs.push(isRTL ? "Vendor Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid vendor.");
      const dt = DEVICE_TYPES_BY_VENDOR[vendor] || [];
      if (!dt.includes(deviceType)) errs.push(isRTL ? "Device type Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª." : "Invalid device type.");
    }

    return errs;
  }

  function computeOS() {
    // version optional, but don't force users to fill it
    if (platform === "linux") return advanced ? (osVersion ? `${linuxDistro} ${osVersion}` : linuxDistro) : "linux";
    if (platform === "windows") return advanced ? (osVersion ? `${windowsFlavor} ${osVersion}` : windowsFlavor) : "windows";
    if (platform === "mac") return advanced ? (osVersion ? `${macFlavor} ${osVersion}` : macFlavor) : "mac";
    if (platform === "network") return "network";
    if (platform === "other") return customOn ? customOS.trim() : "other";
    return platform;
  }

  function payloadFor(mode="generate", targetCommand="") {
    const base = {
      mode,
      lang,
      user_request: input.trim(),
      outputType,
      verbosity,
    };

    // custom ON => send ONLY custom fields (no extra)
    if (platform === "other" && customOn) {
      return {
        ...base,
        platform: "other",
        os: customOS.trim(),
        cli: customShell.trim(),
        vendor: "",
        deviceType: "general",
        ...(mode === "explain" ? { targetCommand } : {}),
      };
    }

    // normal platforms
    const pl = platform;
    const os = computeOS();
    const c = cli;

    return {
      ...base,
      platform: pl,
      os,
      cli: c,
      vendor: pl === "network" ? vendor : "",
      deviceType: pl === "network" ? deviceType : "general",
      ...(mode === "explain" ? { targetCommand } : {}),
    };
  }

  async function runGenerate() {
    const errs = validateBeforeSend();
    if (errs.length) { setErr(`${t.errFix} ${errs[0]}`); return; }

    setErr("");
    setLoading(true);
    setOutput("");
    setTool(null);

    try {
      const res = await callCCG(payloadFor("generate"));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  async function runExplain() {
    // explain should use last produced tool.primary.command if possible
    const cmd = tool?.primary?.command ? String(tool.primary.command) : "";
    if (!cmd.trim()) { setErr(isRTL ? "Ø§ÙˆÙ„ ÛŒÚ© Ø¯Ø³ØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯." : "Generate a command first."); return; }

    setErr("");
    setLoading(true);
    try {
      const res = await callCCG(payloadFor("explain", cmd.trim()));
      setOutput(res?.output || "");
      setTool(res?.tool || null);
    } catch (e) {
      setErr(e?.message || (isRTL ? "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API" : "API error"));
    } finally {
      setLoading(false);
    }
  }

  const cliOptions = SHELL_BY_PLATFORM[platform] || ["bash"];

  const leftPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-2" : "order-1") : (isRTL ? "order-1" : "order-2"))}`;
  const rightPanelClass = `ccg-card p-5 sm:p-6 ${(!swap ? (isRTL ? "order-1" : "order-2") : (isRTL ? "order-2" : "order-1"))}`;

  return (
    <div className="space-y-8">
      <div className="ccg-container">
        <div className="ccg-card px-4 sm:px-6 py-4">
          <div className="flex flex-wrap items-center gap-3 sm:gap-4 justify-between">

            <div className="flex flex-wrap items-center gap-3 sm:gap-4">
              <FieldLabel label={t.platform} tip={t.tip_platform} />
              <select value={platform} onChange={(e)=>setPlatform(e.target.value)} className="ccg-select text-sm">
                {PLATFORM_OPTIONS.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
              </select>

              <FieldLabel label={t.cli} tip={t.tip_cli} />
              <select value={cli} onChange={(e)=>setCli(e.target.value)} className="ccg-select text-sm">
                {cliOptions.map(v => <option key={v} value={v}>{v}</option>)}
              </select>

              <FieldLabel label={t.outputType} tip={t.tip_output} />
              <select value={outputType} onChange={(e)=>setOutputType(e.target.value)} className="ccg-select text-sm">
                {OUTPUT_TYPES.map(o => (
                  <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>
                ))}
              </select>

              <FieldLabel label={t.verbosity} tip={t.tip_verbosity} />
              <select value={verbosity} onChange={(e)=>setVerbosity(e.target.value)} className="ccg-select text-sm">
                {VERBOSITY.map(o => <option key={o.value} value={o.value}>{isRTL ? o.labelFa : o.labelEn}</option>)}
              </select>

              <div className="flex items-center gap-2">
                <input id="ccg-adv" type="checkbox" checked={advanced} onChange={(e)=>setAdvanced(e.target.checked)} />
                <label htmlFor="ccg-adv" className="text-sm opacity-90">{t.advanced}</label>
              </div>

              <button type="button" className="ccg-btn text-sm" onClick={()=>setSwap(s=>!s)}>
                {t.swap}
              </button>
            </div>

            <div className="flex items-center gap-2">
              <button type="button" className="ccg-btn text-sm" onClick={()=>setLang(isRTL ? "en" : "fa")}>
                {isRTL ? "EN" : "FA"}
              </button>
            </div>

          </div>

          {/* Advanced row (platform-specific only) */}
          {advanced ? (
            <div className="mt-4 rounded-2xl border border-[var(--border)] p-4">
              <div className="flex flex-wrap items-center gap-4 justify-between">
                <div className="text-sm opacity-80">{t.tip_advanced}</div>

                {platform === "other" ? (
                  <div className="flex items-center gap-2">
                    <input id="ccg-custom" type="checkbox" checked={customOn} onChange={(e)=>setCustomOn(e.target.checked)} />
                    <label htmlFor="ccg-custom" className="text-sm opacity-90">{t.custom}</label>
                  </div>
                ) : null}
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                {platform === "linux" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={linuxDistro} onChange={(e)=>setLinuxDistro(e.target.value)} className="ccg-select w-full">
                        {LINUX_DISTROS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ 22.04" : "e.g. 22.04"} />
                    </div>
                  </>
                ) : null}

                {platform === "windows" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={windowsFlavor} onChange={(e)=>setWindowsFlavor(e.target.value)} className="ccg-select w-full">
                        {WINDOWS_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "mac" ? (
                  <>
                    <div>
                      <FieldLabel label={t.distro} />
                      <select value={macFlavor} onChange={(e)=>setMacFlavor(e.target.value)} className="ccg-select w-full">
                        {MAC_FLAVORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.version} />
                      <input value={osVersion} onChange={(e)=>setOsVersion(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ø§Ø®ØªÛŒØ§Ø±ÛŒ" : "optional"} />
                    </div>
                  </>
                ) : null}

                {platform === "network" ? (
                  <>
                    <div>
                      <FieldLabel label={t.vendor} />
                      <select value={vendor} onChange={(e)=>{ setVendor(e.target.value); setDeviceType((DEVICE_TYPES_BY_VENDOR[e.target.value]||["router"])[0]); }} className="ccg-select w-full">
                        {NETWORK_VENDORS.map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                    <div>
                      <FieldLabel label={t.deviceType} />
                      <select value={deviceType} onChange={(e)=>setDeviceType(e.target.value)} className="ccg-select w-full">
                        {(DEVICE_TYPES_BY_VENDOR[vendor] || []).map(x => <option key={x} value={x}>{x}</option>)}
                      </select>
                    </div>
                  </>
                ) : null}

                {platform === "other" && customOn ? (
                  <>
                    <div>
                      <FieldLabel label="Custom OS" tip={t.tip_custom} />
                      <input value={customOS} onChange={(e)=>setCustomOS(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ FreeBSD" : "e.g. FreeBSD"} />
                    </div>
                    <div>
                      <FieldLabel label="Custom Shell/CLI" tip={t.tip_custom} />
                      <input value={customShell} onChange={(e)=>setCustomShell(e.target.value)} className="ccg-input w-full" placeholder={isRTL ? "Ù…Ø«Ù„Ø§Ù‹ tcsh" : "e.g. tcsh"} />
                    </div>
                  </>
                ) : null}
              </div>
            </div>
          ) : null}

        </div>
      </div>

      <div className="ccg-container">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          {/* Request */}
          <div className={rightPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{t.request}</h2>
            <textarea
              className="ccg-textarea w-full min-h-[200px]"
              value={input}
              onChange={(e)=>setInput(e.target.value)}
              placeholder={t.placeholder}
            />
            {err ? (
              <div className="ccg-error mt-3">
                <div className="font-semibold mb-1">{isRTL ? "Ø®Ø·Ø§" : "Error"}</div>
                <div className="text-sm">{err}</div>
              </div>
            ) : null}

            <div className="mt-4 flex items-center gap-3 justify-end">
              <button className="ccg-btn" type="button" disabled={loading} onClick={runExplain}>
                {t.explain}
              </button>
              <button className="ccg-btn primary" type="button" disabled={loading} onClick={runGenerate}>
                {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§..." : "Running...") : t.gen}
              </button>
            </div>
          </div>

          {/* Output */}
          <div className={leftPanelClass}>
            <h2 className="text-lg font-semibold mb-3">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ" : "Output"}</h2>
            {outputType === "tool" && tool ? (
              <ToolResult tool={tool} />
            ) : output ? (
              <SectionedMarkdown markdown={output} lang={lang} />
            ) : (
              <div className="text-sm opacity-70">{isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}</div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: client/src/components/ui/MarkdownBox.jsx
================================================================================

import { useMemo, useState } from "react";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";

/**
 * TDZ-safe MarkdownBox:
 * - No local const/object named "t" used in closures before initialization
 * - Copy button never throws
 */
function CopyMini({ value, labelCopy, labelCopied }) {
  const [copied, setCopied] = useState(false);

  async function onCopy() {
    try {
      const v = String(value || "");
      if (navigator?.clipboard?.writeText) {
        await navigator.clipboard.writeText(v);
        setCopied(true);
        window.setTimeout(() => setCopied(false), 900);
      }
    } catch (e) {
      // never crash UI
      console.error("Clipboard copy failed:", e);
    }
  }

  return (
    <button
      type="button"
      onClick={onCopy}
      className="ccg-btn ccg-btn-ghost ccg-btn-xs"
      title={labelCopy}
      disabled={!value}
    >
      {copied ? labelCopied : labelCopy}
    </button>
  );
}

export default function MarkdownBox({ markdown, content, lang = "fa" }) {
  const md = content ?? markdown ?? "";

  const labels = useMemo(() => {
    const fa = { copy: "Ú©Ù¾ÛŒ", copied: "Ú©Ù¾ÛŒ Ø´Ø¯" };
    const en = { copy: "Copy", copied: "Copied" };
    return lang === "fa" ? fa : en;
  }, [lang]);

  return (
    <div className={`ccg-markdown ${lang === "fa" ? "rtl" : "ltr"}`}>
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        components={{
          code({ inline, className, children }) {
            const raw = String(children ?? "");
            const value = raw.replace(/\n$/, "");
            const isBlock = !inline;

            if (!isBlock) return <code className="ccg-inline-code">{children}</code>;

            return (
              <div className="ccg-codeblock">
                <div className="ccg-codeblock-head">
                  <div className="ccg-codeblock-title">
                    {(className || "").replace("language-", "") || "CODE"}
                  </div>
                  <CopyMini
                    value={value}
                    labelCopy={labels.copy}
                    labelCopied={labels.copied}
                  />
                </div>
                <pre className="ccg-pre">
                  <code dir="ltr">{value}</code>
                </pre>
              </div>
            );
          },
        }}
      >
        {String(md)}
      </ReactMarkdown>
    </div>
  );
}

================================================================================
FILE: client/src/components/ui/Tooltip.jsx
================================================================================

// client/src/components/ui/Tooltip.jsx
import { useEffect, useMemo, useRef, useState } from "react";
import { createPortal } from "react-dom";

/**
 * Tooltip Portaled:
 * - Ù…Ø´Ú©Ù„ Ø±ÙØªÙ† Ù…ØªÙ† Ø²ÛŒØ± Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§/overflow Ø±Ø§ Ø­Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
 * - Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ click Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
 */
export default function Tooltip({ text, side = "top" }) {
  const btnRef = useRef(null);
  const [open, setOpen] = useState(false);
  const [pos, setPos] = useState({ top: 0, left: 0, width: 280 });

  const bubbleStyle = useMemo(() => {
    return {
      position: "fixed",
      top: pos.top,
      left: pos.left,
      width: pos.width,
      zIndex: 99999,
    };
  }, [pos]);

  useEffect(() => {
    function onDoc(e) {
      if (!open) return;
      const b = btnRef.current;
      if (!b) return;
      if (b.contains(e.target)) return;
      setOpen(false);
    }
    document.addEventListener("click", onDoc, true);
    return () => document.removeEventListener("click", onDoc, true);
  }, [open]);

  useEffect(() => {
    if (!open) return;

    const b = btnRef.current;
    if (!b) return;

    const r = b.getBoundingClientRect();
    const vw = Math.min(window.innerWidth, 520);
    const width = Math.min(320, vw - 24);

    let left = r.left + r.width / 2 - width / 2;
    left = Math.max(12, Math.min(left, window.innerWidth - width - 12));

    let top;
    if (side === "bottom") top = r.bottom + 10;
    else top = r.top - 10;

    // Ø§Ú¯Ø± Ø¨Ø§Ù„Ø§ Ø¬Ø§ Ù†Ø¨ÙˆØ¯ â†’ Ù¾Ø§ÛŒÛŒÙ†
    if (top < 10) top = r.bottom + 10;
    // Ø§Ú¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ù‡Ù… Ø¬Ø§ Ù†Ø¨ÙˆØ¯ â†’ Ø¨Ø§Ù„Ø§
    if (top + 90 > window.innerHeight) top = Math.max(10, r.top - 100);

    setPos({ top, left, width });
  }, [open, side]);

  if (!text) return null;

  return (
    <>
      <button
        ref={btnRef}
        type="button"
        onClick={() => setOpen((v) => !v)}
        className="w-5 h-5 rounded-full border text-xs text-slate-400 hover:bg-white/5 dark:border-white/10"
        aria-label="Help"
        title="Help"
      >
        ?
      </button>

      {open
        ? createPortal(
            <div style={bubbleStyle} dir="auto">
              <div className="rounded-xl border border-white/10 bg-slate-950/95 text-slate-100 shadow-2xl p-3 text-xs leading-6">
                {text}
              </div>
            </div>,
            document.body
          )
        : null}
    </>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: client/src/components/ui/MarkdownRenderer.jsx
================================================================================

import SectionedMarkdown from "./SectionedMarkdown";

/**
 * Compatibility wrapper used by some pages.
 * TDZ-safe pass-through.
 */
export default function MarkdownRenderer({ markdown, content, lang = "fa" }) {
  return <SectionedMarkdown markdown={markdown} content={content} lang={lang} />;
}

================================================================================
FILE: client/src/components/ui/MarkdownView.jsx
================================================================================

import SectionedMarkdown from "./SectionedMarkdown";

/**
 * Compatibility wrapper used by some pages.
 * TDZ-safe pass-through.
 */
export default function MarkdownView({ markdown, content, lang = "fa" }) {
  return <SectionedMarkdown markdown={markdown} content={content} lang={lang} />;
}

================================================================================
FILE: client/src/components/ui/SectionedMarkdown.jsx
================================================================================

import { useMemo } from "react";
import MarkdownBox from "./MarkdownBox";

/**
 * TDZ-safe SectionedMarkdown:
 * - pure helpers (no closures referencing const before init)
 */
function splitByHeadings(md) {
  const raw = String(md || "").replace(/\r\n/g, "\n");
  const lines = raw.split("\n");
  const sections = [];
  let currentTitle = null;
  let currentBody = [];

  function push() {
    const body = currentBody.join("\n").trim();
    if (!currentTitle && !body) return;
    sections.push({ title: currentTitle, body });
  }

  for (const line of lines) {
    const m = line.match(/^(#{2,6})\s+(.+)\s*$/);
    if (m) {
      if (currentTitle !== null || currentBody.length) push();
      currentTitle = m[2].trim();
      currentBody = [];
    } else {
      currentBody.push(line);
    }
  }
  push();

  if (!sections.length && raw.trim()) return [{ title: null, body: raw.trim() }];
  return sections;
}

export default function SectionedMarkdown({ markdown, content, lang = "fa", defaultTitle }) {
  const md = content ?? markdown ?? "";
  const sections = useMemo(() => splitByHeadings(md), [md]);

  if (!String(md).trim()) return <MarkdownBox markdown={""} lang={lang} />;

  if (sections.length === 1 && !sections[0].title) {
    return <MarkdownBox markdown={sections[0].body} lang={lang} />;
  }

  return (
    <div className="ccg-section-grid">
      {sections.map((sec, idx) => {
        const title =
          sec.title ||
          defaultTitle ||
          (lang === "fa" ? `Ø¨Ø®Ø´ ${idx + 1}` : `Section ${idx + 1}`);
        return (
          <div key={idx} className="ccg-card p-4 sm:p-5">
            <div className="font-semibold mb-3">{title}</div>
            <MarkdownBox markdown={sec.body} lang={lang} />
          </div>
        );
      })}
    </div>
  );
}

================================================================================
FILE: client/src/components/ui/ToolResult.jsx
================================================================================

// CCG_PATCH_STABILIZE_WEB_003
import MarkdownBox from "./MarkdownBox";

export default function ToolResult({ tool, lang = "fa" }) {
  if (!tool || typeof tool !== "object") return null;

  const primary = tool.primary || tool.tool || tool;

  const command =
    primary.command ||
    primary.cmd ||
    tool.command ||
    tool.cmd ||
    "";

  const python =
    primary.python ||
    tool.python ||
    "";

  const explanation =
    tool.explanation ||
    primary.explanation ||
    "";

  return (
    <div className="space-y-4">
      {command ? (
        <div className="ccg-codeblock">
          <div className="ccg-codeblock-head">
            <div className="ccg-codeblock-title">command</div>
          </div>
          <pre className="ccg-pre">
            <code dir="ltr">{command}</code>
          </pre>
        </div>
      ) : null}

      {python ? (
        <div className="ccg-codeblock">
          <div className="ccg-codeblock-head">
            <div className="ccg-codeblock-title">python</div>
          </div>
          <pre className="ccg-pre">
            <code dir="ltr">{python}</code>
          </pre>
        </div>
      ) : null}

      {explanation ? (
        <div className="ccg-card p-4 sm:p-5">
          <MarkdownBox markdown={String(explanation)} lang={lang} />
        </div>
      ) : null}
    </div>
  );
}

================================================================================
FILE: client/src/components/generator/GeneratorForm.jsx
================================================================================

import { useState } from "react";
import { generateCommand } from "../../services/aiService";
import CodeBlock from "../ui/CodeBlock";
import MarkdownRenderer from "../ui/MarkdownRenderer";
import WarningBox from "../ui/WarningBox";
import { useLanguage } from "../../context/LanguageContext";

export default function GeneratorForm() {
  const { lang, setLang, t } = useLanguage();
  const [request, setRequest] = useState("");
  const [os, setOs] = useState("linux");
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);

  const submit = async () => {
    setLoading(true);
    setResult(null);
    try {
      const res = await generateCommand({
        user_request: request,
        os,
        lang,
      });
      setResult(res);
    } catch (e) {
      setResult({ error: e.message });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      {/* FORM */}
      <div className="space-y-4">
        <textarea
          dir={isRTL ? "rtl" : "ltr"}
          value={request}
          onChange={(e) => setRequest(e.target.value)}
          placeholder={isRTL ? "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦" : "Describe your requestâ€¦"}
          className="w-full min-h-[160px] rounded-lg bg-slate-900 border border-slate-800 p-4"
        />

        <select
          value={os}
          onChange={(e) => setOs(e.target.value)}
          className="w-full rounded-lg bg-slate-900 border border-slate-800 p-3"
        >
          <option value="linux">Linux</option>
          <option value="windows">Windows</option>
          <option value="windows-server">Windows Server</option>
          <option value="mac">macOS</option>
          <option value="cisco">Cisco</option>
          <option value="mikrotik">MikroTik</option>
          <option value="fortigate">FortiGate</option>
        </select>

        <button
          onClick={submit}
          disabled={loading}
          className="w-full rounded-lg bg-blue-500 py-3 font-semibold text-black"
        >
          {loading ? (isRTL ? "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´â€¦" : "Generatingâ€¦") : (isRTL ? "ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ" : "Generate")}
        </button>
      </div>

      {/* OUTPUT */}
      <div className="rounded-xl border border-slate-800 bg-slate-900 p-4 space-y-4">
        {!result && (
          <div className="text-slate-500 text-sm">
            {isRTL ? "Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." : "Output will appear here."}
          </div>
        )}

        {result?.output && (
          <MarkdownRenderer content={result.output} />
        )}

        {result?.error && (
          <WarningBox warnings={[result.error]} />
        )}
      </div>
    </div>
  );
}
document.body.classList.add("night-mode");
document.body.classList.add("day-mode");

================================================================================
FILE: server/utils/outputFormatter.js
================================================================================

// server/utils/outputFormatter.js
// âœ… Hardened formatter: if AI returns tool JSON as raw text, we parse it and generate stable markdown + tool object.
// ESM exports: formatToolResponse + formatOutput(alias)

function fenceLangFromCli(cli = "bash", outputType = "tool") {
  const c = String(cli || "").toLowerCase();
  const ot = String(outputType || "").toLowerCase();
  if (ot === "python") return "python";
  if (c.includes("powershell") || c === "pwsh" || c === "powershell") return "powershell";
  if (c.includes("cmd") || c === "cmd") return "cmd";
  return "bash";
}

function tryParseJSONMaybe(text) {
  const t = String(text || "").trim();
  if (!t) return null;
  if (!(t.startsWith("{") && t.endsWith("}"))) return null;
  try { return JSON.parse(t); } catch { return null; }
}

function splitFirstCodeBlock(text) {
  const t = String(text ?? "").trim();
  const m = t.match(/```[^\n]*\n([\s\S]*?)```/);
  if (!m) return { codeRaw: "", rest: t };
  return { codeRaw: String(m[1] ?? "").trim(), rest: t.replace(m[0], "").trim() };
}

function looksLikeCommand(line) {
  const s = String(line || "").trim();
  if (!s) return false;
  if (s.length > 240) return false;
  if (/[.ØŒØ›!?]$/.test(s)) return false;
  return true;
}

function normalizeToolObj(tool) {
  const t = (tool && typeof tool === "object") ? tool : {};
  const primary = (t.primary && typeof t.primary === "object") ? t.primary : {};
  const command = String(primary.command || "").trim();
  const lang = String(primary.lang || "").trim();
  const explanation = String(t.explanation || "").trim();

  const warnings = Array.isArray(t.warnings)
    ? t.warnings.map(x => String(x || "").trim()).filter(Boolean)
    : [];

  const alternatives = Array.isArray(t.alternatives)
    ? t.alternatives.map(a => ({
        command: String(a?.command || "").trim(),
        note: String(a?.note || "").trim(),
      })).filter(a => a.command)
    : [];

  return {
    primary: { command, lang },
    explanation,
    warnings,
    alternatives,
  };
}

function toolToMarkdown(tool, cli, outputType, forcedCommand) {
  const fenceLang = fenceLangFromCli(cli, outputType);
  const primaryCmd = String(forcedCommand || tool?.primary?.command || "").trim() || 'echo "No command produced"';
  const primaryLang = String(tool?.primary?.lang || fenceLang).trim() || fenceLang;

  // command mode: ONLY primary command
  const ot = String(outputType || "").toLowerCase();
  if (ot === "command") {
    return `\`\`\`${primaryLang}\n${primaryCmd}\n\`\`\``;
  }

  const parts = [];
  parts.push(`\`\`\`${primaryLang}\n${primaryCmd}\n\`\`\``);

  const exp = String(tool?.explanation || "").trim();
  if (exp) parts.push(`## ØªÙˆØ¶ÛŒØ­\n${exp}`);

  const warnings = Array.isArray(tool?.warnings) ? tool.warnings : [];
  if (warnings.length) {
    parts.push(`## Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§\n${warnings.map(w => `- ${w}`).join("\n")}`);
  }

  const alts = Array.isArray(tool?.alternatives) ? tool.alternatives : [];
  if (alts.length) {
    const blocks = alts.map(a => {
      const note = String(a?.note || "").trim();
      const cmd = String(a?.command || "").trim();
      const head = note ? `- ${note}\n\n` : "";
      return `${head}\`\`\`${primaryLang}\n${cmd}\n\`\`\``;
    }).join("\n\n");
    parts.push(`## Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§\n${blocks}`);
  }

  return parts.join("\n\n");
}

export function formatToolResponse({
  rawText = "",
  text = "",
  cli = "bash",
  outputType = "tool",
  forcedCommand = "",
} = {}) {
  const input = String(rawText || text || "").trim();

  // 1) If raw text is JSON => parse as tool first
  const parsed = tryParseJSONMaybe(input);
  if (parsed) {
    // accept {tool:{...}, markdown:"..."} OR direct tool object {primary,...}
    const maybeTool = (parsed.tool && typeof parsed.tool === "object") ? parsed.tool : parsed;
    const tool0 = normalizeToolObj(maybeTool);

    // enforce forced command (explain mode)
    if (forcedCommand) tool0.primary.command = String(forcedCommand).trim();

    // if tool json had no command, fallback
    if (!tool0.primary.command) {
      tool0.primary.command = 'echo "No command produced"';
    }

    // if tool json had no lang, infer
    if (!tool0.primary.lang) tool0.primary.lang = fenceLangFromCli(cli, outputType);

    const markdown = toolToMarkdown(tool0, cli, outputType, forcedCommand);
    return { ok: true, tool: tool0, markdown, output: markdown };
  }

  // 2) Otherwise: try to infer from code block or first command-like line
  const { codeRaw, rest } = splitFirstCodeBlock(input);

  let cmd = "";
  if (codeRaw) cmd = codeRaw.split("\n").map(l => l.trim()).filter(Boolean).join("\n").trim();

  if (!cmd) {
    // fallback: first line that looks like a command
    const line = input.split("\n").map(x => x.trim()).find(looksLikeCommand);
    if (line) cmd = line;
  }

  if (!cmd) cmd = 'echo "No command produced"';

  const tool = normalizeToolObj({
    primary: { command: cmd, lang: fenceLangFromCli(cli, outputType) },
    explanation: rest || "",
    warnings: [],
    alternatives: [],
  });

  if (forcedCommand) tool.primary.command = String(forcedCommand).trim();

  const markdown = toolToMarkdown(tool, cli, outputType, forcedCommand);
  return { ok: true, tool, markdown, output: markdown };
}

export function formatOutput(args = {}) {
  return formatToolResponse(args);
}

================================================================================
FILE: node_modules/bfg/src/tools.js
================================================================================

module.exports = {
	check_options:function(options, required){
		if(!options.container){
			throw new Error('container option required');
		}
		(required || []).forEach(function(field){
			if(!options[field]){
				throw new Error(field + ' option required');
			}
		})
	},
	env_options:function(options){
		return {
			username:options.username || process.env.RACKSPACE_USERNAME,
			apikey:options.apikey || process.env.RACKSPACE_APIKEY,
			region:options.region || process.env.RACKSPACE_REGION,
			container:options.container || process.env.RACKSPACE_CONTAINER
		}
	}
}
================================================================================
FILE: node_modules/mongodb/lib/operations/client_bulk_write/results_merger.js
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClientBulkWriteResultsMerger = void 0;
const __1 = require("../..");
const error_1 = require("../../error");
/**
 * Unacknowledged bulk writes are always the same.
 */
const UNACKNOWLEDGED = {
    acknowledged: false,
    insertedCount: 0,
    upsertedCount: 0,
    matchedCount: 0,
    modifiedCount: 0,
    deletedCount: 0,
    insertResults: undefined,
    updateResults: undefined,
    deleteResults: undefined
};
/**
 * Merges client bulk write cursor responses together into a single result.
 * @internal
 */
class ClientBulkWriteResultsMerger {
    /**
     * @returns The standard unacknowledged bulk write result.
     */
    static unacknowledged() {
        return UNACKNOWLEDGED;
    }
    /**
     * Instantiate the merger.
     * @param options - The options.
     */
    constructor(options) {
        this.options = options;
        this.currentBatchOffset = 0;
        this.writeConcernErrors = [];
        this.writeErrors = new Map();
        this.result = {
            acknowledged: true,
            insertedCount: 0,
            upsertedCount: 0,
            matchedCount: 0,
            modifiedCount: 0,
            deletedCount: 0,
            insertResults: undefined,
            updateResults: undefined,
            deleteResults: undefined
        };
        if (options.verboseResults) {
            this.result.insertResults = new Map();
            this.result.updateResults = new Map();
            this.result.deleteResults = new Map();
        }
    }
    /**
     * Get the bulk write result object.
     */
    get bulkWriteResult() {
        return {
            acknowledged: this.result.acknowledged,
            insertedCount: this.result.insertedCount,
            upsertedCount: this.result.upsertedCount,
            matchedCount: this.result.matchedCount,
            modifiedCount: this.result.modifiedCount,
            deletedCount: this.result.deletedCount,
            insertResults: this.result.insertResults,
            updateResults: this.result.updateResults,
            deleteResults: this.result.deleteResults
        };
    }
    /**
     * Merge the results in the cursor to the existing result.
     * @param currentBatchOffset - The offset index to the original models.
     * @param response - The cursor response.
     * @param documents - The documents in the cursor.
     * @returns The current result.
     */
    async merge(cursor) {
        let writeConcernErrorResult;
        try {
            for await (const document of cursor) {
                // Only add to maps if ok: 1
                if (document.ok === 1) {
                    if (this.options.verboseResults) {
                        this.processDocument(cursor, document);
                    }
                }
                else {
                    // If an individual write error is encountered during an ordered bulk write, drivers MUST
                    // record the error in writeErrors and immediately throw the exception. Otherwise, drivers
                    // MUST continue to iterate the results cursor and execute any further bulkWrite batches.
                    if (this.options.ordered) {
                        const error = new error_1.MongoClientBulkWriteError({
                            message: 'Mongo client ordered bulk write encountered a write error.'
                        });
                        error.writeErrors.set(document.idx + this.currentBatchOffset, {
                            code: document.code,
                            message: document.errmsg
                        });
                        error.partialResult = this.result;
                        throw error;
                    }
                    else {
                        this.writeErrors.set(document.idx + this.currentBatchOffset, {
                            code: document.code,
                            message: document.errmsg
                        });
                    }
                }
            }
        }
        catch (error) {
            if (error instanceof __1.MongoWriteConcernError) {
                const result = error.result;
                writeConcernErrorResult = {
                    insertedCount: result.nInserted,
                    upsertedCount: result.nUpserted,
                    matchedCount: result.nMatched,
                    modifiedCount: result.nModified,
                    deletedCount: result.nDeleted,
                    writeConcernError: result.writeConcernError
                };
                if (this.options.verboseResults && result.cursor.firstBatch) {
                    for (const document of result.cursor.firstBatch) {
                        if (document.ok === 1) {
                            this.processDocument(cursor, document);
                        }
                    }
                }
            }
            else {
                throw error;
            }
        }
        finally {
            // Update the counts from the cursor response.
            if (cursor.response) {
                const response = cursor.response;
                this.incrementCounts(response);
            }
            // Increment the batch offset.
            this.currentBatchOffset += cursor.operations.length;
        }
        // If we have write concern errors ensure they are added.
        if (writeConcernErrorResult) {
            const writeConcernError = writeConcernErrorResult.writeConcernError;
            this.incrementCounts(writeConcernErrorResult);
            this.writeConcernErrors.push({
                code: writeConcernError.code,
                message: writeConcernError.errmsg
            });
        }
        return this.result;
    }
    /**
     * Process an individual document in the results.
     * @param cursor - The cursor.
     * @param document - The document to process.
     */
    processDocument(cursor, document) {
        // Get the corresponding operation from the command.
        const operation = cursor.operations[document.idx];
        // Handle insert results.
        if ('insert' in operation) {
            this.result.insertResults?.set(document.idx + this.currentBatchOffset, {
                insertedId: operation.document._id
            });
        }
        // Handle update results.
        if ('update' in operation) {
            const result = {
                matchedCount: document.n,
                modifiedCount: document.nModified ?? 0,
                // Check if the bulk did actually upsert.
                didUpsert: document.upserted != null
            };
            if (document.upserted) {
                result.upsertedId = document.upserted._id;
            }
            this.result.updateResults?.set(document.idx + this.currentBatchOffset, result);
        }
        // Handle delete results.
        if ('delete' in operation) {
            this.result.deleteResults?.set(document.idx + this.currentBatchOffset, {
                deletedCount: document.n
            });
        }
    }
    /**
     * Increment the result counts.
     * @param document - The document with the results.
     */
    incrementCounts(document) {
        this.result.insertedCount += document.insertedCount;
        this.result.upsertedCount += document.upsertedCount;
        this.result.matchedCount += document.matchedCount;
        this.result.modifiedCount += document.modifiedCount;
        this.result.deletedCount += document.deletedCount;
    }
}
exports.ClientBulkWriteResultsMerger = ClientBulkWriteResultsMerger;
//# sourceMappingURL=results_merger.js.map
================================================================================
FILE: node_modules/mongodb/src/operations/client_bulk_write/results_merger.ts
================================================================================

import { MongoWriteConcernError } from '../..';
import { type Document } from '../../bson';
import { type ClientBulkWriteCursor } from '../../cursor/client_bulk_write_cursor';
import { MongoClientBulkWriteError } from '../../error';
import {
  type ClientBulkWriteError,
  type ClientBulkWriteOptions,
  type ClientBulkWriteResult,
  type ClientDeleteResult,
  type ClientInsertOneResult,
  type ClientUpdateResult
} from './common';

/**
 * Unacknowledged bulk writes are always the same.
 */
const UNACKNOWLEDGED = {
  acknowledged: false,
  insertedCount: 0,
  upsertedCount: 0,
  matchedCount: 0,
  modifiedCount: 0,
  deletedCount: 0,
  insertResults: undefined,
  updateResults: undefined,
  deleteResults: undefined
};

interface ClientBulkWriteResultAccumulation {
  /**
   * Whether the bulk write was acknowledged.
   */
  acknowledged: boolean;
  /**
   * The total number of documents inserted across all insert operations.
   */
  insertedCount: number;
  /**
   * The total number of documents upserted across all update operations.
   */
  upsertedCount: number;
  /**
   * The total number of documents matched across all update operations.
   */
  matchedCount: number;
  /**
   * The total number of documents modified across all update operations.
   */
  modifiedCount: number;
  /**
   * The total number of documents deleted across all delete operations.
   */
  deletedCount: number;
  /**
   * The results of each individual insert operation that was successfully performed.
   */
  insertResults?: Map<number, ClientInsertOneResult>;
  /**
   * The results of each individual update operation that was successfully performed.
   */
  updateResults?: Map<number, ClientUpdateResult>;
  /**
   * The results of each individual delete operation that was successfully performed.
   */
  deleteResults?: Map<number, ClientDeleteResult>;
}

/**
 * Merges client bulk write cursor responses together into a single result.
 * @internal
 */
export class ClientBulkWriteResultsMerger {
  private result: ClientBulkWriteResultAccumulation;
  private options: ClientBulkWriteOptions;
  private currentBatchOffset: number;
  writeConcernErrors: Document[];
  writeErrors: Map<number, ClientBulkWriteError>;

  /**
   * @returns The standard unacknowledged bulk write result.
   */
  static unacknowledged(): ClientBulkWriteResult {
    return UNACKNOWLEDGED;
  }

  /**
   * Instantiate the merger.
   * @param options - The options.
   */
  constructor(options: ClientBulkWriteOptions) {
    this.options = options;
    this.currentBatchOffset = 0;
    this.writeConcernErrors = [];
    this.writeErrors = new Map();
    this.result = {
      acknowledged: true,
      insertedCount: 0,
      upsertedCount: 0,
      matchedCount: 0,
      modifiedCount: 0,
      deletedCount: 0,
      insertResults: undefined,
      updateResults: undefined,
      deleteResults: undefined
    };

    if (options.verboseResults) {
      this.result.insertResults = new Map<number, ClientInsertOneResult>();
      this.result.updateResults = new Map<number, ClientUpdateResult>();
      this.result.deleteResults = new Map<number, ClientDeleteResult>();
    }
  }

  /**
   * Get the bulk write result object.
   */
  get bulkWriteResult(): ClientBulkWriteResult {
    return {
      acknowledged: this.result.acknowledged,
      insertedCount: this.result.insertedCount,
      upsertedCount: this.result.upsertedCount,
      matchedCount: this.result.matchedCount,
      modifiedCount: this.result.modifiedCount,
      deletedCount: this.result.deletedCount,
      insertResults: this.result.insertResults,
      updateResults: this.result.updateResults,
      deleteResults: this.result.deleteResults
    };
  }

  /**
   * Merge the results in the cursor to the existing result.
   * @param currentBatchOffset - The offset index to the original models.
   * @param response - The cursor response.
   * @param documents - The documents in the cursor.
   * @returns The current result.
   */
  async merge(cursor: ClientBulkWriteCursor): Promise<ClientBulkWriteResult> {
    let writeConcernErrorResult;
    try {
      for await (const document of cursor) {
        // Only add to maps if ok: 1
        if (document.ok === 1) {
          if (this.options.verboseResults) {
            this.processDocument(cursor, document);
          }
        } else {
          // If an individual write error is encountered during an ordered bulk write, drivers MUST
          // record the error in writeErrors and immediately throw the exception. Otherwise, drivers
          // MUST continue to iterate the results cursor and execute any further bulkWrite batches.
          if (this.options.ordered) {
            const error = new MongoClientBulkWriteError({
              message: 'Mongo client ordered bulk write encountered a write error.'
            });
            error.writeErrors.set(document.idx + this.currentBatchOffset, {
              code: document.code,
              message: document.errmsg
            });
            error.partialResult = this.result;
            throw error;
          } else {
            this.writeErrors.set(document.idx + this.currentBatchOffset, {
              code: document.code,
              message: document.errmsg
            });
          }
        }
      }
    } catch (error) {
      if (error instanceof MongoWriteConcernError) {
        const result = error.result;
        writeConcernErrorResult = {
          insertedCount: result.nInserted,
          upsertedCount: result.nUpserted,
          matchedCount: result.nMatched,
          modifiedCount: result.nModified,
          deletedCount: result.nDeleted,
          writeConcernError: result.writeConcernError
        };
        if (this.options.verboseResults && result.cursor.firstBatch) {
          for (const document of result.cursor.firstBatch) {
            if (document.ok === 1) {
              this.processDocument(cursor, document);
            }
          }
        }
      } else {
        throw error;
      }
    } finally {
      // Update the counts from the cursor response.
      if (cursor.response) {
        const response = cursor.response;
        this.incrementCounts(response);
      }

      // Increment the batch offset.
      this.currentBatchOffset += cursor.operations.length;
    }

    // If we have write concern errors ensure they are added.
    if (writeConcernErrorResult) {
      const writeConcernError = writeConcernErrorResult.writeConcernError as Document;
      this.incrementCounts(writeConcernErrorResult);
      this.writeConcernErrors.push({
        code: writeConcernError.code,
        message: writeConcernError.errmsg
      });
    }

    return this.result;
  }

  /**
   * Process an individual document in the results.
   * @param cursor - The cursor.
   * @param document - The document to process.
   */
  private processDocument(cursor: ClientBulkWriteCursor, document: Document) {
    // Get the corresponding operation from the command.
    const operation = cursor.operations[document.idx];
    // Handle insert results.
    if ('insert' in operation) {
      this.result.insertResults?.set(document.idx + this.currentBatchOffset, {
        insertedId: operation.document._id
      });
    }
    // Handle update results.
    if ('update' in operation) {
      const result: ClientUpdateResult = {
        matchedCount: document.n,
        modifiedCount: document.nModified ?? 0,
        // Check if the bulk did actually upsert.
        didUpsert: document.upserted != null
      };
      if (document.upserted) {
        result.upsertedId = document.upserted._id;
      }
      this.result.updateResults?.set(document.idx + this.currentBatchOffset, result);
    }
    // Handle delete results.
    if ('delete' in operation) {
      this.result.deleteResults?.set(document.idx + this.currentBatchOffset, {
        deletedCount: document.n
      });
    }
  }

  /**
   * Increment the result counts.
   * @param document - The document with the results.
   */
  private incrementCounts(document: Document) {
    this.result.insertedCount += document.insertedCount;
    this.result.upsertedCount += document.upsertedCount;
    this.result.matchedCount += document.matchedCount;
    this.result.modifiedCount += document.modifiedCount;
    this.result.deletedCount += document.deletedCount;
  }
}

================================================================================
FILE: node_modules/openai/resources/evals/runs/output-items.d.ts
================================================================================

import { APIResource } from "../../../resource.js";
import * as Core from "../../../core.js";
import * as RunsAPI from "./runs.js";
import { CursorPage, type CursorPageParams } from "../../../pagination.js";
export declare class OutputItems extends APIResource {
    /**
     * Get an evaluation run output item by ID.
     */
    retrieve(evalId: string, runId: string, outputItemId: string, options?: Core.RequestOptions): Core.APIPromise<OutputItemRetrieveResponse>;
    /**
     * Get a list of output items for an evaluation run.
     */
    list(evalId: string, runId: string, query?: OutputItemListParams, options?: Core.RequestOptions): Core.PagePromise<OutputItemListResponsesPage, OutputItemListResponse>;
    list(evalId: string, runId: string, options?: Core.RequestOptions): Core.PagePromise<OutputItemListResponsesPage, OutputItemListResponse>;
}
export declare class OutputItemListResponsesPage extends CursorPage<OutputItemListResponse> {
}
/**
 * A schema representing an evaluation run output item.
 */
export interface OutputItemRetrieveResponse {
    /**
     * Unique identifier for the evaluation run output item.
     */
    id: string;
    /**
     * Unix timestamp (in seconds) when the evaluation run was created.
     */
    created_at: number;
    /**
     * Details of the input data source item.
     */
    datasource_item: Record<string, unknown>;
    /**
     * The identifier for the data source item.
     */
    datasource_item_id: number;
    /**
     * The identifier of the evaluation group.
     */
    eval_id: string;
    /**
     * The type of the object. Always "eval.run.output_item".
     */
    object: 'eval.run.output_item';
    /**
     * A list of results from the evaluation run.
     */
    results: Array<Record<string, unknown>>;
    /**
     * The identifier of the evaluation run associated with this output item.
     */
    run_id: string;
    /**
     * A sample containing the input and output of the evaluation run.
     */
    sample: OutputItemRetrieveResponse.Sample;
    /**
     * The status of the evaluation run.
     */
    status: string;
}
export declare namespace OutputItemRetrieveResponse {
    /**
     * A sample containing the input and output of the evaluation run.
     */
    interface Sample {
        /**
         * An object representing an error response from the Eval API.
         */
        error: RunsAPI.EvalAPIError;
        /**
         * The reason why the sample generation was finished.
         */
        finish_reason: string;
        /**
         * An array of input messages.
         */
        input: Array<Sample.Input>;
        /**
         * The maximum number of tokens allowed for completion.
         */
        max_completion_tokens: number;
        /**
         * The model used for generating the sample.
         */
        model: string;
        /**
         * An array of output messages.
         */
        output: Array<Sample.Output>;
        /**
         * The seed used for generating the sample.
         */
        seed: number;
        /**
         * The sampling temperature used.
         */
        temperature: number;
        /**
         * The top_p value used for sampling.
         */
        top_p: number;
        /**
         * Token usage details for the sample.
         */
        usage: Sample.Usage;
    }
    namespace Sample {
        /**
         * An input message.
         */
        interface Input {
            /**
             * The content of the message.
             */
            content: string;
            /**
             * The role of the message sender (e.g., system, user, developer).
             */
            role: string;
        }
        interface Output {
            /**
             * The content of the message.
             */
            content?: string;
            /**
             * The role of the message (e.g. "system", "assistant", "user").
             */
            role?: string;
        }
        /**
         * Token usage details for the sample.
         */
        interface Usage {
            /**
             * The number of tokens retrieved from cache.
             */
            cached_tokens: number;
            /**
             * The number of completion tokens generated.
             */
            completion_tokens: number;
            /**
             * The number of prompt tokens used.
             */
            prompt_tokens: number;
            /**
             * The total number of tokens used.
             */
            total_tokens: number;
        }
    }
}
/**
 * A schema representing an evaluation run output item.
 */
export interface OutputItemListResponse {
    /**
     * Unique identifier for the evaluation run output item.
     */
    id: string;
    /**
     * Unix timestamp (in seconds) when the evaluation run was created.
     */
    created_at: number;
    /**
     * Details of the input data source item.
     */
    datasource_item: Record<string, unknown>;
    /**
     * The identifier for the data source item.
     */
    datasource_item_id: number;
    /**
     * The identifier of the evaluation group.
     */
    eval_id: string;
    /**
     * The type of the object. Always "eval.run.output_item".
     */
    object: 'eval.run.output_item';
    /**
     * A list of results from the evaluation run.
     */
    results: Array<Record<string, unknown>>;
    /**
     * The identifier of the evaluation run associated with this output item.
     */
    run_id: string;
    /**
     * A sample containing the input and output of the evaluation run.
     */
    sample: OutputItemListResponse.Sample;
    /**
     * The status of the evaluation run.
     */
    status: string;
}
export declare namespace OutputItemListResponse {
    /**
     * A sample containing the input and output of the evaluation run.
     */
    interface Sample {
        /**
         * An object representing an error response from the Eval API.
         */
        error: RunsAPI.EvalAPIError;
        /**
         * The reason why the sample generation was finished.
         */
        finish_reason: string;
        /**
         * An array of input messages.
         */
        input: Array<Sample.Input>;
        /**
         * The maximum number of tokens allowed for completion.
         */
        max_completion_tokens: number;
        /**
         * The model used for generating the sample.
         */
        model: string;
        /**
         * An array of output messages.
         */
        output: Array<Sample.Output>;
        /**
         * The seed used for generating the sample.
         */
        seed: number;
        /**
         * The sampling temperature used.
         */
        temperature: number;
        /**
         * The top_p value used for sampling.
         */
        top_p: number;
        /**
         * Token usage details for the sample.
         */
        usage: Sample.Usage;
    }
    namespace Sample {
        /**
         * An input message.
         */
        interface Input {
            /**
             * The content of the message.
             */
            content: string;
            /**
             * The role of the message sender (e.g., system, user, developer).
             */
            role: string;
        }
        interface Output {
            /**
             * The content of the message.
             */
            content?: string;
            /**
             * The role of the message (e.g. "system", "assistant", "user").
             */
            role?: string;
        }
        /**
         * Token usage details for the sample.
         */
        interface Usage {
            /**
             * The number of tokens retrieved from cache.
             */
            cached_tokens: number;
            /**
             * The number of completion tokens generated.
             */
            completion_tokens: number;
            /**
             * The number of prompt tokens used.
             */
            prompt_tokens: number;
            /**
             * The total number of tokens used.
             */
            total_tokens: number;
        }
    }
}
export interface OutputItemListParams extends CursorPageParams {
    /**
     * Sort order for output items by timestamp. Use `asc` for ascending order or
     * `desc` for descending order. Defaults to `asc`.
     */
    order?: 'asc' | 'desc';
    /**
     * Filter output items by status. Use `failed` to filter by failed output items or
     * `pass` to filter by passed output items.
     */
    status?: 'fail' | 'pass';
}
export declare namespace OutputItems {
    export { type OutputItemRetrieveResponse as OutputItemRetrieveResponse, type OutputItemListResponse as OutputItemListResponse, OutputItemListResponsesPage as OutputItemListResponsesPage, type OutputItemListParams as OutputItemListParams, };
}
//# sourceMappingURL=output-items.d.ts.map
================================================================================
FILE: node_modules/openai/resources/evals/runs/output-items.js
================================================================================

"use strict";
// File generated from our OpenAPI spec by Stainless. See CONTRIBUTING.md for details.
Object.defineProperty(exports, "__esModule", { value: true });
exports.OutputItemListResponsesPage = exports.OutputItems = void 0;
const resource_1 = require("../../../resource.js");
const core_1 = require("../../../core.js");
const pagination_1 = require("../../../pagination.js");
class OutputItems extends resource_1.APIResource {
    /**
     * Get an evaluation run output item by ID.
     */
    retrieve(evalId, runId, outputItemId, options) {
        return this._client.get(`/evals/${evalId}/runs/${runId}/output_items/${outputItemId}`, options);
    }
    list(evalId, runId, query = {}, options) {
        if ((0, core_1.isRequestOptions)(query)) {
            return this.list(evalId, runId, {}, query);
        }
        return this._client.getAPIList(`/evals/${evalId}/runs/${runId}/output_items`, OutputItemListResponsesPage, { query, ...options });
    }
}
exports.OutputItems = OutputItems;
class OutputItemListResponsesPage extends pagination_1.CursorPage {
}
exports.OutputItemListResponsesPage = OutputItemListResponsesPage;
OutputItems.OutputItemListResponsesPage = OutputItemListResponsesPage;
//# sourceMappingURL=output-items.js.map
================================================================================
FILE: node_modules/openai/src/resources/evals/runs/output-items.ts
================================================================================

// File generated from our OpenAPI spec by Stainless. See CONTRIBUTING.md for details.

import { APIResource } from '../../../resource';
import { isRequestOptions } from '../../../core';
import * as Core from '../../../core';
import * as RunsAPI from './runs';
import { CursorPage, type CursorPageParams } from '../../../pagination';

export class OutputItems extends APIResource {
  /**
   * Get an evaluation run output item by ID.
   */
  retrieve(
    evalId: string,
    runId: string,
    outputItemId: string,
    options?: Core.RequestOptions,
  ): Core.APIPromise<OutputItemRetrieveResponse> {
    return this._client.get(`/evals/${evalId}/runs/${runId}/output_items/${outputItemId}`, options);
  }

  /**
   * Get a list of output items for an evaluation run.
   */
  list(
    evalId: string,
    runId: string,
    query?: OutputItemListParams,
    options?: Core.RequestOptions,
  ): Core.PagePromise<OutputItemListResponsesPage, OutputItemListResponse>;
  list(
    evalId: string,
    runId: string,
    options?: Core.RequestOptions,
  ): Core.PagePromise<OutputItemListResponsesPage, OutputItemListResponse>;
  list(
    evalId: string,
    runId: string,
    query: OutputItemListParams | Core.RequestOptions = {},
    options?: Core.RequestOptions,
  ): Core.PagePromise<OutputItemListResponsesPage, OutputItemListResponse> {
    if (isRequestOptions(query)) {
      return this.list(evalId, runId, {}, query);
    }
    return this._client.getAPIList(
      `/evals/${evalId}/runs/${runId}/output_items`,
      OutputItemListResponsesPage,
      { query, ...options },
    );
  }
}

export class OutputItemListResponsesPage extends CursorPage<OutputItemListResponse> {}

/**
 * A schema representing an evaluation run output item.
 */
export interface OutputItemRetrieveResponse {
  /**
   * Unique identifier for the evaluation run output item.
   */
  id: string;

  /**
   * Unix timestamp (in seconds) when the evaluation run was created.
   */
  created_at: number;

  /**
   * Details of the input data source item.
   */
  datasource_item: Record<string, unknown>;

  /**
   * The identifier for the data source item.
   */
  datasource_item_id: number;

  /**
   * The identifier of the evaluation group.
   */
  eval_id: string;

  /**
   * The type of the object. Always "eval.run.output_item".
   */
  object: 'eval.run.output_item';

  /**
   * A list of results from the evaluation run.
   */
  results: Array<Record<string, unknown>>;

  /**
   * The identifier of the evaluation run associated with this output item.
   */
  run_id: string;

  /**
   * A sample containing the input and output of the evaluation run.
   */
  sample: OutputItemRetrieveResponse.Sample;

  /**
   * The status of the evaluation run.
   */
  status: string;
}

export namespace OutputItemRetrieveResponse {
  /**
   * A sample containing the input and output of the evaluation run.
   */
  export interface Sample {
    /**
     * An object representing an error response from the Eval API.
     */
    error: RunsAPI.EvalAPIError;

    /**
     * The reason why the sample generation was finished.
     */
    finish_reason: string;

    /**
     * An array of input messages.
     */
    input: Array<Sample.Input>;

    /**
     * The maximum number of tokens allowed for completion.
     */
    max_completion_tokens: number;

    /**
     * The model used for generating the sample.
     */
    model: string;

    /**
     * An array of output messages.
     */
    output: Array<Sample.Output>;

    /**
     * The seed used for generating the sample.
     */
    seed: number;

    /**
     * The sampling temperature used.
     */
    temperature: number;

    /**
     * The top_p value used for sampling.
     */
    top_p: number;

    /**
     * Token usage details for the sample.
     */
    usage: Sample.Usage;
  }

  export namespace Sample {
    /**
     * An input message.
     */
    export interface Input {
      /**
       * The content of the message.
       */
      content: string;

      /**
       * The role of the message sender (e.g., system, user, developer).
       */
      role: string;
    }

    export interface Output {
      /**
       * The content of the message.
       */
      content?: string;

      /**
       * The role of the message (e.g. "system", "assistant", "user").
       */
      role?: string;
    }

    /**
     * Token usage details for the sample.
     */
    export interface Usage {
      /**
       * The number of tokens retrieved from cache.
       */
      cached_tokens: number;

      /**
       * The number of completion tokens generated.
       */
      completion_tokens: number;

      /**
       * The number of prompt tokens used.
       */
      prompt_tokens: number;

      /**
       * The total number of tokens used.
       */
      total_tokens: number;
    }
  }
}

/**
 * A schema representing an evaluation run output item.
 */
export interface OutputItemListResponse {
  /**
   * Unique identifier for the evaluation run output item.
   */
  id: string;

  /**
   * Unix timestamp (in seconds) when the evaluation run was created.
   */
  created_at: number;

  /**
   * Details of the input data source item.
   */
  datasource_item: Record<string, unknown>;

  /**
   * The identifier for the data source item.
   */
  datasource_item_id: number;

  /**
   * The identifier of the evaluation group.
   */
  eval_id: string;

  /**
   * The type of the object. Always "eval.run.output_item".
   */
  object: 'eval.run.output_item';

  /**
   * A list of results from the evaluation run.
   */
  results: Array<Record<string, unknown>>;

  /**
   * The identifier of the evaluation run associated with this output item.
   */
  run_id: string;

  /**
   * A sample containing the input and output of the evaluation run.
   */
  sample: OutputItemListResponse.Sample;

  /**
   * The status of the evaluation run.
   */
  status: string;
}

export namespace OutputItemListResponse {
  /**
   * A sample containing the input and output of the evaluation run.
   */
  export interface Sample {
    /**
     * An object representing an error response from the Eval API.
     */
    error: RunsAPI.EvalAPIError;

    /**
     * The reason why the sample generation was finished.
     */
    finish_reason: string;

    /**
     * An array of input messages.
     */
    input: Array<Sample.Input>;

    /**
     * The maximum number of tokens allowed for completion.
     */
    max_completion_tokens: number;

    /**
     * The model used for generating the sample.
     */
    model: string;

    /**
     * An array of output messages.
     */
    output: Array<Sample.Output>;

    /**
     * The seed used for generating the sample.
     */
    seed: number;

    /**
     * The sampling temperature used.
     */
    temperature: number;

    /**
     * The top_p value used for sampling.
     */
    top_p: number;

    /**
     * Token usage details for the sample.
     */
    usage: Sample.Usage;
  }

  export namespace Sample {
    /**
     * An input message.
     */
    export interface Input {
      /**
       * The content of the message.
       */
      content: string;

      /**
       * The role of the message sender (e.g., system, user, developer).
       */
      role: string;
    }

    export interface Output {
      /**
       * The content of the message.
       */
      content?: string;

      /**
       * The role of the message (e.g. "system", "assistant", "user").
       */
      role?: string;
    }

    /**
     * Token usage details for the sample.
     */
    export interface Usage {
      /**
       * The number of tokens retrieved from cache.
       */
      cached_tokens: number;

      /**
       * The number of completion tokens generated.
       */
      completion_tokens: number;

      /**
       * The number of prompt tokens used.
       */
      prompt_tokens: number;

      /**
       * The total number of tokens used.
       */
      total_tokens: number;
    }
  }
}

export interface OutputItemListParams extends CursorPageParams {
  /**
   * Sort order for output items by timestamp. Use `asc` for ascending order or
   * `desc` for descending order. Defaults to `asc`.
   */
  order?: 'asc' | 'desc';

  /**
   * Filter output items by status. Use `failed` to filter by failed output items or
   * `pass` to filter by passed output items.
   */
  status?: 'fail' | 'pass';
}

OutputItems.OutputItemListResponsesPage = OutputItemListResponsesPage;

export declare namespace OutputItems {
  export {
    type OutputItemRetrieveResponse as OutputItemRetrieveResponse,
    type OutputItemListResponse as OutputItemListResponse,
    OutputItemListResponsesPage as OutputItemListResponsesPage,
    type OutputItemListParams as OutputItemListParams,
  };
}

================================================================================
FILE: node_modules/fs-extra/lib/json/output-json-sync.js
================================================================================

'use strict'

const { stringify } = require('jsonfile/utils')
const { outputFileSync } = require('../output')

function outputJsonSync (file, data, options) {
  const str = stringify(data, options)

  outputFileSync(file, str, options)
}

module.exports = outputJsonSync

================================================================================
FILE: node_modules/fs-extra/lib/json/output-json.js
================================================================================

'use strict'

const { stringify } = require('jsonfile/utils')
const { outputFile } = require('../output')

async function outputJson (file, data, options = {}) {
  const str = stringify(data, options)

  await outputFile(file, str, options)
}

module.exports = outputJson

================================================================================
FILE: node_modules/@babel/runtime/helpers/regeneratorValues.js
================================================================================

var _typeof = require("./typeof.js")["default"];
function _regeneratorValues(e) {
  if (null != e) {
    var t = e["function" == typeof Symbol && Symbol.iterator || "@@iterator"],
      r = 0;
    if (t) return t.call(e);
    if ("function" == typeof e.next) return e;
    if (!isNaN(e.length)) return {
      next: function next() {
        return e && r >= e.length && (e = void 0), {
          value: e && e[r++],
          done: !e
        };
      }
    };
  }
  throw new TypeError(_typeof(e) + " is not iterable");
}
module.exports = _regeneratorValues, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/regeneratorRuntime.js
================================================================================

var OverloadYield = require("./OverloadYield.js");
var regenerator = require("./regenerator.js");
var regeneratorAsync = require("./regeneratorAsync.js");
var regeneratorAsyncGen = require("./regeneratorAsyncGen.js");
var regeneratorAsyncIterator = require("./regeneratorAsyncIterator.js");
var regeneratorKeys = require("./regeneratorKeys.js");
var regeneratorValues = require("./regeneratorValues.js");
function _regeneratorRuntime() {
  "use strict";

  var r = regenerator(),
    e = r.m(_regeneratorRuntime),
    t = (Object.getPrototypeOf ? Object.getPrototypeOf(e) : e.__proto__).constructor;
  function n(r) {
    var e = "function" == typeof r && r.constructor;
    return !!e && (e === t || "GeneratorFunction" === (e.displayName || e.name));
  }
  var o = {
    "throw": 1,
    "return": 2,
    "break": 3,
    "continue": 3
  };
  function a(r) {
    var e, t;
    return function (n) {
      e || (e = {
        stop: function stop() {
          return t(n.a, 2);
        },
        "catch": function _catch() {
          return n.v;
        },
        abrupt: function abrupt(r, e) {
          return t(n.a, o[r], e);
        },
        delegateYield: function delegateYield(r, o, a) {
          return e.resultName = o, t(n.d, regeneratorValues(r), a);
        },
        finish: function finish(r) {
          return t(n.f, r);
        }
      }, t = function t(r, _t, o) {
        n.p = e.prev, n.n = e.next;
        try {
          return r(_t, o);
        } finally {
          e.next = n.n;
        }
      }), e.resultName && (e[e.resultName] = n.v, e.resultName = void 0), e.sent = n.v, e.next = n.n;
      try {
        return r.call(this, e);
      } finally {
        n.p = e.prev, n.n = e.next;
      }
    };
  }
  return (module.exports = _regeneratorRuntime = function _regeneratorRuntime() {
    return {
      wrap: function wrap(e, t, n, o) {
        return r.w(a(e), t, n, o && o.reverse());
      },
      isGeneratorFunction: n,
      mark: r.m,
      awrap: function awrap(r, e) {
        return new OverloadYield(r, e);
      },
      AsyncIterator: regeneratorAsyncIterator,
      async: function async(r, e, t, o, u) {
        return (n(e) ? regeneratorAsyncGen : regeneratorAsync)(a(r), e, t, o, u);
      },
      keys: regeneratorKeys,
      values: regeneratorValues
    };
  }, module.exports.__esModule = true, module.exports["default"] = module.exports)();
}
module.exports = _regeneratorRuntime, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/regenerator.js
================================================================================

var regeneratorDefine = require("./regeneratorDefine.js");
function _regenerator() {
  /*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
  var e,
    t,
    r = "function" == typeof Symbol ? Symbol : {},
    n = r.iterator || "@@iterator",
    o = r.toStringTag || "@@toStringTag";
  function i(r, n, o, i) {
    var c = n && n.prototype instanceof Generator ? n : Generator,
      u = Object.create(c.prototype);
    return regeneratorDefine(u, "_invoke", function (r, n, o) {
      var i,
        c,
        u,
        f = 0,
        p = o || [],
        y = !1,
        G = {
          p: 0,
          n: 0,
          v: e,
          a: d,
          f: d.bind(e, 4),
          d: function d(t, r) {
            return i = t, c = 0, u = e, G.n = r, a;
          }
        };
      function d(r, n) {
        for (c = r, u = n, t = 0; !y && f && !o && t < p.length; t++) {
          var o,
            i = p[t],
            d = G.p,
            l = i[2];
          r > 3 ? (o = l === n) && (u = i[(c = i[4]) ? 5 : (c = 3, 3)], i[4] = i[5] = e) : i[0] <= d && ((o = r < 2 && d < i[1]) ? (c = 0, G.v = n, G.n = i[1]) : d < l && (o = r < 3 || i[0] > n || n > l) && (i[4] = r, i[5] = n, G.n = l, c = 0));
        }
        if (o || r > 1) return a;
        throw y = !0, n;
      }
      return function (o, p, l) {
        if (f > 1) throw TypeError("Generator is already running");
        for (y && 1 === p && d(p, l), c = p, u = l; (t = c < 2 ? e : u) || !y;) {
          i || (c ? c < 3 ? (c > 1 && (G.n = -1), d(c, u)) : G.n = u : G.v = u);
          try {
            if (f = 2, i) {
              if (c || (o = "next"), t = i[o]) {
                if (!(t = t.call(i, u))) throw TypeError("iterator result is not an object");
                if (!t.done) return t;
                u = t.value, c < 2 && (c = 0);
              } else 1 === c && (t = i["return"]) && t.call(i), c < 2 && (u = TypeError("The iterator does not provide a '" + o + "' method"), c = 1);
              i = e;
            } else if ((t = (y = G.n < 0) ? u : r.call(n, G)) !== a) break;
          } catch (t) {
            i = e, c = 1, u = t;
          } finally {
            f = 1;
          }
        }
        return {
          value: t,
          done: y
        };
      };
    }(r, o, i), !0), u;
  }
  var a = {};
  function Generator() {}
  function GeneratorFunction() {}
  function GeneratorFunctionPrototype() {}
  t = Object.getPrototypeOf;
  var c = [][n] ? t(t([][n]())) : (regeneratorDefine(t = {}, n, function () {
      return this;
    }), t),
    u = GeneratorFunctionPrototype.prototype = Generator.prototype = Object.create(c);
  function f(e) {
    return Object.setPrototypeOf ? Object.setPrototypeOf(e, GeneratorFunctionPrototype) : (e.__proto__ = GeneratorFunctionPrototype, regeneratorDefine(e, o, "GeneratorFunction")), e.prototype = Object.create(u), e;
  }
  return GeneratorFunction.prototype = GeneratorFunctionPrototype, regeneratorDefine(u, "constructor", GeneratorFunctionPrototype), regeneratorDefine(GeneratorFunctionPrototype, "constructor", GeneratorFunction), GeneratorFunction.displayName = "GeneratorFunction", regeneratorDefine(GeneratorFunctionPrototype, o, "GeneratorFunction"), regeneratorDefine(u), regeneratorDefine(u, o, "Generator"), regeneratorDefine(u, n, function () {
    return this;
  }), regeneratorDefine(u, "toString", function () {
    return "[object Generator]";
  }), (module.exports = _regenerator = function _regenerator() {
    return {
      w: i,
      m: f
    };
  }, module.exports.__esModule = true, module.exports["default"] = module.exports)();
}
module.exports = _regenerator, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/regeneratorDefine.js
================================================================================

function _regeneratorDefine(e, r, n, t) {
  var i = Object.defineProperty;
  try {
    i({}, "", {});
  } catch (e) {
    i = 0;
  }
  module.exports = _regeneratorDefine = function regeneratorDefine(e, r, n, t) {
    function o(r, n) {
      _regeneratorDefine(e, r, function (e) {
        return this._invoke(r, n, e);
      });
    }
    r ? i ? i(e, r, {
      value: n,
      enumerable: !t,
      configurable: !t,
      writable: !t
    }) : e[r] = n : (o("next", 0), o("throw", 1), o("return", 2));
  }, module.exports.__esModule = true, module.exports["default"] = module.exports, _regeneratorDefine(e, r, n, t);
}
module.exports = _regeneratorDefine, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/regeneratorAsyncGen.js
================================================================================

var regenerator = require("./regenerator.js");
var regeneratorAsyncIterator = require("./regeneratorAsyncIterator.js");
function _regeneratorAsyncGen(r, e, t, o, n) {
  return new regeneratorAsyncIterator(regenerator().w(r, e, t, o), n || Promise);
}
module.exports = _regeneratorAsyncGen, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/wrapAsyncGenerator.js
================================================================================

var OverloadYield = require("./OverloadYield.js");
function _wrapAsyncGenerator(e) {
  return function () {
    return new AsyncGenerator(e.apply(this, arguments));
  };
}
function AsyncGenerator(e) {
  var r, t;
  function resume(r, t) {
    try {
      var n = e[r](t),
        o = n.value,
        u = o instanceof OverloadYield;
      Promise.resolve(u ? o.v : o).then(function (t) {
        if (u) {
          var i = "return" === r ? "return" : "next";
          if (!o.k || t.done) return resume(i, t);
          t = e[i](t).value;
        }
        settle(n.done ? "return" : "normal", t);
      }, function (e) {
        resume("throw", e);
      });
    } catch (e) {
      settle("throw", e);
    }
  }
  function settle(e, n) {
    switch (e) {
      case "return":
        r.resolve({
          value: n,
          done: !0
        });
        break;
      case "throw":
        r.reject(n);
        break;
      default:
        r.resolve({
          value: n,
          done: !1
        });
    }
    (r = r.next) ? resume(r.key, r.arg) : t = null;
  }
  this._invoke = function (e, n) {
    return new Promise(function (o, u) {
      var i = {
        key: e,
        arg: n,
        resolve: o,
        reject: u,
        next: null
      };
      t ? t = t.next = i : (r = t = i, resume(e, n));
    });
  }, "function" != typeof e["return"] && (this["return"] = void 0);
}
AsyncGenerator.prototype["function" == typeof Symbol && Symbol.asyncIterator || "@@asyncIterator"] = function () {
  return this;
}, AsyncGenerator.prototype.next = function (e) {
  return this._invoke("next", e);
}, AsyncGenerator.prototype["throw"] = function (e) {
  return this._invoke("throw", e);
}, AsyncGenerator.prototype["return"] = function (e) {
  return this._invoke("return", e);
};
module.exports = _wrapAsyncGenerator, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/asyncToGenerator.js
================================================================================

function asyncGeneratorStep(n, t, e, r, o, a, c) {
  try {
    var i = n[a](c),
      u = i.value;
  } catch (n) {
    return void e(n);
  }
  i.done ? t(u) : Promise.resolve(u).then(r, o);
}
function _asyncToGenerator(n) {
  return function () {
    var t = this,
      e = arguments;
    return new Promise(function (r, o) {
      var a = n.apply(t, e);
      function _next(n) {
        asyncGeneratorStep(a, r, o, _next, _throw, "next", n);
      }
      function _throw(n) {
        asyncGeneratorStep(a, r, o, _next, _throw, "throw", n);
      }
      _next(void 0);
    });
  };
}
module.exports = _asyncToGenerator, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/asyncGeneratorDelegate.js
================================================================================

var OverloadYield = require("./OverloadYield.js");
function _asyncGeneratorDelegate(t) {
  var e = {},
    n = !1;
  function pump(e, r) {
    return n = !0, r = new Promise(function (n) {
      n(t[e](r));
    }), {
      done: !1,
      value: new OverloadYield(r, 1)
    };
  }
  return e["undefined" != typeof Symbol && Symbol.iterator || "@@iterator"] = function () {
    return this;
  }, e.next = function (t) {
    return n ? (n = !1, t) : pump("next", t);
  }, "function" == typeof t["throw"] && (e["throw"] = function (t) {
    if (n) throw n = !1, t;
    return pump("throw", t);
  }), "function" == typeof t["return"] && (e["return"] = function (t) {
    return n ? (n = !1, t) : pump("return", t);
  }), e;
}
module.exports = _asyncGeneratorDelegate, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/awaitAsyncGenerator.js
================================================================================

var OverloadYield = require("./OverloadYield.js");
function _awaitAsyncGenerator(e) {
  return new OverloadYield(e, 0);
}
module.exports = _awaitAsyncGenerator, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/regeneratorAsync.js
================================================================================

var regeneratorAsyncGen = require("./regeneratorAsyncGen.js");
function _regeneratorAsync(n, e, r, t, o) {
  var a = regeneratorAsyncGen(n, e, r, t, o);
  return a.next().then(function (n) {
    return n.done ? n.value : a.next();
  });
}
module.exports = _regeneratorAsync, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/regeneratorKeys.js
================================================================================

function _regeneratorKeys(e) {
  var n = Object(e),
    r = [];
  for (var t in n) r.unshift(t);
  return function e() {
    for (; r.length;) if ((t = r.pop()) in n) return e.value = t, e.done = !1, e;
    return e.done = !0, e;
  };
}
module.exports = _regeneratorKeys, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/regeneratorAsyncIterator.js
================================================================================

var OverloadYield = require("./OverloadYield.js");
var regeneratorDefine = require("./regeneratorDefine.js");
function AsyncIterator(t, e) {
  function n(r, o, i, f) {
    try {
      var c = t[r](o),
        u = c.value;
      return u instanceof OverloadYield ? e.resolve(u.v).then(function (t) {
        n("next", t, i, f);
      }, function (t) {
        n("throw", t, i, f);
      }) : e.resolve(u).then(function (t) {
        c.value = t, i(c);
      }, function (t) {
        return n("throw", t, i, f);
      });
    } catch (t) {
      f(t);
    }
  }
  var r;
  this.next || (regeneratorDefine(AsyncIterator.prototype), regeneratorDefine(AsyncIterator.prototype, "function" == typeof Symbol && Symbol.asyncIterator || "@asyncIterator", function () {
    return this;
  })), regeneratorDefine(this, "_invoke", function (t, o, i) {
    function f() {
      return new e(function (e, r) {
        n(t, i, e, r);
      });
    }
    return r = r ? r.then(f, f) : f();
  }, !0);
}
module.exports = AsyncIterator, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/skipFirstGeneratorNext.js
================================================================================

function _skipFirstGeneratorNext(t) {
  return function () {
    var r = t.apply(this, arguments);
    return r.next(), r;
  };
}
module.exports = _skipFirstGeneratorNext, module.exports.__esModule = true, module.exports["default"] = module.exports;
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regeneratorValues.js
================================================================================

import _typeof from "./typeof.js";
function _regeneratorValues(e) {
  if (null != e) {
    var t = e["function" == typeof Symbol && Symbol.iterator || "@@iterator"],
      r = 0;
    if (t) return t.call(e);
    if ("function" == typeof e.next) return e;
    if (!isNaN(e.length)) return {
      next: function next() {
        return e && r >= e.length && (e = void 0), {
          value: e && e[r++],
          done: !e
        };
      }
    };
  }
  throw new TypeError(_typeof(e) + " is not iterable");
}
export { _regeneratorValues as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js
================================================================================

import OverloadYield from "./OverloadYield.js";
import regenerator from "./regenerator.js";
import regeneratorAsync from "./regeneratorAsync.js";
import regeneratorAsyncGen from "./regeneratorAsyncGen.js";
import regeneratorAsyncIterator from "./regeneratorAsyncIterator.js";
import regeneratorKeys from "./regeneratorKeys.js";
import regeneratorValues from "./regeneratorValues.js";
function _regeneratorRuntime() {
  "use strict";

  var r = regenerator(),
    e = r.m(_regeneratorRuntime),
    t = (Object.getPrototypeOf ? Object.getPrototypeOf(e) : e.__proto__).constructor;
  function n(r) {
    var e = "function" == typeof r && r.constructor;
    return !!e && (e === t || "GeneratorFunction" === (e.displayName || e.name));
  }
  var o = {
    "throw": 1,
    "return": 2,
    "break": 3,
    "continue": 3
  };
  function a(r) {
    var e, t;
    return function (n) {
      e || (e = {
        stop: function stop() {
          return t(n.a, 2);
        },
        "catch": function _catch() {
          return n.v;
        },
        abrupt: function abrupt(r, e) {
          return t(n.a, o[r], e);
        },
        delegateYield: function delegateYield(r, o, a) {
          return e.resultName = o, t(n.d, regeneratorValues(r), a);
        },
        finish: function finish(r) {
          return t(n.f, r);
        }
      }, t = function t(r, _t, o) {
        n.p = e.prev, n.n = e.next;
        try {
          return r(_t, o);
        } finally {
          e.next = n.n;
        }
      }), e.resultName && (e[e.resultName] = n.v, e.resultName = void 0), e.sent = n.v, e.next = n.n;
      try {
        return r.call(this, e);
      } finally {
        n.p = e.prev, n.n = e.next;
      }
    };
  }
  return (_regeneratorRuntime = function _regeneratorRuntime() {
    return {
      wrap: function wrap(e, t, n, o) {
        return r.w(a(e), t, n, o && o.reverse());
      },
      isGeneratorFunction: n,
      mark: r.m,
      awrap: function awrap(r, e) {
        return new OverloadYield(r, e);
      },
      AsyncIterator: regeneratorAsyncIterator,
      async: function async(r, e, t, o, u) {
        return (n(e) ? regeneratorAsyncGen : regeneratorAsync)(a(r), e, t, o, u);
      },
      keys: regeneratorKeys,
      values: regeneratorValues
    };
  })();
}
export { _regeneratorRuntime as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regenerator.js
================================================================================

import regeneratorDefine from "./regeneratorDefine.js";
function _regenerator() {
  /*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
  var e,
    t,
    r = "function" == typeof Symbol ? Symbol : {},
    n = r.iterator || "@@iterator",
    o = r.toStringTag || "@@toStringTag";
  function i(r, n, o, i) {
    var c = n && n.prototype instanceof Generator ? n : Generator,
      u = Object.create(c.prototype);
    return regeneratorDefine(u, "_invoke", function (r, n, o) {
      var i,
        c,
        u,
        f = 0,
        p = o || [],
        y = !1,
        G = {
          p: 0,
          n: 0,
          v: e,
          a: d,
          f: d.bind(e, 4),
          d: function d(t, r) {
            return i = t, c = 0, u = e, G.n = r, a;
          }
        };
      function d(r, n) {
        for (c = r, u = n, t = 0; !y && f && !o && t < p.length; t++) {
          var o,
            i = p[t],
            d = G.p,
            l = i[2];
          r > 3 ? (o = l === n) && (u = i[(c = i[4]) ? 5 : (c = 3, 3)], i[4] = i[5] = e) : i[0] <= d && ((o = r < 2 && d < i[1]) ? (c = 0, G.v = n, G.n = i[1]) : d < l && (o = r < 3 || i[0] > n || n > l) && (i[4] = r, i[5] = n, G.n = l, c = 0));
        }
        if (o || r > 1) return a;
        throw y = !0, n;
      }
      return function (o, p, l) {
        if (f > 1) throw TypeError("Generator is already running");
        for (y && 1 === p && d(p, l), c = p, u = l; (t = c < 2 ? e : u) || !y;) {
          i || (c ? c < 3 ? (c > 1 && (G.n = -1), d(c, u)) : G.n = u : G.v = u);
          try {
            if (f = 2, i) {
              if (c || (o = "next"), t = i[o]) {
                if (!(t = t.call(i, u))) throw TypeError("iterator result is not an object");
                if (!t.done) return t;
                u = t.value, c < 2 && (c = 0);
              } else 1 === c && (t = i["return"]) && t.call(i), c < 2 && (u = TypeError("The iterator does not provide a '" + o + "' method"), c = 1);
              i = e;
            } else if ((t = (y = G.n < 0) ? u : r.call(n, G)) !== a) break;
          } catch (t) {
            i = e, c = 1, u = t;
          } finally {
            f = 1;
          }
        }
        return {
          value: t,
          done: y
        };
      };
    }(r, o, i), !0), u;
  }
  var a = {};
  function Generator() {}
  function GeneratorFunction() {}
  function GeneratorFunctionPrototype() {}
  t = Object.getPrototypeOf;
  var c = [][n] ? t(t([][n]())) : (regeneratorDefine(t = {}, n, function () {
      return this;
    }), t),
    u = GeneratorFunctionPrototype.prototype = Generator.prototype = Object.create(c);
  function f(e) {
    return Object.setPrototypeOf ? Object.setPrototypeOf(e, GeneratorFunctionPrototype) : (e.__proto__ = GeneratorFunctionPrototype, regeneratorDefine(e, o, "GeneratorFunction")), e.prototype = Object.create(u), e;
  }
  return GeneratorFunction.prototype = GeneratorFunctionPrototype, regeneratorDefine(u, "constructor", GeneratorFunctionPrototype), regeneratorDefine(GeneratorFunctionPrototype, "constructor", GeneratorFunction), GeneratorFunction.displayName = "GeneratorFunction", regeneratorDefine(GeneratorFunctionPrototype, o, "GeneratorFunction"), regeneratorDefine(u), regeneratorDefine(u, o, "Generator"), regeneratorDefine(u, n, function () {
    return this;
  }), regeneratorDefine(u, "toString", function () {
    return "[object Generator]";
  }), (_regenerator = function _regenerator() {
    return {
      w: i,
      m: f
    };
  })();
}
export { _regenerator as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regeneratorDefine.js
================================================================================

function _regeneratorDefine(e, r, n, t) {
  var i = Object.defineProperty;
  try {
    i({}, "", {});
  } catch (e) {
    i = 0;
  }
  _regeneratorDefine = function regeneratorDefine(e, r, n, t) {
    function o(r, n) {
      _regeneratorDefine(e, r, function (e) {
        return this._invoke(r, n, e);
      });
    }
    r ? i ? i(e, r, {
      value: n,
      enumerable: !t,
      configurable: !t,
      writable: !t
    }) : e[r] = n : (o("next", 0), o("throw", 1), o("return", 2));
  }, _regeneratorDefine(e, r, n, t);
}
export { _regeneratorDefine as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regeneratorAsyncGen.js
================================================================================

import regenerator from "./regenerator.js";
import regeneratorAsyncIterator from "./regeneratorAsyncIterator.js";
function _regeneratorAsyncGen(r, e, t, o, n) {
  return new regeneratorAsyncIterator(regenerator().w(r, e, t, o), n || Promise);
}
export { _regeneratorAsyncGen as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/wrapAsyncGenerator.js
================================================================================

import OverloadYield from "./OverloadYield.js";
function _wrapAsyncGenerator(e) {
  return function () {
    return new AsyncGenerator(e.apply(this, arguments));
  };
}
function AsyncGenerator(e) {
  var r, t;
  function resume(r, t) {
    try {
      var n = e[r](t),
        o = n.value,
        u = o instanceof OverloadYield;
      Promise.resolve(u ? o.v : o).then(function (t) {
        if (u) {
          var i = "return" === r ? "return" : "next";
          if (!o.k || t.done) return resume(i, t);
          t = e[i](t).value;
        }
        settle(n.done ? "return" : "normal", t);
      }, function (e) {
        resume("throw", e);
      });
    } catch (e) {
      settle("throw", e);
    }
  }
  function settle(e, n) {
    switch (e) {
      case "return":
        r.resolve({
          value: n,
          done: !0
        });
        break;
      case "throw":
        r.reject(n);
        break;
      default:
        r.resolve({
          value: n,
          done: !1
        });
    }
    (r = r.next) ? resume(r.key, r.arg) : t = null;
  }
  this._invoke = function (e, n) {
    return new Promise(function (o, u) {
      var i = {
        key: e,
        arg: n,
        resolve: o,
        reject: u,
        next: null
      };
      t ? t = t.next = i : (r = t = i, resume(e, n));
    });
  }, "function" != typeof e["return"] && (this["return"] = void 0);
}
AsyncGenerator.prototype["function" == typeof Symbol && Symbol.asyncIterator || "@@asyncIterator"] = function () {
  return this;
}, AsyncGenerator.prototype.next = function (e) {
  return this._invoke("next", e);
}, AsyncGenerator.prototype["throw"] = function (e) {
  return this._invoke("throw", e);
}, AsyncGenerator.prototype["return"] = function (e) {
  return this._invoke("return", e);
};
export { _wrapAsyncGenerator as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js
================================================================================

function asyncGeneratorStep(n, t, e, r, o, a, c) {
  try {
    var i = n[a](c),
      u = i.value;
  } catch (n) {
    return void e(n);
  }
  i.done ? t(u) : Promise.resolve(u).then(r, o);
}
function _asyncToGenerator(n) {
  return function () {
    var t = this,
      e = arguments;
    return new Promise(function (r, o) {
      var a = n.apply(t, e);
      function _next(n) {
        asyncGeneratorStep(a, r, o, _next, _throw, "next", n);
      }
      function _throw(n) {
        asyncGeneratorStep(a, r, o, _next, _throw, "throw", n);
      }
      _next(void 0);
    });
  };
}
export { _asyncToGenerator as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/asyncGeneratorDelegate.js
================================================================================

import OverloadYield from "./OverloadYield.js";
function _asyncGeneratorDelegate(t) {
  var e = {},
    n = !1;
  function pump(e, r) {
    return n = !0, r = new Promise(function (n) {
      n(t[e](r));
    }), {
      done: !1,
      value: new OverloadYield(r, 1)
    };
  }
  return e["undefined" != typeof Symbol && Symbol.iterator || "@@iterator"] = function () {
    return this;
  }, e.next = function (t) {
    return n ? (n = !1, t) : pump("next", t);
  }, "function" == typeof t["throw"] && (e["throw"] = function (t) {
    if (n) throw n = !1, t;
    return pump("throw", t);
  }), "function" == typeof t["return"] && (e["return"] = function (t) {
    return n ? (n = !1, t) : pump("return", t);
  }), e;
}
export { _asyncGeneratorDelegate as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/awaitAsyncGenerator.js
================================================================================

import OverloadYield from "./OverloadYield.js";
function _awaitAsyncGenerator(e) {
  return new OverloadYield(e, 0);
}
export { _awaitAsyncGenerator as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regeneratorAsync.js
================================================================================

import regeneratorAsyncGen from "./regeneratorAsyncGen.js";
function _regeneratorAsync(n, e, r, t, o) {
  var a = regeneratorAsyncGen(n, e, r, t, o);
  return a.next().then(function (n) {
    return n.done ? n.value : a.next();
  });
}
export { _regeneratorAsync as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regeneratorKeys.js
================================================================================

function _regeneratorKeys(e) {
  var n = Object(e),
    r = [];
  for (var t in n) r.unshift(t);
  return function e() {
    for (; r.length;) if ((t = r.pop()) in n) return e.value = t, e.done = !1, e;
    return e.done = !0, e;
  };
}
export { _regeneratorKeys as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/regeneratorAsyncIterator.js
================================================================================

import OverloadYield from "./OverloadYield.js";
import regeneratorDefine from "./regeneratorDefine.js";
function AsyncIterator(t, e) {
  function n(r, o, i, f) {
    try {
      var c = t[r](o),
        u = c.value;
      return u instanceof OverloadYield ? e.resolve(u.v).then(function (t) {
        n("next", t, i, f);
      }, function (t) {
        n("throw", t, i, f);
      }) : e.resolve(u).then(function (t) {
        c.value = t, i(c);
      }, function (t) {
        return n("throw", t, i, f);
      });
    } catch (t) {
      f(t);
    }
  }
  var r;
  this.next || (regeneratorDefine(AsyncIterator.prototype), regeneratorDefine(AsyncIterator.prototype, "function" == typeof Symbol && Symbol.asyncIterator || "@asyncIterator", function () {
    return this;
  })), regeneratorDefine(this, "_invoke", function (t, o, i) {
    function f() {
      return new e(function (e, r) {
        n(t, i, e, r);
      });
    }
    return r = r ? r.then(f, f) : f();
  }, !0);
}
export { AsyncIterator as default };
================================================================================
FILE: node_modules/@babel/runtime/helpers/esm/skipFirstGeneratorNext.js
================================================================================

function _skipFirstGeneratorNext(t) {
  return function () {
    var r = t.apply(this, arguments);
    return r.next(), r;
  };
}
export { _skipFirstGeneratorNext as default };
================================================================================
FILE: node_modules/source-map/lib/source-map-generator.js
================================================================================

/* -*- Mode: js; js-indent-level: 2; -*- */
/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */

var base64VLQ = require('./base64-vlq');
var util = require('./util');
var ArraySet = require('./array-set').ArraySet;
var MappingList = require('./mapping-list').MappingList;

/**
 * An instance of the SourceMapGenerator represents a source map which is
 * being built incrementally. You may pass an object with the following
 * properties:
 *
 *   - file: The filename of the generated source.
 *   - sourceRoot: A root for all relative URLs in this source map.
 */
function SourceMapGenerator(aArgs) {
  if (!aArgs) {
    aArgs = {};
  }
  this._file = util.getArg(aArgs, 'file', null);
  this._sourceRoot = util.getArg(aArgs, 'sourceRoot', null);
  this._skipValidation = util.getArg(aArgs, 'skipValidation', false);
  this._sources = new ArraySet();
  this._names = new ArraySet();
  this._mappings = new MappingList();
  this._sourcesContents = null;
}

SourceMapGenerator.prototype._version = 3;

/**
 * Creates a new SourceMapGenerator based on a SourceMapConsumer
 *
 * @param aSourceMapConsumer The SourceMap.
 */
SourceMapGenerator.fromSourceMap =
  function SourceMapGenerator_fromSourceMap(aSourceMapConsumer) {
    var sourceRoot = aSourceMapConsumer.sourceRoot;
    var generator = new SourceMapGenerator({
      file: aSourceMapConsumer.file,
      sourceRoot: sourceRoot
    });
    aSourceMapConsumer.eachMapping(function (mapping) {
      var newMapping = {
        generated: {
          line: mapping.generatedLine,
          column: mapping.generatedColumn
        }
      };

      if (mapping.source != null) {
        newMapping.source = mapping.source;
        if (sourceRoot != null) {
          newMapping.source = util.relative(sourceRoot, newMapping.source);
        }

        newMapping.original = {
          line: mapping.originalLine,
          column: mapping.originalColumn
        };

        if (mapping.name != null) {
          newMapping.name = mapping.name;
        }
      }

      generator.addMapping(newMapping);
    });
    aSourceMapConsumer.sources.forEach(function (sourceFile) {
      var sourceRelative = sourceFile;
      if (sourceRoot !== null) {
        sourceRelative = util.relative(sourceRoot, sourceFile);
      }

      if (!generator._sources.has(sourceRelative)) {
        generator._sources.add(sourceRelative);
      }

      var content = aSourceMapConsumer.sourceContentFor(sourceFile);
      if (content != null) {
        generator.setSourceContent(sourceFile, content);
      }
    });
    return generator;
  };

/**
 * Add a single mapping from original source line and column to the generated
 * source's line and column for this source map being created. The mapping
 * object should have the following properties:
 *
 *   - generated: An object with the generated line and column positions.
 *   - original: An object with the original line and column positions.
 *   - source: The original source file (relative to the sourceRoot).
 *   - name: An optional original token name for this mapping.
 */
SourceMapGenerator.prototype.addMapping =
  function SourceMapGenerator_addMapping(aArgs) {
    var generated = util.getArg(aArgs, 'generated');
    var original = util.getArg(aArgs, 'original', null);
    var source = util.getArg(aArgs, 'source', null);
    var name = util.getArg(aArgs, 'name', null);

    if (!this._skipValidation) {
      this._validateMapping(generated, original, source, name);
    }

    if (source != null) {
      source = String(source);
      if (!this._sources.has(source)) {
        this._sources.add(source);
      }
    }

    if (name != null) {
      name = String(name);
      if (!this._names.has(name)) {
        this._names.add(name);
      }
    }

    this._mappings.add({
      generatedLine: generated.line,
      generatedColumn: generated.column,
      originalLine: original != null && original.line,
      originalColumn: original != null && original.column,
      source: source,
      name: name
    });
  };

/**
 * Set the source content for a source file.
 */
SourceMapGenerator.prototype.setSourceContent =
  function SourceMapGenerator_setSourceContent(aSourceFile, aSourceContent) {
    var source = aSourceFile;
    if (this._sourceRoot != null) {
      source = util.relative(this._sourceRoot, source);
    }

    if (aSourceContent != null) {
      // Add the source content to the _sourcesContents map.
      // Create a new _sourcesContents map if the property is null.
      if (!this._sourcesContents) {
        this._sourcesContents = Object.create(null);
      }
      this._sourcesContents[util.toSetString(source)] = aSourceContent;
    } else if (this._sourcesContents) {
      // Remove the source file from the _sourcesContents map.
      // If the _sourcesContents map is empty, set the property to null.
      delete this._sourcesContents[util.toSetString(source)];
      if (Object.keys(this._sourcesContents).length === 0) {
        this._sourcesContents = null;
      }
    }
  };

/**
 * Applies the mappings of a sub-source-map for a specific source file to the
 * source map being generated. Each mapping to the supplied source file is
 * rewritten using the supplied source map. Note: The resolution for the
 * resulting mappings is the minimium of this map and the supplied map.
 *
 * @param aSourceMapConsumer The source map to be applied.
 * @param aSourceFile Optional. The filename of the source file.
 *        If omitted, SourceMapConsumer's file property will be used.
 * @param aSourceMapPath Optional. The dirname of the path to the source map
 *        to be applied. If relative, it is relative to the SourceMapConsumer.
 *        This parameter is needed when the two source maps aren't in the same
 *        directory, and the source map to be applied contains relative source
 *        paths. If so, those relative source paths need to be rewritten
 *        relative to the SourceMapGenerator.
 */
SourceMapGenerator.prototype.applySourceMap =
  function SourceMapGenerator_applySourceMap(aSourceMapConsumer, aSourceFile, aSourceMapPath) {
    var sourceFile = aSourceFile;
    // If aSourceFile is omitted, we will use the file property of the SourceMap
    if (aSourceFile == null) {
      if (aSourceMapConsumer.file == null) {
        throw new Error(
          'SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, ' +
          'or the source map\'s "file" property. Both were omitted.'
        );
      }
      sourceFile = aSourceMapConsumer.file;
    }
    var sourceRoot = this._sourceRoot;
    // Make "sourceFile" relative if an absolute Url is passed.
    if (sourceRoot != null) {
      sourceFile = util.relative(sourceRoot, sourceFile);
    }
    // Applying the SourceMap can add and remove items from the sources and
    // the names array.
    var newSources = new ArraySet();
    var newNames = new ArraySet();

    // Find mappings for the "sourceFile"
    this._mappings.unsortedForEach(function (mapping) {
      if (mapping.source === sourceFile && mapping.originalLine != null) {
        // Check if it can be mapped by the source map, then update the mapping.
        var original = aSourceMapConsumer.originalPositionFor({
          line: mapping.originalLine,
          column: mapping.originalColumn
        });
        if (original.source != null) {
          // Copy mapping
          mapping.source = original.source;
          if (aSourceMapPath != null) {
            mapping.source = util.join(aSourceMapPath, mapping.source)
          }
          if (sourceRoot != null) {
            mapping.source = util.relative(sourceRoot, mapping.source);
          }
          mapping.originalLine = original.line;
          mapping.originalColumn = original.column;
          if (original.name != null) {
            mapping.name = original.name;
          }
        }
      }

      var source = mapping.source;
      if (source != null && !newSources.has(source)) {
        newSources.add(source);
      }

      var name = mapping.name;
      if (name != null && !newNames.has(name)) {
        newNames.add(name);
      }

    }, this);
    this._sources = newSources;
    this._names = newNames;

    // Copy sourcesContents of applied map.
    aSourceMapConsumer.sources.forEach(function (sourceFile) {
      var content = aSourceMapConsumer.sourceContentFor(sourceFile);
      if (content != null) {
        if (aSourceMapPath != null) {
          sourceFile = util.join(aSourceMapPath, sourceFile);
        }
        if (sourceRoot != null) {
          sourceFile = util.relative(sourceRoot, sourceFile);
        }
        this.setSourceContent(sourceFile, content);
      }
    }, this);
  };

/**
 * A mapping can have one of the three levels of data:
 *
 *   1. Just the generated position.
 *   2. The Generated position, original position, and original source.
 *   3. Generated and original position, original source, as well as a name
 *      token.
 *
 * To maintain consistency, we validate that any new mapping being added falls
 * in to one of these categories.
 */
SourceMapGenerator.prototype._validateMapping =
  function SourceMapGenerator_validateMapping(aGenerated, aOriginal, aSource,
                                              aName) {
    // When aOriginal is truthy but has empty values for .line and .column,
    // it is most likely a programmer error. In this case we throw a very
    // specific error message to try to guide them the right way.
    // For example: https://github.com/Polymer/polymer-bundler/pull/519
    if (aOriginal && typeof aOriginal.line !== 'number' && typeof aOriginal.column !== 'number') {
        throw new Error(
            'original.line and original.column are not numbers -- you probably meant to omit ' +
            'the original mapping entirely and only map the generated position. If so, pass ' +
            'null for the original mapping instead of an object with empty or null values.'
        );
    }

    if (aGenerated && 'line' in aGenerated && 'column' in aGenerated
        && aGenerated.line > 0 && aGenerated.column >= 0
        && !aOriginal && !aSource && !aName) {
      // Case 1.
      return;
    }
    else if (aGenerated && 'line' in aGenerated && 'column' in aGenerated
             && aOriginal && 'line' in aOriginal && 'column' in aOriginal
             && aGenerated.line > 0 && aGenerated.column >= 0
             && aOriginal.line > 0 && aOriginal.column >= 0
             && aSource) {
      // Cases 2 and 3.
      return;
    }
    else {
      throw new Error('Invalid mapping: ' + JSON.stringify({
        generated: aGenerated,
        source: aSource,
        original: aOriginal,
        name: aName
      }));
    }
  };

/**
 * Serialize the accumulated mappings in to the stream of base 64 VLQs
 * specified by the source map format.
 */
SourceMapGenerator.prototype._serializeMappings =
  function SourceMapGenerator_serializeMappings() {
    var previousGeneratedColumn = 0;
    var previousGeneratedLine = 1;
    var previousOriginalColumn = 0;
    var previousOriginalLine = 0;
    var previousName = 0;
    var previousSource = 0;
    var result = '';
    var next;
    var mapping;
    var nameIdx;
    var sourceIdx;

    var mappings = this._mappings.toArray();
    for (var i = 0, len = mappings.length; i < len; i++) {
      mapping = mappings[i];
      next = ''

      if (mapping.generatedLine !== previousGeneratedLine) {
        previousGeneratedColumn = 0;
        while (mapping.generatedLine !== previousGeneratedLine) {
          next += ';';
          previousGeneratedLine++;
        }
      }
      else {
        if (i > 0) {
          if (!util.compareByGeneratedPositionsInflated(mapping, mappings[i - 1])) {
            continue;
          }
          next += ',';
        }
      }

      next += base64VLQ.encode(mapping.generatedColumn
                                 - previousGeneratedColumn);
      previousGeneratedColumn = mapping.generatedColumn;

      if (mapping.source != null) {
        sourceIdx = this._sources.indexOf(mapping.source);
        next += base64VLQ.encode(sourceIdx - previousSource);
        previousSource = sourceIdx;

        // lines are stored 0-based in SourceMap spec version 3
        next += base64VLQ.encode(mapping.originalLine - 1
                                   - previousOriginalLine);
        previousOriginalLine = mapping.originalLine - 1;

        next += base64VLQ.encode(mapping.originalColumn
                                   - previousOriginalColumn);
        previousOriginalColumn = mapping.originalColumn;

        if (mapping.name != null) {
          nameIdx = this._names.indexOf(mapping.name);
          next += base64VLQ.encode(nameIdx - previousName);
          previousName = nameIdx;
        }
      }

      result += next;
    }

    return result;
  };

SourceMapGenerator.prototype._generateSourcesContent =
  function SourceMapGenerator_generateSourcesContent(aSources, aSourceRoot) {
    return aSources.map(function (source) {
      if (!this._sourcesContents) {
        return null;
      }
      if (aSourceRoot != null) {
        source = util.relative(aSourceRoot, source);
      }
      var key = util.toSetString(source);
      return Object.prototype.hasOwnProperty.call(this._sourcesContents, key)
        ? this._sourcesContents[key]
        : null;
    }, this);
  };

/**
 * Externalize the source map.
 */
SourceMapGenerator.prototype.toJSON =
  function SourceMapGenerator_toJSON() {
    var map = {
      version: this._version,
      sources: this._sources.toArray(),
      names: this._names.toArray(),
      mappings: this._serializeMappings()
    };
    if (this._file != null) {
      map.file = this._file;
    }
    if (this._sourceRoot != null) {
      map.sourceRoot = this._sourceRoot;
    }
    if (this._sourcesContents) {
      map.sourcesContent = this._generateSourcesContent(map.sources, map.sourceRoot);
    }

    return map;
  };

/**
 * Render the source map being generated to a string.
 */
SourceMapGenerator.prototype.toString =
  function SourceMapGenerator_toString() {
    return JSON.stringify(this.toJSON());
  };

exports.SourceMapGenerator = SourceMapGenerator;

================================================================================
FILE: node_modules/pkg/dictionary/exiftool.exe.js
================================================================================

'use strict';

module.exports = {
  pkg: {
    patches: {
      'index.js': [
        "path.join(__dirname, 'vendor', 'exiftool.exe')",
        "path.join(path.dirname(process.execPath), 'exiftool.exe')",
      ],
    },
    deployFiles: [['vendor/exiftool.exe', 'exiftool.exe']],
  },
};

================================================================================
FILE: node_modules/pkg/dictionary/markdown.js
================================================================================

'use strict';

module.exports = {};

================================================================================
FILE: node_modules/pkg/dictionary/exiftool.pl.js
================================================================================

'use strict';

module.exports = {
  pkg: {
    patches: {
      'index.js': [
        "path.join(__dirname, 'vendor', 'exiftool')",
        "path.join(path.dirname(process.execPath), 'exiftool')",
      ],
    },
    deployFiles: [['vendor/exiftool', 'exiftool']],
  },
};

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/generators/identifier-names-generators/AbstractIdentifierNamesGenerator.d.ts
================================================================================

import { TNodeWithLexicalScope } from '../../types/node/TNodeWithLexicalScope';
import { IIdentifierNamesGenerator } from '../../interfaces/generators/identifier-names-generators/IIdentifierNamesGenerator';
import { IOptions } from '../../interfaces/options/IOptions';
import { IRandomGenerator } from '../../interfaces/utils/IRandomGenerator';
export declare abstract class AbstractIdentifierNamesGenerator implements IIdentifierNamesGenerator {
    protected readonly options: IOptions;
    protected readonly randomGenerator: IRandomGenerator;
    protected readonly preservedNamesSet: Set<string>;
    protected readonly lexicalScopesPreservedNamesMap: WeakMap<TNodeWithLexicalScope, Set<string>>;
    constructor(randomGenerator: IRandomGenerator, options: IOptions);
    generate(lexicalScopeNode: TNodeWithLexicalScope, nameLength?: number): string;
    preserveName(name: string): void;
    preserveNameForLexicalScope(name: string, lexicalScopeNode: TNodeWithLexicalScope): void;
    isValidIdentifierName(name: string): boolean;
    isValidIdentifierNameInLexicalScopes(name: string, lexicalScopeNodes: TNodeWithLexicalScope[]): boolean;
    private isReservedName;
    abstract generateForGlobalScope(nameLength?: number): string;
    abstract generateForLexicalScope(lexicalScopeNode: TNodeWithLexicalScope, nameLength?: number): string;
    abstract generateForLabel(label: string, nameLength?: number): string;
    abstract generateNext(nameLength?: number): string;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/generators/identifier-names-generators/MangledShuffledIdentifierNamesGenerator.d.ts
================================================================================

import { IArrayUtils } from '../../interfaces/utils/IArrayUtils';
import { IOptions } from '../../interfaces/options/IOptions';
import { IRandomGenerator } from '../../interfaces/utils/IRandomGenerator';
import { ISetUtils } from '../../interfaces/utils/ISetUtils';
import { MangledIdentifierNamesGenerator } from './MangledIdentifierNamesGenerator';
export declare class MangledShuffledIdentifierNamesGenerator extends MangledIdentifierNamesGenerator {
    protected static shuffledNameSequence: string[];
    private readonly arrayUtils;
    constructor(arrayUtils: IArrayUtils, randomGenerator: IRandomGenerator, options: IOptions, setUtils: ISetUtils);
    initialize(): void;
    protected initializeNameSequence(nameSequence: string[]): void;
    protected getNameSequence(): string[];
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/generators/identifier-names-generators/DictionaryIdentifierNamesGenerator.d.ts
================================================================================

import { IArrayUtils } from '../../interfaces/utils/IArrayUtils';
import { IOptions } from '../../interfaces/options/IOptions';
import { IRandomGenerator } from '../../interfaces/utils/IRandomGenerator';
import { AbstractIdentifierNamesGenerator } from './AbstractIdentifierNamesGenerator';
import { TNodeWithLexicalScope } from '../../types/node/TNodeWithLexicalScope';
export declare class DictionaryIdentifierNamesGenerator extends AbstractIdentifierNamesGenerator {
    private readonly arrayUtils;
    private identifierNamesSet;
    private identifiersIterator;
    constructor(randomGenerator: IRandomGenerator, options: IOptions, arrayUtils: IArrayUtils);
    private static incrementIdentifierName;
    generateNext(): string;
    generateForGlobalScope(): string;
    generateForLexicalScope(lexicalScopeNode: TNodeWithLexicalScope): string;
    generateForLabel(label: string): string;
    private generateNewDictionaryName;
    private getInitialIdentifierNames;
    private getIncrementedIdentifierNames;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/generators/identifier-names-generators/MangledIdentifierNamesGenerator.d.ts
================================================================================

import { TNodeWithLexicalScope } from '../../types/node/TNodeWithLexicalScope';
import { IOptions } from '../../interfaces/options/IOptions';
import { IRandomGenerator } from '../../interfaces/utils/IRandomGenerator';
import { ISetUtils } from '../../interfaces/utils/ISetUtils';
import { AbstractIdentifierNamesGenerator } from './AbstractIdentifierNamesGenerator';
export declare class MangledIdentifierNamesGenerator extends AbstractIdentifierNamesGenerator {
    private static readonly maxRegenerationAttempts;
    private static readonly initMangledNameCharacter;
    private static readonly nameSequence;
    private static readonly reservedNamesSet;
    private lastMangledName;
    private readonly lastMangledNameForScopeMap;
    private readonly lastMangledNameForLabelMap;
    private readonly setUtils;
    constructor(randomGenerator: IRandomGenerator, options: IOptions, setUtils: ISetUtils);
    generateNext(nameLength?: number): string;
    generateForGlobalScope(nameLength?: number): string;
    generateForLexicalScope(lexicalScopeNode: TNodeWithLexicalScope, nameLength?: number): string;
    generateForLabel(label: string, nameLength?: number): string;
    isIncrementedMangledName(nextName: string, prevName: string): boolean;
    isValidIdentifierName(mangledName: string): boolean;
    protected getNameSequence(): string[];
    protected updatePreviousMangledName(name: string): void;
    protected updatePreviousMangledNameForLabel(name: string, label: string, lastMangledNameForLabel: string): void;
    protected generateNewMangledName(previousMangledName: string, validationFunction?: (newIdentifierName: string) => boolean): string;
    private getLastMangledNameForScopes;
    private getLastMangledNameForLabel;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/generators/identifier-names-generators/HexadecimalIdentifierNamesGenerator.d.ts
================================================================================

import { TNodeWithLexicalScope } from '../../types/node/TNodeWithLexicalScope';
import { IOptions } from '../../interfaces/options/IOptions';
import { IRandomGenerator } from '../../interfaces/utils/IRandomGenerator';
import { AbstractIdentifierNamesGenerator } from './AbstractIdentifierNamesGenerator';
export declare class HexadecimalIdentifierNamesGenerator extends AbstractIdentifierNamesGenerator {
    private static readonly baseIdentifierNameLength;
    constructor(randomGenerator: IRandomGenerator, options: IOptions);
    generateNext(nameLength?: number): string;
    generateForGlobalScope(nameLength?: number): string;
    generateForLexicalScope(lexicalScopeNode: TNodeWithLexicalScope, nameLength?: number): string;
    generateForLabel(label: string, nameLength?: number): string;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/interfaces/IGeneratorOutput.d.ts
================================================================================

export interface IGeneratorOutput {
    code: string;
    map: string;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/interfaces/generators/identifier-names-generators/IIdentifierNamesGenerator.d.ts
================================================================================

import { TNodeWithLexicalScope } from '../../../types/node/TNodeWithLexicalScope';
export interface IIdentifierNamesGenerator {
    generate(lexicalScopeNode: TNodeWithLexicalScope, nameLength?: number): string;
    generateForGlobalScope(nameLength?: number): string;
    generateForLexicalScope(lexicalScopeNode: TNodeWithLexicalScope, nameLength?: number): string;
    generateForLabel(label: string, nameLength?: number): string;
    generateNext(nameLength?: number): string;
    isValidIdentifierName(identifierName: string): boolean;
    isValidIdentifierNameInLexicalScopes(identifierName: string, lexicalScopeNodes: TNodeWithLexicalScope[]): boolean;
    preserveName(identifierName: string): void;
    preserveNameForLexicalScope(identifierName: string, lexicalScope: TNodeWithLexicalScope): void;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/interfaces/source-code/IObfuscationResult.d.ts
================================================================================

import { TIdentifierNamesCache } from '../../types/TIdentifierNamesCache';
import { IInitializable } from '../IInitializable';
import { IOptions } from '../options/IOptions';
export interface IObfuscationResult extends IInitializable<[string, string]> {
    getIdentifierNamesCache(): TIdentifierNamesCache;
    getObfuscatedCode(): string;
    getOptions(): IOptions;
    getSourceMap(): string;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/interfaces/node-transformers/converting-transformers/object-expression-extractors/IObjectExpressionExtractorResult.d.ts
================================================================================

import * as ESTree from 'estree';
export interface IObjectExpressionExtractorResult {
    nodeToReplace: ESTree.Node;
    objectExpressionHostStatement: ESTree.Statement;
    objectExpressionNode: ESTree.ObjectExpression;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/interfaces/utils/IRandomGenerator.d.ts
================================================================================

export interface IRandomGenerator {
    getMathRandom(): number;
    getRandomGenerator(): Chance.Chance;
    getRandomInteger(min: number, max: number): number;
    getRandomIntegerExcluding(min: number, max: number, valuesToExclude: number[]): number;
    getRandomString(length: number, pool?: string): string;
    getInputSeed(): string;
    getRawSeed(): string;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/source-code/ObfuscationResult.d.ts
================================================================================

import { TIdentifierNamesCache } from '../types/TIdentifierNamesCache';
import { ICryptUtils } from '../interfaces/utils/ICryptUtils';
import { IGlobalIdentifierNamesCacheStorage } from '../interfaces/storages/identifier-names-cache/IGlobalIdentifierNamesCacheStorage';
import { IObfuscationResult } from '../interfaces/source-code/IObfuscationResult';
import { IPropertyIdentifierNamesCacheStorage } from '../interfaces/storages/identifier-names-cache/IPropertyIdentifierNamesCacheStorage';
import { IOptions } from '../interfaces/options/IOptions';
export declare class ObfuscationResult implements IObfuscationResult {
    private obfuscatedCode;
    private sourceMap;
    private readonly cryptUtils;
    private readonly globalIdentifierNamesCacheStorage;
    private readonly propertyIdentifierNamesCacheStorage;
    private readonly options;
    constructor(cryptUtils: ICryptUtils, globalIdentifierNamesCacheStorage: IGlobalIdentifierNamesCacheStorage, propertyIdentifierNamesCacheStorage: IPropertyIdentifierNamesCacheStorage, options: IOptions);
    initialize(obfuscatedCode: string, sourceMap: string): void;
    getIdentifierNamesCache(): TIdentifierNamesCache;
    getObfuscatedCode(): string;
    getOptions(): IOptions;
    getSourceMap(): string;
    toString(): string;
    private correctObfuscatedCode;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/container/modules/generators/GeneratorsModule.d.ts
================================================================================

import { interfaces } from 'inversify';
export declare const generatorsModule: interfaces.ContainerModule;

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/utils/RandomGenerator.d.ts
================================================================================

import { IInitializable } from '../interfaces/IInitializable';
import { IOptions } from '../interfaces/options/IOptions';
import { IRandomGenerator } from '../interfaces/utils/IRandomGenerator';
import { ISourceCode } from '../interfaces/source-code/ISourceCode';
export declare class RandomGenerator implements IRandomGenerator, IInitializable {
    static readonly randomGeneratorPool: string;
    private randomGenerator;
    private readonly options;
    private readonly sourceCode;
    constructor(sourceCode: ISourceCode, options: IOptions);
    initialize(): void;
    getMathRandom(): number;
    getRandomGenerator(): Chance.Chance;
    getRandomInteger(min: number, max: number): number;
    getRandomIntegerExcluding(min: number, max: number, valuesToExclude: number[]): number;
    getRandomString(length: number, pool?: string): string;
    getInputSeed(): string;
    getRawSeed(): string;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/custom-code-helpers/console-output/ConsoleOutputDisableCodeHelper.d.ts
================================================================================

import { TIdentifierNamesGeneratorFactory } from '../../types/container/generators/TIdentifierNamesGeneratorFactory';
import { TStatement } from '../../types/node/TStatement';
import { ICustomCodeHelperFormatter } from '../../interfaces/custom-code-helpers/ICustomCodeHelperFormatter';
import { ICustomCodeHelperObfuscator } from '../../interfaces/custom-code-helpers/ICustomCodeHelperObfuscator';
import { IOptions } from '../../interfaces/options/IOptions';
import { IRandomGenerator } from '../../interfaces/utils/IRandomGenerator';
import { AbstractCustomCodeHelper } from '../AbstractCustomCodeHelper';
export declare class ConsoleOutputDisableCodeHelper extends AbstractCustomCodeHelper {
    private callsControllerFunctionName;
    private consoleOutputDisableFunctionName;
    constructor(identifierNamesGeneratorFactory: TIdentifierNamesGeneratorFactory, customCodeHelperFormatter: ICustomCodeHelperFormatter, customCodeHelperObfuscator: ICustomCodeHelperObfuscator, randomGenerator: IRandomGenerator, options: IOptions);
    initialize(callsControllerFunctionName: string, consoleOutputDisableFunctionName: string): void;
    protected getNodeStructure(codeHelperTemplate: string): TStatement[];
    protected getCodeHelperTemplate(): string;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/custom-code-helpers/console-output/templates/ConsoleOutputDisableTemplate.d.ts
================================================================================

export declare function ConsoleOutputDisableTemplate(): string;

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/custom-code-helpers/console-output/group/ConsoleOutputCodeHelperGroup.d.ts
================================================================================

import { TCustomCodeHelperFactory } from '../../../types/container/custom-code-helpers/TCustomCodeHelperFactory';
import { TIdentifierNamesGeneratorFactory } from '../../../types/container/generators/TIdentifierNamesGeneratorFactory';
import { TNodeWithStatements } from '../../../types/node/TNodeWithStatements';
import { ICustomCodeHelper } from '../../../interfaces/custom-code-helpers/ICustomCodeHelper';
import { IOptions } from '../../../interfaces/options/IOptions';
import { IRandomGenerator } from '../../../interfaces/utils/IRandomGenerator';
import { ICallsGraphData } from '../../../interfaces/analyzers/calls-graph-analyzer/ICallsGraphData';
import { CustomCodeHelper } from '../../../enums/custom-code-helpers/CustomCodeHelper';
import { AbstractCustomCodeHelperGroup } from '../../AbstractCustomCodeHelperGroup';
export declare class ConsoleOutputCodeHelperGroup extends AbstractCustomCodeHelperGroup {
    protected customCodeHelpers: Map<CustomCodeHelper, ICustomCodeHelper>;
    private readonly customCodeHelperFactory;
    constructor(customCodeHelperFactory: TCustomCodeHelperFactory, identifierNamesGeneratorFactory: TIdentifierNamesGeneratorFactory, randomGenerator: IRandomGenerator, options: IOptions);
    appendOnPreparingStage(nodeWithStatements: TNodeWithStatements, callsGraphData: ICallsGraphData[]): void;
    initialize(): void;
}

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/types/TObfuscationResultsObject.d.ts
================================================================================

import { IObfuscationResult } from '../interfaces/source-code/IObfuscationResult';
export type TObfuscationResultsObject<TSourceCodesObject> = {
    [key in keyof TSourceCodesObject]: IObfuscationResult;
};

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/types/container/generators/TIdentifierNamesGeneratorFactory.d.ts
================================================================================

import { IIdentifierNamesGenerator } from '../../../interfaces/generators/identifier-names-generators/IIdentifierNamesGenerator';
import { IOptions } from '../../../interfaces/options/IOptions';
export type TIdentifierNamesGeneratorFactory = (options: IOptions) => IIdentifierNamesGenerator;

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/types/container/source-code/TObfuscationResultFactory.d.ts
================================================================================

import { IObfuscationResult } from '../../../interfaces/source-code/IObfuscationResult';
export type TObfuscationResultFactory = (obfuscatedCode: string, sourceMap: string) => IObfuscationResult;

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/types/node-transformers/TVisitorResult.d.ts
================================================================================

import * as estraverse from '@javascript-obfuscator/estraverse';
import * as ESTree from 'estree';
export type TVisitorResult = ESTree.Node | estraverse.VisitorOption | void;

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/enums/generators/identifier-names-generators/IdentifierNamesGenerator.d.ts
================================================================================

export declare const IdentifierNamesGenerator: Readonly<{
    DictionaryIdentifierNamesGenerator: 'dictionary';
    HexadecimalIdentifierNamesGenerator: 'hexadecimal';
    MangledIdentifierNamesGenerator: 'mangled';
    MangledShuffledIdentifierNamesGenerator: 'mangled-shuffled';
}>;

================================================================================
FILE: node_modules/javascript-obfuscator/typings/src/enums/node/ObfuscatingGuardResult.d.ts
================================================================================

export declare enum ObfuscatingGuardResult {
    ForceTransform = "ForceTransform",
    Ignore = "Ignore",
    Transform = "Transform"
}

================================================================================
FILE: node_modules/lodash/result.js
================================================================================

var castPath = require('./_castPath'),
    isFunction = require('./isFunction'),
    toKey = require('./_toKey');

/**
 * This method is like `_.get` except that if the resolved value is a
 * function it's invoked with the `this` binding of its parent object and
 * its result is returned.
 *
 * @static
 * @since 0.1.0
 * @memberOf _
 * @category Object
 * @param {Object} object The object to query.
 * @param {Array|string} path The path of the property to resolve.
 * @param {*} [defaultValue] The value returned for `undefined` resolved values.
 * @returns {*} Returns the resolved value.
 * @example
 *
 * var object = { 'a': [{ 'b': { 'c1': 3, 'c2': _.constant(4) } }] };
 *
 * _.result(object, 'a[0].b.c1');
 * // => 3
 *
 * _.result(object, 'a[0].b.c2');
 * // => 4
 *
 * _.result(object, 'a[0].b.c3', 'default');
 * // => 'default'
 *
 * _.result(object, 'a[0].b.c3', _.constant('default'));
 * // => 'default'
 */
function result(object, path, defaultValue) {
  path = castPath(path, object);

  var index = -1,
      length = path.length;

  // Ensure the loop is entered when path is empty.
  if (!length) {
    length = 1;
    object = undefined;
  }
  while (++index < length) {
    var value = object == null ? undefined : object[toKey(path[index])];
    if (value === undefined) {
      index = length;
      value = defaultValue;
    }
    object = isFunction(value) ? value.call(object) : value;
  }
  return object;
}

module.exports = result;

================================================================================
FILE: node_modules/lodash/fp/result.js
================================================================================

var convert = require('./convert'),
    func = convert('result', require('../result'));

func.placeholder = require('./placeholder');
module.exports = func;

================================================================================
FILE: node_modules/mongoose/lib/drivers/node-mongodb-native/bulkWriteResult.js
================================================================================

'use strict';

const BulkWriteResult = require('mongodb/lib/bulk/common').BulkWriteResult;

module.exports = BulkWriteResult;

================================================================================
FILE: node_modules/mongoose/lib/helpers/getDefaultBulkwriteResult.js
================================================================================

'use strict';

function getDefaultBulkwriteResult() {
  return {
    ok: 1,
    nInserted: 0,
    nUpserted: 0,
    nMatched: 0,
    nModified: 0,
    nRemoved: 0,
    upserted: [],
    writeErrors: [],
    insertedIds: [],
    writeConcernErrors: []
  };
}

module.exports = getDefaultBulkwriteResult;

================================================================================
FILE: node_modules/mongoose/lib/helpers/model/decorateBulkWriteResult.js
================================================================================

'use strict';

module.exports = function decorateBulkWriteResult(resultOrError, validationErrors, results) {
  resultOrError.mongoose = resultOrError.mongoose || {};
  resultOrError.mongoose.validationErrors = validationErrors;
  resultOrError.mongoose.results = results;
  return resultOrError;
};

================================================================================
FILE: node_modules/express-validator/lib/validation-result.d.ts
================================================================================

import { Request, ValidationError } from './base';
/**
 * Given a validation error, returns a new value that represents it.
 */
export type ErrorFormatter<T = any> = (error: ValidationError) => T;
type ToArrayOptions = {
    /**
     * Whether only the first error of each field should be returned.
     * @default false
     */
    onlyFirstError?: boolean;
};
export type ResultFactory<T> = (req: Request) => Result<T>;
interface ResultFactoryBuilderOptions<T = any> {
    /**
     * The default error formatter of every {@link Result} instance returned by
     * the custom `validationResult()` function.
     */
    formatter: ErrorFormatter<T>;
}
/**
 * Extracts the validation errors of an express request
 */
export declare const validationResult: ResultFactory<ValidationError> & {
    withDefaults: typeof withDefaults;
};
/**
 * The current state of the validation errors in a request.
 */
export declare class Result<T = any> {
    private formatter;
    private readonly errors;
    constructor(formatter: ErrorFormatter<T>, errors: readonly ValidationError[]);
    /**
     * Gets the validation errors as an array.
     *
     * @param options.onlyFirstError whether only the first error of each
     */
    array(options?: ToArrayOptions): T[];
    /**
     * Gets the validation errors as an object.
     * If a field has more than one error, only the first one is set in the resulting object.
     *
     * @returns an object from field name to error
     */
    mapped(): Record<string, T>;
    /**
     * Specifies a function to format errors with.
     * @param formatter the function to use for formatting errors
     * @returns A new {@link Result} instance with the given formatter
     */
    formatWith<T2>(formatter: ErrorFormatter<T2>): Result<T2>;
    /**
     * @returns `true` if there are no errors, `false` otherwise
     */
    isEmpty(): boolean;
    /**
     * Throws an error if there are validation errors.
     */
    throw(): void;
}
/**
 * Creates a `validationResult`-like function with default options passed to every {@link Result} it
 * returns.
 */
declare function withDefaults<T = any>(options?: Partial<ResultFactoryBuilderOptions<T>>): ResultFactory<T>;
export {};

================================================================================
FILE: node_modules/express-validator/lib/validation-result.js
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Result = exports.validationResult = void 0;
const _ = require("lodash");
const base_1 = require("./base");
const utils_1 = require("./utils");
/**
 * Extracts the validation errors of an express request
 */
exports.validationResult = Object.assign(withDefaults(), { withDefaults });
/**
 * The current state of the validation errors in a request.
 */
class Result {
    constructor(formatter, errors) {
        this.formatter = formatter;
        this.errors = errors;
    }
    /**
     * Gets the validation errors as an array.
     *
     * @param options.onlyFirstError whether only the first error of each
     */
    array(options) {
        return options?.onlyFirstError ? Object.values(this.mapped()) : this.errors.map(this.formatter);
    }
    /**
     * Gets the validation errors as an object.
     * If a field has more than one error, only the first one is set in the resulting object.
     *
     * @returns an object from field name to error
     */
    mapped() {
        return this.errors.reduce((mapping, error) => {
            const key = error.type === 'field' ? error.path : `_${error.type}`;
            if (!mapping[key]) {
                mapping[key] = this.formatter(error);
            }
            return mapping;
        }, {});
    }
    /**
     * Specifies a function to format errors with.
     * @param formatter the function to use for formatting errors
     * @returns A new {@link Result} instance with the given formatter
     */
    formatWith(formatter) {
        return new Result(formatter, this.errors);
    }
    /**
     * @returns `true` if there are no errors, `false` otherwise
     */
    isEmpty() {
        return this.errors.length === 0;
    }
    /**
     * Throws an error if there are validation errors.
     */
    throw() {
        if (!this.isEmpty()) {
            throw Object.assign(new Error(), (0, utils_1.bindAll)(this));
        }
    }
}
exports.Result = Result;
/**
 * Creates a `validationResult`-like function with default options passed to every {@link Result} it
 * returns.
 */
function withDefaults(options = {}) {
    const defaults = {
        formatter: error => error,
    };
    const actualOptions = _.defaults(options, defaults);
    return (req) => {
        const contexts = req[base_1.contextsKey] || [];
        const errors = _.flatMap(contexts, 'errors');
        return new Result(actualOptions.formatter, errors);
    };
}

================================================================================
FILE: node_modules/core-js/internals/create-iter-result-object.js
================================================================================

'use strict';
// `CreateIterResultObject` abstract operation
// https://tc39.es/ecma262/#sec-createiterresultobject
module.exports = function (value, done) {
  return { value: value, done: done };
};
